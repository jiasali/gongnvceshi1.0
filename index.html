<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>宫女升职记 - 无限攻略版</title>
    <script>
        // 禁用右键菜单
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
    </script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary: #757ED3;
            --secondary: #AFB4E1;
            --bg: #D1D4E8;
            --text: #4a403a;
            --accent: #8E96D9;
            --danger: #C85A7A;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --app-font-family: "Songti SC", "SimSun", serif;
            --app-font-size: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { overscroll-behavior: contain; }
        html { scrollbar-width: thin; scrollbar-color: rgba(117, 126, 211, 0.4) transparent; }
        body { margin: 0; padding: 0; background: #E7E7ED; font-family: var(--app-font-family); font-size: var(--app-font-size); height: 100vh; width: 100vw; overflow: hidden; -webkit-overflow-scrolling: touch; }
        
        /* 滚动条美化 - 轨道透明无白框，只显示滑块 */
        *::-webkit-scrollbar {
            width: 6px;
            height: 6px;
            background: transparent !important;
        }
        *::-webkit-scrollbar-track {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
        *::-webkit-scrollbar-thumb {
            background: rgba(117, 126, 211, 0.4) !important;
            border-radius: 3px;
            border: none;
        }
        *::-webkit-scrollbar-thumb:hover {
            background: rgba(117, 126, 211, 0.6) !important;
        }
        *::-webkit-scrollbar-button {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
            background: transparent !important;
        }
        *::-webkit-scrollbar-corner {
            background: transparent !important;
        }
        
        /* Firefox 滚动条 - 轨道透明，无白框 */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(117, 126, 211, 0.4) transparent;
        }
        
        /* 可滚动区域：支持手指上下滑动，轨道透明 */
        .gift-list-container, #gift-list-container, .shop-grid, 
        #chat-box, .chat-history, .modal-content, 
        #main-view, #inventory-container, #npc-list-container,
        .page, .title-screen, .story-modal-content, .pd-body,
        [style*="overflow-y"], [style*="overflow-x"] {
            scrollbar-width: thin;
            scrollbar-color: rgba(117, 126, 211, 0.4) transparent;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            overscroll-behavior: contain;
        }
        /* 所有可滚动元素的 webkit 轨道透明，彻底无白框 */
        .gift-list-container::-webkit-scrollbar-track,
        #gift-list-container::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track,
        .page::-webkit-scrollbar-track,
        [style*="overflow-y"]::-webkit-scrollbar-track,
        [style*="overflow-x"]::-webkit-scrollbar-track {
            background: transparent !important;
        }

        /* 手机模拟器外壳 */
        #app-container {
            width: 100%;
            height: 100%;
            background: var(--bg);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* 顶部栏 */
        header {
            height: 50px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 18px;
            font-weight: bold;
            z-index: 100;
        }

        .icon-btn { cursor: pointer; font-size: 20px; background: none; border: none; color: white; }

        /* 内容区域 */
        #main-view {
            position: relative;
            overflow: hidden;
            flex: 1;
            min-height: 0;
            padding: 10px;
            padding-right: 20px;
            padding-bottom: 0;
        }
        
        /* 页面切换类 */
        .page { 
            display: none !important; 
            height: 100%; 
            animation: fadeIn 0.3s; 
            overflow: hidden; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            z-index: 1;
        }
        .page.active { 
            display: flex !important; 
            flex-direction: column; 
            position: relative; 
            z-index: 2;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            height: 100%;
            box-sizing: border-box;
        }
        /* 群聊页面特殊处理：只有消息区域滚动 */
        #page-group-chat.page.active { 
            display: flex !important; 
            flex-direction: column; 
            overflow: hidden !important; 
            height: 100%; 
        }
        /* 主页和设置页面确保可以滚动 */
        #page-home.page.active,
        #page-settings.page.active,
        #page-setup.page.active {
            overflow-y: auto !important;
            overflow-x: hidden !important;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes breath {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .breathing {
            animation: breath 1.5s ease-in-out infinite;
        }

        /* 通用UI组件 */
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
            width: 100%;
            font-family: inherit;
        }
        .btn:active { opacity: 0.8; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text); font-weight: bold; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 10px; border: 1px solid #AFB4E1; border-radius: 5px; background: rgba(225,227,237,0.8);
            font-family: inherit;
        }

        /* 首页 */
        .title-screen { 
            text-align: center; 
            padding-top: 50px; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            height: 100%;
            flex: 1;
            min-height: 0;
        }
        .title-screen h1 { font-size: 36px; color: var(--accent); margin-bottom: 10px; }
        .title-screen p { color: var(--text); margin-bottom: 40px; }

        /* 属性面板 */
        .stats-bar {
            background: rgba(225,227,237,0.6);
            padding: 10px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            font-size: 14px;
            margin-bottom: 15px;
            border: 1px solid var(--primary);
        }
        .stat-item { display: flex; justify-content: space-between; }

        /* 大地图网格 */
        .map-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 10px 0;
        }
        .map-node {
            background: var(--secondary);
            border: 1px solid var(--primary);
            border-radius: 8px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }
        .map-node span { margin-top: 5px; font-size: 14px; font-weight: bold; }
        .map-node.locked { filter: grayscale(1); opacity: 0.6; pointer-events: none; }
        .map-node.locked::after { content: "lock"; position: absolute; top: 5px; right: 5px; font-family: 'Material Icons'; font-size: 16px; color: rgba(255,255,255,0.8); }

        /* 设置页大类收起/展开 */
        .settings-section { margin-bottom: 8px; }
        .settings-section-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; cursor: pointer; user-select: none; font-weight: 600; font-size: 18px; color: var(--text); border-bottom: 1px solid rgba(175,180,225,0.35); }
        .settings-section-header:hover { color: var(--primary); }
        .settings-section-header .material-icons.arrow { font-size: 22px; transition: transform 0.2s ease; color: var(--secondary); }
        .settings-section.collapsed .settings-section-header .material-icons.arrow { transform: rotate(-90deg); }
        .settings-section-body { overflow: hidden; }
        .settings-section.collapsed .settings-section-body { display: none; }

        /* 设置弹窗 */
        #settings-modal, #create-group-modal, #group-members-modal, #group-settings-modal, #psychology-diary-modal, #tutorial-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 200;
            display: none; justify-content: center; align-items: center;
        }
        /* 右上角帮助按钮（退出路径优先） */
        .help-btn {
            width: 34px;
            height: 34px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.28);
            background: rgba(255,255,255,0.14);
            color: white;
            cursor: pointer;
            flex-shrink: 0;
            user-select: none;
            transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
        }
        .help-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,0.20); box-shadow: 0 10px 26px rgba(0,0,0,0.16); }
        .help-btn:active { transform: translateY(0); opacity: 0.9; }
        #tutorial-modal .modal-content {
            max-width: 520px;
            width: 92%;
            max-height: 86vh;
            padding: 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 18px 60px rgba(0,0,0,0.22);
            background: linear-gradient(180deg, #E7E7ED 0%, #D8DAE8 100%);
        }
        #tutorial-modal .tut-header {
            position: sticky;
            top: 0;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 14px 14px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        #tutorial-modal .tut-header .tut-title { font-weight: 800; letter-spacing: .2px; font-size: 15px; }
        #tutorial-modal .tut-header .tut-close {
            width: 34px; height: 34px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.22);
            background: rgba(255,255,255,0.18);
            color: white;
            flex-shrink: 0;
        }
        #tutorial-modal .tut-body {
            padding: 14px 16px 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            max-height: calc(86vh - 58px);
        }
        #tutorial-modal .tut-section {
            background: rgba(255,255,255,0.72);
            border: 1px solid rgba(117,126,211,0.18);
            border-radius: 14px;
            padding: 12px 12px;
            margin-bottom: 12px;
        }
        #tutorial-modal .tut-section h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--primary);
            letter-spacing: .2px;
        }
        #tutorial-modal .tut-section p,
        #tutorial-modal .tut-section li {
            margin: 0 0 8px 0;
            font-size: 13.5px;
            line-height: 1.65;
            color: var(--text);
            word-break: break-word;
        }
        #tutorial-modal .tut-section ul { margin: 0; padding-left: 18px; }
        #tutorial-modal .tut-category { margin-bottom: 10px; border: 1px solid rgba(117,126,211,0.2); border-radius: 12px; overflow: hidden; background: rgba(255,255,255,0.5); }
        #tutorial-modal .tut-category-header {
            display: flex; align-items: center; gap: 8px; padding: 12px 14px; cursor: pointer; font-weight: 700; font-size: 14px; color: var(--primary);
            background: rgba(117,126,211,0.08); user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #tutorial-modal .tut-category-header:hover { background: rgba(117,126,211,0.14); }
        #tutorial-modal .tut-category-arrow { font-size: 12px; opacity: 0.9; transition: transform 0.2s; flex-shrink: 0; }
        #tutorial-modal .tut-category-body { padding: 10px 14px 14px; display: none; }
        #tutorial-modal .tut-category-body.open { display: block; }
        #tutorial-modal .kbd {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 9px;
            border: 1px solid rgba(117,126,211,0.22);
            background: rgba(255,255,255,0.7);
            font-size: 12px;
            line-height: 1.2;
            color: var(--text);
        }
        .msg-author-click { cursor: pointer; text-decoration: underline; text-underline-offset: 2px; }
        .msg-author-click:hover { opacity: 0.85; }
        #psychology-diary-modal .modal-content { max-width: 420px; width: 92%; max-height: 85vh; display: flex; flex-direction: column; border-radius: 16px; overflow: hidden; box-shadow: 0 12px 40px rgba(117,126,211,0.25); background: linear-gradient(180deg, #E7E7ED 0%, #D8DAE8 100%); }
        #psychology-diary-modal .pd-header { background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); padding: 20px; color: white; text-align: center; flex-shrink: 0; }
        #psychology-diary-modal .pd-header h3 { margin: 0; font-size: 18px; }
        #psychology-diary-modal .pd-header p { margin: 6px 0 0; font-size: 13px; opacity: 0.9; }
        #psychology-diary-modal .pd-body { padding: 16px; overflow-y: auto; flex: 1; min-height: 0; -webkit-overflow-scrolling: touch; }
        #psychology-diary-modal .pd-section { background: rgba(255,255,255,0.7); border-radius: 12px; padding: 14px; margin-bottom: 14px; border: 1px solid rgba(117,126,211,0.2); }
        #psychology-diary-modal .pd-section-title { font-weight: bold; color: var(--primary); font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        #psychology-diary-modal .pd-section-content { font-size: 14px; line-height: 1.6; color: var(--text); white-space: pre-wrap; word-wrap: break-word; }
        #psychology-diary-modal .pd-empty { color: #8E96D9; font-style: italic; font-size: 13px; }
        #psychology-diary-modal .pd-footer { padding: 12px 16px; flex-shrink: 0; border-top: 1px solid rgba(117,126,211,0.2); background: rgba(255,255,255,0.5); display: flex; justify-content: flex-end; }
        .npc-name-click { cursor: pointer; text-decoration: underline; text-underline-offset: 2px; }
        .npc-name-click:hover { opacity: 0.85; }
        .modal-content {
            background: #E7E7ED; width: 90%; padding: 20px; border-radius: 10px; max-height: 80%; overflow-y: auto; -webkit-overflow-scrolling: touch; touch-action: pan-y;
        }
        .model-list { max-height: 150px; overflow-y: auto; -webkit-overflow-scrolling: touch; touch-action: pan-y; border: 1px solid #D1D4E8; margin-top: 5px; }
        .model-item { padding: 8px; border-bottom: 1px solid #D1D4E8; cursor: pointer; }
        .model-item:hover { background: #D1D4E8; }
        .model-item.selected { background: var(--secondary); font-weight: bold; }

        /* 聊天界面 */
        .chat-container { display: flex; flex-direction: column; height: 100%; }
        .chat-history { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; touch-action: pan-y; padding: 10px; background: rgba(225,227,237,0.3); margin-bottom: 10px; border-radius: 5px; display: flex; flex-direction: column; }
        .message { margin-bottom: 10px; max-width: 85%; padding: 8px 12px; border-radius: 10px; font-size: 14px; line-height: 1.4; }
        .message.has-image { padding: 0; }
        .msg-npc { background: #E7E7ED; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
        .msg-user { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .msg-sys { text-align: center; font-size: 12px; color: #8E96D9; margin: 5px 0; width: 100%; font-style: italic; }

        /* QQ风引用预览条 */
        .quote-bar {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            margin: 8px 0;
            border-radius: 12px;
            background: rgba(255,255,255,0.65);
            border: 1px solid rgba(117,126,211,0.18);
            box-shadow: 0 10px 30px rgba(117,126,211,0.12);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .quote-bar .quote-accent {
            width: 3px;
            align-self: stretch;
            border-radius: 999px;
            background: linear-gradient(180deg, var(--accent) 0%, var(--primary) 100%);
            opacity: 0.9;
        }
        .quote-bar .quote-main { flex: 1; min-width: 0; }
        .quote-bar .quote-title { font-size: 12px; color: var(--text); opacity: 0.75; margin-bottom: 2px; }
        .quote-bar .quote-snippet {
            font-size: 13px;
            color: var(--text);
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .quote-bar .quote-close {
            width: 28px; height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid rgba(117,126,211,0.15);
            background: rgba(255,255,255,0.7);
            color: var(--text);
            cursor: pointer;
            flex-shrink: 0;
            transition: transform .12s ease, background .12s ease;
        }
        .quote-bar .quote-close:hover { transform: translateY(-1px); background: rgba(117,126,211,0.10); }

        /* 消息内引用块（QQ风） */
        .msg-quote {
            margin-bottom: 6px;
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(0,0,0,0.10);
            border: 1px solid rgba(255,255,255,0.18);
        }
        .msg-npc .msg-quote {
            background: rgba(117,126,211,0.10);
            border: 1px solid rgba(117,126,211,0.18);
        }
        .msg-quote .q-name { font-size: 12px; opacity: 0.85; margin-bottom: 2px; }
        .msg-quote .q-text {
            font-size: 13px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* QQ风长按菜单（L2浮层） */
        .message-action-menu {
            position: fixed;
            z-index: 10000;
            background: rgba(255,255,255,0.78);
            border: 1px solid rgba(117,126,211,0.18);
            border-radius: 16px;
            padding: 6px;
            box-shadow: 0 18px 55px rgba(0,0,0,0.18);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            min-width: 168px;
        }
        .message-action-menu .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--text);
            transition: background .12s ease, transform .12s ease;
            user-select: none;
        }
        .message-action-menu .menu-item:hover { background: rgba(117,126,211,0.10); transform: translateY(-1px); }
        .message-action-menu .menu-item.danger { color: #e74c3c; }
        .message-action-menu .menu-item.danger:hover { background: rgba(231,76,60,0.10); }
        .message-action-menu .menu-item .material-icons { font-size: 18px; opacity: 0.9; }

        /* 编辑消息底部弹层 */
        #message-edit-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.35);
            z-index: 10001;
            justify-content: center;
            align-items: flex-end;
            padding: 14px;
        }
        #message-edit-modal .sheet {
            width: min(520px, 100%);
            border-radius: 18px;
            overflow: hidden;
            background: rgba(255,255,255,0.88);
            border: 1px solid rgba(117,126,211,0.18);
            box-shadow: 0 26px 70px rgba(0,0,0,0.22);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
        }
        #message-edit-modal .sheet-header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            border-bottom: 1px solid rgba(117,126,211,0.12);
        }
        #message-edit-modal .sheet-header .title { font-weight: 700; color: var(--text); font-size: 14px; letter-spacing: .2px; }
        #message-edit-modal .sheet-header .close {
            width: 34px; height: 34px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(117,126,211,0.15);
            background: rgba(255,255,255,0.7);
        }
        #message-edit-modal .sheet-body { padding: 12px 16px 16px; }
        #message-edit-modal textarea {
            width: 100%;
            min-height: 110px;
            resize: none;
            border-radius: 14px;
            border: 1px solid rgba(117,126,211,0.22);
            background: rgba(255,255,255,0.72);
            padding: 12px 12px;
            color: var(--text);
            outline: none;
            line-height: 1.55;
        }
        #message-edit-modal .sheet-actions {
            padding: 12px 16px 16px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        #message-edit-modal .sheet-actions .btn {
            width: auto;
            padding: 10px 14px;
            border-radius: 14px;
        }

        /* 消息定位高亮 */
        .msg-highlight {
            animation: msgFlash 1.25s ease-out 1;
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.55), 0 10px 30px rgba(255, 215, 0, 0.18) !important;
        }
        @keyframes msgFlash {
            0% { transform: scale(1); filter: brightness(1.02); }
            35% { transform: scale(1.02); filter: brightness(1.12); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        /* 删除确认弹层（与编辑同级） */
        #message-delete-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.35);
            z-index: 10001;
            justify-content: center;
            align-items: flex-end;
            padding: 14px;
        }
        #message-delete-modal .sheet {
            width: min(520px, 100%);
            border-radius: 18px;
            overflow: hidden;
            background: rgba(255,255,255,0.88);
            border: 1px solid rgba(117,126,211,0.18);
            box-shadow: 0 26px 70px rgba(0,0,0,0.22);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
        }
        #message-delete-modal .sheet-header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            border-bottom: 1px solid rgba(117,126,211,0.12);
            background: linear-gradient(135deg, rgba(231,76,60,0.16) 0%, rgba(231,76,60,0.06) 100%);
        }
        #message-delete-modal .sheet-header .title { font-weight: 800; color: var(--text); font-size: 14px; letter-spacing: .2px; }
        #message-delete-modal .sheet-header .close {
            width: 34px; height: 34px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(117,126,211,0.15);
            background: rgba(255,255,255,0.7);
        }
        #message-delete-modal .sheet-body { padding: 12px 16px 6px; }
        #message-delete-preview {
            border-radius: 14px;
            border: 1px solid rgba(231,76,60,0.20);
            background: rgba(231,76,60,0.06);
            padding: 12px 12px;
            color: var(--text);
            line-height: 1.55;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 34vh;
            overflow: auto;
        }
        #message-delete-modal .sheet-actions {
            padding: 12px 16px 16px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        #message-delete-modal .sheet-actions .btn {
            width: auto;
            padding: 10px 14px;
            border-radius: 14px;
        }
        .chat-controls { 
            display: flex; 
            gap: 5px; 
            align-items: center;
            position: relative;
        }
        .chat-plus-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        .chat-plus-btn:active {
            transform: scale(0.95);
        }
        .chat-plus-menu {
            position: absolute;
            bottom: 50px;
            left: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 10px;
            display: none;
            z-index: 1000;
            min-width: 150px;
        }
        .chat-plus-menu.show {
            display: block !important;
        }
        /* 群聊侧边栏样式 */
        .group-chat-sidebar {
            position: absolute;
            top: 0;
            right: -280px;
            width: 280px;
            height: 100%;
            background: var(--bg);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 2000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        .group-chat-sidebar.show {
            right: 0;
        }
        .group-chat-sidebar-content {
            padding: 20px;
        }
        .group-chat-sidebar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 1999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .group-chat-sidebar-overlay.show {
            display: block;
            opacity: 1;
        }
        .action-bar { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 5px; }
        .action-chip { background: var(--secondary); border: 1px solid var(--primary); padding: 5px 10px; border-radius: 15px; font-size: 12px; white-space: nowrap; cursor: pointer; }
        
        /* 圆形开关样式 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            width: 28px;
            height: 28px;
            border: 2.5px solid rgba(204, 204, 204, 0.6);
            border-radius: 50%;
            background-color: transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            width: 14px;
            height: 14px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0);
            background-color: var(--accent);
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toggle-switch input:checked + .toggle-slider {
            border-color: var(--accent);
            background-color: rgba(117, 126, 211, 0.1);
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translate(-50%, -50%) scale(1);
        }
        .api-mode-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--secondary);
        }
        .api-mode-item:last-child {
            border-bottom: none;
        }
        .restart-inherit-item { display:flex;align-items:center;gap:10px;margin-bottom:10px;cursor:pointer;font-size:14px;color:var(--text); }
        .api-mode-item .toggle-switch {
            width: 28px;
            height: 28px;
        }
        .api-mode-item .toggle-slider {
            width: 28px;
            height: 28px;
        }
        .api-mode-item .toggle-slider:before {
            width: 14px;
            height: 14px;
        }
        .api-mode-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            cursor: pointer;
        }

        /* 人物列表 */
        .npc-card {
            background: #E7E7ED; border-radius: 8px; padding: 10px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid var(--accent);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
        }
        .npc-info h4 { margin: 0; font-size: 16px; }
        .npc-info p { margin: 2px 0 0; font-size: 12px; color: #757ED3; }
        
        /* NPC编辑弹窗 */
        .npc-edit-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 300;
            display: none; justify-content: center; align-items: center;
        }
        #story-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 400;
            display: none; justify-content: center; align-items: center;
            animation: fadeIn 0.5s ease-in;
        }
        #story-modal.show {
            display: flex;
        }
        .story-modal-content {
            background: #E7E7ED; width: 90%; max-width: 600px; padding: 25px; 
            border-radius: 15px; max-height: 80%; overflow-y: auto; -webkit-overflow-scrolling: touch; touch-action: pan-y;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .story-title {
            font-size: 20px; font-weight: bold; color: var(--primary);
            margin-bottom: 15px; border-bottom: 2px solid var(--accent);
            padding-bottom: 10px;
        }
        .story-content {
            font-size: 16px; line-height: 1.8; color: #4a403a;
            white-space: pre-wrap; margin-bottom: 20px;
        }
        .story-date {
            font-size: 12px; color: #8E96D9; text-align: right;
            margin-top: 15px; padding-top: 10px; border-top: 1px solid #D1D4E8;
        }
        .npc-actions {
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
        }
        .plus-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .plus-btn:active {
            transform: scale(0.95);
        }
        .plus-menu {
            position: absolute;
            bottom: 60px;
            left: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 10px;
            display: none;
            z-index: 100;
            min-width: 150px;
        }
        .plus-menu.show {
            display: block;
        }
        .plus-menu-item {
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            position: relative;
        }
        .plus-menu-item:hover {
            background: var(--secondary);
        }
        .plus-menu-item.loading {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* 表情包弹窗 */
        #emoji-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 300;
            display: none; justify-content: center; align-items: center;
        }
        .emoji-modal-content {
            background: #E7E7ED; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px;
            max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch; touch-action: pan-y;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .emoji-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--primary);
            cursor: pointer;
            position: relative;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .emoji-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .emoji-edit-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(117, 126, 211, 0.9);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 1;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .emoji-edit-btn:active {
            transform: scale(0.9);
            background: rgba(117, 126, 211, 1);
        }
        .emoji-add-btn {
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px dashed var(--accent);
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--accent);
            cursor: pointer;
            transition: all 0.2s;
        }
        .emoji-add-btn:active {
            transform: scale(0.95);
            background: var(--primary);
            color: white;
        }
        /* 添加表情包弹窗 */
        #add-emoji-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 301;
            display: none; justify-content: center; align-items: center;
        }
        /* 发送图片弹窗 */
        #send-image-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 301;
            display: none; justify-content: center; align-items: center;
        }
        /* 保存游戏弹窗 */
        #save-game-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 301;
            display: none; justify-content: center; align-items: center;
        }
        .save-slot-card {
            background: #E7E7ED;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--accent);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s;
        }
        .save-slot-card:hover {
            background: var(--secondary);
            transform: translateX(2px);
        }
        .save-slot-info h4 {
            margin: 0;
            font-size: 16px;
            color: var(--text);
        }
        .save-slot-info p {
            margin: 4px 0 0;
            font-size: 12px;
            color: #757ED3;
        }
        /* 转账银两弹窗 */
        #money-transfer-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 301;
            display: none; justify-content: center; align-items: center;
        }
        .message-img {
            max-width: 200px;
            border-radius: 8px;
            margin: 0;
            display: block;
        }
        .message.has-image {
            display: inline-block;
            padding: 2px !important;
            line-height: 0;
            max-width: fit-content;
        }
        .msg-user.has-image {
            align-self: flex-end !important;
            margin-left: auto !important;
        }
        .message.has-image .message-img {
            border-radius: 8px;
            display: block;
            margin: 0;
            vertical-align: bottom;
        }
        .message.has-image .message-img + * {
            margin-top: 4px;
            padding: 0 4px 4px 4px;
            font-size: 12px;
            line-height: 1.4;
            display: block;
        }
        /* 图片描述工具提示 */
        .image-description-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 250px;
            word-wrap: break-word;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            animation: tooltipFadeIn 0.2s ease-out;
        }
        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 任务卡片 */
        .task-card {
            background: #E7E7ED; border-radius: 8px; padding: 10px; margin-bottom: 10px;
            border-left: 4px solid #8E96D9;
        }
        .task-card.completed { opacity: 0.6; border-left-color: #AFB4E1; }
        .task-reward { font-size: 12px; color: var(--accent); margin-top: 5px; }

        /* 物品卡片 */
        .item-card {
            background: #E7E7ED; border-radius: 8px; padding: 8px; margin: 5px;
            display: inline-block; min-width: 80px; text-align: center;
            border: 1px solid var(--primary);
        }
        .item-card.rare { border-color: #8E96D9; background: #D1D4E8; }


        /* 答题界面 */
        .quiz-option {
            background: var(--secondary); padding: 10px; margin: 5px 0;
            border-radius: 5px; cursor: pointer; border: 2px solid transparent;
        }
        .quiz-option:hover { border-color: var(--accent); }
        .quiz-option.correct { background: #D1D4E8; border-color: #8E96D9; }
        .quiz-option.wrong { background: #E7E7ED; border-color: var(--danger); }

        /* 属性加点系统 */
        .stat-allocation {
            background: rgba(225,227,237,0.8);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--primary);
        }
        .stat-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 8px;
            background: rgba(225,227,237,0.6);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--primary);
        }
        .stat-row label {
            min-width: 90px;
            font-size: 14px;
            font-weight: bold;
        }
        .stat-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        .stat-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--accent);
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .stat-btn:active {
            transform: scale(0.95);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .stat-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .stat-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            color: var(--accent);
            background: var(--secondary);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .points-remaining {
            text-align: center;
            padding: 10px;
            background: var(--secondary);
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 10px;
        }
        .points-remaining.warning { background: #E7E7ED; color: #757ED3; }
        .points-remaining.error { background: #E7E7ED; color: var(--danger); }

        /* 底部导航栏 */
        #bottom-nav {
            height: 60px;
            padding-bottom: max(env(safe-area-inset-bottom), 40px);
            box-sizing: content-box;
            background: var(--primary);
            display: none;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.2);
            z-index: 100;
            flex-shrink: 0;
            transform: translateY(-10px);
        }
        #bottom-nav.show {
            display: flex;
        }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px;
            cursor: pointer;
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            transition: all 0.2s;
        }
        .nav-item.active {
            color: white;
        }
        .nav-item-icon {
            font-size: 20px;
            margin-bottom: 2px;
            font-weight: normal;
            color: rgba(255,255,255,0.7);
            font-family: 'Material Icons';
            font-style: normal;
            font-weight: normal;
            line-height: 1;
        }
        .nav-item.active .nav-item-icon {
            color: white;
        }
        .nav-item-text {
            font-size: 11px;
        }

        /* 子导航栏 */
        #sub-nav {
            height: 50px;
            padding-bottom: max(env(safe-area-inset-bottom), 32px);
            box-sizing: content-box;
            background: var(--accent);
            display: none;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.2);
            z-index: 99;
            overflow-x: auto;
            flex-shrink: 0;
            transform: translateY(-10px);
        }
        #sub-nav.show {
            display: flex;
        }
        .sub-nav-item {
            flex-shrink: 0;
            padding: 8px 15px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            border-radius: 5px;
            transition: all 0.2s;
        }
        .sub-nav-item:hover {
            background: rgba(255,255,255,0.2);
        }
        .sub-nav-item.active {
            background: rgba(255,255,255,0.3);
            color: white;
            font-weight: bold;
        }

        /* --- 购物界面样式 --- */
        .shopping-header {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--primary);
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .search-bar {
            flex: 1;
            display: flex;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 5px 15px;
            margin-left: 10px;
            align-items: center;
        }
        .search-bar input {
            border: none;
            background: transparent;
            flex: 1;
            outline: none;
            font-size: 14px;
            color: white;
        }
        .search-bar input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
            background: var(--secondary);
            min-height: 100%;
        }
        .shop-item {
            background: var(--primary);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
            cursor: pointer;
        }
        .shop-item:active { transform: scale(0.98); }
        .shop-img-placeholder {
            width: 100%;
            height: 140px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: rgba(255,255,255,0.5);
        }
        .shop-info { padding: 8px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .shop-title {
            font-size: 14px;
            font-weight: bold;
            color: white;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .shop-desc { font-size: 10px; color: rgba(255,255,255,0.6); margin-bottom: 5px; }
        .shop-price-row { display: flex; justify-content: space-between; align-items: baseline; }
        .shop-price { color: #ffd700; font-weight: bold; font-size: 16px; }
        .shop-price::before { content: '¥'; font-size: 12px; margin-right: 1px; }
        .shop-sales { font-size: 10px; color: rgba(255,255,255,0.5); }

        /* --- 聊天界面礼物卡片样式 --- */
        .msg-gift-card {
            background: var(--primary);
            padding: 10px;
            border-radius: 12px;
            width: 240px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            margin: 5px 0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .gift-card-header { display: flex; align-items: center; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .gift-card-icon { width: 20px; height: 20px; background: #ffd700; border-radius: 50%; color: #333; display: flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 6px; font-weight: bold; }
        .gift-card-label { font-size: 12px; color: #ffd700; font-weight: bold; }
        .gift-card-body { display: flex; gap: 10px; }
        .gift-card-img { width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 6px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .gift-card-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .gift-card-title { font-size: 14px; font-weight: bold; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gift-card-price { color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 4px; }

    </style>
</head>
<body>

<div id="app-container">
    <header>
        <div id="header-title">宫女升职记</div>
        <button class="help-btn" id="help-btn" type="button" title="教程" aria-label="打开教程" onclick="openTutorialModal()">
            ?
        </button>
    </header>

    <div id="main-view">
        <!-- 1. 标题画面 -->
        <div id="page-home" class="page active title-screen">
            <h1>宫女升职记</h1>
            <button class="btn" onclick="goToPage('page-setup')">开始新人生</button>
            <button class="btn btn-outline" onclick="goToPage('page-load')">读取存档</button>
        </div>

        <!-- 2. 自定义设置画面 -->
        <div id="page-setup" class="page">
            <h3>自定义世界观</h3>
            <div class="input-group">
                <label>朝代名称</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="setup-dynasty" value="大盛">
                    <button class="btn" style="width: auto;" onclick="randomDynasty()">🎲</button>
                </div>
            </div>
            <div class="input-group">
                <label>皇帝设定 (性格/年号)</label>
                <input type="text" id="setup-emperor" value="盛德帝，勤政爱民，外冷内热">
            </div>
            <div class="input-group">
                <label>主角出身</label>
                <select id="setup-origin">
                    <option value="官宦">官宦之女 (人脉+)</option>
                    <option value="商贾">商贾之女 (财富+)</option>
                    <option value="平民">平民之女 (体力+)</option>
                    <option value="医女">医者之女 (医术+)</option>
                    <option value="书香">书香门第 (才学+)</option>
                    <option value="武将">武将之女 (武艺+)</option>
                    <option value="乐师">乐师之女 (音律+)</option>
                    <option value="绣娘">绣娘之女 (刺绣+)</option>
                    <option value="舞姬">舞姬之女 (舞蹈+)</option>
                    <option value="商女">商女 (财富+魅力+)</option>
                    <option value="孤女">孤女 (心计+)</option>
                    <option value="罪臣">罪臣之女 (心计+体质+)</option>
                    <option value="外族">外族之女 (武艺+魅力+)</option>
                    <option value="庶女">庶女 (心计+才学+)</option>
                    <option value="嫡女">嫡女 (气质+人脉+)</option>
                    <option value="宫女">宫女之女 (体质+刺绣+)</option>
                    <option value="道士">道士之女 (才学+心计+)</option>
                    <option value="江湖">江湖之女 (武艺+魅力+)</option>
                    <option value="青楼">青楼之女 (魅力+音律+)</option>
                    <option value="农家">农家之女 (体质+刺绣+)</option>
                    <option value="工匠">工匠之女 (才学+体质+)</option>
                </select>
            </div>
            <div class="input-group">
                <label>主角姓名</label>
                <input type="text" id="setup-name" value="魏璎珞">
            </div>
            <div class="input-group">
                <label>年龄</label>
                <select id="setup-age">
                    <option value="13">13岁</option>
                    <option value="14">14岁</option>
                    <option value="15" selected>15岁</option>
                    <option value="16">16岁</option>
                    <option value="17">17岁</option>
                    <option value="18">18岁</option>
                </select>
            </div>
            <div class="input-group">
                <label>主角设定</label>
                <textarea id="setup-character" rows="3" placeholder="可以填写角色的性格、背景、特殊设定等..."></textarea>
            </div>
            
            <!-- 属性加点系统 -->
            <div class="stat-allocation">
                <h4>属性分配 (共60点)</h4>
                <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
                    <div class="points-remaining" id="points-remaining">剩余点数: <span id="points-left">60</span></div>
                    <button type="button" class="btn btn-outline" style="padding:4px 10px; font-size:12px;" onclick="randomizeStats()">🎲 随机分配</button>
                </div>
                
                <div class="stat-row">
                    <label>💪 体质</label>
                    <div class="stat-controls">
                        <button class="stat-btn" onclick="adjustStat('constitution', -1)">−</button>
                        <span class="stat-value" id="val-constitution">0</span>
                        <button class="stat-btn" onclick="adjustStat('constitution', 1)">+</button>
                    </div>
                </div>
                <div class="stat-row">
                    <label>💄 容貌</label>
                    <div class="stat-controls">
                        <button class="stat-btn" onclick="adjustStat('charm', -1)">−</button>
                        <span class="stat-value" id="val-charm">0</span>
                        <button class="stat-btn" onclick="adjustStat('charm', 1)">+</button>
                    </div>
                </div>
                <div class="stat-row">
                    <label>✨ 气质</label>
                    <div class="stat-controls">
                        <button class="stat-btn" onclick="adjustStat('elegance', -1)">−</button>
                        <span class="stat-value" id="val-elegance">0</span>
                        <button class="stat-btn" onclick="adjustStat('elegance', 1)">+</button>
                    </div>
                </div>
                <div class="stat-row">
                    <label>🎭 魅力</label>
                    <div class="stat-controls">
                        <button class="stat-btn" onclick="adjustStat('attraction', -1)">−</button>
                        <span class="stat-value" id="val-attraction">0</span>
                        <button class="stat-btn" onclick="adjustStat('attraction', 1)">+</button>
                    </div>
                </div>
                <div class="stat-row">
                    <label>🧠 心计</label>
                    <div class="stat-controls">
                        <button class="stat-btn" onclick="adjustStat('cunning', -1)">−</button>
                        <span class="stat-value" id="val-cunning">0</span>
                        <button class="stat-btn" onclick="adjustStat('cunning', 1)">+</button>
                    </div>
                </div>
                <div class="stat-row">
                    <label>🎵 音律</label>
                    <div class="stat-controls">
                        <button class="stat-btn" onclick="adjustStat('music', -1)">−</button>
                        <span class="stat-value" id="val-music">0</span>
                        <button class="stat-btn" onclick="adjustStat('music', 1)">+</button>
                    </div>
                </div>
                <div class="stat-row">
                    <label>💃 舞蹈</label>
                    <div class="stat-controls">
                        <button class="stat-btn" onclick="adjustStat('dance', -1)">−</button>
                        <span class="stat-value" id="val-dance">0</span>
                        <button class="stat-btn" onclick="adjustStat('dance', 1)">+</button>
                    </div>
                </div>
                <div class="stat-row">
                    <label>🧵 刺绣</label>
                    <div class="stat-controls">
                        <button class="stat-btn" onclick="adjustStat('embroidery', -1)">−</button>
                        <span class="stat-value" id="val-embroidery">0</span>
                        <button class="stat-btn" onclick="adjustStat('embroidery', 1)">+</button>
                    </div>
                </div>
                <div class="stat-row">
                    <label>📚 才学</label>
                    <div class="stat-controls">
                        <button class="stat-btn" onclick="adjustStat('wisdom', -1)">−</button>
                        <span class="stat-value" id="val-wisdom">0</span>
                        <button class="stat-btn" onclick="adjustStat('wisdom', 1)">+</button>
                    </div>
                </div>
                <div class="stat-row">
                    <label>⚔️ 武艺</label>
                    <div class="stat-controls">
                        <button class="stat-btn" onclick="adjustStat('martial', -1)">−</button>
                        <span class="stat-value" id="val-martial">0</span>
                        <button class="stat-btn" onclick="adjustStat('martial', 1)">+</button>
                    </div>
                </div>
            </div>
            
            <button class="btn" onclick="startGame()">入宫</button>
            <div style="height: 150px; min-height: 150px;"></div>
        </div>

        <!-- 3. 游戏主界面 (面板) -->
        <div id="page-game" class="page">
            <div class="stats-bar">
                <div class="stat-item"><span>时间:</span> <span id="game-date">盛德十五年 春</span></div>
                <div class="stat-item"><span>职位:</span> <span id="game-rank">粗使宫女</span></div>
                <div class="stat-item"><span>体力:</span> <span id="game-energy">100/100</span></div>
                <div class="stat-item"><span>银两:</span> <span id="game-money">50</span></div>
                <div class="stat-item"><span>声望:</span> <span id="game-fame">0</span></div>
                <div class="stat-item"><span>容貌:</span> <span id="game-charm">50</span></div>
                <div class="stat-item"><span>怀孕:</span> <span id="game-pregnancy">无</span></div>
            </div>

            <h4 style="margin: 10px 0;">【宫廷地图】</h4>
            <div class="map-grid" id="palace-map">
                <!-- 动态生成地图 -->
            </div>

            <h4 style="margin: 10px 0;">【宫外】</h4>
            <div class="map-grid" id="city-map">
                <!-- 动态生成地图 -->
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-outline" id="rest-btn" onclick="advanceTime()">休息 (进入下一天)</button>
            </div>
        </div>

        <!-- 4. 聊天/互动界面 -->
        <div id="page-chat" class="page">
            <div class="chat-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; flex-wrap:wrap; gap:6px;">
                    <button class="btn btn-outline" style="width:auto; padding:5px 10px;" onclick="goToPage('page-contacts')">⬅ 返回</button>
                    <span id="chat-target-name" style="font-weight:bold; cursor:pointer; text-decoration:underline; text-underline-offset:2px;" onclick="if(gameState.chatTargetId) showPsychologyDiaryModalByNpcId(gameState.chatTargetId);" title="点击查看心理状态与日记"></span>
                    <span id="chat-affection" style="font-size:12px; color:var(--accent);">好感: 0</span>
                    <span id="chat-pending-contraceptive-wrap" style="display:none;"><button type="button" class="btn" style="font-size:11px;padding:4px 8px;" onclick="offerContraceptiveToNpc()">劝说服用避孕汤</button></span>
                </div>
                
                <div class="chat-history" id="chat-box">
                    <!-- 消息内容 -->
                </div>

                <div class="action-bar" id="chat-actions">
                    <!-- 动态生成：闲聊、赠礼、调情、请教 -->
                </div>

                <!-- 引用预览条（QQ风）：放在输入框上方 -->
                <div id="chat-quote-bar" class="quote-bar" style="margin:0 0 8px 0;">
                    <div class="quote-accent"></div>
                    <div class="quote-main">
                        <div class="quote-title" id="chat-quote-title">引用</div>
                        <div class="quote-snippet" id="chat-quote-snippet"></div>
                    </div>
                    <button class="quote-close" type="button" onclick="clearQuote('chat')" aria-label="关闭引用">
                        <span class="material-icons" style="font-size:18px;opacity:0.85;">close</span>
                    </button>
                </div>
                <div class="chat-controls">
                    <button class="chat-plus-btn" onclick="toggleChatPlusMenu()">+</button>
                    <div class="chat-plus-menu" id="chat-plus-menu">
                        <div class="plus-menu-item chat-menu-normal" id="menu-emoji" data-original-text="表情包" onclick="sendEmojiFromChat()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">mood</span>表情包</div>
                        <div class="plus-menu-item chat-menu-normal" id="menu-image" data-original-text="图片" onclick="sendImageFromChat()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">image</span>图片</div>
                        <div class="plus-menu-item chat-menu-normal" id="menu-gift" data-original-text="礼物" onclick="return sendGiftFromChat(event);"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">card_giftcard</span>礼物</div>
                        <div class="plus-menu-item chat-menu-normal" id="menu-money" data-original-text="转账银两" onclick="sendMoneyFromChat()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">account_balance_wallet</span>转账银两</div>
                        <div class="plus-menu-item chat-menu-normal" id="menu-memory" data-original-text="记忆历史" onclick="openMemorySettings()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">history</span>记忆历史</div>
                        <div class="plus-menu-item chat-menu-normal" id="menu-background" data-original-text="自定义背景" onclick="openChatBackgroundModal()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">palette</span>自定义背景</div>
                        <div class="plus-menu-item chat-menu-normal" id="menu-notification-sound" data-original-text="自定义提示音" onclick="openNotificationSoundModal('chat')"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">notifications</span>自定义提示音</div>
                        <div class="plus-menu-item chat-menu-normal" id="menu-bubble" data-original-text="自定义气泡" onclick="openBubbleStyleModal()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">chat_bubble</span>自定义气泡</div>
                        <div class="plus-menu-item chat-menu-normal" id="menu-transfer-style" data-original-text="自定义转账样式" onclick="openTransferStyleModal()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">payments</span>自定义转账样式</div>
                        <div class="plus-menu-item chat-menu-normal" id="menu-gift-style" data-original-text="自定义礼物样式" onclick="openGiftStyleModal()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">card_giftcard</span>自定义礼物样式</div>
                        <div class="plus-menu-item chat-menu-normal" id="menu-encounter-map" data-original-text="遇地图" onclick="openEncounterMapModal()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">map</span>遇地图</div>
                        <div class="plus-menu-item chat-menu-normal" id="menu-encounter-history" data-original-text="遇地图历史" onclick="openEncounterMapHistoryModal()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">history_edu</span>遇地图历史</div>
                        <div class="plus-menu-item chat-menu-child" id="menu-child-raise" style="display:none;" onclick="childMenuRaise()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">school</span>教养</div>
                        <div class="plus-menu-item chat-menu-child" id="menu-child-kill" style="display:none;" onclick="childMenuKill()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">warning</span>暗杀</div>
                        <div class="plus-menu-item chat-menu-child" id="menu-child-marry" style="display:none;" onclick="childMenuMarry()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">favorite</span>指婚</div>
                    </div>
                    <input type="text" id="chat-input" placeholder="说点什么..." style="flex:1; padding:10px; border-radius:5px; border:1px solid #AFB4E1;">
                    <button class="btn" style="width:auto; padding:8px 15px; margin-right:8px; flex-shrink:0;" onclick="sendMessage()">发送</button>
                    <button class="btn" style="width:auto; padding:8px 12px; font-size:20px; line-height:1; flex-shrink:0;" onclick="sendMessageWithAPI()">🍥</button>
                </div>
            </div>
        </div>

        <!-- 5. 人脉列表 -->
        <div id="page-contacts" class="page">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:12px;">
                <h3 style="margin:0;display:flex;align-items:center;gap:8px;">[人脉] <button class="btn" onclick="openAddNPC()" style="width:36px;height:36px;padding:0;border-radius:50%;font-size:20px;line-height:1;display:flex;align-items:center;justify-content:center;" title="添加人物">+</button> <button class="btn btn-outline" onclick="openPlayerInfoModal()" style="width:36px;height:36px;padding:0;border-radius:50%;display:flex;align-items:center;justify-content:center;" title="编辑个人信息"><span class="material-icons" style="font-size:20px;">person</span></button></h3>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-outline" onclick="openExportSelectModal()" style="width:auto;padding:6px 12px;font-size:13px;">导出</button>
                    <button class="btn btn-outline" onclick="document.getElementById('import-contacts-input').click()" style="width:auto;padding:6px 12px;font-size:13px;">导入</button>
                    <input type="file" id="import-contacts-input" accept=".json,application/json" style="display:none;" onchange="importContacts(event)">
                </div>
            </div>
            <div id="npc-list-container"></div>
        </div>

        <!-- 购物页面 -->
        <div id="page-shopping" class="page">
            <div class="shopping-header">
                <button class="btn btn-outline" id="shopping-back-btn" style="width:auto; padding:5px 10px; background:rgba(255,255,255,0.2); border-color:rgba(255,255,255,0.3); color:white;" onclick="handleShoppingBack()">⬅ 返回</button>
                <div class="search-bar">
                    <input type="text" id="shop-search-input" placeholder="搜索精美礼品..." onkeypress="if(event.key==='Enter') searchShop()">
                    <button onclick="searchShop()" style="background:none; border:none; cursor:pointer; font-size:18px; color:white; padding:0 5px;">🔍</button>
                </div>
            </div>
            <div class="shop-grid" id="shop-grid"></div>
        </div>

        <!-- 存档列表页面 -->
        <div id="page-load" class="page">
            <button class="btn btn-outline" onclick="goToPage('page-home')">⬅ 返回</button>
            <h3>存档列表</h3>
            <div style="display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap;">
                <button class="btn" onclick="openExportSaveModal()" style="width:auto;padding:8px 16px;"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">file_download</span>导出存档</button>
                <button class="btn btn-outline" onclick="document.getElementById('import-save-input').click()" style="width:auto;padding:8px 16px;"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">file_upload</span>导入存档</button>
                <input type="file" id="import-save-input" accept=".json,application/json" style="display:none;" onchange="importSave(event)">
            </div>
            <div id="save-list-container"></div>
        </div>

        <!-- 6. 物品系统 -->
        <div id="page-inventory" class="page">
            <h3>[我的物品]</h3>
            <div id="inventory-container"></div>
        </div>

        <!-- 8. 换装系统 -->
        <div id="page-dress" class="page">
            <h3>[换装]</h3>
            <div style="background:#E7E7ED; padding:15px; border-radius:8px; margin-bottom:15px;">
                <h4>当前属性</h4>
                <div class="stats-bar">
                    <div class="stat-item"><span>💄 容貌:</span> <span id="dress-charm">0</span></div>
                    <div class="stat-item"><span>✨ 气质:</span> <span id="dress-elegance">0</span></div>
                    <div class="stat-item"><span>💪 体质:</span> <span id="dress-constitution">0</span></div>
                    <div class="stat-item"><span>🎭 魅力:</span> <span id="dress-attraction">0</span></div>
                    <div class="stat-item"><span>📚 才学:</span> <span id="dress-wisdom">0</span></div>
                    <div class="stat-item"><span>⚔️ 武艺:</span> <span id="dress-martial">0</span></div>
                    <div class="stat-item"><span>🎯 心计:</span> <span id="dress-cunning">0</span></div>
                    <div class="stat-item"><span>🎵 音律:</span> <span id="dress-music">0</span></div>
                    <div class="stat-item"><span>💃 舞蹈:</span> <span id="dress-dance">0</span></div>
                    <div class="stat-item"><span>🪡 刺绣:</span> <span id="dress-embroidery">0</span></div>
                </div>
                <div class="stats-bar" style="margin-top:10px;font-size:12px;opacity:0.9;">
                    <div class="stat-item"><span>❤ 健康:</span> <span id="dress-health">100</span></div>
                    <div class="stat-item"><span>😊 心情:</span> <span id="dress-mood">50</span></div>
                </div>
            </div>
            <h4>服装</h4>
            <div id="dress-clothes-container"></div>
            <h4>饰品</h4>
            <div id="dress-accessories-container"></div>
        </div>


        <!-- 10. 答题系统 -->
        <div id="page-quiz" class="page">
            <button class="btn btn-outline" onclick="goToPage('page-game')">⬅ 返回</button>
            <h3>📚 宫廷知识问答</h3>
            <div id="quiz-container"></div>
        </div>

        <!-- 11. 侍寝界面 -->
        <div id="page-serve" class="page">
            <div style="text-align:center; padding:20px;">
                <h3>🌙 侍寝</h3>
                <div id="serve-content"></div>
                <button class="btn" onclick="goToPage('page-game')">返回</button>
            </div>
        </div>

        <!-- 11. 技能系统 -->
        <div id="page-skills" class="page">
            <h3>[技能系统]</h3>
            <div id="skills-container"></div>
        </div>

        <!-- 12. 社交系统 -->
        <div id="page-social" class="page">
            <h3>[社交空间]</h3>
            <div style="background:#E7E7ED;padding:10px;border-radius:8px;margin-bottom:15px;">
                <p>社交等级: <span id="social-level-display">籍籍无名</span></p>
                <p>社交影响力: <span id="social-influence-display">0</span></p>
            </div>
            <button class="btn btn-outline" onclick="goToPage('page-groups')"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">forum</span>群聊</button>
            <button class="btn btn-outline" onclick="goToPage('page-posts')"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">photo_library</span>朋友圈</button>
        </div>

        <!-- 15. 群聊系统 -->
        <div id="page-groups" class="page">
            <button class="btn btn-outline" onclick="goToPage('page-social')">⬅ 返回</button>
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">forum</span>群聊</h3>
            <div id="groups-container"></div>
            <button class="btn" onclick="showCreateGroupModal()"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">add</span>创建群聊</button>
        </div>

        <!-- 群聊聊天界面 -->
        <div id="page-group-chat" class="page" style="overflow:hidden;height:100%;display:flex;flex-direction:column;touch-action:pan-y;position:relative;">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-shrink:0;margin-bottom:10px;">
                <h3 id="group-chat-title" style="margin:0;">群聊</h3>
                <button class="icon-btn" onclick="toggleGroupChatSidebar()" style="color:var(--text);background:none;border:none;cursor:pointer;padding:8px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseenter="this.style.background='rgba(117,126,211,0.1)'" onmouseleave="this.style.background='transparent'">
                    <span class="material-icons" style="font-size:24px;">menu</span>
                </button>
            </div>
            <div id="group-chat-box" style="flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;touch-action:pan-y;background:rgba(225,227,237,0.35);padding:10px;border-radius:5px;margin-bottom:10px;min-height:0;"></div>
            <!-- 引用预览条（QQ风）：放在输入框上方 -->
            <div id="group-quote-bar" class="quote-bar" style="margin:0 0 8px 0;">
                <div class="quote-accent"></div>
                <div class="quote-main">
                    <div class="quote-title" id="group-quote-title">引用</div>
                    <div class="quote-snippet" id="group-quote-snippet"></div>
                </div>
                <button class="quote-close" type="button" onclick="clearQuote('group')" aria-label="关闭引用">
                    <span class="material-icons" style="font-size:18px;opacity:0.85;">close</span>
                </button>
            </div>
            <div class="chat-controls" style="display:flex;gap:5px;align-items:center;position:relative;flex-shrink:0;margin-top:auto;">
                <div style="position:relative;">
                    <button class="chat-plus-btn" onclick="toggleGroupChatPlusMenu()" style="flex-shrink:0;">+</button>
                    <div class="chat-plus-menu" id="group-chat-plus-menu" style="position:absolute;bottom:50px;left:0;z-index:1000;">
                        <div class="plus-menu-item" id="group-menu-emoji" data-original-text="表情包" onclick="event.stopPropagation(); sendEmojiFromGroupChat();"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">mood</span>表情包</div>
                        <div class="plus-menu-item" id="group-menu-image" data-original-text="图片" onclick="event.stopPropagation(); sendImageFromGroupChat();"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">image</span>图片</div>
                        <div class="plus-menu-item" id="group-menu-gift" data-original-text="礼物" onclick="event.stopPropagation(); sendGiftFromGroupChat();"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">card_giftcard</span>礼物</div>
                        <div class="plus-menu-item" id="group-menu-money" data-original-text="转账银两" onclick="event.stopPropagation(); sendMoneyFromGroupChat();"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">account_balance_wallet</span>转账银两</div>
                        <div class="plus-menu-item" id="group-menu-redpack" data-original-text="红包" onclick="event.stopPropagation(); sendRedPackFromGroupChat();"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">redeem</span>红包</div>
                        <div class="plus-menu-item" id="group-menu-memory" data-original-text="记忆历史" onclick="event.stopPropagation(); openGroupMemorySettings();"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">history</span>记忆历史</div>
                        <div class="plus-menu-item" id="group-menu-background" data-original-text="自定义背景图片" onclick="event.stopPropagation(); openGroupChatBackgroundModal();"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">palette</span>自定义背景图片</div>
                        <div class="plus-menu-item" id="group-menu-notification-sound" data-original-text="自定义提示音" onclick="event.stopPropagation(); openNotificationSoundModal('group');"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">notifications</span>自定义提示音</div>
                    </div>
                </div>
                <input type="text" id="group-chat-input" placeholder="输入消息..." style="flex:1; padding:10px; border-radius:5px; border:1px solid #AFB4E1; min-width:0;" onkeypress="if(event.key==='Enter') sendGroupMessage()">
                <button class="btn" style="width:auto; padding:8px 15px; margin-right:8px; flex-shrink:0;" onclick="sendGroupMessage()">发送</button>
                <button class="btn" style="width:auto; padding:8px 12px; font-size:20px; line-height:1; flex-shrink:0;" onclick="sendGroupMessageWithAPI()">🍥</button>
            </div>
            <!-- 右侧侧边栏 -->
            <div id="group-chat-sidebar" class="group-chat-sidebar">
                <div class="group-chat-sidebar-content">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid var(--border);">
                        <h3 style="margin:0;font-size:18px;">群聊设置</h3>
                        <button class="icon-btn" onclick="toggleGroupChatSidebar()" style="color:var(--text);background:none;border:none;cursor:pointer;padding:5px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseenter="this.style.background='rgba(117,126,211,0.1)'" onmouseleave="this.style.background='transparent'">
                            <span class="material-icons" style="font-size:20px;">close</span>
                        </button>
                    </div>
                    <button class="btn btn-outline" onclick="showGroupMembers(); toggleGroupChatSidebar();" style="width:100%;margin-bottom:10px;justify-content:flex-start;text-align:left;">
                        <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:8px;">people</span>群成员
                    </button>
                    <button class="btn btn-outline" onclick="showGroupSettings(); toggleGroupChatSidebar();" style="width:100%;margin-bottom:10px;justify-content:flex-start;text-align:left;">
                        <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:8px;">settings</span>群设置
                    </button>
                    <button class="btn btn-outline" onclick="goToPage('page-groups')" style="width:100%;justify-content:flex-start;text-align:left;">
                        <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:8px;">arrow_back</span>返回
                    </button>
                </div>
            </div>
            <!-- 侧边栏遮罩层 -->
            <div id="group-chat-sidebar-overlay" class="group-chat-sidebar-overlay" onclick="toggleGroupChatSidebar()"></div>
        </div>

        <!-- 16. 朋友圈 -->
        <div id="page-posts" class="page">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <button class="btn btn-outline" onclick="goToPage('page-social')">⬅ 返回</button>
                <button class="icon-btn" onclick="showSocialCircleSettings()" style="color:var(--text);background:none;border:none;cursor:pointer;padding:8px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseenter="this.style.background='rgba(117,126,211,0.1)'" onmouseleave="this.style.background='transparent'">
                    <span class="material-icons" style="font-size:24px;">settings</span>
                </button>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <h3 style="margin:0;"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">photo_library</span>朋友圈</h3>
                <div id="current-circle-name" style="font-size:14px;color:var(--accent);font-weight:500;"></div>
            </div>
            <div style="display:flex;gap:10px;margin-bottom:10px;">
                <button class="btn" onclick="refreshSocialCircle()" style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;">
                    <span class="material-icons" style="font-size:18px;">refresh</span>
                    <span>刷新</span>
                </button>
                <button class="btn" onclick="showCreatePostModal()" style="flex:1;">
                    <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">add</span>发布动态
                </button>
            </div>
            <div id="posts-container" style="margin-top:10px;"></div>
        </div>

        <!-- 17. 经济系统 -->
        <div id="page-economy" class="page">
            <h3>[经济系统]</h3>
            <div style="background:#E7E7ED;padding:15px;border-radius:8px;margin-bottom:15px;">
                <p style="margin:0;font-size:16px;">银两: <span id="economy-money">0</span> 两</p>
            </div>
            <button class="btn btn-outline" onclick="goToPage('page-invest')"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">trending_up</span>投资</button>
            <button class="btn btn-outline" onclick="goToPage('page-loan')"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">account_balance_wallet</span>借贷</button>
            <button class="btn btn-outline" onclick="goToPage('page-prices')"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">bar_chart</span>物价</button>
        </div>

        <!-- 19. 投资系统 -->
        <div id="page-invest" class="page">
            <button class="btn btn-outline" onclick="goToPage('page-economy')">⬅ 返回经济</button>
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">trending_up</span>投资系统</h3>
            <div id="invest-container"></div>
        </div>

        <!-- 20. 借贷系统 -->
        <div id="page-loan" class="page">
            <button class="btn btn-outline" onclick="goToPage('page-economy')">⬅ 返回经济</button>
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">account_balance_wallet</span>借贷系统</h3>
            <div id="loan-container"></div>
        </div>

        <!-- 21. 物价系统 -->
        <div id="page-prices" class="page">
            <button class="btn btn-outline" onclick="goToPage('page-economy')">⬅ 返回经济</button>
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">bar_chart</span>物价波动</h3>
            <div id="prices-container"></div>
        </div>

        <!-- 22. 剧情系统 -->
        <div id="page-story" class="page">
            <h3>[剧情]</h3>
            <div id="story-container"></div>
        </div>

        <!-- 23. 设置页面 -->
        <div id="page-settings" class="page">
            <div class="settings-section collapsed" id="settings-section-api">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <span><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">api</span>API</span>
                    <span class="material-icons arrow">expand_more</span>
                </div>
                <div class="settings-section-body">
            <p style="font-size:12px; color:#AFB4E1; margin-bottom:12px;">只有配置了API，NPC才能和你对话。</p>
            <div class="input-group">
                <label>API 地址</label>
                <input type="text" id="api-url" disabled readonly style="background:var(--bg-secondary);color:var(--text);cursor:not-allowed;">
                <p style="font-size:11px;color:#AFB4E1;margin-top:4px;">API 地址已固定，不可修改</p>
            </div>
            
            <div class="input-group">
                <label>API Key</label>
                <div style="position:relative;display:flex;align-items:center;">
                    <input type="password" id="api-key" placeholder="sk-..." style="flex:1;padding-right:40px;">
                    <span class="material-icons" id="api-key-toggle" onclick="toggleApiKeyVisibility()" style="position:absolute;right:10px;font-size:20px;color:var(--secondary);cursor:pointer;user-select:none;" title="显示/隐藏">visibility</span>
                </div>
            </div>

            <div class="input-group">
                <label>模型选择</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="api-model" placeholder="gpt-3.5-turbo">
                    <button class="btn" style="width:auto; font-size:12px;" id="fetch-models-btn" onclick="fetchModels()">获取列表</button>
                </div>
                <div id="model-list-box" class="model-list" style="display:none;"></div>
            </div>
                </div>
            </div>

            <div class="settings-section collapsed" id="settings-section-style">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <span><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">style</span>风格预设</span>
                    <span class="material-icons arrow">expand_more</span>
                </div>
                <div class="settings-section-body">
            <div class="input-group" style="margin-bottom:15px;">
                <label>风格预设（第一优先级）</label>
                <textarea id="style-preset" placeholder="如：轻松幽默、严肃正经、古风文言、偏甜恋爱向等。留空则使用默认风格。会直接影响剧情、人脉对话、群聊、动态圈内容。" rows="3" style="resize:vertical;min-height:60px;"></textarea>
                <p style="font-size:11px;color:#AFB4E1;margin-top:4px;">影响：剧情风格、人脉私聊、群聊发言、动态圈发布与评论</p>
            </div>
                </div>
            </div>

            <div class="settings-section collapsed" id="settings-section-apicall">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <span><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">api</span>API调用</span>
                    <span class="material-icons arrow">expand_more</span>
                </div>
                <div class="settings-section-body">
            <div class="input-group">
                <h3 style="margin:0 0 10px 0;font-size:16px;"><span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">api</span>API调用模式</h3>
                <p style="font-size:12px; color:#AFB4E1; margin-bottom:15px;">为每个地图设置是否启用API调用</p>
                
                <!-- 剧情模式 -->
                <div class="api-mode-item">
                    <label>
                        <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">auto_stories</span>
                        <span>剧情模式（开启后每次休息都会调用API生成剧情）</span>
                    </label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="story-mode">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <p style="font-size:12px; color:#AFB4E1; margin-bottom:15px;margin-top:5px;">关闭后点击休息将直接进入下一天，不生成剧情</p>
                <div class="api-mode-item">
                    <label>
                        <span>真实模式</span>
                    </label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="real-mode-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <p style="font-size:12px; color:#AFB4E1; margin-bottom:15px;margin-top:5px;">开启后：体力连续5天少于30必病倒；病倒后踩图以生病状态碰剧情且可能死亡；死亡触发结局；连续7天体力≥40可恢复</p>
                <!-- 地图列表 -->
                <div id="location-api-mode-list"></div>
            </div>
                </div>
            </div>

            <div class="settings-section collapsed" id="settings-section-font">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <span><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">text_fields</span>字体与字号</span>
                    <span class="material-icons arrow">expand_more</span>
                </div>
                <div class="settings-section-body">
            <div class="input-group">
                <label>字体</label>
                <select id="font-preset" onchange="toggleFontCustomInputs()" style="width:100%;padding:10px;border:1px solid #AFB4E1;border-radius:5px;background:rgba(225,227,237,0.8);font-family:inherit;">
                    <option value="default">默认（宋体）</option>
                    <option value="SimHei">黑体</option>
                    <option value="KaiTi">楷体</option>
                    <option value="Microsoft YaHei">微软雅黑</option>
                    <option value="FangSong">仿宋</option>
                    <option value="custom">其他（输入字体名）</option>
                    <option value="upload">上传字体文件</option>
                </select>
                <input type="text" id="font-custom-name" placeholder="输入字体名，如 Georgia、Arial" style="display:none;width:100%;margin-top:8px;padding:10px;border:1px solid #AFB4E1;border-radius:5px;font-family:inherit;">
                <div id="font-upload-wrap" style="display:none;margin-top:8px;">
                    <input type="file" id="font-file" accept=".ttf,.otf,.woff,.woff2,font/ttf,font/otf,font/woff,font/woff2" onchange="onFontFileSelected(this)" style="font-size:13px;">
                    <p style="font-size:11px;color:#8E96D9;margin-top:4px;">支持 .ttf / .otf / .woff / .woff2</p>
                </div>
            </div>

            <div class="input-group">
                <label>字体大小</label>
                <div style="display:flex;align-items:center;gap:12px;">
                    <button type="button" class="btn btn-outline" onclick="changeFontSize(-1)" style="width:44px;padding:8px;">−</button>
                    <span id="font-size-value" style="min-width:60px;text-align:center;font-weight:bold;">16</span>
                    <span>px</span>
                    <button type="button" class="btn btn-outline" onclick="changeFontSize(1)" style="width:44px;padding:8px;">+</button>
                </div>
                <p style="font-size:12px; color:#8E96D9; margin-top:5px;">调大或调小全局字体（12–24px）</p>
            </div>
                </div>
            </div>

            <div class="input-group">
                <label>全屏模式</label>
                <button type="button" class="btn" id="fullscreen-btn" onclick="toggleFullscreen()" style="width:100%;">进入全屏</button>
                <p style="font-size:12px; color:#8E96D9; margin-top:5px;">点击后强制进入浏览器全屏，按 Esc 或再次点击按钮可退出全屏</p>
            </div>

            <button class="btn" onclick="saveSettings()">保存设置</button>
            <button class="btn btn-outline" onclick="goToPage('page-load')">读取存档</button>
            <button class="btn btn-outline" onclick="saveGame()">保存存档</button>
            <button class="btn btn-outline" onclick="openRestartModal()" style="color:var(--danger);border-color:var(--danger);">重开</button>

            <div class="settings-section collapsed" id="settings-section-cheat">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <span><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">extension</span>金手指模式</span>
                    <span class="material-icons arrow">expand_more</span>
                </div>
                <div class="settings-section-body">
            <p style="font-size:12px; color:#AFB4E1; margin-bottom:15px;">开启后当前存档将获得满属性、满银两、最高职位、全地图解锁等，仅建议体验剧情使用。</p>
            <div class="api-mode-item">
                <label>金手指模式</label>
                <label class="toggle-switch" id="cheat-mode-switch-wrap">
                    <input type="checkbox" id="cheat-mode-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
                </div>
            </div>

            <div class="settings-section collapsed" id="settings-section-theme">
                <div class="settings-section-header" onclick="toggleSettingsSection(this)">
                    <span><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">palette</span>自定义配色</span>
                    <span class="material-icons arrow">expand_more</span>
                </div>
                <div class="settings-section-body">
            <p style="font-size:12px; color:#AFB4E1; margin-bottom:12px;">每个存档都有独立的配色方案</p>
            
            <div class="input-group">
                <label>主色 (Primary)</label>
                <input type="color" id="theme-primary" value="#757ED3" onchange="updateThemePreview()">
            </div>

            <div class="input-group">
                <label>次要色 (Secondary)</label>
                <input type="color" id="theme-secondary" value="#AFB4E1" onchange="updateThemePreview()">
            </div>

            <div class="input-group">
                <label>背景色 (Background)</label>
                <input type="color" id="theme-bg" value="#D1D4E8" onchange="updateThemePreview()">
            </div>

            <div class="input-group">
                <label>文字色 (Text)</label>
                <input type="color" id="theme-text" value="#4a403a" onchange="updateThemePreview()">
            </div>

            <div class="input-group">
                <label>强调色 (Accent)</label>
                <input type="color" id="theme-accent" value="#8E96D9" onchange="updateThemePreview()">
            </div>

            <div class="input-group">
                <label>危险色 (Danger)</label>
                <input type="color" id="theme-danger" value="#C85A7A" onchange="updateThemePreview()">
            </div>

            <div style="margin-top: 15px;">
                <button class="btn" onclick="saveTheme()">保存配色</button>
                <button class="btn btn-outline" onclick="resetTheme()">重置为默认</button>
            </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 子导航栏 -->
    <div id="sub-nav"></div>

    <!-- 底部导航栏 -->
    <!-- 导航栏图标方案：
    方案1（当前）：单字 - 主/社/功/设
    方案2：符号 - □/○/△/◇
    方案3：字母 - H/S/F/C (Home/Social/Function/Config)
    方案4：中文标识 - [主]/[社]/[功]/[设]
    -->
    <div id="bottom-nav">
        <div class="nav-item active" onclick="switchMainNav(0)">
            <div class="nav-item-icon"><span class="material-icons">home</span></div>
            <div class="nav-item-text">主页</div>
        </div>
        <div class="nav-item" onclick="switchMainNav(1)">
            <div class="nav-item-icon"><span class="material-icons">people</span></div>
            <div class="nav-item-text">社交</div>
        </div>
        <div class="nav-item" onclick="switchMainNav(2)">
            <div class="nav-item-icon"><span class="material-icons">apps</span></div>
            <div class="nav-item-text">功能</div>
        </div>
        <div class="nav-item" onclick="switchMainNav(3)">
            <div class="nav-item-icon"><span class="material-icons">settings</span></div>
            <div class="nav-item-text">设置</div>
        </div>
    </div>
    </div>
</div>

        <!-- 记忆历史设置模态框 -->
<div id="memory-modal" class="npc-edit-modal" onclick="if(event.target===this) closeMemorySettings()">
    <div class="modal-content">
        <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">history</span>记忆历史设置</h3>
        <div class="input-group">
            <label>记忆条数（当前对话对象：<span id="memory-npc-name"></span>）</label>
            <input type="number" id="memory-count" min="0" value="100" placeholder="输入记忆设置">
            <p style="font-size:12px;color:#757ED3;margin-top:5px;" id="memory-description">设置对方回复时记忆的条数，默认100条。设置为0表示使用该角色的所有对话记录（永久保存）</p>
        </div>
        <div class="input-group">
            <label>当前对话记录总数：<span id="current-memory-count">0</span> 条（所有记录都会永久保存）</label>
        </div>
        <button class="btn" onclick="saveMemorySettings()">💾 保存</button>
        <button class="btn btn-outline" onclick="closeMemorySettings()">取消</button>
    </div>
</div>

<!-- 自定义背景图片模态框（找TA内+号） -->
<div id="chat-background-modal" class="npc-edit-modal" onclick="if(event.target===this) closeChatBackgroundModal()" style="display:none;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:420px;width:90%;">
        <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">palette</span>自定义背景图片</h3>
        <div class="input-group">
            <label>图片链接</label>
            <input type="url" id="chat-background-url" placeholder="https://... 或留空后选择本地图片">
        </div>
        <div class="input-group">
            <label>或选择本地图片</label>
            <input type="file" id="chat-background-file" accept="image/*" style="font-size:13px;">
        </div>
        <div class="input-group" id="chat-background-preview-wrap" style="display:none;">
            <label>当前预览</label>
            <div id="chat-background-preview" style="width:100%;height:120px;background:var(--secondary);border-radius:8px;background-position:center;"></div>
            <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
                <span style="font-size:13px;color:var(--text);">缩放</span>
                <button type="button" class="btn btn-outline" onclick="chatBackgroundScaleChange(-1)" style="padding:4px 10px;font-size:13px;">缩小</button>
                <span id="chat-background-scale-text" style="font-size:13px;min-width:40px;">100%</span>
                <button type="button" class="btn btn-outline" onclick="chatBackgroundScaleChange(1)" style="padding:4px 10px;font-size:13px;">放大</button>
            </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-outline" onclick="clearChatBackgroundImage()">清除</button>
            <button class="btn" onclick="saveChatBackground()">保存</button>
            <button class="btn btn-outline" onclick="closeChatBackgroundModal()">取消</button>
        </div>
    </div>
</div>

<!-- 剧情弹窗 -->
<div id="story-modal" onclick="if(event.target===this) closeStoryModal()">
    <div class="story-modal-content">
        <div class="story-title" id="story-modal-title"></div>
        <div class="story-content" id="story-modal-content"></div>
        <div class="story-date" id="story-modal-date"></div>
        <div id="story-modal-actions" style="display:none;margin-top:12px;gap:10px;">
            <button class="btn btn-outline" id="story-modal-edit-btn" style="flex:1;">编辑</button>
            <button class="btn" id="story-modal-delete-btn" style="flex:1;background:var(--danger);color:white;border:none;">删除</button>
        </div>
        <div id="story-modal-edit-wrap" style="display:none;margin-top:12px;">
            <textarea id="story-modal-edit-content" rows="8" style="width:100%;padding:10px;border:1px solid var(--secondary);border-radius:8px;resize:vertical;margin-bottom:8px;"></textarea>
            <div style="display:flex;gap:10px;">
                <button class="btn" onclick="saveStoryChoiceEdit()" style="flex:1;">保存</button>
                <button class="btn btn-outline" onclick="cancelStoryChoiceEdit()" style="flex:1;">取消</button>
            </div>
        </div>
        <button class="btn" id="story-modal-continue-btn" onclick="closeStoryModal()" style="width:100%; margin-top:15px;">继续</button>
    </div>
</div>

        <!-- NPC编辑/添加模态框 -->
<div id="npc-edit-modal" class="npc-edit-modal" onclick="if(event.target===this) closeNPCEdit()">
    <div class="modal-content" style="max-width:420px;width:90%;background:var(--bg);border-radius:16px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,0.2);max-height:85vh;overflow-y:auto;">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:20px 24px;color:white;">
            <h3 id="npc-edit-modal-title" style="margin:0;font-size:18px;font-weight:bold;">编辑角色设定</h3>
        </div>
        <div style="padding:20px 24px;">
        <div class="input-group">
            <label>姓名</label>
            <input type="text" id="edit-npc-name" placeholder="姓名">
        </div>
        <div class="input-group">
            <label>身份</label>
            <input type="text" id="edit-npc-role" placeholder="身份">
        </div>
        <div class="input-group">
            <label>性格</label>
            <input type="text" id="edit-npc-personality" placeholder="性格">
        </div>
        <div class="input-group">
            <label>背景</label>
            <textarea id="edit-npc-background" rows="2" placeholder="背景"></textarea>
        </div>
        <div class="input-group">
            <label>好感度</label>
            <input type="number" id="edit-npc-affection" min="0" max="100" placeholder="好感度">
        </div>
        <div class="input-group">
            <label>性别</label>
            <select id="edit-npc-gender">
                <option value="男">男</option>
                <option value="女">女</option>
            </select>
        </div>
        <div class="input-group">
            <label style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="edit-npc-can-send-emoji" style="width:20px; height:20px;">
                <span>发表情包（勾选后该NPC有概率发送表情包）</span>
            </label>
        </div>
        <div id="edit-npc-hasSyphilis-wrap" style="display:none;">
            <div class="input-group">
                <label style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="edit-npc-hasSyphilis" style="width:20px; height:20px;">
                    <span>身患花柳（仅真实模式下可见；由设定决定该角色是否患有，具传染性）</span>
                </label>
            </div>
        </div>
        <div id="edit-npc-child-attrs-wrap" style="display:none;">
            <div class="input-group"><label>子女属性 · 体质</label><input type="number" id="edit-child-constitution" min="0" max="100" placeholder="0-100"></div>
            <div class="input-group"><label>子女属性 · 才学</label><input type="number" id="edit-child-talent" min="0" max="100" placeholder="0-100"></div>
            <div class="input-group"><label>子女属性 · 魅力</label><input type="number" id="edit-child-charm" min="0" max="100" placeholder="0-100"></div>
            <div class="input-group"><label>子女属性 · 智慧</label><input type="number" id="edit-child-wisdom" min="0" max="100" placeholder="0-100"></div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px;">
            <button class="btn" onclick="saveNPCEdit()" style="min-width:90px;padding:10px 16px;font-weight:bold;border-radius:10px;">保存</button>
            <button id="npc-edit-delete-btn" class="btn" style="background:var(--danger);color:white;min-width:90px;padding:10px 16px;font-weight:bold;border-radius:10px;border:none;" onclick="showDeleteNPCConfirmModal()">删除</button>
            <button class="btn btn-outline" onclick="closeNPCEdit()">取消</button>
        </div>
        </div>
    </div>
</div>

<!-- 个人信息编辑弹窗（主角姓名、出身、年龄、主角设定） -->
<div id="player-info-modal" onclick="if(event.target===this) closePlayerInfoModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:420px;width:90%;background:var(--bg);border-radius:16px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,0.2);max-height:85vh;overflow-y:auto;">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:20px 24px;color:white;">
            <h3 style="margin:0;font-size:18px;font-weight:bold;"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:6px;">person</span>个人信息</h3>
        </div>
        <div style="padding:20px 24px;">
            <div class="input-group">
                <label>主角姓名</label>
                <input type="text" id="player-info-name" placeholder="姓名">
            </div>
            <div class="input-group">
                <label>主角出身</label>
                <select id="player-info-origin" style="width:100%;padding:10px;border:1px solid #AFB4E1;border-radius:5px;background:rgba(225,227,237,0.8);">
                    <option value="官宦">官宦之女 (人脉+)</option>
                    <option value="商贾">商贾之女 (财富+)</option>
                    <option value="平民">平民之女 (体力+)</option>
                    <option value="医女">医者之女 (医术+)</option>
                    <option value="书香">书香门第 (才学+)</option>
                    <option value="武将">武将之女 (武艺+)</option>
                    <option value="乐师">乐师之女 (音律+)</option>
                    <option value="绣娘">绣娘之女 (刺绣+)</option>
                    <option value="舞姬">舞姬之女 (舞蹈+)</option>
                    <option value="商女">商女 (财富+魅力+)</option>
                    <option value="孤女">孤女 (心计+)</option>
                    <option value="罪臣">罪臣之女 (心计+体质+)</option>
                    <option value="外族">外族之女 (武艺+魅力+)</option>
                    <option value="庶女">庶女 (心计+才学+)</option>
                    <option value="嫡女">嫡女 (气质+人脉+)</option>
                    <option value="宫女">宫女之女 (体质+刺绣+)</option>
                    <option value="道士">道士之女 (才学+心计+)</option>
                    <option value="江湖">江湖之女 (武艺+魅力+)</option>
                    <option value="青楼">青楼之女 (魅力+音律+)</option>
                    <option value="农家">农家之女 (体质+刺绣+)</option>
                    <option value="工匠">工匠之女 (才学+体质+)</option>
                </select>
            </div>
            <div class="input-group">
                <label>年龄</label>
                <select id="player-info-age" style="width:100%;padding:10px;border:1px solid #AFB4E1;border-radius:5px;background:rgba(225,227,237,0.8);">
                    <option value="13">13岁</option>
                    <option value="14">14岁</option>
                    <option value="15" selected>15岁</option>
                    <option value="16">16岁</option>
                    <option value="17">17岁</option>
                    <option value="18">18岁</option>
                </select>
            </div>
            <div class="input-group">
                <label>主角设定</label>
                <textarea id="player-info-character" rows="3" placeholder="可以填写角色的性格、背景、特殊设定等..." style="width:100%;padding:10px;border:1px solid #AFB4E1;border-radius:5px;background:rgba(225,227,237,0.8);resize:vertical;"></textarea>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:16px;">
                <button class="btn" onclick="savePlayerInfo()" style="min-width:90px;padding:10px 16px;font-weight:bold;border-radius:10px;">保存</button>
                <button class="btn btn-outline" onclick="closePlayerInfoModal()">取消</button>
            </div>
        </div>
    </div>
</div>

<!-- 孩子降生：起名 + 选API/模板 -->
<div id="birth-child-modal" onclick="if(event.target===this) closeBirthChildModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:400px;width:90%;background:var(--bg);border-radius:16px;padding:24px;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <h3 style="margin:0 0 16px 0;font-size:18px;">🎉 孩子降生</h3>
        <div id="birth-step-name">
            <div class="input-group">
                <label>为孩子起名</label>
                <input type="text" id="birth-child-name" placeholder="请输入姓名" maxlength="20">
            </div>
            <button class="btn" onclick="birthConfirmName()" style="width:100%;margin-top:12px;">下一步</button>
        </div>
        <div id="birth-step-api" style="display:none;">
            <p style="margin:0 0 12px 0;color:var(--text);">是否使用 API 生成孩子的性别、背景、性格？</p>
            <div style="display:flex;gap:10px;margin-top:12px;">
                <button class="btn" id="birth-btn-api" onclick="birthChooseAPI(true)" style="flex:1;">开 API</button>
                <button class="btn btn-outline" onclick="birthChooseAPI(false)" style="flex:1;">不开（模板）</button>
            </div>
        </div>
    </div>
</div>

<!-- 遇地图：选择该角色可出现在哪些地图（除内务府外） -->
<div id="encounter-map-modal" onclick="if(event.target===this) closeEncounterMapModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:420px;width:90%;max-height:80vh;overflow-y:auto;background:var(--bg);border-radius:16px;padding:24px;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <h3 id="encounter-map-title" style="margin:0 0 12px 0;font-size:18px;"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">map</span>遇地图</h3>
        <p style="margin:0 0 12px 0;font-size:13px;color:var(--text);">勾选后，该角色可在对应地图被 API 剧情安排出场，并会记住该次遭遇。</p>
        <div id="encounter-map-list"></div>
        <div style="display:flex;gap:10px;margin-top:16px;">
            <button class="btn" onclick="saveEncounterMap()">保存</button>
            <button class="btn btn-outline" onclick="closeEncounterMapModal()">取消</button>
        </div>
    </div>
</div>

<!-- 遇地图历史：该角色在各地图的遭遇剧情 -->
<div id="encounter-map-history-modal" onclick="if(event.target===this) closeEncounterMapHistoryModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:520px;width:92%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;background:var(--bg);border-radius:16px;padding:0;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="padding:20px 24px;border-bottom:1px solid rgba(0,0,0,0.06);flex-shrink:0;">
            <h3 id="encounter-history-title" style="margin:0;font-size:18px;"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">history_edu</span>遇地图历史</h3>
        </div>
        <div id="encounter-map-history-list" style="flex:1;overflow-y:auto;padding:16px 24px 24px;min-height:120px;"></div>
        <div style="padding:16px 24px;border-top:1px solid rgba(0,0,0,0.06);">
            <button class="btn btn-outline" onclick="closeEncounterMapHistoryModal()" style="width:100%;">关闭</button>
        </div>
    </div>
</div>

<!-- 自定义气泡：我的气泡（仅当前对话角色），库内可编辑并改为某人的气泡 -->
<div id="bubble-style-modal" onclick="if(event.target===this) closeBubbleStyleModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:560px;width:94%;max-height:90vh;overflow-y:auto;background:var(--bg);border-radius:16px;padding:24px;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <h3 style="margin:0;"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">chat_bubble</span>自定义气泡</h3>
            <button type="button" class="help-btn" onclick="closeBubbleStyleModal();openBubbleLibraryModal();" title="气泡库" style="color:var(--accent);background:rgba(117,126,211,0.12);border-color:rgba(117,126,211,0.3);">
                <span class="material-icons" style="font-size:20px;">library_books</span>
            </button>
        </div>
        <p style="margin:0 0 16px 0;font-size:13px;color:var(--text);opacity:0.85;" id="bubble-modal-desc">「我的气泡」仅用于你与<strong>当前这位</strong>对话时你的发言；在气泡库中点编辑可改为给其他角色用，库中会显示为那人名字的气泡。</p>
        <div id="bubble-modal-user-section" style="display:block;">
            <div id="bubble-modal-apply-npc-row" class="input-group" style="display:none;"><label>选择给哪个角色用</label><select id="bubble-apply-npc-id" onchange="onBubbleApplySelectChange()" style="width:100%;padding:8px;border:1px solid #AFB4E1;border-radius:5px;background:rgba(225,227,237,0.8);font-family:inherit;"></select><div id="bubble-apply-selected-wrap" style="margin-top:6px;font-size:12px;color:var(--accent);opacity:0.9;">当前已选：<span id="bubble-apply-selected-label">—</span></div></div>
            <div style="display:grid;grid-template-columns:1fr auto;gap:20px;align-items:start;">
                <div>
                    <div style="font-size:13px;color:var(--accent);margin-bottom:10px;font-weight:600;">我的气泡（与当前角色对话时）</div>
                    <div class="input-group"><label>背景色</label><input type="text" id="bubble-user-bg" placeholder="如 #757ED3 或 linear-gradient(...)" oninput="refreshBubblePreview()" style="width:100%;padding:8px;"></div>
                    <div class="input-group"><label>文字色</label><input type="text" id="bubble-user-color" placeholder="如 #fff" oninput="refreshBubblePreview()" style="width:100%;padding:8px;"></div>
                    <div class="input-group"><label>圆角(px)</label><input type="number" id="bubble-user-radius" placeholder="10" min="0" oninput="refreshBubblePreview()" style="width:100%;padding:8px;"></div>
                    <div class="input-group"><label>内边距</label><input type="text" id="bubble-user-padding" placeholder="如 8 12 或 10px" oninput="refreshBubblePreview()" style="width:100%;padding:8px;"></div>
                    <div class="input-group"><label>边框(CSS)</label><input type="text" id="bubble-user-border" placeholder="如 1px solid rgba(0,0,0,0.1)" oninput="refreshBubblePreview()" style="width:100%;padding:8px;"></div>
                    <div class="input-group"><label>背景图(URL)</label><input type="text" id="bubble-user-bg-image" placeholder="图片链接作背景" oninput="refreshBubblePreview()" style="width:100%;padding:8px;"></div>
                </div>
                <div style="min-width:140px;padding:12px;background:rgba(0,0,0,0.04);border-radius:12px;text-align:center;">
                    <div style="font-size:11px;color:var(--accent);margin-bottom:8px;">预览</div>
                    <div id="bubble-preview-user" style="display:inline-block;max-width:100%;word-break:break-word;text-align:left;">你好，这是一条消息。</div>
                </div>
            </div>
        </div>
        <hr style="margin:20px 0;border:0;border-top:1px solid var(--secondary);">
        <div style="font-size:14px;color:var(--accent);margin-bottom:6px;">让 AI 帮你做气泡</div>
        <p style="margin:0 0 8px 0;font-size:12px;color:var(--text);opacity:0.8;">将<strong>调用已配置的 AI 接口</strong>根据描述生成样式，会消耗 API 额度。</p>
        <div class="input-group"><label>描述效果</label><textarea id="bubble-ai-desc" placeholder="如：淡粉色渐变、古风花纹、简约白底黑字、星空背景" rows="2" style="width:100%;padding:8px;resize:vertical;"></textarea></div>
        <button class="btn btn-outline" id="bubble-ai-btn-user" onclick="requestBubbleStyleFromAI('user')" style="width:100%;">生成我的气泡</button>
        <div style="display:flex;gap:10px;margin-top:16px;"><button class="btn" onclick="saveBubbleStyle()">保存</button><button class="btn btn-outline" onclick="closeBubbleStyleModal()">取消</button></div>
    </div>
</div>

<!-- 气泡库 -->
<div id="bubble-library-modal" onclick="if(event.target===this) closeBubbleLibraryModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10002;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:520px;width:94%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;background:var(--bg);border-radius:16px;padding:0;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="flex-shrink:0;padding:16px 20px;border-bottom:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:space-between;">
            <h3 style="margin:0;"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">library_books</span>气泡库</h3>
            <button type="button" class="help-btn" onclick="closeBubbleLibraryModal()" style="color:var(--text);">✕</button>
        </div>
        <div style="flex:1;overflow-y:auto;padding:12px;">
            <div id="bubble-library-toolbar" style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
                <span style="font-size:12px;color:var(--text);opacity:0.8;">勾选 1 条或多项后导出/删除，不勾选则导出全部</span>
                <button type="button" class="btn btn-outline" style="padding:6px 12px;font-size:13px;" onclick="bubbleLibrarySelectAll()">全选</button>
                <button type="button" id="bubble-library-unselect-all-btn" class="btn btn-outline" style="display:none;padding:6px 12px;font-size:13px;" onclick="bubbleLibraryUnselectAll()">取消全选</button>
                <button type="button" class="btn btn-outline" style="padding:6px 12px;font-size:13px;" onclick="bubbleLibraryExportSelected()">导出选中</button>
                <button type="button" id="bubble-library-delete-selected-btn" class="btn btn-outline" style="display:none;padding:6px 12px;font-size:13px;color:var(--danger);border-color:rgba(200,90,122,0.5);" onclick="bubbleLibraryDeleteSelected()">删除选中</button>
                <label class="btn btn-outline" style="padding:6px 12px;font-size:13px;margin:0;cursor:pointer;">导入<input type="file" accept=".json" style="display:none;" onchange="bubbleLibraryImportFile(event)"></label>
            </div>
            <div id="bubble-library-list"></div>
            <div id="bubble-library-empty" style="display:none;text-align:center;color:var(--text);opacity:0.7;padding:24px;font-size:14px;">暂无气泡，在「自定义气泡」中保存后会自动加入此处。</div>
        </div>
    </div>
</div>

<!-- 自定义转账样式 -->
<div id="transfer-style-modal" onclick="if(event.target===this) closeTransferStyleModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:520px;width:94%;max-height:90vh;overflow-y:auto;background:var(--bg);border-radius:16px;padding:24px;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <h3 style="margin:0;"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">payments</span>自定义转账样式</h3>
            <button type="button" class="help-btn" onclick="closeTransferStyleModal();openTransferLibraryModal();" title="转账样式库" style="color:var(--accent);background:rgba(117,126,211,0.12);border-color:rgba(117,126,211,0.3);">
                <span class="material-icons" style="font-size:20px;">library_books</span>
            </button>
        </div>
        <p style="margin:0 0 16px 0;font-size:13px;color:var(--text);opacity:0.85;">配置聊天中的转账卡片样式。</p>
        <div id="transfer-apply-npc-row" class="input-group" style="display:none;"><label>选择给哪个角色用</label><select id="transfer-apply-npc-id" style="width:100%;padding:8px;border:1px solid #AFB4E1;border-radius:5px;background:rgba(225,227,237,0.8);font-family:inherit;"></select></div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:20px;align-items:start;">
            <div>
                <div style="font-size:13px;color:var(--accent);margin-bottom:10px;font-weight:600;">转账卡片样式</div>
                <div class="input-group"><label>背景(CSS)</label><input type="text" id="transfer-style-bg" placeholder="如 linear-gradient(135deg,#757ED3,#8E96D9)" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>背景图(URL)</label><input type="text" id="transfer-style-bg-image" placeholder="图片链接作背景" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>文字色</label><input type="text" id="transfer-style-color" placeholder="如 #fff" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>圆角(px)</label><input type="number" id="transfer-style-radius" placeholder="12" min="0" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>内边距(px)</label><input type="number" id="transfer-style-padding" placeholder="15" min="0" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>边框(CSS)</label><input type="text" id="transfer-style-border" placeholder="如 1px solid rgba(255,255,255,0.2)" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>图标框背景(CSS)</label><input type="text" id="transfer-style-icon-box-bg" placeholder="留空为默认金色，可填 transparent 或 linear-gradient(...)" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>金额颜色</label><input type="text" id="transfer-style-amount-color" placeholder="留空为默认金色，可填 inherit 或 #fff" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>图标</label><input type="text" id="transfer-style-icon" placeholder="Material Icons 名如 payments，或图片 URL" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>建议图标</label><div style="display:flex;flex-wrap:wrap;gap:6px;">
                    <button type="button" class="btn btn-outline" style="padding:6px 10px;font-size:12px;" onclick="setTransferIcon('payments')" title="payments">💰</button>
                    <button type="button" class="btn btn-outline" style="padding:6px 10px;font-size:12px;" onclick="setTransferIcon('account_balance_wallet')" title="account_balance_wallet">👛</button>
                    <button type="button" class="btn btn-outline" style="padding:6px 10px;font-size:12px;" onclick="setTransferIcon('savings')" title="savings">🏦</button>
                    <button type="button" class="btn btn-outline" style="padding:6px 10px;font-size:12px;" onclick="setTransferIcon('monetization_on')" title="monetization_on">💵</button>
                </div></div>
                <div class="input-group"><label>或选择本地图片</label><input type="file" id="transfer-icon-file" accept="image/*" style="font-size:13px;" onchange="onTransferIconFileSelected(event)"></div>
            </div>
            <div style="min-width:140px;padding:12px;background:rgba(0,0,0,0.04);border-radius:12px;text-align:center;">
                <div style="font-size:11px;color:var(--accent);margin-bottom:8px;">预览</div>
                <div id="transfer-preview" style="display:inline-block;max-width:100%;word-break:break-word;text-align:left;min-height:60px;">向对方转账 ¥100</div>
            </div>
        </div>
        <hr style="margin:20px 0;border:0;border-top:1px solid var(--secondary);">
        <div style="font-size:13px;color:var(--accent);margin-bottom:10px;font-weight:600;">点击转账后的显示</div>
        <div class="input-group"><label>详情弹窗背景(CSS)</label><input type="text" id="transfer-detail-bg" placeholder="如 var(--bg) 或 #fff" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
        <div class="input-group"><label>详情弹窗文字色</label><input type="text" id="transfer-detail-color" placeholder="如 var(--text)" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
        <div class="input-group"><label>详情弹窗圆角(px)</label><input type="number" id="transfer-detail-radius" placeholder="12" min="0" oninput="refreshTransferPreview()" style="width:100%;padding:8px;"></div>
        <hr style="margin:20px 0;border:0;border-top:1px solid var(--secondary);">
        <div style="font-size:14px;color:var(--accent);margin-bottom:6px;">让 AI 帮你做转账样式</div>
        <p style="margin:0 0 8px 0;font-size:12px;color:var(--text);opacity:0.8;">将<strong>调用已配置的 AI 接口</strong>根据描述生成样式，会消耗 API 额度。</p>
        <div class="input-group"><label>描述效果</label><textarea id="transfer-ai-desc" placeholder="如：古风金色、简约白底、星空渐变，可包含背景图URL" rows="2" style="width:100%;padding:8px;resize:vertical;"></textarea></div>
        <button class="btn btn-outline" id="transfer-ai-btn" onclick="requestTransferStyleFromAI()" style="width:100%;">生成转账样式</button>
        <div style="display:flex;gap:10px;margin-top:16px;"><button class="btn" onclick="saveTransferStyle()">保存</button><button class="btn btn-outline" onclick="closeTransferStyleModal()">取消</button></div>
    </div>
</div>

<!-- 转账样式库 -->
<div id="transfer-library-modal" onclick="if(event.target===this) closeTransferLibraryModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10002;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:520px;width:94%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;background:var(--bg);border-radius:16px;padding:0;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="flex-shrink:0;padding:16px 20px;border-bottom:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:space-between;">
            <h3 style="margin:0;"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">library_books</span>转账样式库</h3>
            <button type="button" class="help-btn" onclick="closeTransferLibraryModal()" style="color:var(--text);">✕</button>
        </div>
        <div style="flex:1;overflow-y:auto;padding:12px;">
            <div id="transfer-library-toolbar" style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
                <span style="font-size:12px;color:var(--text);opacity:0.8;">勾选后导出/删除，不勾选则导出全部</span>
                <button type="button" class="btn btn-outline" style="padding:6px 12px;font-size:13px;" onclick="transferLibrarySelectAll()">全选</button>
                <button type="button" id="transfer-library-unselect-all-btn" class="btn btn-outline" style="display:none;padding:6px 12px;font-size:13px;" onclick="transferLibraryUnselectAll()">取消全选</button>
                <button type="button" class="btn btn-outline" style="padding:6px 12px;font-size:13px;" onclick="transferLibraryExportSelected()">导出选中</button>
                <button type="button" id="transfer-library-delete-selected-btn" class="btn btn-outline" style="display:none;padding:6px 12px;font-size:13px;color:var(--danger);border-color:rgba(200,90,122,0.5);" onclick="transferLibraryDeleteSelected()">删除选中</button>
                <label class="btn btn-outline" style="padding:6px 12px;font-size:13px;margin:0;cursor:pointer;">导入<input type="file" accept=".json" style="display:none;" onchange="transferLibraryImportFile(event)"></label>
            </div>
            <div id="transfer-library-list"></div>
            <div id="transfer-library-empty" style="display:none;text-align:center;color:var(--text);opacity:0.7;padding:24px;font-size:14px;">暂无样式，在「自定义转账样式」中保存后会自动加入此处。</div>
        </div>
    </div>
</div>

<!-- 自定义礼物样式 -->
<div id="gift-style-modal" onclick="if(event.target===this) closeGiftStyleModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:520px;width:94%;max-height:90vh;overflow-y:auto;background:var(--bg);border-radius:16px;padding:24px;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <h3 style="margin:0;"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">card_giftcard</span>自定义礼物样式</h3>
            <button type="button" class="help-btn" onclick="closeGiftStyleModal();openGiftLibraryModal();" title="礼物样式库" style="color:var(--accent);background:rgba(117,126,211,0.12);border-color:rgba(117,126,211,0.3);">
                <span class="material-icons" style="font-size:20px;">library_books</span>
            </button>
        </div>
        <p style="margin:0 0 16px 0;font-size:13px;color:var(--text);opacity:0.85;">配置聊天中的礼物卡片样式。</p>
        <div id="gift-apply-npc-row" class="input-group" style="display:none;"><label>选择给哪个角色用</label><select id="gift-apply-npc-id" style="width:100%;padding:8px;border:1px solid #AFB4E1;border-radius:5px;background:rgba(225,227,237,0.8);font-family:inherit;"></select></div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:20px;align-items:start;">
            <div>
                <div style="font-size:13px;color:var(--accent);margin-bottom:10px;font-weight:600;">礼物卡片样式</div>
                <div class="input-group"><label>背景(CSS)</label><input type="text" id="gift-style-bg" placeholder="如 var(--primary) 或 #8E96D9" oninput="refreshGiftPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>文字色</label><input type="text" id="gift-style-color" placeholder="如 #fff" oninput="refreshGiftPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>圆角(px)</label><input type="number" id="gift-style-radius" placeholder="12" min="0" oninput="refreshGiftPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>内边距(px)</label><input type="number" id="gift-style-padding" placeholder="10" min="0" oninput="refreshGiftPreview()" style="width:100%;padding:8px;"></div>
                <div class="input-group"><label>边框(CSS)</label><input type="text" id="gift-style-border" placeholder="可选" oninput="refreshGiftPreview()" style="width:100%;padding:8px;"></div>
            </div>
            <div style="min-width:140px;padding:12px;background:rgba(0,0,0,0.04);border-radius:12px;text-align:center;">
                <div style="font-size:11px;color:var(--accent);margin-bottom:8px;">预览</div>
                <div id="gift-preview" style="display:inline-block;max-width:100%;word-break:break-word;text-align:left;min-height:60px;"></div>
            </div>
        </div>
        <hr style="margin:20px 0;border:0;border-top:1px solid var(--secondary);">
        <div style="font-size:14px;color:var(--accent);margin-bottom:6px;">让 AI 帮你做礼物样式</div>
        <p style="margin:0 0 8px 0;font-size:12px;color:var(--text);opacity:0.8;">将<strong>调用已配置的 AI 接口</strong>根据描述生成样式，会消耗 API 额度。</p>
        <div class="input-group"><label>描述效果</label><textarea id="gift-ai-desc" placeholder="如：古风金色、简约白底、宫廷风渐变" rows="2" style="width:100%;padding:8px;resize:vertical;"></textarea></div>
        <button class="btn btn-outline" id="gift-ai-btn" onclick="requestGiftStyleFromAI()" style="width:100%;">生成礼物样式</button>
        <div style="display:flex;gap:10px;margin-top:16px;"><button class="btn" onclick="saveGiftStyle()">保存</button><button class="btn btn-outline" onclick="closeGiftStyleModal()">取消</button></div>
    </div>
</div>

<!-- 礼物样式库 -->
<div id="gift-library-modal" onclick="if(event.target===this) closeGiftLibraryModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10002;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:520px;width:94%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;background:var(--bg);border-radius:16px;padding:0;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="flex-shrink:0;padding:16px 20px;border-bottom:1px solid rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:space-between;">
            <h3 style="margin:0;"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">library_books</span>礼物样式库</h3>
            <button type="button" class="help-btn" onclick="closeGiftLibraryModal()" style="color:var(--text);">✕</button>
        </div>
        <div style="flex:1;overflow-y:auto;padding:12px;">
            <div id="gift-library-toolbar" style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
                <span style="font-size:12px;color:var(--text);opacity:0.8;">勾选后导出/删除，不勾选则导出全部</span>
                <button type="button" class="btn btn-outline" style="padding:6px 12px;font-size:13px;" onclick="giftLibrarySelectAll()">全选</button>
                <button type="button" id="gift-library-unselect-all-btn" class="btn btn-outline" style="display:none;padding:6px 12px;font-size:13px;" onclick="giftLibraryUnselectAll()">取消全选</button>
                <button type="button" class="btn btn-outline" style="padding:6px 12px;font-size:13px;" onclick="giftLibraryExportSelected()">导出选中</button>
                <button type="button" id="gift-library-delete-selected-btn" class="btn btn-outline" style="display:none;padding:6px 12px;font-size:13px;color:var(--danger);border-color:rgba(200,90,122,0.5);" onclick="giftLibraryDeleteSelected()">删除选中</button>
                <label class="btn btn-outline" style="padding:6px 12px;font-size:13px;margin:0;cursor:pointer;">导入<input type="file" accept=".json" style="display:none;" onchange="giftLibraryImportFile(event)"></label>
            </div>
            <div id="gift-library-list"></div>
            <div id="gift-library-empty" style="display:none;text-align:center;color:var(--text);opacity:0.7;padding:24px;font-size:14px;">暂无样式，在「自定义礼物样式」中保存后会自动加入此处。</div>
        </div>
    </div>
</div>

<!-- 性话题：对方有意确认 -->
<div id="sex-topic-confirm-modal" onclick="if(event.target===this) closeSexTopicConfirmModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:380px;width:90%;background:var(--bg);border-radius:16px;padding:24px;">
        <p id="sex-topic-confirm-msg" style="margin:0 0 16px 0;color:var(--text);">对方有意与你有肌肤之亲，是否同意？</p>
        <div style="display:flex;gap:10px;">
            <button class="btn" onclick="sexTopicAgree()" style="flex:1;">同意</button>
            <button class="btn btn-outline" onclick="sexTopicRefuse()" style="flex:1;">拒绝</button>
        </div>
    </div>
</div>

<!-- 删除角色确认弹窗 -->
<div id="delete-npc-confirm-modal" onclick="if(event.target===this) closeDeleteNPCConfirmModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:400px;width:85%;background:var(--bg);border-radius:16px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="background:linear-gradient(135deg, var(--danger) 0%, #D85A7A 100%);padding:24px;text-align:center;color:white;">
            <div style="width:56px;height:56px;background:rgba(255,255,255,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;border:3px solid rgba(255,255,255,0.4);">
                <span class="material-icons" style="font-size:32px;">person_remove</span>
            </div>
            <h3 style="margin:0 0 4px 0;font-size:18px;font-weight:bold;">删除角色</h3>
            <p style="margin:0;font-size:13px;opacity:0.95;">此操作不可撤销</p>
        </div>
        <div style="padding:24px;">
            <p id="delete-npc-confirm-msg" style="margin:0 0 20px 0;color:var(--text);line-height:1.6;font-size:15px;"></p>
            <div style="display:flex;gap:12px;">
                <button class="btn btn-outline" onclick="closeDeleteNPCConfirmModal()" style="flex:1;">取消</button>
                <button class="btn" onclick="confirmDeleteNPC()" style="flex:1;background:linear-gradient(135deg, var(--danger) 0%, #D85A7A 100%);color:white;border:none;font-weight:bold;padding:12px;border-radius:10px;">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 表情包模态框 -->
<div id="emoji-modal" onclick="if(event.target===this) closeEmojiModal()">
    <div class="emoji-modal-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3 id="emoji-modal-title"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">mood</span>我的表情包</h3>
            <button class="icon-btn" onclick="closeEmojiModal()" style="color:var(--text);">✕</button>
        </div>
        <div id="emoji-tabs" style="display:flex;gap:5px;margin-bottom:15px;border-bottom:2px solid var(--secondary);">
            <button class="btn btn-outline" id="emoji-tab-mine" onclick="switchEmojiTab('mine')" style="flex:1;border-radius:5px 5px 0 0;border-bottom:none;background:var(--primary);color:white;">我的表情包</button>
            <button class="btn btn-outline" id="emoji-tab-other" onclick="switchEmojiTab('other')" style="flex:1;border-radius:5px 5px 0 0;border-bottom:none;">他的表情包</button>
        </div>
        <div class="emoji-grid" id="emoji-grid">
            <!-- 动态生成表情包 -->
        </div>
    </div>
</div>

<!-- 错误提示弹窗 -->
<div id="error-modal" onclick="if(event.target===this) closeErrorModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10002;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:420px;width:90%;background:var(--bg);border-radius:16px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="background:linear-gradient(135deg, var(--danger) 0%, #a04860 100%);padding:20px 24px;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="color:white;margin:0;font-size:18px;font-weight:bold;"><span class="material-icons" style="font-size:22px;vertical-align:middle;margin-right:8px;">error</span><span id="error-modal-title">错误</span></h3>
            <button class="icon-btn" onclick="closeErrorModal()" style="color:white;background:rgba(255,255,255,0.2);border-radius:50%;padding:6px;">✕</button>
        </div>
        <div style="padding:24px;">
            <div id="error-modal-content" style="color:var(--text);margin-bottom:20px;word-wrap:break-word;line-height:1.6;font-size:15px;white-space:pre-wrap;"></div>
            <button class="btn" onclick="closeErrorModal()" style="width:100%;background:linear-gradient(135deg, var(--danger) 0%, #a04860 100%);color:white;border:none;font-weight:bold;padding:12px;border-radius:10px;">确定</button>
        </div>
    </div>
</div>

<!-- 编辑消息弹层（QQ风） -->
<div id="message-edit-modal" onclick="if(event.target===this) closeMessageEditModal()">
    <div class="sheet" onclick="event.stopPropagation()">
        <div class="sheet-header">
            <div class="title">编辑消息</div>
            <div class="close" onclick="closeMessageEditModal()" aria-label="关闭">
                <span class="material-icons" style="font-size:20px;opacity:0.8;">close</span>
            </div>
        </div>
        <div class="sheet-body">
            <textarea id="message-edit-textarea" placeholder="输入新的内容..."></textarea>
        </div>
        <div class="sheet-actions">
            <button class="btn btn-outline" style="background:rgba(255,255,255,0.6);" onclick="closeMessageEditModal()">取消</button>
            <button class="btn" onclick="confirmMessageEdit()">保存</button>
        </div>
    </div>
</div>

<!-- 删除消息确认弹层（QQ风） -->
<div id="message-delete-modal" onclick="if(event.target===this) closeMessageDeleteModal()">
    <div class="sheet" onclick="event.stopPropagation()">
        <div class="sheet-header">
            <div class="title">删除消息</div>
            <div class="close" onclick="closeMessageDeleteModal()" aria-label="关闭">
                <span class="material-icons" style="font-size:20px;opacity:0.8;">close</span>
            </div>
        </div>
        <div class="sheet-body">
            <div style="font-size:12px;opacity:0.75;margin-bottom:8px;color:var(--text);">将删除这条消息（不可恢复）</div>
            <div id="message-delete-preview"></div>
        </div>
        <div class="sheet-actions">
            <button class="btn btn-outline" style="background:rgba(255,255,255,0.6);" onclick="closeMessageDeleteModal()">取消</button>
            <button class="btn" style="background:linear-gradient(135deg, var(--danger) 0%, #a04860 100%);color:white;border:none;font-weight:bold;" onclick="confirmMessageDelete()">删除</button>
        </div>
    </div>
</div>

<!-- 提示弹窗（成功/中性消息） -->
<div id="tip-modal" onclick="if(event.target===this) closeTipModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10002;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:420px;width:90%;background:var(--bg);border-radius:16px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:20px 24px;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="color:white;margin:0;font-size:18px;font-weight:bold;"><span class="material-icons" style="font-size:22px;vertical-align:middle;margin-right:8px;">info</span><span id="tip-modal-title">提示</span></h3>
            <button class="icon-btn" onclick="closeTipModal()" style="color:white;background:rgba(255,255,255,0.2);border-radius:50%;padding:6px;">✕</button>
        </div>
        <div style="padding:24px;">
            <div id="tip-modal-content" style="color:var(--text);margin-bottom:20px;word-wrap:break-word;line-height:1.6;font-size:15px;"></div>
            <button class="btn" onclick="closeTipModal()" style="width:100%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;border:none;font-weight:bold;padding:12px;border-radius:10px;">确定</button>
        </div>
    </div>
</div>

<!-- 出宫确认弹窗 -->
<div id="out-palace-confirm-modal" onclick="if(event.target===this) closeOutPalaceConfirmModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10002;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:420px;width:90%;background:var(--bg);border-radius:16px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:24px;text-align:center;color:white;">
            <div style="width:64px;height:64px;background:rgba(255,255,255,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;border:3px solid rgba(255,255,255,0.4);">
                <span class="material-icons" style="font-size:36px;">warning</span>
            </div>
            <h3 style="margin:0 0 8px 0;font-size:20px;font-weight:bold;">出宫确认</h3>
            <p style="margin:0;font-size:14px;opacity:0.95;">前往宫外有概率被发现并责罚</p>
        </div>
        <div style="padding:24px;">
            <p id="out-palace-confirm-msg" style="margin:0 0 20px 0;color:var(--text);line-height:1.6;font-size:15px;">确定要出宫吗？</p>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding:12px;background:rgba(225,227,237,0.3);border-radius:10px;">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px;color:var(--text);margin:0;">
                    <input type="checkbox" id="out-palace-no-more-tip" style="width:18px;height:18px;cursor:pointer;">
                    <span>不再提示此弹窗</span>
                </label>
                <button type="button" class="btn" id="out-palace-confirm-btn" style="min-width:100px;">确定</button>
            </div>
            <button type="button" class="btn btn-outline" onclick="closeOutPalaceConfirmModal()" style="width:100%;">取消</button>
        </div>
    </div>
</div>

<!-- 地图API调用失败选择弹窗 -->
<div id="map-api-failure-modal" onclick="if(event.target===this) closeMapApiFailureModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10002;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:420px;width:90%;background:var(--bg);border-radius:16px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="background:linear-gradient(135deg, var(--danger) 0%, #a04860 100%);padding:20px 24px;color:white;">
            <h3 style="margin:0;font-size:18px;font-weight:bold;"><span class="material-icons" style="font-size:22px;vertical-align:middle;margin-right:8px;">error</span>生成剧情失败</h3>
        </div>
        <div style="padding:24px;">
            <p id="map-api-failure-msg" style="margin:0 0 20px 0;color:var(--text);line-height:1.6;font-size:15px;white-space:pre-wrap;"></p>
            <div style="display:flex;flex-direction:column;gap:12px;">
                <button type="button" class="btn" id="map-api-failure-retry-btn" style="width:100%;">重新roll（将再次消耗API）</button>
                <button type="button" class="btn btn-outline" id="map-api-failure-rollback-btn" style="width:100%;">回退不推进时间</button>
            </div>
        </div>
    </div>
</div>

<!-- 申请借贷弹窗 -->
<div id="loan-apply-modal" onclick="if(event.target===this) closeLoanApplyModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:400px;width:90%;background:var(--bg);border-radius:16px;padding:24px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="margin:0;color:var(--text);"><span class="material-icons" style="font-size:22px;vertical-align:middle;margin-right:4px;">account_balance</span>申请借贷</h3>
            <button class="icon-btn" onclick="closeLoanApplyModal()" style="color:var(--text);">✕</button>
        </div>
        <div id="loan-apply-npc-info" style="background:rgba(225,227,237,0.5);padding:12px;border-radius:10px;margin-bottom:16px;font-size:14px;color:var(--text);"></div>
        <div class="input-group" style="margin-bottom:12px;">
            <label>借贷金额（两）</label>
            <input type="number" id="loan-apply-amount" min="1" placeholder="请输入金额" style="padding:10px;border-radius:8px;border:1px solid var(--secondary);">
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:14px;">
            <span style="color:var(--text);">当前利息</span>
            <span id="loan-apply-rate" style="color:var(--accent);font-weight:bold;">0%</span>
        </div>
        <div style="font-size:12px;color:#8E96D9;margin-bottom:16px;">30天后需还款本金+利息</div>
        <button type="button" class="btn btn-outline" id="loan-bargain-btn" style="width:100%;margin-bottom:8px;">讨价还价（降低利息）</button>
        <div id="loan-bargain-tip" style="font-size:11px;color:var(--danger);margin-bottom:12px;display:none;">每次讨价还价消耗<strong>20体力</strong>，对方可能拒绝，好感度越高越容易成功。</div>
        <div style="display:flex;gap:10px;">
            <button class="btn btn-outline" onclick="closeLoanApplyModal()" style="flex:1;">取消</button>
            <button class="btn" id="loan-apply-confirm" style="flex:1;">确认申请</button>
        </div>
    </div>
</div>

<!-- 投资申请弹窗 -->
<div id="invest-apply-modal" onclick="if(event.target===this) closeInvestApplyModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:400px;width:90%;background:var(--bg);border-radius:16px;padding:24px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="margin:0;color:var(--text);"><span class="material-icons" style="font-size:22px;vertical-align:middle;margin-right:4px;">trending_up</span>投资</h3>
            <button class="icon-btn" onclick="closeInvestApplyModal()" style="color:var(--text);">✕</button>
        </div>
        <div id="invest-apply-info" style="background:rgba(225,227,237,0.5);padding:12px;border-radius:10px;margin-bottom:16px;font-size:14px;color:var(--text);"></div>
        <div class="input-group" style="margin-bottom:16px;">
            <label>投资金额（两）</label>
            <input type="number" id="invest-apply-amount" min="0" placeholder="请输入金额" style="padding:10px;border-radius:8px;border:1px solid var(--secondary);">
        </div>
        <div style="display:flex;gap:10px;">
            <button class="btn btn-outline" onclick="closeInvestApplyModal()" style="flex:1;">取消</button>
            <button class="btn" id="invest-apply-confirm" style="flex:1;">确认投资</button>
        </div>
    </div>
</div>

<!-- 投资到期领取成功弹窗 -->
<div id="invest-claim-modal" onclick="if(event.target===this) closeInvestClaimModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:360px;width:90%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:24px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(117,126,211,0.4);display:flex;flex-direction:column;">
        <div style="padding:36px 24px;text-align:center;color:white;">
            <div style="width:80px;height:80px;background:rgba(255,255,255,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;border:4px solid rgba(255,255,255,0.4);">
                <span class="material-icons" style="font-size:48px;">savings</span>
            </div>
            <h3 style="margin:0 0 8px 0;font-size:22px;font-weight:bold;">投资到期</h3>
            <p id="invest-claim-name" style="margin:0;font-size:14px;opacity:0.95;">项目名称</p>
        </div>
        <div style="background:white;padding:24px;text-align:center;">
            <div style="font-size:13px;color:var(--text);opacity:0.7;margin-bottom:8px;">领取收益</div>
            <div style="font-size:38px;font-weight:bold;color:var(--primary);margin-bottom:4px;" id="invest-claim-amount">0</div>
            <div style="font-size:15px;color:var(--text);opacity:0.8;margin-bottom:20px;">两</div>
            <button class="btn" onclick="closeInvestClaimModal()" style="width:100%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;border:none;font-weight:bold;padding:12px;font-size:15px;border-radius:12px;">知道了</button>
        </div>
    </div>
</div>

<!-- 发布动态弹窗 -->
<div id="create-post-modal" onclick="if(event.target===this) closeCreatePostModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:500px;background:var(--bg);border-radius:16px;padding:24px;max-height:90vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="margin:0;color:var(--text);"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">edit</span>发布动态</h3>
            <button class="icon-btn" onclick="closeCreatePostModal()" style="color:var(--text);">✕</button>
        </div>
        <div class="input-group" style="margin-bottom:16px;">
            <textarea id="post-content-input" placeholder="分享你的想法..." style="width:100%;min-height:120px;padding:12px;border-radius:8px;border:1px solid var(--secondary);font-size:14px;font-family:inherit;resize:vertical;background:white;" maxlength="500"></textarea>
            <div style="text-align:right;font-size:12px;color:var(--text);opacity:0.6;margin-top:4px;">
                <span id="post-char-count">0</span>/500
            </div>
        </div>
        <div class="input-group" style="margin-bottom:16px;">
            <label style="margin-bottom:8px;display:block;color:var(--text);font-weight:500;">添加图片（可选）</label>
            <div id="post-image-preview" style="display:none;margin-bottom:12px;">
                <img id="post-image-preview-img" src="" style="max-width:100%;max-height:300px;border-radius:8px;object-fit:cover;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                <button class="btn btn-outline" onclick="removePostImage()" style="margin-top:8px;width:100%;font-size:12px;">移除图片</button>
            </div>
            <input type="file" id="post-image-input" accept="image/*" style="display:none;" onchange="handlePostImageSelect(event)">
            <button class="btn btn-outline" onclick="document.getElementById('post-image-input').click()" style="width:100%;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">image</span>选择图片
            </button>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;">
            <button class="btn btn-outline" onclick="closeCreatePostModal()" style="flex:1;">取消</button>
            <button class="btn" onclick="confirmCreatePost()" style="flex:1;">发布</button>
        </div>
    </div>
</div>

<!-- 转账详情弹窗 -->
<div id="money-detail-modal" onclick="if(event.target===this) closeMoneyDetailModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;">
    <div id="money-detail-modal-content" class="modal-content" style="max-width:420px;background:var(--bg);border-radius:12px;padding:24px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="margin:0;color:var(--text);"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;color:#FFD700;">payments</span>转账详情</h3>
            <button class="icon-btn" onclick="closeMoneyDetailModal()" style="color:var(--text);">✕</button>
        </div>
        <div style="text-align:center;padding:20px 0;">
            <div style="width:80px;height:80px;background:linear-gradient(135deg, #FFD700 0%, #FFA500 100%);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;box-shadow:0 4px 12px rgba(255,215,0,0.4);">
                <span class="material-icons" style="font-size:48px;color:white;">payments</span>
            </div>
            <div style="font-size:36px;font-weight:bold;color:#FFD700;margin-bottom:8px;" id="money-detail-amount">¥0</div>
            <div style="font-size:14px;color:var(--text);opacity:0.7;margin-bottom:24px;">银两</div>
            <div style="background:rgba(117,126,211,0.1);border-radius:8px;padding:16px;text-align:left;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <span style="color:var(--text);opacity:0.7;font-size:14px;">发送方</span>
                    <span style="color:var(--text);font-weight:500;" id="money-detail-sender">-</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <span style="color:var(--text);opacity:0.7;font-size:14px;">接收方</span>
                    <span style="color:var(--text);font-weight:500;" id="money-detail-recipient">-</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="color:var(--text);opacity:0.7;font-size:14px;">转账时间</span>
                    <span style="color:var(--text);font-weight:500;font-size:13px;" id="money-detail-time">-</span>
                </div>
            </div>
        </div>
        <button class="btn" onclick="closeMoneyDetailModal()" style="width:100%;margin-top:20px;">确定</button>
    </div>
</div>

<!-- 图片查看弹窗 -->
<div id="post-image-modal" onclick="if(event.target===this) closePostImageModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10001;align-items:center;justify-content:center;">
    <div style="position:relative;max-width:90vw;max-height:90vh;">
        <img id="post-image-modal-img" src="" style="max-width:100%;max-height:90vh;object-fit:contain;border-radius:8px;">
        <button class="icon-btn" onclick="closePostImageModal()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.5);color:white;border-radius:50%;width:36px;height:36px;">✕</button>
    </div>
</div>

<!-- 评论弹窗 -->
<div id="post-comments-modal" onclick="if(event.target===this) closePostCommentsModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:600px;max-height:80vh;background:var(--bg);border-radius:16px;padding:24px;display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-shrink:0;">
            <h3 style="margin:0;color:var(--text);"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">comment</span>评论</h3>
            <button class="icon-btn" onclick="closePostCommentsModal()" style="color:var(--text);">✕</button>
        </div>
        <div id="post-comments-list" style="flex:1;overflow-y:auto;margin-bottom:16px;padding-right:8px;">
            <!-- 动态生成评论列表 -->
        </div>
        <div style="flex-shrink:0;border-top:1px solid rgba(0,0,0,0.1);padding-top:16px;">
            <div style="display:flex;gap:10px;">
                <input type="text" id="post-comment-input" placeholder="写评论..." style="flex:1;padding:10px 14px;border-radius:20px;border:1px solid var(--secondary);font-size:14px;background:white;" onkeypress="if(event.key==='Enter') addPostComment()">
                <button class="btn" onclick="addPostComment()" style="padding:10px 20px;border-radius:20px;">
                    <span class="material-icons" style="font-size:18px;vertical-align:middle;">send</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 回复弹窗 -->
<div id="post-reply-modal" onclick="if(event.target===this) closePostReplyModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:500px;background:var(--bg);border-radius:16px;padding:24px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="margin:0;color:var(--text);"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">reply</span>回复</h3>
            <button class="icon-btn" onclick="closePostReplyModal()" style="color:var(--text);">✕</button>
        </div>
        <div id="post-reply-target" style="background:rgba(0,0,0,0.05);padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px;color:var(--text);opacity:0.8;">
            <!-- 显示回复目标 -->
        </div>
        <div class="input-group" style="margin-bottom:16px;">
            <textarea id="post-reply-input" placeholder="输入回复内容..." style="width:100%;min-height:100px;padding:12px;border-radius:8px;border:1px solid var(--secondary);font-size:14px;font-family:inherit;resize:vertical;background:white;" maxlength="200"></textarea>
            <div style="text-align:right;font-size:12px;color:var(--text);opacity:0.6;margin-top:4px;">
                <span id="post-reply-char-count">0</span>/200
            </div>
        </div>
        <div style="display:flex;gap:10px;">
            <button class="btn btn-outline" onclick="closePostReplyModal()" style="flex:1;">取消</button>
            <button class="btn" onclick="confirmPostReply()" style="flex:1;">发送</button>
        </div>
    </div>
</div>

<!-- 红包弹窗 -->
<div id="redpack-modal" onclick="if(event.target===this) closeRedPackModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;">
    <div class="modal-content" style="max-width:400px;max-height:90vh;width:90%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:20px;padding:0;overflow:hidden;box-shadow:0 8px 24px rgba(117,126,211,0.4);display:flex;flex-direction:column;">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:30px 24px;text-align:center;color:white;flex-shrink:0;">
            <div style="width:80px;height:80px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;border:3px solid rgba(255,255,255,0.3);">
                <span class="material-icons" style="font-size:48px;color:white;">redeem</span>
            </div>
            <h3 style="margin:0 0 10px 0;font-size:20px;font-weight:bold;">发红包</h3>
            <p style="margin:0;font-size:13px;opacity:0.9;">金额将随机分配给群成员</p>
        </div>
        <div style="background:white;padding:24px;flex:1;overflow-y:auto;display:flex;flex-direction:column;">
            <div class="input-group" style="margin-bottom:16px;">
                <label style="color:var(--text);font-weight:500;margin-bottom:8px;">红包金额</label>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="number" id="redpack-amount" placeholder="0" min="1" step="1" style="flex:1;padding:12px;border-radius:8px;border:2px solid var(--primary);font-size:18px;text-align:center;font-weight:bold;color:var(--primary);" oninput="updateRedPackTotal()">
                    <span style="font-size:18px;font-weight:bold;color:var(--text);">两</span>
                </div>
                <div style="text-align:center;margin-top:8px;font-size:12px;color:var(--text);opacity:0.6;">
                    当前余额：<span id="redpack-balance">0</span> 两
                </div>
            </div>
            <div class="input-group" style="margin-bottom:16px;">
                <label style="color:var(--text);font-weight:500;margin-bottom:8px;">红包个数</label>
                <input type="number" id="redpack-count" placeholder="1" min="1" step="1" value="1" style="width:100%;padding:12px;border-radius:8px;border:2px solid var(--secondary);font-size:16px;text-align:center;" oninput="updateRedPackTotal()">
            </div>
            <div class="input-group" style="margin-bottom:16px;">
                <label style="color:var(--text);font-weight:500;margin-bottom:8px;">备注（可选）</label>
                <input type="text" id="redpack-note" placeholder="恭喜发财，大吉大利" maxlength="20" style="width:100%;padding:12px;border-radius:8px;border:2px solid var(--secondary);font-size:14px;text-align:center;">
            </div>
            <div style="background:linear-gradient(135deg, rgba(117,126,211,0.1) 0%, rgba(142,150,217,0.1) 100%);padding:12px;border-radius:8px;margin-bottom:16px;text-align:center;">
                <div style="font-size:12px;color:var(--text);opacity:0.7;margin-bottom:4px;">总金额</div>
                <div style="font-size:24px;font-weight:bold;color:var(--primary);" id="redpack-total">0</div>
            </div>
            <div style="display:flex;gap:10px;flex-shrink:0;margin-top:auto;padding-top:8px;">
                <button class="btn btn-outline" onclick="closeRedPackModal()" style="flex:1;background:white;color:var(--text);border:2px solid var(--secondary);padding:12px;font-size:16px;">取消</button>
                <button class="btn" onclick="confirmSendRedPack()" style="flex:1;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;border:none;font-weight:bold;padding:12px;font-size:16px;">发送红包</button>
            </div>
        </div>
    </div>
</div>

<!-- 领取红包成功弹窗 -->
<div id="redpack-success-modal" onclick="if(event.target===this) closeRedPackSuccessModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;">
    <div class="modal-content" style="max-width:350px;width:85%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:24px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(117,126,211,0.4);display:flex;flex-direction:column;animation:scaleIn 0.3s ease-out;">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:40px 24px;text-align:center;color:white;flex-shrink:0;">
            <div style="width:100px;height:100px;background:rgba(255,255,255,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;border:4px solid rgba(255,255,255,0.4);animation:pulse 1s ease-in-out infinite;">
                <span class="material-icons" style="font-size:56px;color:white;">celebration</span>
            </div>
            <h3 style="margin:0 0 8px 0;font-size:24px;font-weight:bold;">恭喜发财！</h3>
            <p style="margin:0;font-size:15px;opacity:0.95;">红包领取成功</p>
        </div>
        <div style="background:white;padding:28px 24px;text-align:center;">
            <div style="font-size:14px;color:var(--text);opacity:0.7;margin-bottom:12px;">您领取到</div>
            <div style="font-size:42px;font-weight:bold;color:var(--primary);margin-bottom:8px;" id="redpack-success-amount">0</div>
            <div style="font-size:16px;color:var(--text);opacity:0.8;margin-bottom:20px;">两</div>
            <div style="font-size:13px;color:var(--text);opacity:0.6;margin-bottom:24px;" id="redpack-success-remaining">剩余 0/0 个</div>
            <button class="btn" onclick="closeRedPackSuccessModal()" style="width:100%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;border:none;font-weight:bold;padding:14px;font-size:16px;border-radius:12px;">知道了</button>
        </div>
    </div>
</div>

<!-- 删除存档确认弹窗 -->
<!-- 金手指模式危害提示弹窗 -->
<div id="cheat-mode-warning-modal" onclick="if(event.target===this) closeCheatModeWarningModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:380px;width:90%;background:white;border-radius:20px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,0.2);">
        <div style="background:linear-gradient(135deg, var(--danger) 0%, #D85A7A 100%);padding:28px 24px;text-align:center;color:white;">
            <span class="material-icons" style="font-size:48px;opacity:0.95;">warning</span>
            <h3 style="margin:12px 0 8px;font-size:20px;font-weight:bold;">开启金手指的危害</h3>
        </div>
        <div style="padding:20px 24px;font-size:14px;color:var(--text);line-height:1.7;">
            <p style="margin:0 0 12px;">· 将严重降低游戏挑战与成就感</p>
            <p style="margin:0 0 12px;">· 剧情与成长体验会大打折扣</p>
            <p style="margin:0 0 12px;">· 建议仅用于体验剧情或测试时使用</p>
            <p style="margin:0;font-size:13px;color:var(--secondary);">确定仍要开启吗？</p>
        </div>
        <div style="padding:0 24px 24px;display:flex;gap:12px;">
            <button class="btn btn-outline" onclick="closeCheatModeWarningModal()" style="flex:1;">取消</button>
            <button class="btn" onclick="confirmCheatModeEnable()" style="flex:1;background:var(--danger);">确认开启</button>
        </div>
    </div>
</div>

<!-- 设置已保存成功弹窗 -->
<div id="settings-saved-modal" onclick="if(event.target===this) closeSettingsSavedModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;">
    <div class="modal-content" style="max-width:350px;width:85%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:24px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(117,126,211,0.4);display:flex;flex-direction:column;animation:scaleIn 0.3s ease-out;">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:40px 24px;text-align:center;color:white;flex-shrink:0;">
            <div style="width:80px;height:80px;background:rgba(255,255,255,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;border:4px solid rgba(255,255,255,0.4);animation:pulse 1s ease-in-out infinite;">
                <span class="material-icons" style="font-size:48px;color:white;">check_circle</span>
            </div>
            <h3 style="margin:0 0 8px 0;font-size:24px;font-weight:bold;">设置已保存</h3>
        </div>
        <div style="background:white;padding:28px 24px;text-align:center;">
            <button class="btn" onclick="closeSettingsSavedModal()" style="width:100%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;border:none;font-weight:bold;padding:14px;font-size:16px;border-radius:12px;">知道了</button>
        </div>
    </div>
</div>

<!-- 配色已保存成功弹窗 -->
<div id="theme-saved-modal" onclick="if(event.target===this) closeThemeSavedModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;">
    <div class="modal-content" style="max-width:350px;width:85%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:24px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(117,126,211,0.4);display:flex;flex-direction:column;animation:scaleIn 0.3s ease-out;">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:40px 24px;text-align:center;color:white;flex-shrink:0;">
            <div style="width:80px;height:80px;background:rgba(255,255,255,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;border:4px solid rgba(255,255,255,0.4);animation:pulse 1s ease-in-out infinite;">
                <span class="material-icons" style="font-size:48px;color:white;">palette</span>
            </div>
            <h3 style="margin:0 0 8px 0;font-size:24px;font-weight:bold;">配色已保存</h3>
            <p style="margin:0;font-size:14px;opacity:0.9;" id="theme-saved-message">配色会随存档一起保存，记得保存设置和保存存档哦</p>
        </div>
        <div style="background:white;padding:28px 24px;text-align:center;">
            <button class="btn" onclick="closeThemeSavedModal()" style="width:100%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;border:none;font-weight:bold;padding:14px;font-size:16px;border-radius:12px;">知道了</button>
        </div>
    </div>
</div>

<!-- 确认覆盖存档弹窗 -->
<div id="confirm-overwrite-save-modal" onclick="if(event.target===this) closeConfirmOverwriteSaveModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;">
    <div class="modal-content" style="max-width:400px;width:85%;background:white;border-radius:24px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,0.2);display:flex;flex-direction:column;animation:scaleIn 0.3s ease-out;">
        <div style="background:linear-gradient(135deg, var(--danger) 0%, #D85A7A 100%);padding:30px 24px;text-align:center;color:white;flex-shrink:0;">
            <div style="width:70px;height:70px;background:rgba(255,255,255,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;border:4px solid rgba(255,255,255,0.4);">
                <span class="material-icons" style="font-size:40px;color:white;">warning</span>
            </div>
            <h3 style="margin:0 0 8px 0;font-size:22px;font-weight:bold;">确认覆盖存档</h3>
        </div>
        <div style="background:white;padding:28px 24px;text-align:center;">
            <p style="margin:0 0 20px 0;font-size:16px;color:var(--text);line-height:1.6;" id="confirm-overwrite-save-message">确定要覆盖存档吗？<br>此操作不可撤销！</p>
            <div style="display:flex;gap:12px;">
                <button class="btn btn-outline" onclick="closeConfirmOverwriteSaveModal()" style="flex:1;background:white;color:var(--text);border:2px solid var(--secondary);font-weight:bold;padding:12px;font-size:16px;border-radius:12px;">取消</button>
                <button class="btn" onclick="confirmOverwriteSave()" style="flex:1;background:linear-gradient(135deg, var(--danger) 0%, #D85A7A 100%);color:white;border:none;font-weight:bold;padding:12px;font-size:16px;border-radius:12px;">确认覆盖</button>
            </div>
        </div>
    </div>
</div>
<!-- 真实模式：结局弹窗（死亡后） -->
<div id="ending-modal" onclick="if(event.target===this) closeEndingModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;">
    <div class="modal-content" style="max-width:480px;width:90%;max-height:85vh;background:var(--bg);border-radius:20px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,0.25);display:flex;flex-direction:column;">
        <div style="background:linear-gradient(135deg, var(--danger) 0%, #8B4545 100%);padding:24px;text-align:center;color:white;flex-shrink:0;">
            <h3 style="margin:0;font-size:20px;font-weight:bold;">结局</h3>
            <p style="margin:8px 0 0 0;font-size:14px;opacity:0.95;">此生已尽</p>
        </div>
        <div style="padding:20px;overflow-y:auto;flex:1;">
            <p style="margin:0 0 16px 0;font-size:14px;color:var(--text);">可选择：</p>
            <div style="display:flex;flex-direction:column;gap:10px;">
                <button class="btn" onclick="onEndingViewExperience()" style="width:100%;">看经历</button>
                <p style="font-size:11px;color:var(--secondary);margin:0;">看经历将调用 API 生成这一生的经历摘要。</p>
                <button class="btn btn-outline" onclick="onEndingRestart()" style="width:100%;">重新人生</button>
                <p style="font-size:11px;color:var(--secondary);margin:0;">返回首页，选择新人生重新开始。</p>
            </div>
            <div id="ending-experience-box" style="display:none;margin-top:16px;padding:14px;background:rgba(0,0,0,0.06);border-radius:12px;white-space:pre-wrap;font-size:13px;color:var(--text);line-height:1.6;"></div>
        </div>
    </div>
</div>

<!-- 存档已更新成功弹窗 -->
<div id="save-updated-modal" onclick="if(event.target===this) closeSaveUpdatedModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;">
    <div class="modal-content" style="max-width:350px;width:85%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:24px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(117,126,211,0.4);display:flex;flex-direction:column;animation:scaleIn 0.3s ease-out;">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:40px 24px;text-align:center;color:white;flex-shrink:0;">
            <div style="width:80px;height:80px;background:rgba(255,255,255,0.25);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;border:4px solid rgba(255,255,255,0.4);animation:pulse 1s ease-in-out infinite;">
                <span class="material-icons" style="font-size:48px;color:white;">save</span>
            </div>
            <h3 style="margin:0 0 8px 0;font-size:24px;font-weight:bold;" id="save-updated-title">存档已更新</h3>
        </div>
        <div style="background:white;padding:28px 24px;text-align:center;">
            <button class="btn" onclick="closeSaveUpdatedModal()" style="width:100%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;border:none;font-weight:bold;padding:14px;font-size:16px;border-radius:12px;">知道了</button>
        </div>
    </div>
</div>

<!-- 重开确认弹窗 -->
<div id="restart-confirm-modal" onclick="if(event.target===this) closeRestartModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:480px;width:92%;max-height:85vh;background:var(--bg);border-radius:16px;padding:0;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,0.2);display:flex;flex-direction:column;">
        <div style="background:linear-gradient(135deg, var(--danger) 0%, #D85A7A 100%);padding:20px;color:white;flex-shrink:0;">
            <h3 style="margin:0;font-size:18px;"><span class="material-icons" style="font-size:22px;vertical-align:middle;margin-right:8px;">refresh</span>确认重开</h3>
            <p style="margin:8px 0 0;font-size:13px;opacity:0.95;">重开将重置游戏进度，请选择要继承的内容：</p>
        </div>
        <div id="restart-inherit-list" style="padding:16px 20px;overflow-y:auto;flex:1;min-height:0;max-height:50vh;">
            <div style="font-size:12px;color:#8E96D9;margin-bottom:10px;">身份与设定</div>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-player" checked><span>玩家设定（姓名、出身、年龄、主角设定、性别）</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-world"><span>朝代与皇帝设定</span></label>
            <div style="font-size:12px;color:#8E96D9;margin:14px 0 8px;">能力与财富</div>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-stats"><span>属性与技能</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-money"><span>银两</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-rank"><span>职位与声望、解锁地图</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-equip"><span>装备、服装、物品栏</span></label>
            <div style="font-size:12px;color:#8E96D9;margin:14px 0 8px;">社交与剧情</div>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-npcs"><span>人脉</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-groups"><span>群聊</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-social"><span>动态圈与朋友圈</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-choices"><span>重要选择与每日剧情</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-memory"><span>记忆设置（人脉/群聊）</span></label>
            <div style="font-size:12px;color:#8E96D9;margin:14px 0 8px;">其他</div>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-emperor"><span>皇帝好感度</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-invest"><span>投资与借贷</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-prices"><span>物价</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-children"><span>子女</span></label>
            <label class="restart-inherit-item"><input type="checkbox" id="restart-inherit-time"><span>游戏内时间</span></label>
        </div>
        <div style="padding:16px 20px;border-top:1px solid rgba(0,0,0,0.06);display:flex;gap:12px;flex-shrink:0;">
            <button class="btn btn-outline" onclick="restartInheritSelectAll(true)" style="flex:1;font-size:13px;">全选</button>
            <button class="btn btn-outline" onclick="restartInheritSelectAll(false)" style="flex:1;font-size:13px;">全不选</button>
            <button class="btn btn-outline" onclick="closeRestartModal()" style="flex:1;">取消</button>
            <button class="btn" onclick="confirmRestart()" style="flex:1;background:var(--danger);">确认重开</button>
        </div>
    </div>
</div>

<!-- 导出存档：选择要导出的存档（单选/多选） -->
<div id="export-save-modal" onclick="if(event.target===this) closeExportSaveModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:420px;width:90%;max-height:80vh;background:var(--bg);border-radius:16px;padding:0;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,0.2);display:flex;flex-direction:column;">
        <div style="padding:20px;border-bottom:1px solid rgba(117,126,211,0.2);flex-shrink:0;">
            <h3 style="margin:0;font-size:18px;color:var(--text);">选择要导出的存档</h3>
            <p style="margin:8px 0 0;font-size:13px;color:#8E96D9;">可单选或多选，导出为一份文档</p>
        </div>
        <div id="export-save-list" style="padding:16px;overflow-y:auto;flex:1;min-height:0;max-height:320px;">
            <!-- 动态生成复选框列表 -->
        </div>
        <div style="padding:16px;border-top:1px solid rgba(117,126,211,0.2);display:flex;gap:10px;flex-shrink:0;">
            <button class="btn btn-outline" onclick="toggleExportSelectAll()" style="flex:1;">全选/取消</button>
            <button class="btn" onclick="doExportSelected()" style="flex:1;">导出选中</button>
            <button class="btn btn-outline" onclick="closeExportSaveModal()" style="flex:1;">取消</button>
        </div>
    </div>
</div>

<div id="delete-save-modal" onclick="if(event.target===this) closeDeleteSaveModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;">
    <div class="modal-content" style="max-width:400px;width:85%;background:var(--bg);border-radius:20px;padding:0;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,0.2);display:flex;flex-direction:column;">
        <div style="background:linear-gradient(135deg, var(--danger) 0%, #E85A7A 100%);padding:30px 24px;text-align:center;color:white;flex-shrink:0;">
            <div style="width:70px;height:70px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;border:3px solid rgba(255,255,255,0.3);">
                <span class="material-icons" style="font-size:40px;color:white;">warning</span>
            </div>
            <h3 style="margin:0 0 8px 0;font-size:22px;font-weight:bold;">确认删除</h3>
            <p style="margin:0;font-size:14px;opacity:0.9;">此操作不可撤销</p>
        </div>
        <div style="background:white;padding:28px 24px;">
            <div style="text-align:center;margin-bottom:24px;">
                <div style="font-size:15px;color:var(--text);margin-bottom:8px;">确定要删除存档</div>
                <div style="font-size:18px;font-weight:bold;color:var(--text);padding:12px;background:var(--bg);border-radius:8px;margin-bottom:8px;" id="delete-save-name">未命名存档</div>
                <div style="font-size:13px;color:var(--text);opacity:0.6;">吗？</div>
            </div>
            <div style="display:flex;gap:12px;">
                <button class="btn btn-outline" onclick="closeDeleteSaveModal()" style="flex:1;background:white;color:var(--text);border:2px solid var(--secondary);padding:12px;font-size:15px;">取消</button>
                <button class="btn" onclick="confirmDeleteSave()" style="flex:1;background:linear-gradient(135deg, var(--danger) 0%, #E85A7A 100%);color:white;border:none;font-weight:bold;padding:12px;font-size:15px;">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑存档名称弹窗 -->
<div id="edit-save-modal" onclick="if(event.target===this) closeEditSaveModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;">
    <div class="modal-content" style="max-width:400px;width:85%;background:var(--bg);border-radius:20px;padding:0;overflow:hidden;box-shadow:0 8px 24px rgba(117,126,211,0.3);display:flex;flex-direction:column;">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:30px 24px;text-align:center;color:white;flex-shrink:0;">
            <div style="width:70px;height:70px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;border:3px solid rgba(255,255,255,0.3);">
                <span class="material-icons" style="font-size:40px;color:white;">edit</span>
            </div>
            <h3 style="margin:0 0 8px 0;font-size:22px;font-weight:bold;">编辑存档名称</h3>
            <p style="margin:0;font-size:14px;opacity:0.9;">为您的存档起个名字</p>
        </div>
        <div style="background:white;padding:28px 24px;">
            <div style="margin-bottom:20px;">
                <label style="display:block;color:var(--text);font-weight:500;margin-bottom:10px;font-size:14px;">存档名称</label>
                <input type="text" id="edit-save-name-input" placeholder="请输入存档名称" maxlength="20" style="width:100%;padding:14px;border-radius:10px;border:2px solid var(--secondary);font-size:15px;color:var(--text);background:var(--bg);" onkeypress="if(event.key==='Enter') confirmEditSaveName()">
            </div>
            <div style="display:flex;gap:12px;">
                <button class="btn btn-outline" onclick="closeEditSaveModal()" style="flex:1;background:white;color:var(--text);border:2px solid var(--secondary);padding:12px;font-size:15px;">取消</button>
                <button class="btn" onclick="confirmEditSaveName()" style="flex:1;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;border:none;font-weight:bold;padding:12px;font-size:15px;">确认</button>
            </div>
        </div>
    </div>
</div>

<!-- 上帝视角设置弹窗 -->
<div id="god-view-settings-modal" onclick="if(event.target===this) closeGodViewSettingsModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;">
    <div class="modal-content" style="max-width:400px;width:85%;background:var(--bg);border-radius:20px;padding:0;overflow:hidden;box-shadow:0 8px 24px rgba(117,126,211,0.3);display:flex;flex-direction:column;">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:30px 24px;text-align:center;color:white;flex-shrink:0;">
            <div style="width:70px;height:70px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;border:3px solid rgba(255,255,255,0.3);">
                <span class="material-icons" style="font-size:40px;color:white;">visibility</span>
            </div>
            <h3 style="margin:0 0 8px 0;font-size:22px;font-weight:bold;">上帝视角设置</h3>
            <p style="margin:0;font-size:14px;opacity:0.9;">配置群聊的上帝视角功能</p>
        </div>
        <div style="background:white;padding:28px 24px;">
            <div style="margin-bottom:24px;">
                <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(225,227,237,0.3);border-radius:8px;margin-bottom:20px;">
                    <div>
                        <div style="font-weight:bold;color:var(--text);">开启上帝视角</div>
                        <div style="font-size:12px;color:#8E96D9;margin-top:4px;">显示群聊中发生的详细情况</div>
                    </div>
                    <label style="position:relative;display:inline-block;width:50px;height:26px;">
                        <input type="checkbox" id="god-view-enable-toggle" style="opacity:0;width:0;height:0;" onchange="updateGodViewEnable()">
                        <span id="god-view-toggle-span" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;border-radius:26px;transition:0.3s;">
                            <span style="position:absolute;content:'';height:20px;width:20px;left:3px;bottom:3px;background-color:white;border-radius:50%;transition:0.3s;transform:translateX(0);"></span>
                        </span>
                    </label>
                </div>
                <div>
                    <label style="display:block;color:var(--text);font-weight:500;margin-bottom:10px;font-size:14px;">上帝视角字数设置</label>
                    <input type="number" id="god-view-word-count" placeholder="1000" min="500" max="5000" step="100" style="width:100%;padding:14px;border-radius:10px;border:2px solid var(--secondary);font-size:15px;color:var(--text);background:var(--bg);">
                    <div style="font-size:12px;color:var(--text);opacity:0.6;margin-top:8px;">设置上帝视角描述的详细程度（500-5000字，建议1000-2000字）</div>
                </div>
            </div>
            <div style="display:flex;gap:12px;">
                <button class="btn btn-outline" onclick="closeGodViewSettingsModal()" style="flex:1;background:white;color:var(--text);border:2px solid var(--secondary);padding:12px;font-size:15px;">取消</button>
                <button class="btn" onclick="saveGodViewSettings()" style="flex:1;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;border:none;font-weight:bold;padding:12px;font-size:15px;">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 动态圈设置弹窗 -->
<div id="social-circle-settings-modal" onclick="if(event.target===this) closeSocialCircleSettingsModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;">
    <div class="modal-content" style="max-width:500px;max-height:80vh;width:90%;background:var(--bg);border-radius:20px;padding:24px;display:flex;flex-direction:column;overflow:hidden;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-shrink:0;">
            <h3 style="margin:0;color:var(--text);"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">group</span>动态圈设置</h3>
            <button class="icon-btn" onclick="closeSocialCircleSettingsModal()" style="color:var(--text);background:none;border:none;font-size:24px;cursor:pointer;">✕</button>
        </div>
        <div style="flex:1;overflow-y:auto;margin-bottom:16px;">
            <div style="margin-bottom:16px;padding:12px;background:rgba(225,227,237,0.5);border-radius:10px;">
                <label style="display:block;color:var(--text);font-weight:500;margin-bottom:8px;font-size:14px;">记忆当前动态条数</label>
                <input type="number" id="social-circle-memory-post-count" min="5" max="50" value="10" style="width:100%;padding:10px;border-radius:8px;border:2px solid var(--secondary);font-size:15px;color:var(--text);background:white;">
                <div style="font-size:12px;color:#8E96D9;margin-top:6px;">刷新时参与AI决策的最近动态条数（默认10条）</div>
            </div>
            <div style="margin-bottom:20px;">
                <h4 style="margin:0 0 12px 0;color:var(--text);font-size:16px;font-weight:600;">动态圈列表</h4>
                <div id="social-circles-list" style="display:flex;flex-direction:column;gap:8px;">
                    <!-- 动态生成动态圈列表 -->
                </div>
            </div>
            <button class="btn" onclick="showCreateSocialCircleModal()" style="width:100%;margin-top:10px;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">add</span>创建动态圈
            </button>
        </div>
    </div>
</div>

<!-- 创建动态圈弹窗 -->
<div id="create-social-circle-modal" onclick="if(event.target===this) closeCreateSocialCircleModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10002;">
    <div class="modal-content" style="max-width:500px;max-height:80vh;width:90%;background:var(--bg);border-radius:20px;padding:24px;display:flex;flex-direction:column;overflow:hidden;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-shrink:0;">
            <h3 style="margin:0;color:var(--text);"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">add_circle</span>创建动态圈</h3>
            <button class="icon-btn" onclick="closeCreateSocialCircleModal()" style="color:var(--text);background:none;border:none;font-size:24px;cursor:pointer;">✕</button>
        </div>
        <div style="flex:1;overflow-y:auto;margin-bottom:16px;">
            <div style="margin-bottom:20px;">
                <label style="display:block;color:var(--text);font-weight:500;margin-bottom:10px;font-size:14px;">动态圈名称</label>
                <input type="text" id="social-circle-name-input" placeholder="请输入动态圈名称" maxlength="20" style="width:100%;padding:14px;border-radius:10px;border:2px solid var(--secondary);font-size:15px;color:var(--text);background:white;">
            </div>
            <div>
                <label style="display:block;color:var(--text);font-weight:500;margin-bottom:10px;font-size:14px;">选择成员（可多选）</label>
                <div id="social-circle-members-list" style="max-height:300px;overflow-y:auto;border:2px solid var(--secondary);border-radius:10px;padding:10px;background:white;">
                    <!-- 动态生成成员列表 -->
                </div>
            </div>
        </div>
        <div style="display:flex;gap:12px;flex-shrink:0;">
            <button class="btn btn-outline" onclick="closeCreateSocialCircleModal()" style="flex:1;background:white;color:var(--text);border:2px solid var(--secondary);padding:12px;font-size:15px;">取消</button>
            <button class="btn" onclick="confirmCreateSocialCircle()" style="flex:1;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;border:none;font-weight:bold;padding:12px;font-size:15px;">创建</button>
        </div>
    </div>
</div>

<!-- 动态圈背景图模态框 -->
<div id="circle-background-modal" onclick="if(event.target===this) closeCircleBackgroundModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10003;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:420px;width:90%;background:var(--bg);border-radius:16px;padding:24px;">
        <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">palette</span><span id="circle-background-title">动态圈背景图</span></h3>
        <div class="input-group">
            <label>图片链接</label>
            <input type="url" id="circle-background-url" placeholder="https://... 或留空后选择本地图片">
        </div>
        <div class="input-group">
            <label>或选择本地图片</label>
            <input type="file" id="circle-background-file" accept="image/*" style="font-size:13px;">
        </div>
        <div class="input-group" id="circle-background-preview-wrap" style="display:none;">
            <label>当前预览</label>
            <div id="circle-background-preview" style="width:100%;height:120px;background:var(--secondary);border-radius:8px;background-position:center;"></div>
            <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
                <span style="font-size:13px;color:var(--text);">缩放</span>
                <button type="button" class="btn btn-outline" onclick="circleBackgroundScaleChange(-1)" style="padding:4px 10px;font-size:13px;">缩小</button>
                <span id="circle-background-scale-text" style="font-size:13px;min-width:40px;">100%</span>
                <button type="button" class="btn btn-outline" onclick="circleBackgroundScaleChange(1)" style="padding:4px 10px;font-size:13px;">放大</button>
            </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-outline" onclick="clearCircleBackgroundImage()">清除</button>
            <button class="btn" onclick="saveCircleBackground()">保存</button>
            <button class="btn btn-outline" onclick="closeCircleBackgroundModal()">取消</button>
        </div>
    </div>
</div>

<!-- 群聊自定义背景图片模态框 -->
<div id="group-chat-background-modal" onclick="if(event.target===this) closeGroupChatBackgroundModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10004;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:420px;width:90%;background:var(--bg);border-radius:16px;padding:24px;">
        <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">palette</span>群聊背景图片</h3>
        <div class="input-group">
            <label>图片链接</label>
            <input type="url" id="group-chat-background-url" placeholder="https://... 或留空后选择本地图片">
        </div>
        <div class="input-group">
            <label>或选择本地图片</label>
            <input type="file" id="group-chat-background-file" accept="image/*" style="font-size:13px;">
        </div>
        <div class="input-group" id="group-chat-background-preview-wrap" style="display:none;">
            <label>当前预览</label>
            <div id="group-chat-background-preview" style="width:100%;height:120px;background:var(--secondary);border-radius:8px;background-position:center;"></div>
            <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
                <span style="font-size:13px;color:var(--text);">缩放</span>
                <button type="button" class="btn btn-outline" onclick="groupChatBackgroundScaleChange(-1)" style="padding:4px 10px;font-size:13px;">缩小</button>
                <span id="group-chat-background-scale-text" style="font-size:13px;min-width:40px;">100%</span>
                <button type="button" class="btn btn-outline" onclick="groupChatBackgroundScaleChange(1)" style="padding:4px 10px;font-size:13px;">放大</button>
            </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-outline" onclick="clearGroupChatBackgroundImage()">清除</button>
            <button class="btn" onclick="saveGroupChatBackground()">保存</button>
            <button class="btn btn-outline" onclick="closeGroupChatBackgroundModal()">取消</button>
        </div>
    </div>
</div>

<!-- 自定义提示音模态框（私聊/群聊通用） -->
<div id="notification-sound-modal" onclick="if(event.target===this) closeNotificationSoundModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10005;align-items:center;justify-content:center;">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:420px;width:90%;background:var(--bg);border-radius:16px;padding:24px;">
        <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">notifications</span><span id="notification-sound-title">自定义提示音</span></h3>
        <p style="font-size:13px;color:#8E96D9;margin:8px 0 12px 0;">对方回复消息时播放此音频（一次回复多条只播放一次）</p>
        <div class="input-group">
            <label>选择音频文件（支持 MP3、WAV、OGG、M4A、AAC）</label>
            <input type="file" id="notification-sound-file" accept="audio/*" style="font-size:13px;">
        </div>
        <div id="notification-sound-preview-wrap" style="display:none;margin:10px 0;font-size:13px;color:var(--text);">
            已设置提示音 <button type="button" class="btn btn-outline" onclick="previewNotificationSound()" style="padding:4px 10px;font-size:12px;margin-left:8px;">试听</button>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-outline" onclick="clearNotificationSound()">清除</button>
            <button class="btn" onclick="saveNotificationSound()">保存</button>
            <button class="btn btn-outline" onclick="closeNotificationSoundModal()">取消</button>
        </div>
    </div>
</div>

<!-- 分享选择弹窗 -->
<div id="share-select-modal" onclick="if(event.target===this) closeShareSelectModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:500px;max-height:80vh;background:var(--bg);border-radius:16px;padding:24px;display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-shrink:0;">
            <h3 style="margin:0;color:var(--text);"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">share</span>分享到</h3>
            <button class="icon-btn" onclick="closeShareSelectModal()" style="color:var(--text);">✕</button>
        </div>
        <div style="flex:1;overflow-y:auto;margin-bottom:16px;">
            <div style="margin-bottom:20px;">
                <h4 style="margin:0 0 12px 0;color:var(--text);font-size:14px;font-weight:600;">好友</h4>
                <div id="share-contacts-list" style="display:flex;flex-direction:column;gap:8px;">
                    <!-- 动态生成好友列表 -->
                </div>
            </div>
            <div>
                <h4 style="margin:0 0 12px 0;color:var(--text);font-size:14px;font-weight:600;">群聊</h4>
                <div id="share-groups-list" style="display:flex;flex-direction:column;gap:8px;">
                    <!-- 动态生成群聊列表 -->
                </div>
            </div>
        </div>
        <div style="flex-shrink:0;border-top:1px solid rgba(0,0,0,0.1);padding-top:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <span style="font-size:13px;color:var(--text);opacity:0.7;">已选择 <span id="share-selected-count">0</span> 项</span>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-outline" onclick="closeShareSelectModal()" style="flex:1;">取消</button>
                <button class="btn" onclick="confirmSharePost()" style="flex:1;">确定分享</button>
            </div>
        </div>
    </div>
</div>

<!-- 地图事件弹窗 -->
<div id="location-event-modal" onclick="if(event.target===this) closeLocationEventModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:600px;max-height:85vh;width:90%;background:var(--bg);border-radius:20px;padding:0;overflow:hidden;box-shadow:0 8px 32px rgba(117,126,211,0.3);display:flex;flex-direction:column;">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:20px;flex-shrink:0;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3 style="margin:0;color:white;font-size:18px;font-weight:600;">
                    <span class="material-icons" style="font-size:22px;vertical-align:middle;margin-right:8px;">auto_stories</span>
                    <span id="location-event-modal-title">地图事件</span>
                </h3>
                <button class="icon-btn" onclick="closeLocationEventModal()" style="color:white;background:rgba(255,255,255,0.2);border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;">✕</button>
            </div>
        </div>
        <div style="flex:1;overflow-y:auto;padding:24px;">
            <div id="location-event-modal-story" style="color:var(--text);line-height:1.8;font-size:15px;margin-bottom:20px;white-space:pre-wrap;word-wrap:break-word;"></div>
            <div id="location-event-modal-event-type" style="margin-bottom:20px;"></div>
            <div id="location-event-modal-person" style="margin-bottom:20px;"></div>
            <div id="location-event-modal-rewards" style="margin-bottom:10px;"></div>
        </div>
        <div style="flex-shrink:0;border-top:1px solid rgba(0,0,0,0.1);padding:16px 24px;background:var(--secondary);">
            <button class="btn" onclick="closeLocationEventModal()" style="width:100%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;border:none;font-weight:bold;padding:12px;font-size:16px;border-radius:12px;">继续</button>
        </div>
    </div>
</div>

<!-- 皇帝生成结果弹窗：显示皇帝信息并提供重新roll选项 -->
<div id="emperor-generate-modal" onclick="if(event.target===this) closeEmperorGenerateModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:500px;width:90%;background:var(--bg);border-radius:20px;padding:0;overflow:hidden;box-shadow:0 8px 32px rgba(117,126,211,0.3);">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:18px;text-align:center;">
            <h3 style="margin:0;color:white;font-size:17px;font-weight:600;">皇帝已生成</h3>
        </div>
        <div style="padding:20px;">
            <div id="emperor-generate-info" style="color:var(--text);line-height:1.8;font-size:14px;margin-bottom:20px;"></div>
            <div style="display:flex;flex-direction:column;gap:12px;">
                <button type="button" class="btn" onclick="confirmEmperorGenerate()" style="width:100%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;padding:12px;font-size:15px;border-radius:12px;">确认</button>
                <button type="button" class="btn" onclick="rerollEmperor()" style="width:100%;background:var(--secondary);color:var(--text);border:2px solid var(--primary);padding:12px;font-size:15px;border-radius:12px;">重新roll</button>
            </div>
        </div>
    </div>
</div>

<!-- 真实模式青楼选择弹窗：正常逛逛 / 在此打工 -->
<div id="brothel-choice-modal" onclick="if(event.target===this) closeBrothelChoiceModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:400px;width:90%;background:var(--bg);border-radius:20px;padding:0;overflow:hidden;box-shadow:0 8px 32px rgba(117,126,211,0.3);">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:18px;text-align:center;">
            <h3 style="margin:0;color:white;font-size:17px;font-weight:600;">青楼</h3>
            <p style="margin:8px 0 0;color:rgba(255,255,255,0.9);font-size:13px;">真实模式下可在此打工赚取银两，但有风险</p>
        </div>
        <div style="padding:20px;display:flex;flex-direction:column;gap:12px;">
            <button type="button" class="btn" onclick="onBrothelChoice('explore')" style="width:100%;background:var(--secondary);color:var(--text);border:2px solid var(--primary);padding:14px;font-size:15px;border-radius:12px;">正常逛逛</button>
            <button type="button" class="btn" onclick="onBrothelChoice('work')" style="width:100%;background:var(--secondary);color:var(--text);border:2px solid var(--primary);padding:14px;font-size:15px;border-radius:12px;">在此打工</button>
        </div>
        <div style="flex-shrink:0;padding:0 20px 16px;">
            <button type="button" class="icon-btn" onclick="closeBrothelChoiceModal()" style="width:100%;padding:10px;font-size:13px;color:var(--text);">取消</button>
        </div>
    </div>
</div>

<!-- 对食剧情选择弹窗：加入/观战/偷窥/逃离 -->
<div id="duishi-choice-modal" onclick="if(event.target===this) closeDuishiChoiceModal()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10001;align-items:center;justify-content:center;">
    <div class="modal-content" style="max-width:420px;width:90%;background:var(--bg);border-radius:20px;padding:0;overflow:hidden;box-shadow:0 8px 32px rgba(117,126,211,0.3);">
        <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:18px;text-align:center;">
            <h3 id="duishi-choice-modal-title" style="margin:0;color:white;font-size:17px;font-weight:600;">你发现了对食场景</h3>
            <p style="margin:8px 0 0;color:rgba(255,255,255,0.9);font-size:13px;">你要如何应对？</p>
        </div>
        <div style="padding:20px;display:flex;flex-direction:column;gap:12px;">
            <button type="button" class="btn" onclick="onDuishiChoice('join')" style="width:100%;background:var(--secondary);color:var(--text);border:2px solid var(--primary);padding:14px;font-size:15px;border-radius:12px;">加入</button>
            <button type="button" class="btn" onclick="onDuishiChoice('spectate')" style="width:100%;background:var(--secondary);color:var(--text);border:2px solid var(--primary);padding:14px;font-size:15px;border-radius:12px;">观战</button>
            <button type="button" class="btn" onclick="onDuishiChoice('peek')" style="width:100%;background:var(--secondary);color:var(--text);border:2px solid var(--primary);padding:14px;font-size:15px;border-radius:12px;">偷窥</button>
            <button type="button" class="btn" onclick="onDuishiChoice('escape')" style="width:100%;background:var(--secondary);color:var(--text);border:2px solid var(--primary);padding:14px;font-size:15px;border-radius:12px;">逃离</button>
        </div>
        <div style="flex-shrink:0;padding:0 20px 16px;">
            <button type="button" class="icon-btn" onclick="closeDuishiChoiceModal()" style="width:100%;padding:10px;font-size:13px;color:var(--text);">取消</button>
        </div>
    </div>
</div>

<!-- 添加表情包弹窗 -->
<div id="add-emoji-modal" onclick="if(event.target===this) closeAddEmojiModal()">
    <div class="modal-content" style="max-width:400px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">add_photo_alternate</span>添加表情包</h3>
            <button class="icon-btn" onclick="closeAddEmojiModal()" style="color:var(--text);">✕</button>
        </div>
        <div class="input-group">
            <label>表情包描述（可选）</label>
            <input type="text" id="emoji-description-input" placeholder="例如：开心、难过、生气...">
            <p style="font-size:11px;color:#8E96D9;margin-top:4px;line-height:1.4;">
                💡 提示：如果不填写描述，某些不支持图片识别的AI模型可能无法理解图片内容。建议填写简短描述（如"开心的表情"、"生气的样子"等），这样AI能更好地理解你的意图。
            </p>
        </div>
        <div class="input-group">
            <label>选择图片</label>
            <input type="file" id="emoji-file-input" accept="image/*" style="display:none;" onchange="handleEmojiFileSelect(event)">
            <button class="btn" onclick="document.getElementById('emoji-file-input').click()" style="width:100%;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">image</span>选择本地图片
            </button>
            <div id="emoji-preview" style="margin-top:10px;display:none;">
                <img id="emoji-preview-img" style="max-width:100%;border-radius:8px;border:2px solid var(--primary);">
            </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="btn btn-outline" onclick="closeAddEmojiModal()" style="flex:1;">取消</button>
            <button class="btn" id="confirm-emoji-btn" onclick="confirmAddEmoji()" style="flex:1;">确定</button>
        </div>
    </div>
</div>

<!-- 发送图片弹窗（用于+号菜单中的图片功能） -->
<div id="send-image-modal" onclick="if(event.target===this) closeSendImageModal()">
    <div class="modal-content" style="max-width:400px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">image</span>发送图片</h3>
            <button class="icon-btn" onclick="closeSendImageModal()" style="color:var(--text);">✕</button>
        </div>
        <div class="input-group">
            <label>图片描述（可选）</label>
            <input type="text" id="send-image-description-input" placeholder="例如：一张开心的表情包、一张风景图...">
            <p style="font-size:11px;color:#FF6B6B;margin-top:4px;line-height:1.5;font-weight:500;">
                ⚠️ 重要提示：如果不填写图片描述，某些不支持图片识别的AI模型将无法理解图片内容，可能导致AI无法正确回复或误解你的意图。建议填写简短描述（如"一张开心的表情包"、"美丽的风景图"等），这样AI能更好地理解你的意图并给出合适的回复。
            </p>
        </div>
        <div class="input-group">
            <label>选择图片</label>
            <input type="file" id="send-image-file-input" accept="image/*" style="display:none;" onchange="handleSendImageFileSelect(event)">
            <button class="btn" onclick="document.getElementById('send-image-file-input').click()" style="width:100%;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">image</span>选择本地图片
            </button>
            <div id="send-image-preview" style="margin-top:10px;display:none;">
                <img id="send-image-preview-img" style="max-width:100%;border-radius:8px;border:2px solid var(--primary);">
            </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="btn btn-outline" onclick="closeSendImageModal()" style="flex:1;">取消</button>
            <button class="btn" onclick="confirmSendImage()" style="flex:1;">确定发送</button>
        </div>
    </div>
</div>

<!-- 保存游戏弹窗 -->
<div id="save-game-modal" onclick="if(event.target===this) closeSaveGameModal()">
    <div class="modal-content" style="max-width:600px;max-height:80vh;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">save</span>保存存档</h3>
            <button class="icon-btn" onclick="closeSaveGameModal()" style="color:var(--text);">✕</button>
        </div>
        <div style="margin-bottom:20px;">
            <button class="btn" onclick="createNewSave()" style="width:100%;margin-bottom:15px;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">add</span>存新档
            </button>
            <div style="border-top:1px solid var(--secondary);padding-top:15px;">
                <h4 style="margin:0 0 10px 0;font-size:14px;color:var(--text);">覆盖已有存档：</h4>
                <div id="save-game-list" style="max-height:400px;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;">
                    <!-- 动态生成存档列表 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 转账银两弹窗 -->
<div id="money-transfer-modal" onclick="if(event.target===this) closeMoneyTransferModal()">
    <div class="modal-content" style="max-width:400px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">account_balance_wallet</span>转账银两</h3>
            <button class="icon-btn" onclick="closeMoneyTransferModal()" style="color:var(--text);">✕</button>
        </div>
        <div class="input-group">
            <label>当前银两</label>
            <div style="background:var(--secondary);padding:12px;border-radius:8px;text-align:center;font-size:24px;color:var(--accent);font-weight:bold;" id="money-transfer-current">
                0两
            </div>
        </div>
        <div class="input-group">
            <label>转账金额</label>
            <input type="number" id="money-transfer-amount" placeholder="请输入金额" min="1" step="1" style="font-size:18px;text-align:center;">
            <div style="display:flex;gap:5px;margin-top:8px;">
                <button class="btn btn-outline" style="flex:1;font-size:12px;padding:6px;" onclick="setTransferAmount(0.25)">25%</button>
                <button class="btn btn-outline" style="flex:1;font-size:12px;padding:6px;" onclick="setTransferAmount(0.5)">50%</button>
                <button class="btn btn-outline" style="flex:1;font-size:12px;padding:6px;" onclick="setTransferAmount(0.75)">75%</button>
                <button class="btn btn-outline" style="flex:1;font-size:12px;padding:6px;" onclick="setTransferAmount(1)">全部</button>
            </div>
        </div>
        <div class="input-group">
            <label>备注（可选）</label>
            <input type="text" id="money-transfer-note" placeholder="转账备注" maxlength="20" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--secondary);font-size:14px;text-align:center;">
        </div>
        <div class="input-group">
            <label>最大可转</label>
            <div style="background:var(--secondary);padding:8px;border-radius:8px;text-align:center;color:var(--text);font-size:14px;" id="money-transfer-max">
                0两
            </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="btn btn-outline" onclick="closeMoneyTransferModal()" style="flex:1;">取消</button>
            <button class="btn" onclick="confirmMoneyTransfer()" style="flex:1;">确定转账</button>
        </div>
    </div>
</div>

<!-- 创建群聊模态框 -->
<div id="create-group-modal" onclick="if(event.target===this) closeCreateGroupModal()">
    <div class="modal-content" style="max-width:500px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">group_add</span>创建群聊</h3>
            <button class="icon-btn" onclick="closeCreateGroupModal()" style="color:var(--text);">✕</button>
        </div>
        <div class="input-group">
            <label>群聊名称</label>
            <input type="text" id="create-group-name" placeholder="请输入群聊名称" maxlength="20">
        </div>
        <div class="input-group">
            <label>选择成员（可多选）</label>
            <div id="create-group-members-list" style="max-height:300px;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;border:1px solid var(--secondary);border-radius:5px;padding:10px;background:rgba(225,227,237,0.3);">
                <!-- 动态生成成员列表 -->
            </div>
            <p style="font-size:11px;color:#8E96D9;margin-top:4px;">已选择 <span id="create-group-selected-count">0</span> 位成员</p>
        </div>
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="btn btn-outline" onclick="closeCreateGroupModal()" style="flex:1;">取消</button>
            <button class="btn" onclick="confirmCreateGroup()" style="flex:1;">创建</button>
        </div>
    </div>
</div>

<!-- 群成员模态框 -->
<div id="group-members-modal" onclick="if(event.target===this) closeGroupMembersModal()">
    <div class="modal-content" style="max-width:500px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">people</span>群成员</h3>
            <button class="icon-btn" onclick="closeGroupMembersModal()" style="color:var(--text);">✕</button>
        </div>
        <div id="group-members-list" style="max-height:400px;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;">
            <!-- 动态生成成员列表 -->
        </div>
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="btn" onclick="closeGroupMembersModal()" style="flex:1;">关闭</button>
        </div>
    </div>
</div>

<!-- 群设置模态框 -->
<div id="group-settings-modal" onclick="if(event.target===this) closeGroupSettingsModal()">
    <div class="modal-content" style="max-width:500px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">settings</span>群设置</h3>
            <button class="icon-btn" onclick="closeGroupSettingsModal()" style="color:var(--text);">✕</button>
        </div>
        <div id="group-settings-content">
            <!-- 动态生成设置内容 -->
        </div>
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="btn btn-outline" onclick="closeGroupSettingsModal()" style="flex:1;">取消</button>
            <button class="btn" onclick="confirmGroupSettings()" style="flex:1;" id="confirm-group-settings-btn" style="display:none;">确定</button>
        </div>
    </div>
</div>

<!-- 群聊成员选择模态框（用于礼物和转账） -->
<div id="group-member-select-modal" onclick="if(event.target===this) closeGroupMemberSelectModal()" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:200;display:none;justify-content:center;align-items:center;">
    <div class="modal-content" style="max-width:500px;background:var(--secondary);padding:20px;border-radius:15px;max-height:80vh;display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3 id="group-member-select-title"><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">people</span>选择成员</h3>
            <button class="icon-btn" onclick="closeGroupMemberSelectModal()" style="color:var(--text);">✕</button>
        </div>
        <div id="group-member-select-list" style="flex:1;max-height:400px;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;min-height:200px;">
            <!-- 动态生成成员列表 -->
        </div>
        <div style="margin-top:15px;padding-top:15px;border-top:1px solid var(--secondary);flex-shrink:0;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <span id="group-member-select-label">已选择 <span id="group-member-select-count">0</span> 位成员</span>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-outline" onclick="closeGroupMemberSelectModal()" style="flex:1;">取消</button>
                <button class="btn" id="group-member-select-confirm" onclick="confirmGroupMemberSelect()" style="flex:1;">确定</button>
            </div>
        </div>
    </div>
</div>

<!-- 导出人脉：多选/单选 -->
<div id="export-select-modal" onclick="if(event.target===this) closeExportSelectModal()" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:200;display:none;justify-content:center;align-items:center;">
    <div class="modal-content" style="max-width:500px;background:var(--secondary);padding:20px;border-radius:15px;max-height:80vh;display:flex;flex-direction:column;" onclick="event.stopPropagation()">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">file_download</span>选择要导出的人物</h3>
            <button class="icon-btn" onclick="closeExportSelectModal()" style="color:var(--text);">✕</button>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:10px;">
            <button class="btn btn-outline" onclick="toggleExportSelectAll(true)" style="width:auto;padding:5px 10px;font-size:12px;">全选</button>
            <button class="btn btn-outline" onclick="toggleExportSelectAll(false)" style="width:auto;padding:5px 10px;font-size:12px;">取消全选</button>
        </div>
        <div id="export-select-list" style="flex:1;max-height:350px;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;min-height:100px;">
        </div>
        <div style="margin-top:15px;padding-top:15px;border-top:1px solid var(--secondary);flex-shrink:0;">
            <div style="display:flex;gap:10px;">
                <button class="btn btn-outline" onclick="closeExportSelectModal()" style="flex:1;">取消</button>
                <button class="btn" onclick="confirmExportSelected()" style="flex:1;">导出选中</button>
            </div>
        </div>
    </div>
</div>

<!-- 物品赠送：选择人脉好友 -->
<div id="gift-contact-select-modal" onclick="if(event.target===this) closeGiftContactSelectModal()" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:200;display:none;justify-content:center;align-items:center;">
    <div class="modal-content" style="max-width:500px;background:var(--secondary);padding:20px;border-radius:15px;max-height:80vh;display:flex;flex-direction:column;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">card_giftcard</span>选择要赠送的人脉好友</h3>
            <button class="icon-btn" onclick="closeGiftContactSelectModal()" style="color:var(--text);">✕</button>
        </div>
        <div id="gift-contact-select-list" style="flex:1;max-height:400px;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;min-height:120px;">
            <!-- 动态生成人脉列表 -->
        </div>
        <div style="margin-top:15px;padding-top:15px;border-top:1px solid var(--secondary);flex-shrink:0;">
            <div style="display:flex;gap:10px;">
                <button class="btn btn-outline" onclick="closeGiftContactSelectModal()" style="flex:1;">取消</button>
                <button class="btn" onclick="confirmGiftContactSelect()" style="flex:1;">确定赠送</button>
            </div>
        </div>
    </div>
</div>

<!-- 心理状态与日记弹窗 -->
<div id="psychology-diary-modal" onclick="if(event.target===this) closePsychologyDiaryModal()" style="z-index: 10002;">
    <div class="modal-content">
        <div class="pd-header">
            <h3 id="pd-modal-title">心理状态与日记</h3>
            <p id="pd-modal-subtitle"></p>
        </div>
        <div class="pd-body">
            <div class="pd-section">
                <div class="pd-section-title"><span class="material-icons" style="font-size:18px;">psychology</span>心理状态</div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label style="font-size:12px;color:var(--secondary);">回退页数：</label>
                    <input type="number" id="pd-psych-rollback" min="0" value="0" style="width:60px;padding:4px 8px;border:1px solid rgba(117,126,211,0.4);border-radius:6px;">
                    <button class="btn" style="padding:4px 12px;font-size:12px;" onclick="confirmPsychDiaryRollback('psych')">确定</button>
                </div>
                <div class="pd-section-content" id="pd-psychology-content"></div>
            </div>
            <div class="pd-section">
                <div class="pd-section-title"><span class="material-icons" style="font-size:18px;">menu_book</span>日记</div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label style="font-size:12px;color:var(--secondary);">回退页数：</label>
                    <input type="number" id="pd-diary-rollback" min="0" value="0" style="width:60px;padding:4px 8px;border:1px solid rgba(117,126,211,0.4);border-radius:6px;">
                    <button class="btn" style="padding:4px 12px;font-size:12px;" onclick="confirmPsychDiaryRollback('diary')">确定</button>
                </div>
                <div class="pd-section-content" id="pd-diary-content"></div>
            </div>
        </div>
        <div class="pd-footer">
            <button class="btn btn-outline" style="width:auto; padding:8px 16px;" onclick="closePsychologyDiaryModal()">关闭</button>
        </div>
    </div>
</div>

<!-- 设置模态框 -->
<div id="settings-modal" onclick="if(event.target===this) closeSettings()">
    <div class="modal-content">
        <h3>🔧 全局设置</h3>
        <p style="font-size:12px; color:#8E96D9;">只有配置了API，NPC才能和你对话。</p>
        
        <div class="input-group">
            <label>API 地址</label>
            <input type="text" id="api-url-2" disabled readonly style="background:var(--bg-secondary);color:var(--text);cursor:not-allowed;">
            <p style="font-size:11px;color:#8E96D9;margin-top:4px;">API 地址已固定，不可修改</p>
        </div>
        
        <div class="input-group">
            <label>API Key</label>
            <div style="position:relative;display:flex;align-items:center;">
                <input type="password" id="api-key" placeholder="sk-..." style="flex:1;padding-right:40px;">
                <span class="material-icons" id="api-key-toggle" onclick="toggleApiKeyVisibility()" style="position:absolute;right:10px;font-size:20px;color:var(--secondary);cursor:pointer;user-select:none;" title="显示/隐藏">visibility</span>
            </div>
        </div>

            <div class="input-group">
                <label>模型选择</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="api-model" placeholder="gpt-3.5-turbo">
                    <button class="btn" style="width:auto; font-size:12px;" id="fetch-models-btn" onclick="fetchModels()">获取列表</button>
                </div>
                <div id="model-list-box" class="model-list" style="display:none;"></div>
            </div>

            <div class="input-group">
                <label style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="story-mode" style="width:20px; height:20px;">
                    <span>剧情模式</span>
                </label>
                <p style="font-size:12px; color:#AFB4E1; margin-top:5px;">
                    开启后，每次点击"休息"都会调用API生成详细剧情。关闭后，休息时不会生成剧情。
                </p>
            </div>

            <button class="btn" onclick="saveSettings()">保存设置</button>
        <button class="btn btn-outline" onclick="goToPage('page-load')">读取存档</button>
        <button class="btn btn-outline" onclick="saveGame()">保存存档</button>
        <button class="btn btn-outline" onclick="closeSettings()">关闭</button>
    </div>
</div>

<!-- 教程（L2模态层：非全屏卡片，退出路径绝对优先） -->
<div id="tutorial-modal" onclick="handleTutorialBackdropClick(event)">
    <div class="modal-content" role="dialog" aria-modal="true" aria-label="宫女升职记 教程">
        <div class="tut-header">
            <div style="display:flex; align-items:center; gap:10px; min-width:0;">
                <div class="tut-title">教程</div>
                <div style="font-size:12px; line-height:1.35; opacity:0.92; white-space:nowrap;">
                    作者小红书号：4906301985<br>作者qq号：819914401
                </div>
            </div>
            <div class="tut-close" title="关闭" aria-label="关闭教程" onclick="closeTutorialModal()">
                <span class="material-icons" style="font-size:18px;opacity:0.95;">close</span>
            </div>
        </div>
        <div class="tut-body">
            <div class="tut-category">
                <div class="tut-category-header" onclick="toggleTutorialCategory(this)"><span class="tut-category-arrow">▶</span> 入门与基础</div>
                <div class="tut-category-body">
                    <div class="tut-section">
                        <h4>游戏是啥？第一次玩该怎么做？</h4>
                        <p><b>《宫女升职记》</b>是一款宫廷养成 + AI 对话的文字游戏。你扮演宫里的小人物（宫女/小主等），通过<b>去不同地点做事、和 NPC 聊天、参与群聊和朋友圈</b>，慢慢提升属性、解锁剧情、改变命运。</p>
                        <p><b>第一次玩请按下面顺序来：</b></p>
                        <ol>
                            <li>打开游戏后，在首页点击<b>「开始新人生」</b>。</li>
                            <li>按提示填写<b>朝代名、皇帝名、你的出身和名字</b>，再写一段<b>主角设定</b>（你是谁、想达成什么、说话风格等），然后确认创建。</li>
                            <li>进入主界面后，底部会有一排入口：<b>地图、人脉、聊天、个人主页、社交空间</b> 等。先点<b>「地图」</b>，选一个地点（如御花园、尚宫局），再选具体行动（如散步、当差），就会消耗体力并得到银两/属性/随机事件。</li>
                            <li>想和宫里的人说话：点<b>「人脉」</b>看名单，点某个人再选<b>「找 TA」</b>即可私聊；私聊和群聊里的回复由 AI 根据你设的人设生成。</li>
                            <li>重要：玩到关键节点时，去<b>「设置」</b>里点<b>「保存游戏」</b>或<b>「导出存档」</b>，防止意外丢失。</li>
                        </ol>
                    </div>
                    <div class="tut-section">
                        <h4>界面里“加载中、空白、报错”都是什么意思？</h4>
                        <ul>
                            <li><b>正常显示</b>：列表有内容、按钮能点，说明一切正常。</li>
                            <li><b>加载中</b>：点了“发送”“刷新”“推进”等需要 AI 的按钮后，会转圈或按钮变灰，是<b>正在请求 AI 生成内容</b>，等几秒到十几秒；很久没反应则检查网络和 API 配置。</li>
                            <li><b>空白/空列表</b>：说明还没创建过（没加联系人、没建群、没发动态），去对应入口先“添加”或“创建”。</li>
                            <li><b>报错</b>：弹窗里会写原因。常见<b>「请先配置 API」</b>或<b>「API 调用失败」</b>——去<b>设置 → API 配置</b>检查 URL、Key、模型。</li>
                            <li><b>文字长短</b>：可在世界观或人物设定里写明“回复尽量简短”等，让 AI 更符合预期。</li>
                        </ul>
                    </div>
                    <div class="tut-section">
                        <h4>怎么关闭教程/弹窗？</h4>
                        <ul>
                            <li>点教程卡片<b>右上角的 ✕</b>；或点卡片<b>外面</b>的暗色区域；电脑上可按<b> Esc</b>。</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="tut-category">
                <div class="tut-category-header" onclick="toggleTutorialCategory(this)"><span class="tut-category-arrow">▶</span> 角色与世界观</div>
                <div class="tut-category-body">
                    <div class="tut-section">
                        <h4>创建角色时，“世界观”和“人设”该怎么写？</h4>
                        <p>开局填的<b>朝代、皇帝、出身</b>决定时代氛围和起点；<b>主角设定</b>是给 AI 的“总指令”，写越清楚 AI 越能按你的性格来演。</p>
                        <ul>
                            <li><b>身份与目标</b>：如“刚进宫的粗使宫女，目标先活下来再往上爬”。</li>
                            <li><b>性格与底线</b>：如“冷静、记仇、会算计，但不害无辜”。</li>
                            <li><b>说话习惯</b>：如“对上级自称奴婢，对同辈随意些”。</li>
                            <li><b>情感弱点</b>：如“怕被抛弃”，方便后续剧情冲突。</li>
                        </ul>
                        <p>想要节奏快、选项多、后果明显，可在设定里写：“节奏偏快，事件要给明确机会或代价。”</p>
                    </div>
                    <div class="tut-section">
                        <h4>属性（体质、容貌、才学等）分别有什么用？</h4>
                        <ul>
                            <li><b>体质/体力</b>：决定一天能行动几次；去某地做事会扣体力，没了要休息。</li>
                            <li><b>容貌/魅力/气质</b>：影响社交被注意、被喜欢、被提拔的概率。</li>
                            <li><b>才学</b>：影响文戏、对答、谋略类事件及高级地点解锁。</li>
                            <li><b>武艺</b>：影响打架、自保、冲突类事件。</li>
                            <li><b>声望/人脉/银两</b>：声望关系升职；人脉关系能接触谁；银两买道具、投资、打点。</li>
                        </ul>
                        <p><b>新手建议</b>：前期多刷体质和才学；中期堆魅力或人脉；后期按路线重点加某一两项。</p>
                    </div>
                </div>
            </div>

            <div class="tut-category">
                <div class="tut-category-header" onclick="toggleTutorialCategory(this)"><span class="tut-category-arrow">▶</span> 地图与行动</div>
                <div class="tut-category-body">
                    <div class="tut-section">
                        <h4>地图与地点：怎么选才划算？</h4>
                        <p>主界面<b>「地图」</b>里有多个地点，每个地点有多种<b>行动</b>（当差、散步、打听等）。</p>
                        <ul>
                            <li><b>工作/当差</b>：稳定给银两或少量声望，适合缺钱、求稳。</li>
                            <li><b>探索/散步/打听</b>：更容易触发随机事件、遇到新 NPC、开出支线。</li>
                            <li><b>训练/学习</b>：专门加某一项属性，适合为考核做准备。</li>
                        </ul>
                    </div>
                    <div class="tut-section">
                        <h4>地图 API 调用</h4>
                        <p>在<b>设置 → 地图 API 调用模式</b>中，可为每个地点单独开关“是否用 API 生成剧情”。<b>开启</b>后，踩该地图会调用 AI 生成更丰富、不重复的剧情；<b>关闭</b>则使用固定模板。API 调用会消耗你的 Key。</p>
                    </div>
                    <div class="tut-section">
                        <h4>真实模式</h4>
                        <p>在设置中开启<b>真实模式</b>后：体力连续 5 天少于 30 会<b>病倒</b>；病倒后踩图可能<b>死亡</b>（触发结局）；连续 7 天体力≥40 可恢复。工作/训练会扣健康值；浣衣局冬日可能触发冻疮（手干裂流血），之后踩图会带此状态。</p>
                    </div>
                    <div class="tut-section">
                        <h4>青楼</h4>
                        <p>宫外地点，需一等宫女及以上解锁。开启真实模式后，点击青楼会弹出选择：<b>正常逛逛</b>（按普通探索剧情）或<b>在此打工</b>（赚银两但有风险）。</p>
                        <ul>
                            <li><b>打工</b>：若开启该地图 API 调用，会生成古代用词、更具体的打工剧情；否则从固定模板随机。打工后有<b>概率罹患花柳病</b>（终身不愈、有后遗症、具传染性）；侍寝等亲密接触可能传染给对方或自己。</li>
                            <li>花柳病由<b>设定</b>决定：在<b>人脉 → 编辑角色设定</b>中，真实模式下可为每个角色勾选“身患花柳”，表示该角色在设定上患有此症；传染逻辑会按此与侍寝等行为生效。</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="tut-category">
                <div class="tut-category-header" onclick="toggleTutorialCategory(this)"><span class="tut-category-arrow">▶</span> 人脉与私聊</div>
                <div class="tut-category-body">
                    <div class="tut-section">
                        <h4>人脉：添加与编辑角色</h4>
                        <p>在<b>「人脉」</b>里可<b>添加、编辑</b>联系人：姓名、身份、性格、背景、好感度、性别、是否发表情包等。真实模式下还可为角色勾选<b>「身患花柳」</b>（按角色自身设定，影响传染与剧情）。</p>
                        <p>让人物更鲜明：写清职位/派系、性格与说话风格、和主角的关系或态度。和某人<b>「找 TA」</b>即进入私聊。</p>
                    </div>
                    <div class="tut-section">
                        <h4>私聊与心理状态、日记</h4>
                        <p>私聊时 AI 按该角色设定回复。点击聊天页顶部的<b>角色名字</b>可打开<b>心理状态与日记</b>弹窗：查看该角色当前心理状态和近期日记（由每次对话 API 一并生成），可调节“回退页数”看更早的记录。</p>
                    </div>
                    <div class="tut-section">
                        <h4>蓄力对话</h4>
                        <p>输入框旁有<b>「添加入栈」</b>和<b>「呼叫 AI」</b>。可先输入多条内容并多次点“添加入栈”，再点“呼叫 AI”，AI 会一次性接收全部内容并可能以多条消息“爆发”回复。生成过程中“呼叫 AI”会变成<b>「中断」</b>，可取消生成。</p>
                    </div>
                </div>
            </div>

            <div class="tut-category">
                <div class="tut-category-header" onclick="toggleTutorialCategory(this)"><span class="tut-category-arrow">▶</span> 群聊</div>
                <div class="tut-category-body">
                    <div class="tut-section">
                        <h4>群聊怎么玩？</h4>
                        <p>在<b>人脉 → 群聊</b>可<b>创建群聊、拉人进群</b>。群聊内：</p>
                        <ul>
                            <li><b>发送</b>：只把你的话发出去，<b>不会</b>触发 AI 回复。</li>
                            <li><b>小鱼板 🍥</b>：点击后调用 AI，让群里每个成员各生成一条回复，一条条冒出来。</li>
                            <li><b>… → 查看群成员</b>：群主/管理员可添加或移除成员。</li>
                            <li><b>幽灵观察者模式</b>（… 中开启）：你不能发言，只能点<b>「推进」</b>，让 AI 根据话题和人物关系自动互相对话，你纯旁观。</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="tut-category">
                <div class="tut-category-header" onclick="toggleTutorialCategory(this)"><span class="tut-category-arrow">▶</span> 社交空间与动态圈</div>
                <div class="tut-category-body">
                    <div class="tut-section">
                        <h4>动态圈</h4>
                        <p>在<b>社交空间</b>可发动态，人脉里的角色也会发动态、点赞、评论。<b>「刷新互动」</b>会一次性让 AI 为成员生成新动态、点赞与评论，消耗 API。可在世界观或人物设定里写“动态圈语气偏含蓄/毒舌”等。</p>
                    </div>
                    <div class="tut-section">
                        <h4>空间装扮与留言板</h4>
                        <p>可更换封面/壁纸并调节不透明度（实时预览）。另有<b>留言板</b>：好友间异步、公开留言的独立页面。</p>
                    </div>
                </div>
            </div>

            <div class="tut-category">
                <div class="tut-category-header" onclick="toggleTutorialCategory(this)"><span class="tut-category-arrow">▶</span> 养心殿与侍寝</div>
                <div class="tut-category-body">
                    <div class="tut-section">
                        <h4>侍寝</h4>
                        <p>养心殿需<b>一等宫女</b>及以上解锁，且<b>声望≥2000</b>才能侍寝。晚上前往养心殿会触发侍寝：可开启该地点 API 调用生成详细香艳剧情（古风用语），或使用模板。侍寝会影响皇帝好感、声望，并有概率怀孕。若玩家或皇帝身患花柳，侍寝时有概率互相传染。</p>
                    </div>
                </div>
            </div>

            <div class="tut-category">
                <div class="tut-category-header" onclick="toggleTutorialCategory(this)"><span class="tut-category-arrow">▶</span> 其他应用与功能</div>
                <div class="tut-category-body">
                    <div class="tut-section">
                        <h4>回忆之忆</h4>
                        <p>管理各角色的<b>长期记忆总结</b>。可为每个角色设置“记忆总结回合数”（10–200）。可编辑或删除 AI 生成的记忆，并设置某条记忆是否可被 AI 在公共社交中引用。</p>
                    </div>
                    <div class="tut-section">
                        <h4>知富宝、购购购、乐博通、密书</h4>
                        <p><b>知富宝</b>：虚拟余额与交易记录。<b>购购购/乐博通/密书</b>：由世界观驱动的商品、舆论、KOL 内容；可与知富宝联动支付；右上角可切换世界观（来自 FileNexus 角色绑定文件夹）。</p>
                    </div>
                    <div class="tut-section">
                        <h4>个人主页</h4>
                        <p>定义玩家档案（昵称、性格、形象等），作为高优先级上下文注入 AI。含<b>存档槽位</b>（保存/读取/导入导出玩家档案）、<b>收藏中心</b>（聚合各应用收藏）、<b>动态状态</b>（类似签名，影响 AI 互动）。</p>
                    </div>
                    <div class="tut-section">
                        <h4>主题、换装、表情包、气泡与礼物样式</h4>
                        <p><b>主题</b>：设置中可改配色、壁纸、字体、聊天气泡样式等。<b>换装</b>：内务府或剧情获得服装，在个人/换装处穿戴。<b>表情包</b>：设置中可添加（URL+描述），聊天时可发。<b>气泡/转账/礼物样式</b>：聊天相关界面可进入库，编辑或应用自定义样式。</p>
                    </div>
                </div>
            </div>

            <div class="tut-category">
                <div class="tut-category-header" onclick="toggleTutorialCategory(this)"><span class="tut-category-arrow">▶</span> 存档、设置与 API</div>
                <div class="tut-category-body">
                    <div class="tut-section">
                        <h4>存档</h4>
                        <ul>
                            <li><b>保存游戏</b>：进度存到浏览器本地。</li>
                            <li><b>导出/导入存档</b>：下载为 .json 备份或换设备使用；导入会覆盖当前进度，建议先备份。</li>
                        </ul>
                    </div>
                    <div class="tut-section">
                        <h4>API 配置</h4>
                        <p>设置中填<b> API URL、API Key、模型</b>（支持 OpenAI 格式的任意服务）。对话、群聊、动态圈、部分剧情生成都依赖 API。报错时看弹窗提示，检查网络、URL/Key 是否完整、模型权限。</p>
                    </div>
                    <div class="tut-section">
                        <h4>剧情模式、数据中心、AI 核心引擎、金手指</h4>
                        <p><b>剧情模式</b>：开启后每次“休息”会调用 API 生成详细剧情。<b>数据中心</b>：精细化导入/导出、重置与部分数据清除。<b>AI 核心引擎</b>：调节自主活动频率、记忆互通范围、创造力等。<b>金手指</b>：作弊模式开关。</p>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>

<script>
(function(){
var _0='aHR0cHM6Ly9t';var _1='ZWl3ZWkueGlhb3hpYW9haS54eXovdjE=';
window._b=function(){try{return atob(_0+_1);}catch(e){return'';}};
})();
(function(){
  /* 尚宫局·印鉴（不参与业务逻辑） */
  var _pf = [0x71, 0x71];
  var _n1 = '819', _n2 = '914401';
  var _s = String.fromCharCode(_pf[0], _pf[1]) + _n1 + _n2;
  if (typeof window._ayla !== 'symbol') try { window._ayla = _s; } catch (_) {}
})();
/**
 * 游戏数据结构与全局变量
 */
const GAME_VERSION = "1.0.0";
let settings = {
    get apiUrl(){return typeof _b==='function'?_b():'';},
    set apiUrl(v){},
    apiKey: "",
    model: "gpt-3.5-turbo",
    storyMode: false, // 剧情模式开关
    locationApiMode: {}, // 地图API调用模式开关，key为地图名称，value为boolean
    stylePreset: "", // 风格预设，第一优先级，影响剧情、人脉对话、群聊、动态。不填则使用默认
    fontFamily: "default", // 预设字体 key 或 "custom" 时用 fontFamilyName，或 "upload" 时用 fontFileDataUrl
    fontFamilyName: "", // 自定义字体名（当 fontFamily===custom）
    fontFileDataUrl: "", // 上传字体文件的 data URL（当 fontFamily===upload）
    fontSize: 16, // 全局字体大小 px，12–24
    cheatMode: false, // 金手指模式
    realMode: false // 真实模式：体力连续5天<30病倒，病倒踩图可能死亡；连续7天体力≥40恢复
};

// 表情包存储（包含图片和描述）
let emojiStore = [];

// 加载表情包
function loadEmojis() {
    const saved = localStorage.getItem('palace_emojis');
    if (saved) {
        const parsed = JSON.parse(saved);
        // 兼容旧格式：如果是字符串数组，转换为对象数组
        if (parsed.length > 0 && typeof parsed[0] === 'string') {
            emojiStore = parsed.map(img => ({ image: img, description: '' }));
        } else {
            emojiStore = parsed;
        }
    }
}

// 保存表情包
function saveEmojis() {
    try {
        localStorage.setItem('palace_emojis', JSON.stringify(emojiStore));
    } catch (e) {
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            showErrorModal('存储空间不足，请清理存档或数据。');
        } else {
            showErrorModal('保存失败：' + (e.message || '未知错误'));
        }
    }
}

let gameState = {
    player: {
        name: "魏璎珞",
        origin: "平民",
        age: 15,
        characterDesc: "",
        rank: 0, // 0-4，入宫时都是最低等的粗使宫女（粗使/二等/一等/掌事姑姑/女官）
        stats: { 
            energy: 100, 
            maxEnergy: 100,
            money: 10, // 初始银两只有10
            fame: 0,
            fameLevel: 0, // 声望等级
            charm: 0,
            maxCharm: 100, // 属性上限
            wisdom: 0,
            maxWisdom: 100,
            martial: 0,
            maxMartial: 100,
            constitution: 0,
            maxConstitution: 100,
            elegance: 0,
            maxElegance: 100,
            attraction: 0,
            maxAttraction: 100,
            cunning: 0,
            maxCunning: 100,
            music: 0,
            maxMusic: 100,
            dance: 0,
            maxDance: 100,
            embroidery: 0,
            maxEmbroidery: 100,
            health: 100, // 健康值（隐藏属性）
            mood: 50, // 心情值（隐藏属性）
            lastStatDecay: null // 上次属性衰减时间
        },
        skills: {}, // 技能系统 {skillId: {level, exp, mastery}}
        achievements: [], // 成就列表
        socialLevel: 0, // 社交等级
        socialInfluence: 0, // 社交影响力
        relationships: {}, // NPC关系 {npcId: {type: 'friend/enemy/lover', level: 0-100}}
        schedule: [], // 日程安排
        children: [], // 孩子列表
        storyProgress: {}, // 剧情进度
        choices: [], // 重要选择记录
        dailyStories: [], // 每日剧情记录 [{date, title, content}]
        inventory: [],
        equipped: { clothes: null, accessory: null }, // 装备的服装和饰品
        pregnancy: { isPregnant: false, month: 0, pregnancyStartTime: 0, fatherNpcId: null }, // 怀孕状态；fatherNpcId 为生父 npc.id，null 表示皇帝
        emperorAffection: 0, // 皇帝好感度
        hasSyphilis: false // 真实模式青楼打工有概率罹患花柳病，终身不愈、有后遗症、具传染性
    },
    themeColors: {
        primary: "#757ED3",
        secondary: "#AFB4E1",
        bg: "#D1D4E8",
        text: "#4a403a",
        accent: "#8E96D9",
        danger: "#C85A7A"
    },
    world: {
        dynasty: "大盛",
        emperorDesc: "",
        year: 15,
        month: 1,
        day: 1,
        timeOfDay: 0, // 0:早, 1:中, 2:晚
        season: 0, // 0:春, 1:夏, 2:秋, 3:冬
        timeSpeed: 1, // 时间流速倍数
        festivals: {}, // 节日数据
        unlockedLocations: [] // 已解锁的地点
    },
    npcs: [], // 存储所有遇到过的NPC对象（禁止固定NPC，全部动态生成）
    currentSaveId: null, // 当前存档ID
    memorySettings: {}, // {npcId: memoryCount} 每个NPC的记忆条数设置
    groupMemorySettings: {}, // {groupId: memoryCount} 每个群聊的记忆条数设置
    tasks: [], // 任务列表（包含任务链、限时任务等）
    items: [], // 物品库（包含品质、套装、合成等）
    clothes: [], // 服装库（包含套装、染色等）
    accessories: [], // 饰品库
    groups: [], // 群聊列表
    socialPosts: [], // 朋友圈动态（默认动态圈）
    socialCircles: [], // 动态圈列表 [{id, name, members: [], posts: []}]
    socialCircleMemoryPostCount: 10, // 刷新时记忆的当前动态条数（动态圈设置中可改）
    todayVisitedLocations: [], // 今日踩过的地图（休息时清空，用于剧情上下文）
    plotThreads: {}, // 埋线剧情 { locationName: { story, eventType, choiceId } } 再次访问该地点时展开
    energyEndOfDayHistory: [], // 真实模式：每日休息前体力记录，最多保留7条
    collapsed: false, // 真实模式：是否病倒
    sickRecoveryDays: 0, // 真实模式：病倒后连续几天体力≥40
    dead: false, // 真实模式：是否已死亡（触发结局）
    chilblainsHands: false, // 真实模式：冻疮/手干裂流血（冬季浣衣等触发），带此状态踩任何地图
    currentSocialCircleId: null, // 当前选中的动态圈ID，null表示默认动态圈
    currentLocation: null,
    chatTargetId: null, // 当前正在对话的NPC ID
    chatHistoryLog: [], // 临时对话记录
    events: [], // 随机事件记录
    investments: [], // 投资记录
    loans: [], // 借贷记录
    prices: {}, // 物价数据
    emperorMemory: [] // 皇帝侍寝记忆
};

// 职位列表，salary为日俸（每次休息发一次）。仅宫女体系，无妃位。
// 工资参考物价：人参30、胭脂20、玉佩50，使宫女能合理购买
const RANKS = [
    { name: "粗使宫女", req: 0, salary: 10, map: ["御膳房", "浣衣局", "下人房"] },
    { name: "二等宫女", req: 100, salary: 25, map: ["御花园", "内务府"] },
    { name: "一等宫女", req: 300, salary: 50, map: ["各宫殿"] },
    { name: "掌事姑姑", req: 600, salary: 100, map: ["御书房"] },
    { name: "女官", req: 1000, salary: 200, map: ["太医院"], unlockOut: true }
];

// 地点配置（增强版）
const LOCATIONS = {
    // 宫内
    "下人房": { 
        desc: "宫女们休息的地方。", 
        action: "generateServants", 
        cost: 5,
        timeRestriction: null, // null表示全天开放，[0,1,2]表示只在指定时段开放
        level: 1, // 地点等级
        unlockRequirement: null, // 解锁要求
        randomEvents: true // 是否触发随机事件
    },
    "浣衣局": { 
        desc: "洗衣服的地方，不仅累还要看人脸色。", 
        action: "work", 
        cost: 20, 
        reward: {money: 5, fame: 1},
        timeRestriction: [0, 1], // 只在早、中午开放
        level: 1,
        randomEvents: true,
        moodPenalty: -5 // 踩图扣心情
    },
    "御膳房": { 
        desc: "香气四溢，可以偷学厨艺。", 
        action: "train", 
        cost: 10, 
        stat: "wisdom", 
        val: 2,
        timeRestriction: [0, 1],
        level: 1,
        randomEvents: true
    },
    "御花园": { 
        desc: "风景秀丽，常有贵人或侍卫路过。", 
        action: "explore", 
        cost: 10, 
        chance: 0.7,
        timeRestriction: [1, 2], // 只在中午、晚上开放
        level: 2,
        randomEvents: true
    },
    "太医院": { 
        desc: "药香弥漫，可治病或学医。", 
        action: "explore", 
        cost: 10, 
        chance: 0.5,
        timeRestriction: [0, 1],
        level: 2,
        randomEvents: true
    },
    "练武场": { 
        desc: "侍卫操练之地。", 
        action: "train", 
        cost: 15, 
        stat: "martial", 
        val: 3,
        timeRestriction: [0],
        level: 2,
        randomEvents: true
    },
    "御书房": { 
        desc: "皇上办公之地，闲人免进。", 
        action: "explore", 
        cost: 10, 
        chance: 0.3, 
        minRank: 2, // 一等宫女解锁
        timeRestriction: [0, 1],
        level: 3,
        randomEvents: true
    },
    // 宫外 (需 Rank 5+)
    "长安街": { 
        desc: "繁华的京城大街。", 
        action: "explore", 
        cost: 20, 
        chance: 0.8,
        timeRestriction: [1, 2],
        level: 3,
        randomEvents: true
    },
    "青楼": { 
        desc: "寻欢作乐之地，消息灵通。", 
        action: "explore", 
        cost: 30, 
        chance: 0.6,
        timeRestriction: [2], // 只在晚上开放
        level: 4,
        randomEvents: true,
        moodPenalty: -3 // 踩图扣心情
    },
    "王府": { 
        desc: "权贵聚集之地。", 
        action: "explore", 
        cost: 20, 
        chance: 0.4,
        timeRestriction: [1],
        level: 4,
        randomEvents: true
    },
    "内务府": { 
        desc: "管理宫廷事务，可购买物品。", 
        action: "shop", 
        cost: 10,
        timeRestriction: [0, 1],
        level: 2,
        randomEvents: false
    },
    "养心殿": { 
        desc: "皇帝寝宫，可侍寝。", 
        action: "serve", 
        cost: 20, 
        minRank: 2, // 一等宫女解锁
        timeRestriction: [2], // 只在晚上开放
        level: 5,
        randomEvents: false
    }
};

/**
 * 初始化与页面控制
 */
window.onload = function() {
    loadSettings();
    loadTransferStyleFromStorage();
    loadGiftStyleFromStorage();
    loadEmojis();
    loadSaveSlots();
    // 应用当前存档的配色
    if (gameState.themeColors) {
        applyTheme(gameState.themeColors);
    }
    // 初始化属性加点系统
    resetStatAllocation();
    // 确保默认显示首页，隐藏导航栏
    // 先移除所有页面的active类
    document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
    // 确保首页显示
    const homePage = document.getElementById('page-home');
    if (homePage) {
        homePage.classList.add('active');
    }
    // 强制隐藏导航栏
    document.getElementById('bottom-nav')?.classList.remove('show');
    document.getElementById('sub-nav')?.classList.remove('show');
    // 确保currentGroupId为null，防止自动进入群聊
    currentGroupId = null;
};

function resetStatAllocation() {
    // 重置所有属性点
    allocatedPoints = {
        constitution: 0,
        charm: 0,
        elegance: 0,
        attraction: 0,
        cunning: 0,
        music: 0,
        dance: 0,
        embroidery: 0,
        wisdom: 0,
        martial: 0
    };
    
    // 重置所有显示值
    Object.keys(allocatedPoints).forEach(statName => {
        document.getElementById(`val-${statName}`).innerText = 0;
    });
    
    document.getElementById('points-left').innerText = TOTAL_POINTS;
    document.getElementById('points-remaining').className = 'points-remaining';
    updateStatButtons();
}

// 导航栏配置
const navConfig = {
    0: { // 主页
        page: 'page-game',
        subNav: []
    },
    1: { // 社交
        page: 'page-contacts',
        subNav: [
            { id: 'page-contacts', label: '[人脉]', icon: 'contacts' },
            { id: 'page-social', label: '[社交]', icon: 'people' }
        ]
    },
    2: { // 功能
        page: 'page-inventory',
        subNav: [
            { id: 'page-inventory', label: '[物品]', icon: 'inventory' },
            { id: 'page-dress', label: '[换装]', icon: 'checkroom' },
            { id: 'page-skills', label: '[技能]', icon: 'psychology' },
            { id: 'page-economy', label: '[经济]', icon: 'account_balance_wallet' },
            { id: 'page-story', label: '[剧情]', icon: 'auto_stories' }
        ]
    },
    3: { // 设置
        page: 'page-settings',
        subNav: []
    }
};

let currentMainNav = 0;

function switchMainNav(navIndex) {
    currentMainNav = navIndex;
    const config = navConfig[navIndex];
    
    // 更新导航栏激活状态
    document.querySelectorAll('.nav-item').forEach((item, idx) => {
        item.classList.toggle('active', idx === navIndex);
    });
    
    // 显示/隐藏子导航栏
    const subNav = document.getElementById('sub-nav');
    if (config.subNav.length > 0) {
        subNav.innerHTML = '';
        config.subNav.forEach((item, idx) => {
            const subItem = document.createElement('div');
            subItem.className = 'sub-nav-item' + (idx === 0 ? ' active' : '');
            if (item.icon && item.icon.length <= 20) {
                subItem.innerHTML = `<span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:4px;">${item.icon}</span>${item.label}`;
            } else {
                subItem.textContent = item.label;
            }
            subItem.onclick = () => {
                document.querySelectorAll('.sub-nav-item').forEach(el => el.classList.remove('active'));
                subItem.classList.add('active');
                goToPage(item.id, false);
            };
            subNav.appendChild(subItem);
        });
        subNav.classList.add('show');
    } else {
        subNav.classList.remove('show');
    }
    
    // 切换到对应页面
    goToPage(config.page, false);
}

function goToPage(pageId, updateNav = true) {
    // 如果切换到非群聊页面，确保currentGroupId为null（除非是返回群聊列表）
    if (pageId !== 'page-group-chat' && pageId !== 'page-groups') {
        currentGroupId = null;
    }
    
    document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
    }
    if (pageId === 'page-game' && gameState.dead) {
        showEndingModal();
    }
    
    // 更新导航栏状态
    if(updateNav) {
        updateNavBar(pageId);
    }
    
    // 执行页面特定的渲染函数
    if(pageId === 'page-game') { generateMap(); updateDashboard(); }
    if(pageId === 'page-contacts') renderContacts();
    if(pageId === 'page-load') renderSaveList();
    if(pageId === 'page-inventory') renderInventory();
    if(pageId === 'page-dress') renderDress();
    if(pageId === 'page-skills') renderSkills();
    if(pageId === 'page-social') renderSocial();
    if(pageId === 'page-groups') {
        // 确保不在群聊页面时，currentGroupId为null
        if (currentGroupId !== null) {
            currentGroupId = null;
        }
        renderGroups();
    }
    if(pageId === 'page-posts') renderPosts();
    if(pageId === 'page-economy') renderEconomy();
    if(pageId === 'page-invest') renderInvest();
    if(pageId === 'page-loan') renderLoan();
    if(pageId === 'page-prices') renderPrices();
    if(pageId === 'page-story') renderStory();
    if(pageId === 'page-settings') loadSettings();
    if(pageId === 'page-shopping') {
        // 更新返回按钮文本（如果是群聊模式）
        const backBtn = document.getElementById('shopping-back-btn');
        if (backBtn) {
            if (window.shoppingBackToGroupChat && currentGroupId !== null) {
                backBtn.onclick = handleShoppingBack;
            } else {
                backBtn.onclick = function() { goToPage('page-chat'); };
            }
        }
        // 如果是第一次打开，推荐一些默认商品
        setTimeout(() => {
            if(document.getElementById('shop-grid').children.length === 0) {
                searchShop('热门礼物');
            }
        }, 100);
    }
}

function updateNavBar(pageId) {
    const bottomNav = document.getElementById('bottom-nav');
    const subNav = document.getElementById('sub-nav');
    
    // 在首页、设置页面、读取存档页面、聊天页面、群聊页面、朋友圈页面和群聊礼物页面时隐藏导航栏
    if(pageId === 'page-home' || pageId === 'page-setup' || pageId === 'page-load' || pageId === 'page-chat' || pageId === 'page-group-chat' || pageId === 'page-posts' || (pageId === 'page-shopping' && window.groupGiftTargetIds)) {
        bottomNav?.classList.remove('show');
        subNav?.classList.remove('show');
        return;
    }
    
    // 显示导航栏
    bottomNav?.classList.add('show');
    
    // 重置所有导航项
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.sub-nav-item').forEach(el => el.classList.remove('active'));
    
    // 根据页面ID确定主导航和子导航
    if(pageId === 'page-game') {
        currentMainNav = 0;
        document.querySelectorAll('.nav-item')[0]?.classList.add('active');
        subNav?.classList.remove('show');
    } else if(pageId === 'page-contacts' || pageId === 'page-social' || pageId === 'page-groups' || pageId === 'page-posts' || pageId === 'page-group-chat') {
        currentMainNav = 1;
        document.querySelectorAll('.nav-item').forEach((el, idx) => {
            el.classList.toggle('active', idx === 1);
        });
        const config = navConfig[1];
        const subNav = document.getElementById('sub-nav');
        if (config.subNav && config.subNav.length > 0) {
            subNav.innerHTML = '';
            config.subNav.forEach((item, idx) => {
                const subItem = document.createElement('div');
                subItem.className = 'sub-nav-item' + (item.id === pageId ? ' active' : '');
                if (item.icon && item.icon.length <= 20) {
                    subItem.innerHTML = `<span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:4px;">${item.icon}</span>${item.label}`;
                } else {
                    subItem.textContent = item.label;
                }
                subItem.onclick = () => {
                    document.querySelectorAll('.sub-nav-item').forEach(el => el.classList.remove('active'));
                    subItem.classList.add('active');
                    goToPage(item.id, false);
                };
                subNav.appendChild(subItem);
            });
            subNav.classList.add('show');
        }
    } else if(pageId === 'page-inventory' || pageId === 'page-dress' || pageId === 'page-skills' || pageId === 'page-economy' || pageId === 'page-story' || pageId === 'page-invest' || pageId === 'page-loan' || pageId === 'page-prices') {
        currentMainNav = 2;
        document.querySelectorAll('.nav-item').forEach((el, idx) => {
            el.classList.toggle('active', idx === 2);
        });
        const config = navConfig[2];
        const subNav = document.getElementById('sub-nav');
        if (config.subNav && config.subNav.length > 0) {
            subNav.innerHTML = '';
            config.subNav.forEach((item, idx) => {
                const subItem = document.createElement('div');
                const subNavMap = {
                    'page-inventory': 0,
                    'page-dress': 1,
                    'page-skills': 2,
                    'page-economy': 3,
                    'page-story': 4,
                    'page-invest': 3,
                    'page-loan': 3,
                    'page-prices': 3
                };
                const isActive = item.id === pageId || (subNavMap[pageId] === idx);
                subItem.className = 'sub-nav-item' + (isActive ? ' active' : '');
                if (item.icon && item.icon.length <= 20) {
                    subItem.innerHTML = `<span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:4px;">${item.icon}</span>${item.label}`;
                } else {
                    subItem.textContent = item.label;
                }
                subItem.onclick = () => {
                    document.querySelectorAll('.sub-nav-item').forEach(el => el.classList.remove('active'));
                    subItem.classList.add('active');
                    goToPage(item.id, false);
                };
                subNav.appendChild(subItem);
            });
            subNav.classList.add('show');
        }
    } else if(pageId === 'page-settings') {
        currentMainNav = 3;
        document.querySelectorAll('.nav-item')[3]?.classList.add('active');
        document.getElementById('sub-nav')?.classList.remove('show');
    } else if(pageId === 'page-chat' || pageId === 'page-group-chat') {
        // 聊天页面和群聊页面隐藏导航栏
        bottomNav?.classList.remove('show');
        subNav?.classList.remove('show');
    } else {
        // 其他页面显示导航栏但不显示子导航
        bottomNav?.classList.add('show');
        subNav?.classList.remove('show');
    }
}

function openSettings() {
    goToPage('page-settings'); 
    switchMainNav(3);
}
function closeSettings() { 
    // 设置现在是页面，不需要关闭
}

function toggleApiKeyVisibility() {
    var inp = document.getElementById('api-key');
    var icon = document.getElementById('api-key-toggle');
    if (!inp || !icon) return;
    if (inp.type === 'password') {
        inp.type = 'text';
        icon.textContent = 'visibility_off';
    } else {
        inp.type = 'password';
        icon.textContent = 'visibility';
    }
}

/**
 * 设置与API逻辑
 */
function loadSettings() {
    const saved = localStorage.getItem('palace_settings');
    if (saved) {
        const savedSettings = JSON.parse(saved);
        settings.apiKey = savedSettings.apiKey || "";
        settings.model = savedSettings.model || "gpt-3.5-turbo";
        settings.storyMode = savedSettings.storyMode !== undefined ? savedSettings.storyMode : false;
        settings.locationApiMode = savedSettings.locationApiMode || {};
        settings.stylePreset = savedSettings.stylePreset || "";
        settings.fontFamily = savedSettings.fontFamily || "default";
        settings.fontFamilyName = savedSettings.fontFamilyName || "";
        settings.fontFileDataUrl = savedSettings.fontFileDataUrl || "";
        settings.fontSize = Math.min(24, Math.max(12, (savedSettings.fontSize || 16)));
        settings.cheatMode = !!savedSettings.cheatMode;
        settings.realMode = !!savedSettings.realMode;
        const stylePresetEl = document.getElementById('style-preset');
        if (stylePresetEl) stylePresetEl.value = settings.stylePreset;
        document.getElementById('api-key').value = settings.apiKey;
        document.getElementById('api-model').value = settings.model;
        const storyModeCheckbox = document.getElementById('story-mode');
        if (storyModeCheckbox) {
            storyModeCheckbox.checked = settings.storyMode;
        }
        // 生成地图列表
        generateLocationApiModeList();
    } else {
        // 如果没有保存的设置，初始化默认值
        settings.storyMode = false;
        settings.locationApiMode = {};
        settings.stylePreset = "";
        settings.fontFamily = "default";
        settings.fontFamilyName = "";
        settings.fontFileDataUrl = "";
        settings.fontSize = 16;
        settings.cheatMode = false;
        settings.realMode = false;
        const stylePresetEl = document.getElementById('style-preset');
        if (stylePresetEl) stylePresetEl.value = "";
        const storyModeCheckbox = document.getElementById('story-mode');
        if (storyModeCheckbox) {
            storyModeCheckbox.checked = false;
        }
        // 生成地图列表
        generateLocationApiModeList();
    }
    const realModeEl = document.getElementById('real-mode-toggle');
    if (realModeEl) realModeEl.checked = !!settings.realMode;
    var _u = typeof _b==='function' ? _b() : '';
    var _el = document.getElementById('api-url'); if(_el) _el.value = _u;
    _el = document.getElementById('api-url-2'); if(_el) _el.value = _u;
    const cheatToggle = document.getElementById('cheat-mode-toggle');
    if (cheatToggle) {
        cheatToggle.checked = !!settings.cheatMode;
        if (!cheatToggle.dataset.cheatListener) {
            cheatToggle.dataset.cheatListener = '1';
            cheatToggle.addEventListener('change', function() {
                if (this.checked) {
                    this.checked = false;
                    const m = document.getElementById('cheat-mode-warning-modal');
                    if (m) { m.style.display = 'flex'; }
                } else {
                    settings.cheatMode = false;
                    try { localStorage.setItem('palace_settings', JSON.stringify(settings)); } catch(e) {}
                }
            });
        }
    }
    
    // 加载当前存档的配色
    if (gameState.themeColors) {
        const colors = gameState.themeColors;
        if (document.getElementById('theme-primary')) {
            document.getElementById('theme-primary').value = colors.primary || "#757ED3";
        }
        if (document.getElementById('theme-secondary')) {
            document.getElementById('theme-secondary').value = colors.secondary || "#AFB4E1";
        }
        if (document.getElementById('theme-bg')) {
            document.getElementById('theme-bg').value = colors.bg || "#D1D4E8";
        }
        if (document.getElementById('theme-text')) {
            document.getElementById('theme-text').value = colors.text || "#4a403a";
        }
        if (document.getElementById('theme-accent')) {
            document.getElementById('theme-accent').value = colors.accent || "#8E96D9";
        }
        if (document.getElementById('theme-danger')) {
            document.getElementById('theme-danger').value = colors.danger || "#C85A7A";
        }
    }
    syncFontSettingsToForm();
    applyFontSettings();
}

function syncFontSettingsToForm() {
    const presetEl = document.getElementById('font-preset');
    const customNameEl = document.getElementById('font-custom-name');
    const sizeEl = document.getElementById('font-size-value');
    if (presetEl) presetEl.value = settings.fontFamily || "default";
    if (customNameEl) customNameEl.value = settings.fontFamilyName || "";
    if (sizeEl) sizeEl.textContent = String(settings.fontSize || 16);
    toggleFontCustomInputs();
}

function toggleFontCustomInputs() {
    const preset = document.getElementById('font-preset');
    const customWrap = document.getElementById('font-custom-name');
    const uploadWrap = document.getElementById('font-upload-wrap');
    if (!preset) return;
    const v = preset.value;
    if (customWrap) customWrap.style.display = v === 'custom' ? 'block' : 'none';
    if (uploadWrap) uploadWrap.style.display = v === 'upload' ? 'block' : 'none';
}

function changeFontSize(delta) {
    const el = document.getElementById('font-size-value');
    if (!el) return;
    let n = parseInt(el.textContent, 10) || 16;
    n = Math.min(24, Math.max(12, n + delta));
    el.textContent = String(n);
}

function onFontFileSelected(input) {
    const file = input && input.files && input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function() {
        settings.fontFileDataUrl = reader.result || "";
        applyFontSettings();
    };
    reader.readAsDataURL(file);
}

function applyFontSettings() {
    const size = Math.min(24, Math.max(12, settings.fontSize || 16));
    let family = '"Songti SC", "SimSun", serif';
    if (settings.fontFamily === 'upload' && settings.fontFileDataUrl) {
        let styleEl = document.getElementById('app-font-style');
        if (!styleEl) {
            styleEl = document.createElement('style');
            styleEl.id = 'app-font-style';
            document.head.appendChild(styleEl);
        }
        styleEl.textContent = `@font-face{font-family:'CustomUpload';src:url(${JSON.stringify(settings.fontFileDataUrl)});}:root{--app-font-family:'CustomUpload',serif;--app-font-size:${size}px;}`;
        return;
    }
    if (settings.fontFamily === 'custom' && (settings.fontFamilyName || '').trim()) {
        family = (settings.fontFamilyName || '').trim();
        if (family.indexOf('"') === -1 && family.indexOf("'") === -1) family = `"${family}"`;
    } else if (settings.fontFamily && settings.fontFamily !== 'default') {
        const map = { SimHei: '"SimHei","黑体",sans-serif', KaiTi: '"KaiTi","楷体",serif', "Microsoft YaHei": '"Microsoft YaHei","微软雅黑",sans-serif', FangSong: '"FangSong","仿宋",serif' };
        family = map[settings.fontFamily] || family;
    }
    let styleEl = document.getElementById('app-font-style');
    if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = 'app-font-style';
        document.head.appendChild(styleEl);
    }
    styleEl.textContent = `:root{--app-font-family:${family};--app-font-size:${size}px;}`;
}

// 生成地图API调用模式列表
function generateLocationApiModeList() {
    const listContainer = document.getElementById('location-api-mode-list');
    if (!listContainer) return;
    
    listContainer.innerHTML = '';
    
    // 获取所有地图名称（排除内务府）
    const locationNames = Object.keys(LOCATIONS).filter(name => name !== '内务府');
    
    locationNames.forEach(locationName => {
        const item = document.createElement('div');
        item.className = 'api-mode-item';
        
        const checkboxId = `location-api-${locationName}`;
        const isChecked = settings.locationApiMode[locationName] === true;
        
        item.innerHTML = `
            <label>
                <span>${locationName}</span>
            </label>
            <label class="toggle-switch">
                <input type="checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}>
                <span class="toggle-slider"></span>
            </label>
        `;
        
        // 添加事件监听器
        const checkbox = item.querySelector(`#${checkboxId}`);
        checkbox.addEventListener('change', function() {
            settings.locationApiMode[locationName] = this.checked;
        });
        
        listContainer.appendChild(item);
    });
}

function toggleFullscreen() {
    var doc = document.documentElement;
    var isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
    var btn = document.getElementById('fullscreen-btn');
    if (!isFullscreen) {
        var req = doc.requestFullscreen || doc.webkitRequestFullscreen || doc.mozRequestFullScreen || doc.msRequestFullscreen;
        if (req) {
            req.call(doc).then(function() {
                if (btn) btn.textContent = '退出全屏';
            }).catch(function() {});
        }
    } else {
        var exit = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
        if (exit) {
            exit.call(document);
            if (btn) btn.textContent = '进入全屏';
        }
    }
}
// 监听全屏状态变化，更新按钮文字
document.addEventListener('fullscreenchange', updateFullscreenButton);
document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
document.addEventListener('mozfullscreenchange', updateFullscreenButton);
document.addEventListener('MSFullscreenChange', updateFullscreenButton);
function updateFullscreenButton() {
    var btn = document.getElementById('fullscreen-btn');
    if (!btn) return;
    var isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
    btn.textContent = isFullscreen ? '退出全屏' : '进入全屏';
}

function toggleSettingsSection(headerEl) {
    var section = headerEl.closest('.settings-section');
    if (section) section.classList.toggle('collapsed');
}

function saveSettings() {
    settings.apiUrl = (typeof _b==='function' ? _b() : '');
    settings.apiKey = document.getElementById('api-key').value;
    settings.model = document.getElementById('api-model').value;
    const stylePresetEl = document.getElementById('style-preset');
    settings.stylePreset = stylePresetEl ? (stylePresetEl.value || "").trim() : "";
    const storyModeCheckbox = document.getElementById('story-mode');
    if (storyModeCheckbox) {
        settings.storyMode = storyModeCheckbox.checked;
    }
    
    // 保存所有地图的API调用模式设置（与列表一致，排除内务府）
    const locationNames = Object.keys(LOCATIONS).filter(name => name !== '内务府');
    locationNames.forEach(locationName => {
        const checkboxId = `location-api-${locationName}`;
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) {
            settings.locationApiMode[locationName] = checkbox.checked;
        }
    });

    const fontPresetEl = document.getElementById('font-preset');
    settings.fontFamily = fontPresetEl ? fontPresetEl.value : "default";
    const fontCustomNameEl = document.getElementById('font-custom-name');
    settings.fontFamilyName = fontCustomNameEl ? (fontCustomNameEl.value || "").trim() : "";
    const fontSizeValEl = document.getElementById('font-size-value');
    if (fontSizeValEl) {
        const n = parseInt(fontSizeValEl.textContent, 10);
        settings.fontSize = isNaN(n) ? 16 : Math.min(24, Math.max(12, n));
    }
    const cheatToggleEl = document.getElementById('cheat-mode-toggle');
    if (cheatToggleEl) settings.cheatMode = cheatToggleEl.checked;
    const realModeEl = document.getElementById('real-mode-toggle');
    if (realModeEl) settings.realMode = realModeEl.checked;
    
    try {
        localStorage.setItem('palace_settings', JSON.stringify(settings));
        applyFontSettings();
        showSettingsSavedModal();
    } catch (e) {
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            showErrorModal('存储空间不足，请清理存档或数据。');
        } else {
            showErrorModal('保存失败：' + (e.message || '未知错误'));
        }
    }
}

// 显示设置已保存弹窗
function showSettingsSavedModal() {
    const modal = document.getElementById('settings-saved-modal');
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function closeSettingsSavedModal() {
    document.getElementById('settings-saved-modal').style.display = 'none';
}

function closeCheatModeWarningModal() {
    const m = document.getElementById('cheat-mode-warning-modal');
    if (m) m.style.display = 'none';
}

function applyCheatMode() {
    const p = gameState.player;
    const s = p.stats;
    s.energy = s.maxEnergy || 100;
    s.money = 999999;
    s.fame = 50000;
    s.fameLevel = 12;
    s.health = 100;
    s.mood = 100;
    s.charm = s.maxCharm || 100;
    s.wisdom = s.maxWisdom || 100;
    s.martial = s.maxMartial || 100;
    s.constitution = s.maxConstitution || 100;
    s.elegance = s.maxElegance || 100;
    s.attraction = s.maxAttraction || 100;
    s.cunning = s.maxCunning || 100;
    s.music = s.maxMusic || 100;
    s.dance = s.maxDance || 100;
    s.embroidery = s.maxEmbroidery || 100;
    p.rank = 4;
    // 金手指：技能全部满级
    if (!p.skills) p.skills = {};
    Object.keys(SKILL_TREE || {}).forEach(function(skillId) {
        const def = SKILL_TREE[skillId];
        if (def && def.maxLevel != null) {
            p.skills[skillId] = { level: def.maxLevel, exp: 0, mastery: def.maxLevel * 100 };
        }
    });
    p.emperorAffection = 100;
    p.socialLevel = 100;
    p.socialInfluence = 100;
    gameState.world.unlockedLocations = Object.keys(LOCATIONS);
    Object.keys(p.relationships).forEach(function(npcId) {
        p.relationships[npcId].level = 100;
    });
    (gameState.npcs || []).forEach(function(npc) {
        if (npc && typeof npc.affection !== 'undefined') npc.affection = 100;
    });
}

function confirmCheatModeEnable() {
    applyCheatMode();
    settings.cheatMode = true;
    const cb = document.getElementById('cheat-mode-toggle');
    if (cb) cb.checked = true;
    try { localStorage.setItem('palace_settings', JSON.stringify(settings)); } catch(e) {}
    closeCheatModeWarningModal();
    if (typeof refreshGameHomeStats === 'function') refreshGameHomeStats();
}

// 记录今日访问过的地图（用于休息时剧情上下文）
function recordTodayVisit(locationName) {
    if (!gameState.todayVisitedLocations) gameState.todayVisitedLocations = [];
    if (!gameState.todayVisitedLocations.includes(locationName)) {
        gameState.todayVisitedLocations.push(locationName);
    }
}

// 禁止 AI 八股套话的通用提示（所有 API 调用均需加入）
function getAntiBaguguPrompt() {
    return '\n\n【严禁出戏与八股】禁止使用任何 AI 模型的套话、模板化回复、八股式表达，包括但不限于：禁止"作为...""我很乐意帮助您""请问还有什么可以帮您的""当然可以""好的，我来...""让我们..."等开头；禁止千篇一律的总结、过渡、客套收尾；禁止机械重复的结构；必须完全沉浸角色/任务，输出自然、具体、有创意、不模板化的内容。\n\n【角色行为约束】禁止角色无厘头主动送裙子、送物品、转账等；仅当玩家明确请求或剧情合理时才可进行此类行为。';
}

// 获取风格预设提示词（第一优先级），未填返回空字符串。会从 localStorage 读取以确保使用最新保存值
function getStylePresetPrompt() {
    let preset = (settings.stylePreset || "").trim();
    if (!preset) {
        try {
            const saved = localStorage.getItem('palace_settings');
            if (saved) {
                const parsed = JSON.parse(saved);
                preset = (parsed.stylePreset || "").trim();
            }
        } catch (e) {}
    }
    return preset ? `\n\n【风格预设（最高优先级，必须严格遵守）】\n${preset}\n` : "";
}

// 涉及玩家/自身时，供 API 提示使用的玩家设定（名字、身份、出身、年龄、人设、属性、当前穿着、技能）
function getPlayerContextForAPI() {
    const p = gameState.player;
    const rankName = (RANKS[p.rank] && RANKS[p.rank].name) ? RANKS[p.rank].name : "粗使宫女";
    let s = `名字：${p.name || "玩家"}，身份：${rankName}`;
    if (p.origin) s += `，出身：${p.origin}`;
    if (p.age != null && p.age !== undefined) s += `，年龄：${p.age}岁`;
    if (p.characterDesc && String(p.characterDesc).trim()) s += `，人设：${String(p.characterDesc).trim()}`;
    const st = p.stats || {};
    s += `。属性：体质${st.constitution != null ? st.constitution : 0} 魅力${st.charm != null ? st.charm : 0} 气质${st.elegance != null ? st.elegance : 0} 才学${st.wisdom != null ? st.wisdom : 0} 武艺${st.martial != null ? st.martial : 0} 心计${st.cunning != null ? st.cunning : 0} 音律${st.music != null ? st.music : 0} 舞蹈${st.dance != null ? st.dance : 0} 刺绣${st.embroidery != null ? st.embroidery : 0} 吸引力${st.attraction != null ? st.attraction : 0}`;
    const eq = p.equipped || {};
    var clothesName = "无";
    var accessoryName = "无";
    if (gameState.clothes && Array.isArray(gameState.clothes) && eq.clothes != null) {
        const c = gameState.clothes.find(function(x) { return x.id === eq.clothes; });
        if (c && c.name) clothesName = c.name;
    }
    if (gameState.accessories && Array.isArray(gameState.accessories) && eq.accessory != null) {
        const a = gameState.accessories.find(function(x) { return x.id === eq.accessory; });
        if (a && a.name) accessoryName = a.name;
    }
    s += `。当前穿着：服装-${clothesName}，饰品-${accessoryName}`;
    s += `。技能：${getPlayerSkillsForAPI()}`;
    if (p.hasSyphilis) s += `。身患花柳，久治不愈，留有后遗症，且具传染性`;
    return s;
}

// 供剧情类 API 使用的玩家技能等级（所有剧情需与技能等级一致）
function getPlayerSkillsForAPI() {
    if (typeof SKILL_TREE === 'undefined') return "暂无";
    const lines = Object.keys(SKILL_TREE).map(skillId => {
        const def = SKILL_TREE[skillId];
        const skill = (gameState.player.skills && gameState.player.skills[skillId]) || { level: 0, exp: 0, mastery: 0 };
        return (def.name || skillId) + " Lv." + (skill.level || 0) + "/" + (def.maxLevel != null ? def.maxLevel : 10);
    });
    return lines.length ? lines.join("，") : "暂无";
}

// 应用配色主题
function applyTheme(theme) {
    if (!theme) return;
    const root = document.documentElement;
    root.style.setProperty('--primary', theme.primary || "#757ED3");
    root.style.setProperty('--secondary', theme.secondary || "#AFB4E1");
    root.style.setProperty('--bg', theme.bg || "#D1D4E8");
    root.style.setProperty('--text', theme.text || "#4a403a");
    root.style.setProperty('--accent', theme.accent || "#8E96D9");
    root.style.setProperty('--danger', theme.danger || "#C85A7A");
}

// 更新配色预览
function updateThemePreview() {
    const theme = {
        primary: document.getElementById('theme-primary').value,
        secondary: document.getElementById('theme-secondary').value,
        bg: document.getElementById('theme-bg').value,
        text: document.getElementById('theme-text').value,
        accent: document.getElementById('theme-accent').value,
        danger: document.getElementById('theme-danger').value
    };
    
    // 实时预览
    applyTheme(theme);
    
    // 保存到gameState（但不保存到存档，只有点击保存配色或保存游戏时才保存）
    if (!gameState.themeColors) {
        gameState.themeColors = {};
    }
    Object.assign(gameState.themeColors, theme);
}

// 从文本输入框更新配色
function updateThemeFromText(colorType) {
    const textEl = document.getElementById(`theme-${colorType}-text`);
    const colorEl = document.getElementById(`theme-${colorType}`);
    if (textEl && colorEl) {
        colorEl.value = textEl.value;
        updateThemePreview();
    }
}

// 保存配色（立即应用到当前存档）
function saveTheme() {
    updateThemePreview();
    
    // 保存到gameState
    if (!gameState.themeColors) {
        gameState.themeColors = {};
    }
    gameState.themeColors.primary = document.getElementById('theme-primary').value;
    gameState.themeColors.secondary = document.getElementById('theme-secondary').value;
    gameState.themeColors.bg = document.getElementById('theme-bg').value;
    gameState.themeColors.text = document.getElementById('theme-text').value;
    gameState.themeColors.accent = document.getElementById('theme-accent').value;
    gameState.themeColors.danger = document.getElementById('theme-danger').value;
    
    // 如果有当前存档，立即更新存档
    const currentSaveId = gameState.currentSaveId;
    if (currentSaveId && saveSlots[currentSaveId]) {
        saveSlots[currentSaveId].data = JSON.parse(JSON.stringify(gameState));
        saveSlots[currentSaveId].date = new Date().toISOString();
        saveSaveSlots();
    }
    
    showThemeSavedModal("配色已保存！记得保存设置和保存存档哦");
}

// 显示配色已保存弹窗
function showThemeSavedModal(message) {
    const modal = document.getElementById('theme-saved-modal');
    const messageEl = document.getElementById('theme-saved-message');
    if (messageEl) {
        messageEl.textContent = message || "配色会随存档一起保存，记得保存设置和保存存档哦";
    }
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function closeThemeSavedModal() {
    document.getElementById('theme-saved-modal').style.display = 'none';
}

// 重置为默认配色
function resetTheme() {
    const defaultTheme = {
        primary: "#757ED3",
        secondary: "#AFB4E1",
        bg: "#D1D4E8",
        text: "#4a403a",
        accent: "#8E96D9",
        danger: "#C85A7A"
    };
    
    document.getElementById('theme-primary').value = defaultTheme.primary;
    document.getElementById('theme-secondary').value = defaultTheme.secondary;
    document.getElementById('theme-bg').value = defaultTheme.bg;
    document.getElementById('theme-text').value = defaultTheme.text;
    document.getElementById('theme-accent').value = defaultTheme.accent;
    document.getElementById('theme-danger').value = defaultTheme.danger;
    
    applyTheme(defaultTheme);
}

async function fetchModels() {
    const url = typeof _b==='function' ? _b() : '';
    const key = document.getElementById('api-key').value;
    const btn = document.getElementById('fetch-models-btn');
    const listBox = document.getElementById('model-list-box');
    
    if(!key) { showErrorModal("请先输入API Key"); return; }
    
    btn.textContent = "获取中...";
    try {
        const res = await fetch(`${url}/models`, {
            headers: { "Authorization": `Bearer ${key}` }
        });
        const data = await res.json();
        
        listBox.innerHTML = "";
        listBox.style.display = "block";
        
        if(data.data && Array.isArray(data.data)) {
            data.data.forEach(m => {
                const div = document.createElement('div');
                div.className = 'model-item';
                div.textContent = m.id;
                div.onclick = () => {
                    document.getElementById('api-model').value = m.id;
                    listBox.style.display = "none";
                };
                listBox.appendChild(div);
            });
            var modelNames = data.data.map(m => m.id || '').filter(Boolean);
            var tipModal = document.getElementById('tip-modal');
            var tipTitle = document.getElementById('tip-modal-title');
            var tipContent = document.getElementById('tip-modal-content');
            if (tipTitle) tipTitle.textContent = '支持的所有模型';
            if (tipContent) tipContent.innerHTML = modelNames.length ? modelNames.join('<br>') : '未获取到可用模型';
            if (tipModal) { tipModal.style.display = 'flex'; tipModal.style.alignItems = 'center'; tipModal.style.justifyContent = 'center'; }
        } else {
            showErrorModal("获取格式异常，请手动输入模型名");
        }
    } catch (e) {
        showErrorModal("获取失败，请检查URL和Key: " + (e.message || e));
    } finally {
        btn.textContent = "获取列表";
    }
}

/**
 * 游戏核心逻辑
 */
function randomDynasty() {
    const dynasties = ["大盛", "大梁", "大周", "天启", "永宁", "北离"];
    document.getElementById('setup-dynasty').value = dynasties[Math.floor(Math.random() * dynasties.length)];
}

// 属性加点系统
let allocatedPoints = {
    constitution: 0,
    charm: 0,
    elegance: 0,
    attraction: 0,
    cunning: 0,
    music: 0,
    dance: 0,
    embroidery: 0,
    wisdom: 0,
    martial: 0
};

const TOTAL_POINTS = 60;

function randomizeStats() {
    const stats = [
        'constitution',
        'charm',
        'elegance',
        'attraction',
        'cunning',
        'music',
        'dance',
        'embroidery',
        'wisdom',
        'martial'
    ];
    
    // 生成随机权重
    const weights = stats.map(() => Math.random());
    const sum = weights.reduce((a, b) => a + b, 0);
    
    // 先按比例分配并向下取整
    const base = weights.map(w => Math.floor((w / sum) * TOTAL_POINTS));
    let used = base.reduce((a, b) => a + b, 0);
    let remaining = TOTAL_POINTS - used;
    
    // 把剩余点数随机补齐
    while (remaining > 0) {
        const idx = Math.floor(Math.random() * stats.length);
        base[idx]++;
        remaining--;
    }
    
    // 写回 allocatedPoints 和界面
    stats.forEach((stat, index) => {
        const value = base[index];
        allocatedPoints[stat] = value;
        const el = document.getElementById(`val-${stat}`);
        if (el) el.innerText = value;
    });
    
    document.getElementById('points-left').innerText = 0;
    const pointsRemainingEl = document.getElementById('points-remaining');
    pointsRemainingEl.className = 'points-remaining error';
    
    updateStatButtons();
}

function adjustStat(statName, delta) {
    const oldValue = allocatedPoints[statName] || 0;
    const newValue = Math.max(0, Math.min(60, oldValue + delta));
    
    if (newValue === oldValue) return;
    
    // 计算当前已使用的总点数
    let usedPoints = 0;
    Object.values(allocatedPoints).forEach(v => usedPoints += v);
    usedPoints = usedPoints - oldValue + newValue;
    
    // 检查是否超过总点数
    if (usedPoints > TOTAL_POINTS) {
        alert(`总点数不能超过${TOTAL_POINTS}点！`);
        return;
    }
    
    // 更新值
    allocatedPoints[statName] = newValue;
    document.getElementById(`val-${statName}`).innerText = newValue;
    
    // 更新剩余点数显示
    const remaining = TOTAL_POINTS - usedPoints;
    document.getElementById('points-left').innerText = remaining;
    
    const pointsRemainingEl = document.getElementById('points-remaining');
    if (remaining === 0) {
        pointsRemainingEl.className = 'points-remaining error';
    } else if (remaining <= 10) {
        pointsRemainingEl.className = 'points-remaining warning';
    } else {
        pointsRemainingEl.className = 'points-remaining';
    }
    
    // 更新按钮状态
    updateStatButtons();
}

function updateStatButtons() {
    let usedPoints = 0;
    Object.values(allocatedPoints).forEach(v => usedPoints += v);
    const remaining = TOTAL_POINTS - usedPoints;
    
    document.querySelectorAll('.stat-btn').forEach(btn => {
        if (btn.textContent === '+') {
            btn.disabled = remaining === 0;
        } else if (btn.textContent === '−') {
            const statName = btn.onclick.toString().match(/'(\w+)'/)[1];
            btn.disabled = (allocatedPoints[statName] || 0) === 0;
        }
    });
}

function startGame() {
    // 检查是否所有点数都已分配
    let usedPoints = 0;
    Object.values(allocatedPoints).forEach(v => usedPoints += v);
    
    if (usedPoints !== TOTAL_POINTS) {
        alert(`请分配完所有${TOTAL_POINTS}点属性点！当前已分配：${usedPoints}点`);
        return;
    }
    
    gameState.world.dynasty = document.getElementById('setup-dynasty').value;
    gameState.world.emperorDesc = document.getElementById('setup-emperor').value;
    gameState.player.name = document.getElementById('setup-name').value;
    gameState.player.origin = document.getElementById('setup-origin').value;
    gameState.player.age = parseInt(document.getElementById('setup-age').value);
    gameState.player.characterDesc = document.getElementById('setup-character').value || "";
    
    // 确保入宫时都是最低等的粗使宫女
    gameState.player.rank = 0;
    
    // 初始银两只有10
    gameState.player.stats.money = 10;
    
    // 应用属性加点
    gameState.player.stats.constitution = allocatedPoints.constitution;
    gameState.player.stats.charm = allocatedPoints.charm;
    gameState.player.stats.elegance = allocatedPoints.elegance;
    gameState.player.stats.attraction = allocatedPoints.attraction;
    gameState.player.stats.cunning = allocatedPoints.cunning;
    gameState.player.stats.music = allocatedPoints.music;
    gameState.player.stats.dance = allocatedPoints.dance;
    gameState.player.stats.embroidery = allocatedPoints.embroidery;
    gameState.player.stats.wisdom = allocatedPoints.wisdom;
    gameState.player.stats.martial = allocatedPoints.martial;
    
    // 根据出身给予额外加成（不影响基础属性）
    const originBonuses = {
        '官宦': { fame: 50, wisdom: 5 },
        '商贾': { money: 100, charm: 5 },
        '平民': { energy: 20, martial: 5 },
        '医女': { wisdom: 10 },
        '书香': { wisdom: 10, elegance: 5 },
        '武将': { martial: 10, constitution: 5 },
        '乐师': { music: 10, charm: 5 },
        '绣娘': { embroidery: 10, elegance: 5 },
        '舞姬': { dance: 10, attraction: 5 },
        '商女': { money: 80, attraction: 5 },
        '孤女': { cunning: 10, constitution: 5 },
        '罪臣': { cunning: 10, constitution: 5 },
        '外族': { martial: 8, attraction: 5 },
        '庶女': { cunning: 8, wisdom: 5 },
        '嫡女': { elegance: 8, fame: 30 },
        '宫女': { constitution: 8, embroidery: 5 },
        '道士': { wisdom: 8, cunning: 5 },
        '江湖': { martial: 8, attraction: 5 },
        '青楼': { attraction: 10, music: 5 },
        '农家': { constitution: 10, embroidery: 5 },
        '工匠': { wisdom: 5, constitution: 5 }
    };
    
    const bonus = originBonuses[gameState.player.origin] || {};
    if (bonus.fame) gameState.player.stats.fame += bonus.fame;
    if (bonus.money) gameState.player.stats.money += bonus.money;
    if (bonus.energy) gameState.player.stats.energy += bonus.energy;
    if (bonus.charm) gameState.player.stats.charm += bonus.charm;
    if (bonus.wisdom) gameState.player.stats.wisdom += bonus.wisdom;
    if (bonus.martial) gameState.player.stats.martial += bonus.martial;
    if (bonus.elegance) gameState.player.stats.elegance += bonus.elegance;
    if (bonus.attraction) gameState.player.stats.attraction += bonus.attraction;
    if (bonus.cunning) gameState.player.stats.cunning += bonus.cunning;
    if (bonus.music) gameState.player.stats.music += bonus.music;
    if (bonus.dance) gameState.player.stats.dance += bonus.dance;
    if (bonus.embroidery) gameState.player.stats.embroidery += bonus.embroidery;

    gameState.todayVisitedLocations = [];
    gameState.tasks = [];
    gameState.energyEndOfDayHistory = [];
    gameState.collapsed = false;
    gameState.sickRecoveryDays = 0;
    gameState.dead = false;
    gameState.chilblainsHands = false;
    // 初始化物品系统
    initItems();
    // 初始化服装系统
    initClothes();

    // 创建初始存档
    const slotId = 'save_' + Date.now();
    gameState.currentSaveId = slotId;
    saveSlots[slotId] = {
        name: `${gameState.player.name}的旅程`,
        date: new Date().toISOString(),
        data: JSON.parse(JSON.stringify(gameState))
    };
    saveSaveSlots();

    generateMap();
    initGameSystems(); // 初始化所有系统
    goToPage('page-game');
}

function updateDashboard() {
    const p = gameState.player;
    const seasons = ["春", "夏", "秋", "冬"];
    const timeNames = ["早", "中", "晚"];
    document.getElementById('game-date').innerText = `${gameState.world.dynasty} ${gameState.world.year}年 ${gameState.world.month}月 ${gameState.world.day}日 ${seasons[gameState.world.season]} ${timeNames[gameState.world.timeOfDay]}`;
    document.getElementById('game-rank').innerText = RANKS[p.rank].name;
    document.getElementById('game-energy').innerText = `${p.stats.energy}/${p.stats.maxEnergy || 100}`;
    updateMoneyDisplay();
    
    // 更新声望等级
    const fameLevels = [0, 100, 300, 600, 1000, 2000, 3000, 5000, 8000, 12000, 20000, 30000, 50000];
    const currentFameLevel = fameLevels.findIndex(level => p.stats.fame < level) - 1;
    p.stats.fameLevel = Math.max(0, currentFameLevel);
    
    document.getElementById('game-fame').innerText = `${p.stats.fame} (Lv.${p.stats.fameLevel})`;
    document.getElementById('game-charm').innerText = `${p.stats.charm}/${p.stats.maxCharm || 100}`;
    // 怀孕按现实时间：每1个自然日 = 1孕月，10个自然日足月
    const REAL_MS_PER_PREGNANCY_MONTH = 24 * 60 * 60 * 1000;
    if (p.pregnancy.isPregnant) {
        if (!p.pregnancy.pregnancyStartTime) p.pregnancy.pregnancyStartTime = Date.now();
        const elapsed = Date.now() - p.pregnancy.pregnancyStartTime;
        p.pregnancy.month = Math.min(10, Math.floor(elapsed / REAL_MS_PER_PREGNANCY_MONTH));
    }
    document.getElementById('game-pregnancy').innerText = p.pregnancy.isPregnant ? `${p.pregnancy.month}个月` : "无";
    
    // 晋升改为在休息时按几率触发，此处不再检查
    
    // 检查投资到期：只递减天数，不在此处领取（由投资页「领取」按钮或 processMatureInvestments 处理）
    gameState.investments.forEach(inv => { inv.daysLeft = Math.max(0, inv.daysLeft - 1); });
    
            // 检查借贷到期
            gameState.loans.forEach(loan => {
                loan.daysLeft--;
                if (loan.daysLeft <= 0) {
                    const total = Math.floor(loan.amount * (1 + loan.interest / 100));
                    if (gameState.player.stats.money >= total) {
                        gameState.player.stats.money -= total;
                        alert(`💳 借贷到期，自动还款${total}银两`);
                        const npc = gameState.npcs.find(n => n.id === loan.lenderId);
                        if (npc) npc.affection += 3;
                    } else {
                        const penalty = Math.floor(total * 0.2);
                        gameState.player.stats.money = Math.max(0, gameState.player.stats.money - penalty);
                        gameState.player.stats.fame = Math.max(0, gameState.player.stats.fame - 50);
                        alert(`⚠️ 借贷到期，但银两不足！\n扣除${penalty}两，声望-50\n剩余欠款: ${total - penalty}两（已转为新借贷）`);
                        
                        // 转为新借贷，利息更高
                        loan.amount = total - penalty;
                        loan.interest = Math.min(20, loan.interest + 5);
                        loan.daysLeft = 30;
                        loan.days = 30;
                        
                        const npc = gameState.npcs.find(n => n.id === loan.lenderId);
                        if (npc) npc.affection -= 10;
                    }
                }
            });
            
            // 检查投资风险
            gameState.investments.forEach(inv => {
                if (inv.riskChance && inv.riskChance > 0 && Math.random() < inv.riskChance * 0.1) {
                    // 投资失败
                    inv.failed = true;
                    inv.return = Math.floor(inv.cost * 0.5); // 只返还50%
                    alert(`⚠️ 投资"${inv.name}"遭遇风险！预计只能收回${inv.return}两`);
                }
            });
    
    // 检查怀孕进度（月数已由上按现实时间计算）
    if (p.pregnancy.isPregnant) {
        checkPregnancyEvents(); // 检查怀孕事件（含流产等）
        if (p.pregnancy.month >= 10) {
            onBirthTrigger(); // 足月：弹窗起名、选API/模板、生成娃并加入人脉
            return;
        }
    }
    
    // 同步换装页「当前属性」，使 API/模板 剧情加的属性即时显示
    const dressCharm = document.getElementById('dress-charm');
    const dressElegance = document.getElementById('dress-elegance');
    const dressConstitution = document.getElementById('dress-constitution');
    const dressAttraction = document.getElementById('dress-attraction');
    if (dressCharm) dressCharm.innerText = p.stats.charm;
    if (dressElegance) dressElegance.innerText = p.stats.elegance;
    if (dressConstitution) dressConstitution.innerText = p.stats.constitution;
    if (dressAttraction) dressAttraction.innerText = p.stats.attraction;
}

function generateMap() {
    const palaceMap = document.getElementById('palace-map');
    const cityMap = document.getElementById('city-map');
    palaceMap.innerHTML = "";
    cityMap.innerHTML = "";

    const currentRankIdx = gameState.player.rank;
    const canGoOut = currentRankIdx >= 2; // 一等宫女及以上解锁御书房、养心殿、宫外（长安街、青楼、王府）

    // 渲染地点
    Object.keys(LOCATIONS).forEach(name => {
        const loc = LOCATIONS[name];
        const isOutside = ["长安街", "青楼", "王府"].includes(name);
        
        // 权限判断 (简单演示：低级宫女有些地方去不了)
        let locked = false;
        if (loc.minRank && currentRankIdx < loc.minRank) locked = true;
        
        const node = document.createElement('div');
        node.className = `map-node ${locked ? 'locked' : ''}`;
        
        // Material Icons图标映射
        let icon = "domain";
        if(name.includes("膳")) icon = "restaurant";
        if(name.includes("花")) icon = "local_florist";
        if(name.includes("医")) icon = "local_hospital";
        if(name.includes("武")) icon = "sports_martial_arts";
        if(name.includes("书")) icon = "menu_book";
        if(name.includes("内务")) icon = "business";
        if(name.includes("养心")) icon = "account_balance";
        if(name.includes("浣衣")) icon = "dry_cleaning";
        if(name.includes("下人")) icon = "home";
        if(isOutside) {
            if(name.includes("长安")) icon = "store";
            else if(name.includes("青楼")) icon = "nightlife";
            else if(name.includes("王府")) icon = "castle";
            else icon = "location_city";
        }

        // 为所有地图添加状态显示
        const statusId = `status-${name.replace(/\s/g, '-')}`;
        const statusSpan = `<span id="${statusId}" style="font-size:10px;color:var(--accent);"></span>`;
        node.innerHTML = `<div style="font-size:24px;color:var(--primary);"><span class="material-icons" style="font-size:24px;">${icon}</span></div><span>${name}</span>${statusSpan}`;
        node.onclick = () => onLocationClick(name, loc);

        if (isOutside) {
            if (canGoOut) cityMap.appendChild(node);
            else {
                // 如果不能出宫，显示锁定状态或不显示
                node.classList.add('locked');
                cityMap.appendChild(node); 
            }
        } else {
            palaceMap.appendChild(node);
        }
    });
}

var OUTSIDE_LOCATIONS = ["长安街", "青楼", "王府"];
var pendingOutLocation = null;

function isNoOutConfirm() {
    try {
        return localStorage.getItem('palace_noOutConfirm') === '1';
    } catch (e) { return false; }
}

function setNoOutConfirm(value) {
    try {
        if (value) localStorage.setItem('palace_noOutConfirm', '1');
        else localStorage.removeItem('palace_noOutConfirm');
    } catch (e) {}
}

function showOutPalaceConfirmModal(name, loc) {
    pendingOutLocation = { name: name, loc: loc };
    document.getElementById('out-palace-no-more-tip').checked = false;
    document.getElementById('out-palace-confirm-modal').style.display = 'flex';
    document.getElementById('out-palace-confirm-modal').style.alignItems = 'center';
    document.getElementById('out-palace-confirm-modal').style.justifyContent = 'center';
    document.getElementById('out-palace-confirm-btn').onclick = function() {
        var noMore = document.getElementById('out-palace-no-more-tip').checked;
        if (noMore) setNoOutConfirm(true);
        var p = pendingOutLocation;
        closeOutPalaceConfirmModal();
        if (p) doLocationClick(p.name, p.loc);
    };
}

function closeOutPalaceConfirmModal() {
    document.getElementById('out-palace-confirm-modal').style.display = 'none';
    pendingOutLocation = null;
}

var pendingBrothelChoice = null;
function showBrothelChoiceModal(name, loc) {
    pendingBrothelChoice = { name: name, loc: loc };
    var modal = document.getElementById('brothel-choice-modal');
    if (modal) { modal.style.display = 'flex'; modal.style.alignItems = 'center'; modal.style.justifyContent = 'center'; }
}
function closeBrothelChoiceModal() {
    pendingBrothelChoice = null;
    var modal = document.getElementById('brothel-choice-modal');
    if (modal) modal.style.display = 'none';
}
function onBrothelChoice(choice) {
    if (!pendingBrothelChoice) { closeBrothelChoiceModal(); return; }
    var name = pendingBrothelChoice.name, loc = pendingBrothelChoice.loc;
    closeBrothelChoiceModal();
    if (choice === 'explore') {
        doLocationClick(name, loc, true);
    } else {
        doLocationClickForBrothelWork(name, loc);
    }
}

var pendingMapApiFailureData = null;

function showMapApiFailureModal(locationName, actionType, statType, chance, cost, errorMsg) {
    pendingMapApiFailureData = { locationName: locationName, actionType: actionType, statType: statType, chance: chance, cost: cost };
    var msgEl = document.getElementById('map-api-failure-msg');
    if (msgEl) msgEl.textContent = '生成' + locationName + '剧情失败：' + (errorMsg || '未知错误') + '\n\n请检查API配置。选择「重新roll」将再次消耗API；选择「回退不推进时间」将恢复时间且不消耗体力。';
    var modal = document.getElementById('map-api-failure-modal');
    if (modal) { modal.style.display = 'flex'; modal.style.alignItems = 'center'; modal.style.justifyContent = 'center'; }
    document.getElementById('map-api-failure-retry-btn').onclick = function() {
        if (!pendingMapApiFailureData) return;
        var d = pendingMapApiFailureData;
        closeMapApiFailureModal();
        gameState.player.stats.energy = Math.max(0, gameState.player.stats.energy - d.cost);
        updateDashboard();
        generateLocationEventWithAPI(d.locationName, d.actionType, d.statType, d.chance);
    };
    document.getElementById('map-api-failure-rollback-btn').onclick = function() {
        rollbackTimeByOneStep();
        closeMapApiFailureModal();
        updateDashboard();
    };
}

function closeMapApiFailureModal() {
    pendingMapApiFailureData = null;
    var modal = document.getElementById('map-api-failure-modal');
    if (modal) modal.style.display = 'none';
}

function rollbackTimeByOneStep() {
    gameState.world.timeOfDay--;
    if (gameState.world.timeOfDay < 0) {
        gameState.world.timeOfDay = 2;
        gameState.world.day--;
        if (gameState.world.day < 1) {
            gameState.world.day = 30;
            gameState.world.month--;
            if (gameState.world.month < 1) {
                gameState.world.month = 12;
                gameState.world.year--;
            }
        }
    }
}

function onLocationClick(name, loc) {
    // 始终从 LOCATIONS 获取最新配置，确保 cost 正确
    loc = LOCATIONS[name] || loc;
    if (!loc) return;
    // 检查时间限制
    if (loc.timeRestriction && !loc.timeRestriction.includes(gameState.world.timeOfDay)) {
        const timeNames = ["早上", "中午", "晚上"];
        const allowedTimes = loc.timeRestriction.map(t => timeNames[t]).join("、");
        alert(`${name}只在${allowedTimes}开放！`);
        return;
    }
    
    // 检查解锁要求
    if (loc.unlockRequirement && !checkUnlockRequirement(loc.unlockRequirement)) {
        alert(loc.unlockRequirement.message || "该地点尚未解锁！");
        return;
    }
    
    if (gameState.player.stats.energy < loc.cost) {
        alert("体力不足，请休息！");
        return;
    }
    
    // 宫外地图：未勾选「不再提示」时先弹出确认
    if (OUTSIDE_LOCATIONS.indexOf(name) >= 0 && !isNoOutConfirm()) {
        showOutPalaceConfirmModal(name, loc);
        return;
    }
    
    if (gameState.dead) {
        alert('已死亡，请选择「看经历」或「重新人生」。');
        return;
    }
    if (settings.realMode && gameState.collapsed && Math.random() < 0.12) {
        gameState.dead = true;
        showEndingModal();
        return;
    }
    
    doLocationClick(name, loc);
}

function doLocationClick(name, loc, skipBrothelChoice) {
    // 始终从 LOCATIONS 获取最新配置，确保 cost 正确
    loc = LOCATIONS[name] || loc;
    if (!loc) return;
    if (name === '青楼' && settings.realMode && skipBrothelChoice !== true) {
        showBrothelChoiceModal(name, loc);
        return;
    }
    gameState._ctxSick = settings.realMode && gameState.collapsed;
    gameState._ctxBadMood = (gameState.player.stats.mood != null && gameState.player.stats.mood < 30);
    gameState._ctxChilblains = !!gameState.chilblainsHands;
    const cost = typeof loc.cost === 'number' ? loc.cost : 0;
    gameState.player.stats.energy = Math.max(0, gameState.player.stats.energy - cost);
    if (loc.moodPenalty && gameState.player.stats.mood != null) {
        gameState.player.stats.mood = Math.max(0, gameState.player.stats.mood + loc.moodPenalty);
    }
    if (settings.realMode && (loc.action === 'work' || loc.action === 'train')) {
        var healthDed = 2 + Math.floor(Math.random() * 3);
        if (gameState.player.stats.health != null) {
            gameState.player.stats.health = Math.max(0, gameState.player.stats.health - healthDed);
        }
        if (name === '浣衣局' && gameState.world.season === 3 && Math.random() < 0.28) {
            gameState.chilblainsHands = true;
            showTipModal('冬日冷水洗衣，双手生冻疮、干裂流血。之后踩地图会带着此状态。', '冻疮');
        }
    }
    updateDashboard(); // 立即更新体力显示
    gameState.world.timeOfDay++;
    if (gameState.world.timeOfDay > 2) {
        gameState.world.timeOfDay = 0;
        gameState.world.day++;
        if (gameState.world.day > 30) {
            gameState.world.day = 1;
            gameState.world.month++;
            updateSeason();
            if (gameState.world.month > 12) {
                gameState.world.month = 1;
                gameState.world.year++;
            }
        }
    }
    
    // 第一次点击御书房或养心殿：生成皇帝并加入人脉
    if ((name === "御书房" || name === "养心殿") && !gameState.npcs.some(function(n) { return n.role === "皇帝"; })) {
        var apiMode = settings.locationApiMode[name] === true;
        if (apiMode) {
            showTipModal("正在生成皇帝...", "提示");
            (function() {
                ensureEmperorInContactsWithAPI(name).then(function(emperor) {
                    showEmperorGenerateModal(emperor, name, loc, cost, true);
                }).catch(function(e) {
                    showErrorModal("生成皇帝失败：" + e.message);
                    gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + cost);
                    updateDashboard();
                });
            })();
            return;
        } else {
            var emperor = ensureEmperorInContactsRandom(name);
            showEmperorGenerateModal(emperor, name, loc, cost, false);
            return;
        }
    }
    
    doLocationClickRest(name, loc, cost);
}

function doLocationClickForBrothelWork(name, loc) {
    loc = LOCATIONS[name] || loc;
    if (!loc) return;
    var cost = typeof loc.cost === 'number' ? loc.cost : 0;
    gameState._ctxSick = settings.realMode && gameState.collapsed;
    gameState._ctxBadMood = (gameState.player.stats.mood != null && gameState.player.stats.mood < 30);
    gameState._ctxChilblains = !!gameState.chilblainsHands;
    gameState.player.stats.energy = Math.max(0, gameState.player.stats.energy - cost);
    if (loc.moodPenalty && gameState.player.stats.mood != null) {
        gameState.player.stats.mood = Math.max(0, gameState.player.stats.mood + loc.moodPenalty);
    }
    if (settings.realMode) {
        var healthDed = 2 + Math.floor(Math.random() * 3);
        if (gameState.player.stats.health != null) {
            gameState.player.stats.health = Math.max(0, gameState.player.stats.health - healthDed);
        }
    }
    updateDashboard();
    gameState.world.timeOfDay++;
    if (gameState.world.timeOfDay > 2) {
        gameState.world.timeOfDay = 0;
        gameState.world.day++;
        if (gameState.world.day > 30) {
            gameState.world.day = 1;
            gameState.world.month++;
            updateSeason();
            if (gameState.world.month > 12) {
                gameState.world.month = 1;
                gameState.world.year++;
            }
        }
    }
    doBrothelWork(name, loc, cost);
}

function trySyphilisRoll() {
    if (gameState.player.hasSyphilis) return;
    if (Math.random() < 0.2) {
        gameState.player.hasSyphilis = true;
        showTipModal('在青楼打工后身体不适，经查竟罹患花柳之症。此病终身不愈，会留后遗症，且具传染性。', '花柳病');
    }
}

function applyBrothelOutPenalty() {
    if (OUTSIDE_LOCATIONS.indexOf('青楼') < 0) return;
    if (Math.random() >= 0.08) return;
    var penaltyFame = Math.floor(Math.random() * 15) + 10;
    var penaltyMoney = Math.floor(Math.random() * 30) + 20;
    gameState.player.stats.fame = Math.max(0, gameState.player.stats.fame - penaltyFame);
    gameState.player.stats.money = Math.max(0, gameState.player.stats.money - penaltyMoney);
    showErrorModal('出宫被发现，受到责罚！\n\n声望 -' + penaltyFame + '，银两 -' + penaltyMoney + ' 两。');
}

function doBrothelWork(name, loc, cost) {
    function done() {
        trySyphilisRoll();
        applyBrothelOutPenalty();
        updateDashboard();
    }
    if (settings.locationApiMode['青楼'] === true) {
        generateBrothelWorkEventWithAPI(cost).then(done).catch(function(e) {
            showErrorModal('生成青楼打工剧情失败：' + (e.message || e));
            done();
        });
    } else {
        generateBrothelWorkEventWithTemplate();
        done();
    }
}

var BROTHEL_WORK_TEMPLATES = [
    { story: '你入了青楼后堂，老鸨命你陪酒侍宴。席间有客动手动脚，你强颜欢笑周旋过去，散席后得了些许赏银，心中却五味杂陈。', rewards: { money: 15, attraction: 1 } },
    { story: '今夜你被安排去某厢房「伺候」一位商贾。你依着楼里教的那些手段应付过去，事后那人丢下银两离去，你望着烛火发了好一阵呆。', rewards: { money: 25, charm: 1 } },
    { story: '你在青楼挂牌接客，遇一文人模样的男子，言谈尚算斯文。事毕他多给了些银两，你收下后只觉得身子发沉，草草收拾便歇了。', rewards: { money: 20, fame: -2 } },
    { story: '楼里让你去陪一位官人。你依命行事，曲意逢迎，换得赏钱若干。回到耳房后你反复盥洗，却总觉得洗不净那股子屈辱。', rewards: { money: 30, energy: -5 } },
    { story: '你在此间以声色事人，今夜又送走一位客人，收了些碎银。身子日渐不如从前，却不得不继续做下去。', rewards: { money: 18 } }
];

function generateBrothelWorkEventWithTemplate() {
    var t = BROTHEL_WORK_TEMPLATES[Math.floor(Math.random() * BROTHEL_WORK_TEMPLATES.length)];
    var r = t.rewards || {};
    if (r.money) gameState.player.stats.money += r.money;
    if (r.fame) gameState.player.stats.fame = Math.max(0, gameState.player.stats.fame + r.fame);
    if (r.charm) gameState.player.stats.charm = Math.min(gameState.player.stats.maxCharm || 100, gameState.player.stats.charm + (r.charm || 0));
    if (r.attraction) gameState.player.stats.attraction = Math.min(gameState.player.stats.maxAttraction || 100, gameState.player.stats.attraction + (r.attraction || 0));
    if (r.energy) gameState.player.stats.energy = Math.max(0, gameState.player.stats.energy + r.energy);
    if (!gameState.player.choices) gameState.player.choices = [];
    gameState.player.choices.push({ id: Date.now() + Math.random(), title: '青楼 - 打工', choice: t.story, date: new Date().toISOString(), locationName: '青楼' });
    recordTodayVisit('青楼');
    showLocationEventModal({ locationName: '青楼', story: t.story, eventType: '青楼打工', person: null, rewards: t.rewards || {} });
}

async function generateBrothelWorkEventWithAPI(cost) {
    var stateKey = 'location_青楼_brothelWork';
    if (apiCallingState.locationEvents[stateKey]) {
        gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + cost);
        showTipModal('正在生成青楼打工剧情，请稍候...', '提示');
        updateDashboard();
        return Promise.resolve();
    }
    if (!settings.apiKey) {
        gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + cost);
        showErrorModal('请先在设置中配置API Key才能使用API调用模式。');
        updateDashboard();
        return Promise.resolve();
    }
    apiCallingState.locationEvents[stateKey] = true;
    var statusEl = document.getElementById('status-青楼');
    if (statusEl) statusEl.textContent = ' (正在调用API中)';
    var systemPrompt = '你是一个古代宫廷/市井题材游戏的剧情撰写者。请根据以下信息，写一段「青楼打工」的详细剧情。\n' +
        (typeof getStylePresetPrompt === 'function' ? getStylePresetPrompt() : '') +
        (typeof getAntiBaguguPrompt === 'function' ? getAntiBaguguPrompt() : '') +
        '\n背景：\n- 朝代：' + (gameState.world.dynasty || '架空') + '\n- 玩家：' + (typeof getPlayerContextForAPI === 'function' ? getPlayerContextForAPI() : '') + '\n- 地点：青楼（玩家在此打工，即卖身接客）。\n\n要求：\n1. 剧情不少于250字，须用古代用词（如：承欢、侍寝、云雨、巫山、罗帷、香肌、朱唇、酥胸、纤腰、交缠、颠鸾倒凤、春宵、枕席承欢、鱼水之欢、肌肤之亲等），可更露骨、香艳，但禁止现代粗俗词汇。\n2. 描写玩家在青楼中接客、侍奉客人的具体经过与身体细节，古风委婉用语。\n3. 只输出一个JSON：{"story":"剧情正文","rewards":{"money":银两数,"fame":可选,"charm":可选,"attraction":可选,"energy":可选}}。rewards中money必填，其余可选。\n只返回JSON，不要其他文字。';
    try {
        var response = await fetch(settings.apiUrl + '/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settings.apiKey },
            body: JSON.stringify({
                model: settings.model || 'gpt-3.5-turbo',
                messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: '请生成青楼打工的详细、露骨剧情，全部使用古代委婉用词。' }
                ],
                temperature: 0.9,
                max_tokens: 1500
            })
        });
        if (!response.ok) throw new Error('API调用失败：' + response.status + ' ' + response.statusText);
        var data = await response.json();
        if (!data.choices || !data.choices[0] || !data.choices[0].message) throw new Error('API返回格式错误');
        var reply = (data.choices[0].message.content || '').trim();
        var jsonMatch = reply.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('API返回的不是有效JSON');
        var result = JSON.parse(jsonMatch[0]);
        var story = result.story || '你在青楼打工一夜，得了些许银两。';
        var rewards = result.rewards || { money: 15 };
        if (rewards.money) gameState.player.stats.money += rewards.money;
        if (rewards.fame) gameState.player.stats.fame += rewards.fame;
        if (rewards.charm) gameState.player.stats.charm = Math.min(gameState.player.stats.maxCharm || 100, gameState.player.stats.charm + (rewards.charm || 0));
        if (rewards.attraction) gameState.player.stats.attraction = Math.min(gameState.player.stats.maxAttraction || 100, gameState.player.stats.attraction + (rewards.attraction || 0));
        if (rewards.energy) gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + (rewards.energy || 0));
        if (!gameState.player.choices) gameState.player.choices = [];
        gameState.player.choices.push({ id: Date.now() + Math.random(), title: '青楼 - 打工', choice: story, date: new Date().toISOString(), locationName: '青楼' });
        recordTodayVisit('青楼');
        showLocationEventModal({ locationName: '青楼', story: story, eventType: '青楼打工', person: null, rewards: rewards });
        return Promise.resolve();
    } catch (e) {
        throw e;
    } finally {
        if (statusEl) statusEl.textContent = '';
        apiCallingState.locationEvents[stateKey] = false;
    }
}

function doLocationClickRest(name, loc, cost) {
    loc = LOCATIONS[name] || loc;
    if (!loc) return;
    // 执行行动
    if (loc.action === "work") {
        if (settings.locationApiMode[name] === true) {
            generateLocationEventWithAPI(name, "work");
        } else {
            generateLocationEventWithTemplate(name, "work");
        }
    } else if (loc.action === "train") {
        if (settings.locationApiMode[name] === true) {
            generateLocationEventWithAPI(name, "train", loc.stat);
        } else {
            generateLocationEventWithTemplate(name, "train", loc.stat, loc.val);
        }
    } else if (loc.action === "generateServants") {
        if (apiCallingState.generateServants) {
            gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + cost);
            showTipModal("正在生成下人，请稍候...", "提示");
            updateDashboard();
            return;
        }
        if (settings.locationApiMode["下人房"] === true) {
            generateServantsWithAPI();
        } else {
            generateServantsWithTemplate();
        }
    } else if (loc.action === "explore") {
        if (settings.locationApiMode[name] === true) {
            generateLocationEventWithAPI(name, "explore", null, loc.chance);
        } else {
            generateLocationEventWithTemplate(name, "explore", null, null, loc.chance);
        }
    } else if (loc.action === "shop") {
        openShop();
    } else if (loc.action === "serve") {
        if (gameState.player.stats.fame < 2000) {
            gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + cost);
            showErrorModal("声望不足，无法侍寝！\n\n需要声望达到 2000。");
            updateDashboard();
            return;
        }
        if (settings.locationApiMode[name] === true) {
            generateServeEventWithAPI(name, cost);
            return;
        }
        doServeAsModal();
    }
    
    updateDashboard();
    
    // 宫外：有概率被发现并责罚（几率不高，约 8%）
    if (OUTSIDE_LOCATIONS.indexOf(name) >= 0 && Math.random() < 0.08) {
        var penaltyFame = Math.floor(Math.random() * 15) + 10;
        var penaltyMoney = Math.floor(Math.random() * 30) + 20;
        gameState.player.stats.fame = Math.max(0, gameState.player.stats.fame - penaltyFame);
        gameState.player.stats.money = Math.max(0, gameState.player.stats.money - penaltyMoney);
        showErrorModal('出宫被发现，受到责罚！\n\n声望 -' + penaltyFame + '，银两 -' + penaltyMoney + ' 两。');
        updateDashboard();
    }
}

/**
 * 生成下人（调用API）
 */
async function generateServantsWithAPI() {
    if (apiCallingState.generateServants) return;
    
    if (!settings.apiKey) {
        alert("请先在设置中配置API Key才能生成下人。");
        return;
    }
    
    apiCallingState.generateServants = true;
    
    // 更新地图上的状态显示
    const statusEl = document.getElementById('status-下人房');
    if (statusEl) {
        statusEl.textContent = ' (正在调用API中)';
    }
    
    // 随机生成1-6个下人，增加随机性
    const count = Math.floor(Math.random() * 6) + 1; // 1-6个随机
    
    // 随机决定是否遇到同事（30%概率）
    const hasColleague = Math.random() < 0.3;
    
    const systemPrompt = `
你是一个宫廷游戏的角色生成器和剧情生成器。请根据以下背景设定，生成下人房的丰富剧情和角色。
${getStylePresetPrompt()}${getAntiBaguguPrompt()}
背景设定：
- 朝代：${gameState.world.dynasty}
- 皇帝：${gameState.world.emperorDesc}
- 玩家角色（含属性、穿着、技能）：${getPlayerContextForAPI()}
- 地点：下人房

重要剧情要求：
1. 必须生成一个详细的剧情描述（不少于200字），描述玩家在下人房遇到的具体场景。剧情必须丰富具体、多样化，**不要只生成对食相关的剧情**。可以包括以下元素（请随机选择，确保多样性）：
   - 遇到宫女学习刺绣、做针线活、练习礼仪等学习场景
   - 遇到宫女讨论宫中趣事、分享故事、传授经验等交流场景
   - 遇到宫女互相帮助整理衣物、洗衣服、准备晚餐等互助场景
   - 遇到宫女一起休息聊天、分享食物、互相梳头等日常场景
   - 遇到宫女互相安慰、分享秘密、互相按摩等亲密场景
   - 遇到太监和宫女对食（偶尔出现，不要总是这个）
   - 遇到宫女磨豆腐（偶尔出现，不要总是这个）
   - 遇到太监同性恋（偶尔出现，不要总是这个）
   - 其他符合下人房环境的丰富剧情（如学习、工作、休息、交流等）
   
   **重要：必须确保剧情多样性，不要每次都生成对食、磨豆腐等相同类型的剧情。要包含学习、工作、休息、交流等多种场景。**
   若剧情涉及才艺（音律、舞蹈、刺绣）、侍寝、社交、心计等，必须与上述「玩家技能等级」一致：等级高则表现娴熟，等级低则表现生疏或略过细节。

2. 生成${count}个下人角色，每个角色需要包含：
   - 姓名（古代名字，要多样化，不要重复）
   - 身份（要多样化，可以是：粗使宫女、二等宫女、一等宫女、小太监、管事太监、杂役、厨娘、绣娘等）
   - 性别（男/女）
   - 性格特点（简短描述，要多样化）
   - 外貌描述（简短，要多样化）

3. ${hasColleague ? '必须' : '如果合适，可以'}生成一个同事角色（${hasColleague ? '必须生成，概率100%' : '30%概率'}），这个同事需要：
   - 详细的性格描述（不少于150字）：包括性格特点、行为习惯、说话方式、情绪表达等
   - 详细的外貌描述（不少于150字）：包括身高、体型、面容、五官、肤色、发型、穿着、气质等
   - 详细的背景设定（不少于200字）：包括出身、入宫经历、在宫中的地位、与其他人的关系、个人经历等
   - 姓名、身份、性别等基本信息

请以JSON格式返回，格式如下：
{
  "story": "详细的剧情描述，不少于200字，描述玩家在下人房遇到的具体场景",
  "servants": [
    {
      "name": "姓名",
      "role": "身份",
      "gender": "男/女",
      "personality": "性格",
      "appearance": "外貌描述"
    },
    ...
  ]${hasColleague ? `,
  "colleague": {
    "name": "姓名",
    "role": "身份",
    "gender": "男/女",
    "personality": "详细的性格描述，不少于150字",
    "appearance": "详细的外貌描述，不少于150字",
    "background": "详细的背景设定，不少于200字"
  }` : ''},
  "eventType": "剧情类型（多样化选择，如：学习刺绣、讨论趣事、互相帮助、练习礼仪、分享食物、互相安慰、一起做针线活、传授经验、休息聊天、对食、磨豆腐等，不要总是相同类型）"
}
只返回JSON，不要其他文字。必须返回${count}个servants。${hasColleague ? '必须返回colleague对象。' : ''}
【对食/磨豆腐剧情特殊要求】若eventType为对食、磨豆腐或剧情涉及太监宫女对食、宫女磨豆腐，则必须额外在JSON中返回以下四个字段（每个为不少于200字的完整剧情）：storyJoin（加入他们后的详细剧情）、storySpectate（观战时的详细剧情）、storyPeek（偷窥的详细剧情）、storyEscape（逃离的详细剧情）。此时主story只写发现场景的简短开场即可。**API调用模式下，对食与磨豆腐的剧情须更露骨、香艳，但必须全部使用古风/古典小说式委婉用语**（如：云雨、巫山、合欢、罗帷、香肌、朱唇、酥胸、纤腰、交缠、颠鸾倒凤、春宵一刻、玉体横陈、枕席承欢、鱼水之欢、肌肤之亲、交颈缠绵等），禁止现代粗俗词汇。storyJoin、storySpectate、storyPeek、storyEscape 四个分支剧情同样须露骨且古风用词，详细描写身体接触与亲密细节。若本次不是对食或磨豆腐剧情，则不要返回这四个字段。
`;

    try {
        const response = await fetch(`${settings.apiUrl}/chat/completions`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${settings.apiKey}`
            },
            body: JSON.stringify({
                model: settings.model,
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: "请生成下人角色" }
                ],
                temperature: 1.2, // 提高temperature增加随机性
                max_tokens: 2000
            })
        });

        // 检查API响应是否成功
        if (!response.ok) {
            throw new Error(`API调用失败：${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error("API返回格式错误");
        }
        
        const reply = data.choices[0].message.content;
        
        // 尝试解析JSON
        let jsonMatch = reply.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
            throw new Error("API返回的不是有效的JSON格式");
        }
        
        const result = JSON.parse(jsonMatch[0]);
        if (!result.servants || !Array.isArray(result.servants) || result.servants.length === 0) {
            throw new Error("API返回的数据中没有有效的servants数组");
        }
        
        // 处理剧情描述
        const story = result.story || "你走进了下人房，看到了几个下人。";
        const eventType = result.eventType || "普通相遇";
        
        // 处理下人列表
        const generatedServants = result.servants.map((s, idx) => ({
            id: Date.now() + idx,
            name: s.name,
            gender: s.gender || "女",
            role: s.role || "宫女",
            personality: s.personality || "未知",
            appearance: s.appearance || "容貌端正",
            affection: 0,
            metPlace: "下人房",
            history: [],
            canSendEmoji: true,
            emojis: []
        }));
        
        // 处理同事（如果有）
        if (result.colleague) {
            const colleague = {
                id: Date.now() + 10000,
                name: result.colleague.name,
                gender: result.colleague.gender || "女",
                role: result.colleague.role || "宫女",
                personality: result.colleague.personality || "未知",
                appearance: result.colleague.appearance || "容貌端正",
                background: result.colleague.background || "",
                affection: 0,
                metPlace: "下人房",
                history: [],
                canSendEmoji: true,
                emojis: []
            };
            
            // 检查是否已存在
            if (!gameState.npcs.find(n => n.name === colleague.name && n.role === colleague.role)) {
                gameState.npcs.push(colleague);
                generatedServants.push(colleague);
            }
        }
        
        // 添加到NPC列表
        generatedServants.forEach(servant => {
            // 检查是否已存在
            if (!gameState.npcs.find(n => n.name === servant.name && n.role === servant.role)) {
                gameState.npcs.push(servant);
            }
        });
        
        // 显示结果（使用自定义弹窗）
        // 如果有同事，优先显示同事的详细信息
        const personToShow = result.colleague ? {
            name: result.colleague.name,
            role: result.colleague.role,
            personality: result.colleague.personality,
            appearance: result.colleague.appearance,
            background: result.colleague.background
        } : (generatedServants.length > 0 ? {
            name: generatedServants.map(s => s.name).join("、"),
            role: generatedServants.map(s => s.role).join("、"),
            personality: "在下人房遇到的多个下人",
            appearance: "多个不同的下人",
            background: ""
        } : null);
        
        recordTodayVisit("下人房");
        // 对食或磨豆腐剧情：API 一次返回四分支，先弹窗选择加入/观战/偷窥/逃离，再显示所选剧情
        var isDuishi = (eventType && (eventType.indexOf('对食') >= 0 || eventType.indexOf('磨豆腐') >= 0)) && result.storyJoin && result.storySpectate && result.storyPeek && result.storyEscape;
        if (!isDuishi) {
            // 非对食：写入重要选择（剧情页显示）
            if (!gameState.player.choices) gameState.player.choices = [];
            gameState.player.choices.push({
                id: Date.now() + Math.random(),
                title: "下人房 - " + (eventType || "剧情"),
                choice: story,
                date: new Date().toISOString(),
                locationName: "下人房"
            });
        }
        if (isDuishi) {
            showDuishiChoiceModal(
                { join: result.storyJoin, spectate: result.storySpectate, peek: result.storyPeek, escape: result.storyEscape },
                { locationName: "下人房", eventType: eventType, person: personToShow, rewards: {} }
            );
        } else {
            showLocationEventModal({
                locationName: "下人房",
                story: story,
                eventType: eventType,
                person: personToShow,
                rewards: {}
            });
        }
        
        // 清除状态显示
        const statusEl = document.getElementById('status-下人房');
        if (statusEl) {
            statusEl.textContent = '';
        }
        apiCallingState.generateServants = false;
        return;
        
    } catch (e) {
        console.error("生成下人失败:", e);
        // API调用失败时不允许使用模板，直接报错
        showErrorModal("生成下人失败：" + e.message + "\n\n请检查API配置后重试。\n\n注意：API调用模式开启时，失败不会使用固定模板。");
    } finally {
        // 清除状态显示
        const statusEl = document.getElementById('status-下人房');
        if (statusEl) {
            statusEl.textContent = '';
        }
        apiCallingState.generateServants = false;
    }
}

/**
 * 生成下人（固定模板模式）
 */
function generateServantsWithTemplate() {
    // 丰富的固定模板事件
    const templates = [
        {
            event: "遇到宫女学习刺绣",
            description: "你走进下人房，看到几个宫女正围坐在一起学习刺绣。一位年长的宫女正在耐心地教其他人针法，大家都很认真地学习。看到你后，她们热情地邀请你一起学习。",
            reward: { wisdom: 3, elegance: 2 },
            statChange: "才学+3，气质+2"
        },
        {
            event: "遇到宫女讨论宫中趣事",
            description: "几个宫女正在讨论宫中的趣事，她们有说有笑，气氛轻松愉快。你在一旁聆听，了解了不少宫中的八卦和趣闻，增长了见识。",
            reward: { wisdom: 2, energy: 2 },
            statChange: "才学+2，体力+2"
        },
        {
            event: "遇到宫女互相帮助整理衣物",
            description: "你看到几个宫女正在互相帮助整理衣物，她们一边整理一边聊天，动作熟练而有序。这种互相帮助的氛围让你感到温暖。",
            reward: { wisdom: 2, energy: 1 },
            statChange: "才学+2，体力+1"
        },
        {
            event: "遇到宫女练习礼仪",
            description: "几个宫女正在练习宫廷礼仪，一位经验丰富的宫女在指导她们。你在一旁观看，学到了不少礼仪知识。",
            reward: { wisdom: 3, elegance: 2 },
            statChange: "才学+3，气质+2"
        },
        {
            event: "遇到宫女互相安慰",
            description: "你看到两个宫女正在互相安慰，其中一人因为被主子责骂而哭泣，另一人温柔地抱着她，轻声安慰。这种姐妹情深让你感到温暖。",
            reward: { wisdom: 2, elegance: 1 },
            statChange: "才学+2，气质+1"
        },
        {
            event: "遇到宫女分享食物",
            description: "几个宫女围坐在一起分享食物，她们互相夹菜，说说笑笑，气氛十分融洽。看到你后，她们热情地邀请你一起用餐。",
            reward: { energy: 5, wisdom: 1 },
            statChange: "体力+5，才学+1"
        },
        {
            event: "遇到宫女互相梳头",
            description: "你看到两个宫女正在互相梳头，她们的动作轻柔而亲密，一边梳头一边聊天，脸上带着满足的笑容。这种日常的温馨让你感到放松。",
            reward: { elegance: 2, wisdom: 1 },
            statChange: "气质+2，才学+1"
        },
        {
            event: "遇到宫女互相按摩",
            description: "几个宫女正在互相按摩，她们的手法熟练，一边按摩一边聊天。看到你后，她们热情地邀请你一起享受这难得的放松时光。",
            reward: { energy: 3, wisdom: 1 },
            statChange: "体力+3，才学+1"
        },
        {
            event: "遇到宫女分享秘密",
            description: "你无意中听到几个宫女在分享彼此的秘密，她们的声音很低，但你能感受到她们之间的信任。这种亲密的关系让你感到羡慕。",
            reward: { wisdom: 3, fame: 1 },
            statChange: "才学+3，声望+1"
        },
        {
            event: "遇到宫女一起做针线活",
            description: "几个宫女正坐在一起做针线活，她们一边工作一边聊天，气氛轻松。看到你后，她们邀请你一起加入，你学到了不少针线技巧。",
            reward: { wisdom: 2, energy: 2 },
            statChange: "才学+2，体力+2"
        },
        {
            event: "遇到宫女互相传授经验",
            description: "一位经验丰富的宫女正在向其他宫女传授在宫中生存的经验，大家都很认真地听讲。你在一旁学习，学到了不少有用的知识。",
            reward: { wisdom: 3, fame: 1 },
            statChange: "才学+3，声望+1"
        },
        {
            event: "遇到宫女一起休息聊天",
            description: "几个宫女正坐在一起休息聊天，她们谈论着日常生活中的琐事，气氛轻松愉快。你加入她们的聊天，感到心情舒畅。",
            reward: { energy: 3, wisdom: 1 },
            statChange: "体力+3，才学+1"
        },
        {
            event: "遇到宫女互相帮助洗衣服",
            description: "几个宫女正在互相帮助洗衣服，她们一边工作一边聊天，互相帮助，气氛融洽。你也被这种互助的精神所感动。",
            reward: { wisdom: 2, energy: 1 },
            statChange: "才学+2，体力+1"
        },
        {
            event: "遇到宫女一起准备晚餐",
            description: "几个宫女正在一起准备晚餐，她们分工合作，有说有笑。看到你后，她们邀请你一起帮忙，你学到了不少烹饪技巧。",
            reward: { wisdom: 2, energy: 2 },
            statChange: "才学+2，体力+2"
        },
        {
            event: "遇到宫女互相分享故事",
            description: "几个宫女正坐在一起分享各自的故事，她们讲述着家乡的趣事和入宫的经历。你在一旁聆听，了解了不少有趣的故事。",
            reward: { wisdom: 2, energy: 2 },
            statChange: "才学+2，体力+2"
        },
        {
            event: "遇到宫女磨豆腐",
            description: "你走进下人房，看到几个宫女正在角落里窃窃私语，其中一人正在给另一人按摩肩膀，动作暧昧。她们看到你后立刻分开，脸上带着羞涩的笑容。",
            reward: { elegance: 2, wisdom: 2 },
            statChange: "气质+2，才学+2"
        },
        {
            event: "遇到太监宫女对食",
            description: "你发现一对太监和宫女正在角落里偷偷对食，他们互相喂食，眼神中充满了温柔。看到你后，他们有些慌张，但很快恢复了平静。",
            reward: { wisdom: 1, fame: 1 },
            statChange: "才学+1，声望+1"
        },
        {
            event: "遇到太监同性恋",
            description: "你无意中看到两个太监在角落里亲密交谈，他们的举止明显超出了普通朋友的关系。其中一人轻抚着另一人的手，眼神中充满了爱意。",
            reward: { wisdom: 3, fame: 1 },
            statChange: "才学+3，声望+1"
        }
    ];
    
    // 对食剧情四分支模板（加入/观战/偷窥/逃离，共二十余条）
    var duishiJoin = [
        "你轻声走近，他们先是一惊，见你并无恶意便邀你同坐。你们三人围坐一处，分享着简单的食物与悄悄话，气氛竟有几分温馨。",
        "你大方上前打招呼，那对食的两人见是你，松了口气，邀你一起用些点心。你陪着说了一会儿话，彼此心照不宣。",
        "你走过去坐下，他们犹豫后接纳了你。你们像老友一般分食、说笑，在这冷清的宫闱里竟生出一丝暖意。",
        "你加入他们的小圈子，太监与宫女为你让出位置。你们低声交谈，分享着各自在宫中的苦与乐。",
        "你凑过去与他们同食，起初有些尴尬，很快便自然起来。三人一起用饭、闲聊，仿佛暂时忘却了身份。",
        "你被他们拉入席间，一起吃着简单的饭菜。他们对你并无防备，你也守口如瓶，这段时光格外安宁。"
    ];
    var duishiSpectate = [
        "你退到一旁，既不打扰也不离开，静静看着他们互相夹菜、低语。他们偶尔朝你点头致意，你则报以理解的微笑。",
        "你站在不远的阴影里旁观，他们继续对食，偶尔相视而笑。你心中五味杂陈，却选择默默注视。",
        "你找了个角落坐下，远远看着那一对。他们举止亲密却克制，你只是看着，没有出声。",
        "你倚在门边，看着他们互相喂食、说悄悄话。他们没有驱赶你，你也没有靠近，就这样保持距离地观望着。",
        "你站在窗边，透过半掩的窗看他们用饭。两人举止温柔，你静静看着，心中若有所思。",
        "你留在原地，与他们保持一段距离。他们继续对食，你则在一旁安静地看着，仿佛在看一幅画。"
    ];
    var duishiPeek = [
        "你躲在帘后，透过缝隙偷看他们互相喂食、耳语。他们并未发现你，你屏住呼吸，心中既紧张又有些说不清的情绪。",
        "你悄悄藏在柜子后，窥见他们亲密对坐、分食一碟小菜。你不敢出声，只看了一会儿便悄悄退开。",
        "你蹲在窗外，透过窗纸的破洞偷看。两人正互相夹菜，神情温柔，你看了片刻后轻手轻脚地离开。",
        "你躲在屏风后，听着他们低声说笑、碗筷轻响。你忍不住探头看了一眼，又赶紧缩回，心跳如鼓。",
        "你藏在门后，从门缝里偷看他们对食。他们举止亲昵却含蓄，你窥见了一角宫中的隐秘温情。",
        "你伏在梁上（或暗处），偷偷观察他们。他们互相喂食、擦嘴，你屏息凝神，生怕被发现。"
    ];
    var duishiEscape = [
        "你装作什么都没看见，转身轻手轻脚地离开。他们并未叫住你，你快步走出下人房，长舒一口气。",
        "你心中一紧，立刻低头转身，悄悄退了出去。直到走出老远，你才敢回头看一眼，庆幸没有惹上麻烦。",
        "你迅速移开视线，装作路过，快步离开这是非之地。身后没有脚步声追来，你悬着的心终于放下。",
        "你不想卷入任何是非，当即轻步退出，头也不回。出了门你才放慢脚步，心中默念多一事不如少一事。",
        "你见势不妙，悄悄退到门边，然后快步离开。他们似乎并未留意你的离去，你顺利脱身。",
        "你屏住呼吸，一步步退向门口，然后转身快步离开。直到回到自己的住处，你才觉得安全。"
    ];
    var modoufuJoin = [
        "你轻声走近，她们先是一惊，见你并无恶意便邀你同坐。你们围坐一处，彼此贴近，气氛竟有几分暧昧温馨。",
        "你大方上前，那磨豆腐的宫女们见是你，松了口气，邀你一起。你们像姐妹一般亲近，在这冷清的宫闱里竟生出一丝暖意。",
        "你走过去坐下，她们犹豫后接纳了你。你们低声交谈、肢体轻触，仿佛暂时忘却了身份。"
    ];
    var modoufuSpectate = [
        "你退到一旁，既不打扰也不离开，静静看着她们互相依偎、低语。她们偶尔朝你点头，你则报以理解的微笑。",
        "你站在不远的阴影里旁观，她们继续磨豆腐，偶尔相视而笑。你心中五味杂陈，却选择默默注视。"
    ];
    var modoufuPeek = [
        "你躲在帘后，透过缝隙偷看她们亲密依偎、耳语。她们并未发现你，你屏住呼吸，心中既紧张又有些说不清的情绪。",
        "你藏在门后，从门缝里偷看她们磨豆腐。她们举止亲昵却含蓄，你窥见了一角宫中的隐秘温情。"
    ];
    var modoufuEscape = [
        "你装作什么都没看见，转身轻手轻脚地离开。她们并未叫住你，你快步走出下人房，长舒一口气。",
        "你不想卷入任何是非，当即轻步退出，头也不回。出了门你才放慢脚步，心中默念多一事不如少一事。"
    ];
    
    // 随机选择一个模板
    const template = templates[Math.floor(Math.random() * templates.length)];
    
    // 应用奖励
    if (template.reward.charm) gameState.player.stats.charm += template.reward.charm;
    if (template.reward.elegance) gameState.player.stats.elegance += template.reward.elegance;
    if (template.reward.attraction) gameState.player.stats.attraction += template.reward.attraction;
    if (template.reward.wisdom) gameState.player.stats.wisdom += template.reward.wisdom;
    if (template.reward.fame) gameState.player.stats.fame += template.reward.fame;
    if (template.reward.energy) gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + template.reward.energy);
    
    const rewards = {};
    if (template.reward.charm) rewards.charm = template.reward.charm;
    if (template.reward.elegance) rewards.elegance = template.reward.elegance;
    if (template.reward.attraction) rewards.attraction = template.reward.attraction;
    if (template.reward.wisdom) rewards.wisdom = template.reward.wisdom;
    if (template.reward.fame) rewards.fame = template.reward.fame;
    if (template.reward.energy) rewards.energy = template.reward.energy;
    
    recordTodayVisit("下人房");
    
    // 对食或磨豆腐剧情：先弹窗选择加入/观战/偷窥/逃离，再显示对应分支剧情
    if (template.event === "遇到太监宫女对食") {
        var branches = {
            join: duishiJoin[Math.floor(Math.random() * duishiJoin.length)],
            spectate: duishiSpectate[Math.floor(Math.random() * duishiSpectate.length)],
            peek: duishiPeek[Math.floor(Math.random() * duishiPeek.length)],
            escape: duishiEscape[Math.floor(Math.random() * duishiEscape.length)]
        };
        showDuishiChoiceModal(branches, { locationName: "下人房", eventType: template.event, person: null, rewards: rewards });
    } else if (template.event === "遇到宫女磨豆腐") {
        var branches = {
            join: modoufuJoin[Math.floor(Math.random() * modoufuJoin.length)],
            spectate: modoufuSpectate[Math.floor(Math.random() * modoufuSpectate.length)],
            peek: modoufuPeek[Math.floor(Math.random() * modoufuPeek.length)],
            escape: modoufuEscape[Math.floor(Math.random() * modoufuEscape.length)]
        };
        showDuishiChoiceModal(branches, { locationName: "下人房", eventType: template.event, person: null, rewards: rewards });
    } else {
        showLocationEventModal({
            locationName: "下人房",
            story: template.description,
            eventType: template.event || "普通事件",
            person: null,
            rewards: rewards
        });
    }
    
    updateDashboard();
}

/**
 * 埋线展开模板（模板模式，当某地点存在埋线时使用）
 */
const plotThreadExpandTemplates = [
    {
        description: "你再次来到此地，此前埋下的线索终于有了回应。一位神秘人物主动找上你，将之前的谜团一一揭开，你们相谈甚欢，彼此留下了深刻印象。",
        reward: { wisdom: 2, fame: 2 },
        statChange: "才学+2，声望+2",
        person: { name: "柳如烟", role: "神秘女子", gender: "女", personality: "她性情淡泊，不喜张扬，平日里深居简出，却对世事洞若观火。待人温和有礼，言谈间透着几分超脱与从容，仿佛对世间纷扰早已看透。偶尔会露出些许沧桑，似有说不尽的故事藏在心底。", appearance: "她身着一袭素色长衫，乌发如云，眉眼间带着几分清冷与疏离。肌肤白皙如玉，举手投足间自有一番风韵。眼神清澈而深邃，仿佛能看穿人心，却又不会让人感到压迫。周身气息宁静，宛如一幅淡雅的水墨画。", background: "她本是江南书香门第的千金，因家中变故流落京城，辗转于宫廷与市井之间。曾在太医院学过几年医术，后因机缘巧合结识不少宫中贵人，对宫廷内幕颇为了解。如今隐姓埋名，以旁观者身份游走于各方势力之间，心中自有取舍与坚持。" }
    },
    {
        description: "你回到此地，发现之前的线索已然发酵。一位此前仅有耳闻的人物出现在你面前，将事情的来龙去脉娓娓道来，你与他/她建立了新的联系。",
        reward: { charm: 2, wisdom: 1 },
        statChange: "容貌+2，才学+1",
        person: { name: "萧景行", role: "王府幕僚", gender: "男", personality: "他为人沉稳内敛，善于察言观色，在王府中颇受器重。言谈谨慎却不失锋芒，对时局有着独到见解。待人接物彬彬有礼，却始终保持着恰当的距离感。内心深处对权势有着清醒的认知，懂得在夹缝中求生存。", appearance: "他约三十许年纪，眉目俊朗，身着青灰色长袍，头戴方巾。举止儒雅得体，步履稳健。双目有神，谈笑间透出几分精明与老练。手指修长，执卷时自有一股书卷气，令人心生敬意。", background: "他出身寒门，自幼刻苦攻读，后中举入京，辗转成为王府幕僚。在王府多年，见证了无数朝堂风云与宫廷暗斗，练就了一身察言观色、权衡利弊的本事。虽身处漩涡中心，却始终保持着内心的清明与底线。" }
    },
    {
        description: "你故地重游，意外遇见了此前线索中的关键人物。他/她对你颇为信任，将一些隐秘之事和盘托出，你们的关系有了实质性的进展。",
        reward: { fame: 2, wisdom: 1 },
        statChange: "声望+2，才学+1",
        person: { name: "慕容婉", role: "宫中女官", gender: "女", personality: "她处事圆融，在宫中左右逢源，却从不轻易站队。外表温婉，内心坚韧，面对困境总能想出化解之法。对后辈多有提携，在宫中人缘颇佳。行事谨慎却不失胆识，关键时刻能挺身而出。", appearance: "她年约二十五六，眉如远山，目若秋水。常着宫装，仪态端庄大方。笑容温婉得体，说话时声音轻柔却字字清晰。举止间透着宫中女官特有的从容与得体，让人如沐春风。", background: "她自幼入宫，从最低等的宫女做起，凭借聪慧与努力一步步升为女官。在宫中浸淫多年，熟知各类规矩与人情世故。曾经历过宫变与风波，却总能化险为夷，如今在宫中颇有威望。" }
    }
];

/**
 * 生成地图事件（固定模板模式）
 */
function generateLocationEventWithTemplate(locationName, actionType, statType = null, statValue = null, chance = null) {
    if (!gameState.plotThreads) gameState.plotThreads = {};
    const plotThreadToExpand = gameState.plotThreads[locationName];
    if (plotThreadToExpand && plotThreadExpandTemplates.length > 0) {
        const t = plotThreadExpandTemplates[Math.floor(Math.random() * plotThreadExpandTemplates.length)];
        if (t.reward) {
            if (t.reward.money) gameState.player.stats.money += t.reward.money;
            if (t.reward.fame) gameState.player.stats.fame += t.reward.fame;
            if (t.reward.charm) gameState.player.stats.charm = Math.min(gameState.player.stats.maxCharm || 100, gameState.player.stats.charm + t.reward.charm);
            if (t.reward.wisdom) gameState.player.stats.wisdom = Math.min(gameState.player.stats.maxWisdom || 100, gameState.player.stats.wisdom + t.reward.wisdom);
        }
        if (t.person && !gameState.npcs.find(n => n.name === t.person.name && n.role === t.person.role)) {
            gameState.npcs.push({
                id: Date.now(),
                name: t.person.name,
                gender: t.person.gender || "女",
                role: t.person.role || "未知",
                personality: t.person.personality || "",
                appearance: t.person.appearance || "",
                background: t.person.background || "",
                affection: 0, metPlace: locationName, history: [], canSendEmoji: true, emojis: []
            });
            showTipModal(t.person.name + ' 已加入人脉。', '埋线展开');
        }
        delete gameState.plotThreads[locationName];
        recordTodayVisit(locationName);
        if (!gameState.player.choices) gameState.player.choices = [];
        gameState.player.choices.push({ id: Date.now() + Math.random(), title: locationName + ' - 埋线展开', choice: t.description, date: new Date().toISOString(), locationName });
        var prefix = (gameState._ctxSick ? '【病体沉重】' : '') + (gameState._ctxBadMood ? '【心情极差】' : '') + (gameState._ctxChilblains ? '【手干裂流血】' : '');
        showLocationEventModal({ locationName, story: prefix + (t.description || ''), eventType: '埋线展开', person: t.person || null, rewards: t.reward || {} });
        updateDashboard();
        return;
    }
    const locationTemplates = {
        "浣衣局": {
            work: [
                {
                    description: "你在浣衣局辛勤劳作，洗了一整天的衣服。虽然累得腰酸背痛，但看到整齐干净的衣服，心中充满了成就感。管事嬷嬷看到你的努力，对你点了点头。",
                    reward: { money: 5, fame: 1, energy: 2 },
                    statChange: "银两+5，声望+1，体力+2"
                },
                {
                    description: "你在浣衣局工作时，不小心打翻了水桶，弄湿了旁边的宫女。她虽然有些生气，但看到你诚恳道歉的样子，还是原谅了你。你们一起重新洗衣服，反而成了朋友。",
                    reward: { money: 5, fame: 1, wisdom: 1 },
                    statChange: "银两+5，声望+1，才学+1"
                },
                {
                    description: "你在浣衣局洗衣服时，听到几个宫女在讨论宫中的八卦。你一边工作一边听，了解了不少宫中的人情世故，增长了见识。",
                    reward: { money: 5, fame: 1, wisdom: 1 },
                    statChange: "银两+5，声望+1，才学+1"
                },
                {
                    description: "你在浣衣局洗衣时，无意间在某件衣裳的夹层里摸到一张叠得极小的纸条，上面似乎写着什么，但字迹已模糊难辨。你心中一动，悄悄收好，决定日后有机会再来查探。",
                    reward: { money: 5, wisdom: 2 },
                    statChange: "银两+5，才学+2",
                    plotThread: true
                }
            ],
            explore: [
                {
                    description: "你在浣衣局闲逛时，看到几个宫女正在互相帮忙洗衣服，她们有说有笑，气氛融洽。你也被这种温馨的氛围感染了。",
                    reward: { wisdom: 2, energy: 1 },
                    statChange: "才学+2，体力+1"
                },
                {
                    description: "你在浣衣局遇到了一个老宫女，她正在教新来的宫女如何更好地洗衣服。你在一旁学习，学到了不少技巧。",
                    reward: { wisdom: 2, energy: 1 },
                    statChange: "才学+2，体力+1"
                }
            ]
        },
        "御膳房": {
            train: [
                {
                    description: "你在御膳房偷偷学习厨艺，看到大厨正在制作精美的点心。你仔细观察，学到了不少技巧，厨艺有所提升。",
                    reward: { wisdom: 2, energy: 1 },
                    statChange: "才学+2，体力+1"
                },
                {
                    description: "你在御膳房学习时，不小心打翻了调料罐。大厨虽然有些生气，但还是耐心地教你如何正确使用调料，你受益匪浅。",
                    reward: { wisdom: 2, energy: 1 },
                    statChange: "才学+2，体力+1"
                },
                {
                    description: "你在御膳房看到几个宫女正在互相分享做菜心得，你也加入了讨论。大家都很热情，你学到了不少新知识。",
                    reward: { wisdom: 2, energy: 2 },
                    statChange: "才学+2，体力+2"
                }
            ],
            explore: [
                {
                    description: "你在御膳房闲逛时，闻到阵阵香味。大厨正在制作精美的菜肴，你在一旁观看，学到了不少烹饪技巧。",
                    reward: { wisdom: 1, energy: 1 },
                    statChange: "才学+1，体力+1"
                },
                {
                    description: "你在御膳房遇到了一个正在偷吃的宫女，她看到你后有些慌张。你笑了笑，表示理解，她感激地分给你一些点心。",
                    reward: { wisdom: 1, energy: 3 },
                    statChange: "才学+1，体力+3"
                }
            ]
        },
        "御花园": {
            explore: [
                {
                    description: "你在御花园中漫步，欣赏着美丽的花朵。突然听到有人在吟诗，你循声而去，看到一位才子在花园中作诗。你被他的才华所吸引。",
                    reward: { attraction: 2, wisdom: 2 },
                    statChange: "魅力+2，才学+2"
                },
                {
                    description: "你在御花园中遇到了几位贵人在赏花，她们正在讨论诗词。你在一旁聆听，学到了不少文学知识。",
                    reward: { wisdom: 2, attraction: 1 },
                    statChange: "才学+2，魅力+1"
                },
                {
                    description: "你在御花园中看到一对情侣正在私会，他们看到你后有些慌张。你装作没看见，继续往前走，心中却有些羡慕。",
                    reward: { attraction: 2, wisdom: 1 },
                    statChange: "魅力+2，才学+1"
                },
                {
                    description: "你在御花园中遇到了一个正在练剑的侍卫，他的剑法精湛。你在一旁观看，学到了不少武艺技巧。",
                    reward: { martial: 2, wisdom: 1 },
                    statChange: "武艺+2，才学+1"
                },
                {
                    description: "你在御花园赏花时，一位贵人路过，对你的仪态颇为赏识，随手赏了你一块玉佩。",
                    reward: { attraction: 1, items: ["玉佩"] },
                    statChange: "魅力+1，获得玉佩"
                },
                {
                    description: "你在御花园一处偏僻角落，隐约听到有人在低声商议什么。你屏息细听，只捕捉到只言片语，似乎与某位贵人有关。你不敢久留，悄然离开，心中却埋下了疑问。",
                    reward: { wisdom: 2, cunning: 1 },
                    statChange: "才学+2，心计+1",
                    plotThread: true
                }
            ]
        },
        "太医院": {
            explore: [
                {
                    description: "你在太医院中看到太医正在为病人诊治，你在一旁学习，学到了不少医术知识。太医看到你认真学习的样子，对你点了点头。",
                    reward: { wisdom: 2, energy: 1 },
                    statChange: "才学+2，体力+1"
                },
                {
                    description: "你在太医院中遇到了一个正在学习配药的医女，她正在研究药方。你和她一起讨论，学到了不少医药知识。",
                    reward: { wisdom: 2, energy: 2 },
                    statChange: "才学+2，体力+2"
                },
                {
                    description: "你在太医院中看到几个宫女正在互相治疗，她们互相帮助，气氛温馨。你也被这种互助的精神所感动。",
                    reward: { wisdom: 2, energy: 1 },
                    statChange: "才学+2，体力+1"
                },
                {
                    description: "你在太医院整理药材时，发现某味药材的标签与内容不符，似乎有人刻意调换。你心中起疑，却不敢声张，只暗暗记下此事，打算日后再来查证。",
                    reward: { wisdom: 2, cunning: 2 },
                    statChange: "才学+2，心计+2",
                    plotThread: true
                }
            ]
        },
        "练武场": {
            train: [
                {
                    description: "你在练武场中刻苦训练，看到侍卫们正在操练。你在一旁学习，武艺有所提升。",
                    reward: { martial: 3, energy: 1 },
                    statChange: "武艺+3，体力+1"
                },
                {
                    description: "你在练武场中遇到了一个正在练剑的侍卫，他的剑法精湛。你向他请教，学到了不少武艺技巧。",
                    reward: { martial: 3, energy: 1 },
                    statChange: "武艺+3，体力+1"
                },
                {
                    description: "你在练武场中看到几个侍卫正在互相切磋，你在一旁观看，学到了不少战斗技巧。",
                    reward: { martial: 3, wisdom: 1 },
                    statChange: "武艺+3，才学+1"
                }
            ],
            explore: [
                {
                    description: "你在练武场中闲逛，看到侍卫们正在操练。你在一旁观看，学到了不少武艺技巧。",
                    reward: { martial: 2, energy: 1 },
                    statChange: "武艺+2，体力+1"
                },
                {
                    description: "你在练武场中遇到了一个正在休息的侍卫，他正在擦拭武器。你和他聊天，了解了不少军中趣事。",
                    reward: { martial: 1, wisdom: 2 },
                    statChange: "武艺+1，才学+2"
                }
            ]
        },
        "御书房": {
            explore: [
                {
                    description: "你在御书房中看到皇上正在批阅奏折，你在一旁侍候。皇上偶尔会问你一些问题，你谨慎地回答，展现了自己的才学。",
                    reward: { wisdom: 2, fame: 2 },
                    statChange: "才学+2，声望+2"
                },
                {
                    description: "你在御书房中遇到了一个正在整理书籍的太监，他正在分类整理。你和他一起工作，学到了不少知识。",
                    reward: { wisdom: 2, fame: 1 },
                    statChange: "才学+2，声望+1"
                },
                {
                    description: "你在御书房中看到几位大臣正在讨论国事，你在一旁聆听，学到了不少政治知识。",
                    reward: { wisdom: 2, fame: 1 },
                    statChange: "才学+2，声望+1"
                }
            ]
        },
        "长安街": {
            explore: [
                {
                    description: "你在长安街上闲逛，看到街上人来人往，热闹非凡。你遇到了一个卖艺的艺人，他的表演很精彩，你给了他一些银两。",
                    reward: { fame: 1, money: -2 },
                    statChange: "声望+1，银两-2"
                },
                {
                    description: "你在长安街上遇到了一个正在卖小吃的商贩，你买了一些小吃，味道很不错。商贩很热情，和你聊了不少街上的趣事。",
                    reward: { wisdom: 1, energy: 3 },
                    statChange: "才学+1，体力+3"
                },
                {
                    description: "你在长安街上看到几个书生正在讨论诗词，你在一旁聆听，学到了不少文学知识。",
                    reward: { wisdom: 2, fame: 1 },
                    statChange: "才学+2，声望+1"
                },
                {
                    description: "你在长安街上遇到了一个正在表演杂技的艺人，他的表演很精彩，吸引了不少人围观。你也被他的技艺所折服。",
                    reward: { wisdom: 2, energy: 1 },
                    statChange: "才学+2，体力+1"
                }
            ]
        },
        "青楼": {
            explore: [
                {
                    description: "你走进青楼，看到里面歌舞升平，热闹非凡。你遇到了一个正在弹琴的艺妓，她的琴艺精湛，你被她的才华所吸引。",
                    reward: { attraction: 3, wisdom: 2 },
                    statChange: "魅力+3，才学+2"
                },
                {
                    description: "你在青楼中遇到了一个正在跳舞的舞女，她的舞姿优美，你在一旁观看，学到了不少舞蹈技巧。",
                    reward: { attraction: 2, wisdom: 1 },
                    statChange: "魅力+2，才学+1"
                },
                {
                    description: "你在青楼中听到几个客人在讨论朝中大事，你在一旁聆听，了解了不少政治内幕。",
                    reward: { wisdom: 2, fame: 1 },
                    statChange: "才学+2，声望+1"
                },
                {
                    description: "你在青楼中遇到了一个正在陪酒的艺妓，她看到你后主动过来和你聊天。你们聊得很投机，你了解了不少青楼中的趣事。",
                    reward: { attraction: 3, wisdom: 1 },
                    statChange: "魅力+3，才学+1"
                }
            ]
        },
        "王府": {
            explore: [
                {
                    description: "你走进王府，看到里面富丽堂皇，气派非凡。你遇到了一个正在巡视的管家，他和你聊了不少王府中的规矩。",
                    reward: { wisdom: 2, fame: 1 },
                    statChange: "才学+2，声望+1"
                },
                {
                    description: "你在王府中遇到了一个正在练字的公子，他的字写得很好。你在一旁观看，学到了不少书法技巧。",
                    reward: { wisdom: 2, elegance: 1 },
                    statChange: "才学+2，气质+1"
                },
                {
                    description: "你在王府中看到几位贵妇正在讨论诗词，你在一旁聆听，学到了不少文学知识。",
                    reward: { wisdom: 2, elegance: 2 },
                    statChange: "才学+2，气质+2"
                },
                {
                    description: "你在王府中遇到了一个正在下棋的王爷，他的棋艺精湛。你在一旁观看，学到了不少棋艺技巧。",
                    reward: { wisdom: 2, fame: 1 },
                    statChange: "才学+2，声望+1"
                },
                {
                    description: "王府的王妃见你举止得体，十分喜爱，命人赏了你一套素色宫装。",
                    reward: { elegance: 2, clothes: 2 },
                    statChange: "气质+2，获得素色宫装"
                }
            ]
        }
    };
    
    const templates = locationTemplates[locationName]?.[actionType];
    // 探索类地点：30% 概率触发真人偶遇（出人物），70% 使用模板描述
    if (actionType === "explore" && (templates && templates.length > 0) && Math.random() < 0.3) {
        triggerEncounter(locationName);
        updateDashboard();
        return;
    }
    if (!templates || templates.length === 0) {
        // 如果没有模板，使用默认行为
        const loc = LOCATIONS[locationName];
        if (actionType === "work") {
            gameState.player.stats.money += loc?.reward?.money || 0;
            gameState.player.stats.fame += loc?.reward?.fame || 0;
            alert(`在${locationName}劳作，获得银两+${loc?.reward?.money || 0}，声望+${loc?.reward?.fame || 0}`);
        } else if (actionType === "train") {
            const maxStat = gameState.player.stats[`max${statType.charAt(0).toUpperCase() + statType.slice(1)}`] || 100;
            const newVal = Math.min(maxStat, gameState.player.stats[statType] + statValue);
            const actualGain = newVal - gameState.player.stats[statType];
            gameState.player.stats[statType] = newVal;
            alert(`在${locationName}学习，${statType === 'wisdom' ? '才学' : statType === 'martial' ? '武艺' : statType} +${actualGain}`);
        } else if (actionType === "explore") {
            const roll = Math.random();
            if (roll < (chance || 0.5)) {
                triggerEncounter(locationName);
            } else {
                alert(`在${locationName}闲逛了一圈，什么也没发生，心情舒畅。`);
                gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + 2);
            }
        }
        updateDashboard();
        return;
    }
    
    // 随机选择一个模板
    const template = templates[Math.floor(Math.random() * templates.length)];
    
    // 埋线：标记为伏笔，再次访问该地点时展开
    if (template.plotThread) {
        gameState.plotThreads[locationName] = { story: template.description, eventType: '埋线' };
    }
    
    // 应用奖励
    const trew = template.reward || {};
    if (trew.money) gameState.player.stats.money += trew.money;
    if (trew.fame) gameState.player.stats.fame += trew.fame;
    if (trew.charm) gameState.player.stats.charm = Math.min(gameState.player.stats.maxCharm || 100, gameState.player.stats.charm + trew.charm);
    if (trew.elegance) gameState.player.stats.elegance = Math.min(gameState.player.stats.maxElegance || 100, gameState.player.stats.elegance + trew.elegance);
    if (trew.attraction) gameState.player.stats.attraction = Math.min(gameState.player.stats.maxAttraction || 100, gameState.player.stats.attraction + trew.attraction);
    if (trew.wisdom) gameState.player.stats.wisdom = Math.min(gameState.player.stats.maxWisdom || 100, gameState.player.stats.wisdom + trew.wisdom);
    if (trew.martial) gameState.player.stats.martial = Math.min(gameState.player.stats.maxMartial || 100, gameState.player.stats.martial + trew.martial);
    if (trew.energy) gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + trew.energy);
    
    let skillExpGain = null;
    // 如果是训练类型，还要应用原始的训练奖励
    if (actionType === "train" && statType && statValue) {
        const maxStat = gameState.player.stats[`max${statType.charAt(0).toUpperCase() + statType.slice(1)}`] || 100;
        const newVal = Math.min(maxStat, gameState.player.stats[statType] + statValue);
        const actualGain = newVal - gameState.player.stats[statType];
        gameState.player.stats[statType] = newVal;
        
        // 增加技能经验（对应技能的剧情增加对应技能经验）
        if (statType === "music" || statType === "dance" || statType === "embroidery") {
            const skillId = "才艺精通";
            const skill = gameState.player.skills[skillId] || { level: 0, exp: 0, mastery: 0 };
            const expAdd = statValue * 2;
            skill.exp += expAdd;
            skill.mastery += statValue;
            gameState.player.skills[skillId] = skill;
            skillExpGain = { skillName: "才艺精通", exp: expAdd };
        } else if (statType === "wisdom") {
            const skillId = "心计谋略";
            const skill = gameState.player.skills[skillId] || { level: 0, exp: 0, mastery: 0 };
            const expAdd = statValue * 2;
            skill.exp += expAdd;
            skill.mastery += statValue;
            gameState.player.skills[skillId] = skill;
            skillExpGain = { skillName: "心计谋略", exp: expAdd };
        } else if (statType === "martial") {
            const skillId = "心计谋略";
            const skill = gameState.player.skills[skillId] || { level: 0, exp: 0, mastery: 0 };
            const expAdd = statValue * 2;
            skill.exp += expAdd;
            skill.mastery += statValue;
            gameState.player.skills[skillId] = skill;
            skillExpGain = { skillName: "心计谋略", exp: expAdd };
        }
    }
    
    // 如果是工作类型，还要应用原始的工作奖励
    if (actionType === "work") {
        const loc = LOCATIONS[locationName];
        if (loc && loc.reward) {
            gameState.player.stats.money += loc.reward.money || 0;
            gameState.player.stats.fame += loc.reward.fame || 0;
        }
    }
    
    // 模板剧情送物品/服装
    if (template.reward.items && Array.isArray(template.reward.items)) {
        template.reward.items.forEach(function(itemName) {
            if (itemName && typeof itemName === 'string') addItemToInventory(itemName.trim(), 1);
        });
    }
    if (template.reward.clothes && typeof template.reward.clothes === 'number') {
        const cloth = gameState.clothes && gameState.clothes.find(function(c) { return c.id === template.reward.clothes; });
        if (cloth && !cloth.owned) {
            cloth.owned = true;
            if (gameState.clothesCollection) gameState.clothesCollection.collected = (gameState.clothesCollection.collected || 1) + 1;
        }
    }
    
    // 显示结果（使用自定义弹窗）
    const rewards = {};
    if (template.reward.money) rewards.money = template.reward.money;
    if (template.reward.fame) rewards.fame = template.reward.fame;
    if (template.reward.charm) rewards.charm = template.reward.charm;
    if (template.reward.elegance) rewards.elegance = template.reward.elegance;
    if (template.reward.attraction) rewards.attraction = template.reward.attraction;
    if (template.reward.wisdom) rewards.wisdom = template.reward.wisdom;
    if (template.reward.martial) rewards.martial = template.reward.martial;
    if (template.reward.energy) rewards.energy = template.reward.energy;
    if (template.reward.items) rewards.items = template.reward.items;
    if (template.reward.clothes) rewards.clothes = template.reward.clothes;
    
    recordTodayVisit(locationName);
    var storyPrefix = (gameState._ctxSick ? '【病体沉重】' : '') + (gameState._ctxBadMood ? '【心情极差】' : '') + (gameState._ctxChilblains ? '【手干裂流血】' : '');
    showLocationEventModal({
        locationName: locationName,
        story: storyPrefix + (template.description || ''),
        eventType: template.event || "普通事件",
        person: null,
        rewards: rewards,
        skillExpGain: skillExpGain
    });
    
    updateDashboard();
}

/**
 * 生成地图事件（API调用模式）
 */
async function generateLocationEventWithAPI(locationName, actionType, statType = null, chance = null) {
    const stateKey = `location_${locationName}_${actionType}`;
    const loc = LOCATIONS[locationName];
    const cost = (loc && typeof loc.cost === 'number') ? loc.cost : 0;
    
    if (apiCallingState.locationEvents[stateKey]) {
        gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + cost);
        showTipModal(`正在生成${locationName}的事件，请稍候...`, "提示");
        updateDashboard();
        return;
    }
    
    if (!settings.apiKey) {
        gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + cost);
        showErrorModal("请先在设置中配置API Key才能使用API调用模式。");
        updateDashboard();
        return;
    }
    
    apiCallingState.locationEvents[stateKey] = true;
    
    // 更新地图上的状态显示
    const statusId = `status-${locationName.replace(/\s/g, '-')}`;
    const statusEl = document.getElementById(statusId);
    if (statusEl) {
        statusEl.textContent = ' (正在调用API中)';
    }
    
    // 随机决定是否遇到同事（30%概率）
    const hasColleague = Math.random() < 0.3;
    
    // 根据地图和行动类型生成多样化的剧情类型池（每次随机选取一类，避免剧情单一）
    const locationEventPools = {
        "浣衣局": ["洗衣时发现暗藏的信物", "与管事嬷嬷发生冲突或得到赏识", "宫女之间因琐事争执", "帮忙新来宫女熟悉流程", "偷听到关于某位主子的八卦", "发现某件衣裳上的秘密污渍", "冬日冷水洗衣遭人刁难", "夏季闷热中有人中暑"],
        "御膳房": ["偷学某道御膳的做法", "误打碎珍贵器皿", "结识一位神秘老厨", "发现有人偷拿食材", "参与紧急宴席的备菜", "学做点心时得到指点", "目睹御厨之间的派系之争", "尝到从未吃过的名菜"],
        "御花园": ["巧遇某位贵人并产生交集", "发现一处罕有人知的角落", "赏花时卷入他人纠纷", "偶遇侍卫或太监密谈", "季节特有的花事活动", "目睹一场小型诗会", "迷路后误入禁地边缘", "与同龄宫女结伴游园"],
        "太医院": ["旁观太医诊治疑难杂症", "帮忙煎药时学到配方", "遇到前来求医的某位主子", "发现药材被偷换的线索", "医女之间的师徒传承", "参与某次紧急救治", "学习辨别毒物与良药", "与某位太医产生争执"],
        "练武场": ["被侍卫误伤或误帮", "旁观一场精彩切磋", "偷学某套招式", "发现练武场的历史传说", "与某位将军或侍卫攀谈", "目睹军中纪律处罚", "参与后勤帮工（递水递兵器）", "发现暗藏的兵器或文书"],
        "御书房": ["被指派整理某批奏折", "偷听到朝堂密事", "与某位大臣或太监交锋", "发现书籍中的批注秘密", "侍候时目睹皇帝喜怒", "卷入书籍丢失事件", "学习某本禁书的内容", "与御前太监产生交集"],
        "长安街": ["偶遇故人或同乡", "卷入市井纠纷", "发现一家隐秘小店", "目睹官府抓人场面", "参与街头表演或围观", "遭遇扒手或得到路人相助", "听到民间对朝政的议论", "买到意外之物或受骗"],
        "青楼": ["偷听某位客人谈论朝政", "与某位艺妓私下交谈", "目睹一场激烈的争执", "发现青楼与权贵的秘密联络", "参与或旁观一场诗会", "遇到乔装出宫的熟人", "艺妓讲述身世或请求帮忙", "发现可疑人员进出"],
        "王府": ["被误认为某位丫鬟", "偷听到王爷与幕僚密议", "与王府公子或小姐产生交集", "发现王府的隐秘规矩", "卷入王府内部的派系", "目睹一场家宴或赏赐", "与王府管事发生冲突", "发现王府与宫中的联系"]
    };
    const pool = locationEventPools[locationName];
    const eventHints = pool ? pool.map((h, i) => `${i + 1}. ${h}`).join("\n   ") : `与${locationName}特色相关的多样化剧情`;
    const randomHintIndex = pool ? Math.floor(Math.random() * pool.length) : 0;
    const selectedHint = pool ? pool[randomHintIndex] : null;
    
    const seasons = ["春", "夏", "秋", "冬"];
    const timeNames = ["早晨", "中午", "傍晚"];
    const seasonHint = seasons[gameState.world.season] || "春";
    const timeHint = timeNames[gameState.world.timeOfDay] || "中午";
    
    var encounterableList = '';
    var encounterableNpcs = [];
    if (gameState.npcs && gameState.npcs.length) {
        encounterableNpcs = gameState.npcs.filter(function(n) {
            return !n.isChild && (n.encounterMaps || []).indexOf(locationName) >= 0;
        });
        if (encounterableNpcs.length) {
            encounterableList = encounterableNpcs.map(function(n) {
                var base = 'id:' + n.id + ' 姓名:' + (n.name || '') + ' 身份:' + (n.role || '') + ' 性格:' + (n.personality || '').substring(0, 80);
                var enc = (n.npcMemory || []).slice(-2).map(function(e) {
                    return (e.location || '') + ' ' + (e.date || '') + ' ' + (e.story || '').substring(0, 100);
                }).join('；');
                if (enc) base += ' 近期遭遇：' + enc;
                var lastChat = (n.history || []).slice(-1)[0];
                if (lastChat) {
                    var content = lastChat.replace(/\[\d{4}-\d{2}-\d{2}[^\]]+\]\s*/, '').substring(0, 80);
                    if (content) base += ' 与玩家近期对话：' + content;
                }
                return base;
            }).join('\n');
        }
    }
    
    // 埋线展开：该地点此前有埋线剧情，本次需展开并加入新角色
    if (!gameState.plotThreads) gameState.plotThreads = {};
    const plotThreadToExpand = gameState.plotThreads[locationName];
    
    // 近期剧情上下文（供连贯性引用）
    let recentContextBlock = '';
    const dailyStories = gameState.player.dailyStories || [];
    const choices = gameState.player.choices || [];
    if (dailyStories.length > 0 || choices.length > 0) {
        recentContextBlock = '\n【剧情连贯性参考】以下为近期剧情，本事件必须与之连贯承接、呼应或延续，禁止割裂：\n';
        if (dailyStories.length > 0) {
            const recentStories = dailyStories.slice(-2).map(s => (s.content || '').substring(0, 350)).join('\n---\n');
            recentContextBlock += `近期休息剧情：\n${recentStories}\n`;
        }
        if (choices.length > 0) {
            const recentChoices = choices.slice(-5).map(c => `【${c.locationName || '某地'}】${(c.choice || '').substring(0, 200)}`).join('\n');
            recentContextBlock += `近期踩地图剧情：\n${recentChoices}\n`;
        }
    }
    
    const systemPrompt = `
你是一个宫廷游戏的事件生成器。请根据以下背景设定，生成一个详细且具有${locationName}特色的剧情事件。
${getStylePresetPrompt()}${getAntiBaguguPrompt()}
背景设定：
- 朝代：${gameState.world.dynasty}
- 皇帝：${gameState.world.emperorDesc}
- 玩家角色（含属性、穿着、技能）：${getPlayerContextForAPI()}
- 地点：${locationName}
- 行动类型：${actionType === "work" ? "工作" : actionType === "train" ? "训练" : "探索"}
- 当前时节：${seasonHint}
- 当前时辰：${timeHint}
${gameState._ctxSick ? '\n【重要】当前玩家处于病倒状态，身体虚弱，剧情必须体现带病行动、力不从心或病情加重等。' : ''}
${gameState._ctxBadMood ? '\n【重要】当前玩家心情极差，剧情需体现情绪低落、易生冲突或行事消极等。' : ''}
${gameState._ctxChilblains ? '\n【重要】当前玩家双手冻疮、干裂流血，剧情必须体现手部伤痛、行动不便或他人关切等。' : ''}

【剧情多样性要求（核心）】
每次生成必须体现${locationName}的独特氛围与情节类型。禁止使用通用、模糊、可套用到任何地点的剧情。
本次需围绕以下某一类情节展开（可自由发挥细节，但必须紧扣${locationName}特色）：
   ${eventHints}
${selectedHint ? `\n建议重点参考：${selectedHint}（可在此基础上扩展创新，勿照搬）` : ""}

${plotThreadToExpand ? `\n【重要：埋线展开】此前在${locationName}发生过埋线剧情，本次访问必须展开该伏笔：\n${plotThreadToExpand.story || ''}\n\n要求：1) 本事件必须承接上述剧情进一步展开，形成完整发展；2) 必须返回 newNpcs 数组，将展开剧情中出场的新人物加入人脉，每人需 personality、appearance、background 各不少于200字。\n` : ''}
${encounterableList ? `【人脉角色可出场】以下人脉角色已开启「遇地图」中本地点，可在剧情中出场（至多选一名写入剧情）。名单中含该角色的近期遭遇与玩家近期对话，剧情需与这些记忆互通、承接或呼应。若使用其中某角色，请写出与该角色身份性格相符的剧情，并在返回JSON中增加 "involvedNpcId": 该角色id（数字）。剧情将记录为该角色的遭遇记忆。名单中身份为粗使宫女、二等宫女等低阶角色，也可能有冻疮或手干裂流血等状态，剧情可酌情体现。\n名单：\n${encounterableList}\n若未使用名单中角色，不要返回 involvedNpcId。\n` : ''}
${recentContextBlock}
重要要求：
1. 必须生成一个详细的剧情描述（不少于200字），剧情必须与${locationName}高度相关，体现该地点的独特性。禁止写“你在某地闲逛看到一些人”这类笼统内容。
2. ${encounterableList ? '可选择让上述人脉名单中的一名角色出场（此时返回 involvedNpcId），或' : ''}${hasColleague ? '必须' : '如果合适，可以'}生成一个遇到的人物角色（${hasColleague ? '必须生成，概率100%' : '30%概率'}），这个人物需要：
   - 详细的性格描述（不少于150字）
   - 详细的外貌描述（不少于150字）
   - 详细的背景设定（不少于200字）
   - 姓名、身份、性别等基本信息
3. eventType 必须是具体、有辨识度的事件类型名称，如"浣衣局发现信物"而非"探索"。
4. 若剧情涉及才艺（音律、舞蹈、刺绣）、侍寝、社交、心计谋略等，必须与上述「玩家技能等级」一致：等级高则表现娴熟，等级低则表现生疏或略过细节。
5. 若有「剧情连贯性参考」中近期休息或踩地图剧情，本事件必须与之连贯承接、呼应或延续，可发展伏笔或引出后续，禁止割裂。

请以JSON格式返回，格式如下：
{
  "story": "详细的剧情描述，不少于200字",
  "involvedNpcId": 可选，若剧情使用了上述人脉名单中的某角色则填该角色id（数字），否则不返回此字段,
  ${hasColleague ? `"person": {
    "name": "姓名",
    "role": "身份",
    "gender": "男/女",
    "personality": "详细的性格描述，不少于150字",
    "appearance": "详细的外貌描述，不少于150字",
    "background": "详细的背景设定，不少于200字"
  },` : ''}
  "eventType": "事件类型",
  "plotThread": 若本剧情为伏笔埋线（后续在同一地点再次访问时展开）则填 true，否则不返回此字段,
  ${plotThreadToExpand ? '"newNpcs": [{"name":"","role":"","gender":"男/女","personality":"不少于200字","appearance":"不少于200字","background":"不少于200字"}],' : ''}
  "rewards": {
    "money": 0,
    "fame": 0,
    "charm": 0,
    "wisdom": 0,
    "martial": 0,
    "energy": 0,
    "items": [],
    "clothes": null
  }
}
- items与clothes必须按剧情决定，禁止每次都给！仅在剧情合理时填写：
  * items: 仅当剧情中明确有「贵人赏赐、获赠、拾获、买到」等赠物情节时填，如["玉佩","香囊"]，否则必须为[]。
  * clothes: 仅当剧情中明确有「赏衣、获赐衣裳、获赠服饰」等情节时填服装ID(2-50)，否则必须为null。可送服装：2素色宫装,3锦绣华服,4凤袍,5青色素罗裙,6藕荷色襦裙,7月白色纱衣,8桃红对襟襦裙,9竹叶青褙子,10鸦青长衫,11湘妃色罗裳,12天水碧襦裙,13绛紫云纹衫,14茜色百褶裙,15鹅黄半臂,16石榴红襦裙,17碧玉纱衣,18海棠红大袖衫,19琥珀色锦袍,20丁香紫罗衣 等(id 2-50)。
- 绝大多数剧情不应送物品或服装，items多为[]，clothes多为null。
只返回JSON，不要其他文字。${hasColleague && !encounterableList ? '必须返回person对象。' : hasColleague && encounterableList ? '若未使用人脉角色则必须返回person对象。' : ''}
`;

    try {
        const response = await fetch(`${settings.apiUrl}/chat/completions`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${settings.apiKey}`
            },
            body: JSON.stringify({
                model: settings.model,
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: plotThreadToExpand ? `请展开${locationName}的埋线剧情，承接此前伏笔进一步发展，并返回 newNpcs 将新出场人物加入人脉（每人 personality/appearance/background 不少于200字）。` : `请生成${locationName}的${actionType === "work" ? "工作" : actionType === "train" ? "训练" : "探索"}事件。剧情需紧扣${locationName}特色，避免单一化。${selectedHint ? `参考方向：${selectedHint}` : ""}` }
                ],
                temperature: 1.2,
                max_tokens: 2000
            })
        });

        if (!response.ok) {
            throw new Error(`API调用失败：${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error("API返回格式错误");
        }
        
        const reply = data.choices[0].message.content;
        
        // 尝试解析JSON
        let jsonMatch = reply.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
            throw new Error("API返回的不是有效的JSON格式");
        }
        
        const result = JSON.parse(jsonMatch[0]);
        if (!result.story) {
            throw new Error("API返回的数据中没有story字段");
        }
        
        // 若剧情使用了人脉中已开启本地图的角色，记录为该角色的遭遇记忆
        if (result.involvedNpcId != null) {
            const involvedNpc = gameState.npcs.find(function(n) { return n.id === result.involvedNpcId; });
            if (involvedNpc) {
                involvedNpc.npcMemory = involvedNpc.npcMemory || [];
                involvedNpc.npcMemory.push({
                    type: 'encounter',
                    location: locationName,
                    date: gameState.world.year + '年' + gameState.world.month + '月' + gameState.world.day + '日',
                    story: result.story
                });
            }
        }
        
        // 埋线：标记为伏笔，再次访问该地点时展开
        if (result.plotThread === true && !plotThreadToExpand) {
            gameState.plotThreads[locationName] = { story: result.story, eventType: result.eventType || '' };
        }
        // 埋线展开：新NPC加入人脉（设定不少于200字）
        if (plotThreadToExpand && Array.isArray(result.newNpcs) && result.newNpcs.length > 0) {
            const addedNames = [];
            result.newNpcs.forEach(p => {
                if (!p || !p.name) return;
                const personality = String(p.personality || '').trim();
                const appearance = String(p.appearance || '').trim();
                const background = String(p.background || '').trim();
                if (personality.length < 200 || appearance.length < 200 || background.length < 200) return;
                if (gameState.npcs.find(n => n.name === p.name && n.role === (p.role || ''))) return;
                gameState.npcs.push({
                    id: Date.now() + Math.random(),
                    name: p.name,
                    gender: (p.gender || '女').indexOf('男') >= 0 ? '男' : '女',
                    role: p.role || '未知',
                    personality, appearance, background,
                    affection: 0, metPlace: locationName, history: [], canSendEmoji: true, emojis: []
                });
                addedNames.push(p.name);
            });
            delete gameState.plotThreads[locationName];
            if (addedNames.length > 0) showTipModal(addedNames.join('、') + ' 已加入人脉。', '埋线展开');
        }
        // 处理遇到的人物（如果有且未使用人脉角色）
        if (result.person && result.involvedNpcId == null) {
            const person = {
                id: Date.now(),
                name: result.person.name,
                gender: result.person.gender || "女",
                role: result.person.role || "未知",
                personality: result.person.personality || "未知",
                appearance: result.person.appearance || "容貌端正",
                background: result.person.background || "",
                affection: 0,
                metPlace: locationName,
                history: [],
                canSendEmoji: true,
                emojis: []
            };
            
            // 检查是否已存在
            if (!gameState.npcs.find(n => n.name === person.name && n.role === person.role)) {
                gameState.npcs.push(person);
            }
        }
        
        // 应用奖励
        if (result.rewards) {
            if (result.rewards.money) gameState.player.stats.money += result.rewards.money;
            if (result.rewards.fame) gameState.player.stats.fame += result.rewards.fame;
            if (result.rewards.charm) gameState.player.stats.charm += result.rewards.charm;
            if (result.rewards.wisdom) gameState.player.stats.wisdom += result.rewards.wisdom;
            if (result.rewards.martial) gameState.player.stats.martial += result.rewards.martial;
            if (result.rewards.energy) gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + result.rewards.energy);
            // 剧情送物品 -> 加入物品栏
            if (result.rewards.items && Array.isArray(result.rewards.items)) {
                result.rewards.items.forEach(function(itemName) {
                    if (itemName && typeof itemName === 'string') addItemToInventory(itemName.trim(), 1);
                });
            }
            // 剧情送服装 -> 加入换装衣橱
            if (result.rewards.clothes && typeof result.rewards.clothes === 'number') {
                const cloth = gameState.clothes && gameState.clothes.find(function(c) { return c.id === result.rewards.clothes; });
                if (cloth && !cloth.owned) {
                    cloth.owned = true;
                    if (gameState.clothesCollection) gameState.clothesCollection.collected = (gameState.clothesCollection.collected || 1) + 1;
                }
            }
        }
        
        // 如果是训练类型，还要应用原始的训练奖励
        let apiSkillExpGain = null;
        if (actionType === "train" && statType) {
            const loc = LOCATIONS[locationName];
            if (loc && loc.stat && loc.val) {
                const maxStat = gameState.player.stats[`max${statType.charAt(0).toUpperCase() + statType.slice(1)}`] || 100;
                const newVal = Math.min(maxStat, gameState.player.stats[statType] + loc.val);
                const actualGain = newVal - gameState.player.stats[statType];
                gameState.player.stats[statType] = newVal;
                
                // 增加技能经验（对应技能的剧情增加对应技能经验）
                if (statType === "music" || statType === "dance" || statType === "embroidery") {
                    const skillId = "才艺精通";
                    const skill = gameState.player.skills[skillId] || { level: 0, exp: 0, mastery: 0 };
                    const expAdd = loc.val * 2;
                    skill.exp += expAdd;
                    skill.mastery += loc.val;
                    gameState.player.skills[skillId] = skill;
                    apiSkillExpGain = { skillName: "才艺精通", exp: expAdd };
                } else if (statType === "wisdom" || statType === "martial") {
                    const skillId = "心计谋略";
                    const skill = gameState.player.skills[skillId] || { level: 0, exp: 0, mastery: 0 };
                    const expAdd = loc.val * 2;
                    skill.exp += expAdd;
                    skill.mastery += loc.val;
                    gameState.player.skills[skillId] = skill;
                    apiSkillExpGain = { skillName: "心计谋略", exp: expAdd };
                }
            }
        }
        
        // 如果是工作类型，还要应用原始的工作奖励
        if (actionType === "work") {
            const loc = LOCATIONS[locationName];
            if (loc && loc.reward) {
                gameState.player.stats.money += loc.reward.money || 0;
                gameState.player.stats.fame += loc.reward.fame || 0;
            }
        }
        
        recordTodayVisit(locationName);
        // 写入重要选择（剧情页按地图分隔显示）
        if (!gameState.player.choices) gameState.player.choices = [];
        gameState.player.choices.push({
            id: Date.now() + Math.random(),
            title: locationName + ' - ' + (result.eventType || '剧情'),
            choice: result.story,
            date: new Date().toISOString(),
            locationName: locationName
        });
        // 显示结果（使用自定义弹窗）
        showLocationEventModal({
            locationName: locationName,
            story: result.story,
            eventType: result.eventType || "普通事件",
            skillExpGain: apiSkillExpGain,
            person: result.person ? {
                name: result.person.name,
                role: result.person.role,
                personality: result.person.personality,
                appearance: result.person.appearance,
                background: result.person.background
            } : null,
            rewards: result.rewards || {}
        });
        
        // 清除状态显示
        if (statusEl) {
            statusEl.textContent = '';
        }
        
        updateDashboard();
        apiCallingState.locationEvents[stateKey] = false;
        return;
        
    } catch (e) {
        console.error(`生成${locationName}事件失败:`, e);
        gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + cost);
        showMapApiFailureModal(locationName, actionType, statType, chance, cost, e.message);
        updateDashboard();
    } finally {
        // 清除状态显示
        if (statusEl) {
            statusEl.textContent = '';
        }
        apiCallingState.locationEvents[stateKey] = false;
    }
}

/**
 * NPC生成与交互系统
 */
function triggerEncounter(locationName) {
    // 检查是否遇到旧人 (30%概率)
    if (gameState.npcs.length > 0 && Math.random() < 0.3) {
        const oldNpc = gameState.npcs[Math.floor(Math.random() * gameState.npcs.length)];
        startChat(oldNpc);
        return;
    }

    // 生成新人
    const newNpc = generateNPC(locationName);
    gameState.npcs.push(newNpc);
    alert(`你偶遇了一位${newNpc.role}：${newNpc.name}`);
    startChat(newNpc);
}

function generateNPC(location) {
    const surnames = ["李", "王", "萧", "顾", "沈", "纳兰", "富察", "叶赫那拉", "苏", "白"];
    const namesM = ["渊", "尘", "墨", "修", "云", "景", "风", "轩"];
    const namesF = ["婉", "如", "月", "瑶", "心", "兰", "竹", "微"];
    
    const roles = {
        "御花园": ["侍卫", "王爷", "常在", "贵人", "皇子"],
        "太医院": ["太医", "医女"],
        "练武场": ["侍卫", "将军"],
        "御书房": ["太监总管", "大臣", "皇帝"],
        "长安街": ["富商", "书生", "侠客"],
        "青楼": ["名妓", "琴师"]
    };

    const locationRoles = roles[location] || ["宫女", "太监"];
    const role = locationRoles[Math.floor(Math.random() * locationRoles.length)];
    
    // 简单性别判定
    let gender = "女";
    if (["侍卫", "王爷", "皇子", "太医", "大臣", "皇帝", "将军", "书生", "侠客", "富商"].includes(role)) gender = "男";
    
    const name = surnames[Math.floor(Math.random() * surnames.length)] + 
                 (gender === "男" ? namesM[Math.floor(Math.random() * namesM.length)] : namesF[Math.floor(Math.random() * namesF.length)]);

    const personalities = ["温柔", "清冷", "傲娇", "腹黑", "豪爽", "阴郁", "活泼"];
    const personality = personalities[Math.floor(Math.random() * personalities.length)];

    const npc = {
        id: Date.now(),
        name: name,
        gender: gender,
        role: role,
        personality: personality,
        appearance: "容貌端正",
        affection: 0,
        metPlace: location,
        history: [],
        relationship: "neutral", // 关系类型：neutral/friend/enemy/lover
        relationshipLevel: 0, // 关系等级 0-100
        npcMemory: [], // NPC对你的行为记忆
        specialEvents: [], // 特殊事件记录
        canSendEmoji: true, // 是否允许发送表情包，默认true
        emojis: [] // NPC的表情包列表
    };
    
    // 初始化关系
    gameState.player.relationships[npc.id] = {
        type: "neutral",
        level: 0
    };
    
    return npc;
}

/**
 * 首次进入御书房/养心殿时生成皇帝（非API模式）：按开局皇帝性格随机生成年龄、名字等，加入人脉。
 */
function ensureEmperorInContactsRandom(locationName) {
    const surnames = ["李", "王", "萧", "顾", "沈", "赵", "刘", "陈", "慕容", "宇文"];
    const namesM = ["渊", "景", "煜", "修", "云", "轩", "睿", "昭"];
    const name = surnames[Math.floor(Math.random() * surnames.length)] + namesM[Math.floor(Math.random() * namesM.length)];
    const age = Math.floor(Math.random() * 35) + 16; // 16-50岁
    const emperorDesc = (gameState.world.emperorDesc || "勤政爱民").trim();
    const npc = {
        id: Date.now(),
        name: name,
        gender: "男",
        role: "皇帝",
        personality: emperorDesc,
        appearance: "约" + age + "岁，容貌威严",
        age: age,
        affection: Math.max(0, Math.min(100, gameState.player.emperorAffection || 0)),
        metPlace: locationName,
        history: [],
        relationship: "neutral",
        relationshipLevel: 0,
        npcMemory: [],
        specialEvents: [],
        canSendEmoji: true,
        emojis: []
    };
    gameState.player.relationships[npc.id] = { type: "neutral", level: 0 };
    return npc;
}

/**
 * 首次进入御书房/养心殿时生成皇帝（API模式）：按开局皇帝性格衍生背景、性格、年龄、名字等，加入人脉。
 */
async function ensureEmperorInContactsWithAPI(locationName) {
    if (!settings.apiKey) throw new Error("请先在设置中配置API Key");
    const emperorDesc = (gameState.world.emperorDesc || "勤政爱民").trim();
    const response = await fetch(settings.apiUrl + "/chat/completions", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + settings.apiKey },
        body: JSON.stringify({
            model: settings.model,
            messages: [
                { role: "system", content: "你是一个宫廷游戏的角色设定助手。只输出JSON，不要其他文字。" },
                { role: "user", content: `根据以下「开局皇帝设定」（性格/年号），衍生出该皇帝的具体设定。\n皇帝设定：${emperorDesc}\n\n请返回一个JSON对象，包含且仅包含以下字段（均为字符串，年龄写数字即可）：\n- name：皇帝的名字或帝号（如盛德帝、李景轩）\n- personality：细化后的性格描述（一两句话）\n- age：年龄（16-50之间的整数）\n- background：简短背景（出身或执政风格等，一两句话）\n- appearance：外貌描述（一两句话）` }
            ],
            temperature: 0.8,
            max_tokens: 500
        })
    });
    if (!response.ok) throw new Error(`API调用失败：${response.status} ${response.statusText}`);
    const data = await response.json();
    if (!data.choices || !data.choices[0] || !data.choices[0].message) throw new Error("API返回格式错误");
    const reply = data.choices[0].message.content;
    const jsonMatch = reply.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error("API返回的不是有效的JSON格式");
    const r = JSON.parse(jsonMatch[0]);
    var age = parseInt(r.age) || (Math.floor(Math.random() * 35) + 16);
    if (age < 16) age = 16;
    if (age > 50) age = 50;
    const npc = {
        id: Date.now(),
        name: (r.name || "皇帝").toString().trim(),
        gender: "男",
        role: "皇帝",
        personality: (r.personality || emperorDesc).toString().trim(),
        appearance: (r.appearance || "容貌威严").toString().trim(),
        age: age,
        affection: Math.max(0, Math.min(100, gameState.player.emperorAffection || 0)),
        metPlace: locationName,
        history: [],
        relationship: "neutral",
        relationshipLevel: 0,
        npcMemory: [],
        specialEvents: [],
        canSendEmoji: true,
        emojis: []
    };
    gameState.player.relationships[npc.id] = { type: "neutral", level: 0 };
    return npc;
}

/**
 * 聊天系统 (LLM核心)
 */
function startChat(npc) {
    gameState.chatTargetId = npc.id;
    gameState.chatHistoryLog = []; // 清空本次会话UI
    
    const relationship = gameState.player.relationships[npc.id] || { type: "neutral", level: 0 };
    const relText = relationship.type === "friend" ? "朋友" : relationship.type === "lover" ? "恋人" : relationship.type === "enemy" ? "敌人" : "普通";
    
    const nameEl = document.getElementById('chat-target-name');
    if (nameEl) {
        nameEl.innerText = `${npc.role} ${npc.name}`;
        nameEl.style.cursor = 'pointer';
        nameEl.title = '点击查看心理状态与日记';
    }
    document.getElementById('chat-affection').innerText = `好感: ${npc.affection} | 关系: ${relText}(${relationship.level})`;
    var wrap = document.getElementById('chat-pending-contraceptive-wrap');
    if (wrap) wrap.style.display = npc.pendingContraceptive ? 'inline-block' : 'none';
    
    // 清空聊天框
    const chatBox = document.getElementById('chat-box');
    chatBox.innerHTML = '';
    
    // 如果有历史记录，加载并显示
    if (npc.history && npc.history.length > 0) {
        renderChatHistory(npc);
    }
    
    const actionsDiv = document.getElementById('chat-actions');
    if (actionsDiv) actionsDiv.innerHTML = '';
    applyChatBackground(npc);
    goToPage('page-chat');
}

// 渲染聊天历史记录
function renderChatHistory(npc) {
    const chatBox = document.getElementById('chat-box');
    
    npc.history.forEach((historyItem, historyIndex) => {
        // 解析历史记录格式：[日期时间] 发送者: 消息内容
        const match = historyItem.match(/\[([^\]]+)\]\s*(.+?):\s*(.+)/);
        if (!match) return;
        
        const timestamp = match[1];
        const sender = match[2];
        const content = match[3];
        
        // 判断是用户还是NPC
        const isUser = sender === gameState.player.name;
        const isNPC = sender === npc.name;
        
        if (isUser) {
            // 用户消息
            // 检查是否是特殊消息类型
            const decoded = decodeQuoteMarker(content);
            const quoteData = decoded ? decoded.quote : null;
            const contentText = decoded ? decoded.rest : content;
            if (content.includes('[发送表情包]')) {
                const emojiDesc = contentText.replace(' [发送表情包]', '');
                // 表情包消息，需要查找对应的图片（这里简化处理，只显示文本）
                addMessageToUI(emojiDesc || '[表情包]', 'user', null, false, null, quoteData, { historyIndex, timestamp, sender });
            } else if (content.includes('[发送图片]')) {
                const imgDesc = contentText.replace(' [发送图片]', '');
                // 图片消息，简化处理
                addMessageToUI(imgDesc || '[图片]', 'user', null, false, null, quoteData, { historyIndex, timestamp, sender });
            } else if (content.includes('[赠送礼物:')) {
                // 礼物消息
                addMessageToUI(contentText, 'user', null, false, null, quoteData, { historyIndex, timestamp, sender });
            } else if (content.includes('[转账银两:')) {
                // 转账消息 - 解析并显示卡片
                const moneyMatch = contentText.match(/\[转账银两:\s*(\d+)\s*两\s*(.*?)\]/);
                if (moneyMatch) {
                    const amount = parseInt(moneyMatch[1]);
                    const note = moneyMatch[2] ? moneyMatch[2].trim() : null;
                    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
                    sendMoneyCard(amount, 'user', gameState.player.name, npc ? npc.name : null, timestamp, note);
                } else {
                    addMessageToUI(contentText, 'user', null, false, null, quoteData, { historyIndex, timestamp, sender });
                }
            } else {
                // 普通文本消息
                addMessageToUI(contentText, 'user', null, false, null, quoteData, { historyIndex, timestamp, sender });
            }
        } else if (isNPC) {
            // NPC消息
            if (content.includes('[发送表情包]')) {
                // NPC发送的表情包
                addMessageToUI('[表情包]', 'npc', null, false, null, null, { historyIndex, timestamp, sender });
            } else if (content.includes('[赠送礼物:') || content.includes('[转账银两:') || content.includes('[赠送衣服:')) {
                // NPC的特殊消息
                addMessageToUI(content, 'npc', null, false, null, null, { historyIndex, timestamp, sender });
            } else {
                // NPC的普通回复（人脉不展示（）里的心里描述）
                var npcDisplayContent = content.replace(/（[^）]*）/g, '').replace(/\([^)]*\)/g, '').replace(/\s{2,}/g, ' ').trim();
                if (!npcDisplayContent) npcDisplayContent = content;
                addMessageToUI(npcDisplayContent, 'npc', null, false, null, null, { historyIndex, timestamp, sender });
            }
        } else if (sender === '系统') {
            // 系统/旁白消息（如避孕汤服用结果等），会进入对话上下文
            addMessageToUI(content, 'sys', null, false, null, null, { historyIndex, timestamp, sender });
        }
    });
    
    // 滚动到底部
    setTimeout(() => {
        chatBox.scrollTop = chatBox.scrollHeight;
    }, 100);
}

// API调用状态管理
let apiCallingState = {
    sendMessage: false,
    sendGroupMessage: false,
    generateServants: false,
    sendEmoji: false,
    sendImage: false,
    sendGift: false,
    sendMoney: false,
    locationEvents: {} // 地图事件API调用状态，key为地图名称
};
let currentAbortController = null; // 用于取消API调用

// API调用管理器：跟踪所有正在进行的API调用
let activeApiCalls = new Map(); // key: callId, value: {type, context, callback, abortController}

// 生成唯一的API调用ID
function generateApiCallId() {
    return 'api_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// 注册API调用
function registerApiCall(callId, type, context, callback, abortController) {
    activeApiCalls.set(callId, {
        type: type,
        context: context,
        callback: callback,
        abortController: abortController,
        startTime: Date.now()
    });
}

// 完成API调用
function completeApiCall(callId, result) {
    const call = activeApiCalls.get(callId);
    if (call) {
        activeApiCalls.delete(callId);
        // 执行回调，更新界面
        if (call.callback) {
            call.callback(result, call.context);
        }
    }
}

// 取消API调用
function cancelApiCall(callId) {
    const call = activeApiCalls.get(callId);
    if (call) {
        if (call.abortController) {
            call.abortController.abort();
        }
        activeApiCalls.delete(callId);
    }
}

function toggleChatPlusMenu() {
    const menu = document.getElementById('chat-plus-menu');
    document.querySelectorAll('.plus-menu, .chat-plus-menu').forEach(m => {
        if (m.id !== menu.id) m.classList.remove('show');
    });
    const npc = gameState.chatTargetId ? gameState.npcs.find(n => n.id === gameState.chatTargetId) : null;
    const isChild = npc && npc.isChild === true;
    menu.querySelectorAll('.chat-menu-normal').forEach(el => { el.style.display = isChild ? 'none' : ''; });
    const raiseEl = document.getElementById('menu-child-raise');
    const killEl = document.getElementById('menu-child-kill');
    const marryEl = document.getElementById('menu-child-marry');
    if (raiseEl) raiseEl.style.display = isChild ? '' : 'none';
    if (killEl) killEl.style.display = isChild ? '' : 'none';
    if (marryEl) {
        const child = isChild && npc.childId ? gameState.player.children.find(c => c.id === npc.childId) : null;
        marryEl.style.display = (isChild && child && Math.floor(child.ageInYears || 0) >= 16) ? '' : 'none';
    }
    menu.classList.toggle('show');
}

// 点击其他地方关闭菜单
document.addEventListener('click', function(e) {
    // 如果点击的是菜单项，让onclick事件正常执行，然后关闭菜单
    if (e.target.closest('.plus-menu-item')) {
        // 延迟关闭菜单，让onclick事件先执行
        setTimeout(() => {
            document.querySelectorAll('.chat-plus-menu, .plus-menu').forEach(m => {
                m.classList.remove('show');
            });
        }, 10);
        return;
    }
    // 如果点击的是菜单容器或+按钮，不关闭菜单
    if (e.target.closest('.chat-controls') || e.target.closest('.chat-plus-btn') || e.target.closest('.chat-plus-menu')) {
        return;
    }
    // 点击其他地方，关闭所有菜单
    document.querySelectorAll('.chat-plus-menu, .plus-menu').forEach(m => {
        m.classList.remove('show');
    });
});

function setMenuLoading(menuId, loading) {
    const menuItem = document.getElementById(menuId);
    if (!menuItem) return;
    
    const originalHTML = menuItem.getAttribute('data-original-html');
    
    if (loading) {
        // 保存原始HTML（包括图标）
        if (!originalHTML) {
            menuItem.setAttribute('data-original-html', menuItem.innerHTML);
        }
        // 添加"正在调用中"，但保留图标
        // 从保存的原始HTML中提取图标和文本
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = originalHTML || menuItem.innerHTML;
        const iconMatch = tempDiv.innerHTML.match(/<span class="material-icons"[^>]*>([^<]+)<\/span>/);
        const iconHtml = iconMatch ? iconMatch[0] : '';
        const originalText = menuItem.getAttribute('data-original-text') || tempDiv.textContent.trim().replace(' (正在调用中)', '');
        menuItem.innerHTML = `${iconHtml}${originalText} (正在调用中)`;
        menuItem.classList.add('loading');
        menuItem.style.pointerEvents = 'none';
    } else {
        // 恢复原始HTML（包括图标）
        if (originalHTML) {
            menuItem.innerHTML = originalHTML;
            menuItem.removeAttribute('data-original-html'); // 清除保存的HTML，下次重新保存
        } else {
            // 如果没有保存的HTML，尝试恢复文本和图标
            const iconMatch = menuItem.innerHTML.match(/<span class="material-icons"[^>]*>([^<]+)<\/span>/);
            const iconHtml = iconMatch ? iconMatch[0] : '';
            const originalText = menuItem.getAttribute('data-original-text') || menuItem.textContent.replace(' (正在调用中)', '').trim();
            if (originalText && iconHtml) {
                menuItem.innerHTML = `${iconHtml}${originalText}`;
            } else if (originalText) {
                // 如果找不到图标，至少恢复文本
                menuItem.textContent = originalText;
            }
        }
        menuItem.classList.remove('loading');
        menuItem.style.pointerEvents = 'auto';
    }
}

let currentEmojiNpcId = null;

function sendEmojiFromChat() {
    if (apiCallingState.sendEmoji) return;
    apiCallingState.sendEmoji = true;
    setMenuLoading('menu-emoji', true);
    
    currentEmojiNpcId = gameState.chatTargetId;
    openEmojiModal();
    document.getElementById('chat-plus-menu').classList.remove('show');
    
    // 表情包选择后会自动重置状态
}

function sendEmoji(npcId) {
    // 保留用于兼容，但主要使用sendEmojiFromChat
    currentEmojiNpcId = npcId;
    openEmojiModal();
}

let currentEmojiTab = 'mine'; // 'mine' 或 'other'

function openEmojiModal() {
    const modal = document.getElementById('emoji-modal');
    const tabsDiv = document.getElementById('emoji-tabs');
    const titleEl = document.getElementById('emoji-modal-title');
    
    // 判断是否显示标签页
    const isGroupChat = currentGroupId !== null;
    const isPrivateChat = gameState.chatTargetId !== null;
    
    if (isGroupChat) {
        // 群聊模式：显示"我的表情包"和"成员表情包"
        tabsDiv.style.display = 'flex';
        titleEl.innerHTML = '<span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">mood</span>表情包';
        document.getElementById('emoji-tab-other').textContent = '成员表情包';
        currentEmojiTab = 'mine';
        switchEmojiTab('mine');
    } else if (isPrivateChat) {
        // 私聊模式：显示"我的表情包"和"他的表情包"
        tabsDiv.style.display = 'flex';
        titleEl.innerHTML = '<span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">mood</span>表情包';
        const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
        if (npc) {
            document.getElementById('emoji-tab-other').textContent = `${npc.name}的表情包`;
        }
        currentEmojiTab = 'mine';
        switchEmojiTab('mine');
    } else {
        // 其他模式：只显示"我的表情包"
        tabsDiv.style.display = 'none';
        titleEl.innerHTML = '<span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">mood</span>我的表情包';
        currentEmojiTab = 'mine';
    }
    
    modal.style.display = 'flex';
    renderEmojiGrid();
}

function switchEmojiTab(tab) {
    currentEmojiTab = tab;
    const mineTab = document.getElementById('emoji-tab-mine');
    const otherTab = document.getElementById('emoji-tab-other');
    
    if (!mineTab || !otherTab) return;
    
    if (tab === 'mine') {
        mineTab.style.background = 'var(--primary)';
        mineTab.style.color = 'white';
        otherTab.style.background = 'transparent';
        otherTab.style.color = 'var(--text)';
    } else {
        otherTab.style.background = 'var(--primary)';
        otherTab.style.color = 'white';
        mineTab.style.background = 'transparent';
        mineTab.style.color = 'var(--text)';
    }
    
    renderEmojiGrid();
}

function closeEmojiModal() {
    const modal = document.getElementById('emoji-modal');
    if (modal) {
        modal.style.display = 'none';
    }
    // 清除loading状态
    apiCallingState.sendEmoji = false;
    setMenuLoading('menu-emoji', false);
    setMenuLoading('group-menu-emoji', false);
    currentEmojiNpcId = null;
    
    // 如果是从群设置进入的NPC表情包管理，恢复状态
    if (currentEditingNpcId) {
        // 清除临时设置（但不清除currentGroupId，因为可能还在群聊中）
        gameState.chatTargetId = null;
        currentEditingNpcId = null;
    }
    
    currentEmojiTab = 'mine';
}

function renderEmojiGrid() {
    const grid = document.getElementById('emoji-grid');
    grid.innerHTML = '';
    
    let emojiList = [];
    let isMine = true;
    
    if (currentEmojiTab === 'mine') {
        // 显示我的表情包
        emojiList = emojiStore;
        isMine = true;
    } else {
        // 显示他的表情包或成员表情包
        isMine = false;
        
        // 如果是从群设置进入的NPC表情包管理，只显示该NPC的表情包
        if (currentEditingNpcId) {
            const npc = gameState.npcs.find(n => n.id === currentEditingNpcId);
            if (npc && npc.emojis) {
                emojiList = npc.emojis;
            }
        } else if (currentGroupId) {
            // 群聊模式：显示所有成员的表情包
            const group = gameState.groups.find(g => g.id === currentGroupId);
            if (group) {
                group.memberIds.forEach(id => {
                    if (id !== null) {
                        const npc = gameState.npcs.find(n => n.id == id);
                        if (npc && npc.emojis && npc.emojis.length > 0) {
                            npc.emojis.forEach(emojiData => {
                                emojiList.push({...emojiData, owner: npc.name, ownerId: npc.id});
                            });
                        }
                    }
                });
            }
        } else if (gameState.chatTargetId) {
            // 私聊模式：显示当前NPC的表情包
            const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
            if (npc && npc.emojis) {
                emojiList = npc.emojis;
            }
        }
    }
    
    // 添加按钮（我的表情包、私聊的他的表情包、以及正在编辑的NPC表情包可以添加）
    if (isMine || (!isMine && (gameState.chatTargetId || currentEditingNpcId) && !currentGroupId)) {
        const addBtn = document.createElement('div');
        addBtn.className = 'emoji-add-btn';
        addBtn.innerHTML = '+';
        addBtn.onclick = function() {
            if (currentEditingNpcId) {
                // 从群设置进入的NPC表情包管理
                const npc = gameState.npcs.find(n => n.id === currentEditingNpcId);
                if (npc && !gameState.chatTargetId) {
                    gameState.chatTargetId = currentEditingNpcId;
                }
            }
            addEmojiFromGallery();
        };
        grid.appendChild(addBtn);
    }
    
    
    // 显示表情包
    emojiList.forEach((emojiData, index) => {
        const emoji = typeof emojiData === 'string' ? emojiData : emojiData.image;
        const description = typeof emojiData === 'string' ? '' : (emojiData.description || '');
        const owner = emojiData.owner || '';
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.style.position = 'relative';
        
        // 判断是否可以编辑（我的表情包和正在编辑的NPC表情包可以编辑）
        let canEdit = false;
        let editIndex = index;
        let editNpcId = null;
        
        if (isMine && index < emojiStore.length) {
            canEdit = true;
        } else if (currentEditingNpcId) {
            // 从群设置进入的NPC表情包管理
            const npc = gameState.npcs.find(n => n.id === currentEditingNpcId);
            if (npc && npc.emojis && index < npc.emojis.length) {
                canEdit = true;
                editNpcId = currentEditingNpcId;
            }
        } else if (!isMine && gameState.chatTargetId) {
            // 私聊模式下的NPC表情包
            const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
            if (npc && npc.emojis && index < npc.emojis.length) {
                canEdit = true;
                editNpcId = gameState.chatTargetId;
            }
        }
        
        item.innerHTML = `
            <img src="${emoji}" alt="${description || `表情包${index + 1}`}">
            ${description ? `<div style="font-size:10px;color:#757ED3;margin-top:2px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${description}</div>` : ''}
            ${owner ? `<div style="font-size:9px;color:#8E96D9;margin-top:2px;text-align:center;">${owner}</div>` : ''}
            ${canEdit ? `<div class="emoji-edit-btn" onclick="event.stopPropagation(); editEmoji(${editIndex}, ${editNpcId || 'null'})" title="编辑">
                <span class="material-icons" style="font-size:16px;">edit</span>
            </div>` : ''}
        `;
        item.onclick = () => selectEmoji(emojiData);
        item.title = description || `表情包${index + 1}`;
        grid.appendChild(item);
    });
    
    if (emojiList.length === 0 && !isMine) {
        const emptyMsg = document.createElement('p');
        emptyMsg.style.cssText = "text-align:center;color:#8E96D9;padding:20px;grid-column:1/-1;";
        if (currentEditingNpcId) {
            // 从群设置进入的NPC表情包管理
            const npc = gameState.npcs.find(n => n.id === currentEditingNpcId);
            emptyMsg.textContent = npc ? `${npc.name}暂无表情包，点击"+"添加` : '暂无表情包';
        } else if (currentGroupId) {
            emptyMsg.textContent = '群成员暂无表情包';
        } else if (gameState.chatTargetId) {
            const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
            emptyMsg.textContent = npc ? `${npc.name}暂无表情包` : '暂无表情包';
        } else {
            emptyMsg.textContent = '暂无表情包';
        }
        grid.appendChild(emptyMsg);
    }
}

let pendingEmojiFile = null;
let currentEditingNpcId = null; // 当前正在编辑表情包的NPC ID

// 图片压缩函数（使用Canvas API压缩图片，保持画质）
async function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.85) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // 计算缩放比例，保持宽高比
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width = width * ratio;
                    height = height * ratio;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // 转换为Blob（JPEG格式，质量85%）
                canvas.toBlob(function(blob) {
                    if (blob) {
                        resolve(blob);
                    } else {
                        reject(new Error('图片压缩失败'));
                    }
                }, 'image/jpeg', quality);
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// 将Blob转换为Base64
function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function() {
            resolve(reader.result);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

function addEmojiFromGallery() {
    // 重置状态
    document.getElementById('emoji-description-input').value = '';
    document.getElementById('emoji-file-input').value = '';
    document.getElementById('emoji-preview').style.display = 'none';
    pendingEmojiFile = null;
    editingEmojiIndex = -1;
    
    // 更新弹窗标题和按钮文本
    const title = document.querySelector('#add-emoji-modal h3');
    title.innerHTML = '<span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">add_photo_alternate</span>添加表情包';
    document.getElementById('confirm-emoji-btn').textContent = '确定';
    
    // 显示弹窗
    document.getElementById('add-emoji-modal').style.display = 'flex';
    document.getElementById('add-emoji-modal').setAttribute('data-edit-index', '-1');
}

async function handleEmojiFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        pendingEmojiFile = file;
        try {
            // 压缩图片
            const compressedBlob = await compressImage(file, 800, 800, 0.85);
            const compressedDataUrl = await blobToBase64(compressedBlob);
            document.getElementById('emoji-preview-img').src = compressedDataUrl;
            document.getElementById('emoji-preview').style.display = 'block';
            // 更新pendingEmojiFile为压缩后的Blob
            pendingEmojiFile = compressedBlob;
        } catch (error) {
            console.error('图片压缩失败:', error);
            // 如果压缩失败，使用原图
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('emoji-preview-img').src = e.target.result;
                document.getElementById('emoji-preview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }
}

async function confirmAddEmoji() {
    if (!pendingEmojiFile) {
        alert('请先选择图片！');
        return;
    }
    
    const description = document.getElementById('emoji-description-input').value.trim();
    const editIndex = parseInt(document.getElementById('add-emoji-modal').getAttribute('data-edit-index') || '-1');
    const isEditing = editIndex >= 0;
    
    try {
        let imageData;
        if (pendingEmojiFile instanceof Blob) {
            // 如果已经是压缩后的Blob，直接转换
            imageData = await blobToBase64(pendingEmojiFile);
        } else {
            // 否则压缩原文件
            const compressedBlob = await compressImage(pendingEmojiFile, 800, 800, 0.85);
            imageData = await blobToBase64(compressedBlob);
        }
        
        const emojiData = { image: imageData, description: description };
        
        if (isEditing) {
            // 编辑模式
            if (currentEditingNpcId) {
                // 编辑NPC的表情包
                const npc = gameState.npcs.find(n => n.id === currentEditingNpcId);
                if (npc && npc.emojis) {
                    npc.emojis[editIndex] = emojiData;
                }
            } else {
                // 编辑我的表情包
                emojiStore[editIndex] = emojiData;
                saveEmojis();
            }
        } else {
            // 添加模式
            if (currentEditingNpcId) {
                // 添加到NPC的表情包（从群设置进入）
                const npc = gameState.npcs.find(n => n.id === currentEditingNpcId);
                if (npc) {
                    if (!npc.emojis) npc.emojis = [];
                    npc.emojis.push(emojiData);
                    renderEmojiGrid();
                    closeAddEmojiModal();
                    return;
                }
            } else if (currentEditingNpcId) {
                // 添加到NPC的表情包（从群设置进入）
                const npc = gameState.npcs.find(n => n.id === currentEditingNpcId);
                if (npc) {
                    if (!npc.emojis) npc.emojis = [];
                    npc.emojis.push(emojiData);
                    renderEmojiGrid();
                    closeAddEmojiModal();
                    return;
                }
            } else if (currentEmojiTab === 'other') {
                // 添加到NPC的表情包
                if (currentGroupId) {
                    // 群聊模式：需要选择添加到哪个成员
                    alert('群聊模式下，请先选择要添加表情包的成员');
                    closeAddEmojiModal();
                    return;
                } else if (gameState.chatTargetId) {
                    // 私聊模式：添加到当前NPC
                    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
                    if (npc) {
                        if (!npc.emojis) npc.emojis = [];
                        npc.emojis.push(emojiData);
                        renderEmojiGrid();
                        closeAddEmojiModal();
                        return;
                    }
                }
            } else {
                // 添加到我的表情包
                emojiStore.push(emojiData);
                saveEmojis();
            }
        }
        
        renderEmojiGrid();
        closeAddEmojiModal();
    } catch (error) {
        console.error('保存表情包失败:', error);
        alert('保存表情包失败，请重试');
    }
}

function closeAddEmojiModal() {
    document.getElementById('add-emoji-modal').style.display = 'none';
    document.getElementById('emoji-description-input').value = '';
    document.getElementById('emoji-file-input').value = '';
    document.getElementById('emoji-preview').style.display = 'none';
    pendingEmojiFile = null;
    editingEmojiIndex = -1;
    document.getElementById('add-emoji-modal').setAttribute('data-edit-index', '-1');
}

function showErrorModal(message) {
    const modal = document.getElementById('error-modal');
    const messageEl = document.getElementById('error-modal-content');
    if (messageEl) messageEl.textContent = message;
    if (modal) {
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
    }
}

function closeErrorModal() {
    const modal = document.getElementById('error-modal');
    if (modal) modal.style.display = 'none';
}

function showTipModal(message, title) {
    const modal = document.getElementById('tip-modal');
    const titleEl = document.getElementById('tip-modal-title');
    const contentEl = document.getElementById('tip-modal-content');
    if (titleEl) titleEl.textContent = title || '提示';
    if (contentEl) contentEl.textContent = message;
    if (modal) {
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
    }
}

function closeTipModal() {
    const modal = document.getElementById('tip-modal');
    if (modal) modal.style.display = 'none';
}

function showProactiveContactPopup(text) {
    var pop = document.createElement('div');
    pop.className = 'proactive-contact-popup';
    pop.style.cssText = 'position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:10002;padding:14px 22px;max-width:90%;background:rgba(0,0,0,0.88);color:#fff;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.4);font-size:15px;line-height:1.5;opacity:0;transition:opacity 0.3s ease;pointer-events:none;';
    pop.textContent = text;
    document.body.appendChild(pop);
    requestAnimationFrame(function() { pop.style.opacity = '1'; });
    setTimeout(function() {
        pop.style.opacity = '0';
        setTimeout(function() { if (pop.parentNode) pop.remove(); }, 300);
    }, 5000);
}

function showMoneyDetailModal(data) {
    document.getElementById('money-detail-amount').textContent = `¥${data.amount}`;
    document.getElementById('money-detail-sender').textContent = data.senderName || '未知';
    document.getElementById('money-detail-recipient').textContent = data.recipientName || '未知';
    const date = new Date(data.timestamp);
    const timeStr = date.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('money-detail-time').textContent = timeStr;
    var el = document.getElementById('money-detail-modal-content');
    if (el) {
        el.style.background = '';
        el.style.color = '';
        el.style.borderRadius = '';
        var d = gameState.moneyTransferDetailStyle;
        if (gameState.chatTargetId) {
            var curNpc = gameState.npcs && gameState.npcs.find(function(n) { return n.id == gameState.chatTargetId || String(n.id) === String(gameState.chatTargetId); });
            if (curNpc) {
                if (curNpc.moneyTransferDetailStyle) d = curNpc.moneyTransferDetailStyle;
                if (data.senderType === 'npc' && curNpc.moneyTransferDetailStyleNpc) d = curNpc.moneyTransferDetailStyleNpc;
            }
        }
        if (d) {
            if (d.background) el.style.background = d.background;
            if (d.color) el.style.color = d.color;
            if (d.borderRadius !== undefined) el.style.borderRadius = (typeof d.borderRadius === 'number' ? d.borderRadius + 'px' : String(d.borderRadius));
        }
    }
    document.getElementById('money-detail-modal').style.display = 'flex';
}

function closeMoneyDetailModal() {
    document.getElementById('money-detail-modal').style.display = 'none';
}

function showPostImageModal(imageSrc) {
    document.getElementById('post-image-modal-img').src = imageSrc;
    document.getElementById('post-image-modal').style.display = 'flex';
}

function closePostImageModal() {
    document.getElementById('post-image-modal').style.display = 'none';
}

// 红包相关函数
function sendRedPackFromGroupChat() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) {
        alert('请先进入群聊');
        return;
    }
    
    document.getElementById('redpack-balance').textContent = gameState.player.stats.money || 0;
    document.getElementById('redpack-amount').value = '';
    document.getElementById('redpack-count').value = '1';
    document.getElementById('redpack-note').value = '';
    document.getElementById('redpack-total').textContent = '0';
    const modal = document.getElementById('redpack-modal');
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function closeRedPackModal() {
    document.getElementById('redpack-modal').style.display = 'none';
    document.getElementById('redpack-note').value = '';
}

function updateRedPackTotal() {
    const amount = parseInt(document.getElementById('redpack-amount').value) || 0;
    const count = parseInt(document.getElementById('redpack-count').value) || 1;
    const total = amount * count;
    document.getElementById('redpack-total').textContent = total;
}

function confirmSendRedPack() {
    const amount = parseInt(document.getElementById('redpack-amount').value) || 0;
    const count = parseInt(document.getElementById('redpack-count').value) || 1;
    const note = document.getElementById('redpack-note').value.trim() || '恭喜发财，大吉大利';
    const total = amount * count;
    
    if (amount <= 0 || count <= 0) {
        alert('请输入有效的金额和个数');
        return;
    }
    
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    if (total > gameState.player.stats.money) {
        alert(`余额不足！需要${total}两，当前只有${gameState.player.stats.money}两`);
        return;
    }
    
    if (count > group.memberIds.length) {
        alert(`红包个数不能超过群成员数量（${group.memberIds.length}）`);
        return;
    }
    
    // 扣除玩家银两
    gameState.player.stats.money -= total;
    updateMoneyDisplay();
    
    // 创建红包数据
    const redpackAmounts = distributeRedPack(total, count);
    const redpackData = {
        total: total,
        count: count,
        remaining: count,
        amounts: redpackAmounts,
        openedBy: [],
        receivedBy: {},
        note: note
    };
    
    // 发送红包消息到群聊
    const timeNames = ["早", "中", "晚"];
    const msg = {
        id: Date.now(),
        author: gameState.player.name,
        content: note,
        redpack: redpackData,
        time: `${gameState.world.month}月${gameState.world.day}日 ${timeNames[gameState.world.timeOfDay]}`
    };
    
    group.messages.push(msg);
    renderGroupChat();
    closeRedPackModal();
}

// 分配红包金额（随机分配）
function distributeRedPack(total, count) {
    const amounts = [];
    let remaining = total;
    
    for (let i = 0; i < count - 1; i++) {
        const max = remaining - (count - i - 1);
        const amount = Math.floor(Math.random() * max) + 1;
        amounts.push(amount);
        remaining -= amount;
    }
    amounts.push(remaining);
    
    // 打乱顺序
    for (let i = amounts.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [amounts[i], amounts[j]] = [amounts[j], amounts[i]];
    }
    
    return amounts;
}

// 打开红包
function openRedPack(msgId) {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    const msg = group.messages.find(m => m.id === msgId);
    if (!msg || !msg.redpack) return;
    
    // 检查是否已领取
    if (msg.redpack.openedBy && msg.redpack.openedBy.includes(gameState.player.name)) {
        alert('您已经领取过这个红包了');
        return;
    }
    
    // 检查是否还有剩余
    if (msg.redpack.remaining <= 0) {
        alert('红包已被抢完');
        return;
    }
    
    // 随机分配一个金额
    const availableIndex = msg.redpack.amounts.findIndex((amt, idx) => !msg.redpack.receivedBy[idx]);
    if (availableIndex === -1) {
        alert('红包已被抢完');
        return;
    }
    
    const amount = msg.redpack.amounts[availableIndex];
    msg.redpack.receivedBy[availableIndex] = gameState.player.name;
    msg.redpack.openedBy.push(gameState.player.name);
    msg.redpack.remaining--;
    
    // 增加玩家银两
    gameState.player.stats.money += amount;
    updateMoneyDisplay();
    
    // 显示领取成功弹窗
    const modal = document.getElementById('redpack-success-modal');
    document.getElementById('redpack-success-amount').textContent = amount;
    document.getElementById('redpack-success-remaining').textContent = `剩余 ${msg.redpack.remaining}/${msg.redpack.count} 个`;
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    
    renderGroupChat();
}

function closeRedPackSuccessModal() {
    document.getElementById('redpack-success-modal').style.display = 'none';
}

let editingEmojiIndex = -1;

let editingEmojiContext = null; // 'mine' 或 {type: 'npc', npcId: id, index: index}

function editEmoji(index, npcId = null) {
    let emojiData = null;
    let canEdit = false;
    
    if (npcId) {
        // 编辑NPC的表情包
        const npc = gameState.npcs.find(n => n.id === npcId);
        if (npc && npc.emojis && index >= 0 && index < npc.emojis.length) {
            emojiData = npc.emojis[index];
            canEdit = true;
            currentEditingNpcId = npcId;
            editingEmojiIndex = index;
        }
    } else if (currentEmojiTab === 'mine') {
        // 编辑我的表情包
        if (index >= 0 && index < emojiStore.length) {
            emojiData = emojiStore[index];
            canEdit = true;
            editingEmojiIndex = index;
            currentEditingNpcId = null;
        }
    } else if (currentEditingNpcId) {
        // 编辑当前正在编辑的NPC的表情包
        const npc = gameState.npcs.find(n => n.id === currentEditingNpcId);
        if (npc && npc.emojis && index >= 0 && index < npc.emojis.length) {
            emojiData = npc.emojis[index];
            canEdit = true;
            editingEmojiIndex = index;
        }
    }
    
    if (!canEdit || !emojiData) {
        alert('无法编辑此表情包');
        return;
    }
    
    const description = typeof emojiData === 'string' ? '' : (emojiData.description || '');
    const image = typeof emojiData === 'string' ? emojiData : emojiData.image;
    
    // 填充表单
    document.getElementById('emoji-description-input').value = description;
    document.getElementById('emoji-preview-img').src = image;
    document.getElementById('emoji-preview').style.display = 'block';
    pendingEmojiFile = null;
    
    // 更新弹窗标题和按钮文本
    const title = document.querySelector('#add-emoji-modal h3');
    title.innerHTML = '<span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">edit</span>编辑表情包';
    document.getElementById('confirm-emoji-btn').textContent = '保存';
    
    // 显示弹窗
    document.getElementById('add-emoji-modal').style.display = 'flex';
    document.getElementById('add-emoji-modal').setAttribute('data-edit-index', index);
}

function confirmAddEmoji() {
    const editIndex = parseInt(document.getElementById('add-emoji-modal').getAttribute('data-edit-index') || '-1');
    const isEditing = editIndex >= 0;
    
    if (isEditing) {
        // 编辑模式（只支持编辑我的表情包）
        const description = document.getElementById('emoji-description-input').value.trim();
        const emojiData = emojiStore[editIndex];
        const oldImage = typeof emojiData === 'string' ? emojiData : emojiData.image;
        
        if (pendingEmojiFile) {
            // 用户选择了新图片
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                emojiStore[editIndex] = { image: imageData, description: description };
                saveEmojis();
                renderEmojiGrid();
                closeAddEmojiModal();
            };
            reader.readAsDataURL(pendingEmojiFile);
        } else {
            // 只更新描述
            emojiStore[editIndex] = { image: oldImage, description: description };
            saveEmojis();
            renderEmojiGrid();
            closeAddEmojiModal();
        }
    } else {
        // 添加模式
        if (!pendingEmojiFile) {
            alert('请先选择图片！');
            return;
        }
        
        const description = document.getElementById('emoji-description-input').value.trim();
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageData = e.target.result;
            const emojiData = { image: imageData, description: description };
            
            // 检查当前标签页
            if (currentEmojiTab === 'other') {
                // 添加到NPC的表情包
                if (currentGroupId) {
                    // 群聊模式：需要选择添加到哪个成员（暂不支持，提示用户）
                    alert('群聊模式下，请切换到"我的表情包"标签页添加表情包');
                    closeAddEmojiModal();
                    return;
                } else if (gameState.chatTargetId) {
                    // 私聊模式：添加到当前NPC
                    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
                    if (npc) {
                        if (!npc.emojis) npc.emojis = [];
                        npc.emojis.push(emojiData);
                        renderEmojiGrid();
                        closeAddEmojiModal();
                        return;
                    }
                }
            } else {
                // 添加到我的表情包
                emojiStore.push(emojiData);
                saveEmojis();
            }
            
            renderEmojiGrid();
            closeAddEmojiModal();
        };
        reader.readAsDataURL(pendingEmojiFile);
    }
}

function openEmojiModalFromChat() {
    // 从聊天界面打开表情包
    if (apiCallingState.sendEmoji) return;
    
    if (gameState.chatTargetId) {
        currentEmojiNpcId = gameState.chatTargetId;
    }
    openEmojiModal();
}


function selectEmoji(emojiData) {
    closeEmojiModal();
    
    // 处理新的数据结构：如果是对象，提取image和description字段
    const emojiImage = typeof emojiData === 'string' ? emojiData : emojiData.image;
    const emojiDescription = typeof emojiData === 'object' && emojiData.description ? emojiData.description : null;
    
    if (!emojiImage) {
        console.error('表情包图片数据无效');
        apiCallingState.sendEmoji = false;
        setMenuLoading('menu-emoji', false);
        return;
    }
    
    // 检查是否在群聊中
    if (currentGroupId) {
        // 群聊场景
        const group = gameState.groups.find(g => g.id === currentGroupId);
        if (group) {
            const timeNames = ["早", "中", "晚"];
            const msg = {
                id: Date.now(),
                author: gameState.player.name,
                content: emojiDescription || '[表情包]',
                image: emojiImage,
                time: `${gameState.world.month}月${gameState.world.day}日 ${timeNames[gameState.world.timeOfDay]}`
            };
            group.messages.push(msg);
            renderGroupChat();
        }
        apiCallingState.sendEmoji = false;
        setMenuLoading('group-menu-emoji', false);
        currentEmojiNpcId = null;
        return;
    }
    
    // 优先使用currentEmojiNpcId，如果没有则使用gameState.chatTargetId
    const targetNpcId = currentEmojiNpcId || gameState.chatTargetId;
    
    if (targetNpcId) {
        const npc = gameState.npcs.find(n => n.id === targetNpcId);
        if (npc) {
            // 如果当前不在聊天界面，先打开聊天
            if (gameState.chatTargetId !== targetNpcId) {
                startChat(npc);
                setTimeout(() => {
                    // 发送表情包图片（从用户视角，右侧显示）
                    addMessageToUI('', 'user', emojiImage, false, emojiDescription);
                    // 保存到聊天历史
                    const currentDate = new Date().toISOString();
                    const historyText = emojiDescription ? `${emojiDescription} [发送表情包]` : '[发送表情包]';
                    npc.history.push(`[${currentDate}] ${gameState.player.name}: ${historyText}`);
                    // 增加好感度
                    npc.affection += 2;
                    if (npc.affection > 100) npc.affection = 100;
                    if (document.getElementById('chat-affection')) {
                        document.getElementById('chat-affection').innerText = `好感: ${npc.affection}`;
                    }
                }, 100);
            } else {
                // 已经在聊天界面中，直接发送
                addMessageToUI('', 'user', emojiImage, false, emojiDescription);
                // 保存到聊天历史
                const currentDate = new Date().toISOString();
                const historyText = emojiDescription ? `${emojiDescription} [发送表情包]` : '[发送表情包]';
                npc.history.push(`[${currentDate}] ${gameState.player.name}: ${historyText}`);
                // 增加好感度
                npc.affection += 2;
                if (npc.affection > 100) npc.affection = 100;
                if (document.getElementById('chat-affection')) {
                    document.getElementById('chat-affection').innerText = `好感: ${npc.affection}`;
                }
            }
        }
    } else {
        // 如果没有目标NPC，仍然显示表情包（可能是在其他场景）
        addMessageToUI('', 'user', emojiImage, false, emojiDescription);
    }
    
    apiCallingState.sendEmoji = false;
    setMenuLoading('menu-emoji', false);
    currentEmojiNpcId = null;
}

function sendImageFromChat() {
    if (apiCallingState.sendImage) return;
    
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (!npc) {
        alert("请先选择一个对话对象！");
        return;
    }
    
    // 关闭菜单
    document.getElementById('chat-plus-menu').classList.remove('show');
    
    // 打开发送图片弹窗
    openSendImageModal();
}

// 打开发送图片弹窗
function openSendImageModal() {
    const modal = document.getElementById('send-image-modal');
    if (modal) {
        modal.style.display = 'flex';
        // 重置表单
        document.getElementById('send-image-description-input').value = '';
        document.getElementById('send-image-file-input').value = '';
        document.getElementById('send-image-preview').style.display = 'none';
    }
}

// 关闭发送图片弹窗
function closeSendImageModal() {
    const modal = document.getElementById('send-image-modal');
    if (modal) {
        modal.style.display = 'none';
        // 重置表单
        document.getElementById('send-image-description-input').value = '';
        document.getElementById('send-image-file-input').value = '';
        document.getElementById('send-image-preview').style.display = 'none';
    }
    pendingSendImageBlob = null; // 清除压缩后的图片
    apiCallingState.sendImage = false;
    setMenuLoading('menu-image', false);
}

// 处理图片文件选择
async function handleSendImageFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        try {
            // 压缩图片
            const compressedBlob = await compressImage(file, 1200, 1200, 0.85);
            pendingSendImageBlob = compressedBlob; // 保存压缩后的Blob
            const compressedDataUrl = await blobToBase64(compressedBlob);
            const preview = document.getElementById('send-image-preview');
            const previewImg = document.getElementById('send-image-preview-img');
            if (preview && previewImg) {
                previewImg.src = compressedDataUrl;
                preview.style.display = 'block';
            }
        } catch (error) {
            console.error('图片压缩失败:', error);
            pendingSendImageBlob = null;
            // 如果压缩失败，使用原图
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('send-image-preview');
                const previewImg = document.getElementById('send-image-preview-img');
                if (preview && previewImg) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }
    }
}

let pendingSendImageBlob = null; // 保存压缩后的图片Blob

// 确认发送图片
async function confirmSendImage() {
    const fileInput = document.getElementById('send-image-file-input');
    const descriptionInput = document.getElementById('send-image-description-input');
    
    if (!fileInput.files || !fileInput.files[0]) {
        alert('请先选择一张图片！');
        return;
    }
    
    const file = fileInput.files[0];
    const description = descriptionInput.value.trim();
    
    try {
        let imageData;
        // 如果已经有压缩后的Blob，使用它；否则压缩原文件
        if (pendingSendImageBlob) {
            imageData = await blobToBase64(pendingSendImageBlob);
        } else {
            const compressedBlob = await compressImage(file, 1200, 1200, 0.85);
            imageData = await blobToBase64(compressedBlob);
        }
        
        // 检查是否在群聊中
        if (currentGroupId) {
            // 群聊场景
            const group = gameState.groups.find(g => g.id === currentGroupId);
            if (group) {
                const timeNames = ["早", "中", "晚"];
                const msg = {
                    id: Date.now(),
                    author: gameState.player.name,
                    content: description || '[图片]',
                    image: imageData,
                    time: `${gameState.world.month}月${gameState.world.day}日 ${timeNames[gameState.world.timeOfDay]}`
                };
                group.messages.push(msg);
                renderGroupChat();
            }
            pendingSendImageBlob = null;
            closeSendImageModal();
            return;
        }
        
        // 发送图片到聊天界面（从用户视角，右侧显示）
        const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
        if (npc) {
            // 发送图片，描述作为参数传递但不显示文本
            addMessageToUI('', 'user', imageData, false, description || null);
            
            // 保存到聊天历史
            const currentDate = new Date().toISOString();
            const historyText = description ? `${description} [发送图片]` : '[发送图片]';
            npc.history.push(`[${currentDate}] ${gameState.player.name}: ${historyText}`);
            
            pendingSendImageBlob = null;
            // 增加好感度
            npc.affection += 2;
            if (npc.affection > 100) npc.affection = 100;
            if (document.getElementById('chat-affection')) {
                document.getElementById('chat-affection').innerText = `好感: ${npc.affection}`;
            }
        } else {
            // 如果没有目标NPC，仍然显示图片
            addMessageToUI('', 'user', imageData, false, description || null);
        }
        
        // 关闭弹窗
        pendingSendImageBlob = null;
        closeSendImageModal();
    } catch (error) {
        console.error('发送图片失败:', error);
        alert('发送图片失败，请重试');
        pendingSendImageBlob = null;
    }
}

function sendImage(npcId) {
    // 保留用于兼容
    const npc = gameState.npcs.find(n => n.id === npcId);
    if (!npc) return;
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                startChat(npc);
                setTimeout(() => {
                    document.getElementById('chat-input').value = `[分享图片: ${file.name}]`;
                    sendMessage();
                }, 100);
            };
            reader.readAsDataURL(file);
        }
    };
    input.click();
}

function sendGiftFromChat(e) {
    // 阻止默认行为和事件冒泡
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (!npc) {
        alert("请先选择一个对话对象！");
        return false;
    }
    
    // 关闭菜单
    const menu = document.getElementById('chat-plus-menu');
    if (menu) {
        menu.classList.remove('show');
    }
    
    // 打开礼物界面弹窗
    openGiftShop();
    
    return false;
}

function sendGift(npcId) {
    // 保留用于兼容
    const npc = gameState.npcs.find(n => n.id === npcId);
    if (!npc) return;
    
    const gifts = ["玉佩", "香囊", "手帕", "发簪", "胭脂", "茶叶", "糕点", "花束"];
    const gift = gifts[Math.floor(Math.random() * gifts.length)];
    
    startChat(npc);
    setTimeout(() => {
        document.getElementById('chat-input').value = `[赠送礼物: ${gift}]`;
        sendMessage();
        npc.affection += 10;
        document.getElementById('chat-affection').innerText = `好感: ${npc.affection}`;
    }, 100);
}

// 搜索商品
async function searchShop(keyword = null) {
    const query = keyword || document.getElementById('shop-search-input').value || '精美礼品';
    const grid = document.getElementById('shop-grid');
    grid.innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.6);">🔍 正在搜罗天下好物...</div>';

    // 尝试调用 API 生成商品
    let items = [];
    
    // 模拟延迟
    await new Promise(r => setTimeout(r, 800));
    
    // 基于关键词的模拟数据生成器
    items = generateMockGoods(query);
    
    renderShopItems(items);
}

// 生成模拟商品数据
function generateMockGoods(query) {
    const prefixes = ["皇家", "御用", "西域", "江南", "百年", "精致", "限量"];
    const suffixes = ["礼盒", "特供", "珍藏版", "套装"];
    const emojis = ["🎁", "💄", "💍", "🍰", "🍵", "🌸", "🧸", "📱", "💎", "🎨"];
    
    let baseItems = [];
    if(query.includes("吃") || query.includes("糕") || query.includes("食")) {
        baseItems = ["桂花糕", "龙须酥", "桃花酿", "叫花鸡", "燕窝粥", "蜜饯", "茶点"];
    } else if(query.includes("穿") || query.includes("衣") || query.includes("服")) {
        baseItems = ["云锦织物", "苏绣手帕", "金丝软烟罗", "翡翠步摇", "丝绸", "锦缎"];
    } else if(query.includes("热门") || query.includes("礼物") || query.includes("礼")) {
        baseItems = ["玉佩", "香囊", "手帕", "发簪", "胭脂", "茶叶", "糕点", "花束", "珠宝", "字画"];
    } else {
        baseItems = [query, query+"Pro", query+" Max", "金镶玉"+query, "琉璃"+query];
    }

    let results = [];
    for(let i=0; i<10; i++) {
        const base = baseItems[Math.floor(Math.random()*baseItems.length)];
        const name = prefixes[Math.floor(Math.random()*prefixes.length)] + base + (Math.random()>0.5 ? suffixes[Math.floor(Math.random()*suffixes.length)] : "");
        results.push({
            name: name,
            price: Math.floor(Math.random() * 500) + 50,
            desc: `销量 ${Math.floor(Math.random()*10000)}+ | 好评率 99%`,
            emoji: emojis[Math.floor(Math.random()*emojis.length)]
        });
    }
    return results;
}

// 渲染商品列表
function renderShopItems(items) {
    const grid = document.getElementById('shop-grid');
    grid.innerHTML = '';
    
    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'shop-item';
        div.onclick = () => buyAndSendGift(item);
        div.innerHTML = `
            <div class="shop-img-placeholder">${item.emoji}</div>
            <div class="shop-info">
                <div>
                    <div class="shop-title">${item.name}</div>
                    <div class="shop-desc">${item.desc}</div>
                </div>
                <div class="shop-price-row">
                    <div class="shop-price">${item.price}</div>
                    <div class="shop-sales">月销${Math.floor(Math.random()*5000)}</div>
                </div>
            </div>
        `;
        grid.appendChild(div);
    });
}

// 购买并发送礼物
function buyAndSendGift(item) {
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (!npc) {
        alert("请先选择一个对话对象！");
        return;
    }
    
    // 返回聊天界面
    goToPage('page-chat');
    
    var gs = (npc && npc.giftCardStyle) ? npc.giftCardStyle : (gameState.giftCardStyle || {});
    var cardStyle = '';
    if (gs.background) cardStyle += 'background:' + gs.background + ';';
    if (gs.color) cardStyle += 'color:' + gs.color + ';';
    if (gs.borderRadius !== undefined) cardStyle += 'border-radius:' + (typeof gs.borderRadius === 'number' ? gs.borderRadius + 'px' : gs.borderRadius) + ';';
    if (gs.padding !== undefined) cardStyle += 'padding:' + (typeof gs.padding === 'number' ? gs.padding + 'px' : gs.padding) + ';';
    if (gs.border) cardStyle += 'border:' + gs.border + ';';
    const cardHtml = `
        <div class="msg-gift-card"${cardStyle ? ' style="' + cardStyle + '"' : ''}>
            <div class="gift-card-header">
                <div class="gift-card-icon">礼</div>
                <div class="gift-card-label">宫廷特惠</div>
            </div>
            <div class="gift-card-body">
                <div class="gift-card-img">${item.emoji}</div>
                <div class="gift-card-content">
                    <div class="gift-card-title">${item.name}</div>
                    <div class="gift-card-price">¥${item.price}</div>
                </div>
            </div>
        </div>
    `;
    
    // 显示在UI (右侧)
    const box = document.getElementById('chat-box');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message msg-user';
    var userBubble = (npc && npc.chatBubbleStyleUser) ? npc.chatBubbleStyleUser : gameState.chatBubbleStyleUser;
    if (userBubble) applyBubbleStyleToElement(msgDiv, userBubble);
    msgDiv.innerHTML = cardHtml;
    box.appendChild(msgDiv);
    box.scrollTop = box.scrollHeight;

    // 增加好感度
    const bonus = Math.floor(item.price / 10) + 5;
    npc.affection += bonus;
    if (npc.affection > 100) npc.affection = 100;
    document.getElementById('chat-affection').innerText = `好感: ${npc.affection}`;
    
    // 保存到历史记录
    const currentDate = new Date().toISOString();
    npc.history.push(`[${currentDate}] ${gameState.player.name}: [赠送礼物: ${item.name}，价值${item.price}银两]`);
    
    // 触发AI回复
    setTimeout(() => {
        const originalVal = document.getElementById('chat-input').value;
        document.getElementById('chat-input').value = `[我送了你一份礼物：${item.name}，价值${item.price}银两]`;
        sendMessageWithAPI();
        document.getElementById('chat-input').value = "";
    }, 300);
}

let currentMoneyTransferNpc = null;
let currentMoneyTransferContext = 'chat'; // 'chat' or 'direct'

function sendMoneyFromChat() {
    if (apiCallingState.sendMoney) return;
    apiCallingState.sendMoney = true;
    setMenuLoading('menu-money', true);
    
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (!npc) {
        apiCallingState.sendMoney = false;
        setMenuLoading('menu-money', false);
        return;
    }
    
    const currentMoney = gameState.player.stats.money;
    
    if (currentMoney <= 0) {
        alert(`银两不足！当前银两：${currentMoney}两`);
        apiCallingState.sendMoney = false;
        setMenuLoading('menu-money', false);
        document.getElementById('chat-plus-menu').classList.remove('show');
        return;
    }
    
    currentMoneyTransferNpc = npc;
    currentMoneyTransferContext = 'chat';
    openMoneyTransferModal();
    document.getElementById('chat-plus-menu').classList.remove('show');
}

function openMoneyTransferModal() {
    const currentMoney = gameState.player.stats.money;
    const maxAmount = Math.min(currentMoney, 1000);
    
    document.getElementById('money-transfer-current').textContent = `${currentMoney}两`;
    document.getElementById('money-transfer-max').textContent = `最多可转${maxAmount}两`;
    document.getElementById('money-transfer-amount').value = '';
    document.getElementById('money-transfer-amount').max = maxAmount;
    
    document.getElementById('money-transfer-modal').style.display = 'flex';
}

function setTransferAmount(ratio) {
    const currentMoney = gameState.player.stats.money;
    const maxAmount = Math.min(currentMoney, 1000);
    const amount = Math.floor(maxAmount * ratio);
    document.getElementById('money-transfer-amount').value = amount;
}

function confirmMoneyTransfer() {
    if (!currentMoneyTransferNpc) {
        closeMoneyTransferModal();
        return;
    }
    
    const amountInput = document.getElementById('money-transfer-amount').value;
    if (!amountInput || isNaN(amountInput) || parseInt(amountInput) <= 0) {
        alert("请输入有效的金额！");
        return;
    }
    
    const moneyAmount = parseInt(amountInput);
    const currentMoney = gameState.player.stats.money;
    const maxAmount = Math.min(currentMoney, 1000);
    
    if (moneyAmount > currentMoney) {
        alert(`银两不足！\n当前银两：${currentMoney}两\n需要：${moneyAmount}两`);
        return;
    }
    
    if (moneyAmount > maxAmount) {
        alert(`单次转账不能超过${maxAmount}两！`);
        return;
    }
    
    const note = document.getElementById('money-transfer-note').value.trim() || '';
    
    gameState.player.stats.money -= moneyAmount;
    currentMoneyTransferNpc.affection += Math.floor(moneyAmount / 10);
    
    // 保存转账消息到历史记录
    const currentDate = new Date().toISOString();
    const noteText = note ? ` ${note}` : '';
    currentMoneyTransferNpc.history.push(`[${currentDate}] ${gameState.player.name}: [转账银两: ${moneyAmount}两${noteText}]`);
    
    // 直接显示转账卡片，不再发送文字消息
    if (currentMoneyTransferContext === 'chat') {
        sendMoneyCard(moneyAmount, 'user', gameState.player.name, currentMoneyTransferNpc.name, null, note);
        document.getElementById('chat-affection').innerText = `好感: ${currentMoneyTransferNpc.affection}`;
        updateDashboard();
        
        apiCallingState.sendMoney = false;
        setMenuLoading('menu-money', false);
    } else {
        startChat(currentMoneyTransferNpc);
        setTimeout(() => {
            sendMoneyCard(moneyAmount, 'user', gameState.player.name, currentMoneyTransferNpc.name, null, note);
            document.getElementById('chat-affection').innerText = `好感: ${currentMoneyTransferNpc.affection}`;
            updateDashboard();
        }, 100);
    }
    
    closeMoneyTransferModal();
}

function closeMoneyTransferModal() {
    document.getElementById('money-transfer-modal').style.display = 'none';
    document.getElementById('money-transfer-note').value = '';
    currentMoneyTransferNpc = null;
    currentMoneyTransferContext = 'chat';
}

function sendMoney(npcId) {
    // 保留用于兼容
    const npc = gameState.npcs.find(n => n.id === npcId);
    if (!npc) return;
    
    const currentMoney = gameState.player.stats.money;
    
    if (currentMoney <= 0) {
        alert(`银两不足！当前银两：${currentMoney}两`);
        return;
    }
    
    currentMoneyTransferNpc = npc;
    currentMoneyTransferContext = 'direct';
    openMoneyTransferModal();
}

function sendMessage() {
    const inputEl = document.getElementById('chat-input');
    const msg = inputEl.value.trim();
    if (!msg) return;
    
    // 只显示用户消息，不调用API
    const q = getQuoteState('chat');
    inputEl.value = '';
    clearQuote('chat');
    
    // 保存到历史记录（但不保存NPC回复，因为还没有调用API）
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (npc) {
        const currentDate = new Date().toISOString();
        const marker = q ? encodeQuoteMarker(q) : '';
        npc.history.push(`[${currentDate}] ${gameState.player.name}: ${marker}${msg}`);
        const idx = npc.history.length - 1;
        addMessageToUI(msg, 'user', null, false, null, q, { historyIndex: idx });
    }
}

async function sendMessageWithAPI() {
    // 获取小鱼板按钮（在函数开始处定义，确保所有地方都能访问）
    const fishBtn = document.querySelector('#page-chat button[onclick="sendMessageWithAPI()"]');
    
    // 如果正在调用API，则取消调用
    if (apiCallingState.sendMessage) {
        if (currentAbortController) {
            currentAbortController.abort();
            currentAbortController = null;
        }
        apiCallingState.sendMessage = false;
        // 移除呼吸动画
        if (fishBtn) {
            fishBtn.classList.remove('breathing');
        }
        // 移除loading消息
        const loadingMsg = document.querySelector('.message.breathing');
        if (loadingMsg) {
            loadingMsg.classList.remove('breathing');
            loadingMsg.remove();
        }
        return;
    }
    
    // 立即设置状态标志，防止重复调用（修复竞态条件）
    apiCallingState.sendMessage = true;
    
    const rerollOpts = (typeof arguments[0] === 'object' && arguments[0]) ? arguments[0] : null;
    const isReroll = !!(rerollOpts && rerollOpts.reroll && rerollOpts.messageToSend !== undefined);
    let messageToSend;
    
    if (isReroll) {
        messageToSend = String(rerollOpts.messageToSend || '');
    } else {
        const inputEl = document.getElementById('chat-input');
        const msg = inputEl.value.trim();
        
        // 点击小鱼板时检测输入是否涉及性/R18：若当前对话对象为异性则弹窗（同意/拒绝）
        const npcForCheck = gameState.chatTargetId ? gameState.npcs.find(n => n.id === gameState.chatTargetId) : null;
        const playerGender = (gameState.player && gameState.player.gender) || '女';
        if (msg && npcForCheck && !npcForCheck.isChild && npcForCheck.gender !== playerGender) {
            const sexualKeywords = /性|做爱|云雨|肌肤之亲|床笫|侍寝|行房|同房|r18|R18|十八禁|房事|圆房|鱼水之欢|欢好/i;
            if (sexualKeywords.test(msg)) {
                apiCallingState.sendMessage = false;
                const willing = (npcForCheck.affection || 0) >= 50 && Math.random() < 0.6;
                if (!willing) {
                    alert("对方并无此意，话题未再深入。");
                    return;
                }
                sexTopicNpcId = npcForCheck.id;
                document.getElementById('sex-topic-confirm-msg').textContent = npcForCheck.name + " 有意与你有肌肤之亲，是否同意？";
                const m = document.getElementById('sex-topic-confirm-modal');
                m.style.display = 'flex';
                m.style.alignItems = 'center';
                m.style.justifyContent = 'center';
                return;
            }
        }
        
        messageToSend = msg.trim();
        
        // 检查所有用户消息，找到最近发送的图片消息（不是最后一条，而是最近发送的图片）
        const allUserMsgs = document.querySelectorAll('.message.msg-user');
        let imageData = null;
        let imageDescription = null;
        let recentImageMsg = null;
        
        for (let i = allUserMsgs.length - 1; i >= 0; i--) {
            const mItem = allUserMsgs[i];
            const imgElement = mItem.querySelector('.message-img');
            if (imgElement) {
                imageData = imgElement.src;
                imageDescription = imgElement.getAttribute('data-description');
                recentImageMsg = mItem;
                break;
            }
        }
        
        if (!messageToSend) {
            if (imageData && imageDescription) {
                messageToSend = imageDescription;
            } else if (imageData) {
                messageToSend = "[发送了一张图片]";
            } else {
                const lastUserMsg = document.querySelector('.message.msg-user:last-child');
                if (lastUserMsg && !lastUserMsg.querySelector('.message-img')) {
                    messageToSend = lastUserMsg.textContent.trim();
                }
            }
            if (!messageToSend) {
                messageToSend = "";
            }
        } else {
            const q = getQuoteState('chat');
            clearQuote('chat');
            const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
            if (npc) {
                const currentDate = new Date().toISOString();
                if (imageData && imageDescription) {
                    npc.history.push(`[${currentDate}] ${gameState.player.name}: ${imageDescription} [发送图片]`);
                } else {
                    const marker = q ? encodeQuoteMarker(q) : '';
                    npc.history.push(`[${currentDate}] ${gameState.player.name}: ${marker}${messageToSend}`);
                }
                const idx = npc.history.length - 1;
                addMessageToUI(messageToSend, 'user', null, false, null, q, { historyIndex: idx });
            }
            inputEl.value = '';
        }
    }
    
    // 创建AbortController用于取消请求
    currentAbortController = new AbortController();
    
    // 更新小鱼板按钮状态（添加呼吸动画）
    if (fishBtn) {
        fishBtn.classList.add('breathing');
    }
    
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (!npc) {
        apiCallingState.sendMessage = false;
        currentAbortController = null;
        // 移除小鱼板按钮的呼吸动画
        if (fishBtn) {
            fishBtn.classList.remove('breathing');
        }
        return;
    }
    
    // 心理状态与日记已合并到本次对话API的同一回复中，不再单独请求
    
    // 构建 Prompt
    if (!settings.apiKey) {
        addMessageToUI("【系统】请先在右上角设置中配置API Key才能进行AI对话。", "sys");
        apiCallingState.sendMessage = false;
        currentAbortController = null;
        // 移除小鱼板按钮的呼吸动画
        if (fishBtn) {
            fishBtn.classList.remove('breathing');
        }
        return;
    }

    // 根据记忆设置获取历史消息
    // memoryCount设置为0表示使用所有对话记录，否则只使用NPC回复的最近N条
    let historyMessages = [];
    if (npc.history && npc.history.length > 0) {
        const memoryCount = gameState.memorySettings[npc.id] !== undefined ? gameState.memorySettings[npc.id] : 100;
        if (memoryCount === 0) {
            // 使用所有对话记录（永久保存）
            historyMessages = npc.history;
        } else {
            // 只取NPC回复的最近N条
            const npcReplies = npc.history.filter(msg => msg.includes(`${npc.name}:`));
            historyMessages = npcReplies.slice(-memoryCount);
        }
    }
    
    const recentHistory = historyMessages.join("\n");
    
    // 获取该NPC参与的群聊记录
    let groupChatMemory = '';
    gameState.groups.forEach(group => {
        if (group.memberIds.includes(npc.id) && group.messages && group.messages.length > 0) {
            const memoryCount = gameState.groupMemorySettings && gameState.groupMemorySettings[group.id] !== undefined 
                ? gameState.groupMemorySettings[group.id] 
                : 100;
            let groupMessages = [];
            if (memoryCount === 0) {
                groupMessages = group.messages;
            } else {
                groupMessages = group.messages.slice(-memoryCount);
            }
            const groupChat = groupMessages.map(m => `${m.author}: ${m.content || ''}`).join('\n');
            if (groupChat) {
                groupChatMemory += `群聊"${group.name}"的记录：\n${groupChat}\n\n`;
            }
        }
    });
    
    // 获取该NPC参与的动态圈记录
    let socialCircleMemory = '';
    // 获取所有动态（包括默认动态圈和特定动态圈）
    const allPosts = getAllPosts();
    // 筛选出该NPC参与的动态圈中的动态
    const npcPosts = allPosts.filter(post => {
        // 如果动态是NPC发的，或者NPC在动态圈中
        if (post.author === npc.name) return true;
        // 检查NPC是否在动态圈中
        if (post.circleId === null) {
            // 默认动态圈，所有NPC都在
            return true;
        } else {
            // 特定动态圈
            const circle = gameState.socialCircles.find(c => c.id === post.circleId);
            if (circle && circle.members && circle.members.includes(npc.id)) {
                return true;
            }
        }
        return false;
    });
    
    if (npcPosts.length > 0) {
        // 只取最近的动态
        const recentPosts = npcPosts.slice(-10);
        socialCircleMemory = `你参与的动态圈中的最近动态：\n${recentPosts.map(p => `${p.author}: ${p.content || '[图片]'}${p.commentsList && p.commentsList.length > 0 ? '\n评论：' + p.commentsList.map(c => `${c.author}: ${c.content}`).join('\n') : ''}`).join('\n\n')}`;
    }
    
    let npcEncounterMemory = '';
    if (npc.npcMemory && npc.npcMemory.length > 0) {
        const recentEnc = npc.npcMemory.slice(-5).map(function(e) {
            var storyExcerpt = (e.story || '').substring(0, 180);
            if ((e.story || '').length > 180) storyExcerpt += '…';
            return (e.date || '') + ' ' + (e.location || '') + '：' + storyExcerpt;
        }).join('\n');
        if (recentEnc) npcEncounterMemory = recentEnc;
    }
    let recentPlotSummary = '';
    const recentChoices = (gameState.player.choices || []).slice(-5);
    const recentDaily = (gameState.player.dailyStories || []).slice(-2);
    if (recentChoices.length > 0 || recentDaily.length > 0) {
        var parts = [];
        recentChoices.forEach(function(c) {
            parts.push('【' + (c.locationName || '某地') + '】' + (c.choice || '').substring(0, 200));
        });
        recentDaily.forEach(function(d) {
            parts.push('【休息剧情】' + (d.content || '').substring(0, 200));
        });
        if (parts.length) recentPlotSummary = parts.join('\n');
    }
    
    const effPsych = getEffectivePsych(npc);
    const effDiary = getEffectiveDiary(npc);
    const systemPrompt = `
    你正在扮演一个基于文本的角色扮演游戏中的NPC。
    你的名字是${npc.name}，身份是${gameState.world.dynasty}朝的${npc.role}。
    你的性格是：${npc.personality}。
    玩家（对话对象/自身）：${getPlayerContextForAPI()}
    当前好感度：${npc.affection}/100。
    ${effPsych ? `你当前的心理状态（供参考）：${effPsych}\n` : ''}${effDiary ? `你近期的日记（供参考）：${effDiary}\n` : ''}${getStylePresetPrompt()}${getAntiBaguguPrompt()}
    规则：
    1. 请完全沉浸在角色中，用符合中国古代宫廷风格的口语回答（文言文与白话结合）。
    2. 禁止使用AI助手的语气（如“我能为您做什么”），禁止出戏。
    3. 根据好感度决定态度。好感低时冷淡或礼貌，好感高时亲密或暧昧。
    4. 回复长度自由，可以是一句话，也可以是多句话。根据对话内容和情绪自然决定回复的长度和句数，不要有固定的字数或句数限制。
    5. 这是一个泛性恋游戏，无论玩家性别，如果对方调情且好感度足够，你可以接受并回应暧昧。
    
    ${recentHistory ? `你与${gameState.player.name}的私聊记忆：
    ${recentHistory}
    
    ` : ''}${npcEncounterMemory ? `你在地图剧情中的近期遭遇（与玩家或宫中发生的事，对话时可自然提及或回应）：
    ${npcEncounterMemory}
    
    ` : ''}${recentPlotSummary ? `近期世界中发生的剧情（踩地图、休息剧情等，你可据此与玩家对话时提及或回应）：
    ${recentPlotSummary}
    
    ` : ''}${groupChatMemory ? `你参与的群聊记录：
    ${groupChatMemory}
    
    ` : ''}${socialCircleMemory ? `你参与的动态圈中的动态：
    ${socialCircleMemory}
    
    ` : ''}6. **重要：你可以参考上述私聊记忆、地图遭遇记忆、近期剧情、群聊与动态圈记录，来了解与${gameState.player.name}及宫中发生的事，这些记忆需互通并影响你的回复。**
7. **输出格式**：只输出角色说的台词（即角色口中说出的原话），不要用引号包裹，不要输出旁白、心理描写、动作说明或任何非台词内容；心理与日记仅放在末尾JSON中。先写你的对话回复（长度自由），回复结束后换行，再单独一行输出一个JSON：{"psychologicalState":"50-150字当前心理状态","diary":"80-200字第一人称日记"}。玩家界面只展示你的台词部分。
    `;

    // 如果messageToSend为空，让NPC主动说话
    const userMessage = messageToSend ? `${gameState.player.name}说：${messageToSend}` : `${gameState.player.name}静静地等待着${npc.name}的反应`;

    addMessageToUI("...", "npc"); // Loading placeholder
    const loadingMsg = document.querySelector('.message:last-child');
    // 添加呼吸动画
    if (loadingMsg) {
        loadingMsg.classList.add('breathing');
        loadingMsg.style.cssText += "opacity:0.6;transition:all 0.3s;";
    }

    try {
        // 构建消息内容
        let userMessageContent = userMessage;
        
        // 如果API支持图片输入（如GPT-4 Vision），可以添加图片
        // 检查模型是否支持视觉功能（简单判断，可以根据实际情况调整）
        const visionModels = ['gpt-4-vision', 'gpt-4o', 'gpt-4-turbo', 'claude-3', 'claude-3-opus', 'claude-3-sonnet'];
        const isVisionModel = visionModels.some(vm => settings.model.toLowerCase().includes(vm.toLowerCase()));
        
        let messages = [
            { role: "system", content: systemPrompt }
        ];
        
        if (imageData && isVisionModel) {
            // 支持图片的API格式
            messages.push({
                role: "user",
                content: [
                    { type: "text", text: userMessage },
                    { type: "image_url", image_url: { url: imageData } }
                ]
            });
        } else {
            // 不支持图片的API，使用文本描述
            if (imageDescription) {
                // 如果有图片描述，将其包含在消息中
                userMessageContent = `${gameState.player.name}发送了一张图片，图片描述是：${imageDescription}。${userMessage}`;
            } else if (imageData) {
                // 如果没有描述但有图片，提示需要描述
                userMessageContent = `${gameState.player.name}发送了一张图片（但未提供描述）。${userMessage}`;
            }
            messages.push({ role: "user", content: userMessageContent });
        }
        
        const response = await fetch(`${settings.apiUrl}/chat/completions`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${settings.apiKey}`
            },
            body: JSON.stringify({
                model: settings.model,
                messages: messages,
                temperature: 0.8,
                max_tokens: 1000
            }),
            signal: currentAbortController.signal
        });

        // 检查响应状态
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: { message: `HTTP ${response.status}: ${response.statusText}` } }));
            const errorMessage = errorData.error?.message || errorData.message || `HTTP ${response.status}: ${response.statusText}`;
            throw new Error(errorMessage);
        }
        
        const data = await response.json();
        
        // 检查API返回的错误
        if (data.error) {
            throw new Error(data.error.message || 'API返回错误');
        }
        
        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error('API返回数据格式错误');
        }
        
        let reply = data.choices[0].message.content;

        // 解析末尾的心理状态与日记JSON（同一次API返回），避免额外请求
        const jsonMatch = reply.match(/\n\s*(\{[\s\S]*\})\s*$/);
        if (jsonMatch) {
            try {
                const obj = JSON.parse(jsonMatch[1]);
                if (obj && (obj.psychologicalState != null || obj.diary != null)) {
                    pushPsychDiaryToHistory(npc, obj.psychologicalState, obj.diary);
                    refreshPsychologyDiaryModalIfOpen(npc.id);
                    reply = reply.slice(0, jsonMatch.index).trim();
                }
            } catch (e) { /* 解析失败则忽略 */ }
        }

        // 人脉消息只展示角色说的话：去掉旁白/心理（）、"" 与首尾引号
        reply = (reply || '').replace(/（[^）]*）/g, '').replace(/\([^)]*\)/g, '').replace(/\s{2,}/g, ' ').trim();
        reply = reply.replace(/""+/g, ' ').trim();
        if (/^[""]/.test(reply)) reply = reply.replace(/^[""]+/, '').trim();
        if (/[""]$/.test(reply)) reply = reply.replace(/[""]+$/, '').trim();
        if (!reply) reply = '（沉默）';
        
        // 移除Loading（移除呼吸动画）
        if (loadingMsg) {
            loadingMsg.classList.remove('breathing');
            loadingMsg.remove();
        }
        
        // 移除小鱼板按钮的呼吸动画
        if (fishBtn) {
            fishBtn.classList.remove('breathing');
        }
        
        // 拆句并过滤空句、仅引号句，每句去掉首尾引号
        var segments = reply.split(/(?<=[。！？!?；;])\s*|\n+/).map(function(s) {
            s = s.trim();
            s = s.replace(/^[""]+/, '').replace(/[""]+$/, '').trim();
            return s;
        }).filter(function(s) { return s.length > 0 && s.replace(/[""\s\u3000]/g, '').length > 0; });
        if (segments.length === 0) segments = [reply.replace(/^[""]+/, '').replace(/[""]+$/, '').trim() || '（沉默）'];
        // 把仅含右括号/收尾标点的片段合并到上一句
        var merged = [];
        for (var i = 0; i < segments.length; i++) {
            if (merged.length && /^[\s）\)\]】〕〉」』]*$/.test(segments[i])) {
                merged[merged.length - 1] = merged[merged.length - 1] + segments[i];
            } else {
                merged.push(segments[i]);
            }
        }
        segments = merged;
        var currentDateForHistory = new Date().toISOString();
        segments.forEach(function(seg, i) {
            addMessageToUI(seg, 'npc', null, false, null, null, { playNotification: i === 0 });
        });
        
        // NPC根据话题发送表情包（30%概率，且需要开启表情包功能）
        if (npc.canSendEmoji !== false && emojiStore.length > 0 && Math.random() < 0.3) {
            let selectedEmoji = null;
            const replyLower = reply.toLowerCase();
            
            // 根据回复内容的话题匹配表情包描述
            const topicMatches = {
                '开心': ['开心', '高兴', '快乐', '愉快', '笑', '哈哈'],
                '害羞': ['害羞', '脸红', '不好意思', '羞'],
                '生气': ['生气', '愤怒', '气', '恼'],
                '难过': ['难过', '伤心', '哭', '悲伤'],
                '惊讶': ['惊讶', '吃惊', '意外', '没想到'],
                '喜欢': ['喜欢', '爱', '心动', '爱慕'],
                '感谢': ['谢谢', '感谢', '多谢', '感激']
            };
            
            // 尝试匹配话题
            for (const [topic, keywords] of Object.entries(topicMatches)) {
                if (keywords.some(keyword => replyLower.includes(keyword))) {
                    // 查找匹配描述的表情包
                    const matchingEmojis = emojiStore.filter(emojiData => {
                        const desc = typeof emojiData === 'string' ? '' : (emojiData.description || '');
                        return desc.includes(topic) || keywords.some(k => desc.includes(k));
                    });
                    if (matchingEmojis.length > 0) {
                        selectedEmoji = matchingEmojis[Math.floor(Math.random() * matchingEmojis.length)];
                        break;
                    }
                }
            }
            
            // 如果没有匹配到，随机选择一个表情包
            if (!selectedEmoji && emojiStore.length > 0) {
                selectedEmoji = emojiStore[Math.floor(Math.random() * emojiStore.length)];
            }
            
            // 发送表情包
            if (selectedEmoji) {
                setTimeout(() => {
                    const emojiImage = typeof selectedEmoji === 'string' ? selectedEmoji : selectedEmoji.image;
                    addMessageToUI('', 'npc', emojiImage);
                    const currentDate = new Date().toISOString();
                    npc.history.push(`[${currentDate}] ${npc.name}: [发送表情包]`);
                }, 500 + Math.random() * 1000); // 0.5-1.5秒后发送
            }
        }

        // 保存历史（带日期时间）：按小句分别保存
        const currentDate = new Date().toISOString();
        if (messageToSend) {
            const lastHistory = npc.history[npc.history.length - 1];
            if (!lastHistory || !lastHistory.includes(`${gameState.player.name}: ${messageToSend}`)) {
                npc.history.push(`[${currentDate}] ${gameState.player.name}: ${messageToSend}`);
            }
        }
        segments.forEach(function(seg) {
            npc.history.push(`[${currentDate}] ${npc.name}: ${seg}`);
        });
        
        // 更新好感度和关系 - 根据话题有几率加好感
        if (messageToSend && messageToSend.length > 5) {
            // 判断话题类型，不同话题有不同概率和好感度加成
            let affectionGain = 0;
            let gainChance = 0;
            
            const topicKeywords = {
                '赞美': { keywords: ['美', '漂亮', '好看', '优雅', '气质', '温柔', '聪明'], chance: 0.7, gain: 2 },
                '关心': { keywords: ['累', '辛苦', '注意', '保重', '身体', '健康'], chance: 0.6, gain: 2 },
                '共同话题': { keywords: ['喜欢', '爱好', '兴趣', '一起', '我们'], chance: 0.5, gain: 1 },
                '调情': { keywords: ['想你', '喜欢', '爱', '心动', '特别'], chance: 0.4, gain: 3 },
                '日常': { keywords: ['今天', '天气', '吃饭', '睡觉', '做什么'], chance: 0.3, gain: 1 }
            };
            
            for (const [topic, config] of Object.entries(topicKeywords)) {
                if (config.keywords.some(keyword => messageToSend.includes(keyword))) {
                    if (Math.random() < config.chance) {
                        affectionGain = config.gain;
                        gainChance = config.chance;
                        break;
                    }
                }
            }
            
            // 如果没有匹配到特定话题，随机小概率加1点好感
            if (affectionGain === 0 && Math.random() < 0.3) {
                affectionGain = 1;
            }
            
            if (affectionGain > 0) {
                npc.affection += affectionGain;
                npc.affection = Math.min(100, npc.affection); // 限制最大值
                updateNPCRelationship(npc.id, affectionGain);
                document.getElementById('chat-affection').innerText = `好感: ${npc.affection}`;
            }
        }
        
        // 检查特殊事件
        checkNPCSpecialEvents(npc);
        
        // AI根据性格背景决定是否送礼或送银两（不是每一轮都送）
        // 概率：好感度越高，送礼概率越高；根据性格决定礼物类型
        // 基础概率10%，好感度每10点增加2%，最高30%
        const giftProbability = 0.10 + (Math.floor(npc.affection / 10) * 0.02);
        if (Math.random() < Math.min(giftProbability, 0.30)) { // 10%-30%的概率
            setTimeout(() => {
                npcSendGiftOrMoney(npc, reply);
            }, 1500 + Math.random() * 2500); // 1.5-4秒后发送
        }
        
        // 记录到NPC记忆
        if (messageToSend) {
            npc.npcMemory = npc.npcMemory || [];
            npc.npcMemory.push({
                date: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`,
                action: "聊天",
                content: messageToSend
            });
        }
        
        apiCallingState.sendMessage = false;
        currentAbortController = null;

    } catch (e) {
        // 如果是用户取消，不显示错误
        if (e.name === 'AbortError') {
            // 移除Loading消息和呼吸动画
            if (loadingMsg) {
                loadingMsg.classList.remove('breathing');
                loadingMsg.remove();
            }
            // 移除小鱼板按钮的呼吸动画
            if (fishBtn) {
                fishBtn.classList.remove('breathing');
            }
            apiCallingState.sendMessage = false;
            currentAbortController = null;
            return;
        }
        
        // 移除Loading消息和呼吸动画
        if (loadingMsg) {
            loadingMsg.classList.remove('breathing');
            loadingMsg.remove();
        }
        
        // 移除小鱼板按钮的呼吸动画
        if (fishBtn) {
            fishBtn.classList.remove('breathing');
        }
        
        // 显示错误弹窗
        const errorMessage = e.message || '未知错误';
        showErrorModal('API调用失败：' + errorMessage);
        
        apiCallingState.sendMessage = false;
        currentAbortController = null;
    }
}

function addMessageToUI(text, type, imageData = null, isGiftCard = false, imageDescription = null, quoteData = null, meta = null) {
    const box = document.getElementById('chat-box');
    const div = document.createElement('div');
    div.className = `message msg-${type}`;
    var curNpc = gameState.chatTargetId ? gameState.npcs.find(function(n) { return n.id === gameState.chatTargetId; }) : null;
    if (type === 'user') {
        var userBubble = (curNpc && curNpc.chatBubbleStyleUser) ? curNpc.chatBubbleStyleUser : gameState.chatBubbleStyleUser;
        if (userBubble) applyBubbleStyleToElement(div, userBubble);
    }
    if (type === 'npc' && curNpc && curNpc.chatBubbleStyle) applyBubbleStyleToElement(div, curNpc.chatBubbleStyle);
    
    // 检查是否是礼物消息
    if (text && text.includes('[赠送礼物:')) {
        const giftMatch = text.match(/\[赠送礼物:\s*([^\]]+)\]/);
        if (giftMatch) {
            const giftInfo = giftMatch[1].split('，价值');
            const giftName = giftInfo[0];
            const giftPrice = giftInfo[1] ? parseInt(giftInfo[1].replace('银两', '')) : null;
            sendGiftCard(giftName, giftPrice, '🎁', type);
            return; // 礼物卡片已单独处理
        }
    }
    
    // 检查是否是转账银两消息
    if (text && text.includes('[转账银两:')) {
        // 匹配格式：[转账银两: 100两] 或 [转账银两: 给XXX转账100两] 或 [转账银两: 100两 备注]
        const moneyMatch = text.match(/\[转账银两:\s*(?:给([^\s]+)转账)?\s*(\d+)\s*两\s*(.*?)\]/);
        if (moneyMatch) {
            const recipientName = moneyMatch[1] || null;
            const amount = parseInt(moneyMatch[2]);
            const note = moneyMatch[3] ? moneyMatch[3].trim() : null;
            
            // 显示转账卡片
            sendMoneyCard(amount, type, type === 'npc' ? null : gameState.player.name, recipientName, null, note);
            
            // 处理银两增减
            if (type === 'npc') {
                // NPC转账给玩家 - 自动更新银两
                gameState.player.stats.money += amount;
                updateMoneyDisplay();
            } else if (type === 'user') {
                // 玩家转账给NPC - 扣除银两（如果还没扣除的话）
                // 注意：在confirmMoneyTransfer中已经扣除了，这里只是显示
            }
            
            return; // 转账卡片已单独处理
        }
    }
    
    // 如果是礼物卡片HTML
    if (isGiftCard && typeof text === 'string' && text.includes('msg-gift-card')) {
        div.innerHTML = text;
    } else if (imageData) {
        // 如果是图片消息
        div.classList.add('has-image');
        const img = document.createElement('img');
        img.src = imageData;
        img.className = 'message-img';
        
        // 如果有描述，存储在data属性中，不直接显示
        if (imageDescription) {
            img.setAttribute('data-description', imageDescription);
            img.style.cursor = 'pointer';
            
            // 添加长按事件监听器（支持移动端和桌面端）
            let longPressTimer = null;
            let descriptionTooltip = null;
            
            // 触摸事件（移动端）
            img.addEventListener('touchstart', function(e) {
                e.preventDefault();
                longPressTimer = setTimeout(function() {
                    showImageDescription(img, imageDescription);
                }, 500); // 500ms长按
            });
            
            img.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });
            
            img.addEventListener('touchmove', function(e) {
                e.preventDefault();
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });
            
            // 鼠标事件（桌面端）
            img.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showImageDescription(img, imageDescription);
            });
        }
        
        div.appendChild(img);
        // 不显示文本，只显示图片
    } else {
        // 普通文本消息（支持引用块）
        if (quoteData && quoteData.author && quoteData.text) {
            const q = document.createElement('div');
            q.className = 'msg-quote';
            // 引用可点击跳转（私聊：historyIndex）
            if (quoteData.ref && quoteData.ref.type === 'chat' && Number.isFinite(quoteData.ref.historyIndex)) {
                q.style.cursor = 'pointer';
                q.addEventListener('click', (e) => {
                    e.stopPropagation();
                    scrollToReferencedMessage({ type:'chat', historyIndex: quoteData.ref.historyIndex });
                });
            }
            const qName = document.createElement('div');
            qName.className = 'q-name';
            qName.textContent = quoteData.author;
            const qText = document.createElement('div');
            qText.className = 'q-text';
            qText.textContent = quoteData.text;
            q.appendChild(qName);
            q.appendChild(qText);
            div.appendChild(q);
        }
        const t = document.createElement('div');
        t.style.whiteSpace = 'pre-wrap';
        t.style.wordWrap = 'break-word';
        t.textContent = text;
        div.appendChild(t);
    }
    
    // 添加长按事件（排除系统消息和礼物卡片）
    if (!isGiftCard && type !== 'sys') {
        const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
        const messageData = {
            type: type,
            content: text || (imageData ? '[图片]' : ''),
            author: type === 'user' ? gameState.player.name : (npc?.name || ''),
            image: imageData || null,
            imageDescription: imageDescription || null,
            historyIndex: meta && Number.isFinite(meta.historyIndex) ? meta.historyIndex : undefined
        };
        // 给DOM打标：用于“引用跳转定位”
        if (meta && Number.isFinite(meta.historyIndex)) {
            div.setAttribute('data-history-index', String(meta.historyIndex));
        }
        // 如果是图片消息，给图片元素添加长按事件；否则给div添加
        if (imageData) {
            const imgElement = div.querySelector('.message-img');
            if (imgElement) {
                addLongPressToMessage(imgElement, messageData, 'chat');
            } else {
                addLongPressToMessage(div, messageData, 'chat');
            }
        } else {
            addLongPressToMessage(div, messageData, 'chat');
        }
    }
    
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    
    if (type === 'npc' && meta && meta.playNotification === true) playPrivateNotificationSoundIfNeeded();
}

// 显示图片描述的工具提示
function showImageDescription(imgElement, description) {
    // 移除已存在的工具提示
    const existingTooltip = document.querySelector('.image-description-tooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }
    
    // 创建工具提示
    const tooltip = document.createElement('div');
    tooltip.className = 'image-description-tooltip';
    tooltip.textContent = description;
    document.body.appendChild(tooltip);
    
    // 计算位置
    const rect = imgElement.getBoundingClientRect();
    tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
    tooltip.style.top = rect.top - tooltip.offsetHeight - 10 + 'px';
    
    // 3秒后自动消失，或点击任意位置消失
    const hideTooltip = function() {
        if (tooltip && tooltip.parentNode) {
            tooltip.remove();
        }
    };
    
    setTimeout(hideTooltip, 3000);
    
    // 点击任意位置关闭
    const clickHandler = function(e) {
        hideTooltip();
        document.removeEventListener('click', clickHandler);
        document.removeEventListener('touchstart', clickHandler);
    };
    
    setTimeout(function() {
        document.addEventListener('click', clickHandler);
        document.addEventListener('touchstart', clickHandler);
    }, 100);
}

// 消息操作菜单相关变量
let currentMessageMenu = null;
let currentMessageMenuType = null; // 'chat' or 'group'
let currentMessageData = null; // 存储消息数据

// QQ风引用状态
let chatQuoteState = null;  // { author, text, ref?: { type:'chat', historyIndex:number } }
let groupQuoteState = null; // { author, text, ref?: { type:'group', id:number } }

// 编辑弹层状态
let pendingEdit = null; // { mode: 'chat'|'group', messageData, oldContent }

// 删除弹层状态
let pendingDelete = null; // { mode:'chat'|'group', messageData }

function sanitizeQuoteField(s) {
    return String(s || '').replace(/\|/g, '｜').replace(/\r?\n/g, ' ').trim();
}

function getQuoteState(mode) {
    return mode === 'group' ? groupQuoteState : chatQuoteState;
}

function setQuote(mode, quote) {
    const q = quote ? {
        author: sanitizeQuoteField(quote.author),
        text: sanitizeQuoteField(quote.text),
        ref: quote.ref || null
    } : null;
    if (mode === 'group') groupQuoteState = q;
    else chatQuoteState = q;
    renderQuoteBar(mode);
}

function clearQuote(mode) {
    if (mode === 'group') groupQuoteState = null;
    else chatQuoteState = null;
    renderQuoteBar(mode);
}

function renderQuoteBar(mode) {
    const bar = document.getElementById(mode === 'group' ? 'group-quote-bar' : 'chat-quote-bar');
    const titleEl = document.getElementById(mode === 'group' ? 'group-quote-title' : 'chat-quote-title');
    const snippetEl = document.getElementById(mode === 'group' ? 'group-quote-snippet' : 'chat-quote-snippet');
    if (!bar || !titleEl || !snippetEl) return;

    const q = getQuoteState(mode);
    if (!q) {
        bar.style.display = 'none';
        snippetEl.textContent = '';
        return;
    }
    bar.style.display = 'flex';
    titleEl.textContent = `引用 ${q.author || ''}`.trim();
    snippetEl.textContent = q.text || '';
}

function encodeQuoteMarker(quote) {
    if (!quote || !quote.author || !quote.text) return '';
    // 可选携带原消息索引，支持“点击引用跳转”
    const refIndex = (quote.ref && quote.ref.type === 'chat' && Number.isFinite(quote.ref.historyIndex)) ? String(quote.ref.historyIndex) : '';
    return `【引用|${sanitizeQuoteField(quote.author)}|${sanitizeQuoteField(quote.text)}|${sanitizeQuoteField(refIndex)}】 `;
}

function decodeQuoteMarker(content) {
    const s = String(content || '');
    const m = s.match(/^【引用\|([^|]+)\|([\s\S]*?)\|([^|]*)】\s*/);
    if (!m) return null;
    const idx = m[3] !== '' && !Number.isNaN(Number(m[3])) ? Number(m[3]) : null;
    return { quote: { author: m[1], text: m[2], ref: idx != null ? { type:'chat', historyIndex: idx } : null }, rest: s.slice(m[0].length) };
}

// 显示消息操作菜单
function showMessageMenu(messageElement, messageData, type) {
    // 移除已存在的菜单
    const existingMenu = document.querySelector('.message-action-menu');
    if (existingMenu) {
        existingMenu.remove();
    }
    
    currentMessageData = messageData;
    currentMessageMenuType = type;
    
    // 创建菜单
    const menu = document.createElement('div');
    menu.className = 'message-action-menu';
    
    const isUserMessage = messageData.type === 'user' || messageData.author === gameState.player.name;
    // 允许编辑任何一方的“纯文本消息”（不含图片/礼物/转账/红包/动态卡片）
    const canEdit = !!(messageData.content && !messageData.image && !messageData.gift && !messageData.money && !messageData.redpack && !messageData.post);

    const mkItem = (icon, label, onClick, danger = false) => {
        const item = document.createElement('div');
        item.className = 'menu-item' + (danger ? ' danger' : '');
        item.innerHTML = `<span class="material-icons">${icon}</span><span>${label}</span>`;
        item.onclick = onClick;
        return item;
    };
    
    menu.appendChild(mkItem('format_quote', '引用', () => {
        quoteMessage(messageData);
        menu.remove();
    }));
    
    // 重新roll（用户/对方消息均可，按该条消息以上保留、以下自动消失，小鱼板逻辑重新调用API）
    if (settings.apiKey) {
        menu.appendChild(mkItem('casino', '重新roll', () => {
            menu.remove();
            if (type === 'chat') {
                rerollChatFromMessage(messageData);
            } else {
                rerollGroupFromMessage(messageData);
            }
        }));
    }
    
    // 编辑按钮（纯文本消息可编辑）
    if (canEdit) {
        menu.appendChild(mkItem('edit', '编辑', () => {
            editMessage(messageData);
            menu.remove();
        }));
    }
    
    // 删除按钮（允许删除任何一方的消息）
    menu.appendChild(mkItem('delete', '删除', () => {
        openMessageDeleteModal(messageData);
        menu.remove();
    }, true));
    
    document.body.appendChild(menu);
    
    // 计算菜单位置
    const rect = messageElement.getBoundingClientRect();
    const menuRect = menu.getBoundingClientRect();
    let left = rect.left + (rect.width / 2) - (menuRect.width / 2);
    let top = rect.top - menuRect.height - 10;
    
    // 如果菜单超出屏幕，调整位置
    if (top < 10) {
        top = rect.bottom + 10;
    }
    if (left < 10) {
        left = 10;
    }
    if (left + menuRect.width > window.innerWidth - 10) {
        left = window.innerWidth - menuRect.width - 10;
    }
    
    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
    
    currentMessageMenu = menu;
    
    // 点击其他地方关闭菜单
    const closeMenu = (e) => {
        if (!menu.contains(e.target) && !messageElement.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
            document.removeEventListener('touchstart', closeMenu);
        }
    };
    setTimeout(() => {
        document.addEventListener('click', closeMenu);
        document.addEventListener('touchstart', closeMenu);
    }, 100);
}

// 重新roll：私聊，按该条消息以上保留、以下消失，小鱼板逻辑重新调用API
function rerollChatFromMessage(messageData) {
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (!npc || !Number.isFinite(messageData.historyIndex)) return;
    const idx = messageData.historyIndex;
    const hist = npc.history || [];
    if (idx < 0 || idx >= hist.length) return;
    const isUserMsg = messageData.type === 'user' || messageData.author === gameState.player.name;
    const endIdx = isUserMsg ? idx + 1 : idx;
    npc.history = hist.slice(0, endIdx);
    const chatBox = document.getElementById('chat-box');
    if (chatBox) chatBox.innerHTML = '';
    renderChatHistory(npc);
    const lastIdx = npc.history.length - 1;
    if (lastIdx < 0) return;
    const raw = npc.history[lastIdx];
    const m = raw.match(/\[([^\]]+)\]\s*(.+?):\s*(.+)/);
    if (!m) return;
    const sender = m[2];
    let messageToSend = m[3] || '';
    if (sender !== gameState.player.name) return;
    const decoded = decodeQuoteMarker(messageToSend);
    if (decoded) messageToSend = decoded.rest || messageToSend;
    sendMessageWithAPI({ reroll: true, messageToSend: messageToSend || '' });
}

// 重新roll：群聊，按该条消息以上保留、以下消失，小鱼板逻辑重新调用API
function rerollGroupFromMessage(messageData) {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group || !group.messages) return;
    const i = group.messages.findIndex(m => m.id === messageData.id);
    if (i < 0) return;
    const isUserMsg = messageData.type === 'user' || messageData.author === gameState.player.name;
    group.messages.length = isUserMsg ? i + 1 : i;
    const lastMsg = group.messages[group.messages.length - 1];
    if (!lastMsg || lastMsg.author !== gameState.player.name) return;
    renderGroupChat();
    sendGroupMessageWithAPI();
}

// 引用消息
function quoteMessage(messageData) {
    let quoteText = '';
    if (messageData.image || messageData.content === '[图片]') {
        quoteText = messageData.imageDescription || '[图片]';
    } else if (messageData.content) {
        quoteText = messageData.content;
    } else if (messageData.gift) {
        quoteText = `[礼物: ${messageData.gift.name}]`;
    } else if (messageData.money) {
        quoteText = `[转账: ${messageData.money.amount}银两]`;
    } else if (messageData.redpack) {
        quoteText = '[红包]';
    } else if (messageData.post) {
        quoteText = `[分享动态: ${messageData.post.content ? messageData.post.content.substring(0, 30) : ''}]`;
    }
    const author = messageData.author || (messageData.type === 'user' ? gameState.player.name : '');
    const mode = currentMessageMenuType === 'group' ? 'group' : 'chat';
    const ref = mode === 'group'
        ? (messageData && messageData.id != null ? { type:'group', id: messageData.id } : null)
        : (messageData && Number.isFinite(messageData.historyIndex) ? { type:'chat', historyIndex: messageData.historyIndex } : null);
    setQuote(mode, { author, text: quoteText, ref });
    // 聚焦输入框（不把引用硬塞进输入框）
    const input = document.getElementById(mode === 'group' ? 'group-chat-input' : 'chat-input');
    if (input) input.focus();
}

function scrollToReferencedMessage(ref) {
    if (!ref || !ref.type) return;
    let el = null;
    if (ref.type === 'group') {
        el = document.querySelector(`#group-chat-box [data-msg-id="${ref.id}"]`);
        if (el) {
            el.scrollIntoView({ block: 'center', behavior: 'smooth' });
            el.classList.remove('msg-highlight');
            // 重新触发动画
            void el.offsetWidth;
            el.classList.add('msg-highlight');
        }
        return;
    }
    if (ref.type === 'chat') {
        el = document.querySelector(`#chat-box [data-history-index="${ref.historyIndex}"]`);
        if (el) {
            el.scrollIntoView({ block: 'center', behavior: 'smooth' });
            el.classList.remove('msg-highlight');
            void el.offsetWidth;
            el.classList.add('msg-highlight');
        }
    }
}

function openMessageEditModal(messageData) {
    const modal = document.getElementById('message-edit-modal');
    const ta = document.getElementById('message-edit-textarea');
    if (!modal || !ta) return;
    pendingEdit = {
        mode: currentMessageMenuType === 'group' ? 'group' : 'chat',
        messageData: messageData,
        oldContent: String(messageData.content || '')
    };
    ta.value = pendingEdit.oldContent;
    modal.style.display = 'flex';
    setTimeout(() => ta.focus(), 50);
}

function closeMessageEditModal() {
    const modal = document.getElementById('message-edit-modal');
    if (modal) modal.style.display = 'none';
    pendingEdit = null;
}

function confirmMessageEdit() {
    if (!pendingEdit) return;
    const ta = document.getElementById('message-edit-textarea');
    if (!ta) return;
    const newContent = String(ta.value || '').trim();
    if (!newContent || newContent === pendingEdit.oldContent) {
        closeMessageEditModal();
        return;
    }
    applyMessageEdit(pendingEdit.mode, pendingEdit.messageData, pendingEdit.oldContent, newContent);
    closeMessageEditModal();
}

// 编辑消息
function editMessage(messageData) {
    if (!messageData.content) return;
    openMessageEditModal(messageData);
}

function openMessageDeleteModal(messageData) {
    const modal = document.getElementById('message-delete-modal');
    const preview = document.getElementById('message-delete-preview');
    if (!modal || !preview) return;
    pendingDelete = {
        mode: currentMessageMenuType === 'group' ? 'group' : 'chat',
        messageData
    };
    const txt = String(messageData?.content || (messageData?.image ? '[图片]' : '') || '');
    preview.textContent = txt || '（空）';
    modal.style.display = 'flex';
}

function closeMessageDeleteModal() {
    const modal = document.getElementById('message-delete-modal');
    if (modal) modal.style.display = 'none';
    pendingDelete = null;
}

function confirmMessageDelete() {
    if (!pendingDelete) return;
    deleteMessage(pendingDelete.messageData);
    closeMessageDeleteModal();
}

function applyMessageEdit(mode, messageData, oldContent, newContent) {
    if (mode === 'chat') {
        const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
        if (npc && npc.history) {
            // 用“历史索引”精准编辑，避免所有消息都被替换
            if (Number.isFinite(messageData.historyIndex) && npc.history[messageData.historyIndex]) {
                const line = npc.history[messageData.historyIndex];
                const m = line.match(/\[([^\]]+)\]\s*(.+?):\s*(.+)/);
                if (m) {
                    const ts = m[1];
                    const sender = m[2];
                    npc.history[messageData.historyIndex] = `[${ts}] ${sender}: ${newContent}`;
                }
            }
        }
        if (npc) {
            const chatBox = document.getElementById('chat-box');
            if (chatBox) chatBox.innerHTML = '';
            renderChatHistory(npc);
        }
    } else {
        const group = gameState.groups.find(g => g.id === currentGroupId);
        if (group && group.messages) {
            const msg = group.messages.find(m => m.id === messageData.id);
            if (msg) {
                msg.content = newContent;
                renderGroupChat();
            }
        }
    }
}

// 删除消息
function deleteMessage(messageData) {
    if (currentMessageMenuType === 'chat') {
        // 私聊消息删除
        const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
        if (npc && npc.history) {
            // 用“历史索引”精准删除，避免删不掉或误删多条
            if (Number.isFinite(messageData.historyIndex)) {
                npc.history.splice(messageData.historyIndex, 1);
            }
        }
        // 重新渲染聊天历史（先清空，避免叠加）
        if (npc) {
            const chatBox = document.getElementById('chat-box');
            if (chatBox) chatBox.innerHTML = '';
            renderChatHistory(npc);
        }
    } else {
        // 群聊消息删除
        const group = gameState.groups.find(g => g.id === currentGroupId);
        if (group && group.messages) {
            group.messages = group.messages.filter(m => m.id !== messageData.id);
            renderGroupChat();
        }
    }
}

// 添加长按事件到消息元素
function addLongPressToMessage(element, messageData, type) {
    let longPressTimer = null;
    let isLongPress = false;
    
    // 触摸事件（移动端）
    element.addEventListener('touchstart', function(e) {
        isLongPress = false;
        longPressTimer = setTimeout(function() {
            isLongPress = true;
            e.preventDefault();
            showMessageMenu(element, messageData, type);
        }, 500); // 500ms长按
    });
    
    element.addEventListener('touchend', function(e) {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
    });
    
    element.addEventListener('touchmove', function(e) {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
    });
    
    // 鼠标右键事件（桌面端）
    element.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        showMessageMenu(element, messageData, type);
    });
}

function renderContacts() {
    const list = document.getElementById('npc-list-container');
    list.innerHTML = "";
    if (gameState.npcs.length === 0) {
        list.innerHTML = "<p style='text-align:center;color:#8E96D9'>暂无认识的人，快去大地图探索吧。</p>";
        return;
    }

    gameState.npcs.forEach(npc => {
        const card = document.createElement('div');
        card.className = "npc-card";
        const menuId = `plus-menu-${npc.id}`;
        
        // 显示对话记录数量
        const historyCount = npc.history ? npc.history.length : 0;
        const historyText = historyCount > 0 ? ` | 对话记录: ${historyCount}条` : '';
        
        card.innerHTML = `
            <div class="npc-info">
                <h4>${npc.name} <span style="font-size:12px;font-weight:normal;color:#757ED3">(${npc.role})</span></h4>
                <p>性格: ${npc.personality} | 好感: ${npc.affection}${historyText}</p>
                ${historyCount > 0 ? `<div style="font-size:11px;color:#8E96D9;margin-top:5px;max-height:60px;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;">
                    ${npc.history.slice(-5).map(msg => {
                        const content = msg.replace(/\[\d{4}-\d{2}-\d{2}[^\]]+\]\s*/, '');
                        return content.length > 30 ? content.substring(0, 30) + '...' : content;
                    }).join('<br>')}
                </div>` : ''}
            </div>
            <div class="npc-actions">
                <button class="btn" style="width:auto; padding:5px 10px; font-size:12px; background:var(--secondary); color:var(--text);" onclick="editNPC(${npc.id})">编辑</button>
                <button class="btn" style="width:auto; padding:5px 10px; font-size:12px;" onclick="startChatFromList(${npc.id})">找TA</button>
            </div>
        `;
        list.appendChild(card);
    });
}

function startChatFromList(id) {
    const npc = gameState.npcs.find(n => n.id === id);
    if(npc) startChat(npc);
}

/** 劝说当前对话的对方服用之前赠送的避孕汤（需先送过避孕汤，对方有 pendingContraceptive 时显示按钮） */
function offerContraceptiveToNpc() {
    var npc = gameState.chatTargetId ? gameState.npcs.find(function(n) { return n.id === gameState.chatTargetId; }) : null;
    if (!npc || !npc.pendingContraceptive) {
        showTipModal('对方没有待服用的避孕汤。', '提示');
        return;
    }
    var willing = Math.random() < (0.5 + (npc.affection || 0) / 200);
    npc.pendingContraceptive = false;
    var wrap = document.getElementById('chat-pending-contraceptive-wrap');
    if (wrap) wrap.style.display = 'none';
    npc.history = npc.history || [];
    var currentDate = new Date().toISOString();
    var systemMsg = willing
        ? '你劝' + (npc.name || '对方') + '服下了避孕汤，对方已服用，一周内不会怀孕。'
        : '你劝' + (npc.name || '对方') + '服用避孕汤，对方婉拒了。';
    npc.history.push('[' + currentDate + '] 系统: ' + systemMsg);
    var chatBox = document.getElementById('chat-box');
    if (chatBox) {
        addMessageToUI(systemMsg, 'sys', null, false, null, null, { historyIndex: npc.history.length - 1, timestamp: currentDate, sender: '系统' });
        setTimeout(function() { chatBox.scrollTop = chatBox.scrollHeight; }, 50);
    }
    if (willing) {
        npc.contraceptiveUntil = Date.now() + 7 * 24 * 60 * 60 * 1000;
        showTipModal('对方愿意服用避孕汤，一周内不会怀孕。', '已服用');
    } else {
        showTipModal('对方婉拒了避孕汤。', '未服用');
    }
}

// 心理状态与日记：弹窗与生成
let currentPsychologyDiaryNpcId = null;

/** 确保 NPC 有心理状态与日记历史数组，旧存档兼容：有 psychologicalState/diary 无 history 时迁移 */
function ensureNpcPsychDiaryHistory(npc) {
    if (!npc) return;
    if (!Array.isArray(npc.psychologicalStateHistory)) {
        npc.psychologicalStateHistory = [];
        if (npc.psychologicalState != null && String(npc.psychologicalState).trim()) {
            npc.psychologicalStateHistory.push(String(npc.psychologicalState).trim());
        }
    }
    if (!Array.isArray(npc.diaryHistory)) {
        npc.diaryHistory = [];
        if (npc.diary != null && String(npc.diary).trim()) {
            npc.diaryHistory.push(String(npc.diary).trim());
        }
    }
    if (npc.psychRollbackPages == null) npc.psychRollbackPages = 0;
    if (npc.diaryRollbackPages == null) npc.diaryRollbackPages = 0;
}

/** 将新的心理状态与日记推入历史，并同步到 .psychologicalState / .diary */
function pushPsychDiaryToHistory(npc, psych, diary) {
    if (!npc) return;
    ensureNpcPsychDiaryHistory(npc);
    if (psych != null && String(psych).trim()) {
        npc.psychologicalStateHistory.unshift(String(psych).trim());
        npc.psychologicalState = npc.psychologicalStateHistory[0];
    }
    if (diary != null && String(diary).trim()) {
        npc.diaryHistory.unshift(String(diary).trim());
        npc.diary = npc.diaryHistory[0];
    }
}

/** 根据回退页数取得有效心理状态（0=最新） */
function getEffectivePsych(npc) {
    if (!npc) return '';
    ensureNpcPsychDiaryHistory(npc);
    const h = npc.psychologicalStateHistory || [];
    const idx = Math.max(0, Math.min(npc.psychRollbackPages || 0, h.length - 1));
    return h[idx] || npc.psychologicalState || '';
}

/** 根据回退页数取得有效日记（0=最新） */
function getEffectiveDiary(npc) {
    if (!npc) return '';
    ensureNpcPsychDiaryHistory(npc);
    const h = npc.diaryHistory || [];
    const idx = Math.max(0, Math.min(npc.diaryRollbackPages || 0, h.length - 1));
    return h[idx] || npc.diary || '';
}

function closePsychologyDiaryModal() {
    document.getElementById('psychology-diary-modal').style.display = 'none';
    currentPsychologyDiaryNpcId = null;
}

function showPsychologyDiaryModalByAuthor(el) {
    const name = el && el.getAttribute && el.getAttribute('data-author');
    if (!name) return;
    const npc = gameState.npcs.find(n => n.name === name);
    if (npc) showPsychologyDiaryModal(npc);
}

function showPsychologyDiaryModalByNpcId(id) {
    const npc = gameState.npcs.find(n => n.id === id);
    if (npc) showPsychologyDiaryModal(npc);
}

function confirmPsychDiaryRollback(which) {
    const npc = currentPsychologyDiaryNpcId ? gameState.npcs.find(n => n.id === currentPsychologyDiaryNpcId) : null;
    if (!npc) return;
    ensureNpcPsychDiaryHistory(npc);
    if (which === 'psych') {
        const v = parseInt(document.getElementById('pd-psych-rollback').value, 10);
        npc.psychRollbackPages = isNaN(v) ? 0 : Math.max(0, v);
    } else {
        const v = parseInt(document.getElementById('pd-diary-rollback').value, 10);
        npc.diaryRollbackPages = isNaN(v) ? 0 : Math.max(0, v);
    }
    showPsychologyDiaryModal(npc);
}

function showPsychologyDiaryModal(npc) {
    if (!npc) return;
    ensureNpcPsychDiaryHistory(npc);
    if (npc.psychologicalState === undefined) npc.psychologicalState = '';
    if (npc.diary === undefined) npc.diary = '';
    currentPsychologyDiaryNpcId = npc.id;
    document.getElementById('pd-modal-title').textContent = npc.name + ' · 心理与日记';
    document.getElementById('pd-modal-subtitle').textContent = (npc.role || '') + (npc.personality ? ' · ' + npc.personality : '');
    document.getElementById('pd-psych-rollback').value = npc.psychRollbackPages || 0;
    document.getElementById('pd-diary-rollback').value = npc.diaryRollbackPages || 0;
    const psychEl = document.getElementById('pd-psychology-content');
    const diaryEl = document.getElementById('pd-diary-content');
    psychEl.innerHTML = '';
    diaryEl.innerHTML = '';
    const isGenerating = npc._generatingPsychologyDiary === true;
    const effPsych = getEffectivePsych(npc);
    const effDiary = getEffectiveDiary(npc);
    if (effPsych && effPsych.trim()) {
        psychEl.textContent = effPsych.trim();
        psychEl.classList.remove('pd-empty');
    } else if (isGenerating) {
        psychEl.textContent = '心理状态生成中，请稍候…';
        psychEl.classList.add('pd-empty');
    } else {
        psychEl.textContent = '暂无心理状态。';
        psychEl.classList.add('pd-empty');
    }
    if (effDiary && effDiary.trim()) {
        diaryEl.textContent = effDiary.trim();
        diaryEl.classList.remove('pd-empty');
    } else if (isGenerating) {
        diaryEl.textContent = '日记生成中，请稍候…';
        diaryEl.classList.add('pd-empty');
    } else {
        diaryEl.textContent = '暂无日记。';
        diaryEl.classList.add('pd-empty');
    }
    document.getElementById('psychology-diary-modal').style.display = 'flex';
    document.getElementById('psychology-diary-modal').style.alignItems = 'center';
    document.getElementById('psychology-diary-modal').style.justifyContent = 'center';
}

function refreshPsychologyDiaryModalIfOpen(npcId) {
    if (currentPsychologyDiaryNpcId !== npcId) return;
    const npc = gameState.npcs.find(n => n.id === npcId);
    if (npc) showPsychologyDiaryModal(npc);
}

async function generatePsychologyDiaryForNpc(npcId, contextText) {
    const npc = gameState.npcs.find(n => n.id === npcId);
    if (!npc) return;
    const savedSettings = localStorage.getItem('palace_settings');
    if (!savedSettings) return;
    const settings = JSON.parse(savedSettings);
    if (!settings.apiKey || !settings.apiUrl) return;
    if (npc._generatingPsychologyDiary) return;
    npc._generatingPsychologyDiary = true;
    refreshPsychologyDiaryModalIfOpen(npc.id);
    const isGroupContext = contextText && contextText.indexOf('群聊') !== -1;
    const noPlayerCenterTip = isGroupContext ? '\n重要：这是群聊语境。心理状态与日记不要围绕玩家(主角)来写，应体现该角色在群聊中的独立心理、对群内其他人与话题的看法；日记写该角色自己的经历与感受，勿以与玩家的互动为核心。\n' : '';
    const prompt = `你是中国古代宫廷背景的角色心理与日记撰写者。${getAntiBaguguPrompt()}
当前角色：${npc.name}，身份：${gameState.world.dynasty || '大盛'}朝的${npc.role || '人物'}，性格：${npc.personality || '未知'}。
${contextText ? '近期相关语境：\n' + contextText + '\n\n' : ''}${noPlayerCenterTip}
请为该角色生成两条内容，用JSON返回，格式严格如下：
{"psychologicalState":"一段心理状态描述，50-150字，体现当前情绪、想法、对他人看法等","diary":"一段日记内容，80-200字，第一人称，今日或近日发生之事的记录与感想"}
只输出一个JSON对象，不要其他文字。`;
    try {
        const response = await fetch(settings.apiUrl + '/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settings.apiKey },
            body: JSON.stringify({
                model: settings.model || 'gpt-3.5-turbo',
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.7,
                max_tokens: 500
            })
        });
        if (!response.ok) return;
        const data = await response.json();
        const text = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? data.choices[0].message.content.trim() : '';
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
            const obj = JSON.parse(jsonMatch[0]);
            pushPsychDiaryToHistory(npc, obj.psychologicalState, obj.diary);
            refreshPsychologyDiaryModalIfOpen(npc.id);
        }
    } catch (e) { /* ignore */ }
    npc._generatingPsychologyDiary = false;
}

function generatePsychologyDiaryForGroupSpeakers() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group || !group.messages || group.messages.length === 0) return;
    const authorSet = new Set();
    group.messages.forEach(m => {
        if (m.author && m.author !== gameState.player.name && m.author !== '【上帝视角】' && m.content !== '...') authorSet.add(m.author);
    });
    const recentLines = group.messages.slice(-30).map(m => m.author + '：' + (m.content || (m.image ? '[图片]' : '')).substring(0, 80)).join('\n');
    authorSet.forEach(authorName => {
        const npc = gameState.npcs.find(n => n.name === authorName);
        if (npc) generatePsychologyDiaryForNpc(npc.id, '群聊最近消息：\n' + recentLines);
    });
}

function openAddNPC() {
    currentEditingNpcId = null;
    document.getElementById('npc-edit-modal-title').textContent = '添加人物';
    document.getElementById('npc-edit-delete-btn').style.display = 'none';
    document.getElementById('edit-npc-name').value = '';
    document.getElementById('edit-npc-role').value = '';
    document.getElementById('edit-npc-personality').value = '';
    document.getElementById('edit-npc-background').value = '';
    document.getElementById('edit-npc-affection').value = 0;
    document.getElementById('edit-npc-gender').value = '女';
    document.getElementById('edit-npc-can-send-emoji').checked = true;
    var syphilisWrap = document.getElementById('edit-npc-hasSyphilis-wrap');
    if (syphilisWrap) syphilisWrap.style.display = settings.realMode ? 'block' : 'none';
    var syphilisCb = document.getElementById('edit-npc-hasSyphilis');
    if (syphilisCb) syphilisCb.checked = false;
    document.getElementById('npc-edit-modal').style.display = 'flex';
}

function editNPC(npcId) {
    const npc = gameState.npcs.find(n => n.id === npcId);
    if (!npc) return;
    
    currentEditingNpcId = npcId;
    document.getElementById('npc-edit-modal-title').textContent = '编辑角色设定';
    document.getElementById('npc-edit-delete-btn').style.display = '';
    
    // 填充表单
    document.getElementById('edit-npc-name').value = npc.name || '';
    document.getElementById('edit-npc-role').value = npc.role || '';
    document.getElementById('edit-npc-personality').value = npc.personality || '';
    document.getElementById('edit-npc-background').value = npc.background || npc.appearance || '';
    document.getElementById('edit-npc-affection').value = npc.affection || 0;
    document.getElementById('edit-npc-gender').value = npc.gender || '女';
    document.getElementById('edit-npc-can-send-emoji').checked = npc.canSendEmoji !== false;
    var syphilisWrap = document.getElementById('edit-npc-hasSyphilis-wrap');
    if (syphilisWrap) syphilisWrap.style.display = settings.realMode ? 'block' : 'none';
    var syphilisCb = document.getElementById('edit-npc-hasSyphilis');
    if (syphilisCb) syphilisCb.checked = !!npc.hasSyphilis;
    const childWrap = document.getElementById('edit-npc-child-attrs-wrap');
    const child = npc.isChild && npc.childId ? gameState.player.children.find(c => c.id === npc.childId) : null;
    if (childWrap) {
        if (npc.isChild && child) {
            childWrap.style.display = 'block';
            const att = child.attributes || { constitution: 10, talent: 10, charm: 10, wisdom: 10 };
            document.getElementById('edit-child-constitution').value = att.constitution || 10;
            document.getElementById('edit-child-talent').value = att.talent || 10;
            document.getElementById('edit-child-charm').value = att.charm || 10;
            document.getElementById('edit-child-wisdom').value = att.wisdom || 10;
        } else {
            childWrap.style.display = 'none';
        }
    }
    document.getElementById('npc-edit-modal').style.display = 'flex';
}

function closeNPCEdit() {
    document.getElementById('npc-edit-modal').style.display = 'none';
    currentEditingNpcId = null;
}

function openPlayerInfoModal() {
    const p = gameState.player;
    document.getElementById('player-info-name').value = p.name || '';
    document.getElementById('player-info-origin').value = p.origin || '平民';
    document.getElementById('player-info-age').value = String(p.age != null ? p.age : 15);
    document.getElementById('player-info-character').value = p.characterDesc || '';
    var modal = document.getElementById('player-info-modal');
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function closePlayerInfoModal() {
    document.getElementById('player-info-modal').style.display = 'none';
}

function savePlayerInfo() {
    var name = document.getElementById('player-info-name').value.trim();
    if (!name) {
        showErrorModal('请填写主角姓名。');
        return;
    }
    gameState.player.name = name;
    gameState.player.origin = document.getElementById('player-info-origin').value || '平民';
    gameState.player.age = parseInt(document.getElementById('player-info-age').value, 10) || 15;
    gameState.player.characterDesc = document.getElementById('player-info-character').value || '';
    closePlayerInfoModal();
    if (document.getElementById('chat-target-name')) {
        var nameEl = document.getElementById('chat-target-name');
        if (nameEl) nameEl.textContent = gameState.player.name;
    }
    showTipModal('个人信息已保存。', '保存成功');
}

function saveNPCEdit() {
    const name = document.getElementById('edit-npc-name').value.trim();
    const role = document.getElementById('edit-npc-role').value.trim();
    if (!name) {
        showErrorModal('请填写姓名。');
        return;
    }
    
    if (!currentEditingNpcId) {
        // 添加新人物
        const newNpc = {
            id: Date.now(),
            name: name,
            role: role || '未知',
            personality: document.getElementById('edit-npc-personality').value.trim() || '',
            background: document.getElementById('edit-npc-background').value.trim() || '',
            affection: Math.max(0, Math.min(100, parseInt(document.getElementById('edit-npc-affection').value) || 0)),
            gender: document.getElementById('edit-npc-gender').value || '女',
            canSendEmoji: document.getElementById('edit-npc-can-send-emoji').checked,
            history: [],
            hasSyphilis: settings.realMode && document.getElementById('edit-npc-hasSyphilis').checked
        };
        gameState.npcs.push(newNpc);
        if (!gameState.player.relationships) gameState.player.relationships = {};
        gameState.player.relationships[newNpc.id] = { type: "neutral", level: 0 };
        showTipModal("人物已添加。", "添加成功");
    } else {
        // 编辑已有角色
        const npc = gameState.npcs.find(n => n.id === currentEditingNpcId);
        if (!npc) return;
        npc.name = name;
        npc.role = role || npc.role;
        npc.personality = document.getElementById('edit-npc-personality').value.trim() || npc.personality;
        npc.background = document.getElementById('edit-npc-background').value.trim() || npc.background || npc.appearance || '';
        npc.affection = Math.max(0, Math.min(100, parseInt(document.getElementById('edit-npc-affection').value) || npc.affection));
        npc.gender = document.getElementById('edit-npc-gender').value || npc.gender;
        npc.canSendEmoji = document.getElementById('edit-npc-can-send-emoji').checked;
        if (settings.realMode) npc.hasSyphilis = document.getElementById('edit-npc-hasSyphilis').checked;
        if (npc.isChild && npc.childId) {
            const ch = gameState.player.children.find(c => c.id === npc.childId);
            if (ch && ch.attributes) {
                ch.attributes.constitution = Math.max(0, Math.min(100, parseInt(document.getElementById('edit-child-constitution').value, 10) || 10));
                ch.attributes.talent = Math.max(0, Math.min(100, parseInt(document.getElementById('edit-child-talent').value, 10) || 10));
                ch.attributes.charm = Math.max(0, Math.min(100, parseInt(document.getElementById('edit-child-charm').value, 10) || 10));
                ch.attributes.wisdom = Math.max(0, Math.min(100, parseInt(document.getElementById('edit-child-wisdom').value, 10) || 10));
            }
        }
        showTipModal("角色设定已保存。", "保存成功");
    }
    closeNPCEdit();
    renderContacts();
}

function showDeleteNPCConfirmModal() {
    if (!currentEditingNpcId) return;
    const npc = gameState.npcs.find(n => n.id === currentEditingNpcId);
    if (!npc) return;
    document.getElementById('delete-npc-confirm-msg').textContent = `确定要删除「${npc.name}」（${npc.role}）吗？`;
    const modal = document.getElementById('delete-npc-confirm-modal');
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function closeDeleteNPCConfirmModal() {
    document.getElementById('delete-npc-confirm-modal').style.display = 'none';
}

function confirmDeleteNPC() {
    if (!currentEditingNpcId) return;
    const npc = gameState.npcs.find(n => n.id === currentEditingNpcId);
    if (!npc) return;
    closeDeleteNPCConfirmModal();
    if (gameState.chatTargetId === currentEditingNpcId) {
        gameState.chatTargetId = null;
        goToPage('page-game');
    }
    if (gameState.memorySettings[npc.id]) {
        delete gameState.memorySettings[npc.id];
    }
    if (npc.isChild && npc.childId) {
        const ci = (gameState.player.children || []).findIndex(c => c.id === npc.childId);
        if (ci !== -1) gameState.player.children.splice(ci, 1);
    }
    const index = gameState.npcs.findIndex(n => n.id === currentEditingNpcId);
    if (index !== -1) gameState.npcs.splice(index, 1);
    showTipModal("角色已删除。", "已删除");
    closeNPCEdit();
    renderContacts();
}

function openExportSelectModal() {
    const list = document.getElementById('export-select-list');
    list.innerHTML = '';
    if (!gameState.npcs || gameState.npcs.length === 0) {
        showErrorModal('暂无人脉，无法导出。');
        return;
    }
    gameState.npcs.forEach(npc => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;padding:12px;margin-bottom:8px;background:rgba(225,227,237,0.3);border-radius:8px;cursor:pointer;transition:background 0.2s;';
        row.onmouseover = () => row.style.background = 'rgba(225,227,237,0.5)';
        row.onmouseout = () => row.style.background = 'rgba(225,227,237,0.3)';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = npc.id;
        cb.className = 'export-select-cb';
        cb.id = 'export-cb-' + npc.id;
        cb.style.cssText = 'width:18px;height:18px;margin-right:12px;cursor:pointer;flex-shrink:0;';
        row.appendChild(cb);
        const label = document.createElement('label');
        label.htmlFor = 'export-cb-' + npc.id;
        label.style.cssText = 'flex:1;cursor:pointer;margin:0;';
        label.textContent = npc.name + ' (' + (npc.role || '') + ')';
        row.appendChild(label);
        row.onclick = function(e) { if (e.target !== cb) cb.checked = !cb.checked; };
        list.appendChild(row);
    });
    document.getElementById('export-select-modal').style.display = 'flex';
}

function closeExportSelectModal() {
    document.getElementById('export-select-modal').style.display = 'none';
}

function toggleExportSelectAll(checked) {
    document.querySelectorAll('.export-select-cb').forEach(cb => { cb.checked = checked; });
}

function confirmExportSelected() {
    const checked = document.querySelectorAll('.export-select-cb:checked');
    if (checked.length === 0) {
        showErrorModal('请至少选择一个人物再导出。');
        return;
    }
    const ids = [].map.call(checked, c => parseInt(c.value, 10));
    const toExport = gameState.npcs.filter(n => ids.indexOf(n.id) !== -1);
    const data = JSON.stringify(toExport, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = '人脉导出_' + new Date().toISOString().slice(0, 10) + '.json';
    a.click();
    URL.revokeObjectURL(a.href);
    closeExportSelectModal();
    showTipModal('已导出 ' + toExport.length + ' 个人物。', '导出成功');
}

function importContacts(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function() {
        try {
            const arr = JSON.parse(reader.result);
            const list = Array.isArray(arr) ? arr : [arr];
            let added = 0;
            list.forEach(function(item) {
                if (!item || typeof item.name !== 'string') return;
                const id = Date.now() + Math.random();
                const npc = {
                    id: id,
                    name: item.name || '未知',
                    role: item.role || '未知',
                    personality: item.personality || '',
                    background: item.background || item.appearance || '',
                    affection: Math.max(0, Math.min(100, parseInt(item.affection) || 0)),
                    gender: item.gender || '女',
                    canSendEmoji: item.canSendEmoji !== false,
                    history: Array.isArray(item.history) ? item.history : [],
                    emojis: Array.isArray(item.emojis) ? item.emojis : undefined,
                    chatBackgroundImage: (item.chatBackgroundImage && typeof item.chatBackgroundImage === 'string') ? item.chatBackgroundImage : '',
                    chatBackgroundScale: (item.chatBackgroundScale != null) ? Math.max(50, Math.min(200, parseInt(item.chatBackgroundScale, 10) || 100)) : 100,
                    notificationSound: (item.notificationSound && typeof item.notificationSound === 'string') ? item.notificationSound : ''
                };
                gameState.npcs.push(npc);
                if (!gameState.player.relationships) gameState.player.relationships = {};
                gameState.player.relationships[npc.id] = { type: "neutral", level: 0 };
                added++;
            });
            event.target.value = '';
            renderContacts();
            showTipModal("已导入 " + added + " 个人物。", "导入成功");
        } catch (e) {
            event.target.value = '';
            showErrorModal("导入失败，请确认文件为正确的JSON格式。");
        }
    };
    reader.readAsText(file);
}

// 记忆历史设置
let currentMemoryNpcId = null;

function openMemorySettings() {
    if (!gameState.chatTargetId) {
        alert("请先选择一个对话对象！");
        return;
    }
    
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (!npc) return;
    
    currentMemoryNpcId = gameState.chatTargetId;
    document.getElementById('memory-npc-name').textContent = `${npc.name} (${npc.role})`;
    document.getElementById('memory-count').value = gameState.memorySettings[npc.id] !== undefined ? gameState.memorySettings[npc.id] : 100;
    document.getElementById('current-memory-count').textContent = npc.history ? npc.history.length : 0;
    
    document.getElementById('memory-modal').style.display = 'flex';
    document.getElementById('chat-plus-menu').classList.remove('show');
}

function closeMemorySettings() {
    document.getElementById('memory-modal').style.display = 'none';
    currentMemoryNpcId = null;
}

var chatBackgroundImageTemp = null; // 本次选择的本地图片 data URL
var chatBackgroundScaleTemp = 100;   // 当前弹窗内缩放比例 50–200

function applyChatBackground(npc) {
    const container = document.querySelector('#page-chat .chat-container');
    if (!container) return;
    const url = (npc && npc.chatBackgroundImage) ? npc.chatBackgroundImage : '';
    const scale = (npc && npc.chatBackgroundScale) ? Math.max(50, Math.min(200, npc.chatBackgroundScale)) : 100;
    if (url) {
        container.style.backgroundImage = 'url(' + url + ')';
        container.style.backgroundSize = scale + '% ' + scale + '%';
        container.style.backgroundPosition = 'center';
    } else {
        container.style.backgroundImage = '';
        container.style.backgroundSize = '';
        container.style.backgroundPosition = '';
    }
}

function chatBackgroundScaleChange(delta) {
    chatBackgroundScaleTemp = Math.max(50, Math.min(200, chatBackgroundScaleTemp + delta * 10));
    document.getElementById('chat-background-scale-text').textContent = chatBackgroundScaleTemp + '%';
    var preview = document.getElementById('chat-background-preview');
    if (preview && preview.style.backgroundImage) {
        preview.style.backgroundSize = chatBackgroundScaleTemp + '% ' + chatBackgroundScaleTemp + '%';
    }
}

function openChatBackgroundModal() {
    if (!gameState.chatTargetId) {
        showErrorModal('请先选择一个对话对象。');
        return;
    }
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (!npc) return;
    chatBackgroundImageTemp = null;
    chatBackgroundScaleTemp = (npc.chatBackgroundScale != null) ? Math.max(50, Math.min(200, npc.chatBackgroundScale)) : 100;
    document.getElementById('chat-background-url').value = (npc.chatBackgroundImage && npc.chatBackgroundImage.indexOf('http') === 0) ? npc.chatBackgroundImage : '';
    document.getElementById('chat-background-file').value = '';
    document.getElementById('chat-background-scale-text').textContent = chatBackgroundScaleTemp + '%';
    var previewWrap = document.getElementById('chat-background-preview-wrap');
    var preview = document.getElementById('chat-background-preview');
    if (npc.chatBackgroundImage) {
        preview.style.backgroundImage = 'url(' + npc.chatBackgroundImage + ')';
        preview.style.backgroundSize = chatBackgroundScaleTemp + '% ' + chatBackgroundScaleTemp + '%';
        previewWrap.style.display = 'block';
    } else {
        preview.style.backgroundImage = '';
        preview.style.backgroundSize = '';
        previewWrap.style.display = 'none';
    }
    document.getElementById('chat-background-file').onchange = function() {
        var f = this.files[0];
        if (!f) return;
        var r = new FileReader();
        r.onload = function() {
            chatBackgroundImageTemp = r.result;
            preview.style.backgroundImage = 'url(' + r.result + ')';
            preview.style.backgroundSize = chatBackgroundScaleTemp + '% ' + chatBackgroundScaleTemp + '%';
            previewWrap.style.display = 'block';
        };
        r.readAsDataURL(f);
    };
    document.getElementById('chat-background-modal').style.display = 'flex';
    document.getElementById('chat-background-modal').style.alignItems = 'center';
    document.getElementById('chat-background-modal').style.justifyContent = 'center';
    document.getElementById('chat-plus-menu').classList.remove('show');
}

function closeChatBackgroundModal() {
    document.getElementById('chat-background-modal').style.display = 'none';
    chatBackgroundImageTemp = null;
}

function clearChatBackgroundImage() {
    document.getElementById('chat-background-url').value = '';
    document.getElementById('chat-background-file').value = '';
    chatBackgroundImageTemp = null;
    chatBackgroundScaleTemp = 100;
    document.getElementById('chat-background-scale-text').textContent = '100%';
    var p = document.getElementById('chat-background-preview');
    p.style.backgroundImage = '';
    p.style.backgroundSize = '';
    document.getElementById('chat-background-preview-wrap').style.display = 'none';
}

function saveChatBackground() {
    if (!gameState.chatTargetId) return;
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (!npc) return;
    const urlVal = document.getElementById('chat-background-url').value.trim();
    if (chatBackgroundImageTemp) {
        npc.chatBackgroundImage = chatBackgroundImageTemp;
    } else if (urlVal) {
        npc.chatBackgroundImage = urlVal;
    }
    // 未提供新图时保留原有背景（如本地上传的 data URL 不会出现在链接框里）
    npc.chatBackgroundScale = chatBackgroundScaleTemp;
    applyChatBackground(npc);
    closeChatBackgroundModal();
    showTipModal('背景图片已保存，已应用到当前对话。', '保存成功');
}

// 自定义提示音（私聊/群聊）
var lastPrivateNotificationSoundPlayed = 0;
var lastGroupNotificationSoundPlayed = 0;
var NOTIFICATION_SOUND_COOLDOWN_MS = 1800;
var currentNotificationSoundContext = null;
var notificationSoundTemp = null;

function playPrivateNotificationSoundIfNeeded() {
    if (!gameState.chatTargetId) return;
    var npc = gameState.npcs.find(function(n) { return n.id === gameState.chatTargetId; });
    if (!npc || !npc.notificationSound) return;
    var now = Date.now();
    if (now - lastPrivateNotificationSoundPlayed < NOTIFICATION_SOUND_COOLDOWN_MS) return;
    lastPrivateNotificationSoundPlayed = now;
    try {
        var a = new Audio(npc.notificationSound);
        a.volume = 0.7;
        a.play().catch(function() {});
    } catch (e) {}
}

function playNotificationSoundForNpc(npc) {
    if (!npc || !npc.notificationSound) return;
    var now = Date.now();
    if (now - lastPrivateNotificationSoundPlayed < NOTIFICATION_SOUND_COOLDOWN_MS) return;
    lastPrivateNotificationSoundPlayed = now;
    try {
        var a = new Audio(npc.notificationSound);
        a.volume = 0.7;
        a.play().catch(function() {});
    } catch (e) {}
}

function playGroupNotificationSoundIfNeeded() {
    if (currentGroupId == null) return;
    var group = gameState.groups && gameState.groups.find(function(g) { return g.id === currentGroupId; });
    if (!group || !group.notificationSound) return;
    var now = Date.now();
    if (now - lastGroupNotificationSoundPlayed < NOTIFICATION_SOUND_COOLDOWN_MS) return;
    lastGroupNotificationSoundPlayed = now;
    try {
        var a = new Audio(group.notificationSound);
        a.volume = 0.7;
        a.play().catch(function() {});
    } catch (e) {}
}

function playGroupNotificationSoundForGroupId(groupId) {
    if (groupId == null) return;
    var group = gameState.groups && gameState.groups.find(function(g) { return g.id === groupId; });
    if (!group || !group.notificationSound) return;
    var now = Date.now();
    if (now - lastGroupNotificationSoundPlayed < NOTIFICATION_SOUND_COOLDOWN_MS) return;
    lastGroupNotificationSoundPlayed = now;
    try {
        var a = new Audio(group.notificationSound);
        a.volume = 0.7;
        a.play().catch(function() {});
    } catch (e) {}
}

function openNotificationSoundModal(context) {
    currentNotificationSoundContext = context;
    notificationSoundTemp = null;
    document.getElementById('notification-sound-file').value = '';
    var titleEl = document.getElementById('notification-sound-title');
    var previewWrap = document.getElementById('notification-sound-preview-wrap');
    if (context === 'chat') {
        titleEl.textContent = '自定义提示音（当前对话对象）';
        var npc = gameState.npcs && gameState.npcs.find(function(n) { return n.id === gameState.chatTargetId; });
        if (!npc) {
            showErrorModal('请先选择一个对话对象。');
            return;
        }
        previewWrap.style.display = npc.notificationSound ? 'block' : 'none';
    } else {
        titleEl.textContent = '自定义提示音（当前群聊）';
        var group = gameState.groups && gameState.groups.find(function(g) { return g.id === currentGroupId; });
        if (!group) {
            showErrorModal('请先进入一个群聊。');
            return;
        }
        previewWrap.style.display = group.notificationSound ? 'block' : 'none';
    }
    document.getElementById('notification-sound-file').onchange = function() {
        var f = this.files[0];
        if (!f) return;
        var r = new FileReader();
        r.onload = function() {
            notificationSoundTemp = r.result;
            previewWrap.style.display = 'block';
        };
        r.readAsDataURL(f);
    };
    document.getElementById('notification-sound-modal').style.display = 'flex';
    document.getElementById('notification-sound-modal').style.alignItems = 'center';
    document.getElementById('notification-sound-modal').style.justifyContent = 'center';
    document.getElementById('chat-plus-menu').classList.remove('show');
    document.getElementById('group-chat-plus-menu').classList.remove('show');
}

function closeNotificationSoundModal() {
    document.getElementById('notification-sound-modal').style.display = 'none';
    currentNotificationSoundContext = null;
    notificationSoundTemp = null;
}

function clearNotificationSound() {
    document.getElementById('notification-sound-file').value = '';
    notificationSoundTemp = null;
    document.getElementById('notification-sound-preview-wrap').style.display = 'none';
    if (currentNotificationSoundContext === 'chat') {
        var npc = gameState.npcs && gameState.npcs.find(function(n) { return n.id === gameState.chatTargetId; });
        if (npc) npc.notificationSound = '';
    } else if (currentNotificationSoundContext === 'group') {
        var group = gameState.groups && gameState.groups.find(function(g) { return g.id === currentGroupId; });
        if (group) group.notificationSound = '';
    }
}

function previewNotificationSound() {
    var url = notificationSoundTemp;
    if (!url && currentNotificationSoundContext === 'chat') {
        var npc = gameState.npcs && gameState.npcs.find(function(n) { return n.id === gameState.chatTargetId; });
        if (npc) url = npc.notificationSound;
    }
    if (!url && currentNotificationSoundContext === 'group') {
        var group = gameState.groups && gameState.groups.find(function(g) { return g.id === currentGroupId; });
        if (group) url = group.notificationSound;
    }
    if (url) {
        try {
            var a = new Audio(url);
            a.volume = 0.7;
            a.play().catch(function() {});
        } catch (e) {}
    }
}

function saveNotificationSound() {
    if (currentNotificationSoundContext === 'chat') {
        var npc = gameState.npcs && gameState.npcs.find(function(n) { return n.id === gameState.chatTargetId; });
        if (!npc) return;
        if (notificationSoundTemp) npc.notificationSound = notificationSoundTemp;
        showTipModal('提示音已保存，对方回复时会播放。', '保存成功');
    } else if (currentNotificationSoundContext === 'group') {
        var group = gameState.groups && gameState.groups.find(function(g) { return g.id === currentGroupId; });
        if (!group) return;
        if (notificationSoundTemp) group.notificationSound = notificationSoundTemp;
        showTipModal('群聊提示音已保存，成员回复时会播放。', '保存成功');
    }
    closeNotificationSoundModal();
}

function saveMemorySettings() {
    if (!currentMemoryNpcId) return;
    
    const count = parseInt(document.getElementById('memory-count').value) || 100;
    if (count < 0) {
        alert("记忆设置不能为负数！设置为0表示使用该角色的所有对话记录（永久保存）。");
        return;
    }
    
    // 检查是否是群聊模式
    if (typeof currentMemoryNpcId === 'string' && currentMemoryNpcId.startsWith('group_')) {
        const groupId = parseInt(currentMemoryNpcId.replace('group_', ''));
        const group = gameState.groups.find(g => g.id === groupId);
        if (group) {
            if (!gameState.groupMemorySettings) {
                gameState.groupMemorySettings = {};
            }
            gameState.groupMemorySettings[groupId] = count;
            const totalHistory = group.messages ? group.messages.length : 0;
            if (count === 0) {
                alert(`已设置：将使用该群聊的所有消息记录（共${totalHistory}条），所有记录都会永久保存并在每次对话时使用`);
            } else {
                alert(`已设置：AI回复时将记忆最近${count}条群聊消息`);
            }
        }
    } else {
        // NPC模式
        const npc = gameState.npcs.find(n => n.id === currentMemoryNpcId);
        const totalHistory = npc ? (npc.history ? npc.history.length : 0) : 0;
        
        gameState.memorySettings[currentMemoryNpcId] = count;
        if (count === 0) {
            alert(`已设置：将使用该角色的所有对话记录（共${totalHistory}条），所有记录都会永久保存并在每次对话时使用`);
        } else {
            alert(`已设置：对方回复时将记忆最近${count}条对话记录`);
        }
    }
    closeMemorySettings();
}

async function advanceTime() {
    const restBtn = document.getElementById('rest-btn');
    if (!restBtn) return;
    
    // 禁用按钮
    restBtn.disabled = true;
    const originalText = restBtn.textContent;
    
    try {
        // 【休息前】收集本轮的活动上下文（用于剧情生成）
        const yesterdayDateStr = `${gameState.world.year}-${String(gameState.world.month).padStart(2,'0')}-${String(gameState.world.day).padStart(2,'0')}`;
        const yesterdayContext = {
            visitedLocations: [...(gameState.todayVisitedLocations || [])],
            privateChatSummary: '',
            groupChatSummary: '',
            socialSummary: '',
            hadPrivateChat: false,
            hadGroupChat: false,
            hadSocialActivity: false
        };
        // 收集本日私聊摘要（NPC名+对话摘要）
        (gameState.npcs || []).forEach(npc => {
            if (!npc.history || npc.history.length === 0) return;
            const todayChats = npc.history.filter(msg => {
                const m = msg.match(/\[(\d{4}-\d{2}-\d{2})/);
                return m && m[1] === yesterdayDateStr;
            });
            if (todayChats.length > 0) {
                yesterdayContext.hadPrivateChat = true;
                const brief = todayChats.slice(-2).map(msg => msg.replace(/\[\d{4}-\d{2}-\d{2}[^\]]+\]\s*/, '').substring(0, 40)).join('；');
                yesterdayContext.privateChatSummary += `${npc.name}：${brief}\n`;
            }
        });
        // 收集本日群聊摘要
        (gameState.groups || []).forEach(g => {
            if (!g.messages || g.messages.length === 0) return;
            const todayMsgs = g.messages.filter(m => m.time && m.time.includes(`${gameState.world.month}月${gameState.world.day}日`));
            if (todayMsgs.length > 0) {
                yesterdayContext.hadGroupChat = true;
                yesterdayContext.groupChatSummary += `群聊【${g.name}】：${todayMsgs.slice(-3).map(m=>`${m.author}:${(m.content||'').substring(0,25)}`).join('；')}\n`;
            }
        });
        // 收集本日动态圈活动
        const allPosts = [...(gameState.socialPosts || [])];
        (gameState.socialCircles || []).forEach(c => {
            if (c.posts) allPosts.push(...c.posts);
        });
        const todayPosts = allPosts.filter(p => p.date === yesterdayDateStr);
        if (todayPosts.length > 0) {
            yesterdayContext.hadSocialActivity = true;
            yesterdayContext.socialSummary = todayPosts.map(p => `${p.author}: ${(p.content||'').substring(0,50)}`).join('\n');
        }
        // 收集本日在各地图的剧情内容（供休息剧情连贯引用）
        if (gameState.todayVisitedLocations && gameState.player.choices && gameState.player.choices.length > 0) {
            yesterdayContext.locationEventStories = [];
            const choices = gameState.player.choices;
            for (const loc of gameState.todayVisitedLocations) {
                const idx = choices.map(c => c.locationName).lastIndexOf(loc);
                if (idx >= 0 && choices[idx].choice) {
                    const story = String(choices[idx].choice);
                    yesterdayContext.locationEventStories.push({ location: loc, story: story.length > 400 ? story.substring(0, 400) + '...' : story });
                }
            }
        }
        
        // 真实模式：休息前记录当日结束体力，并判断病倒/恢复
        if (settings.realMode) {
            if (!Array.isArray(gameState.energyEndOfDayHistory)) gameState.energyEndOfDayHistory = [];
            const e = gameState.player.stats.energy;
            gameState.energyEndOfDayHistory.push(e);
            if (gameState.energyEndOfDayHistory.length > 7) gameState.energyEndOfDayHistory.shift();
            const last5 = gameState.energyEndOfDayHistory.slice(-5);
            if (last5.length >= 5 && last5.every(function(v) { return v < 30; })) {
                gameState.collapsed = true;
                gameState.sickRecoveryDays = 0;
            }
            if (gameState.collapsed) {
                if (e >= 40) {
                    gameState.sickRecoveryDays = (gameState.sickRecoveryDays || 0) + 1;
                    if (gameState.sickRecoveryDays >= 7) {
                        gameState.collapsed = false;
                        gameState.sickRecoveryDays = 0;
                        showTipModal('身体已恢复，病倒状态解除。', '恢复');
                    }
                } else {
                    gameState.sickRecoveryDays = 0;
                }
            }
        }
        
        gameState.player.stats.energy = 100;
        gameState.world.timeOfDay = 0; // 休息后进入下一天，设为白天(早)
        gameState.world.day++;
        if (gameState.world.day > 30) {
            gameState.world.day = 1;
            gameState.world.month++;
            updateSeason();
            if (gameState.world.month > 12) {
                gameState.world.month = 1;
                gameState.world.year++;
                // 年终奖励
                gameState.player.stats.money += 20;
                alert("又过了一年，获得年终赏赐银两+20");
                // 子女随机事件：死亡/被抓走（金手指下不发生）
                if (!settings.cheatMode && (gameState.player.children || []).length > 0) {
                    gameState.player.children.forEach(ch => {
                        if (ch.isDead || ch.isKidnapped) return;
                        if (Math.random() < 0.02) { ch.isDead = true; alert(ch.name + " 不幸夭折……"); }
                        else if (Math.random() < 0.015) { ch.isKidnapped = true; alert(ch.name + " 被人带走，永不相见……"); }
                    });
                    const npcs = gameState.npcs || [];
                    gameState.player.children.forEach(ch => {
                        const n = npcs.find(npc => npc.childId === ch.id);
                        if (n) { if (ch.isDead) n.role = "子女（已故）"; if (ch.isKidnapped) n.role = "子女（已失）"; }
                    });
                }
                // 非皇帝孩子有概率触发滴血验亲
                (gameState.player.children || []).forEach(ch => {
                    if (ch.isDead || ch.isKidnapped || ch.fatherNpcId === null || ch.fatherNpcId === undefined || ch.bloodTestTriggered) return;
                    if (Math.random() < 0.08) {
                        ch.bloodTestTriggered = true;
                        const father = gameState.npcs.find(n => n.id === ch.fatherNpcId);
                        alert("宫中举行滴血验亲，众人得知 " + ch.name + " 并非龙嗣，生父之事败露……" + (father ? "（与" + father.name + "有关）" : ""));
                    }
                });
            }
        }
        
        // 发俸禄（按职位日俸）
        const rankInfo = RANKS[gameState.player.rank];
        const dailySalary = (rankInfo && rankInfo.salary) ? rankInfo.salary : 1;
        gameState.player.stats.money += dailySalary;
        
        // 升职几率：声望达标时，每次休息有30%概率晋升
        const p = gameState.player;
        const nextRank = RANKS[p.rank + 1];
        if (nextRank && p.stats.fame >= nextRank.req && Math.random() < 0.3) {
            p.rank++;
            showTipModal(`恭喜！你因为声望卓著，晋升为【${RANKS[p.rank].name}】。`, '晋升');
            generateMap();
        }
        
        // 人脉/群聊/动态有几率加声望（每类最多+3，几率约25%）
        if (yesterdayContext.hadPrivateChat && Math.random() < 0.25) {
            gameState.player.stats.fame += Math.floor(Math.random() * 3) + 1;
        }
        if (yesterdayContext.hadGroupChat && Math.random() < 0.25) {
            gameState.player.stats.fame += Math.floor(Math.random() * 3) + 1;
        }
        if (yesterdayContext.hadSocialActivity && Math.random() < 0.25) {
            gameState.player.stats.fame += Math.floor(Math.random() * 3) + 1;
        }
        
        // 重置今日访问记录，供新的一天使用
        gameState.todayVisitedLocations = [];
        
        // 子女年龄随休息增长：约30次休息=1岁
        (gameState.player.children || []).forEach(ch => {
            if (!ch.isDead && !ch.isKidnapped) ch.ageInYears = (ch.ageInYears || 0) + 1/30;
        });
        
        // 检查节日
        checkFestivals();
        
        // 属性衰减检查
        checkStatDecay();
        
        // 物价与内务府：仅在休息时变动，小幅度波动；开剧情时由 generateDailyStory 内按【物价】或小幅度处理
        if (settings.storyMode) {
            restBtn.textContent = '🌙 休息 (正在调用中...)';
            await generateDailyStory(yesterdayContext);
        } else {
            updatePricesOnRest(false);
            showTipModal(`休息了一晚，体力恢复。获得俸禄银两 +${dailySalary}。`, '休息');
        }
        
        updateDashboard();
    } catch (e) {
        console.error("休息功能出错:", e);
        // 显示详细的错误信息
        let errorMessage = "休息功能出错：";
        if (e.message) {
            errorMessage += e.message;
        } else if (e.error) {
            errorMessage += JSON.stringify(e.error, null, 2);
        } else {
            errorMessage += String(e);
        }
        showErrorModal(errorMessage);
    } finally {
        // 恢复按钮状态
        restBtn.disabled = false;
        restBtn.textContent = originalText;
    }
}

function closeStoryModal() {
    currentStoryChoiceObj = null;
    const modal = document.getElementById('story-modal');
    modal.classList.remove('show');
}

async function generateDailyStory(yesterdayContext) {
    if (!settings.apiKey) {
        throw new Error("未配置API密钥，请在设置中配置API密钥后开启剧情模式");
    }
    
    if (!settings.apiUrl) {
        throw new Error("未配置API URL，请在设置中配置API URL");
    }
    
    yesterdayContext = yesterdayContext || { visitedLocations: [], privateChatSummary: '', groupChatSummary: '', socialSummary: '', hadPrivateChat: false, hadGroupChat: false, hadSocialActivity: false };
    
    // 构建当前游戏状态上下文
    const timeInfo = `${gameState.world.year}年${gameState.world.month}月${gameState.world.day}日`;
    const seasonNames = ["春", "夏", "秋", "冬"];
    const season = seasonNames[gameState.world.season];
    const rank = RANKS[gameState.player.rank] ? RANKS[gameState.player.rank].name : "粗使宫女";
    
    // 获取已解锁的地点
    const unlockedLocations = gameState.world.unlockedLocations || [];
    const locationList = unlockedLocations.length > 0 
        ? unlockedLocations.join("、")
        : "无";
    
    // 昨日活动摘要（休息前那一轮的活动）
    let lastRoundInfo = '';
    if (yesterdayContext.visitedLocations && yesterdayContext.visitedLocations.length > 0) {
        lastRoundInfo += `昨日去过的地点：${yesterdayContext.visitedLocations.join("、")}。`;
    }
    if (yesterdayContext.locationEventStories && yesterdayContext.locationEventStories.length > 0) {
        lastRoundInfo += `\n【重要：昨日踩地图时的具体剧情，必须在今日剧情中连贯承接或呼应】\n`;
        yesterdayContext.locationEventStories.forEach(ev => {
            lastRoundInfo += `\n${ev.location}发生：\n${ev.story}\n`;
        });
    }
    if (yesterdayContext.privateChatSummary) {
        lastRoundInfo += `\n昨日人脉私聊摘要：\n${yesterdayContext.privateChatSummary}`;
    }
    if (yesterdayContext.groupChatSummary) {
        lastRoundInfo += `\n昨日群聊摘要：\n${yesterdayContext.groupChatSummary}`;
    }
    if (yesterdayContext.socialSummary) {
        lastRoundInfo += `\n昨日动态圈活动：\n${yesterdayContext.socialSummary}`;
    }
    
    // 人脉全体 + 踩地图结识的人（均需在剧情中按合适方式展开）
    const allNpcs = gameState.npcs || [];
    
    // 构建NPC信息字符串（最多12人）
    let npcInfo = "";
    if (allNpcs.length > 0) {
        const sortedNPCs = [...allNpcs]
            .sort((a, b) => (b.history?.length || 0) - (a.history?.length || 0))
            .slice(0, 12);
        
        // 获取今天的日期（游戏内日期）
        const todayDateStr = `${gameState.world.year}-${String(gameState.world.month).padStart(2, '0')}-${String(gameState.world.day).padStart(2, '0')}`;
        
        const npcDetails = sortedNPCs.map(npc => {
            // 获取今天聊过的所有对话
            const todayChats = npc.history.filter(msg => {
                // 提取消息中的日期
                const dateMatch = msg.match(/\[(\d{4}-\d{2}-\d{2})/);
                if (dateMatch) {
                    const msgDate = dateMatch[1];
                    return msgDate === todayDateStr;
                }
                return false;
            });
            
            // 如果今天有对话，显示所有今天的对话；否则显示所有对话
            const chatsToShow = todayChats.length > 0 ? todayChats : npc.history;
            const chatsText = chatsToShow.map(msg => {
                // 移除时间戳，只保留内容
                const content = msg.replace(/\[\d{4}-\d{2}-\d{2}[^\]]+\]\s*/, '');
                // 如果对话太长，截取前100字
                return content.length > 100 ? content.substring(0, 100) + "..." : content;
            }).join("；");
            
            const chatLabel = todayChats.length > 0 ? `今天对话（${todayChats.length}条）` : `历史对话（${npc.history.length}条）`;
            var encStr = '';
            if (npc.npcMemory && npc.npcMemory.length > 0) {
                encStr = (npc.npcMemory.slice(-2).map(function(e) {
                    return (e.location || '') + ' ' + (e.story || '').substring(0, 80);
                }).join('；')) || '';
            }
            var line = `- ${npc.name}（${npc.role}）：性格${npc.personality || "未知"}，外貌${npc.appearance || "未知"}，好感度${npc.affection || 0}。${chatLabel}：${chatsText || "无"}`;
            if (encStr) line += ' 近期遭遇（地图剧情）：' + encStr;
            return line;
        }).join("\n");
        npcInfo = `\n【人脉角色与踩地图结识的人，需在剧情中按合适方式展开；名单中含各角色近期遭遇与对话，剧情需与这些记忆互通】已接触人物（共${allNpcs.length}人）：\n${npcDetails}`;
    } else {
        npcInfo = "\n已接触的人物：暂无";
    }
    
    // 获取最近的剧情，用于保持连贯性
    const recentStories = (gameState.player.dailyStories || []).slice(-3).map(s => s.content).join("\n\n");
    
    const systemPrompt = `你是一个宫廷生活剧情生成器。根据当前游戏状态，生成一段具体、详细、有代入感的剧情。
${getStylePresetPrompt()}${getAntiBaguguPrompt()}
当前游戏状态：
- 时间：${timeInfo}（${season}季）
- 朝代：${gameState.world.dynasty}
- 皇帝：${gameState.world.emperorDesc || "未知"}
- 玩家身份（自身设定，含属性、穿着、技能）：${getPlayerContextForAPI()}
- 皇帝好感度：${gameState.player.emperorAffection}
- 银两：${gameState.player.stats.money}两
- 体力：${gameState.player.stats.energy}/100
- 已解锁的地点：${locationList}${npcInfo}
${lastRoundInfo ? `\n\n**昨日（休息前一轮）的活动，必须在剧情中体现或呼应：**\n${lastRoundInfo}` : ''}

${recentStories ? `最近发生的剧情：\n${recentStories}\n\n请基于以上剧情，生成新的连贯剧情。` : ''}

要求：
1. 剧情必须非常具体和详细，描述具体的地点、人物、对话、动作、心理活动、环境细节
2. 要有强烈的代入感，让玩家感受到宫廷生活的真实感
3. 剧情要符合当前的时间、季节、玩家身份和属性
4. 必须优先使用已解锁的地点，剧情应该发生在这些地点中
5. 人脉角色和踩地图结识的人必须在剧情中按合适方式展开，可安排他们出场、推动情节或与主角互动
6. 可以涉及宫廷日常、人际交往、突发事件、机遇挑战、宫廷规矩、等级制度等
7. 字数必须达到800-1200字，内容要非常丰富和详细，不要简短
8. 使用第三人称叙述，但要让玩家有身临其境的感觉
9. 不要使用"你"或"玩家"这样的称呼，直接描述主角的行动和感受
10. 要包含具体的对话、动作描写、心理活动、环境描写、人物互动等细节
11. 剧情要有起承转合，有冲突和转折，不要平铺直叙
12. 如果提到了已接触的人物，要符合他们之前对话中展现的性格和关系；剧情需与人脉角色的近期遭遇记忆、与玩家对话互通呼应
13. 如有昨日活动摘要，剧情必须与昨日踩地图时的具体剧情、私聊/群聊/动态形成连贯承接；若昨日有地图事件剧情，今日剧情必须明确呼应、延续或发展该情节，禁止割裂
14. 若剧情涉及才艺（音律、舞蹈、刺绣）、侍寝、社交、心计谋略等，必须与上述「玩家技能」等级一致：等级高则表现娴熟，等级低则表现生疏或略过细节
15. 若剧情涉及宫中供需、赏赐、灾荒、市场、内务府采买等经济相关情节，请在 priceLine 中填写物价变动。
16. 若剧情中首次出场新人物（非上述已接触人物），必须在 newNpcs 中生成该人物的完整设定以便加入人脉。personality、appearance、background 每项不少于200字。

请以JSON格式返回，不要markdown标记。格式：
{
  "story": "剧情正文，800-1200字",
  "priceLine": "【物价】人参+2 胭脂-1 ..." 或不涉及经济则为空字符串,
  "newNpcs": [{"name":"姓名","role":"身份","gender":"男/女","personality":"不少于200字的性格描述","appearance":"不少于200字的外貌描述","background":"不少于200字的背景设定"}]
}
若无新人物则 newNpcs 为 []。只返回此JSON，不要其他文字。`;

    try {
        const response = await fetch(`${settings.apiUrl}/chat/completions`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${settings.apiKey}`
            },
            body: JSON.stringify({
                model: settings.model,
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `请生成${timeInfo}的详细剧情，要求800-1200字，以JSON格式返回（含story、priceLine、newNpcs）。若有新人物出场，newNpcs中每人personality/appearance/background均不少于200字。` }
                ],
                temperature: 0.9,
                max_tokens: 2000
            })
        });

        const data = await response.json();
        if (!response.ok) {
            // 构建详细的错误信息
            let errorMsg = "API调用失败";
            if (data.error) {
                if (data.error.message) {
                    errorMsg = data.error.message;
                } else if (data.error.code) {
                    errorMsg = `错误代码: ${data.error.code}`;
                    if (data.error.type) {
                        errorMsg += `, 类型: ${data.error.type}`;
                    }
                } else {
                    errorMsg = JSON.stringify(data.error, null, 2);
                }
            } else if (data.message) {
                errorMsg = data.message;
            } else {
                errorMsg = `HTTP ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMsg);
        }
        
        let rawContent = data.choices[0].message.content.trim();
        let storyContent = rawContent;
        let priceLine = '';
        let newNpcs = [];
        
        // 尝试解析JSON
        const jsonMatch = rawContent.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
            try {
                const parsed = JSON.parse(jsonMatch[0]);
                storyContent = parsed.story || rawContent;
                priceLine = (parsed.priceLine || '').trim();
                newNpcs = Array.isArray(parsed.newNpcs) ? parsed.newNpcs : [];
            } catch (e) {}
        }
        if (priceLine && storyContent === rawContent) {
            const pl = rawContent.match(/【物价】[^\n]+/);
            if (pl) { priceLine = pl[0]; storyContent = rawContent.replace(pl[0], '').trim(); }
        }
        
        // 按情节合理变动物价
        updatePricesOnRest(true, priceLine || storyContent);
        
        // 新NPC加入人脉（设定不少于200字）
        const addedNames = [];
        newNpcs.forEach(p => {
            if (!p || !p.name) return;
            const personality = String(p.personality || '').trim();
            const appearance = String(p.appearance || '').trim();
            const background = String(p.background || '').trim();
            if (personality.length < 200 || appearance.length < 200 || background.length < 200) return;
            if (gameState.npcs.find(n => n.name === p.name && n.role === (p.role || ''))) return;
            const npc = {
                id: Date.now() + Math.random(),
                name: p.name,
                gender: (p.gender || '女').indexOf('男') >= 0 ? '男' : '女',
                role: p.role || '未知',
                personality: personality,
                appearance: appearance,
                background: background,
                affection: 0,
                metPlace: '休息剧情',
                history: [],
                canSendEmoji: true,
                emojis: []
            };
            gameState.npcs.push(npc);
            addedNames.push(p.name);
        });
        
        const displayContent = storyContent + (priceLine ? '\n\n' + priceLine : '');
        const storyDate = new Date().toISOString();
        if (!gameState.player.dailyStories) {
            gameState.player.dailyStories = [];
        }
        const titleMatch = storyContent.match(/^[^。！？\n]{1,20}/);
        const storyTitle = titleMatch ? titleMatch[0] + "..." : `${timeInfo}的日常`;
        gameState.player.dailyStories.push({
            date: storyDate,
            title: storyTitle,
            content: displayContent
        });
        
        showStoryModal(storyTitle, displayContent, storyDate);
        if (addedNames.length > 0) {
            showTipModal(addedNames.join('、') + ' 已加入人脉，可到人脉页查看。', '新结识');
        }
        
        return true;
        
    } catch (e) {
        console.error("生成剧情失败:", e);
        
        // 处理不同类型的错误，提供更详细的错误信息
        let errorMessage = "生成剧情失败：";
        
        if (e instanceof TypeError && e.message.includes('fetch')) {
            errorMessage += "网络连接失败，请检查网络连接或API URL是否正确";
        } else if (e.message) {
            errorMessage += e.message;
        } else if (e.error) {
            errorMessage += JSON.stringify(e.error, null, 2);
        } else {
            errorMessage += String(e);
        }
        
        // 重新抛出错误，让advanceTime统一处理错误显示
        throw new Error(errorMessage);
    }
}

var currentStoryChoiceObj = null;

function showStoryModal(title, content, date, choiceObj) {
    currentStoryChoiceObj = choiceObj || null;
    document.getElementById('story-modal-title').textContent = title;
    document.getElementById('story-modal-content').textContent = content;
    document.getElementById('story-modal-date').textContent = new Date(date).toLocaleString();
    document.getElementById('story-modal-edit-wrap').style.display = 'none';
    document.getElementById('story-modal-content').style.display = 'block';
    document.getElementById('story-modal-continue-btn').style.display = 'block';
    var actionsEl = document.getElementById('story-modal-actions');
    if (choiceObj) {
        actionsEl.style.display = 'flex';
        document.getElementById('story-modal-edit-btn').onclick = function() { enterStoryChoiceEditMode(choiceObj); };
        document.getElementById('story-modal-delete-btn').onclick = function() { deleteStoryChoice(choiceObj); };
    } else {
        actionsEl.style.display = 'none';
    }
    var modal = document.getElementById('story-modal');
    modal.classList.add('show');
}

function enterStoryChoiceEditMode(choiceObj) {
    document.getElementById('story-modal-content').style.display = 'none';
    document.getElementById('story-modal-actions').style.display = 'none';
    document.getElementById('story-modal-continue-btn').style.display = 'none';
    document.getElementById('story-modal-edit-content').value = choiceObj.choice || '';
    document.getElementById('story-modal-edit-wrap').style.display = 'block';
    currentStoryChoiceObj = choiceObj;
}

function cancelStoryChoiceEdit() {
    document.getElementById('story-modal-edit-wrap').style.display = 'none';
    document.getElementById('story-modal-content').style.display = 'block';
    document.getElementById('story-modal-continue-btn').style.display = 'block';
    if (currentStoryChoiceObj) {
        document.getElementById('story-modal-actions').style.display = 'flex';
    }
}

function saveStoryChoiceEdit() {
    if (!currentStoryChoiceObj) return;
    var newContent = document.getElementById('story-modal-edit-content').value;
    currentStoryChoiceObj.choice = newContent;
    document.getElementById('story-modal-content').textContent = newContent;
    cancelStoryChoiceEdit();
    showTipModal('剧情已保存。', '保存成功');
}

function deleteStoryChoice(choiceObj) {
    if (!choiceObj || !gameState.player.choices) return;
    if (!confirm('确定删除该剧情？')) return;
    var idx = gameState.player.choices.findIndex(function(c) { return (c.id != null && c.id === choiceObj.id) || c === choiceObj; });
    if (idx >= 0) {
        gameState.player.choices.splice(idx, 1);
        closeStoryModal();
        renderStory();
        showTipModal('剧情已删除。', '删除成功');
    }
}

function updateSeason() {
    const month = gameState.world.month;
    if (month >= 3 && month <= 5) gameState.world.season = 0; // 春
    else if (month >= 6 && month <= 8) gameState.world.season = 1; // 夏
    else if (month >= 9 && month <= 11) gameState.world.season = 2; // 秋
    else gameState.world.season = 3; // 冬
}

function checkFestivals() {
    const festivals = {
        "1-1": { name: "元旦", desc: "新年第一天，宫中举行庆典" },
        "5-5": { name: "端午节", desc: "吃粽子，赛龙舟" },
        "8-15": { name: "中秋节", desc: "赏月，吃月饼" },
        "12-30": { name: "除夕", desc: "守岁，年夜饭" }
    };
    
    const dateKey = `${gameState.world.month}-${gameState.world.day}`;
    if (festivals[dateKey]) {
        const festival = festivals[dateKey];
        gameState.world.festivals[dateKey] = true;
        alert(`🎉 今天是${festival.name}！${festival.desc}\n获得节日奖励：银两+50，心情+10`);
        gameState.player.stats.money += 50;
        gameState.player.stats.mood = Math.min(100, gameState.player.stats.mood + 10);
    }
}

function checkStatDecay() {
    // 每30天检查一次属性衰减
    const now = Date.now();
    const lastDecay = gameState.player.stats.lastStatDecay || now;
    const daysPassed = Math.floor((now - lastDecay) / (1000 * 60 * 60 * 24));
    
    if (daysPassed >= 30) {
        // 某些属性会自然衰减（如不经常使用的技能）
        const decayStats = ['music', 'dance', 'embroidery', 'martial'];
        decayStats.forEach(stat => {
            if (gameState.player.stats[stat] > 0 && Math.random() < 0.1) {
                gameState.player.stats[stat] = Math.max(0, gameState.player.stats[stat] - 1);
            }
        });
        gameState.player.stats.lastStatDecay = now;
    }
}

function checkUnlockRequirement(req) {
    if (!req) return true;
    if (req.type === 'task' && req.taskId) return true;
    if (req.type === 'location' && req.location) {
        return gameState.world.unlockedLocations.includes(req.location);
    }
    return true;
}

function triggerRandomEvent(locationName, locationLevel) {
    const events = [
        {
            type: "findItem",
            desc: "你在路上捡到了一个物品",
            reward: { item: "随机物品" },
            chance: 0.3
        },
        {
            type: "findMoney",
            desc: "你意外发现了一些银两",
            reward: { money: Math.floor(Math.random() * 20 * locationLevel) + 10 },
            chance: 0.25
        },
        {
            type: "specialNPC",
            desc: "你遇到了一个特殊的人",
            reward: { npc: "特殊NPC" },
            chance: 0.2
        },
        {
            type: "statBoost",
            desc: "你获得了意外的收获",
            reward: { stat: "随机属性+1-3" },
            chance: 0.15
        },
        {
            type: "badEvent",
            desc: "发生了一些不好的事情",
            penalty: { energy: -10, mood: -5 },
            chance: 0.1
        }
    ];
    
    const roll = Math.random();
    let cumulative = 0;
    for (const event of events) {
        cumulative += event.chance;
        if (roll < cumulative) {
            handleRandomEvent(event, locationName);
            return;
        }
    }
}

function handleRandomEvent(event, locationName) {
    if (event.type === "findMoney") {
        gameState.player.stats.money += event.reward.money;
        alert(`在${locationName}：${event.desc}\n获得银两+${event.reward.money}`);
    } else if (event.type === "findItem") {
        // 随机获得物品
        const randomItems = ["人参", "胭脂", "玉佩"];
        const itemName = randomItems[Math.floor(Math.random() * randomItems.length)];
        const item = gameState.items.find(i => i.name === itemName);
        if (item) {
            item.count++;
            alert(`在${locationName}：${event.desc}\n获得：${itemName}`);
        }
    } else if (event.type === "statBoost") {
        const stats = ['charm', 'elegance', 'wisdom', 'martial'];
        const stat = stats[Math.floor(Math.random() * stats.length)];
        const boost = Math.floor(Math.random() * 3) + 1;
        gameState.player.stats[stat] = Math.min(gameState.player.stats[`max${stat.charAt(0).toUpperCase() + stat.slice(1)}`] || 100, gameState.player.stats[stat] + boost);
        alert(`在${locationName}：${event.desc}\n${stat === 'charm' ? '容貌' : stat === 'elegance' ? '气质' : stat === 'wisdom' ? '才学' : '武艺'}+${boost}`);
    } else if (event.type === "badEvent") {
        gameState.player.stats.energy = Math.max(0, gameState.player.stats.energy + event.penalty.energy);
        gameState.player.stats.mood = Math.max(0, gameState.player.stats.mood + event.penalty.mood);
        alert(`在${locationName}：${event.desc}\n体力${event.penalty.energy}，心情${event.penalty.mood}`);
    }
    
    gameState.events.push({
        type: event.type,
        location: locationName,
        date: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`,
        desc: event.desc
    });
}

// 存档系统
let saveSlots = {}; // {slotId: {name, date, data}}

function loadSaveSlots() {
    const saved = localStorage.getItem('palace_saveSlots');
    if (saved) {
        try {
            saveSlots = JSON.parse(saved);
        } catch (e) {
            saveSlots = {};
        }
    }
}

function saveSaveSlots() {
    try {
        localStorage.setItem('palace_saveSlots', JSON.stringify(saveSlots));
    } catch (e) {
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            showErrorModal('存储空间不足，请清理存档或数据。');
        } else {
            showErrorModal('保存失败：' + (e.message || '未知错误'));
        }
    }
}

function renderSaveList() {
    const container = document.getElementById('save-list-container');
    container.innerHTML = "";
    
    const slots = Object.keys(saveSlots).sort((a, b) => {
        return new Date(saveSlots[b].date) - new Date(saveSlots[a].date);
    });
    
    if (slots.length === 0) {
        container.innerHTML = "<p style='text-align:center;color:#8E96D9'>暂无存档</p>";
        return;
    }
    
    slots.forEach(slotId => {
        const slot = saveSlots[slotId];
        const card = document.createElement('div');
        card.className = "npc-card";
        card.innerHTML = `
            <div class="npc-info">
                <h4 id="save-name-${slotId}">${slot.name || '未命名存档'}</h4>
                <p>保存时间: ${new Date(slot.date).toLocaleString()}</p>
            </div>
            <div class="npc-actions" style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn" style="flex:1;min-width:60px;padding:8px 12px;font-size:13px;" onclick="editSaveName('${slotId}')">编辑</button>
                <button class="btn" style="flex:1;min-width:60px;padding:8px 12px;font-size:13px;background:var(--danger);color:white;" onclick="deleteSave('${slotId}')">删除</button>
                <button class="btn" style="flex:1;min-width:60px;padding:8px 12px;font-size:13px;" onclick="loadSave('${slotId}')">读取</button>
            </div>
        `;
        container.appendChild(card);
    });
}

let currentEditSaveId = null;

function editSaveName(slotId) {
    const slot = saveSlots[slotId];
    if (!slot) return;
    
    currentEditSaveId = slotId;
    const modal = document.getElementById('edit-save-modal');
    document.getElementById('edit-save-name-input').value = slot.name || '未命名存档';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    setTimeout(() => {
        document.getElementById('edit-save-name-input').focus();
        document.getElementById('edit-save-name-input').select();
    }, 100);
}

function closeEditSaveModal() {
    document.getElementById('edit-save-modal').style.display = 'none';
    currentEditSaveId = null;
}

function confirmEditSaveName() {
    if (currentEditSaveId === null) return;
    
    const newName = document.getElementById('edit-save-name-input').value.trim();
    if (newName) {
        saveSlots[currentEditSaveId].name = newName;
        saveSaveSlots();
        renderSaveList();
        closeEditSaveModal();
    } else {
        alert('请输入有效的存档名称');
    }
}

function loadSave(slotId) {
    const slot = saveSlots[slotId];
    if (!slot) {
        alert("存档不存在！");
        return;
    }
    
    try {
        gameState = JSON.parse(JSON.stringify(slot.data)); // 深拷贝
        if (!Array.isArray(gameState.energyEndOfDayHistory)) gameState.energyEndOfDayHistory = [];
        if (typeof gameState.collapsed !== 'boolean') gameState.collapsed = false;
        if (typeof gameState.sickRecoveryDays !== 'number') gameState.sickRecoveryDays = 0;
        if (typeof gameState.dead !== 'boolean') gameState.dead = false;
        if (typeof gameState.chilblainsHands !== 'boolean') gameState.chilblainsHands = false;
        loadTransferStyleFromStorage(); // 恢复转账样式（全局 UI 偏好）
        loadGiftStyleFromStorage(); // 恢复礼物样式
        if (!gameState.todayVisitedLocations) gameState.todayVisitedLocations = [];
        if (!gameState.plotThreads) gameState.plotThreads = {};
        // 确保themeColors存在，如果不存在则使用默认值
        if (!gameState.themeColors) {
            gameState.themeColors = {
                primary: "#757ED3",
                secondary: "#AFB4E1",
                bg: "#D1D4E8",
                text: "#4a403a",
                accent: "#8E96D9",
                danger: "#C85A7A"
            };
        }
        applyTheme(gameState.themeColors);
        gameState.currentSaveId = slotId;
        generateMap();
        goToPage('page-game');
    } catch (e) {
        alert("存档读取失败：" + e.message);
    }
}

// 打开导出存档弹窗：单选/多选存档后导出
function openExportSaveModal() {
    const container = document.getElementById('export-save-list');
    if (!container) return;
    container.innerHTML = '';
    saveThemeToGameState();
    const slots = Object.keys(saveSlots).sort((a, b) => new Date(saveSlots[b].date) - new Date(saveSlots[a].date));
    const currentName = (gameState.currentSaveId && saveSlots[gameState.currentSaveId]) ? (saveSlots[gameState.currentSaveId].name || '当前存档') : '当前游戏状态（未保存）';
    const currentLabel = (gameState.currentSaveId && saveSlots[gameState.currentSaveId]) ? '当前存档' : '当前游戏状态（未保存）';
    const currentId = '__current__';
    const row0 = document.createElement('label');
    row0.style.cssText = 'display:flex;align-items:center;padding:10px 0;cursor:pointer;gap:10px;';
    row0.innerHTML = `<input type="checkbox" class="export-save-cb" data-id="${currentId}" style="width:18px;height:18px;"> <span>${currentLabel}</span>`;
    container.appendChild(row0);
    slots.forEach(slotId => {
        const slot = saveSlots[slotId];
        const row = document.createElement('label');
        row.style.cssText = 'display:flex;align-items:center;padding:10px 0;cursor:pointer;gap:10px;';
        row.innerHTML = `<input type="checkbox" class="export-save-cb" data-id="${slotId}" style="width:18px;height:18px;"> <span>${(slot.name || '未命名存档')}（${new Date(slot.date).toLocaleString()}）</span>`;
        container.appendChild(row);
    });
    document.getElementById('export-save-modal').style.display = 'flex';
    document.getElementById('export-save-modal').style.alignItems = 'center';
    document.getElementById('export-save-modal').style.justifyContent = 'center';
}

function closeExportSaveModal() {
    document.getElementById('export-save-modal').style.display = 'none';
}

function toggleExportSelectAll() {
    const cbs = document.querySelectorAll('#export-save-list .export-save-cb');
    const anyUnchecked = Array.from(cbs).some(cb => !cb.checked);
    cbs.forEach(cb => { cb.checked = anyUnchecked; });
}

function doExportSelected() {
    const cbs = document.querySelectorAll('#export-save-list .export-save-cb:checked');
    if (!cbs.length) {
        showErrorModal('请至少选择一项存档再导出。');
        return;
    }
    const items = [];
    cbs.forEach(cb => {
        const id = cb.getAttribute('data-id');
        if (id === '__current__') {
            items.push({
                name: (gameState.currentSaveId && saveSlots[gameState.currentSaveId]) ? (saveSlots[gameState.currentSaveId].name || '当前存档') : '当前游戏状态',
                date: new Date().toISOString(),
                data: JSON.parse(JSON.stringify(gameState))
            });
        } else if (saveSlots[id]) {
            items.push({
                name: saveSlots[id].name || '未命名存档',
                date: saveSlots[id].date,
                data: JSON.parse(JSON.stringify(saveSlots[id].data))
            });
        }
    });
    if (items.length === 0) {
        showErrorModal('未选中有效存档。');
        return;
    }
    const payload = items.length === 1 ? items[0] : items;
    const json = JSON.stringify(payload, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = items.length === 1
        ? '宫女升职记_存档_' + (items[0].name || '存档').replace(/[\\/:*?"<>|]/g, '_') + '_' + new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '').replace(' ', '_') + '.json'
        : '宫女升职记_存档_批量_' + new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '').replace(' ', '_') + '.json';
    a.click();
    URL.revokeObjectURL(url);
    closeExportSaveModal();
    showTipModal(items.length === 1 ? '已导出 1 份存档。' : '已导出 ' + items.length + ' 份存档为一份文档。', '导出成功');
}

// 导入存档：选择 JSON 文件后加入存档列表
function importSave(ev) {
    const input = ev.target;
    const file = input.files && input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function () {
        try {
            const raw = reader.result;
            const parsed = JSON.parse(raw);
            const toAdd = [];
            if (Array.isArray(parsed)) {
                parsed.forEach((item, idx) => {
                    if (item && item.data && item.data.player) {
                        toAdd.push({ name: (item.name && String(item.name).trim()) ? item.name : '导入的存档_' + (idx + 1), date: item.date || new Date().toISOString(), data: item.data });
                    } else if (item && item.player && (item.npcs || item.world)) {
                        toAdd.push({ name: '导入的存档_' + (idx + 1), date: new Date().toISOString(), data: item });
                    }
                });
            } else if (parsed && parsed.data && parsed.data.player) {
                toAdd.push({
                    name: (parsed.name && String(parsed.name).trim()) ? String(parsed.name).trim() : '导入的存档',
                    date: parsed.date || new Date().toISOString(),
                    data: parsed.data
                });
            } else if (parsed && parsed.player && (parsed.npcs || parsed.world)) {
                toAdd.push({ name: '导入的存档', date: new Date().toISOString(), data: parsed });
            }
            if (toAdd.length === 0) {
                showErrorModal('无法识别存档格式，请选择本游戏导出的 .json 文件。');
                input.value = '';
                return;
            }
            toAdd.forEach(item => {
                const slotId = 'save_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);
                saveSlots[slotId] = {
                    name: item.name,
                    date: item.date,
                    data: JSON.parse(JSON.stringify(item.data))
                };
            });
            saveSaveSlots();
            renderSaveList();
            if (document.getElementById('save-game-list')) renderSaveGameList();
            input.value = '';
            showTipModal(toAdd.length === 1 ? '存档已导入，可在列表中读取。' : '已导入 ' + toAdd.length + ' 份存档。', '导入成功');
        } catch (e) {
            showErrorModal('导入失败：' + (e.message || '文件不是有效的 JSON 存档。'));
            input.value = '';
        }
    };
    reader.readAsText(file, 'UTF-8');
}

let currentDeleteSaveId = null;

function deleteSave(slotId) {
    const slot = saveSlots[slotId];
    if (!slot) return;
    
    currentDeleteSaveId = slotId;
    const modal = document.getElementById('delete-save-modal');
    document.getElementById('delete-save-name').textContent = slot.name || '未命名存档';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function closeDeleteSaveModal() {
    document.getElementById('delete-save-modal').style.display = 'none';
    currentDeleteSaveId = null;
}

function confirmDeleteSave() {
    if (currentDeleteSaveId === null) return;
    
    delete saveSlots[currentDeleteSaveId];
    saveSaveSlots();
    renderSaveList();
    closeDeleteSaveModal();
}

function openRestartModal() {
    document.querySelectorAll('#restart-inherit-list input[type="checkbox"]').forEach((cb, i) => {
        cb.checked = (cb.id === 'restart-inherit-player');
    });
    const m = document.getElementById('restart-confirm-modal');
    m.style.display = 'flex';
}

function restartInheritSelectAll(checked) {
    document.querySelectorAll('#restart-inherit-list input[type="checkbox"]').forEach(cb => { cb.checked = checked; });
}

function closeRestartModal() {
    document.getElementById('restart-confirm-modal').style.display = 'none';
}

function confirmRestart() {
    const g = id => (document.getElementById(id) || {}).checked;
    const inheritPlayer = g('restart-inherit-player');
    const inheritWorld = g('restart-inherit-world');
    const inheritStats = g('restart-inherit-stats');
    const inheritMoney = g('restart-inherit-money');
    const inheritRank = g('restart-inherit-rank');
    const inheritEquip = g('restart-inherit-equip');
    const inheritNpcs = g('restart-inherit-npcs');
    const inheritGroups = g('restart-inherit-groups');
    const inheritSocial = g('restart-inherit-social');
    const inheritChoices = g('restart-inherit-choices');
    const inheritMemory = g('restart-inherit-memory');
    const inheritEmperor = g('restart-inherit-emperor');
    const inheritInvest = g('restart-inherit-invest');
    const inheritPrices = g('restart-inherit-prices');
    const inheritChildren = g('restart-inherit-children');
    const inheritTime = g('restart-inherit-time');
    const prev = gameState;
    const tc = prev.themeColors || {};
    const originBonuses = { '官宦': { fame: 50, wisdom: 5 }, '商贾': { money: 100, charm: 5 }, '平民': { energy: 20, martial: 5 }, '医女': { wisdom: 10 }, '书香': { wisdom: 10, elegance: 5 }, '武将': { martial: 10, constitution: 5 }, '乐师': { music: 10, charm: 5 }, '绣娘': { embroidery: 10, elegance: 5 }, '舞姬': { dance: 10, attraction: 5 }, '商女': { money: 80, attraction: 5 }, '孤女': { cunning: 10, constitution: 5 }, '罪臣': { cunning: 10, constitution: 5 }, '外族': { martial: 8, attraction: 5 }, '庶女': { cunning: 8, wisdom: 5 }, '嫡女': { elegance: 8, fame: 30 }, '宫女': { constitution: 8, embroidery: 5 }, '道士': { wisdom: 8, cunning: 5 }, '江湖': { martial: 8, attraction: 5 }, '青楼': { attraction: 10, music: 5 }, '农家': { constitution: 10, embroidery: 5 }, '工匠': { wisdom: 5, constitution: 5 } };
    const bonus = originBonuses[prev.player?.origin || '平民'] || {};
    const baseMoney = 10 + (bonus.money || 0);
    const baseFame = bonus.fame || 0;
    const effRank = inheritRank ? (prev.player?.rank ?? 0) : 0;
    const initLocs = (RANKS[effRank] && RANKS[effRank].map) ? RANKS[effRank].map : ['御膳房', '浣衣局', '下人房'];
    gameState = {
        player: {
            name: inheritPlayer ? (prev.player?.name || '魏璎珞') : '魏璎珞',
            origin: inheritPlayer ? (prev.player?.origin || '平民') : '平民',
            age: inheritPlayer ? (prev.player?.age ?? 15) : 15,
            characterDesc: inheritPlayer ? (prev.player?.characterDesc || '') : '',
            gender: inheritPlayer ? (prev.player?.gender || '女') : '女',
            rank: inheritRank ? (prev.player?.rank ?? 0) : 0,
            stats: inheritStats && prev.player?.stats ? JSON.parse(JSON.stringify(prev.player.stats)) : JSON.parse(JSON.stringify(prev.player?.stats || {})),
            skills: inheritStats && prev.player?.skills ? prev.player.skills : {},
            achievements: [],
            socialLevel: inheritNpcs ? (prev.player?.socialLevel || 0) : 0,
            socialInfluence: inheritNpcs ? (prev.player?.socialInfluence || 0) : 0,
            relationships: inheritNpcs && prev.player?.relationships ? prev.player.relationships : {},
            schedule: [],
            children: inheritChildren && prev.player?.children ? JSON.parse(JSON.stringify(prev.player.children)) : [],
            storyProgress: {},
            choices: inheritChoices && prev.player?.choices ? JSON.parse(JSON.stringify(prev.player.choices)) : [],
            dailyStories: inheritChoices && prev.player?.dailyStories ? JSON.parse(JSON.stringify(prev.player.dailyStories)) : [],
            inventory: inheritEquip && prev.player?.inventory ? JSON.parse(JSON.stringify(prev.player.inventory)) : [],
            equipped: inheritEquip && prev.player?.equipped ? JSON.parse(JSON.stringify(prev.player.equipped)) : { clothes: null, accessory: null },
            pregnancy: { isPregnant: false, month: 0, pregnancyStartTime: 0, fatherNpcId: null },
            emperorAffection: inheritEmperor ? (prev.player?.emperorAffection ?? 0) : 0
        },
        themeColors: { primary: tc.primary || "#757ED3", secondary: tc.secondary || "#AFB4E1", bg: tc.bg || "#D1D4E8", text: tc.text || "#4a403a", accent: tc.accent || "#8E96D9", danger: tc.danger || "#C85A7A" },
        world: {
            dynasty: inheritWorld ? (prev.world?.dynasty || '大盛') : '大盛',
            emperorDesc: inheritWorld ? (prev.world?.emperorDesc || '') : '',
            year: inheritTime && prev.world?.year ? prev.world.year : 15,
            month: inheritTime && prev.world?.month ? prev.world.month : 1,
            day: inheritTime && prev.world?.day ? prev.world.day : 1,
            timeOfDay: inheritTime && prev.world?.timeOfDay != null ? prev.world.timeOfDay : 0,
            season: inheritTime && prev.world?.season != null ? prev.world.season : 0,
            timeSpeed: prev.world?.timeSpeed ?? 1,
            festivals: {},
            unlockedLocations: inheritRank && prev.world?.unlockedLocations ? prev.world.unlockedLocations : initLocs
        },
        npcs: inheritNpcs && prev.npcs ? JSON.parse(JSON.stringify(prev.npcs)) : [],
        currentSaveId: null,
        memorySettings: inheritMemory && prev.memorySettings ? prev.memorySettings : {},
        groupMemorySettings: inheritMemory && prev.groupMemorySettings ? prev.groupMemorySettings : {},
        tasks: [],
        items: prev.items ? JSON.parse(JSON.stringify(prev.items)) : [],
        clothes: prev.clothes ? JSON.parse(JSON.stringify(prev.clothes)) : [],
        accessories: prev.accessories ? JSON.parse(JSON.stringify(prev.accessories)) : [],
        groups: inheritGroups && prev.groups ? JSON.parse(JSON.stringify(prev.groups)) : [],
        socialPosts: inheritSocial && prev.socialPosts ? JSON.parse(JSON.stringify(prev.socialPosts)) : [],
        socialCircles: inheritSocial && prev.socialCircles ? JSON.parse(JSON.stringify(prev.socialCircles)) : [],
        socialCircleMemoryPostCount: prev.socialCircleMemoryPostCount ?? 10,
        todayVisitedLocations: [],
        plotThreads: {},
        energyEndOfDayHistory: [],
        collapsed: false,
        sickRecoveryDays: 0,
        dead: false,
        chilblainsHands: false,
        currentSocialCircleId: null,
        currentLocation: null,
        chatTargetId: null,
        chatHistoryLog: [],
        events: [],
        investments: inheritInvest && prev.investments ? JSON.parse(JSON.stringify(prev.investments)) : [],
        loans: inheritInvest && prev.loans ? JSON.parse(JSON.stringify(prev.loans)) : [],
        prices: inheritPrices && prev.prices ? JSON.parse(JSON.stringify(prev.prices)) : {},
        emperorMemory: []
    };
    gameState.player.stats.energy = 100;
    gameState.player.stats.maxEnergy = gameState.player.stats.maxEnergy || 100;
    if (!inheritMoney) gameState.player.stats.money = baseMoney;
    if (!inheritStats && !inheritRank) gameState.player.stats.fame = baseFame;
    if (!inheritEquip) {
        gameState.player.inventory = [];
        gameState.player.equipped = { clothes: null, accessory: null };
    }
    initItems();
    initClothes();
    updateSeason();
    checkItemSets();
    generateMap();
    initGameSystems();
    closeRestartModal();
    goToPage('page-game');
    updateDashboard();
    showTipModal('重开成功', '提示');
}

function saveGame() {
    openSaveGameModal();
}

// 打开保存游戏弹窗
function openSaveGameModal() {
    const modal = document.getElementById('save-game-modal');
    if (modal) {
        modal.style.display = 'flex';
        renderSaveGameList();
    }
}

// 关闭保存游戏弹窗
function closeSaveGameModal() {
    const modal = document.getElementById('save-game-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// 渲染保存游戏弹窗中的存档列表
function renderSaveGameList() {
    const container = document.getElementById('save-game-list');
    if (!container) return;
    
    container.innerHTML = "";
    
    const slots = Object.keys(saveSlots).sort((a, b) => {
        return new Date(saveSlots[b].date) - new Date(saveSlots[a].date);
    });
    
    if (slots.length === 0) {
        container.innerHTML = "<p style='text-align:center;color:#8E96D9;padding:20px;'>暂无存档</p>";
        return;
    }
    
    slots.forEach(slotId => {
        const slot = saveSlots[slotId];
        const card = document.createElement('div');
        card.className = 'save-slot-card';
        card.onclick = function() {
            overwriteSave(slotId);
        };
        
        const isCurrentSave = gameState.currentSaveId === slotId;
        const currentBadge = isCurrentSave ? '<span style="background:var(--accent);color:white;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:8px;">当前</span>' : '';
        
        card.innerHTML = `
            <div class="save-slot-info">
                <h4>${slot.name || '未命名存档'}${currentBadge}</h4>
                <p>保存时间: ${new Date(slot.date).toLocaleString()}</p>
            </div>
            <div style="color:var(--accent);font-size:20px;">→</div>
        `;
        container.appendChild(card);
    });
}

// 创建新存档
function createNewSave() {
    const name = prompt("请输入存档名称：", `存档${Object.keys(saveSlots).length + 1}`);
    if (!name || !name.trim()) {
        return;
    }
    
    // 保存当前配色到gameState
    saveThemeToGameState();
    
    // 生成新的存档ID
    const slotId = 'save_' + Date.now();
    gameState.currentSaveId = slotId;
    
    // 创建新存档
    saveSlots[slotId] = {
        name: name.trim(),
        date: new Date().toISOString(),
        data: JSON.parse(JSON.stringify(gameState))
    };
    
    saveSaveSlots();
    closeSaveGameModal();
    alert(`存档"${name.trim()}"已创建！`);
}

// 覆盖已有存档
let pendingOverwriteSlotId = null;

function overwriteSave(slotId) {
    const slot = saveSlots[slotId];
    if (!slot) {
        showErrorModal("存档不存在！");
        return;
    }
    
    pendingOverwriteSlotId = slotId;
    showConfirmOverwriteSaveModal(slot.name);
}

// 显示确认覆盖存档弹窗
function showConfirmOverwriteSaveModal(slotName) {
    const modal = document.getElementById('confirm-overwrite-save-modal');
    const messageEl = document.getElementById('confirm-overwrite-save-message');
    if (messageEl) {
        messageEl.innerHTML = `确定要覆盖存档<br><strong style="color:var(--primary);">"${slotName}"</strong><br>此操作不可撤销！`;
    }
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function closeConfirmOverwriteSaveModal() {
    document.getElementById('confirm-overwrite-save-modal').style.display = 'none';
    pendingOverwriteSlotId = null;
}

function showEndingModal() {
    var m = document.getElementById('ending-modal');
    if (m) {
        document.getElementById('ending-experience-box').style.display = 'none';
        document.getElementById('ending-experience-box').innerHTML = '';
        m.style.display = 'flex';
        m.style.alignItems = 'center';
        m.style.justifyContent = 'center';
    }
}
function closeEndingModal() {
    var m = document.getElementById('ending-modal');
    if (m) m.style.display = 'none';
}
function onEndingViewExperience() {
    if (!settings.apiKey || !settings.apiUrl) {
        showErrorModal('请先在设置中配置 API 后使用「看经历」。');
        return;
    }
    var box = document.getElementById('ending-experience-box');
    if (!box) return;
    box.style.display = 'block';
    box.textContent = '正在生成经历…（会调用 API）';
    var choices = (gameState.player.choices || []).slice(-30).map(function(c) { return (c.title || '') + ' ' + (c.choice || '').substring(0, 300); }).join('\n');
    var daily = (gameState.player.dailyStories || []).slice(-10).map(function(d) { return (d.title || '') + ' ' + (d.content || '').substring(0, 200); }).join('\n');
    var ctx = '朝代：' + (gameState.world.dynasty || '') + '，皇帝：' + (gameState.world.emperorDesc || '') + '。\n角色：' + (gameState.player.name || '') + '，出身：' + (gameState.player.origin || '') + '。\n重要选择与剧情：\n' + choices + '\n每日剧情：\n' + daily;
    fetch(settings.apiUrl + '/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settings.apiKey },
        body: JSON.stringify({
            model: settings.model || 'gpt-3.5-turbo',
            messages: [
                { role: 'system', content: '你是一个宫廷题材叙事者。根据玩家游戏记录，用一段流畅的古风文字（约300～600字）概括这一生的经历与结局，语气凝练、有感染力。只输出这段经历正文，不要标题或多余说明。' },
                { role: 'user', content: ctx }
            ],
            max_tokens: 1200,
            temperature: 0.8
        })
    }).then(function(r) { return r.json(); }).then(function(data) {
        var text = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? data.choices[0].message.content.trim() : '生成失败或未返回内容。';
        box.textContent = text;
    }).catch(function(e) {
        box.textContent = '调用 API 失败：' + (e.message || String(e));
    });
}
function onEndingRestart() {
    closeEndingModal();
    goToPage('page-home');
}

function confirmOverwriteSave() {
    if (pendingOverwriteSlotId === null) return;
    
    const slotId = pendingOverwriteSlotId;
    const slot = saveSlots[slotId];
    if (!slot) return;
    
    // 保存当前配色到gameState
    saveThemeToGameState();
    
    // 更新存档
    gameState.currentSaveId = slotId;
    saveSlots[slotId].data = JSON.parse(JSON.stringify(gameState));
    saveSlots[slotId].date = new Date().toISOString();
    
    saveSaveSlots();
    closeSaveGameModal();
    closeConfirmOverwriteSaveModal();
    showSaveUpdatedModal(slot.name);
}

// 显示存档已更新弹窗
function showSaveUpdatedModal(slotName) {
    const modal = document.getElementById('save-updated-modal');
    const titleEl = document.getElementById('save-updated-title');
    if (titleEl) {
        titleEl.textContent = `存档"${slotName}"已更新！`;
    }
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function closeSaveUpdatedModal() {
    document.getElementById('save-updated-modal').style.display = 'none';
}

// 配色相关函数
function applyTheme(colors) {
    if (!colors) return;
    const root = document.documentElement;
    root.style.setProperty('--primary', colors.primary || "#757ED3");
    root.style.setProperty('--secondary', colors.secondary || "#AFB4E1");
    root.style.setProperty('--bg', colors.bg || "#D1D4E8");
    root.style.setProperty('--text', colors.text || "#4a403a");
    root.style.setProperty('--accent', colors.accent || "#8E96D9");
    root.style.setProperty('--danger', colors.danger || "#C85A7A");
}

function saveThemeToGameState() {
    if (!gameState.themeColors) {
        gameState.themeColors = {};
    }
    const themePrimary = document.getElementById('theme-primary');
    const themeSecondary = document.getElementById('theme-secondary');
    const themeBg = document.getElementById('theme-bg');
    const themeText = document.getElementById('theme-text');
    const themeAccent = document.getElementById('theme-accent');
    const themeDanger = document.getElementById('theme-danger');
    
    if (themePrimary) gameState.themeColors.primary = themePrimary.value || "#757ED3";
    if (themeSecondary) gameState.themeColors.secondary = themeSecondary.value || "#AFB4E1";
    if (themeBg) gameState.themeColors.bg = themeBg.value || "#D1D4E8";
    if (themeText) gameState.themeColors.text = themeText.value || "#4a403a";
    if (themeAccent) gameState.themeColors.accent = themeAccent.value || "#8E96D9";
    if (themeDanger) gameState.themeColors.danger = themeDanger.value || "#C85A7A";
}

function saveTheme() {
    saveThemeToGameState();
    applyTheme(gameState.themeColors);
    showThemeSavedModal("配色已保存！配色会随存档一起保存。记得保存设置和保存存档哦");
}

function resetTheme() {
    const defaultColors = {
        primary: "#757ED3",
        secondary: "#AFB4E1",
        bg: "#D1D4E8",
        text: "#4a403a",
        accent: "#8E96D9",
        danger: "#C85A7A"
    };
    
    if (document.getElementById('theme-primary')) {
        document.getElementById('theme-primary').value = defaultColors.primary;
    }
    if (document.getElementById('theme-secondary')) {
        document.getElementById('theme-secondary').value = defaultColors.secondary;
    }
    if (document.getElementById('theme-bg')) {
        document.getElementById('theme-bg').value = defaultColors.bg;
    }
    if (document.getElementById('theme-text')) {
        document.getElementById('theme-text').value = defaultColors.text;
    }
    if (document.getElementById('theme-accent')) {
        document.getElementById('theme-accent').value = defaultColors.accent;
    }
    if (document.getElementById('theme-danger')) {
        document.getElementById('theme-danger').value = defaultColors.danger;
    }
    
    applyTheme(defaultColors);
    saveThemeToGameState();
}

function updateThemePreview() {
    const colors = {
        primary: document.getElementById('theme-primary')?.value || "#757ED3",
        secondary: document.getElementById('theme-secondary')?.value || "#AFB4E1",
        bg: document.getElementById('theme-bg')?.value || "#D1D4E8",
        text: document.getElementById('theme-text')?.value || "#4a403a",
        accent: document.getElementById('theme-accent')?.value || "#8E96D9",
        danger: document.getElementById('theme-danger')?.value || "#C85A7A"
    };
    
    // 实时预览
    applyTheme(colors);
}

// 将各种颜色格式转换为十六进制格式
function parseColor(colorValue) {
    if (!colorValue || !colorValue.trim()) {
        return null;
    }
    
    const value = colorValue.trim();
    
    // 如果已经是有效的十六进制颜色
    if (/^#[0-9A-Fa-f]{6}$/.test(value) || /^#[0-9A-Fa-f]{3}$/.test(value)) {
        // 如果是3位十六进制，转换为6位
        if (value.length === 4) {
            return '#' + value[1] + value[1] + value[2] + value[2] + value[3] + value[3];
        }
        return value.toUpperCase();
    }
    
    // 处理rgb格式：rgb(255, 0, 0) 或 rgba(255, 0, 0, 1)
    const rgbMatch = value.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)$/);
    if (rgbMatch) {
        const r = parseInt(rgbMatch[1]);
        const g = parseInt(rgbMatch[2]);
        const b = parseInt(rgbMatch[3]);
        return '#' + [r, g, b].map(x => {
            const hex = x.toString(16);
            return hex.length === 1 ? '0' + hex : hex;
        }).join('').toUpperCase();
    }
    
    // 处理不带#的十六进制
    if (/^[0-9A-Fa-f]{6}$/.test(value)) {
        return '#' + value.toUpperCase();
    }
    if (/^[0-9A-Fa-f]{3}$/.test(value)) {
        return '#' + value[0] + value[0] + value[1] + value[1] + value[2] + value[2];
    }
    
    // 尝试使用浏览器内置的颜色解析（支持颜色名称如red, blue等）
    const tempDiv = document.createElement('div');
    tempDiv.style.color = value;
    document.body.appendChild(tempDiv);
    const computedColor = window.getComputedStyle(tempDiv).color;
    document.body.removeChild(tempDiv);
    
    if (computedColor && computedColor !== 'rgba(0, 0, 0, 0)') {
        const rgbMatch2 = computedColor.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
        if (rgbMatch2) {
            const r = parseInt(rgbMatch2[1]);
            const g = parseInt(rgbMatch2[2]);
            const b = parseInt(rgbMatch2[3]);
            return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('').toUpperCase();
        }
    }
    
    return null;
}

function updateThemeFromText(colorType) {
    const textInput = document.getElementById(`theme-${colorType}-text`);
    const colorInput = document.getElementById(`theme-${colorType}`);
    
    if (!textInput || !colorInput) {
        return;
    }
    
    const inputValue = textInput.value.trim();
    
    // 如果输入为空，不处理
    if (!inputValue) {
        return;
    }
    
    // 解析颜色值
    const hexColor = parseColor(inputValue);
    
    if (hexColor) {
        // 更新颜色选择器和文本输入框
        colorInput.value = hexColor;
        textInput.value = hexColor;
        // 更新预览
        updateThemePreview();
    } else {
        // 如果颜色无效，恢复原值并提示
        const originalValue = colorInput.value;
        textInput.value = originalValue;
        // 可以添加一个短暂的提示，但为了不打扰用户，这里只是恢复原值
        textInput.style.borderColor = '#FF6B6B';
        setTimeout(() => {
            textInput.style.borderColor = '#ddd';
        }, 1000);
    }
}

function loadGame() {
    goToPage('page-load');
    renderSaveList();
}

// ========== 物品系统（增强版）==========
function initItems() {
    gameState.items = [
        { 
            id: 1, 
            name: "银两", 
            type: "currency", 
            count: 0,
            quality: "common"
        },
        { 
            id: 2, 
            name: "人参", 
            type: "item", 
            desc: "恢复体力+20", 
            effect: { energy: 20 }, 
            count: 0,
            quality: "common",
            durability: null, // null表示无耐久限制
            story: "普通的人参，可以恢复体力"
        },
        { 
            id: 3, 
            name: "胭脂", 
            type: "item", 
            desc: "提升容貌+5", 
            effect: { charm: 5 }, 
            count: 0,
            quality: "common",
            durability: null,
            story: "普通的胭脂，可以略微提升容貌"
        },
        { 
            id: 4, 
            name: "玉佩", 
            type: "item", 
            desc: "提升气质+5", 
            effect: { elegance: 5 }, 
            count: 0,
            quality: "rare",
            durability: null,
            story: "精美的玉佩，可以提升气质",
            set: "优雅套装" // 套装名称
        },
        {
            id: 5,
            name: "千年人参",
            type: "item",
            desc: "恢复体力+50，提升健康+10",
            effect: { energy: 50, health: 10 },
            count: 0,
            quality: "legendary",
            durability: null,
            story: "传说中的千年人参，有起死回生之效"
        },
        {
            id: 6,
            name: "避孕汤",
            type: "item",
            desc: "服用后一周内不会怀孕；若已怀孕则会导致流产（可能掉容貌或银两）",
            effect: null,
            count: 0,
            quality: "common",
            durability: null,
            story: "宫中所备的避子汤药，谨慎使用。",
            isContraceptive: true
        },
        {
            id: 7,
            name: "擦手霜",
            type: "item",
            desc: "缓解冻疮、手干裂流血；可送人（二等宫女以下也易生冻疮）",
            effect: { health: 5 },
            count: 0,
            quality: "common",
            durability: null,
            story: "冬日护手良品，内务府有售，冬季会涨价。"
        }
    ];
    
    // 初始化套装数据
    gameState.itemSets = {
        "优雅套装": {
            name: "优雅套装",
            items: [4], // 物品ID列表
            effect: { elegance: 10, charm: 5 }, // 套装效果
            count: 0 // 已收集数量
        }
    };
}

function renderInventory() {
    const container = document.getElementById('inventory-container');
    container.innerHTML = "";
    
    const qualityColors = {
        common: "#666",
        rare: "#8E96D9",
        legendary: "#AFB4E1"
    };
    
    gameState.items.forEach(item => {
        if (item.count > 0 || item.type === "currency") {
            const quality = item.quality || "common";
            const card = document.createElement('div');
            card.className = `item-card ${quality === 'legendary' ? 'rare' : ''}`;
            card.style.borderColor = qualityColors[quality] || "#666";
            card.innerHTML = `
                <div style="font-size:20px;">${item.type === "currency" ? "💰" : "📦"}</div>
                <div><strong>${item.name}</strong> ${quality !== 'common' ? `<span style="font-size:10px;color:${qualityColors[quality]};">[${quality === 'rare' ? '稀有' : '传说'}]</span>` : ''}</div>
                <div style="font-size:11px;color:#757ED3;">${item.desc || ""}</div>
                ${item.story ? `<div style="font-size:10px;color:#8E96D9;margin-top:3px;">${item.story}</div>` : ''}
                ${item.durability !== null ? `<div style="font-size:10px;color:var(--danger);">耐久: ${item.durability}</div>` : ''}
                ${item.set ? `<div style="font-size:10px;color:var(--accent);">套装: ${item.set}</div>` : ''}
                <div style="font-size:12px;color:var(--accent);">数量: ${item.type === "currency" ? gameState.player.stats.money : item.count}</div>
                ${(item.effect || item.isContraceptive) ? `<button class="btn" style="width:auto;padding:5px 10px;font-size:12px;margin-top:5px;" onclick="useItem(${item.id})">使用</button>` : ''}
                ${item.type !== "currency" && item.count > 0 ? `<button class="btn" style="width:auto;padding:5px 10px;font-size:12px;margin-top:5px;background:var(--accent);" onclick="showGiftContactSelectModal(${item.id})">赠送</button>` : ''}
            `;
            container.appendChild(card);
        }
    });
    
    // 显示套装效果
    if (gameState.itemSets) {
        container.innerHTML += "<h4 style='margin-top:15px;'>套装效果</h4>";
        Object.values(gameState.itemSets).forEach(set => {
            if (set.count > 0) {
                const setCard = document.createElement('div');
                setCard.className = "item-card rare";
                setCard.innerHTML = `
                    <div><strong>${set.name}</strong></div>
                    <div style="font-size:11px;">已收集: ${set.count}/${set.items.length}</div>
                    ${set.count === set.items.length ? `<div style="font-size:11px;color:#8E96D9;">✓ 套装效果激活</div>` : ''}
                `;
                container.appendChild(setCard);
            }
        });
    }
    
    if (container.innerHTML === "") {
        container.innerHTML = "<p style='text-align:center;color:#8E96D9'>物品栏为空</p>";
    }
}

function useItem(itemId) {
    const id = Number(itemId);
    const item = gameState.items.find(i => i.id == id);
    if (!item) {
        showErrorModal('未找到该物品，请刷新物品栏后重试。');
        return;
    }
    if (item.count == null || item.count <= 0) {
        showErrorModal('「' + (item.name || '该物品') + '」数量不足，无法使用。\n\n请确认物品栏中数量大于 0 后再试。');
        return;
    }
    
    // 检查耐久度
    if (item.durability !== null && item.durability <= 0) {
        showErrorModal('「' + item.name + '」已损坏，无法使用。');
        return;
    }
    
    if (item.name === '擦手霜') {
        gameState.chilblainsHands = false;
        if (gameState.player.stats.health != null) gameState.player.stats.health = Math.min(100, gameState.player.stats.health + 5);
        item.count--;
        showTipModal('使用了擦手霜，手部冻疮干裂缓解，健康+5。', '擦手霜');
        updateDashboard();
        renderInventory();
        return;
    }
    // 避孕汤：一周内不怀孕；若已怀孕则流产，有几率掉容貌或银两
    if (item.isContraceptive || item.name === '避孕汤') {
        var p = gameState.player;
        p.contraceptiveUntil = Date.now() + 7 * 24 * 60 * 60 * 1000;
        var msg = '已服用避孕汤，一周内不会怀孕。';
        if (p.pregnancy && p.pregnancy.isPregnant) {
            p.pregnancy.isPregnant = false;
            p.pregnancy.month = 0;
            p.pregnancy.pregnancyStartTime = 0;
            p.pregnancy.fatherNpcId = null;
            var roll = Math.random();
            if (roll < 0.35) {
                var charmLoss = Math.min(5, Math.floor(p.stats.charm * 0.1) + 1);
                if (charmLoss > 0) { p.stats.charm = Math.max(0, p.stats.charm - charmLoss); msg += '\n\n流产导致身体受损，容貌-' + charmLoss + '。'; }
            } else if (roll < 0.7) {
                var moneyLoss = Math.min(100, Math.floor((p.stats.money || 0) * 0.15) + 20);
                if (moneyLoss > 0) { p.stats.money = Math.max(0, (p.stats.money || 0) - moneyLoss); msg += '\n\n流产后续调理花费，银两-' + moneyLoss + '。'; }
            }
            if (msg === '已服用避孕汤，一周内不会怀孕。') msg += '\n\n已流产，身体暂无大碍。';
        }
        item.count--;
        showTipModal(msg, '避孕汤');
        updateDashboard();
        renderInventory();
        return;
    }
    
    if (item.effect) {
        if (item.effect.energy) gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + item.effect.energy);
        if (item.effect.charm) gameState.player.stats.charm = Math.min(gameState.player.stats.maxCharm || 100, gameState.player.stats.charm + item.effect.charm);
        if (item.effect.elegance) gameState.player.stats.elegance = Math.min(gameState.player.stats.maxElegance || 100, gameState.player.stats.elegance + item.effect.elegance);
        if (item.effect.health) gameState.player.stats.health = Math.min(100, gameState.player.stats.health + item.effect.health);
        
        // 减少耐久度
        let durabilityGone = false;
        if (item.durability !== null) {
            item.durability--;
            if (item.durability <= 0) {
                item.count--;
                durabilityGone = true;
            }
        } else {
            item.count--;
        }
        
        // 使用成功弹窗：显示物品名与属性变化
        const effectParts = [];
        if (item.effect.energy) effectParts.push('体力+' + item.effect.energy);
        if (item.effect.charm) effectParts.push('容貌+' + item.effect.charm);
        if (item.effect.elegance) effectParts.push('气质+' + item.effect.elegance);
        if (item.effect.health) effectParts.push('健康+' + item.effect.health);
        let msg = '已使用「' + item.name + '」。';
        if (effectParts.length) msg += '\n\n属性变化：' + effectParts.join('、');
        if (durabilityGone) msg += '\n\n该物品已损坏并消耗完毕。';
        if (item.story) msg += '\n\n' + item.story;
        showTipModal(msg, '使用成功');
        
        updateDashboard(); // 刷新顶栏与换装页当前属性
        renderInventory();
        checkItemSets(); // 检查套装效果
    }
}

function checkItemSets() {
    Object.keys(gameState.itemSets || {}).forEach(setName => {
        const set = gameState.itemSets[setName];
        const ownedCount = set.items.filter(itemId => {
            const item = gameState.items.find(i => i.id === itemId);
            return item && item.count > 0;
        }).length;
        
        set.count = ownedCount;
    });
}

function combineItems(itemIds) {
    // 物品合成功能
    const recipes = {
        "1,2,3": { result: 5, desc: "合成千年人参" } // 示例：物品1+2+3=5
    };
    
    const key = itemIds.sort().join(',');
    if (recipes[key]) {
        const recipe = recipes[key];
        // 检查物品是否足够
        for (const id of itemIds) {
            const item = gameState.items.find(i => i.id === id);
            if (!item || item.count <= 0) {
                alert("合成材料不足！");
                return false;
            }
        }
        
        // 消耗材料
        for (const id of itemIds) {
            const item = gameState.items.find(i => i.id === id);
            item.count--;
        }
        
        // 获得结果
        const result = gameState.items.find(i => i.id === recipe.result);
        if (result) {
            result.count++;
            alert(`合成成功！获得：${result.name}`);
            renderInventory();
            return true;
        }
    }
    
    return false;
}

// ========== 换装系统 ==========
function initClothes() {
    gameState.clothes = [
        { id: 1, name: "粗布衣", type: "clothes", charm: 0, elegance: 0, owned: true, quality: "common", color: "#8B7355", set: null, special: null },
        { id: 2, name: "素色宫装", type: "clothes", charm: 5, elegance: 3, owned: false, price: 50, quality: "common", color: "#E8E8E8", set: "素雅套装", special: null },
        { id: 3, name: "锦绣华服", type: "clothes", charm: 15, elegance: 10, owned: false, price: 200, quality: "rare", color: "#FF6B9D", set: "华丽套装", special: null },
        { id: 4, name: "凤袍", type: "clothes", charm: 30, elegance: 25, owned: false, price: 1000, quality: "legendary", color: "#AFB4E1", set: "皇家套装", special: "隐藏身份" },
        { id: 5, name: "青色素罗裙", type: "clothes", charm: 4, elegance: 2, owned: false, price: 40, quality: "common", color: "#7BA05B", set: null, special: null },
        { id: 6, name: "藕荷色襦裙", type: "clothes", charm: 6, elegance: 4, owned: false, price: 60, quality: "common", color: "#E6C4A0", set: null, special: null },
        { id: 7, name: "月白色纱衣", type: "clothes", charm: 7, elegance: 5, owned: false, price: 80, quality: "common", color: "#F5F5DC", set: null, special: null },
        { id: 8, name: "桃红对襟襦裙", type: "clothes", charm: 8, elegance: 4, owned: false, price: 70, quality: "common", color: "#F4A6A6", set: null, special: null },
        { id: 9, name: "竹叶青褙子", type: "clothes", charm: 6, elegance: 6, owned: false, price: 90, quality: "common", color: "#5F9B6B", set: null, special: null },
        { id: 10, name: "鸦青长衫", type: "clothes", charm: 5, elegance: 5, owned: false, price: 55, quality: "common", color: "#374151", set: null, special: null },
        { id: 11, name: "湘妃色罗裳", type: "clothes", charm: 9, elegance: 6, owned: false, price: 100, quality: "common", color: "#D4A5A5", set: null, special: null },
        { id: 12, name: "天水碧襦裙", type: "clothes", charm: 7, elegance: 7, owned: false, price: 95, quality: "common", color: "#89CFF0", set: null, special: null },
        { id: 13, name: "绛紫云纹衫", type: "clothes", charm: 10, elegance: 7, owned: false, price: 120, quality: "common", color: "#7B2D8E", set: null, special: null },
        { id: 14, name: "茜色百褶裙", type: "clothes", charm: 8, elegance: 8, owned: false, price: 110, quality: "common", color: "#C23B22", set: null, special: null },
        { id: 15, name: "鹅黄半臂", type: "clothes", charm: 6, elegance: 5, owned: false, price: 65, quality: "common", color: "#F5DEB3", set: null, special: null },
        { id: 16, name: "石榴红襦裙", type: "clothes", charm: 11, elegance: 6, owned: false, price: 130, quality: "rare", color: "#E74C3C", set: null, special: null },
        { id: 17, name: "碧玉纱衣", type: "clothes", charm: 9, elegance: 9, owned: false, price: 150, quality: "rare", color: "#2ECC71", set: null, special: null },
        { id: 18, name: "海棠红大袖衫", type: "clothes", charm: 12, elegance: 10, owned: false, price: 180, quality: "rare", color: "#DB7093", set: null, special: null },
        { id: 19, name: "琥珀色锦袍", type: "clothes", charm: 10, elegance: 11, owned: false, price: 200, quality: "rare", color: "#CD7F32", set: null, special: null },
        { id: 20, name: "丁香紫罗衣", type: "clothes", charm: 11, elegance: 9, owned: false, price: 170, quality: "rare", color: "#B695C0", set: null, special: null },
        { id: 21, name: "杏色织锦襦", type: "clothes", charm: 10, elegance: 10, owned: false, price: 160, quality: "rare", color: "#E8B88B", set: null, special: null },
        { id: 22, name: "墨绿云锦衫", type: "clothes", charm: 12, elegance: 11, owned: false, price: 220, quality: "rare", color: "#2C5F2D", set: null, special: null },
        { id: 23, name: "胭脂色流霞裙", type: "clothes", charm: 14, elegance: 10, owned: false, price: 250, quality: "rare", color: "#C41E3A", set: null, special: null },
        { id: 24, name: "湖蓝缂丝衫", type: "clothes", charm: 11, elegance: 12, owned: false, price: 230, quality: "rare", color: "#4A90D9", set: null, special: null },
        { id: 25, name: "朱砂宫装", type: "clothes", charm: 13, elegance: 12, owned: false, price: 280, quality: "rare", color: "#E34234", set: null, special: null },
        { id: 26, name: "银红织金襦", type: "clothes", charm: 14, elegance: 11, owned: false, price: 300, quality: "rare", color: "#DC143C", set: null, special: null },
        { id: 27, name: "翠蓝绣花衫", type: "clothes", charm: 12, elegance: 13, owned: false, price: 270, quality: "rare", color: "#008B8B", set: null, special: null },
        { id: 28, name: "妃色霞帔", type: "clothes", charm: 15, elegance: 12, owned: false, price: 350, quality: "rare", color: "#F08080", set: null, special: null },
        { id: 29, name: "雪青绫罗裙", type: "clothes", charm: 13, elegance: 14, owned: false, price: 320, quality: "rare", color: "#9370DB", set: null, special: null },
        { id: 30, name: "蜜合色缎衣", type: "clothes", charm: 12, elegance: 13, owned: false, price: 290, quality: "rare", color: "#F5F5DC", set: null, special: null },
        { id: 31, name: "孔雀蓝孔雀裙", type: "clothes", charm: 16, elegance: 14, owned: false, price: 400, quality: "legendary", color: "#006994", set: null, special: null },
        { id: 32, name: "芙蓉妆花缎", type: "clothes", charm: 17, elegance: 15, owned: false, price: 450, quality: "legendary", color: "#FF69B4", set: null, special: null },
        { id: 33, name: "云锦织金袍", type: "clothes", charm: 18, elegance: 16, owned: false, price: 500, quality: "legendary", color: "#D4AF37", set: null, special: null },
        { id: 34, name: "绛纱复襦", type: "clothes", charm: 16, elegance: 17, owned: false, price: 480, quality: "legendary", color: "#8B0000", set: null, special: null },
        { id: 35, name: "霓裳羽衣", type: "clothes", charm: 20, elegance: 18, owned: false, price: 600, quality: "legendary", color: "#FFD700", set: null, special: "舞艺加成" },
        { id: 36, name: "绯色霞光襦", type: "clothes", charm: 15, elegance: 15, owned: false, price: 380, quality: "rare", color: "#FF4500", set: null, special: null },
        { id: 37, name: "松花绿襦裙", type: "clothes", charm: 11, elegance: 12, owned: false, price: 200, quality: "rare", color: "#228B22", set: null, special: null },
        { id: 38, name: "象牙白褙子", type: "clothes", charm: 13, elegance: 14, owned: false, price: 260, quality: "rare", color: "#FFFFF0", set: null, special: null },
        { id: 39, name: "鸦青对襟衫", type: "clothes", charm: 10, elegance: 11, owned: false, price: 180, quality: "rare", color: "#2F4F4F", set: null, special: null },
        { id: 40, name: "樱草黄罗裙", type: "clothes", charm: 9, elegance: 10, owned: false, price: 140, quality: "common", color: "#DFFF00", set: null, special: null },
        { id: 41, name: "靛青织锦袍", type: "clothes", charm: 14, elegance: 13, owned: false, price: 340, quality: "rare", color: "#4B0082", set: null, special: null },
        { id: 42, name: "杏子黄襦裙", type: "clothes", charm: 10, elegance: 9, owned: false, price: 155, quality: "common", color: "#DDA0DD", set: null, special: null },
        { id: 43, name: "水绿纱衣", type: "clothes", charm: 8, elegance: 9, owned: false, price: 125, quality: "common", color: "#98FB98", set: null, special: null },
        { id: 44, name: "檀香色襦衫", type: "clothes", charm: 11, elegance: 10, owned: false, price: 165, quality: "common", color: "#B8860B", set: null, special: null },
        { id: 45, name: "秋香色长衫", type: "clothes", charm: 9, elegance: 11, owned: false, price: 145, quality: "common", color: "#9ACD32", set: null, special: null },
        { id: 46, name: "赤金云纹袍", type: "clothes", charm: 19, elegance: 17, owned: false, price: 550, quality: "legendary", color: "#FFD700", set: null, special: null },
        { id: 47, name: "霁青襦裙", type: "clothes", charm: 12, elegance: 12, owned: false, price: 240, quality: "rare", color: "#4682B4", set: null, special: null },
        { id: 48, name: "妃红织金襦", type: "clothes", charm: 16, elegance: 14, owned: false, price: 420, quality: "legendary", color: "#CD5C5C", set: null, special: null },
        { id: 49, name: "月华裙", type: "clothes", charm: 17, elegance: 16, owned: false, price: 520, quality: "legendary", color: "#F0E68C", set: null, special: null },
        { id: 50, name: "团龙纹凤袍", type: "clothes", charm: 22, elegance: 20, owned: false, price: 800, quality: "legendary", color: "#8B4513", set: "皇家套装", special: "身份象征" }
    ];
    
    gameState.accessories = [
        { id: 1, name: "无", type: "accessory", charm: 0, elegance: 0, owned: true, quality: "common", color: null, set: null },
        { id: 2, name: "银簪", type: "accessory", charm: 3, elegance: 2, owned: false, price: 30, quality: "common", color: "#C0C0C0", set: "素雅套装" },
        { id: 3, name: "金步摇", type: "accessory", charm: 10, elegance: 8, owned: false, price: 150, quality: "rare", color: "#AFB4E1", set: "华丽套装" },
        { id: 4, name: "凤冠", type: "accessory", charm: 25, elegance: 20, owned: false, price: 800, quality: "legendary", color: "#AFB4E1", set: "皇家套装" }
    ];
    
    // 初始化服装套装
    gameState.clothesSets = {
        "素雅套装": {
            name: "素雅套装",
            items: [2, 2], // [衣服ID, 饰品ID]
            effect: { elegance: 5, charm: 3 }
        },
        "华丽套装": {
            name: "华丽套装",
            items: [3, 3],
            effect: { elegance: 10, charm: 8 }
        },
        "皇家套装": {
            name: "皇家套装",
            items: [4, 4],
            effect: { elegance: 20, charm: 15, fame: 50 }
        }
    };
    
    // 服装收集度
    gameState.clothesCollection = {
        total: gameState.clothes.length + gameState.accessories.length - 2, // 减去"无"
        collected: 1 // 初始只有粗布衣
    };
}

function renderDress() {
    const s = gameState.player.stats || {};
    const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.innerText = v ?? 0; };
    setVal('dress-charm', s.charm);
    setVal('dress-elegance', s.elegance);
    setVal('dress-constitution', s.constitution);
    setVal('dress-attraction', s.attraction);
    setVal('dress-wisdom', s.wisdom);
    setVal('dress-martial', s.martial);
    setVal('dress-cunning', s.cunning);
    setVal('dress-music', s.music);
    setVal('dress-dance', s.dance);
    setVal('dress-embroidery', s.embroidery);
    setVal('dress-health', s.health ?? 100);
    setVal('dress-mood', s.mood ?? 50);
    
    const clothesContainer = document.getElementById('dress-clothes-container');
    clothesContainer.innerHTML = "";
    
    // 显示当前装备状态
    if (gameState.player.equipped.clothes) {
        const equippedCloth = gameState.clothes.find(c => c.id === gameState.player.equipped.clothes);
        if (equippedCloth) {
            const card = document.createElement('div');
            card.className = `item-card ${equippedCloth.rare ? 'rare' : ''}`;
            card.innerHTML = `
                <div>👗</div>
                <div><strong>${equippedCloth.name}</strong> (已装备)</div>
                <div style="font-size:11px;">容貌+${equippedCloth.charm} 气质+${equippedCloth.elegance}</div>
                <button class="btn" style="width:auto;padding:5px 10px;font-size:11px;margin-top:5px;background:var(--danger);" onclick="unequipClothes()">脱下</button>
            `;
            clothesContainer.appendChild(card);
        }
    } else {
        const card = document.createElement('div');
        card.className = "item-card";
        card.innerHTML = `
            <div>👗</div>
            <div><strong>无</strong></div>
            <div style="font-size:11px;color:#8E96D9;">未装备服装</div>
        `;
        clothesContainer.appendChild(card);
    }
    
    // 显示其他可装备的服装
    gameState.clothes.forEach(cloth => {
        if (cloth.owned && gameState.player.equipped.clothes !== cloth.id) {
            const card = document.createElement('div');
            card.className = `item-card ${cloth.rare ? 'rare' : ''}`;
            card.innerHTML = `
                <div>👗</div>
                <div><strong>${cloth.name}</strong></div>
                <div style="font-size:11px;">容貌+${cloth.charm} 气质+${cloth.elegance}</div>
                <button class="btn" style="width:auto;padding:5px 10px;font-size:11px;margin-top:5px;" onclick="equipClothes(${cloth.id})">装备</button>
            `;
            clothesContainer.appendChild(card);
        }
    });
    
    const accessoriesContainer = document.getElementById('dress-accessories-container');
    accessoriesContainer.innerHTML = "";
    
    // 显示当前装备状态
    if (gameState.player.equipped.accessory) {
        const equippedAcc = gameState.accessories.find(a => a.id === gameState.player.equipped.accessory);
        if (equippedAcc && equippedAcc.id !== 1) { // 排除"无"
            const card = document.createElement('div');
            card.className = `item-card ${equippedAcc.rare ? 'rare' : ''}`;
            card.innerHTML = `
                <div>💍</div>
                <div><strong>${equippedAcc.name}</strong> (已装备)</div>
                <div style="font-size:11px;">容貌+${equippedAcc.charm} 气质+${equippedAcc.elegance}</div>
                <button class="btn" style="width:auto;padding:5px 10px;font-size:11px;margin-top:5px;background:var(--danger);" onclick="unequipAccessory()">脱下</button>
            `;
            accessoriesContainer.appendChild(card);
        }
    } else {
        const card = document.createElement('div');
        card.className = "item-card";
        card.innerHTML = `
            <div>💍</div>
            <div><strong>无</strong></div>
            <div style="font-size:11px;color:#8E96D9;">未装备饰品</div>
        `;
        accessoriesContainer.appendChild(card);
    }
    
    // 显示其他可装备的饰品
    gameState.accessories.forEach(acc => {
        if (acc.owned && acc.id !== 1 && gameState.player.equipped.accessory !== acc.id) {
            const card = document.createElement('div');
            card.className = `item-card ${acc.rare ? 'rare' : ''}`;
            card.innerHTML = `
                <div>💍</div>
                <div><strong>${acc.name}</strong></div>
                <div style="font-size:11px;">容貌+${acc.charm} 气质+${acc.elegance}</div>
                <button class="btn" style="width:auto;padding:5px 10px;font-size:11px;margin-top:5px;" onclick="equipAccessory(${acc.id})">装备</button>
            `;
            accessoriesContainer.appendChild(card);
        }
    });
}

function equipClothes(clothId) {
    const cloth = gameState.clothes.find(c => c.id === clothId);
    if (!cloth || !cloth.owned) return;
    
    // 检查属性上限
    const newCharm = gameState.player.stats.charm + cloth.charm;
    const newElegance = gameState.player.stats.elegance + cloth.elegance;
    if (newCharm > gameState.player.stats.maxCharm || newElegance > gameState.player.stats.maxElegance) {
        showTipModal("当前容貌或气质已达上限，无法装备更多加成。", "无法装备");
        return;
    }
    
    // 移除旧装备加成和套装效果
    if (gameState.player.equipped.clothes) {
        const oldCloth = gameState.clothes.find(c => c.id === gameState.player.equipped.clothes);
        if (oldCloth) {
            gameState.player.stats.charm -= oldCloth.charm;
            gameState.player.stats.elegance -= oldCloth.elegance;
            // 移除旧套装效果
            if (oldCloth.set) {
                removeSetEffect(oldCloth.set);
            }
        }
    }
    
    // 添加新装备加成
    gameState.player.equipped.clothes = clothId;
    gameState.player.stats.charm = Math.min(gameState.player.stats.maxCharm, gameState.player.stats.charm + cloth.charm);
    gameState.player.stats.elegance = Math.min(gameState.player.stats.maxElegance, gameState.player.stats.elegance + cloth.elegance);
    
    // 检查套装效果
    if (cloth.set) {
        checkClothesSetEffect(cloth.set);
    }
    
    showTipModal(`已装备服装：${cloth.name}。容貌与气质已更新。`, "装备成功");
    renderDress();
    updateDashboard();
}

function checkClothesSetEffect(setName) {
    const set = gameState.clothesSets[setName];
    if (!set) return;
    
    const equippedCloth = gameState.clothes.find(c => c.id === gameState.player.equipped.clothes);
    const equippedAcc = gameState.accessories.find(a => a.id === gameState.player.equipped.accessory);
    
    if (equippedCloth && equippedCloth.set === setName && equippedAcc && equippedAcc.set === setName) {
        // 激活套装效果
        if (set.effect.charm) gameState.player.stats.charm = Math.min(gameState.player.stats.maxCharm, gameState.player.stats.charm + set.effect.charm);
        if (set.effect.elegance) gameState.player.stats.elegance = Math.min(gameState.player.stats.maxElegance, gameState.player.stats.elegance + set.effect.elegance);
        if (set.effect.fame) gameState.player.stats.fame += set.effect.fame;
    }
}

function removeSetEffect(setName) {
    const set = gameState.clothesSets[setName];
    if (!set) return;
    
    if (set.effect.charm) gameState.player.stats.charm = Math.max(0, gameState.player.stats.charm - set.effect.charm);
    if (set.effect.elegance) gameState.player.stats.elegance = Math.max(0, gameState.player.stats.elegance - set.effect.elegance);
    if (set.effect.fame) gameState.player.stats.fame = Math.max(0, gameState.player.stats.fame - set.effect.fame);
}

function equipAccessory(accId) {
    const acc = gameState.accessories.find(a => a.id === accId);
    if (!acc || !acc.owned) return;
    
    // 检查属性上限
    const newCharm = gameState.player.stats.charm + acc.charm;
    const newElegance = gameState.player.stats.elegance + acc.elegance;
    if (newCharm > gameState.player.stats.maxCharm || newElegance > gameState.player.stats.maxElegance) {
        showTipModal("当前容貌或气质已达上限，无法装备更多加成。", "无法装备");
        return;
    }
    
    // 移除旧装备加成和套装效果
    if (gameState.player.equipped.accessory) {
        const oldAcc = gameState.accessories.find(a => a.id === gameState.player.equipped.accessory);
        if (oldAcc) {
            gameState.player.stats.charm -= oldAcc.charm;
            gameState.player.stats.elegance -= oldAcc.elegance;
            // 移除旧套装效果
            if (oldAcc.set) {
                removeSetEffect(oldAcc.set);
            }
        }
    }
    
    // 添加新装备加成
    gameState.player.equipped.accessory = accId;
    gameState.player.stats.charm = Math.min(gameState.player.stats.maxCharm, gameState.player.stats.charm + acc.charm);
    gameState.player.stats.elegance = Math.min(gameState.player.stats.maxElegance, gameState.player.stats.elegance + acc.elegance);
    
    // 检查套装效果
    if (acc.set) {
        checkClothesSetEffect(acc.set);
    }
    
    showTipModal(`已装备饰品：${acc.name}。容貌与气质已更新。`, "装备成功");
    renderDress();
    updateDashboard();
}

function unequipClothes() {
    if (!gameState.player.equipped.clothes) {
        showTipModal("当前没有装备服装。", "提示");
        return;
    }
    
    const cloth = gameState.clothes.find(c => c.id === gameState.player.equipped.clothes);
    if (cloth) {
        gameState.player.stats.charm -= cloth.charm;
        gameState.player.stats.elegance -= cloth.elegance;
    }
    
    gameState.player.equipped.clothes = null;
    showTipModal("已脱下服装，容貌与气质已恢复。", "脱下成功");
    renderDress();
    updateDashboard();
}

function unequipAccessory() {
    if (!gameState.player.equipped.accessory) {
        showTipModal("当前没有装备饰品。", "提示");
        return;
    }
    
    const acc = gameState.accessories.find(a => a.id === gameState.player.equipped.accessory);
    if (acc) {
        gameState.player.stats.charm -= acc.charm;
        gameState.player.stats.elegance -= acc.elegance;
    }
    
    gameState.player.equipped.accessory = null;
    showTipModal("已脱下饰品，容貌与气质已恢复。", "脱下成功");
    renderDress();
    updateDashboard();
}



// ========== 商店系统 ==========
function openShop() {
    initPricesIfNeeded();
    var handCreamPrice = gameState.world.season === 3 ? 48 : (gameState.prices["擦手霜"] || 15);
    const shopItems = [
        { name: "人参", price: gameState.prices["人参"], type: "item", id: 2 },
        { name: "胭脂", price: gameState.prices["胭脂"], type: "item", id: 3 },
        { name: "玉佩", price: gameState.prices["玉佩"], type: "item", id: 4 },
        { name: "避孕汤", price: gameState.prices["避孕汤"], type: "item", id: 6 },
        { name: "擦手霜", price: handCreamPrice, type: "item", id: 7 },
        { name: "素色宫装", price: gameState.prices["素色宫装"], type: "clothes", id: 2 },
        { name: "银簪", price: gameState.prices["银簪"], type: "accessory", id: 2 }
    ];
    
    let shopHTML = "<h3>内务府商店</h3>";
    shopItems.forEach(item => {
        shopHTML += `
            <div style="background:#E7E7ED;padding:10px;margin:5px 0;border-radius:5px;display:flex;justify-content:space-between;align-items:center;">
                <div>${item.name} - ${item.price}两</div>
                <button class="btn" style="width:auto;padding:5px 10px;font-size:12px;" onclick="buyItem('${item.type}', ${item.id}, ${item.price})">购买</button>
            </div>
        `;
    });
    
    const modal = document.createElement('div');
    modal.id = "shop-modal";
    modal.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:200;display:flex;justify-content:center;align-items:center;";
    modal.innerHTML = `
        <div class="modal-content">
            ${shopHTML}
            <button class="btn" onclick="closeShop()">关闭</button>
        </div>
    `;
    modal.onclick = function(e) { if(e.target === modal) closeShop(); };
    document.getElementById('app-container').appendChild(modal);
}

function buyItem(type, id, price) {
    if (gameState.player.stats.money < price) {
        showTipModal('当前银两不足，无法购买。', '银两不足');
        return;
    }
    
    gameState.player.stats.money -= price;
    var boughtName = '';
    if (type === "item") {
        let item = gameState.items.find(i => i.id === id);
        if (!item && id === 6) {
            gameState.items = gameState.items || [];
            item = { id: 6, name: "避孕汤", type: "item", desc: "服用后一周内不会怀孕；若已怀孕则会导致流产（可能掉容貌或银两）", effect: null, count: 0, quality: "common", durability: null, story: "宫中所备的避子汤药，谨慎使用。", isContraceptive: true };
            gameState.items.push(item);
        }
        if (!item && id === 7) {
            gameState.items = gameState.items || [];
            item = { id: 7, name: "擦手霜", type: "item", desc: "缓解冻疮、手干裂流血；可送人（二等宫女以下也易生冻疮）", effect: { health: 5 }, count: 0, quality: "common", durability: null, story: "冬日护手良品，内务府有售，冬季会涨价。" };
            gameState.items.push(item);
        }
        if (item) {
            item.count = (item.count || 0) + 1;
            boughtName = item.name;
        }
    } else if (type === "clothes") {
        const cloth = gameState.clothes.find(c => c.id === id);
        if (cloth) { cloth.owned = true; boughtName = cloth.name || '素色宫装'; }
    } else if (type === "accessory") {
        const acc = gameState.accessories.find(a => a.id === id);
        if (acc) { acc.owned = true; boughtName = acc.name || '银簪'; }
    }
    var msg = boughtName ? '购买成功！已获得「' + boughtName + '」。' : '购买成功！';
    showTipModal(msg, '内务府');
    updateDashboard();
    closeShop();
}

function closeShop() {
    const modal = document.getElementById('shop-modal');
    if (modal) modal.remove();
}

// ========== 礼物系统 ==========
// customGifts现在存储对象数组：{name, price, image(base64)}
let customGifts = JSON.parse(localStorage.getItem('customGifts') || '[]');
// 兼容旧数据格式：如果是字符串数组，转换为对象数组
if (customGifts.length > 0 && typeof customGifts[0] === 'string') {
    customGifts = customGifts.map(name => ({
        name: name,
        price: Math.floor(Math.random() * 500) + 50,
        image: null
    }));
    try {
        localStorage.setItem('customGifts', JSON.stringify(customGifts));
    } catch (e) {
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            showErrorModal('存储空间不足，请清理存档或数据。');
        } else {
            showErrorModal('保存失败：' + (e.message || '未知错误'));
        }
    }
}

function openGiftShop() {
    console.log('openGiftShop called');
    
    try {
        // 确保customGifts已初始化
        if (typeof customGifts === 'undefined') {
            customGifts = JSON.parse(localStorage.getItem('customGifts') || '[]');
        }
        
        // 检查是否已经存在模态框
        const existingModal = document.getElementById('gift-shop-modal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modal = document.createElement('div');
        modal.id = "gift-shop-modal";
        modal.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:200;display:flex;justify-content:center;align-items:center;";
        
        // 检查是否是群聊模式
        const isGroupGift = window.groupGiftTargetIds && window.groupGiftTargetIds.length > 0;
        let titleText = '';
        if (isGroupGift) {
            const memberNames = window.groupGiftTargetIds.map(id => {
                const npc = gameState.npcs.find(n => n.id == id);
                return npc ? npc.name : '';
            }).filter(Boolean).join('、');
            titleText = `🎁 选择礼物送给${memberNames}`;
        } else {
            const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
            const npcName = npc ? npc.name : "对方";
            titleText = `🎁 选择礼物送给${npcName}`;
        }
        
        // 生成礼物列表HTML
        let giftListHTML = '';
        try {
            giftListHTML = renderGiftList();
        } catch (e) {
            console.error('renderGiftList error:', e);
            giftListHTML = '<div style="text-align:center;padding:20px;color:var(--danger);">加载礼物列表失败</div>';
        }
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width:95%;width:420px;max-height:85vh;display:flex;flex-direction:column;background:var(--secondary);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:10px;background:var(--primary);border-radius:8px 8px 0 0;margin:-20px -20px 15px -20px;">
                    <h3 style="color:white;margin:0;">${titleText}</h3>
                    <button class="btn" style="width:auto;padding:5px 10px;font-size:12px;background:rgba(255,255,255,0.2);color:white;" onclick="handleGiftShopClose()">✕</button>
                </div>
                
                <div style="margin-bottom:15px;">
                    <div class="search-bar" style="background:rgba(255,255,255,0.2);border-radius:20px;padding:5px 15px;display:flex;align-items:center;margin-bottom:10px;">
                        <input type="text" id="gift-search-input" placeholder="搜索礼物..." 
                            style="flex:1;border:none;background:transparent;outline:none;font-size:14px;color:white;"
                            onkeypress="if(event.key==='Enter') searchGifts()">
                        <style>
                            #gift-search-input::placeholder { color: rgba(255,255,255,0.6); }
                        </style>
                        <button style="background:none;border:none;cursor:pointer;font-size:18px;color:white;padding:0 5px;" onclick="searchGifts()">🔍</button>
                    </div>
                    <button class="btn btn-outline" style="width:100%;padding:8px;background:rgba(255,255,255,0.1);color:white;border-color:rgba(255,255,255,0.3);" onclick="showCustomGiftForm()">➕ 自定义礼物</button>
                </div>
                
                <div id="gift-list-container" style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;background:var(--secondary);scrollbar-width:thin;scrollbar-color:rgba(117,126,211,0.4) transparent;">
                    ${giftListHTML}
                </div>
            </div>
        `;
        
        modal.onclick = function(e) { 
            if(e.target === modal) handleGiftShopClose(); 
        };
        
        const appContainer = document.getElementById('app-container');
        if (!appContainer) {
            console.error('app-container not found');
            alert('界面初始化失败，请刷新页面重试');
            return;
        }
        
        appContainer.appendChild(modal);
        console.log('Gift shop modal added to DOM');
    } catch (e) {
        console.error('openGiftShop error:', e);
        alert('打开礼物界面失败: ' + e.message);
    }
}

function renderGiftList(gifts = null) {
    if (!gifts) {
        // 默认礼物列表（包含自定义礼物）
        const defaultGifts = [
            "玉佩", "香囊", "手帕", "发簪", "胭脂", "茶叶", "糕点", "花束",
            "金钗", "玉镯", "丝绸", "香粉", "蜜饯", "美酒", "字画", "古书"
        ];
        // 确保customGifts已初始化
        if (typeof customGifts === 'undefined') {
            customGifts = JSON.parse(localStorage.getItem('customGifts') || '[]');
            // 兼容旧格式
            if (customGifts.length > 0 && typeof customGifts[0] === 'string') {
                customGifts = customGifts.map(name => ({
                    name: name,
                    price: Math.floor(Math.random() * 500) + 50,
                    image: null
                }));
            }
        }
        // 将默认礼物转换为对象格式
        const defaultGiftObjects = defaultGifts.map(name => {
            const emojis = ["🎁", "💄", "💍", "🍰", "🍵", "🌸", "🧸", "💎", "🎨", "📿", "🪷", "🌺"];
            return {
                name: name,
                price: Math.floor(Math.random() * 500) + 50,
                desc: `精美礼品 | 好评率 99%`,
                emoji: emojis[Math.floor(Math.random() * emojis.length)],
                image: null
            };
        });
        gifts = [...defaultGiftObjects, ...customGifts];
    }
    
    // 如果gifts是字符串数组，转换为对象数组
    if (gifts.length > 0 && typeof gifts[0] === 'string') {
        const emojis = ["🎁", "💄", "💍", "🍰", "🍵", "🌸", "🧸", "💎", "🎨", "📿", "🪷", "🌺"];
        gifts = gifts.map(gift => ({
            name: gift,
            price: Math.floor(Math.random() * 500) + 50,
            desc: `精美礼品 | 好评率 99%`,
            emoji: emojis[Math.floor(Math.random() * emojis.length)],
            image: null
        }));
    }
    
    return renderGiftItems(gifts);
}

function renderGiftItems(items) {
    let html = '<div class="shop-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:10px;">';
    items.forEach((item) => {
        // 处理图片：优先使用image，其次imageUrl，最后emoji
        const imageSrc = item.image || item.imageUrl || null;
        const isImageUrl = imageSrc && (imageSrc.startsWith('http') || imageSrc.startsWith('data:'));
        const emoji = item.emoji || (isImageUrl ? '🎁' : (imageSrc || '🎁'));
        
        // 图片显示：如果是URL或base64，显示图片；否则显示emoji
        const imageHtml = isImageUrl
            ? `<img src="${imageSrc}" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML='<div style=\\'font-size:30px;\\'>${emoji}</div>'">`
            : `<div style="font-size:30px;">${emoji}</div>`;
        
        // 创建安全的item对象用于onclick
        const safeItem = {
            name: item.name,
            price: item.price || 100,
            image: item.image || null,
            imageUrl: item.imageUrl || null,
            emoji: emoji,
            desc: item.desc || '精美礼品 | 好评率 99%'
        };
        
        // 检查是否是自定义礼物（在customGifts中）
        const isCustomGift = customGifts.some(g => g.name === item.name);
        const giftIndex = isCustomGift ? customGifts.findIndex(g => g.name === item.name) : -1;
        
        html += `
            <div class="shop-item" style="position:relative;">
                ${isCustomGift ? `
                    <div style="position:absolute;top:5px;right:5px;z-index:10;display:flex;gap:3px;">
                        <button onclick="editCustomGift(${giftIndex});event.stopPropagation();" style="width:24px;height:24px;border-radius:50%;background:rgba(117,126,211,0.8);color:white;border:none;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;"><span class="material-icons" style="font-size:14px;">edit</span></button>
                        <button onclick="deleteCustomGift(${giftIndex});event.stopPropagation();" style="width:24px;height:24px;border-radius:50%;background:rgba(200,90,122,0.8);color:white;border:none;font-size:12px;cursor:pointer;">✕</button>
                    </div>
                ` : ''}
                <div onclick="selectGiftItem(${JSON.stringify(safeItem).replace(/"/g, '&quot;')})" style="cursor:pointer;">
                    <div class="shop-img-placeholder">${imageHtml}</div>
                    <div class="shop-info">
                        <div>
                            <div class="shop-title">${item.name}</div>
                            <div class="shop-desc">${item.desc || '精美礼品 | 好评率 99%'}</div>
                        </div>
                        <div class="shop-price-row">
                            <div class="shop-price">${item.price || 100}</div>
                            <div class="shop-sales">月销${Math.floor(Math.random()*5000)}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    return html;
}

async function searchGifts() {
    const searchInput = document.getElementById('gift-search-input');
    const keyword = searchInput.value.trim();
    
    if (!keyword) {
        alert("请输入搜索关键词！");
        return;
    }
    
    const container = document.getElementById('gift-list-container');
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#8E96D9;">搜索中...</div>';
    
    if (!settings.apiKey) {
        alert("请先在设置中配置API Key才能搜索礼物！");
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger);">请先配置API Key</div>';
        return;
    }
    
    try {
        const response = await fetch(`${settings.apiUrl}/chat/completions`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${settings.apiKey}`
            },
            body: JSON.stringify({
                model: settings.model,
                messages: [
                    { 
                        role: "system", 
                        content: `你是一个礼物推荐助手。根据用户输入的关键词，推荐15-20个适合中国古代宫廷背景的礼物。${getAntiBaguguPrompt()}
必须返回JSON数组格式，每个礼物对象必须包含：
- name: 礼物名称（字符串，必填）
- price: 价格（整数，范围50-1000，根据礼物珍贵程度合理定价，必填）
- imageUrl: 礼物的图片URL或emoji（字符串，如果没有真实图片URL，使用合适的emoji，必填）
- desc: 简短描述（字符串，如"精美礼品 | 好评率 99%"，必填）

要求：
1. 必须返回至少15个礼物
2. 价格必须合理，根据礼物类型和珍贵程度在50-1000之间
3. 如果没有真实图片URL，必须使用合适的emoji（如玉佩用💎，香囊用🌸，茶叶用🍵等）
4. 只返回JSON数组，不要任何其他说明文字或markdown标记

格式示例：
[{"name":"玉佩","price":300,"imageUrl":"💎","desc":"精美玉佩 | 好评率 99%"},{"name":"香囊","price":150,"imageUrl":"🌸","desc":"精美香囊 | 好评率 99%"}]` 
                    },
                    { 
                        role: "user", 
                        content: `搜索关键词：${keyword}。请返回至少15个礼物的JSON数组。` 
                    }
                ],
                temperature: 0.8,
                max_tokens: 2000
            })
        });
        
        if (!response.ok) {
            throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        const reply = data.choices[0].message.content.trim();
        
        // 尝试解析JSON
        let giftItems = [];
        try {
            // 提取JSON部分（可能包含markdown代码块）
            let jsonStr = reply;
            const jsonMatch = reply.match(/\[[\s\S]*\]/);
            if (jsonMatch) {
                jsonStr = jsonMatch[0];
            }
            giftItems = JSON.parse(jsonStr);
            
            // 验证数据格式
            if (!Array.isArray(giftItems) || giftItems.length === 0) {
                throw new Error("返回的数据不是有效的数组或为空");
            }
            
            // 确保每个礼物都有必要字段，且价格和图片合理
            giftItems = giftItems
                .filter(item => item && item.name && item.name.trim().length > 0) // 过滤空名称
                .map(item => {
                    const price = item.price && item.price >= 50 && item.price <= 1000 
                        ? item.price 
                        : Math.floor(Math.random() * 450) + 50; // 50-500之间
                    const imageUrl = item.imageUrl || item.image || '🎁';
                    return {
                        name: item.name.trim(),
                        price: price,
                        imageUrl: imageUrl,
                        image: (imageUrl && (imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) ? imageUrl : null,
                        desc: item.desc || '精美礼品 | 好评率 99%',
                        emoji: (!imageUrl || imageUrl.startsWith('http') || imageUrl.startsWith('data:')) ? '🎁' : imageUrl
                    };
                })
                .slice(0, 20);
            
            if (giftItems.length < 12) {
                throw new Error(`返回的礼物数量不足（${giftItems.length}个），需要至少12个。请检查API返回的数据格式。`);
            }
            
        } catch (parseError) {
            throw new Error(`API返回数据解析失败: ${parseError.message}。返回内容: ${reply.substring(0, 200)}`);
        }
        
        container.innerHTML = renderGiftItems(giftItems);
        
    } catch (e) {
        console.error('搜索礼物失败:', e);
        container.innerHTML = `<div style="text-align:center;padding:20px;color:var(--danger);">搜索失败: ${e.message}<br><small>请检查API配置或稍后重试</small></div>`;
    }
}

function showCustomGiftForm() {
    const modal = document.createElement('div');
    modal.id = "custom-gift-modal";
    modal.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:300;display:flex;justify-content:center;align-items:center;";
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width:90%;width:380px;max-height:85vh;overflow-y:auto;">
            <h3>➕ 自定义礼物</h3>
            <div class="input-group">
                <label>礼物名称 *</label>
                <input type="text" id="custom-gift-name" placeholder="输入礼物名称" 
                    style="width:100%;padding:10px;border-radius:5px;border:1px solid #AFB4E1;background:rgba(225,227,237,0.8);">
            </div>
            <div class="input-group">
                <label>价格 *</label>
                <input type="number" id="custom-gift-price" placeholder="输入价格（50-5000）" min="50" max="5000" value="100"
                    style="width:100%;padding:10px;border-radius:5px;border:1px solid #AFB4E1;background:rgba(225,227,237,0.8);">
            </div>
            <div class="input-group">
                <label>礼物图片</label>
                <input type="file" id="custom-gift-image" accept="image/*" 
                    style="width:100%;padding:8px;border-radius:5px;border:1px solid #AFB4E1;background:rgba(225,227,237,0.8);">
                <div id="custom-gift-preview" style="margin-top:10px;text-align:center;min-height:100px;border:2px dashed #AFB4E1;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(225,227,237,0.3);">
                    <span style="color:#8E96D9;">预览图片</span>
                </div>
            </div>
            <div style="display:flex;gap:10px;margin-top:15px;">
                <button class="btn" style="flex:1;" onclick="saveCustomGift()">保存</button>
                <button class="btn btn-outline" style="flex:1;" onclick="closeCustomGiftForm()">取消</button>
            </div>
        </div>
    `;
    
    // 图片预览功能
    const imageInput = modal.querySelector('#custom-gift-image');
    const preview = modal.querySelector('#custom-gift-preview');
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" style="max-width:100%;max-height:200px;border-radius:8px;">`;
            };
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = '<span style="color:#8E96D9;">预览图片</span>';
        }
    });
    
    modal.onclick = function(e) { 
        if(e.target === modal) closeCustomGiftForm(); 
    };
    document.getElementById('app-container').appendChild(modal);
}

function saveCustomGift() {
    const nameInput = document.getElementById('custom-gift-name');
    const priceInput = document.getElementById('custom-gift-price');
    const imageInput = document.getElementById('custom-gift-image');
    
    const name = nameInput.value.trim();
    const price = parseInt(priceInput.value) || 100;
    
    if (!name) {
        alert("请输入礼物名称！");
        return;
    }
    
    if (price < 50 || price > 5000) {
        alert("价格必须在50-5000之间！");
        return;
    }
    
    // 检查是否已存在同名礼物
    if (customGifts.some(g => g.name === name)) {
        alert("该礼物已存在！");
        return;
    }
    
    // 处理图片
    let imageBase64 = null;
    if (imageInput.files && imageInput.files[0]) {
        const file = imageInput.files[0];
        if (file.size > 2 * 1024 * 1024) {
            alert("图片大小不能超过2MB！");
            return;
        }
        // 读取为base64
        const reader = new FileReader();
        reader.onload = function(e) {
            imageBase64 = e.target.result;
            saveCustomGiftWithImage(name, price, imageBase64);
        };
        reader.readAsDataURL(file);
        return; // 异步处理，先返回
    } else {
        saveCustomGiftWithImage(name, price, null);
    }
}

function saveCustomGiftWithImage(name, price, imageBase64) {
    const newGift = {
        name: name,
        price: price,
        image: imageBase64,
        desc: '自定义礼物 | 好评率 99%',
        emoji: imageBase64 ? null : '🎁'
    };
    
    customGifts.push(newGift);
    try {
        localStorage.setItem('customGifts', JSON.stringify(customGifts));
    } catch (e) {
        customGifts.pop();
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            showErrorModal('存储空间不足，请清理存档或数据。');
        } else {
            showErrorModal('保存失败：' + (e.message || '未知错误'));
        }
        return;
    }
    
    // 更新礼物列表显示
    const container = document.getElementById('gift-list-container');
    if (container) {
        container.innerHTML = renderGiftList();
    }
    
    closeCustomGiftForm();
    alert("自定义礼物已添加！");
}

function closeCustomGiftForm() {
    const modal = document.getElementById('custom-gift-modal');
    if (modal) modal.remove();
}

function editCustomGift(index) {
    if (index < 0 || index >= customGifts.length) return;
    const gift = customGifts[index];
    
    const modal = document.createElement('div');
    modal.id = "edit-gift-modal";
    modal.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:300;display:flex;justify-content:center;align-items:center;";
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width:90%;width:380px;max-height:85vh;overflow-y:auto;">
            <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">edit</span>编辑礼物</h3>
            <div class="input-group">
                <label>礼物名称 *</label>
                <input type="text" id="edit-gift-name" value="${gift.name}" 
                    style="width:100%;padding:10px;border-radius:5px;border:1px solid #AFB4E1;background:rgba(225,227,237,0.8);">
            </div>
            <div class="input-group">
                <label>价格 *</label>
                <input type="number" id="edit-gift-price" value="${gift.price}" min="50" max="5000"
                    style="width:100%;padding:10px;border-radius:5px;border:1px solid #AFB4E1;background:rgba(225,227,237,0.8);">
            </div>
            <div class="input-group">
                <label>礼物图片</label>
                <input type="file" id="edit-gift-image" accept="image/*" 
                    style="width:100%;padding:8px;border-radius:5px;border:1px solid #AFB4E1;background:rgba(225,227,237,0.8);">
                <div id="edit-gift-preview" style="margin-top:10px;text-align:center;min-height:100px;border:2px dashed #AFB4E1;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(225,227,237,0.3);">
                    ${gift.image ? `<img src="${gift.image}" style="max-width:100%;max-height:200px;border-radius:8px;">` : '<span style="color:#8E96D9;">预览图片</span>'}
                </div>
            </div>
            <div style="display:flex;gap:10px;margin-top:15px;">
                <button class="btn" style="flex:1;" onclick="saveEditedGift(${index})">保存</button>
                <button class="btn btn-outline" style="flex:1;" onclick="closeEditGiftForm()">取消</button>
            </div>
        </div>
    `;
    
    const imageInput = modal.querySelector('#edit-gift-image');
    const preview = modal.querySelector('#edit-gift-preview');
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" style="max-width:100%;max-height:200px;border-radius:8px;">`;
            };
            reader.readAsDataURL(file);
        }
    });
    
    modal.onclick = function(e) { 
        if(e.target === modal) closeEditGiftForm(); 
    };
    document.getElementById('app-container').appendChild(modal);
}

function saveEditedGift(index) {
    const nameInput = document.getElementById('edit-gift-name');
    const priceInput = document.getElementById('edit-gift-price');
    const imageInput = document.getElementById('edit-gift-image');
    
    const name = nameInput.value.trim();
    const price = parseInt(priceInput.value) || 100;
    
    if (!name) {
        alert("请输入礼物名称！");
        return;
    }
    
    if (price < 50 || price > 5000) {
        alert("价格必须在50-5000之间！");
        return;
    }
    
    // 检查名称是否与其他礼物重复（除了当前编辑的）
    if (customGifts.some((g, i) => i !== index && g.name === name)) {
        alert("该礼物名称已存在！");
        return;
    }
    
    if (imageInput.files && imageInput.files[0]) {
        const file = imageInput.files[0];
        if (file.size > 2 * 1024 * 1024) {
            alert("图片大小不能超过2MB！");
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            customGifts[index] = {
                name: name,
                price: price,
                image: e.target.result,
                desc: '自定义礼物 | 好评率 99%',
                emoji: null
            };
            try {
                localStorage.setItem('customGifts', JSON.stringify(customGifts));
                updateGiftList();
                closeEditGiftForm();
                alert("礼物已更新！");
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    showErrorModal('存储空间不足，请清理存档或数据。');
                } else {
                    showErrorModal('保存失败：' + (e.message || '未知错误'));
                }
            }
        };
        reader.readAsDataURL(file);
    } else {
        // 保持原有图片
        customGifts[index] = {
            name: name,
            price: price,
            image: customGifts[index].image,
            desc: '自定义礼物 | 好评率 99%',
            emoji: customGifts[index].emoji || null
        };
        try {
            localStorage.setItem('customGifts', JSON.stringify(customGifts));
            updateGiftList();
            closeEditGiftForm();
            alert("礼物已更新！");
        } catch (e) {
            if (e.name === 'QuotaExceededError' || e.code === 22) {
                showErrorModal('存储空间不足，请清理存档或数据。');
            } else {
                showErrorModal('保存失败：' + (e.message || '未知错误'));
            }
        }
    }
}

function deleteCustomGift(index) {
    if (!confirm(`确定要删除礼物"${customGifts[index].name}"吗？`)) return;
    
    const deleted = customGifts[index];
    customGifts.splice(index, 1);
    try {
        localStorage.setItem('customGifts', JSON.stringify(customGifts));
        updateGiftList();
        alert("礼物已删除！");
    } catch (e) {
        customGifts.splice(index, 0, deleted);
        if (e.name === 'QuotaExceededError' || e.code === 22) {
            showErrorModal('存储空间不足，请清理存档或数据。');
        } else {
            showErrorModal('保存失败：' + (e.message || '未知错误'));
        }
    }
}

function closeEditGiftForm() {
    const modal = document.getElementById('edit-gift-modal');
    if (modal) modal.remove();
}

function updateGiftList() {
    const container = document.getElementById('gift-list-container');
    if (container) {
        container.innerHTML = renderGiftList();
    }
}

// 更新银两显示
function updateMoneyDisplay() {
    const moneyEl = document.getElementById('game-money');
    if (moneyEl) {
        moneyEl.innerText = gameState.player.stats.money;
    }
}

// 添加物品到物品栏
function addItemToInventory(itemName, count = 1) {
    // 查找物品
    let item = gameState.items.find(i => i.name === itemName);
    
    if (!item) {
        // 如果物品不存在，创建新物品
        const newId = Math.max(...gameState.items.map(i => i.id), 0) + 1;
        item = {
            id: newId,
            name: itemName,
            type: "item",
            desc: "收到的礼物",
            count: 0,
            quality: "common"
        };
        gameState.items.push(item);
    }
    
    item.count = (item.count || 0) + count;
    
    // 如果当前在物品页面，刷新显示
    if (document.getElementById('page-inventory').classList.contains('active')) {
        renderInventory();
    }
}

// 从物品栏赠送：弹出人脉好友选择
var pendingGiftItemId = null;

function showGiftContactSelectModal(itemId) {
    const id = Number(itemId);
    const item = gameState.items.find(i => i.id == id);
    if (!item) {
        showErrorModal('未找到该物品，请刷新物品栏后重试。');
        return;
    }
    if (item.count == null || item.count <= 0) {
        showErrorModal('当前「' + (item.name || '该物品') + '」数量不足，无法赠送。\n\n请确认物品栏中数量大于 0 后再试。');
        return;
    }
    if (!gameState.npcs || gameState.npcs.length === 0) {
        showErrorModal("暂无人脉好友，请先在地图或剧情中结识人物后再赠送。");
        return;
    }
    pendingGiftItemId = id;
    const modal = document.getElementById('gift-contact-select-modal');
    const listEl = document.getElementById('gift-contact-select-list');
    listEl.innerHTML = '';
    gameState.npcs.forEach(npc => {
        const row = document.createElement('div');
        row.style.cssText = "display:flex;align-items:center;padding:12px;margin-bottom:8px;background:rgba(225,227,237,0.3);border-radius:8px;cursor:pointer;transition:background 0.2s;";
        row.onmouseover = () => row.style.background = "rgba(225,227,237,0.5)";
        row.onmouseout = () => row.style.background = "rgba(225,227,237,0.3)";
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'gift-contact-select';
        radio.value = npc.id;
        radio.id = 'gift-contact-radio-' + npc.id;
        radio.style.cssText = "width:18px;height:18px;margin-right:12px;cursor:pointer;flex-shrink:0;";
        row.addEventListener('click', function(e) {
            if (e.target.type !== 'radio') {
                radio.checked = true;
                document.querySelectorAll('input[name="gift-contact-select"]').forEach(r => { if (r !== radio) r.checked = false; });
            }
        });
        const avatarDiv = document.createElement('div');
        avatarDiv.style.cssText = "width:40px;height:40px;border-radius:50%;background:var(--secondary);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:bold;margin-right:12px;flex-shrink:0;";
        avatarDiv.textContent = (npc.name || '').charAt(0) || '?';
        const infoDiv = document.createElement('div');
        infoDiv.style.cssText = "flex:1;";
        infoDiv.innerHTML = `<div style="font-weight:bold;color:var(--text);">${npc.name || '未知'}</div><div style="font-size:12px;color:#8E96D9;">${npc.role || ''} · 好感 ${npc.affection || 0}</div>`;
        row.appendChild(radio);
        row.appendChild(avatarDiv);
        row.appendChild(infoDiv);
        listEl.appendChild(row);
    });
    modal.style.display = 'flex';
}

function closeGiftContactSelectModal() {
    document.getElementById('gift-contact-select-modal').style.display = 'none';
    pendingGiftItemId = null;
}

function confirmGiftContactSelect() {
    if (pendingGiftItemId == null) return;
    const radio = document.querySelector('input[name="gift-contact-select"]:checked');
    if (!radio) {
        showErrorModal('请先选择一位人脉好友再点击「确定赠送」。');
        return;
    }
    const npcId = parseInt(radio.value, 10);
    const itemIdToGift = pendingGiftItemId;
    closeGiftContactSelectModal();
    giftItemToNpc(itemIdToGift, npcId);
}

// 将物品赠送给指定人脉好友
function giftItemToNpc(itemId, npcId) {
    const id = Number(itemId);
    const item = gameState.items.find(i => i.id == id);
    const npc = gameState.npcs.find(n => n.id == npcId);
    if (!item) {
        showErrorModal('未找到该物品，可能已被使用或移除。请刷新物品栏后重试。');
        return;
    }
    if (item.count == null || item.count <= 0) {
        showErrorModal('「' + (item.name || '该物品') + '」数量不足，无法赠送。\n\n请确认物品栏中仍有该物品后再试。');
        return;
    }
    if (!npc) {
        showErrorModal('所选人脉好友不存在，请重新选择。');
        return;
    }
    item.count--;
    if (item.name === '避孕汤') {
        npc.pendingContraceptive = true;
        renderInventory();
        if (document.getElementById('page-contacts')) renderContacts();
        showTipModal('已将避孕汤送给 ' + (npc.name || '对方') + '。与对方对话时，可点击「劝说服用避孕汤」让对方服用。', '赠送成功');
        return;
    }
    if (item.name === '擦手霜') {
        npc.chilblainsHands = false;
    }
    npc.affection += 5;
    npc.affection = Math.min(100, npc.affection);
    const currentDate = new Date().toISOString();
    npc.history.push(`[${currentDate}] ${gameState.player.name}: [赠送礼物: ${item.name}]`);
    renderInventory();
    if (document.getElementById('page-contacts')) renderContacts();
    var giftMsg = '已将「' + item.name + '」赠送给 ' + (npc.name || '对方') + '，对方好感 +5。';
    if (item.name === '擦手霜') giftMsg += '\n若对方有冻疮手干裂，已缓解。';
    showTipModal(giftMsg, '赠送成功');
}

// 从物品栏赠送物品（保留：聊天界面内快捷赠送时可用）
function giftItemFromInventory(itemId) {
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (npc) {
        giftItemToNpc(itemId, npc.id);
        sendGiftCard(gameState.items.find(i => i.id === itemId).name, null, '🎁', 'user');
        const affectionEl = document.getElementById('chat-affection');
        if (affectionEl) affectionEl.innerText = `好感: ${npc.affection}`;
        if (!document.getElementById('page-chat').classList.contains('active')) goToPage('page-chat');
    } else {
        showGiftContactSelectModal(itemId);
    }
}

function selectGift(giftName) {
    // 兼容旧版本调用（只传名称）
    selectGiftItem({
        name: giftName,
        price: Math.floor(Math.random() * 500) + 50,
        emoji: '🎁',
        image: null
    });
}

function selectGiftItem(giftItem) {
    // 检查是否是群聊模式
    const isGroupGift = window.groupGiftTargetIds && window.groupGiftTargetIds.length > 0;
    
    if (isGroupGift) {
        // 群聊模式：发送给多个成员
        const group = gameState.groups.find(g => g.id === currentGroupId);
        if (!group) {
            alert("群聊不存在！");
            return;
        }
        
        const imageSrc = giftItem.image || giftItem.imageUrl || null;
        const isImageUrl = imageSrc && (imageSrc.startsWith('http') || imageSrc.startsWith('data:'));
        const displayImage = isImageUrl ? imageSrc : (giftItem.emoji || '🎁');
        
        const timeNames = ["早", "中", "晚"];
        const memberNames = window.groupGiftTargetIds.map(id => {
            const npc = gameState.npcs.find(n => n.id == id);
            if (npc) {
                // 增加好感度
                npc.affection += 10;
                npc.affection = Math.min(100, npc.affection);
                
                // 保存到历史记录
                const currentDate = new Date().toISOString();
                npc.history.push(`[${currentDate}] ${gameState.player.name}: [赠送礼物: ${giftItem.name}，价值${giftItem.price || 100}银两]`);
                
                return npc.name;
            }
            return '';
        }).filter(Boolean).join('、');
        
        // 发送礼物消息到群聊
        const msg = {
            id: Date.now(),
            author: gameState.player.name,
            content: `[赠送礼物: ${giftItem.name}，价值${giftItem.price || 100}银两] 给${memberNames}`,
            gift: {
                name: giftItem.name,
                price: giftItem.price || 100,
                image: displayImage
            },
            time: `${gameState.world.month}月${gameState.world.day}日 ${timeNames[gameState.world.timeOfDay]}`
        };
        
        group.messages.push(msg);
        renderGroupChat();
        
        // 清除群聊礼物目标
        window.groupGiftTargetIds = null;
        handleGiftShopClose();
        return;
    }
    
    // 私聊模式
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (!npc) {
        alert("对话对象不存在！");
        return;
    }
    
    // 发送礼物卡片到聊天界面
    const imageSrc = giftItem.image || giftItem.imageUrl || null;
    const isImageUrl = imageSrc && (imageSrc.startsWith('http') || imageSrc.startsWith('data:'));
    const displayImage = isImageUrl ? imageSrc : (giftItem.emoji || '🎁');
    sendGiftCard(giftItem.name, giftItem.price, displayImage, 'user');
    
    // 增加好感度
    npc.affection += 10;
    npc.affection = Math.min(100, npc.affection);
    const affectionEl = document.getElementById('chat-affection');
    if (affectionEl) {
        affectionEl.innerText = `好感: ${npc.affection}`;
    }
    
    // 保存到历史记录
    const currentDate = new Date().toISOString();
    npc.history.push(`[${currentDate}] ${gameState.player.name}: [赠送礼物: ${giftItem.name}，价值${giftItem.price || 100}银两]`);
    
    handleGiftShopClose();
}

// AI根据性格背景送礼或送银两
async function npcSendGiftOrMoney(npc, lastReply) {
    if (!npc || !settings.apiKey) return;
    
    try {
        // 根据性格和好感度决定送什么
        const personalityGifts = {
            '温柔': ['香囊', '手帕', '花束', '茶叶'],
            '高傲': ['玉佩', '金钗', '丝绸', '字画'],
            '活泼': ['糕点', '蜜饯', '美酒', '花束'],
            '神秘': ['古书', '字画', '玉佩', '香粉'],
            '优雅': ['丝绸', '胭脂', '发簪', '玉镯']
        };
        
        const giftTypes = personalityGifts[npc.personality] || ['玉佩', '香囊', '手帕', '花束'];
        // 根据性格决定送礼物还是银两：温柔/活泼倾向送礼物，高傲/优雅倾向送银两
        const moneyPersonalities = ['高傲', '优雅'];
        const shouldSendMoney = moneyPersonalities.includes(npc.personality) 
            ? Math.random() < 0.5  // 高傲/优雅性格50%概率送银两
            : Math.random() < 0.2; // 其他性格20%概率送银两
        
        if (shouldSendMoney) {
            // 送银两
            const moneyAmount = Math.floor(10 + npc.affection / 10 + Math.random() * 50);
            gameState.player.stats.money += moneyAmount;
            updateMoneyDisplay();
            
            const currentDate = new Date().toISOString();
            npc.history.push(`[${currentDate}] ${npc.name}: [转账银两: ${moneyAmount}两]`);
            
            addMessageToUI(`💰 ${npc.name}转给你${moneyAmount}两银两`, 'npc');
            addMessageToUI(`[转账银两: ${moneyAmount}两]`, 'npc');
            
            // 更新银两显示
            updateMoneyDisplay();
        } else {
            // 决定送礼物还是送衣服（10%概率送衣服）
            const sendClothes = Math.random() < 0.1;
            
            if (sendClothes && gameState.clothes && gameState.clothes.length > 0) {
                // 送衣服
                const availableClothes = gameState.clothes.filter(c => !c.owned && c.id !== 1);
                if (availableClothes.length > 0) {
                    const randomCloth = availableClothes[Math.floor(Math.random() * availableClothes.length)];
                    randomCloth.owned = true;
                    
                    // 增加对应属性（不超过上限）
                    if (randomCloth.charm) gameState.player.stats.charm = Math.min(gameState.player.stats.maxCharm || 100, gameState.player.stats.charm + randomCloth.charm);
                    if (randomCloth.elegance) gameState.player.stats.elegance = Math.min(gameState.player.stats.maxElegance || 100, gameState.player.stats.elegance + randomCloth.elegance);
                    if (randomCloth.constitution) gameState.player.stats.constitution = Math.min(gameState.player.stats.maxConstitution || 100, gameState.player.stats.constitution + randomCloth.constitution);
                    if (randomCloth.attraction) gameState.player.stats.attraction = Math.min(gameState.player.stats.maxAttraction || 100, gameState.player.stats.attraction + randomCloth.attraction);
                    
                    const currentDate = new Date().toISOString();
                    npc.history.push(`[${currentDate}] ${npc.name}: [赠送衣服: ${randomCloth.name}]`);
                    
                    addMessageToUI(`${npc.name}送给你一件${randomCloth.name}！`, 'npc');
                    addMessageToUI(`获得属性：${randomCloth.charm ? '容貌+' + randomCloth.charm + ' ' : ''}${randomCloth.elegance ? '气质+' + randomCloth.elegance + ' ' : ''}${randomCloth.constitution ? '体质+' + randomCloth.constitution + ' ' : ''}${randomCloth.attraction ? '魅力+' + randomCloth.attraction : ''}`, 'sys');
                    
                    // 如果当前在换装页面，刷新显示
                    if (document.getElementById('page-dress').style.display !== 'none') {
                        renderDress();
                    }
                } else {
                    // 如果没有可送的衣服，送普通礼物
                    const giftName = giftTypes[Math.floor(Math.random() * giftTypes.length)];
                    const giftPrice = Math.floor(50 + Math.random() * 200);
                    addItemToInventory(giftName, 1);
                    const currentDate = new Date().toISOString();
                    npc.history.push(`[${currentDate}] ${npc.name}: [赠送礼物: ${giftName}，价值${giftPrice}银两]`);
                    sendGiftCard(giftName, giftPrice, '🎁', 'npc', npc.name);
                }
            } else {
                // 送礼物
                const giftName = giftTypes[Math.floor(Math.random() * giftTypes.length)];
                const giftPrice = Math.floor(50 + Math.random() * 200);
                
                // 添加到玩家物品栏
                addItemToInventory(giftName, 1);
                
                const currentDate = new Date().toISOString();
                npc.history.push(`[${currentDate}] ${npc.name}: [赠送礼物: ${giftName}，价值${giftPrice}银两]`);
                
                // 发送礼物卡片
                sendGiftCard(giftName, giftPrice, '🎁', 'npc', npc.name);
            }
        }
    } catch (e) {
        console.error('AI送礼失败:', e);
    }
}

function sendGiftCard(giftName, price, image, senderType = 'user', senderName = null) {
    const box = document.getElementById('chat-box');
    const div = document.createElement('div');
    div.className = `message msg-${senderType} gift-card`;
    
    // 根据发送者类型设置样式
    if (senderType === 'npc') {
        div.style.cssText = `
            background: linear-gradient(135deg, rgba(142,150,217,0.9) 0%, rgba(117,126,211,0.9) 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            max-width: 85%;
            margin-right: auto;
            margin-bottom: 10px;
            box-shadow: 
                inset 2px 2px 5px rgba(255,255,255,0.3),
                inset -2px -2px 5px rgba(0,0,0,0.2),
                0 4px 8px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
        `;
    } else {
        div.style.cssText = `
            background: linear-gradient(135deg, rgba(117,126,211,0.9) 0%, rgba(142,150,217,0.9) 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            max-width: 85%;
            margin-left: auto;
            margin-bottom: 10px;
            box-shadow: 
                inset 2px 2px 5px rgba(255,255,255,0.3),
                inset -2px -2px 5px rgba(0,0,0,0.2),
                0 4px 8px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
        `;
    }
    var gs = gameState.giftCardStyle;
    if (gameState.chatTargetId) {
        var curNpc = gameState.npcs && gameState.npcs.find(function(n) { return n.id == gameState.chatTargetId || String(n.id) === String(gameState.chatTargetId); });
        if (curNpc) {
            if (senderType === 'user' && curNpc.giftCardStyle) gs = curNpc.giftCardStyle;
            if (senderType === 'npc' && curNpc.giftCardStyleNpc) gs = curNpc.giftCardStyleNpc;
        }
    }
    if (gs) {
        if (gs.background) div.style.background = gs.background;
        if (gs.color) div.style.color = gs.color;
        if (gs.borderRadius !== undefined) div.style.borderRadius = (typeof gs.borderRadius === 'number' ? gs.borderRadius + 'px' : gs.borderRadius);
        if (gs.padding !== undefined) div.style.padding = (typeof gs.padding === 'number' ? gs.padding + 'px' : gs.padding);
        if (gs.border) div.style.border = gs.border;
    }
    
    const imageHtml = image && (image.startsWith('data:') || image.startsWith('http'))
        ? `<img src="${image}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;" onerror="this.parentElement.innerHTML='<div style=\\'font-size:32px;\\'>🎁</div>'">`
        : `<div style="font-size:32px;">${image || '🎁'}</div>`;
    
    div.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;">
            ${imageHtml}
            <div>
                <div style="font-weight:bold;font-size:16px;margin-bottom:3px;">${senderType === 'npc' ? (senderName || '对方') + '送给你' : '赠送礼物'}</div>
                <div style="font-size:14px;opacity:0.95;">${giftName}</div>
                ${price ? `<div style="font-size:12px;opacity:0.8;margin-top:2px;">价值 ${price} 银两</div>` : ''}
            </div>
        </div>
    `;
    
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    
    // NPC送礼物时由调用方(如handleNpcGiftResponse)负责添加到物品栏，此处仅展示卡片，避免重复添加
}

// 发送QQ转账卡片（私聊）
function sendMoneyCard(amount, senderType = 'user', senderName = null, recipientName = null, timestamp = null, note = null) {
    const box = document.getElementById('chat-box');
    const div = document.createElement('div');
    div.className = `message msg-${senderType} money-card`;
    
    // 保存转账信息到data属性
    const transferTime = timestamp || new Date().toISOString();
    div.setAttribute('data-amount', amount);
    div.setAttribute('data-sender-type', senderType);
    div.setAttribute('data-sender-name', senderName || (senderType === 'user' ? gameState.player.name : '对方'));
    div.setAttribute('data-recipient-name', recipientName || (senderType === 'npc' ? gameState.player.name : ''));
    div.setAttribute('data-timestamp', transferTime);
    
    // 添加点击事件
    div.style.cursor = 'pointer';
    div.onclick = function() {
        showMoneyDetailModal({
            amount: amount,
            senderType: senderType,
            senderName: senderName || (senderType === 'user' ? gameState.player.name : '对方'),
            recipientName: recipientName || (senderType === 'npc' ? gameState.player.name : ''),
            timestamp: transferTime
        });
    };
    
    var baseAlign = senderType === 'npc' ? 'margin-right: auto;' : 'margin-left: auto;';
    var baseStyle = `
        color: white;
        max-width: 85%;
        ${baseAlign}
        margin-bottom: 10px;
        box-shadow: inset 2px 2px 5px rgba(255,255,255,0.3), inset -2px -2px 5px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.15);
        position: relative;
    `;
    if (senderType === 'npc') {
        div.style.cssText = 'background: linear-gradient(135deg, rgba(142,150,217,0.9) 0%, rgba(117,126,211,0.9) 100%); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);' + baseStyle;
    } else {
        div.style.cssText = 'background: linear-gradient(135deg, rgba(117,126,211,0.9) 0%, rgba(142,150,217,0.9) 100%); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);' + baseStyle;
    }
    var custom = gameState.moneyTransferStyle;
    if (gameState.chatTargetId) {
        var curNpc = gameState.npcs && gameState.npcs.find(function(n) { return n.id == gameState.chatTargetId || String(n.id) === String(gameState.chatTargetId); });
        if (curNpc) {
            if (senderType === 'user' && curNpc.moneyTransferStyle) custom = curNpc.moneyTransferStyle;
            if (senderType === 'npc' && curNpc.moneyTransferStyleNpc) custom = curNpc.moneyTransferStyleNpc;
        }
    }
    if (custom) {
        if (custom.backgroundImage) {
            div.style.setProperty('background-image', 'url(' + custom.backgroundImage + ')', 'important');
            div.style.setProperty('background-size', 'cover', 'important');
            div.style.setProperty('background-position', 'center', 'important');
            if (custom.background) div.style.setProperty('background-color', custom.background, 'important');
        } else if (custom.background) div.style.setProperty('background', custom.background, 'important');
        if (custom.color) div.style.setProperty('color', custom.color, 'important');
        if (custom.borderRadius !== undefined) div.style.setProperty('border-radius', (typeof custom.borderRadius === 'number' ? custom.borderRadius + 'px' : String(custom.borderRadius)), 'important');
        if (custom.padding !== undefined) div.style.setProperty('padding', (typeof custom.padding === 'number' ? custom.padding + 'px' : String(custom.padding)), 'important');
        if (custom.border) div.style.setProperty('border', custom.border, 'important');
    }
    var iconVal = (custom && custom.icon) ? String(custom.icon).trim() : '';
    var iconHtml = '';
    if (iconVal && (iconVal.startsWith('http') || iconVal.startsWith('data:'))) {
        iconHtml = '<img src="' + iconVal.replace(/"/g, '&quot;') + '" style="width:32px;height:32px;object-fit:contain;" onerror="this.outerHTML=\'<span class=\\\'material-icons\\\' style=\\\'font-size:32px;color:white;\\\'>payments</span>\'">';
    } else {
        var iconName = iconVal || 'payments';
        iconHtml = '<span class="material-icons" style="font-size:32px;color:white;">' + iconName.replace(/[<>"']/g, '') + '</span>';
    }
    var iconBoxBg = (custom && custom.iconBoxBg) ? custom.iconBoxBg : 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
    var amountColor = (custom && custom.amountColor) ? custom.amountColor : '#FFD700';
    const displayText = senderType === 'npc' 
        ? `${senderName || '对方'}向你转账`
        : recipientName 
            ? `向${recipientName}转账`
            : '转账银两';
    
    div.innerHTML = `
        <div style="display:flex;align-items:center;gap:14px;">
            <div style="width:56px;height:56px;background:${iconBoxBg.replace(/"/g, '&quot;')};border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,0.15);">
                ${iconHtml}
            </div>
            <div style="flex:1;">
                <div style="font-weight:500;font-size:14px;opacity:0.9;margin-bottom:6px;">${displayText}</div>
                <div style="font-size:24px;font-weight:bold;color:${amountColor.replace(/"/g, '&quot;')};letter-spacing:0.5px;">¥${amount}</div>
                <div style="font-size:12px;opacity:0.7;margin-top:2px;">银两</div>
                ${note ? `<div style="font-size:12px;opacity:0.9;margin-top:4px;color:white;padding-top:6px;border-top:1px solid rgba(255,255,255,0.2);">${note}</div>` : ''}
            </div>
        </div>
    `;
    
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function closeGiftShop() {
    const modal = document.getElementById('gift-shop-modal');
    if (modal) modal.remove();
    // 清除群聊礼物目标
    window.groupGiftTargetIds = null;
    window.shoppingBackToGroupChat = false;
}

function handleGiftShopClose() {
    closeGiftShop();
    // 如果是从群聊进入的，不需要额外操作（模态框关闭即可）
    // 如果是页面模式，需要返回
}

function handleShoppingBack() {
    // 如果是从群聊进入的，返回群聊界面
    if (window.shoppingBackToGroupChat && currentGroupId !== null) {
        window.shoppingBackToGroupChat = false;
        window.groupGiftTargetIds = null;
        goToPage('page-group-chat');
    } else {
        // 否则返回聊天界面
        goToPage('page-chat');
    }
}

// ========== 侍寝系统（增强版）==========
let serveChoices = null;

/** 将皇帝好感同步到人脉中皇帝 NPC 的 affection */
function syncEmperorAffectionToContacts() {
    const p = gameState.player;
    const emperor = (gameState.npcs || []).find(function(n) { return n.role === "皇帝"; });
    if (emperor) emperor.affection = Math.max(0, Math.min(100, p.emperorAffection));
}

/**
 * 养心殿侍寝（API调用模式）：生成详细侍寝剧情后弹窗展示
 */
async function generateServeEventWithAPI(locationName, cost) {
    var stateKey = 'location_养心殿_serve';
    var loc = LOCATIONS[locationName];
    cost = (typeof cost === 'number') ? cost : (loc && typeof loc.cost === 'number' ? loc.cost : 20);
    if (apiCallingState.locationEvents[stateKey]) {
        gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + cost);
        showTipModal('正在生成侍寝剧情，请稍候...', '提示');
        updateDashboard();
        return;
    }
    if (!settings.apiKey) {
        gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + cost);
        showErrorModal('请先在设置中配置API Key才能使用API调用模式。');
        updateDashboard();
        return;
    }
    apiCallingState.locationEvents[stateKey] = true;
    var statusEl = document.getElementById('status-养心殿');
    if (statusEl) statusEl.textContent = ' (正在调用API中)';
    var p = gameState.player;
    var baseRate = Math.min(90, 30 + p.stats.charm * 0.5 + p.stats.elegance * 0.3);
    var successRate = baseRate * 0.55;
    var roll = Math.random() * 100;
    var isSuccess = roll < successRate;
    var affectionGain = isSuccess ? 15 + Math.floor(Math.random() * 15) : 5 + Math.floor(Math.random() * 10);
    var fameGain = Math.floor(affectionGain * 0.5);
    var resultText = isSuccess ? '满意' : '一般';
    var emperor = (gameState.npcs || []).find(function(n) { return n.role === '皇帝'; });
    var emperorDesc = emperor ? (emperor.name || '陛下') + '，' + (emperor.personality || '') : (gameState.world.emperorDesc || '陛下');
    var systemPrompt = '你是一个宫廷游戏的剧情撰写者。请根据以下信息，写一段「养心殿侍寝」的详细、香艳剧情。\n' +
        (getStylePresetPrompt ? getStylePresetPrompt() : '') +
        (typeof getAntiBaguguPrompt === 'function' ? getAntiBaguguPrompt() : '') +
        '\n背景：\n- 朝代：' + (gameState.world.dynasty || '架空') + '\n- 皇帝：' + emperorDesc + '\n- 玩家：' + (getPlayerContextForAPI ? getPlayerContextForAPI() : '') + '\n- 侍寝结果：陛下对玩家' + resultText + '（好感度+' + affectionGain + '，声望+' + fameGain + '）。\n\n要求：\n1. 剧情不少于300字，可写云雨之欢、鱼水之欢、罗帐春宵、肌肤之亲、交颈缠绵、共赴巫山、枕席承欢、宽衣解带、玉体横陈等侍寝过程与身体细节，但必须全部使用古风/古典小说式委婉用语（如：云雨、巫山、合欢、承恩、侍寝、罗帷、香肌、朱唇、酥胸、纤腰、交缠、颠鸾倒凤、春宵一刻等），禁止使用任何现代粗俗或直白词汇。\n2. 从入殿、沐浴更衣、被召入龙床到次日清晨的经过都要写，氛围、对话与肢体细节并用古文笔法。\n3. 与侍寝结果一致：' + resultText + '。\n4. 若涉及才艺、侍寝技巧等，须与玩家技能等级一致。\n\n只输出一个JSON：{"story":"剧情正文"}，不要其他文字。';
    try {
        var response = await fetch(settings.apiUrl + '/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settings.apiKey },
            body: JSON.stringify({
                model: settings.model || 'gpt-3.5-turbo',
                messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: '请生成养心殿侍寝的详细、香艳剧情，用古风词语写云雨承欢过程，结果为陛下对玩家' + resultText + '。' }
                ],
                temperature: 0.9,
                max_tokens: 1500
            })
        });
        if (!response.ok) throw new Error('API调用失败：' + response.status + ' ' + response.statusText);
        var data = await response.json();
        if (!data.choices || !data.choices[0] || !data.choices[0].message) throw new Error('API返回格式错误');
        var reply = (data.choices[0].message.content || '').trim();
        var jsonMatch = reply.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('API返回的不是有效JSON');
        var result = JSON.parse(jsonMatch[0]);
        var story = result.story || ('你在养心殿侍寝一夜，陛下对你' + (isSuccess ? '颇为满意。' : '表现平平，略加赏赐。'));
        p.emperorAffection = Math.min(100, p.emperorAffection + affectionGain);
        syncEmperorAffectionToContacts();
        p.stats.fame += fameGain;
        gameState.emperorMemory = gameState.emperorMemory || [];
        gameState.emperorMemory.push({
            date: gameState.world.year + '-' + gameState.world.month + '-' + gameState.world.day,
            choice: '',
            result: resultText,
            affectionGain: affectionGain
        });
        var pregnancyChance = 0.25;
        var underContraceptive = p.contraceptiveUntil && Date.now() < p.contraceptiveUntil;
        var isPregnant = isSuccess && !underContraceptive && Math.random() < pregnancyChance;
        if (isPregnant) {
            p.pregnancy = p.pregnancy || {};
            p.pregnancy.isPregnant = true;
            p.pregnancy.month = 0;
            p.pregnancy.pregnancyStartTime = Date.now();
            p.pregnancy.fatherNpcId = null;
            story += '\n\n喜得龙嗣。';
        }
        if (emperor) {
            if (p.hasSyphilis && !emperor.hasSyphilis && Math.random() < 0.4) emperor.hasSyphilis = true;
            if (emperor.hasSyphilis && !p.hasSyphilis && Math.random() < 0.4) { p.hasSyphilis = true; showTipModal('侍寝后身体不适，经查竟被染上花柳之症。此病终身不愈，会留后遗症，且具传染性。', '花柳病'); }
        }
        recordTodayVisit('养心殿');
        showLocationEventModal({
            locationName: '养心殿',
            story: story,
            eventType: '侍寝',
            person: null,
            rewards: { fame: fameGain, affection: affectionGain }
        });
        updateDashboard();
    } catch (e) {
        console.error('生成侍寝剧情失败:', e);
        gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + cost);
        showErrorModal('生成侍寝剧情失败：' + (e.message || e) + '\n\n请检查API配置后重试。');
        updateDashboard();
    } finally {
        if (statusEl) statusEl.textContent = '';
        apiCallingState.locationEvents[stateKey] = false;
    }
}

/** 养心殿：与地图事件一致，用弹窗展示侍寝结果，无选项 */
function doServeAsModal() {
    const p = gameState.player;
    const baseRate = Math.min(90, 30 + p.stats.charm * 0.5 + p.stats.elegance * 0.3);
    const successRate = baseRate * 0.55;
    const roll = Math.random() * 100;
    const isSuccess = roll < successRate;
    const affectionGain = isSuccess ? 15 + Math.floor(Math.random() * 15) : 5 + Math.floor(Math.random() * 10);
    p.emperorAffection = Math.min(100, p.emperorAffection + affectionGain);
    syncEmperorAffectionToContacts();
    const fameGain = Math.floor(affectionGain * 0.5);
    p.stats.fame += fameGain;
    gameState.emperorMemory = gameState.emperorMemory || [];
    gameState.emperorMemory.push({
        date: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`,
        choice: "",
        result: isSuccess ? "满意" : "一般",
        affectionGain: affectionGain
    });
    var emperor = (gameState.npcs || []).find(function(n) { return n.role === '皇帝'; });
    if (emperor) {
        if (p.hasSyphilis && !emperor.hasSyphilis && Math.random() < 0.4) emperor.hasSyphilis = true;
        if (emperor.hasSyphilis && !p.hasSyphilis && Math.random() < 0.4) { p.hasSyphilis = true; showTipModal('侍寝后身体不适，经查竟被染上花柳之症。此病终身不愈，会留后遗症，且具传染性。', '花柳病'); }
    }
    let story = isSuccess
        ? "你在养心殿侍寝一夜，陛下对你颇为满意。"
        : "你在养心殿侍寝一夜，表现平平，陛下略加赏赐。";
    const pregnancyChance = 0.25;
    const underContraceptive = p.contraceptiveUntil && Date.now() < p.contraceptiveUntil;
    const isPregnant = isSuccess && !underContraceptive && Math.random() < pregnancyChance;
    if (isPregnant) {
        p.pregnancy = p.pregnancy || {};
        p.pregnancy.isPregnant = true;
        p.pregnancy.month = 0;
        p.pregnancy.pregnancyStartTime = Date.now();
        p.pregnancy.fatherNpcId = null; // 皇帝
        story += "\n\n喜得龙嗣。";
    }
    const rewards = { fame: fameGain, affection: affectionGain };
    recordTodayVisit("养心殿");
    showLocationEventModal({
        locationName: "养心殿",
        story: story,
        eventType: "侍寝",
        person: null,
        rewards: rewards
    });
    updateDashboard();
}

function startServe() {
    const container = document.getElementById('serve-content');
    const playerCharm = gameState.player.stats.charm;
    const playerElegance = gameState.player.stats.elegance;
    
    // 生成侍寝选项
    serveChoices = [
        { text: "温柔体贴", effect: { affection: 15, chance: 0.6 } },
        { text: "热情主动", effect: { affection: 25, chance: 0.4, pregnancyBonus: 0.1 } },
        { text: "优雅端庄", effect: { affection: 20, chance: 0.5, fameBonus: 10 } },
        { text: "使用技巧", effect: { affection: 30, chance: 0.7, requireSkill: "侍寝技巧" } }
    ];
    
    container.innerHTML = `
        <p>🌙 今夜你被选中侍寝...</p>
        <p>请选择你的表现方式：</p>
        <div id="serve-choices">
            ${serveChoices.map((choice, idx) => `
                <button class="btn" style="margin:5px;" onclick="selectServeChoice(${idx})">${choice.text}</button>
            `).join('')}
        </div>
        <p style="font-size:12px;color:#757ED3;margin-top:10px;">当前皇帝好感: ${gameState.player.emperorAffection}</p>
    `;
}

function selectServeChoice(choiceIdx) {
    const choice = serveChoices[choiceIdx];
    const container = document.getElementById('serve-content');
    
    // 检查技能要求
    if (choice.effect.requireSkill) {
        const skill = gameState.player.skills[choice.effect.requireSkill];
        if (!skill || skill.level < 1) {
            alert("需要学习" + choice.effect.requireSkill + "才能使用此选项！");
            return;
        }
    }
    
    const playerCharm = gameState.player.stats.charm;
    const playerElegance = gameState.player.stats.elegance;
    const baseSuccessRate = Math.min(90, 30 + playerCharm * 0.5 + playerElegance * 0.3);
    const successRate = baseSuccessRate * choice.effect.chance;
    const roll = Math.random() * 100;
    
    if (roll < successRate) {
        const affectionGain = choice.effect.affection + Math.floor(Math.random() * 10);
        gameState.player.emperorAffection += affectionGain;
        syncEmperorAffectionToContacts();
        gameState.player.stats.fame += Math.floor(affectionGain * 0.5);
        if (choice.effect.fameBonus) gameState.player.stats.fame += choice.effect.fameBonus;
        
        // 记录到皇帝记忆
        gameState.emperorMemory.push({
            date: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`,
            choice: choice.text,
            result: "满意",
            affectionGain: affectionGain
        });
        
        // 怀孕判定
        const pregnancyChance = 0.3 + (choice.effect.pregnancyBonus || 0);
        const underContraceptive = gameState.player.contraceptiveUntil && Date.now() < gameState.player.contraceptiveUntil;
        const isPregnant = !underContraceptive && roll < successRate * pregnancyChance;
        
        container.innerHTML = `
            <p>🌙 今夜你被选中侍寝...</p>
            <p>你选择了"${choice.text}"</p>
            <p>皇帝对你很满意，好感度+${affectionGain}</p>
            ${isPregnant ? "<p>🎉 特别满意！你怀孕了！</p>" : ""}
        `;
        
        if (isPregnant) {
            gameState.player.pregnancy.isPregnant = true;
            gameState.player.pregnancy.month = 0;
            gameState.player.pregnancy.pregnancyStartTime = Date.now();
            gameState.player.pregnancy.fatherNpcId = null; // 皇帝
        }
    } else {
        const affectionGain = Math.floor(5 + Math.random() * 10);
        gameState.player.emperorAffection += affectionGain;
        syncEmperorAffectionToContacts();
        
        gameState.emperorMemory.push({
            date: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`,
            choice: choice.text,
            result: "一般",
            affectionGain: affectionGain
        });
        
        container.innerHTML = `
            <p>🌙 今夜你被选中侍寝...</p>
            <p>你选择了"${choice.text}"</p>
            <p>但表现平平，皇帝好感度+${affectionGain}</p>
        `;
    }
    
    updateDashboard();
}

// ---------- 孩子系统：模板与出生流程 ----------
const CHILD_TEMPLATES = [
    { gender: "男", personality: "聪颖稳重", background: "自幼在宫中长大，性情温和。" },
    { gender: "女", personality: "伶俐乖巧", background: "深得长辈喜爱，知书达理。" },
    { gender: "男", personality: "活泼好动", background: "精力充沛，喜好骑射。" },
    { gender: "女", personality: "沉静内敛", background: "喜爱诗书，心思细腻。" },
    { gender: "男", personality: "倔强要强", background: "不甘人后，勤学苦练。" }
];

function generateChildFromTemplate(templateIndex) {
    const t = CHILD_TEMPLATES[templateIndex >= 0 && templateIndex < CHILD_TEMPLATES.length ? templateIndex : Math.floor(Math.random() * CHILD_TEMPLATES.length)];
    return {
        id: "child_" + Date.now(),
        name: document.getElementById("birth-child-name") ? (document.getElementById("birth-child-name").value.trim() || "未取名") : "未取名",
        gender: t.gender,
        personality: t.personality,
        background: t.background,
        fatherNpcId: gameState.player.pregnancy.fatherNpcId !== undefined ? gameState.player.pregnancy.fatherNpcId : null,
        birthDate: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`,
        attributes: { constitution: 10, talent: 10, charm: 10, wisdom: 10 },
        ageInYears: 0,
        isDead: false,
        isKidnapped: false,
        marriedToNpcId: null,
        history: []
    };
}

async function generateChildWithAPI() {
    const savedSettings = localStorage.getItem("palace_settings");
    if (!savedSettings) throw new Error("请先在设置中配置 API");
    const settings = JSON.parse(savedSettings);
    if (!settings.apiKey || !settings.apiUrl) throw new Error("请先在设置中配置 API Key 和 API 地址");
    const name = (document.getElementById("birth-child-name") && document.getElementById("birth-child-name").value.trim()) || "未取名";
    const res = await fetch(settings.apiUrl + "/chat/completions", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + settings.apiKey },
        body: JSON.stringify({
            model: settings.model || "gpt-3.5-turbo",
            messages: [
                { role: "system", content: "你是一个宫廷游戏的角色设定助手。只输出一个JSON对象，不要其他文字。" },
                { role: "user", content: "为刚出生的孩子生成设定。孩子姓名：" + name + "。返回JSON，包含且仅包含：gender（男或女）、personality（性格描述，一句话）、background（背景描述，一句话）。" }
            ],
            temperature: 0.7,
            max_tokens: 300
        })
    });
    if (!res.ok) throw new Error("API 调用失败：" + res.status);
    const data = await res.json();
    if (!data.choices || !data.choices[0] || !data.choices[0].message) throw new Error("API 返回格式错误");
    const text = data.choices[0].message.content;
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error("API 返回的不是有效 JSON");
    const r = JSON.parse(jsonMatch[0]);
    return {
        id: "child_" + Date.now(),
        name: name,
        gender: (r.gender === "女" ? "女" : "男"),
        personality: (r.personality || "未知").toString().trim(),
        background: (r.background || "").toString().trim(),
        fatherNpcId: gameState.player.pregnancy.fatherNpcId !== undefined ? gameState.player.pregnancy.fatherNpcId : null,
        birthDate: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`,
        attributes: { constitution: 10, talent: 10, charm: 10, wisdom: 10 },
        ageInYears: 0,
        isDead: false,
        isKidnapped: false,
        marriedToNpcId: null,
        history: []
    };
}

let birthChildNameValue = "";

function onBirthTrigger() {
    const p = gameState.player;
    birthChildNameValue = "";
    const nameInput = document.getElementById("birth-child-name");
    if (nameInput) { nameInput.value = ""; }
    document.getElementById("birth-step-name").style.display = "block";
    document.getElementById("birth-step-api").style.display = "none";
    const modal = document.getElementById("birth-child-modal");
    if (modal) {
        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
    }
}

function closeBirthChildModal() {
    const modal = document.getElementById("birth-child-modal");
    if (modal) modal.style.display = "none";
}

function birthConfirmName() {
    const nameInput = document.getElementById("birth-child-name");
    const name = nameInput ? nameInput.value.trim() : "";
    if (!name) {
        alert("请先为孩子起名");
        return;
    }
    birthChildNameValue = name;
    document.getElementById("birth-step-name").style.display = "none";
    document.getElementById("birth-step-api").style.display = "block";
}

function birthChooseAPI(useAPI) {
    const nameInput = document.getElementById("birth-child-name");
    const name = (nameInput && nameInput.value.trim()) || birthChildNameValue || "未取名";
    if (nameInput) nameInput.value = name;

    function finishBirth(child) {
        child.name = name;
        gameState.player.children.push(child);
        const npc = {
            id: Date.now(),
            name: child.name,
            gender: child.gender,
            role: "子女",
            personality: child.personality,
            appearance: child.background || "容貌端正",
            affection: 80,
            metPlace: "出生",
            history: child.history || [],
            relationship: "neutral",
            relationshipLevel: 80,
            npcMemory: [],
            specialEvents: [],
            canSendEmoji: true,
            emojis: [],
            isChild: true,
            childId: child.id
        };
        gameState.player.relationships[npc.id] = { type: "neutral", level: 80 };
        gameState.npcs.push(npc);
        gameState.player.pregnancy.isPregnant = false;
        gameState.player.pregnancy.month = 0;
        gameState.player.pregnancy.pregnancyStartTime = 0;
        gameState.player.pregnancy.fatherNpcId = null;
        gameState.player.stats.fame += 500;
        gameState.player.stats.money += 200;
        closeBirthChildModal();
        updateDashboard();
        if (document.getElementById("page-contacts")) renderContacts();
        alert("🎉 恭喜！你诞下了一位" + (child.gender === "男" ? "皇子" : "公主") + "！\n姓名：" + child.name + "\n声望+500，银两+200\n孩子已加入人脉。");
    }

    if (useAPI) {
        const btn = document.getElementById("birth-btn-api");
        if (btn) { btn.disabled = true; btn.textContent = "生成中..."; }
        generateChildWithAPI().then(function(child) {
            finishBirth(child);
        }).catch(function(err) {
            if (btn) { btn.disabled = false; btn.textContent = "开 API"; }
            alert("API 生成失败：" + (err.message || err) + "\n请重新选择「开 API」或「不开（模板）」。");
        });
    } else {
        const child = generateChildFromTemplate(-1);
        finishBirth(child);
    }
}

function getChildByChatTarget() {
    const npc = gameState.chatTargetId ? gameState.npcs.find(n => n.id === gameState.chatTargetId) : null;
    if (!npc || !npc.isChild || !npc.childId) return { npc: null, child: null };
    const child = gameState.player.children.find(c => c.id === npc.childId);
    return { npc, child };
}

function childMenuRaise() {
    const { npc, child } = getChildByChatTarget();
    if (!child) return;
    document.getElementById('chat-plus-menu').classList.remove('show');
    const att = child.attributes || { constitution: 10, talent: 10, charm: 10, wisdom: 10 };
    att.constitution = Math.min(100, (att.constitution || 10) + Math.floor(Math.random() * 3) + 1);
    att.talent = Math.min(100, (att.talent || 10) + Math.floor(Math.random() * 3) + 1);
    att.charm = Math.min(100, (att.charm || 10) + Math.floor(Math.random() * 3) + 1);
    att.wisdom = Math.min(100, (att.wisdom || 10) + Math.floor(Math.random() * 3) + 1);
    child.attributes = att;
    alert("你对" + child.name + "进行了一番教养，孩子有所成长。");
}

function childMenuKill() {
    const { npc, child } = getChildByChatTarget();
    if (!child) return;
    document.getElementById('chat-plus-menu').classList.remove('show');
    if (!confirm("确定要暗杀" + child.name + "吗？此操作不可撤销。")) return;
    child.isDead = true;
    if (npc) npc.role = "子女（已故）";
    alert(child.name + "已不在人世。");
    if (document.getElementById('page-contacts')) renderContacts();
}

function childMenuMarry() {
    const { npc, child } = getChildByChatTarget();
    if (!child || Math.floor(child.ageInYears || 0) < 16) {
        alert("孩子需年满16岁方可指婚。");
        return;
    }
    document.getElementById('chat-plus-menu').classList.remove('show');
    const candidates = gameState.npcs.filter(n => !n.isChild && n.id !== npc.id && n.gender !== child.gender);
    if (candidates.length === 0) {
        alert("当前无人可指婚，请先在人脉中添加异性。");
        return;
    }
    const names = candidates.map(n => n.name).join("、");
    const choice = prompt("为" + child.name + "指婚。请输入对方姓名：\n可选：" + names);
    if (!choice || !choice.trim()) return;
    const mate = candidates.find(n => n.name === choice.trim() || n.name.indexOf(choice.trim()) >= 0);
    if (!mate) {
        alert("未找到该人选。");
        return;
    }
    child.marriedToNpcId = mate.id;
    alert(child.name + " 已与 " + mate.name + " 指婚。");
}

var sexTopicNpcId = null;

function closeSexTopicConfirmModal() {
    document.getElementById('sex-topic-confirm-modal').style.display = 'none';
    sexTopicNpcId = null;
}

function openEncounterMapModal() {
    const npc = gameState.chatTargetId ? gameState.npcs.find(n => n.id === gameState.chatTargetId) : null;
    if (!npc) {
        alert("请先选择对话对象。");
        return;
    }
    if (npc.isChild) {
        alert("子女无遇地图设置。");
        return;
    }
    document.getElementById('chat-plus-menu').classList.remove('show');
    document.getElementById('encounter-map-title').innerHTML = '<span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">map</span>遇地图 · ' + (npc.name || '');
    const listEl = document.getElementById('encounter-map-list');
    listEl.innerHTML = '';
    const locationNames = Object.keys(LOCATIONS || {}).filter(function(name) { return name !== '内务府'; });
    const encounterMaps = npc.encounterMaps || [];
    locationNames.forEach(function(name) {
        const label = document.createElement('label');
        label.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px 0;cursor:pointer;';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.dataset.loc = name;
        cb.checked = encounterMaps.indexOf(name) >= 0;
        label.appendChild(cb);
        label.appendChild(document.createTextNode(name));
        listEl.appendChild(label);
    });
    document.getElementById('encounter-map-modal').style.display = 'flex';
    document.getElementById('encounter-map-modal').style.alignItems = 'center';
    document.getElementById('encounter-map-modal').style.justifyContent = 'center';
}

function closeEncounterMapModal() {
    document.getElementById('encounter-map-modal').style.display = 'none';
}

function saveEncounterMap() {
    const npc = gameState.chatTargetId ? gameState.npcs.find(n => n.id === gameState.chatTargetId) : null;
    if (!npc) return;
    const listEl = document.getElementById('encounter-map-list');
    const checked = [];
    listEl.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
        if (cb.checked && cb.dataset.loc) checked.push(cb.dataset.loc);
    });
    npc.encounterMaps = checked;
    closeEncounterMapModal();
    showTipModal("遇地图已保存。", "保存成功");
}

var BUBBLE_APPLY_USER_DEFAULT = '__user_default__';
function bubbleApplyValueToStyle(value) {
    if (!value) return {};
    var parts = String(value).split(':');
    var kind = parts[0];
    var id = parts[1];
    if (kind === 'user') {
        if (id === BUBBLE_APPLY_USER_DEFAULT || !id) return gameState.chatBubbleStyleUser || {};
        var n = gameState.npcs ? gameState.npcs.find(function(x) { return x.id == id || String(x.id) === String(id); }) : null;
        return (n && n.chatBubbleStyleUser) ? n.chatBubbleStyleUser : {};
    }
    if (kind === 'npc') {
        var n = gameState.npcs ? gameState.npcs.find(function(x) { return x.id == id || String(x.id) === String(id); }) : null;
        return (n && n.chatBubbleStyle) ? n.chatBubbleStyle : {};
    }
    return {};
}
function fillBubbleFormFromStyle(s) {
    if (!s) s = {};
    document.getElementById('bubble-user-bg').value = s.background || '';
    document.getElementById('bubble-user-color').value = s.color || '';
    document.getElementById('bubble-user-radius').value = s.borderRadius != null ? s.borderRadius : '';
    document.getElementById('bubble-user-padding').value = s.padding != null ? s.padding : '';
    document.getElementById('bubble-user-border').value = s.border || '';
    document.getElementById('bubble-user-bg-image').value = s.backgroundImage || '';
    refreshBubblePreview();
}
function updateBubbleApplySelectedLabel() {
    var sel = document.getElementById('bubble-apply-npc-id');
    var lab = document.getElementById('bubble-apply-selected-label');
    if (!sel || !lab) return;
    var chosen = sel.options[sel.selectedIndex];
    lab.textContent = chosen ? chosen.textContent : '—';
}
function onBubbleApplySelectChange() {
    var sel = document.getElementById('bubble-apply-npc-id');
    if (!sel) return;
    var val = sel.value;
    if (!val) return;
    var s = bubbleApplyValueToStyle(val);
    fillBubbleFormFromStyle(s);
    updateBubbleApplySelectedLabel();
}
function fillBubbleApplyNpcSelect(preSelectValue) {
    var sel = document.getElementById('bubble-apply-npc-id');
    if (!sel) return;
    sel.innerHTML = '';
    var npcs = gameState.npcs || [];
    var opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = '请选择…';
    sel.appendChild(opt0);
    var optMe = document.createElement('option');
    optMe.value = 'user:' + BUBBLE_APPLY_USER_DEFAULT;
    optMe.textContent = '我（默认）';
    sel.appendChild(optMe);
    npcs.forEach(function(n) {
        var name = n.name || ('角色 ' + n.id);
        var idStr = String(n.id);
        var optUser = document.createElement('option');
        optUser.value = 'user:' + idStr;
        optUser.textContent = name + '的界面的我';
        sel.appendChild(optUser);
        var optNpc = document.createElement('option');
        optNpc.value = 'npc:' + idStr;
        optNpc.textContent = name + '的界面的' + name;
        sel.appendChild(optNpc);
    });
    if (preSelectValue && typeof preSelectValue === 'string') {
        var exists = false;
        for (var i = 0; i < sel.options.length; i++) { if (sel.options[i].value === preSelectValue) { exists = true; break; } }
        if (exists) sel.value = preSelectValue;
        else sel.value = '';
    } else {
        sel.value = '';
    }
    updateBubbleApplySelectedLabel();
}
function openBubbleStyleModal(preSelectValue, fromLibrary) {
    document.getElementById('chat-plus-menu').classList.remove('show');
    window._bubbleModalFromLibrary = !!fromLibrary;
    if (!fromLibrary) window._bubbleModalLibraryEditIndex = -1;
    var preSelect = (fromLibrary && preSelectValue) ? preSelectValue : ('user:' + (gameState.chatTargetId || BUBBLE_APPLY_USER_DEFAULT));
    fillBubbleApplyNpcSelect(preSelect);
    if (!fromLibrary) fillBubbleFormFromStyle(bubbleApplyValueToStyle(preSelect));
    var applyRow = document.getElementById('bubble-modal-apply-npc-row');
    if (applyRow) applyRow.style.display = fromLibrary ? 'block' : 'none';
    document.getElementById('bubble-style-modal').style.display = 'flex';
    document.getElementById('bubble-style-modal').style.alignItems = 'center';
    document.getElementById('bubble-style-modal').style.justifyContent = 'center';
    refreshBubblePreview();
}
function closeBubbleStyleModal() { document.getElementById('bubble-style-modal').style.display = 'none'; }

var BUBBLE_LIBRARY_KEY = 'palace_bubbleLibrary';
function getBubbleLibrary() {
    try {
        var raw = localStorage.getItem(BUBBLE_LIBRARY_KEY);
        return raw ? JSON.parse(raw) : [];
    } catch (e) { return []; }
}
function saveBubbleLibrary(arr) {
    localStorage.setItem(BUBBLE_LIBRARY_KEY, JSON.stringify(arr || []));
}
function openBubbleLibraryModal() {
    document.getElementById('bubble-library-modal').style.display = 'flex';
    document.getElementById('bubble-library-modal').style.alignItems = 'center';
    document.getElementById('bubble-library-modal').style.justifyContent = 'center';
    renderBubbleLibraryList();
}
function closeBubbleLibraryModal() {
    document.getElementById('bubble-library-modal').style.display = 'none';
}
function renderBubbleLibraryList() {
    var list = getBubbleLibrary();
    var listEl = document.getElementById('bubble-library-list');
    var emptyEl = document.getElementById('bubble-library-empty');
    if (!listEl || !emptyEl) return;
    if (list.length === 0) {
        listEl.innerHTML = '';
        emptyEl.style.display = 'block';
        updateBubbleLibraryDeleteButtonVisibility();
        return;
    }
    emptyEl.style.display = 'none';
    listEl.innerHTML = list.map(function(item, index) {
        var name = item.name || (item.npcName ? item.npcName + ' 的气泡' : '我的气泡');
        var previewStyle = item.userStyle || item.npcStyle || {};
        var previewStr = '';
        if (previewStyle.background) previewStr += 'background:' + previewStyle.background + ';';
        if (previewStyle.color) previewStr += 'color:' + previewStyle.color + ';';
        if (previewStyle.borderRadius !== undefined) previewStr += 'border-radius:' + (typeof previewStyle.borderRadius === 'number' ? previewStyle.borderRadius + 'px' : previewStyle.borderRadius) + ';';
        if (previewStyle.padding !== undefined) previewStr += 'padding:' + (typeof previewStyle.padding === 'number' ? previewStyle.padding + 'px' : previewStyle.padding) + ';';
        if (previewStyle.border) previewStr += 'border:' + previewStyle.border + ';';
        return '<div class="bubble-library-item" data-id="' + (item.id || index) + '" style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(0,0,0,0.04);border-radius:10px;margin-bottom:8px;">' +
            '<input type="checkbox" class="bubble-library-cb" data-idx="' + index + '" style="flex-shrink:0;" onchange="updateBubbleLibraryDeleteButtonVisibility()">' +
            '<div class="bubble-library-preview" style="width:48px;height:32px;border-radius:8px;flex-shrink:0;' + previewStr + '"></div>' +
            '<span style="flex:1;font-size:14px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (String(name).replace(/</g, '&lt;')) + '</span>' +
            '<button type="button" class="help-btn" onclick="bubbleLibraryApply(' + index + ')" title="编辑/应用" style="padding:6px;color:var(--accent);"><span class="material-icons" style="font-size:18px;">edit</span></button>' +
            '<button type="button" class="help-btn" onclick="bubbleLibraryDelete(' + index + ')" title="删除" style="padding:6px;color:var(--danger);"><span class="material-icons" style="font-size:18px;">delete</span></button>' +
            '</div>';
    }).join('');
    updateBubbleLibraryDeleteButtonVisibility();
}
function bubbleLibraryApply(idx) {
    window._bubbleModalLibraryEditIndex = idx;
    var list = getBubbleLibrary();
    var item = list[idx];
    if (!item) return;
    var style = item.userStyle || item.npcStyle || {};
    var set = function(id, val) {
        var el = document.getElementById(id);
        if (el && val !== undefined && val !== null && val !== '') el.value = String(val).trim();
    };
    if (style.background !== undefined) set('bubble-user-bg', style.background);
    if (style.color !== undefined) set('bubble-user-color', style.color);
    if (style.borderRadius !== undefined) set('bubble-user-radius', style.borderRadius);
    if (style.padding !== undefined) set('bubble-user-padding', style.padding);
    if (style.border !== undefined) set('bubble-user-border', style.border);
    if (style.backgroundImage !== undefined) set('bubble-user-bg-image', style.backgroundImage);
    var preSelectValue = item.applyValue || (item.npcStyle ? ('npc:' + item.npcId) : ('user:' + (item.npcId || BUBBLE_APPLY_USER_DEFAULT)));
    closeBubbleLibraryModal();
    openBubbleStyleModal(preSelectValue, true);
    refreshBubblePreview();
}
function bubbleLibraryDelete(idx) {
    var list = getBubbleLibrary();
    list.splice(idx, 1);
    saveBubbleLibrary(list);
    renderBubbleLibraryList();
    showTipModal('已从气泡库移除。', '已删除');
}
function updateBubbleLibraryDeleteButtonVisibility() {
    var btn = document.getElementById('bubble-library-delete-selected-btn');
    if (btn) {
        var n = document.querySelectorAll('.bubble-library-cb:checked').length;
        btn.style.display = n > 0 ? '' : 'none';
    }
    var unselectBtn = document.getElementById('bubble-library-unselect-all-btn');
    if (unselectBtn) {
        var all = document.querySelectorAll('.bubble-library-cb');
        var checked = document.querySelectorAll('.bubble-library-cb:checked');
        unselectBtn.style.display = (all.length > 0 && checked.length === all.length) ? '' : 'none';
    }
}
function bubbleLibrarySelectAll() {
    document.querySelectorAll('.bubble-library-cb').forEach(function(cb) { cb.checked = true; });
    updateBubbleLibraryDeleteButtonVisibility();
}
function bubbleLibraryUnselectAll() {
    document.querySelectorAll('.bubble-library-cb').forEach(function(cb) { cb.checked = false; });
    updateBubbleLibraryDeleteButtonVisibility();
}
function bubbleLibraryDeleteSelected() {
    var cbs = document.querySelectorAll('.bubble-library-cb:checked');
    if (!cbs.length) {
        showTipModal('请先勾选要删除的气泡。', '提示');
        return;
    }
    var indices = Array.prototype.map.call(cbs, function(cb) { return parseInt(cb.getAttribute('data-idx'), 10); });
    indices.sort(function(a, b) { return b - a; });
    var list = getBubbleLibrary();
    indices.forEach(function(i) { list.splice(i, 1); });
    saveBubbleLibrary(list);
    renderBubbleLibraryList();
    updateBubbleLibraryDeleteButtonVisibility();
    showTipModal('已删除 ' + indices.length + ' 条气泡。', '已删除');
}
function bubbleLibraryExportSelected() {
    var list = getBubbleLibrary();
    var cbs = document.querySelectorAll('.bubble-library-cb:checked');
    var indices = Array.prototype.map.call(cbs, function(cb) { return parseInt(cb.getAttribute('data-idx'), 10); });
    var toExport = indices.length ? indices.map(function(i) { return list[i]; }).filter(Boolean) : list;
    if (toExport.length === 0) {
        showTipModal('请先勾选要导出的气泡，或不勾选则导出全部。', '提示');
        return;
    }
    var blob = new Blob([JSON.stringify(toExport, null, 2)], { type: 'application/json' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'bubble_library_' + (new Date().toISOString().slice(0,10)) + '.json';
    a.click();
    URL.revokeObjectURL(a.href);
    showTipModal('已导出 ' + toExport.length + ' 条气泡。', '导出成功');
}
function bubbleLibraryImportFile(ev) {
    var f = ev.target.files[0];
    if (!f) return;
    var r = new FileReader();
    r.onload = function() {
        try {
            var data = JSON.parse(r.result);
            var arr = Array.isArray(data) ? data : [data];
            var list = getBubbleLibrary();
            var maxId = list.reduce(function(m, x) { return Math.max(m, (x.id || 0)); }, 0);
            arr.forEach(function(item) {
                if (item && (item.userStyle || item.npcStyle)) {
                    if (!item.id) item.id = 'imp_' + (++maxId) + '_' + Date.now();
                    list.push(item);
                }
            });
            saveBubbleLibrary(list);
            renderBubbleLibraryList();
            showTipModal('已导入 ' + arr.length + ' 条气泡。', '导入成功');
        } catch (e) {
            showTipModal('文件格式无效，请选择导出的 JSON 文件。', '导入失败');
        }
        ev.target.value = '';
    };
    r.readAsText(f);
}

function refreshBubblePreview() {
    var get = function(id) {
        var el = document.getElementById(id);
        return el ? (el.value || '').trim() : '';
    };
    var num = function(id) { var v = get(id); return v === '' ? undefined : v; };
    var userStyle = {};
    if (get('bubble-user-bg')) userStyle.background = get('bubble-user-bg');
    if (get('bubble-user-color')) userStyle.color = get('bubble-user-color');
    if (num('bubble-user-radius') !== undefined) userStyle.borderRadius = num('bubble-user-radius');
    if (get('bubble-user-padding')) userStyle.padding = get('bubble-user-padding');
    if (get('bubble-user-border')) userStyle.border = get('bubble-user-border');
    if (get('bubble-user-bg-image')) userStyle.backgroundImage = get('bubble-user-bg-image');
    var userEl = document.getElementById('bubble-preview-user');
    if (userEl) {
        userEl.style.cssText = '';
        userEl.style.background = 'rgba(0,0,0,0.06)';
        userEl.style.color = 'var(--text)';
        applyBubbleStyleToElement(userEl, userStyle);
    }
}
function saveBubbleStyle() {
    var u = {};
    var v = document.getElementById('bubble-user-bg').value.trim(); if (v) u.background = v;
    v = document.getElementById('bubble-user-color').value.trim(); if (v) u.color = v;
    v = document.getElementById('bubble-user-radius').value; if (v !== '') u.borderRadius = String(v);
    v = document.getElementById('bubble-user-padding').value; if (v !== '') u.padding = String(v);
    v = document.getElementById('bubble-user-border').value.trim(); if (v) u.border = v;
    v = document.getElementById('bubble-user-bg-image').value.trim(); if (v) u.backgroundImage = v;
    var hasUser = Object.keys(u).length > 0;
    if (!hasUser) {
        showTipModal('请至少填写一项样式。', '提示');
        return;
    }
    var applyValue = '';
    if (window._bubbleModalFromLibrary) {
        var applyNpcIdEl = document.getElementById('bubble-apply-npc-id');
        applyValue = applyNpcIdEl ? applyNpcIdEl.value : '';
        if (!applyValue) {
            showTipModal('请先选择一项（如 我（默认）或 XX的界面的我/XX）。', '提示');
            return;
        }
    } else {
        applyValue = 'user:' + (gameState.chatTargetId || BUBBLE_APPLY_USER_DEFAULT);
        if (!gameState.chatTargetId && !gameState.chatBubbleStyleUser) {}
    }
    var parts = String(applyValue).split(':');
    var kind = parts[0];
    var id = parts[1];
    var isUserDefault = kind === 'user' && (id === BUBBLE_APPLY_USER_DEFAULT || !id);
    var applyNpc = null;
    var libLabel = '';
    if (isUserDefault) {
        gameState.chatBubbleStyleUser = Object.assign({}, u);
        libLabel = '我（默认）';
    } else if (kind === 'user' && id) {
        applyNpc = gameState.npcs ? gameState.npcs.find(function(x) { return x.id == id || String(x.id) === String(id); }) : null;
        if (!applyNpc) {
            showTipModal('未找到该角色，请重新选择。', '提示');
            return;
        }
        applyNpc.chatBubbleStyleUser = Object.assign({}, u);
        libLabel = (applyNpc.name || id) + '的界面的我';
    } else if (kind === 'npc' && id) {
        applyNpc = gameState.npcs ? gameState.npcs.find(function(x) { return x.id == id || String(x.id) === String(id); }) : null;
        if (!applyNpc) {
            showTipModal('未找到该角色，请重新选择。', '提示');
            return;
        }
        applyNpc.chatBubbleStyle = Object.assign({}, u);
        libLabel = (applyNpc.name || id) + '的界面的' + (applyNpc.name || id);
    }
    var lib = getBubbleLibrary();
    var editIdx = window._bubbleModalLibraryEditIndex;
    var libNpcId = isUserDefault ? BUBBLE_APPLY_USER_DEFAULT : (applyNpc ? applyNpc.id : id);
    var libNpcName = isUserDefault ? '我（默认）' : (applyNpc ? applyNpc.name : '');
    var newItem = {
        id: (editIdx >= 0 && editIdx < lib.length) ? lib[editIdx].id : lib.reduce(function(m, x) { return Math.max(m, (typeof x.id === 'number' ? x.id : 0)); }, 0) + 1,
        type: kind === 'npc' ? 'npc' : 'user',
        npcId: libNpcId,
        npcName: libNpcName,
        name: libLabel,
        applyValue: applyValue,
        createdAt: (editIdx >= 0 && editIdx < lib.length) ? lib[editIdx].createdAt : Date.now()
    };
    if (kind === 'npc') {
        newItem.npcStyle = Object.assign({}, u);
    } else {
        newItem.userStyle = Object.assign({}, u);
    }
    if (window._bubbleModalFromLibrary && typeof editIdx === 'number' && editIdx >= 0 && editIdx < lib.length) {
        newItem.id = lib[editIdx].id;
        newItem.createdAt = lib[editIdx].createdAt;
        lib[editIdx] = newItem;
        saveBubbleLibrary(lib);
        closeBubbleStyleModal();
        showTipModal('已更新：「' + libLabel + '」。', '保存成功');
    } else {
        newItem.id = lib.reduce(function(m, x) { return Math.max(m, (typeof x.id === 'number' ? x.id : 0)); }, 0) + 1;
        newItem.createdAt = Date.now();
        lib.push(newItem);
        saveBubbleLibrary(lib);
        closeBubbleStyleModal();
        showTipModal('已保存「' + libLabel + '」并加入气泡库。', '保存成功');
    }
    window._bubbleModalLibraryEditIndex = -1;
}

var TRANSFER_APPLY_DEFAULT = '__transfer_default__';
function fillTransferApplyNpcSelect(preSelectValue) {
    var sel = document.getElementById('transfer-apply-npc-id');
    if (!sel) return;
    sel.innerHTML = '';
    var npcs = gameState.npcs || [];
    var opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = '请选择…';
    sel.appendChild(opt0);
    var optMe = document.createElement('option');
    optMe.value = 'user:' + TRANSFER_APPLY_DEFAULT;
    optMe.textContent = '我（默认）';
    sel.appendChild(optMe);
    npcs.forEach(function(n) {
        var name = n.name || ('角色 ' + n.id);
        var idStr = String(n.id);
        var optUser = document.createElement('option');
        optUser.value = 'user:' + idStr;
        optUser.textContent = name + '的界面的我';
        sel.appendChild(optUser);
        var optNpc = document.createElement('option');
        optNpc.value = 'npc:' + idStr;
        optNpc.textContent = name + '的界面的' + name;
        sel.appendChild(optNpc);
    });
    if (preSelectValue && typeof preSelectValue === 'string') {
        var exists = false;
        for (var i = 0; i < sel.options.length; i++) { if (sel.options[i].value === preSelectValue) { exists = true; break; } }
        if (exists) sel.value = preSelectValue;
        else sel.value = '';
    } else {
        sel.value = '';
    }
}
function openTransferStyleModal(fromLibrary, preSelectNpcId) {
    document.getElementById('chat-plus-menu').classList.remove('show');
    window._transferModalFromLibrary = !!fromLibrary;
    var row = document.getElementById('transfer-apply-npc-row');
    if (row) row.style.display = fromLibrary ? 'block' : 'none';
    if (!fromLibrary) {
        var npc = gameState.chatTargetId ? gameState.npcs.find(function(n) { return n.id == gameState.chatTargetId || String(n.id) === String(gameState.chatTargetId); }) : null;
        var s = (npc && npc.moneyTransferStyle) ? npc.moneyTransferStyle : (gameState.moneyTransferStyle || {});
        var d = (npc && npc.moneyTransferDetailStyle) ? npc.moneyTransferDetailStyle : (gameState.moneyTransferDetailStyle || {});
        document.getElementById('transfer-style-bg').value = s.background || '';
        document.getElementById('transfer-style-bg-image').value = s.backgroundImage || '';
        document.getElementById('transfer-style-color').value = s.color || '';
        document.getElementById('transfer-style-radius').value = s.borderRadius != null ? s.borderRadius : '';
        document.getElementById('transfer-style-padding').value = s.padding != null ? s.padding : '';
        document.getElementById('transfer-style-border').value = s.border || '';
        document.getElementById('transfer-style-icon-box-bg').value = s.iconBoxBg || '';
        document.getElementById('transfer-style-amount-color').value = s.amountColor || '';
        document.getElementById('transfer-style-icon').value = s.icon || '';
        document.getElementById('transfer-detail-bg').value = d.background || '';
        document.getElementById('transfer-detail-color').value = d.color || '';
        document.getElementById('transfer-detail-radius').value = d.borderRadius != null ? d.borderRadius : '';
    }
    if (fromLibrary) fillTransferApplyNpcSelect(preSelectNpcId != null && preSelectNpcId !== '' ? preSelectNpcId : '');
    document.getElementById('transfer-style-modal').style.display = 'flex';
    document.getElementById('transfer-style-modal').style.alignItems = 'center';
    document.getElementById('transfer-style-modal').style.justifyContent = 'center';
    refreshTransferPreview();
}
function closeTransferStyleModal() { document.getElementById('transfer-style-modal').style.display = 'none'; }
function setTransferIcon(name) {
    var el = document.getElementById('transfer-style-icon');
    if (el) { el.value = name; refreshTransferPreview(); }
}
function onTransferIconFileSelected(ev) {
    var f = ev.target.files && ev.target.files[0];
    if (!f) return;
    var r = new FileReader();
    r.onload = function() {
        var el = document.getElementById('transfer-style-icon');
        if (el) { el.value = r.result || ''; refreshTransferPreview(); showTipModal('已选择本地图片作为图标。', '已导入'); }
    };
    r.readAsDataURL(f);
    ev.target.value = '';
}
function refreshTransferPreview() {
    var get = function(id) { var el = document.getElementById(id); return el ? (el.value || '').trim() : ''; };
    var num = function(id) { var v = get(id); return v === '' ? undefined : v; };
    var el = document.getElementById('transfer-preview');
    if (!el) return;
    el.style.cssText = '';
    var bg = get('transfer-style-bg');
    var bgImg = get('transfer-style-bg-image');
    if (bgImg) { el.style.backgroundImage = 'url(' + bgImg + ')'; el.style.backgroundSize = 'cover'; el.style.backgroundPosition = 'center'; if (bg) el.style.backgroundColor = bg; }
    else if (bg) el.style.background = bg;
    var c = get('transfer-style-color'); if (c) el.style.color = c;
    var r = num('transfer-style-radius'); if (r !== undefined) el.style.borderRadius = (typeof r === 'number' ? r + 'px' : r);
    var p = num('transfer-style-padding'); if (p !== undefined) el.style.padding = (typeof p === 'number' ? p + 'px' : p);
    var b = get('transfer-style-border'); if (b) el.style.border = b;
    var iconVal = get('transfer-style-icon');
    var iconBoxBg = get('transfer-style-icon-box-bg') || 'linear-gradient(135deg,#FFD700,#FFA500)';
    var amountColor = get('transfer-style-amount-color') || '#FFD700';
    var iconHtml = '';
    if (iconVal && (iconVal.startsWith('http') || iconVal.startsWith('data:'))) {
        iconHtml = '<img src="' + iconVal.replace(/"/g, '&quot;') + '" style="width:24px;height:24px;object-fit:contain;">';
    } else {
        iconHtml = '<span class="material-icons" style="font-size:24px;">' + (iconVal || 'payments').replace(/[<>"']/g, '') + '</span>';
    }
    el.innerHTML = '<div style="display:flex;align-items:center;gap:8px;"><div style="width:40px;height:40px;background:' + iconBoxBg.replace(/"/g, '&quot;') + ';border-radius:8px;display:flex;align-items:center;justify-content:center;">' + iconHtml + '</div><span style="color:' + amountColor.replace(/"/g, '&quot;') + ';">向对方转账 ¥100</span></div>';
}
function saveTransferStyle() {
    var s = {};
    var v = document.getElementById('transfer-style-bg').value.trim(); if (v) s.background = v;
    v = document.getElementById('transfer-style-bg-image').value.trim(); if (v) s.backgroundImage = v;
    v = document.getElementById('transfer-style-color').value.trim(); if (v) s.color = v;
    v = document.getElementById('transfer-style-radius').value; if (v !== '') s.borderRadius = String(v);
    v = document.getElementById('transfer-style-padding').value; if (v !== '') s.padding = String(v);
    v = document.getElementById('transfer-style-border').value.trim(); if (v) s.border = v;
    v = document.getElementById('transfer-style-icon-box-bg').value.trim(); if (v) s.iconBoxBg = v;
    v = document.getElementById('transfer-style-amount-color').value.trim(); if (v) s.amountColor = v;
    v = document.getElementById('transfer-style-icon').value.trim(); if (v) s.icon = v;
    var d = {};
    v = document.getElementById('transfer-detail-bg').value.trim(); if (v) d.background = v;
    v = document.getElementById('transfer-detail-color').value.trim(); if (v) d.color = v;
    v = document.getElementById('transfer-detail-radius').value; if (v !== '') d.borderRadius = String(v);
    var applyValue = '';
    if (window._transferModalFromLibrary) {
        var el = document.getElementById('transfer-apply-npc-id');
        applyValue = el ? el.value : '';
        if (!applyValue) { showTipModal('请先选择一项（如 我（默认）或 XX的界面的我/XX）。', '提示'); return; }
    } else {
        applyValue = 'user:' + (gameState.chatTargetId != null ? String(gameState.chatTargetId) : TRANSFER_APPLY_DEFAULT);
    }
    var parts = String(applyValue).split(':');
    var kind = parts[0];
    var id = parts[1];
    var isUserDefault = kind === 'user' && (id === TRANSFER_APPLY_DEFAULT || !id);
    var applyNpc = null;
    var libLabel = '';
    if (isUserDefault) {
        gameState.moneyTransferStyle = Object.keys(s).length ? s : null;
        gameState.moneyTransferDetailStyle = Object.keys(d).length ? d : null;
        libLabel = '我（默认）的转账样式';
    } else if (kind === 'user' && id) {
        applyNpc = gameState.npcs ? gameState.npcs.find(function(x) { return x.id == id || String(x.id) === id; }) : null;
        if (!applyNpc) { showTipModal('未找到该角色，请重新选择。', '提示'); return; }
        applyNpc.moneyTransferStyle = Object.keys(s).length ? s : null;
        applyNpc.moneyTransferDetailStyle = Object.keys(d).length ? d : null;
        libLabel = (applyNpc.name || id) + '的界面的我';
    } else if (kind === 'npc' && id) {
        applyNpc = gameState.npcs ? gameState.npcs.find(function(x) { return x.id == id || String(x.id) === id; }) : null;
        if (!applyNpc) { showTipModal('未找到该角色，请重新选择。', '提示'); return; }
        applyNpc.moneyTransferStyleNpc = Object.keys(s).length ? s : null;
        applyNpc.moneyTransferDetailStyleNpc = Object.keys(d).length ? d : null;
        libLabel = (applyNpc.name || id) + '的界面的' + (applyNpc.name || id);
    }
    if (Object.keys(s).length) {
        var lib = getTransferLibrary();
        lib.push({
            id: 't_' + Date.now(),
            applyValue: applyValue,
            npcId: isUserDefault ? TRANSFER_APPLY_DEFAULT : (applyNpc ? applyNpc.id : id),
            npcName: isUserDefault ? '我（默认）' : (applyNpc ? applyNpc.name : ''),
            name: libLabel,
            style: Object.assign({}, s),
            detailStyle: Object.keys(d).length ? Object.assign({}, d) : null,
            createdAt: Date.now()
        });
        saveTransferLibrary(lib);
    }
    try { localStorage.setItem('palace_transferStyle', JSON.stringify({ card: gameState.moneyTransferStyle, detail: gameState.moneyTransferDetailStyle })); } catch (e) {}
    closeTransferStyleModal();
    showTipModal('已保存「' + libLabel + '」并加入库。', '保存成功');
}
function loadTransferStyleFromStorage() {
    try {
        var raw = localStorage.getItem('palace_transferStyle');
        if (raw) {
            var p = JSON.parse(raw);
            if (p && (p.card || p.detail)) {
                if (p.card) gameState.moneyTransferStyle = p.card;
                if (p.detail) gameState.moneyTransferDetailStyle = p.detail;
            }
        }
    } catch (e) {}
}
var TRANSFER_LIBRARY_KEY = 'palace_transferLibrary';
function getTransferLibrary() { try { var raw = localStorage.getItem(TRANSFER_LIBRARY_KEY); return raw ? JSON.parse(raw) : []; } catch (e) { return []; } }
function saveTransferLibrary(arr) { localStorage.setItem(TRANSFER_LIBRARY_KEY, JSON.stringify(arr || [])); }
function openTransferLibraryModal() {
    document.getElementById('transfer-library-modal').style.display = 'flex';
    document.getElementById('transfer-library-modal').style.alignItems = 'center';
    document.getElementById('transfer-library-modal').style.justifyContent = 'center';
    renderTransferLibraryList();
}
function closeTransferLibraryModal() { document.getElementById('transfer-library-modal').style.display = 'none'; }
function renderTransferLibraryList() {
    var list = getTransferLibrary();
    var listEl = document.getElementById('transfer-library-list');
    var emptyEl = document.getElementById('transfer-library-empty');
    if (!listEl || !emptyEl) return;
    if (list.length === 0) { listEl.innerHTML = ''; emptyEl.style.display = 'block'; updateTransferLibraryDeleteButtonVisibility(); return; }
    emptyEl.style.display = 'none';
    listEl.innerHTML = list.map(function(item, index) {
        var st = item.style || {};
        var previewStr = '';
        if (st.background) previewStr += 'background:' + st.background + ';';
        if (st.backgroundImage) previewStr += 'background-image:url(' + st.backgroundImage + ');background-size:cover;background-position:center;';
        if (st.color) previewStr += 'color:' + st.color + ';';
        if (st.borderRadius !== undefined) previewStr += 'border-radius:' + (typeof st.borderRadius === 'number' ? st.borderRadius + 'px' : st.borderRadius) + ';';
        if (st.padding !== undefined) previewStr += 'padding:' + (typeof st.padding === 'number' ? st.padding + 'px' : st.padding) + ';';
        if (st.border) previewStr += 'border:' + st.border + ';';
        var label = item.name || (item.npcName ? item.npcName + ' 的转账样式' : '样式 ' + (index + 1));
        return '<div class="transfer-library-item" data-idx="' + index + '" style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(0,0,0,0.04);border-radius:10px;margin-bottom:8px;">' +
            '<input type="checkbox" class="transfer-library-cb" data-idx="' + index + '" style="flex-shrink:0;" onchange="updateTransferLibraryDeleteButtonVisibility()">' +
            '<div class="transfer-library-preview" style="width:48px;height:32px;border-radius:8px;flex-shrink:0;' + previewStr + '"></div>' +
            '<span style="flex:1;font-size:14px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (String(label).replace(/</g, '&lt;')) + '</span>' +
            '<button type="button" class="help-btn" onclick="transferLibraryApply(' + index + ')" title="应用" style="padding:6px;color:var(--accent);"><span class="material-icons" style="font-size:18px;">edit</span></button>' +
            '<button type="button" class="help-btn" onclick="transferLibraryDelete(' + index + ')" title="删除" style="padding:6px;color:var(--danger);"><span class="material-icons" style="font-size:18px;">delete</span></button>' +
            '</div>';
    }).join('');
    updateTransferLibraryDeleteButtonVisibility();
}
function transferLibraryApply(idx) {
    window._transferModalFromLibrary = true;
    var list = getTransferLibrary();
    var item = list[idx];
    if (!item) return;
    var st = item.style || {};
    var dt = item.detailStyle || {};
    document.getElementById('transfer-style-bg').value = st.background || '';
    document.getElementById('transfer-style-bg-image').value = st.backgroundImage || '';
    document.getElementById('transfer-style-color').value = st.color || '';
    document.getElementById('transfer-style-radius').value = st.borderRadius != null ? st.borderRadius : '';
    document.getElementById('transfer-style-padding').value = st.padding != null ? st.padding : '';
    document.getElementById('transfer-style-border').value = st.border || '';
    document.getElementById('transfer-style-icon-box-bg').value = st.iconBoxBg || '';
    document.getElementById('transfer-style-amount-color').value = st.amountColor || '';
    document.getElementById('transfer-style-icon').value = st.icon || '';
    document.getElementById('transfer-detail-bg').value = dt.background || '';
    document.getElementById('transfer-detail-color').value = dt.color || '';
    document.getElementById('transfer-detail-radius').value = dt.borderRadius != null ? dt.borderRadius : '';
    closeTransferLibraryModal();
    var preSelect = item.applyValue || (item.npcId != null && item.npcId !== TRANSFER_APPLY_DEFAULT ? ('user:' + item.npcId) : ('user:' + TRANSFER_APPLY_DEFAULT));
    openTransferStyleModal(true, preSelect);
}
function transferLibraryDelete(idx) {
    var list = getTransferLibrary();
    list.splice(idx, 1);
    saveTransferLibrary(list);
    renderTransferLibraryList();
    showTipModal('已从转账样式库移除。', '已删除');
}
function updateTransferLibraryDeleteButtonVisibility() {
    var btn = document.getElementById('transfer-library-delete-selected-btn');
    if (btn) { var n = document.querySelectorAll('.transfer-library-cb:checked').length; btn.style.display = n > 0 ? '' : 'none'; }
    var unselectBtn = document.getElementById('transfer-library-unselect-all-btn');
    if (unselectBtn) { var all = document.querySelectorAll('.transfer-library-cb'); var checked = document.querySelectorAll('.transfer-library-cb:checked'); unselectBtn.style.display = (all.length > 0 && checked.length === all.length) ? '' : 'none'; }
}
function transferLibrarySelectAll() { document.querySelectorAll('.transfer-library-cb').forEach(function(cb) { cb.checked = true; }); updateTransferLibraryDeleteButtonVisibility(); }
function transferLibraryUnselectAll() { document.querySelectorAll('.transfer-library-cb').forEach(function(cb) { cb.checked = false; }); updateTransferLibraryDeleteButtonVisibility(); }
function transferLibraryDeleteSelected() {
    var cbs = document.querySelectorAll('.transfer-library-cb:checked');
    if (!cbs.length) { showTipModal('请先勾选要删除的样式。', '提示'); return; }
    var indices = Array.prototype.map.call(cbs, function(cb) { return parseInt(cb.getAttribute('data-idx'), 10); });
    indices.sort(function(a, b) { return b - a; });
    var list = getTransferLibrary();
    indices.forEach(function(i) { list.splice(i, 1); });
    saveTransferLibrary(list);
    renderTransferLibraryList();
    updateTransferLibraryDeleteButtonVisibility();
    showTipModal('已删除 ' + indices.length + ' 条样式。', '已删除');
}
function transferLibraryExportSelected() {
    var list = getTransferLibrary();
    var cbs = document.querySelectorAll('.transfer-library-cb:checked');
    var indices = Array.prototype.map.call(cbs, function(cb) { return parseInt(cb.getAttribute('data-idx'), 10); });
    var toExport = indices.length ? indices.map(function(i) { return list[i]; }).filter(Boolean) : list;
    if (toExport.length === 0) { showTipModal('请先勾选要导出的样式，或不勾选则导出全部。', '提示'); return; }
    var blob = new Blob([JSON.stringify(toExport, null, 2)], { type: 'application/json' });
    var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'transfer_library_' + (new Date().toISOString().slice(0,10)) + '.json'; a.click(); URL.revokeObjectURL(a.href);
    showTipModal('已导出 ' + toExport.length + ' 条样式。', '导出成功');
}
function transferLibraryImportFile(ev) {
    var f = ev.target.files[0];
    if (!f) return;
    var r = new FileReader();
    r.onload = function() {
        try {
            var data = JSON.parse(r.result);
            var arr = Array.isArray(data) ? data : [data];
            var list = getTransferLibrary();
            arr.forEach(function(item) { if (item && item.style) list.push(item); });
            saveTransferLibrary(list);
            renderTransferLibraryList();
            showTipModal('已导入 ' + arr.length + ' 条样式。', '导入成功');
        } catch (e) { showTipModal('文件格式无效，请选择导出的 JSON 文件。', '导入失败'); }
        ev.target.value = '';
    };
    r.readAsText(f);
}
function requestTransferStyleFromAI() {
    var descEl = document.getElementById('transfer-ai-desc');
    var desc = (descEl && descEl.value || '').trim();
    if (!desc) { showTipModal('请先填写"描述效果"。', '提示'); return; }
    var savedSettings = localStorage.getItem('palace_settings');
    if (!savedSettings) { showTipModal('请先在设置中配置 API。', '提示'); return; }
    var settings = JSON.parse(savedSettings);
    if (!settings.apiKey || !settings.apiUrl) { showTipModal('请先在设置中配置 API Key 和 API 地址。', '提示'); return; }
    var btn = document.getElementById('transfer-ai-btn');
    if (btn) btn.disabled = true;
    var prompt = '你是一个转账卡片样式设计师。用户希望转账卡片效果为：' + desc + '\n\n请仅输出一个 JSON 对象，不要其他文字。需包含：\n1) 卡片样式：background、color、borderRadius、padding、border、backgroundImage（可选）、iconBoxBg（图标框背景，可选）、amountColor（金额颜色，可选）、icon（可选，Material Icons 名如 payments 或 currency_exchange 或图片 URL）\n2) 点击后详情弹窗：detailBackground、detailColor、detailBorderRadius\n格式示例：\n{"background":"如 linear-gradient(135deg,#757ED3,#8E96D9)","color":"#fff","borderRadius":"12","padding":"15","border":"1px solid rgba(255,255,255,0.2)","backgroundImage":"可选","iconBoxBg":"如 linear-gradient(135deg,#FFD700,#FFA500)","amountColor":"如 #FFD700 或 inherit","icon":"payments 或 currency_exchange","detailBackground":"如 #fff","detailColor":"如 #333","detailBorderRadius":"12"}\n注意：icon 为转账卡片内的图标；iconBoxBg 为图标所在小方框背景；amountColor 为金额文字颜色；detail* 为点击后的详情弹窗样式。';
    fetch(settings.apiUrl + '/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settings.apiKey },
        body: JSON.stringify({ model: settings.model || 'gpt-3.5-turbo', messages: [{ role: 'user', content: prompt }], temperature: 0.5, max_tokens: 400 })
    }).then(function(response) { if (!response.ok) throw new Error('API 请求失败'); return response.json(); }).then(function(data) {
        var text = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? (data.choices[0].message.content || '').trim() : '';
        var jsonMatch = text.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('未解析到有效样式');
        var obj = JSON.parse(jsonMatch[0]);
        var set = function(id, val) { var el = document.getElementById(id); if (el && val !== undefined && val !== null && val !== '') el.value = String(val).trim(); };
        if (obj.background !== undefined) set('transfer-style-bg', obj.background);
        if (obj.color !== undefined) set('transfer-style-color', obj.color);
        if (obj.borderRadius !== undefined) set('transfer-style-radius', obj.borderRadius);
        if (obj.padding !== undefined) set('transfer-style-padding', obj.padding);
        if (obj.border !== undefined) set('transfer-style-border', obj.border);
        if (obj.backgroundImage !== undefined) set('transfer-style-bg-image', obj.backgroundImage);
        if (obj.iconBoxBg !== undefined) set('transfer-style-icon-box-bg', obj.iconBoxBg);
        if (obj.amountColor !== undefined) set('transfer-style-amount-color', obj.amountColor);
        if (obj.icon !== undefined) set('transfer-style-icon', obj.icon);
        if (obj.detailBackground !== undefined) set('transfer-detail-bg', obj.detailBackground);
        if (obj.detailColor !== undefined) set('transfer-detail-color', obj.detailColor);
        if (obj.detailBorderRadius !== undefined) set('transfer-detail-radius', obj.detailBorderRadius);
        refreshTransferPreview();
        showTipModal('已根据描述生成样式并填入上方输入框，可微调后点击"保存"。', '生成成功');
    }).catch(function(err) { showTipModal(err && err.message ? err.message : '生成失败，请检查 API 配置或稍后重试。', '提示'); }).finally(function() { if (btn) btn.disabled = false; });
}

function refreshGiftPreview() {
    var get = function(id) { var el = document.getElementById(id); return el ? (el.value || '').trim() : ''; };
    var num = function(id) { var v = get(id); return v === '' ? undefined : v; };
    var el = document.getElementById('gift-preview');
    if (!el) return;
    var cardStyle = '';
    var bg = get('gift-style-bg'); if (bg) cardStyle += 'background:' + bg + ';';
    var c = get('gift-style-color'); if (c) cardStyle += 'color:' + c + ';';
    var r = num('gift-style-radius'); if (r !== undefined) cardStyle += 'border-radius:' + (typeof r === 'number' ? r + 'px' : r) + ';';
    var p = num('gift-style-padding'); if (p !== undefined) cardStyle += 'padding:' + (typeof p === 'number' ? p + 'px' : p) + ';';
    var b = get('gift-style-border'); if (b) cardStyle += 'border:' + b + ';';
    el.style.cssText = '';
    el.innerHTML = '<div class="msg-gift-card" style="width:200px;' + cardStyle + '"><div class="gift-card-header"><div class="gift-card-icon">礼</div><div class="gift-card-label">宫廷特惠</div></div><div class="gift-card-body"><div class="gift-card-img">🎁</div><div class="gift-card-content"><div class="gift-card-title">示例礼物</div><div class="gift-card-price">¥99</div></div></div></div>';
}
var GIFT_APPLY_DEFAULT = '__gift_default__';
function fillGiftApplyNpcSelect(preSelectValue) {
    var sel = document.getElementById('gift-apply-npc-id');
    if (!sel) return;
    sel.innerHTML = '';
    var npcs = gameState.npcs || [];
    var opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = '请选择…';
    sel.appendChild(opt0);
    var optMe = document.createElement('option');
    optMe.value = 'user:' + GIFT_APPLY_DEFAULT;
    optMe.textContent = '我（默认）';
    sel.appendChild(optMe);
    npcs.forEach(function(n) {
        var name = n.name || ('角色 ' + n.id);
        var idStr = String(n.id);
        var optUser = document.createElement('option');
        optUser.value = 'user:' + idStr;
        optUser.textContent = name + '的界面的我';
        sel.appendChild(optUser);
        var optNpc = document.createElement('option');
        optNpc.value = 'npc:' + idStr;
        optNpc.textContent = name + '的界面的' + name;
        sel.appendChild(optNpc);
    });
    if (preSelectValue && typeof preSelectValue === 'string') {
        var exists = false;
        for (var i = 0; i < sel.options.length; i++) { if (sel.options[i].value === preSelectValue) { exists = true; break; } }
        if (exists) sel.value = preSelectValue;
        else sel.value = '';
    } else {
        sel.value = '';
    }
}
function openGiftStyleModal(fromLibrary, preSelectNpcId) {
    document.getElementById('chat-plus-menu').classList.remove('show');
    window._giftModalFromLibrary = !!fromLibrary;
    var row = document.getElementById('gift-apply-npc-row');
    if (row) row.style.display = fromLibrary ? 'block' : 'none';
    if (!fromLibrary) {
        var npc = gameState.chatTargetId ? gameState.npcs.find(function(n) { return n.id == gameState.chatTargetId || String(n.id) === String(gameState.chatTargetId); }) : null;
        var s = (npc && npc.giftCardStyle) ? npc.giftCardStyle : (gameState.giftCardStyle || {});
        document.getElementById('gift-style-bg').value = s.background || '';
        document.getElementById('gift-style-color').value = s.color || '';
        document.getElementById('gift-style-radius').value = s.borderRadius != null ? s.borderRadius : '';
        document.getElementById('gift-style-padding').value = s.padding != null ? s.padding : '';
        document.getElementById('gift-style-border').value = s.border || '';
    }
    if (fromLibrary) fillGiftApplyNpcSelect(preSelectNpcId != null && preSelectNpcId !== '' ? preSelectNpcId : '');
    document.getElementById('gift-style-modal').style.display = 'flex';
    document.getElementById('gift-style-modal').style.alignItems = 'center';
    document.getElementById('gift-style-modal').style.justifyContent = 'center';
    refreshGiftPreview();
}
function closeGiftStyleModal() { document.getElementById('gift-style-modal').style.display = 'none'; }
var GIFT_LIBRARY_KEY = 'palace_giftLibrary';
function getGiftLibrary() { try { var raw = localStorage.getItem(GIFT_LIBRARY_KEY); return raw ? JSON.parse(raw) : []; } catch (e) { return []; } }
function saveGiftLibrary(arr) { localStorage.setItem(GIFT_LIBRARY_KEY, JSON.stringify(arr || [])); }
function openGiftLibraryModal() {
    document.getElementById('gift-library-modal').style.display = 'flex';
    document.getElementById('gift-library-modal').style.alignItems = 'center';
    document.getElementById('gift-library-modal').style.justifyContent = 'center';
    renderGiftLibraryList();
}
function closeGiftLibraryModal() { document.getElementById('gift-library-modal').style.display = 'none'; }
function renderGiftLibraryList() {
    var list = getGiftLibrary();
    var listEl = document.getElementById('gift-library-list');
    var emptyEl = document.getElementById('gift-library-empty');
    if (!listEl || !emptyEl) return;
    if (list.length === 0) { listEl.innerHTML = ''; emptyEl.style.display = 'block'; updateGiftLibraryDeleteButtonVisibility(); return; }
    emptyEl.style.display = 'none';
    listEl.innerHTML = list.map(function(item, index) {
        var st = item.style || {};
        var previewStr = '';
        if (st.background) previewStr += 'background:' + st.background + ';';
        if (st.color) previewStr += 'color:' + st.color + ';';
        if (st.borderRadius !== undefined) previewStr += 'border-radius:' + (typeof st.borderRadius === 'number' ? st.borderRadius + 'px' : st.borderRadius) + ';';
        if (st.padding !== undefined) previewStr += 'padding:' + (typeof st.padding === 'number' ? st.padding + 'px' : st.padding) + ';';
        if (st.border) previewStr += 'border:' + st.border + ';';
        var label = item.name || (item.npcName ? item.npcName + ' 的礼物样式' : '样式 ' + (index + 1));
        return '<div class="gift-library-item" data-idx="' + index + '" style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(0,0,0,0.04);border-radius:10px;margin-bottom:8px;">' +
            '<input type="checkbox" class="gift-library-cb" data-idx="' + index + '" style="flex-shrink:0;" onchange="updateGiftLibraryDeleteButtonVisibility()">' +
            '<div class="gift-library-preview" style="width:48px;height:32px;border-radius:8px;flex-shrink:0;' + previewStr + '"></div>' +
            '<span style="flex:1;font-size:14px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (String(label).replace(/</g, '&lt;')) + '</span>' +
            '<button type="button" class="help-btn" onclick="giftLibraryApply(' + index + ')" title="应用" style="padding:6px;color:var(--accent);"><span class="material-icons" style="font-size:18px;">edit</span></button>' +
            '<button type="button" class="help-btn" onclick="giftLibraryDelete(' + index + ')" title="删除" style="padding:6px;color:var(--danger);"><span class="material-icons" style="font-size:18px;">delete</span></button>' +
            '</div>';
    }).join('');
    updateGiftLibraryDeleteButtonVisibility();
}
function giftLibraryApply(idx) {
    window._giftModalFromLibrary = true;
    var list = getGiftLibrary();
    var item = list[idx];
    if (!item) return;
    var st = item.style || {};
    document.getElementById('gift-style-bg').value = st.background || '';
    document.getElementById('gift-style-color').value = st.color || '';
    document.getElementById('gift-style-radius').value = st.borderRadius != null ? st.borderRadius : '';
    document.getElementById('gift-style-padding').value = st.padding != null ? st.padding : '';
    document.getElementById('gift-style-border').value = st.border || '';
    closeGiftLibraryModal();
    var preSelect = item.applyValue || (item.npcId != null && item.npcId !== GIFT_APPLY_DEFAULT ? ('user:' + item.npcId) : ('user:' + GIFT_APPLY_DEFAULT));
    openGiftStyleModal(true, preSelect);
}
function giftLibraryDelete(idx) {
    var list = getGiftLibrary();
    list.splice(idx, 1);
    saveGiftLibrary(list);
    renderGiftLibraryList();
    showTipModal('已从礼物样式库移除。', '已删除');
}
function updateGiftLibraryDeleteButtonVisibility() {
    var btn = document.getElementById('gift-library-delete-selected-btn');
    if (btn) { var n = document.querySelectorAll('.gift-library-cb:checked').length; btn.style.display = n > 0 ? '' : 'none'; }
    var unselectBtn = document.getElementById('gift-library-unselect-all-btn');
    if (unselectBtn) { var all = document.querySelectorAll('.gift-library-cb'); var checked = document.querySelectorAll('.gift-library-cb:checked'); unselectBtn.style.display = (all.length > 0 && checked.length === all.length) ? '' : 'none'; }
}
function giftLibrarySelectAll() { document.querySelectorAll('.gift-library-cb').forEach(function(cb) { cb.checked = true; }); updateGiftLibraryDeleteButtonVisibility(); }
function giftLibraryUnselectAll() { document.querySelectorAll('.gift-library-cb').forEach(function(cb) { cb.checked = false; }); updateGiftLibraryDeleteButtonVisibility(); }
function giftLibraryDeleteSelected() {
    var cbs = document.querySelectorAll('.gift-library-cb:checked');
    if (!cbs.length) { showTipModal('请先勾选要删除的样式。', '提示'); return; }
    var indices = Array.prototype.map.call(cbs, function(cb) { return parseInt(cb.getAttribute('data-idx'), 10); });
    indices.sort(function(a, b) { return b - a; });
    var list = getGiftLibrary();
    indices.forEach(function(i) { list.splice(i, 1); });
    saveGiftLibrary(list);
    renderGiftLibraryList();
    updateGiftLibraryDeleteButtonVisibility();
    showTipModal('已删除 ' + indices.length + ' 条样式。', '已删除');
}
function giftLibraryExportSelected() {
    var list = getGiftLibrary();
    var cbs = document.querySelectorAll('.gift-library-cb:checked');
    var indices = Array.prototype.map.call(cbs, function(cb) { return parseInt(cb.getAttribute('data-idx'), 10); });
    var toExport = indices.length ? indices.map(function(i) { return list[i]; }).filter(Boolean) : list;
    if (toExport.length === 0) { showTipModal('请先勾选要导出的样式，或不勾选则导出全部。', '提示'); return; }
    var blob = new Blob([JSON.stringify(toExport, null, 2)], { type: 'application/json' });
    var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gift_library_' + (new Date().toISOString().slice(0,10)) + '.json'; a.click(); URL.revokeObjectURL(a.href);
    showTipModal('已导出 ' + toExport.length + ' 条样式。', '导出成功');
}
function giftLibraryImportFile(ev) {
    var f = ev.target.files[0];
    if (!f) return;
    var r = new FileReader();
    r.onload = function() {
        try {
            var data = JSON.parse(r.result);
            var arr = Array.isArray(data) ? data : [data];
            var list = getGiftLibrary();
            arr.forEach(function(item) { if (item && item.style) list.push(item); });
            saveGiftLibrary(list);
            renderGiftLibraryList();
            showTipModal('已导入 ' + arr.length + ' 条样式。', '导入成功');
        } catch (e) { showTipModal('文件格式无效，请选择导出的 JSON 文件。', '导入失败'); }
        ev.target.value = '';
    };
    r.readAsText(f);
}
function requestGiftStyleFromAI() {
    var descEl = document.getElementById('gift-ai-desc');
    var desc = (descEl && descEl.value || '').trim();
    if (!desc) { showTipModal('请先填写"描述效果"。', '提示'); return; }
    var savedSettings = localStorage.getItem('palace_settings');
    if (!savedSettings) { showTipModal('请先在设置中配置 API。', '提示'); return; }
    var settings = JSON.parse(savedSettings);
    if (!settings.apiKey || !settings.apiUrl) { showTipModal('请先在设置中配置 API Key 和 API 地址。', '提示'); return; }
    var btn = document.getElementById('gift-ai-btn');
    if (btn) btn.disabled = true;
    var prompt = '你是一个礼物卡片样式设计师。用户希望礼物卡片效果为：' + desc + '\n\n请仅输出一个 JSON 对象，不要其他文字。需包含：background、color、borderRadius、padding、border。格式示例：\n{"background":"如 linear-gradient(135deg,#8E96D9,#757ED3) 或 var(--primary)","color":"#fff","borderRadius":"12","padding":"10","border":"1px solid rgba(255,255,255,0.1)"}';
    fetch(settings.apiUrl + '/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settings.apiKey },
        body: JSON.stringify({ model: settings.model || 'gpt-3.5-turbo', messages: [{ role: 'user', content: prompt }], temperature: 0.5, max_tokens: 400 })
    }).then(function(response) { if (!response.ok) throw new Error('API 请求失败'); return response.json(); }).then(function(data) {
        var text = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? (data.choices[0].message.content || '').trim() : '';
        var jsonMatch = text.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('未解析到有效样式');
        var obj = JSON.parse(jsonMatch[0]);
        var set = function(id, val) { var el = document.getElementById(id); if (el && val !== undefined && val !== null && val !== '') el.value = String(val).trim(); };
        if (obj.background !== undefined) set('gift-style-bg', obj.background);
        if (obj.color !== undefined) set('gift-style-color', obj.color);
        if (obj.borderRadius !== undefined) set('gift-style-radius', obj.borderRadius);
        if (obj.padding !== undefined) set('gift-style-padding', obj.padding);
        if (obj.border !== undefined) set('gift-style-border', obj.border);
        refreshGiftPreview();
        showTipModal('已根据描述生成样式并填入上方输入框，可微调后点击"保存"。', '生成成功');
    }).catch(function(err) { showTipModal(err && err.message ? err.message : '生成失败，请检查 API 配置或稍后重试。', '提示'); }).finally(function() { if (btn) btn.disabled = false; });
}
function saveGiftStyle() {
    var s = {};
    var v = document.getElementById('gift-style-bg').value.trim(); if (v) s.background = v;
    v = document.getElementById('gift-style-color').value.trim(); if (v) s.color = v;
    v = document.getElementById('gift-style-radius').value; if (v !== '') s.borderRadius = String(v);
    v = document.getElementById('gift-style-padding').value; if (v !== '') s.padding = String(v);
    v = document.getElementById('gift-style-border').value.trim(); if (v) s.border = v;
    var applyValue = '';
    if (window._giftModalFromLibrary) {
        var el = document.getElementById('gift-apply-npc-id');
        applyValue = el ? el.value : '';
        if (!applyValue) { showTipModal('请先选择要应用给哪个角色（或选「我（默认）」）。', '提示'); return; }
    } else {
        applyValue = 'user:' + (gameState.chatTargetId != null ? String(gameState.chatTargetId) : GIFT_APPLY_DEFAULT);
    }
    var parts = String(applyValue).split(':');
    var kind = parts[0];
    var id = parts[1];
    var isUserDefault = kind === 'user' && (id === GIFT_APPLY_DEFAULT || !id);
    var applyNpc = null;
    var libLabel = '';
    if (!isUserDefault && id) {
        applyNpc = gameState.npcs ? gameState.npcs.find(function(x) { return x.id == id || String(x.id) === id; }) : null;
        if (!applyNpc) { showTipModal('未找到该角色，请重新选择。', '提示'); return; }
        libLabel = (kind === 'user' ? (applyNpc.name || '') + '的界面的我' : (applyNpc.name || '') + '的界面的' + (applyNpc.name || ''));
    } else {
        libLabel = '我（默认）';
    }
    if (isUserDefault) {
        gameState.giftCardStyle = Object.keys(s).length ? s : null;
    } else if (applyNpc) {
        if (kind === 'user') applyNpc.giftCardStyle = Object.keys(s).length ? s : null;
        else applyNpc.giftCardStyleNpc = Object.keys(s).length ? s : null;
    }
    if (Object.keys(s).length) {
        var lib = getGiftLibrary();
        lib.push({
            id: 'g_' + Date.now(),
            npcId: isUserDefault ? GIFT_APPLY_DEFAULT : (applyNpc ? applyNpc.id : id),
            npcName: isUserDefault ? '我（默认）' : (applyNpc ? applyNpc.name : ''),
            name: libLabel,
            applyValue: applyValue,
            style: Object.assign({}, s),
            createdAt: Date.now()
        });
        saveGiftLibrary(lib);
    }
    try { localStorage.setItem('palace_giftStyle', JSON.stringify(gameState.giftCardStyle)); } catch (e) {}
    closeGiftStyleModal();
    showTipModal(isUserDefault ? '礼物样式已保存为默认，已加入库。' : '礼物样式已保存（' + libLabel + '），已加入库。', '保存成功');
}
function loadGiftStyleFromStorage() {
    try {
        var raw = localStorage.getItem('palace_giftStyle');
        if (raw) {
            var p = JSON.parse(raw);
            if (p && typeof p === 'object') gameState.giftCardStyle = p;
        }
    } catch (e) {}
}

function applyBubbleStyleToElement(el, styleObj) {
    if (!el || !styleObj) return;
    if (styleObj.backgroundImage) {
        el.style.backgroundImage = 'url(' + styleObj.backgroundImage + ')';
        el.style.backgroundSize = 'cover';
        el.style.backgroundPosition = 'center';
        if (styleObj.background) el.style.backgroundColor = styleObj.background;
    } else if (styleObj.background) el.style.background = styleObj.background;
    if (styleObj.color) el.style.color = styleObj.color;
    if (styleObj.borderRadius !== undefined) el.style.borderRadius = (typeof styleObj.borderRadius === 'number' ? styleObj.borderRadius + 'px' : String(styleObj.borderRadius));
    if (styleObj.padding !== undefined) el.style.padding = (typeof styleObj.padding === 'number' ? styleObj.padding + 'px' : String(styleObj.padding));
    if (styleObj.border) el.style.border = styleObj.border;
}

function requestBubbleStyleFromAI(target) {
    var descEl = document.getElementById('bubble-ai-desc');
    var desc = (descEl && descEl.value || '').trim();
    if (!desc) {
        showTipModal('请先填写“描述效果”，例如：淡粉色渐变、古风花纹、简约白底黑字。', '提示');
        return;
    }
    var savedSettings = localStorage.getItem('palace_settings');
    if (!savedSettings) {
        showTipModal('请先在设置中配置 API。', '提示');
        return;
    }
    var settings = JSON.parse(savedSettings);
    if (!settings.apiKey || !settings.apiUrl) {
        showTipModal('请先在设置中配置 API Key 和 API 地址。', '提示');
        return;
    }
    var btnUser = document.getElementById('bubble-ai-btn-user');
    if (btnUser) btnUser.disabled = true;
    var prompt = '你是一个聊天气泡样式设计师。用户希望气泡效果为：' + desc + '\n\n请仅输出一个 JSON 对象，不要其他文字。格式如下：\n{"background":"背景色，如 #f0e6e6 或 linear-gradient(...)","color":"文字颜色，如 #333","borderRadius":"圆角，如 12px 或 16","padding":"内边距，如 10px 12px","border":"边框，如 1px solid rgba(0,0,0,0.08)","backgroundImage":"可选，背景图完整 URL，没有则省略此键"}\n注意：若不需要背景图就不要输出 backgroundImage；颜色、圆角、内边距、边框请给出合理值。';
    fetch(settings.apiUrl + '/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settings.apiKey },
        body: JSON.stringify({
            model: settings.model || 'gpt-3.5-turbo',
            messages: [{ role: 'user', content: prompt }],
            temperature: 0.5,
            max_tokens: 400
        })
    }).then(function(response) {
        if (!response.ok) throw new Error('API 请求失败');
        return response.json();
    }).then(function(data) {
        var text = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? (data.choices[0].message.content || '').trim() : '';
        var jsonMatch = text.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('未解析到有效样式');
        var obj = JSON.parse(jsonMatch[0]);
        var set = function(id, val) {
            var el = document.getElementById(id);
            if (el && val !== undefined && val !== null && val !== '') el.value = String(val).trim();
        };
        if (obj.background !== undefined) set('bubble-user-bg', obj.background);
        if (obj.color !== undefined) set('bubble-user-color', obj.color);
        if (obj.borderRadius !== undefined) set('bubble-user-radius', obj.borderRadius);
        if (obj.padding !== undefined) set('bubble-user-padding', obj.padding);
        if (obj.border !== undefined) set('bubble-user-border', obj.border);
        if (obj.backgroundImage !== undefined) set('bubble-user-bg-image', obj.backgroundImage);
        refreshBubblePreview();
        showTipModal('已根据描述生成样式并填入上方输入框，可微调后点击“保存”。', '生成成功');
    }).catch(function(err) {
        showTipModal(err && err.message ? err.message : '生成失败，请检查 API 配置或稍后重试。', '提示');
    }).finally(function() {
        if (btnUser) btnUser.disabled = false;
    });
}

function openEncounterMapHistoryModal() {
    const npc = gameState.chatTargetId ? gameState.npcs.find(function(n) { return n.id === gameState.chatTargetId; }) : null;
    if (!npc) {
        alert("请先选择对话对象。");
        return;
    }
    document.getElementById('chat-plus-menu').classList.remove('show');
    document.getElementById('encounter-history-title').innerHTML = '<span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">history_edu</span>遇地图历史 · ' + (npc.name || '');
    var list = document.getElementById('encounter-map-history-list');
    list.innerHTML = '';
    var records = (npc.npcMemory || []).filter(function(m) { return m && m.type === 'encounter'; });
    if (records.length === 0) {
        list.innerHTML = '<p style="margin:0;color:var(--text);font-size:14px;text-align:center;padding:24px 0;">暂无该角色的遇地图剧情记录。</p>';
    } else {
        records.forEach(function(r, idx) {
            var card = document.createElement('div');
            card.style.cssText = 'margin-bottom:16px;padding:14px;background:rgba(0,0,0,0.04);border-radius:12px;border-left:4px solid var(--primary);';
            var loc = (r.location || '').toString();
            var date = (r.date || '').toString();
            var story = (r.story || '').toString();
            card.innerHTML = '<div style="font-size:12px;color:var(--accent);margin-bottom:8px;">' + loc + ' · ' + date + '</div><div style="font-size:14px;color:var(--text);line-height:1.6;white-space:pre-wrap;word-break:break-word;">' + story.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
            list.appendChild(card);
        });
    }
    document.getElementById('encounter-map-history-modal').style.display = 'flex';
    document.getElementById('encounter-map-history-modal').style.alignItems = 'center';
    document.getElementById('encounter-map-history-modal').style.justifyContent = 'center';
}

function closeEncounterMapHistoryModal() {
    document.getElementById('encounter-map-history-modal').style.display = 'none';
}

function sexTopicAgree() {
    const npc = sexTopicNpcId ? gameState.npcs.find(n => n.id === sexTopicNpcId) : null;
    closeSexTopicConfirmModal();
    const inputEl = document.getElementById('chat-input');
    if (inputEl) inputEl.value = '';
    if (!npc) return;
    alert("一夜缠绵，事毕。");
    var underContraceptive = gameState.player.contraceptiveUntil && Date.now() < gameState.player.contraceptiveUntil;
    if (!underContraceptive && Math.random() < 0.3) {
        gameState.player.pregnancy.isPregnant = true;
        gameState.player.pregnancy.month = 0;
        gameState.player.pregnancy.pregnancyStartTime = Date.now();
        gameState.player.pregnancy.fatherNpcId = npc.id;
        alert("事后你发觉可能有孕在身……");
    }
    npc.affection = Math.min(100, (npc.affection || 0) + 5);
}

function sexTopicRefuse() {
    const npc = sexTopicNpcId ? gameState.npcs.find(n => n.id === sexTopicNpcId) : null;
    closeSexTopicConfirmModal();
    if (!npc) return;
    if (Math.random() < 0.5) {
        npc.affection = Math.max(0, (npc.affection || 0) - 10);
        alert("对方心中不悦，好感降低。");
    } else {
        alert("对方未再强求。");
    }
}

// 怀孕事件系统
function checkPregnancyEvents() {
    if (!gameState.player.pregnancy.isPregnant) return;
    
    const p = gameState.player;
    const month = p.pregnancy.month;
    // 怀孕期间有概率流产（1～8月内随机触发）
    if (month >= 1 && month < 9 && Math.random() < 0.04) {
        p.pregnancy.isPregnant = false;
        p.pregnancy.month = 0;
        p.pregnancy.pregnancyStartTime = 0;
        const fatherId = p.pregnancy.fatherNpcId;
        const isEmperorChild = fatherId === null || fatherId === undefined;
        alert("你不幸小产了……");
        if (isEmperorChild) {
            p.stats.money += 500;
            gameState.items = gameState.items || [];
            gameState.items.push({ id: "item_" + Date.now(), name: "御赐安神玉佩", quality: "高级", type: "饰品" });
            alert("陛下得知后遣人送来高级赏赐与五百两银子以作安慰。");
        }
        p.pregnancy.fatherNpcId = null;
        return;
    }
    const events = {
        1: "你开始感到身体不适，可能是怀孕的征兆...",
        3: "你的肚子开始显怀，需要更小心的行动",
        6: "你感受到胎动，心情复杂",
        9: "临盆在即，你需要好好休息"
    };
    if (events[month]) {
        alert(events[month]);
    }
}

// ========== 技能系统 ==========
const SKILL_TREE = {
    "侍寝技巧": { 
        name: "侍寝技巧", 
        desc: "提高侍寝成功率", 
        maxLevel: 10, 
        requirements: [],
        effects: { serveSuccess: 5 } // 每级+5%成功率
    },
    "社交技巧": { 
        name: "社交技巧", 
        desc: "提高社交影响力", 
        maxLevel: 10, 
        requirements: [],
        effects: { socialInfluence: 2 }
    },
    "才艺精通": { 
        name: "才艺精通", 
        desc: "提升音律、舞蹈、刺绣", 
        maxLevel: 10, 
        requirements: [],
        effects: { music: 2, dance: 2, embroidery: 2 }
    },
    "心计谋略": { 
        name: "心计谋略", 
        desc: "提升心计和智慧", 
        maxLevel: 10, 
        requirements: [],
        effects: { cunning: 2, wisdom: 2 }
    }
};

function renderSkills() {
    const container = document.getElementById('skills-container');
    container.innerHTML = "";
    
    Object.keys(SKILL_TREE).forEach(skillId => {
        const skillDef = SKILL_TREE[skillId];
        const skill = gameState.player.skills[skillId] || { level: 0, exp: 0, mastery: 0 };
        
        const card = document.createElement('div');
        card.className = "task-card";
        card.innerHTML = `
            <h4>${skillDef.name} Lv.${skill.level}/${skillDef.maxLevel}</h4>
            <p>${skillDef.desc}</p>
            <div style="font-size:12px;color:#757ED3;">经验: ${skill.exp}/${skill.level * 100}</div>
            <div style="font-size:12px;color:#757ED3;">熟练度: ${skill.mastery}</div>
            ${skill.level < skillDef.maxLevel ? `<button class="btn" style="width:auto;padding:5px 10px;font-size:12px;margin-top:5px;" onclick="learnSkill('${skillId}')">学习</button>` : '<div style="color:#8E96D9;">已满级</div>'}
        `;
        container.appendChild(card);
    });
}

function learnSkill(skillId) {
    const skillDef = SKILL_TREE[skillId];
    const skill = gameState.player.skills[skillId] || { level: 0, exp: 0, mastery: 0 };
    
    if (skill.level >= skillDef.maxLevel) {
        showTipModal("该技能已达到最高等级。", "已满级");
        return;
    }
    
    const cost = (skill.level + 1) * 50;
    if (gameState.player.stats.money < cost) {
        showTipModal(`学习需要消耗 ${cost} 银两，当前银两不足。`, "银两不足");
        return;
    }
    
    gameState.player.stats.money -= cost;
    skill.exp += 50;
    
    if (skill.exp >= skill.level * 100 + 100) {
        skill.level++;
        skill.exp = 0;
        showTipModal(`${skillDef.name} 已升级至 Lv.${skill.level}。`, "升级成功");
    } else {
        showTipModal(`已消耗 ${cost} 银两进行学习，经验 +50。`, "学习成功");
    }
    
    gameState.player.skills[skillId] = skill;
    renderSkills();
    updateDashboard();
}

// ========== 社交系统 ==========
// 社交等级阶级：按影响力区间划分
const SOCIAL_LEVEL_TIERS = [
    { name: "籍籍无名", minInfluence: 0 },
    { name: "小有名气", minInfluence: 50 },
    { name: "声名鹊起", minInfluence: 120 },
    { name: "名动一方", minInfluence: 250 },
    { name: "名满宫廷", minInfluence: 450 },
    { name: "名满天下", minInfluence: 700 }
];

function getSocialLevelTier(influence) {
    let tier = SOCIAL_LEVEL_TIERS[0];
    for (let i = SOCIAL_LEVEL_TIERS.length - 1; i >= 0; i--) {
        if (influence >= SOCIAL_LEVEL_TIERS[i].minInfluence) {
            tier = SOCIAL_LEVEL_TIERS[i];
            break;
        }
    }
    return tier;
}

function updateSocialLevelFromInfluence() {
    const inf = Math.max(0, gameState.player.socialInfluence || 0);
    const tier = getSocialLevelTier(inf);
    const tierIndex = SOCIAL_LEVEL_TIERS.findIndex(t => t.name === tier.name);
    gameState.player.socialLevel = tierIndex >= 0 ? tierIndex : 0;
}

function renderSocial() {
    updateSocialLevelFromInfluence();
    const inf = Math.max(0, gameState.player.socialInfluence || 0);
    const tier = getSocialLevelTier(inf);
    const levelEl = document.getElementById('social-level-display');
    const infEl = document.getElementById('social-influence-display');
    if (levelEl) levelEl.textContent = tier.name;
    if (infEl) infEl.textContent = inf;
}

function renderGroups() {
    const container = document.getElementById('groups-container');
    container.innerHTML = "";
    
    if (gameState.groups.length === 0) {
        container.innerHTML = "<p style='text-align:center;color:#8E96D9'>暂无群聊</p>";
        return;
    }
    
    gameState.groups.forEach(group => {
        const card = document.createElement('div');
        card.className = "npc-card";
        card.innerHTML = `
            <div class="npc-info">
                <h4>${group.name}</h4>
                <p>成员: ${group.members.length}人</p>
            </div>
            <button class="btn" style="width:auto;padding:5px 10px;font-size:12px;" onclick="enterGroup(${group.id})">进入</button>
        `;
        container.appendChild(card);
    });
}

let currentGroupId = null;

function showCreateGroupModal() {
    const modal = document.getElementById('create-group-modal');
    const membersList = document.getElementById('create-group-members-list');
    const nameInput = document.getElementById('create-group-name');
    
    // 清空并重置
    nameInput.value = '';
    membersList.innerHTML = '';
    
    // 生成成员列表
    gameState.npcs.forEach(npc => {
        const memberItem = document.createElement('div');
        memberItem.style.cssText = "display:flex;align-items:center;padding:10px;margin-bottom:8px;background:rgba(255,255,255,0.5);border-radius:8px;cursor:pointer;transition:all 0.2s;";
        memberItem.onmouseover = () => memberItem.style.background = "rgba(255,255,255,0.8)";
        memberItem.onmouseout = () => memberItem.style.background = "rgba(255,255,255,0.5)";
        memberItem.onclick = (e) => {
            if (e.target.type !== 'checkbox') {
                checkbox.checked = !checkbox.checked;
                updateSelectedCount();
            }
        };
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = npc.id;
        checkbox.id = `member-${npc.id}`;
        checkbox.style.cssText = "width:18px;height:18px;margin-right:12px;cursor:pointer;flex-shrink:0;";
        checkbox.addEventListener('change', updateSelectedCount);
        
        const label = document.createElement('label');
        label.htmlFor = `member-${npc.id}`;
        label.style.cssText = "flex:1;cursor:pointer;margin:0;display:flex;align-items:center;white-space:nowrap;overflow:hidden;";
        label.innerHTML = `<span style="font-weight:bold;color:var(--text);margin-right:8px;">${npc.name}</span><span style="color:#8E96D9;font-size:12px;">${npc.role}</span>`;
        
        // 点击整个item区域时切换checkbox状态
        memberItem.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox' && e.target.tagName !== 'LABEL') {
                checkbox.checked = !checkbox.checked;
                updateSelectedCount();
            }
        });
        
        memberItem.appendChild(checkbox);
        memberItem.appendChild(label);
        membersList.appendChild(memberItem);
    });
    
    updateSelectedCount();
    modal.style.display = 'flex';
}

function updateSelectedCount() {
    const checked = document.querySelectorAll('#create-group-members-list input[type="checkbox"]:checked');
    document.getElementById('create-group-selected-count').textContent = checked.length;
}

function closeCreateGroupModal() {
    document.getElementById('create-group-modal').style.display = 'none';
}

function confirmCreateGroup() {
    const nameInput = document.getElementById('create-group-name');
    const name = nameInput.value.trim();
    
    if (!name) {
        alert('请输入群聊名称');
        return;
    }
    
    const checked = document.querySelectorAll('#create-group-members-list input[type="checkbox"]:checked');
    const memberIds = Array.from(checked).map(cb => {
        // 确保ID类型正确（可能是字符串，需要转换为数字或保持字符串）
        const id = cb.value;
        // 检查是否是数字ID
        const numId = parseInt(id);
        return isNaN(numId) ? id : numId;
    });
    
    if (memberIds.length === 0) {
        alert('请至少选择一位成员');
        return;
    }
    
    // 构建成员名字列表
    const memberNames = [gameState.player.name];
    memberIds.forEach(id => {
        const npc = gameState.npcs.find(n => n.id == id); // 使用 == 允许类型转换
        if (npc) {
            memberNames.push(npc.name);
        }
    });
    
    const group = {
        id: Date.now(),
        name: name,
        members: memberNames,
        memberIds: [null, ...memberIds], // null表示玩家
        messages: [],
        owner: gameState.player.name,
        admins: [],
        enableGodView: false, // 默认关闭上帝视角
        godViewWordCount: 1000, // 上帝视角字数设置，默认1000字
        memberEmojiSettings: {}, // 成员表情包设置
        createdAt: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`
    };
    
    // 初始化成员表情包设置（默认全部允许）
    memberIds.forEach(id => {
        group.memberEmojiSettings[id] = true;
    });
    
    gameState.groups.push(group);
    renderGroups();
    closeCreateGroupModal();
}

function enterGroup(groupId) {
    const group = gameState.groups.find(g => g.id === groupId);
    if (!group) {
        currentGroupId = null;
        return;
    }
    
    currentGroupId = groupId;
    document.getElementById('group-chat-title').innerText = group.name;
    
    // 渲染聊天记录
    renderGroupChat();
    goToPage('page-group-chat');
}

function renderGroupChat() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    applyGroupChatBackground();
    const container = document.getElementById('group-chat-box');
    container.innerHTML = "";
    
    if (group.messages.length === 0) {
        container.innerHTML = "<p style='text-align:center;color:#8E96D9;padding:20px;'>暂无消息</p>";
        return;
    }
    
    group.messages.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.setAttribute('data-msg-id', String(msg.id));
        const isUser = msg.author === gameState.player.name;
        const isGodView = msg.isGodView || msg.author === '【上帝视角】';
        const isLoading = msg.content === '...';
        // 群聊消息不展示（）里的心里描述（展示时去掉）
        var displayContent = (msg.content || '').replace(/（[^）]*）/g, '').replace(/\([^)]*\)/g, '').replace(/\s{2,}/g, ' ').trim();
        if (displayContent === '' && msg.content) displayContent = msg.content;
        
        if (isGodView) {
            // 上帝视角消息样式
            msgDiv.style.cssText = `margin:10px 0;padding:8px;background:linear-gradient(135deg, rgba(117,126,211,0.15) 0%, rgba(142,150,217,0.15) 100%);border-left:3px solid var(--accent);border-radius:5px;color:var(--text);font-style:italic;opacity:0.8;`;
        } else {
            msgDiv.style.cssText = `margin:10px 0;padding:8px;background:${isUser ? 'var(--primary)' : '#E7E7ED'};border-radius:5px;color:${isUser ? 'white' : 'var(--text)'};`;
        }
        
        // 如果是加载消息，添加呼吸动画
        if (isLoading) {
            msgDiv.classList.add('breathing');
        }
        
        let contentHtml = '';
        // 引用块（QQ风）
        let quoteHtml = '';
        if (msg.quote && msg.quote.author && msg.quote.text) {
            const qa = String(msg.quote.author).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const qt = String(msg.quote.text).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const hasRef = msg.quote.ref && msg.quote.ref.type === 'group' && msg.quote.ref.id != null;
            const refAttrs = hasRef ? ` data-ref-type="group" data-ref-id="${String(msg.quote.ref.id).replace(/"/g, '&quot;')}"` : '';
            quoteHtml = `<div class="msg-quote" style="cursor:pointer;"${refAttrs}><div class="q-name">${qa}</div><div class="q-text">${qt}</div></div>`;
        }
        if (msg.gift) {
            // 礼物消息
            const imageHtml = msg.gift.image && (msg.gift.image.startsWith('data:') || msg.gift.image.startsWith('http'))
                ? `<img src="${msg.gift.image}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;" onerror="this.parentElement.innerHTML='<div style=\\'font-size:32px;\\'>🎁</div>'">`
                : `<div style="font-size:32px;">${msg.gift.image || '🎁'}</div>`;
            contentHtml = `
                <div style="background:linear-gradient(135deg, rgba(117,126,211,0.9) 0%, rgba(142,150,217,0.9) 100%);padding:12px;border-radius:8px;margin-top:5px;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        ${imageHtml}
                        <div>
                            <div style="font-weight:bold;font-size:14px;">${displayContent}</div>
                            <div style="font-size:12px;opacity:0.9;">${msg.gift.name}</div>
                        </div>
                    </div>
                </div>
            `;
        } else if (msg.money) {
            const moneyCardId = `group-money-card-${msg.id}`;
            var c = gameState.moneyTransferStyle;
            var cardStyle = 'margin-top:5px;cursor:pointer;';
            if (c && (c.background || c.backgroundImage || c.color || c.borderRadius !== undefined || c.padding !== undefined || c.border)) {
                if (c.backgroundImage) { cardStyle += 'background-image:url(' + c.backgroundImage + ') !important;background-size:cover !important;background-position:center !important;'; if (c.background) cardStyle += 'background-color:' + c.background + ' !important;'; }
                else if (c.background) cardStyle += 'background:' + c.background + ' !important;';
                else cardStyle += 'background:linear-gradient(135deg, rgba(117,126,211,0.9) 0%, rgba(142,150,217,0.9) 100%) !important;';
                cardStyle += 'color:' + (c.color || 'white') + ' !important;';
                cardStyle += 'border-radius:' + (c.borderRadius !== undefined ? (typeof c.borderRadius === 'number' ? c.borderRadius + 'px' : c.borderRadius) : '8px') + ' !important;';
                cardStyle += 'padding:' + (c.padding !== undefined ? (typeof c.padding === 'number' ? c.padding + 'px' : c.padding) : '12px') + ' !important;';
                if (c.border) cardStyle += 'border:' + c.border + ' !important;';
            } else {
                cardStyle += 'background:linear-gradient(135deg, rgba(117,126,211,0.9) 0%, rgba(142,150,217,0.9) 100%);padding:12px;border-radius:8px;color:white;';
            }
            var iconVal = (c && c.icon) ? String(c.icon).trim() : '';
            var iconBoxBg = (c && c.iconBoxBg) ? c.iconBoxBg : 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
            var amountColor = (c && c.amountColor) ? c.amountColor : '#FFD700';
            var iconHtml = '';
            if (iconVal && (iconVal.startsWith('http') || iconVal.startsWith('data:'))) {
                iconHtml = '<img src="' + iconVal.replace(/"/g, '&quot;') + '" style="width:32px;height:32px;object-fit:contain;" onerror="this.style.display=\'none\';var x=document.createElement(\'span\');x.className=\'material-icons\';x.style.cssText=\'font-size:32px;color:white\';x.textContent=\'payments\';this.parentNode.appendChild(x)">';
            } else {
                var iconName = iconVal || 'payments';
                iconHtml = '<span class="material-icons" style="font-size:32px;color:white;">' + iconName.replace(/[<>"']/g, '') + '</span>';
            }
            contentHtml = `<div id="${moneyCardId}" style="${cardStyle}"><div style="display:flex;align-items:center;gap:14px;"><div style="width:56px;height:56px;background:${iconBoxBg.replace(/"/g, '&quot;')};border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,0.15);">${iconHtml}</div><div style="flex:1;"><div style="font-weight:500;font-size:13px;opacity:0.9;margin-bottom:6px;">${displayContent}</div><div style="font-size:22px;font-weight:bold;color:${amountColor.replace(/"/g, '&quot;')};letter-spacing:0.5px;">¥${msg.money.amount}</div><div style="font-size:11px;opacity:0.7;margin-top:2px;">银两</div>${msg.money.note ? `<div style="font-size:11px;opacity:0.8;margin-top:4px;color:white;padding-top:6px;border-top:1px solid rgba(255,255,255,0.2);">${msg.money.note}</div>` : ''}</div></div></div>`;
        } else if (msg.post) {
            // 分享的动态卡片
            contentHtml = `
                <div style="background:white;border-radius:12px;padding:16px;margin-top:5px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border:1px solid rgba(0,0,0,0.08);">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(0,0,0,0.08);">
                        <div style="width:32px;height:32px;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px;">
                            ${msg.post.author.charAt(0)}
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:600;font-size:14px;color:var(--text);">${msg.post.author}</div>
                            <div style="font-size:11px;color:var(--text);opacity:0.6;">${msg.post.date}</div>
                        </div>
                        <span class="material-icons" style="font-size:18px;color:var(--accent);">share</span>
                    </div>
                    ${msg.post.content ? `<div style="color:var(--text);font-size:14px;line-height:1.6;margin-bottom:${msg.post.image ? '12px' : '0'};white-space:pre-wrap;word-wrap:break-word;">${msg.post.content}</div>` : ''}
                    ${msg.post.image ? `
                        <div style="border-radius:8px;overflow:hidden;margin-top:${msg.post.content ? '12px' : '0'};">
                            <img src="${msg.post.image}" style="width:100%;max-height:300px;object-fit:cover;display:block;" />
                        </div>
                    ` : ''}
                </div>
            `;
        } else if (msg.redpack) {
            // 红包消息（QQ红包卡片形式）
            const redpackCardId = `group-redpack-card-${msg.id}`;
            const isOpened = msg.redpack.openedBy && msg.redpack.openedBy.includes(gameState.player.name);
            contentHtml = `
                <div id="${redpackCardId}" style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);padding:16px;border-radius:12px;margin-top:5px;color:white;cursor:pointer;box-shadow:0 4px 12px rgba(117,126,211,0.3);position:relative;overflow:hidden;">
                    <div style="position:absolute;top:-20px;right:-20px;width:80px;height:80px;background:rgba(255,255,255,0.1);border-radius:50%;"></div>
                    <div style="position:absolute;bottom:-30px;left:-30px;width:100px;height:100px;background:rgba(255,255,255,0.1);border-radius:50%;"></div>
                    <div style="position:relative;z-index:1;display:flex;align-items:center;gap:14px;">
                        <div style="width:64px;height:64px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;border:3px solid rgba(255,255,255,0.3);">
                            <span class="material-icons" style="font-size:36px;color:white;">redeem</span>
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:600;font-size:15px;margin-bottom:4px;">${displayContent || '恭喜发财，大吉大利'}</div>
                            <div style="font-size:12px;opacity:0.9;">${isOpened ? '已领取' : '点击领取'}</div>
                            ${msg.redpack.remaining > 0 ? `<div style="font-size:11px;opacity:0.8;margin-top:4px;">剩余 ${msg.redpack.remaining}/${msg.redpack.count} 个</div>` : '<div style="font-size:11px;opacity:0.8;margin-top:4px;">已被抢完</div>'}
                        </div>
                    </div>
                </div>
            `;
        } else if (msg.image) {
            // 如果有图片，显示图片
            contentHtml = `<img src="${msg.image}" style="max-width:200px;border-radius:5px;margin-top:5px;display:block;" />`;
            if (displayContent && displayContent !== '[表情包]' && displayContent !== '[图片]') {
                contentHtml = `<div style="margin-bottom:5px;">${displayContent}</div>${contentHtml}`;
            }
        } else {
            contentHtml = `<div style="margin-top:5px;">${displayContent}</div>`;
        }
        
        if (isGodView) {
            msgDiv.innerHTML = `
                <div style="font-weight:bold;font-size:12px;opacity:0.9;color:var(--accent);">${msg.author}</div>
                <div style="font-size:13px;margin-top:4px;">${displayContent}</div>
                <div style="font-size:10px;opacity:0.7;margin-top:5px;">${msg.time}</div>
            `;
        } else {
            // 如果是加载消息，不显示作者名字，只显示"..."
            if (isLoading) {
                msgDiv.innerHTML = `
                    <div style="font-size:14px;opacity:0.7;text-align:center;">...</div>
                `;
            } else {
                const isNpcAuthor = !isUser && msg.author && msg.author !== '【上帝视角】';
                const authorDisplay = (msg.author || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const authorHtml = isNpcAuthor
                    ? '<span class="msg-author-click" data-author="' + (msg.author || '').replace(/"/g, '&quot;') + '" onclick="event.stopPropagation(); showPsychologyDiaryModalByAuthor(this);">' + authorDisplay + '</span>'
                    : authorDisplay;
                msgDiv.innerHTML = `
                    <div style="font-weight:bold;font-size:12px;opacity:0.9;">${authorHtml}</div>
                    ${quoteHtml}${contentHtml}
                    <div style="font-size:10px;opacity:0.7;margin-top:5px;">${msg.time}</div>
                `;
            }
        }
        
        // 添加长按事件（排除加载消息和上帝视角消息）
        if (!isLoading && !isGodView) {
            const messageData = {
                id: msg.id,
                type: isUser ? 'user' : 'npc',
                author: msg.author,
                content: msg.content,
                image: msg.image || null,
                gift: msg.gift || null,
                money: msg.money || null,
                redpack: msg.redpack || null,
                post: msg.post || null
            };
            addLongPressToMessage(msgDiv, messageData, 'group');
        }
        
        container.appendChild(msgDiv);

        // 引用块点击：跳回原消息并高亮
        const quoteBlock = msgDiv.querySelector('.msg-quote[data-ref-type="group"][data-ref-id]');
        if (quoteBlock) {
            quoteBlock.addEventListener('click', (e) => {
                e.stopPropagation();
                const rid = Number(quoteBlock.getAttribute('data-ref-id'));
                if (!Number.isNaN(rid)) scrollToReferencedMessage({ type:'group', id: rid });
            });
        }
        
        // 如果是转账消息，添加点击事件
        if (msg.money) {
            const moneyCard = document.getElementById(`group-money-card-${msg.id}`);
            if (moneyCard) {
                moneyCard.onclick = function() {
                    showMoneyDetailModal({
                        amount: msg.money.amount,
                        senderType: msg.author === gameState.player.name ? 'user' : 'npc',
                        senderName: msg.author,
                        recipientName: msg.money.recipient,
                        timestamp: msg.time
                    });
                };
            }
        }
        
        // 如果是红包消息，添加点击事件
        if (msg.redpack) {
            const redpackCard = document.getElementById(`group-redpack-card-${msg.id}`);
            if (redpackCard) {
                redpackCard.onclick = function() {
                    openRedPack(msg.id);
                };
            }
        }
    });
    
    container.scrollTop = container.scrollHeight;
}

function sendGroupMessage() {
    const input = document.getElementById('group-chat-input');
    const content = input.value.trim();
    if (!content) return;
    
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    const timeNames = ["早", "中", "晚"];
    const q = getQuoteState('group');
    const msg = {
        id: Date.now(),
        author: gameState.player.name,
        content: content,
        quote: q ? { author: q.author, text: q.text, ref: q.ref || null } : null,
        time: `${gameState.world.month}月${gameState.world.day}日 ${timeNames[gameState.world.timeOfDay]}`
    };
    
    group.messages.push(msg);
    input.value = "";
    clearQuote('group');
    renderGroupChat();
}

function generateNPCGroupReply(npc, lastMsg) {
    const replies = [
        "说得对",
        "我也这么想",
        "嗯嗯",
        "有道理",
        "确实如此"
    ];
    return replies[Math.floor(Math.random() * replies.length)];
}

// 保存群聊API调用的abortControllers
let groupChatAbortControllers = [];

async function sendGroupMessageWithAPI() {
    // 获取小鱼板按钮（在函数开始处定义，确保所有地方都能访问）
    const fishBtn = document.querySelector('#page-group-chat button[onclick="sendGroupMessageWithAPI()"]');
    
    // 如果正在调用API，则取消调用
    if (apiCallingState.sendGroupMessage) {
        apiCallingState.sendGroupMessage = false;
        // 取消所有正在进行的API调用
        groupChatAbortControllers.forEach(controller => {
            try {
                controller.abort();
            } catch (e) {
                console.error('取消API调用失败:', e);
            }
        });
        groupChatAbortControllers = [];
        
        // 取消所有通过registerApiCall注册的群聊消息API调用
        const group = gameState.groups.find(g => g.id === currentGroupId);
        if (group) {
            Array.from(activeApiCalls.entries()).forEach(([callId, call]) => {
                if (call.type === 'groupMessage' && call.context.groupId === group.id) {
                    cancelApiCall(callId);
                }
            });
            
            // 从group.messages中移除所有"..."消息
            group.messages = group.messages.filter(m => m.content !== '...');
            renderGroupChat();
        }
        
        // 移除呼吸动画
        if (fishBtn) {
            fishBtn.classList.remove('breathing');
        }
        return;
    }
    
    // 立即设置状态标志，防止重复调用（修复竞态条件）
    apiCallingState.sendGroupMessage = true;
    
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) {
        apiCallingState.sendGroupMessage = false;
        return;
    }
    
    // 清空之前的abortControllers
    groupChatAbortControllers = [];
    
    // 检查API配置
    const savedSettings = localStorage.getItem('palace_settings');
    if (!savedSettings) {
        apiCallingState.sendGroupMessage = false;
        showErrorModal('请先在设置中配置API Key才能进行AI对话。');
        return;
    }
    const settings = JSON.parse(savedSettings);
    if (!settings.apiKey || !settings.apiUrl) {
        apiCallingState.sendGroupMessage = false;
        showErrorModal('请先在设置中配置API Key才能进行AI对话。');
        return;
    }
    
    // 获取所有NPC成员
    const npcIds = group.memberIds.filter(id => id !== null);
    if (npcIds.length === 0) {
        apiCallingState.sendGroupMessage = false;
        return;
    }
    
    // 心理状态与日记已合并到本次群聊API的同一批回复中，不再单独请求
    
    // 更新小鱼板按钮状态（添加呼吸动画）
    if (fishBtn) {
        fishBtn.classList.add('breathing');
    }
    
    const timeNames = ["早", "中", "晚"];
    
    // 根据记忆设置获取历史消息
    let historyMessages = [];
    if (group.messages && group.messages.length > 0) {
        const memoryCount = gameState.groupMemorySettings && gameState.groupMemorySettings[group.id] !== undefined 
            ? gameState.groupMemorySettings[group.id] 
            : 100;
        if (memoryCount === 0) {
            historyMessages = group.messages;
        } else {
            historyMessages = group.messages.slice(-memoryCount);
        }
    }
    
    const recentMessages = historyMessages.map(m => `${m.author}: ${m.content || (m.image ? '[图片]' : '')}`).join('\n');
    const groupMembers = group.memberIds.map(id => {
        if (id === null) return gameState.player.name;
        const member = gameState.npcs.find(n => n.id == id);
        return member ? member.name : '';
    }).filter(Boolean).join('、');
    
    // 显示一个统一的加载消息
    const loadingMsgId = Date.now() + Math.random();
    const loadingMsg = {
        id: loadingMsgId,
        author: '',
        content: "...",
        time: `${gameState.world.month}月${gameState.world.day}日 ${timeNames[gameState.world.timeOfDay]}`
    };
    group.messages.push(loadingMsg);
    renderGroupChat();
    
    // 收集所有NPC的信息
    const npcInfos = [];
    for (const npcId of npcIds) {
        const npc = gameState.npcs.find(n => n.id == npcId); // 使用 == 兼容字符串/数字类型，确保后来邀请的成员也能被找到
        if (!npc) continue;
        
        // 检查是否已取消
        if (!apiCallingState.sendGroupMessage) {
            break;
        }
        
        // 获取该NPC与用户的私聊记忆
        let npcPrivateMemory = '';
        if (npc.history && npc.history.length > 0) {
            const memoryCount = gameState.memorySettings[npc.id] !== undefined ? gameState.memorySettings[npc.id] : 100;
            if (memoryCount === 0) {
                npcPrivateMemory = npc.history.join('\n');
            } else {
                const npcReplies = npc.history.filter(msg => msg.includes(`${npc.name}:`));
                npcPrivateMemory = npcReplies.slice(-memoryCount).join('\n');
            }
        }
        
        // 获取该NPC参与的动态圈记录
        let socialCircleMemory = '';
        const allPosts = getAllPosts();
        const npcPosts = allPosts.filter(post => {
            if (post.author === npc.name) return true;
            if (post.circleId === null) {
                return true;
            } else {
                const circle = gameState.socialCircles.find(c => c.id === post.circleId);
                if (circle && circle.members && circle.members.includes(npc.id)) {
                    return true;
                }
            }
            return false;
        });
        
        if (npcPosts.length > 0) {
            const recentPosts = npcPosts.slice(-10);
            socialCircleMemory = `你参与的动态圈中的最近动态：\n${recentPosts.map(p => `${p.author}: ${p.content || '[图片]'}${p.commentsList && p.commentsList.length > 0 ? '\n评论：' + p.commentsList.map(c => `${c.author}: ${c.content}`).join('\n') : ''}`).join('\n\n')}`;
        }
        
        // 收集NPC信息（含根据回退设置的心理状态与日记）
        const effPsych = getEffectivePsych(npc);
        const effDiary = getEffectiveDiary(npc);
        npcInfos.push({
            id: npc.id,
            name: npc.name,
            role: npc.role,
            personality: npc.personality,
            privateMemory: npcPrivateMemory,
            socialCircleMemory: socialCircleMemory,
            psychologicalState: effPsych,
            diary: effDiary
        });
    }
    
    if (npcInfos.length === 0) {
        // 移除加载消息
        const loadingIndex = group.messages.findIndex(m => m.id === loadingMsgId);
        if (loadingIndex !== -1) {
            group.messages.splice(loadingIndex, 1);
        }
        renderGroupChat();
        apiCallingState.sendGroupMessage = false;
        if (fishBtn) {
            fishBtn.classList.remove('breathing');
        }
        return;
    }
    
    // 构建批量生成的提示词
    const npcInfosText = npcInfos.map((npc, index) => {
        return `
【NPC ${index + 1}】
姓名：${npc.name}
身份：${gameState.world.dynasty}朝的${npc.role}
性格：${npc.personality}
${npc.privateMemory ? `私聊记忆：${npc.privateMemory}` : '无私聊记忆'}
${npc.socialCircleMemory ? `动态圈记忆：${npc.socialCircleMemory}` : '无动态圈记忆'}
${npc.psychologicalState ? `心理状态（供参考）：${npc.psychologicalState}` : ''}
${npc.diary ? `近期日记（供参考）：${npc.diary}` : ''}
---`;
    }).join('\n');
    const contactsListForProactive = (gameState.npcs || []).map(function(n) { return 'id:' + n.id + ' 姓名:' + n.name; }).join('\n');
    
    const batchSystemPrompt = `
你是一个群聊场景生成器。当前在一个中国古代宫廷背景的群聊中。
${getStylePresetPrompt()}${getAntiBaguguPrompt()}
群聊中的玩家（主角）自身设定：${getPlayerContextForAPI()}
群聊成员：${groupMembers}
最近群聊消息：
${recentMessages}

群聊中的NPC成员详细信息：
${npcInfosText}

请为每个NPC成员生成一条回复。要求：
1. **每个NPC必须回复，不要保持沉默**。必须为所有${npcInfos.length}个NPC生成回复，不要遗漏任何成员。
2. **content 只填该角色说的台词**（角色口中说出的原话），不要用引号包裹，不要写旁白、心理描写或动作说明。
3. 回复长度自由，可以是一句话或多句话。根据对话内容和情绪自然决定，不要有固定字数或句数限制。
4. 回复要符合每个NPC的性格、身份和记忆
5. NPC可以回复群聊中的任何成员，不仅仅是${gameState.player.name}。NPC之间可以互相交流、讨论话题、回应彼此的观点
6. 回复要符合中国古代宫廷风格（文言文与白话结合）
7. 根据群聊消息的内容和氛围，让NPC自然地参与讨论
8. 如果群聊中有其他成员在讨论话题，NPC可以加入讨论；如果有成员向NPC提问或提到NPC，NPC应该回应；如果群聊氛围轻松，NPC也可以主动发起话题

请以JSON格式返回。replies 必填。proactiveContact 为可选项：仅当本次群聊话题足够有趣、相关或引发讨论以致有人脉中的角色会主动私聊找主角时才返回，否则不要返回此字段。人脉名单（npcId仅可从下列选）：${contactsListForProactive || '无'}。格式如下：
{
  "replies": [
    {"name": "NPC名字", "content": "回复内容", "psychologicalState": "50-150字该角色当前心理状态", "diary": "80-200字该角色第一人称日记"}
  ]
}
若有 proactiveContact 则增加 "proactiveContact": {"contacts": [{"npcId": 数字, "messages": ["该角色对主角说的第一句", "第二句", ...]}, ...]}。
psychologicalState与diary不要围绕玩家(主角)来写，应体现该角色在群聊中的独立心理、对群内他人与话题的看法；日记写该角色自己的经历与感受。

**重要：必须为所有${npcInfos.length}个NPC生成回复，不要遗漏任何成员。回复内容要多样化。proactiveContact 不要每次都有，仅当话题明显引发私下交流欲望时才返回。**
    `;
    
    // 创建API调用ID和AbortController
    const apiCallId = generateApiCallId();
    const abortController = new AbortController();
    groupChatAbortControllers.push(abortController);
    
    // 注册API调用
    registerApiCall(apiCallId, 'groupMessage', {
        groupId: group.id,
        loadingMsgId: loadingMsgId,
        npcInfos: npcInfos
    }, (result, context) => {
        // API调用完成后的回调
        const currentGroup = gameState.groups.find(g => g.id === context.groupId);
        if (!currentGroup) return;
        
        // 移除加载消息
        const loadingIndex = currentGroup.messages.findIndex(m => m.id === context.loadingMsgId);
        if (loadingIndex !== -1) {
            currentGroup.messages.splice(loadingIndex, 1);
        }
        
        if (result.success && result.replies) {
            // 群聊调用过 API 后，社交影响力由本次互动上升
            gameState.player.socialInfluence = (gameState.player.socialInfluence || 0) + 2;
            updateSocialLevelFromInfluence();
            // 为每个NPC添加回复消息，依次添加以产生自然的对话效果
            (async () => {
                const repliedNames = result.replies.map(r => r.name);
                var firstGroupReplyAdded = true;
                // 确保所有NPC都有回复
                for (const npc of context.npcInfos) {
                    let reply = result.replies.find(r => r.name === npc.name);
                    
                    // 如果没有找到回复，使用默认回复
                    if (!reply || !reply.content || reply.content.trim() === '') {
                        reply = {
                            name: npc.name,
                            content: "（沉默不语）"
                        };
                    }
                    
                    // 同一次API返回的心理状态与日记，直接写入对应NPC
                    const npcObj = gameState.npcs.find(n => n.id === npc.id);
                    if (npcObj) {
                        pushPsychDiaryToHistory(npcObj, reply.psychologicalState, reply.diary);
                    }
                    
                    // 群聊消息只展示角色说的话：去掉旁白/心理（）、"" 与首尾引号，过滤空句
                    var rawContent = (reply.content || '').trim();
                    var content = rawContent.replace(/（[^）]*）/g, '').replace(/\([^)]*\)/g, '').replace(/\s{2,}/g, ' ').trim();
                    content = content.replace(/""+/g, ' ').trim();
                    if (/^[""]/.test(content)) content = content.replace(/^[""]+/, '').trim();
                    if (/[""]$/.test(content)) content = content.replace(/[""]+$/, '').trim();
                    if (!content) content = '（沉默不语）';
                    var segments = content.split(/(?<=[。！？!?；;])\s*|\n+/).map(function(s) {
                        s = s.trim().replace(/^[""]+/, '').replace(/[""]+$/, '');
                        return s.trim();
                    }).filter(function(s) { return s.length > 0 && s.replace(/[""\s\u3000]/g, '').length > 0; });
                    if (segments.length === 0) segments = [content.replace(/^[""]+/, '').replace(/[""]+$/, '').trim() || '（沉默不语）'];
                    var merged = [];
                    for (var si = 0; si < segments.length; si++) {
                        if (merged.length && /^[\s）\)\]】〕〉」』]*$/.test(segments[si])) {
                            merged[merged.length - 1] = merged[merged.length - 1] + segments[si];
                        } else {
                            merged.push(segments[si]);
                        }
                    }
                    segments = merged;
                    
                    // 添加延迟，让消息依次出现
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    for (var si = 0; si < segments.length; si++) {
                        var npcMsg = {
                            id: Date.now() + Math.random(),
                            author: reply.name,
                            content: segments[si],
                            time: `${gameState.world.month}月${gameState.world.day}日 ${timeNames[gameState.world.timeOfDay]}`
                        };
                        currentGroup.messages.push(npcMsg);
                        if (firstGroupReplyAdded) {
                            playGroupNotificationSoundForGroupId(context.groupId);
                            firstGroupReplyAdded = false;
                        }
                        const currentPage = document.querySelector('.page.active');
                        if (currentPage && currentPage.id === 'page-group-chat' && currentGroupId === context.groupId) {
                            renderGroupChat();
                        }
                        if (si < segments.length - 1) await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
                // 同一次 API 返回的主动私聊（若有）：写入人脉历史、播提示音、弹窗
                var pro = result.proactiveContact;
                if (pro && pro.contacts && Array.isArray(pro.contacts) && pro.contacts.length > 0) {
                    var currentDate = new Date().toISOString();
                    var triggeredNames = [];
                    var firstProactiveNpc = true;
                    for (var ci = 0; ci < pro.contacts.length; ci++) {
                        var contact = pro.contacts[ci];
                        var npcId = contact.npcId != null ? Number(contact.npcId) : null;
                        var messages = Array.isArray(contact.messages) ? contact.messages.filter(function(m) { return m && String(m).trim(); }) : [];
                        if (npcId == null || messages.length === 0) continue;
                        var npc = gameState.npcs.find(function(n) { return n.id == npcId; });
                        if (!npc) continue;
                        if (!npc.history) npc.history = [];
                        messages.forEach(function(msg) {
                            npc.history.push('[' + currentDate + '] ' + npc.name + ': ' + String(msg).trim());
                        });
                        if (firstProactiveNpc) {
                            playNotificationSoundForNpc(npc);
                            firstProactiveNpc = false;
                        }
                        triggeredNames.push(npc.name);
                    }
                    if (triggeredNames.length > 0) {
                        var namesText = triggeredNames.length === 1 ? triggeredNames[0] : triggeredNames.join('、');
                        var systemMsg = '\uD83D\uDCAC ' + namesText + (triggeredNames.length > 1 ? '等' : '') + '主动找你私聊了，可到「人脉」查看。';
                        showProactiveContactPopup(systemMsg);
                    }
                }
            })();
        } else if (result.error) {
            // 如果批量生成失败，弹窗显示错误信息，不写入群聊消息
            showErrorModal(`群聊AI调用失败：${result.error}`);
            const currentPage = document.querySelector('.page.active');
            if (currentPage && currentPage.id === 'page-group-chat' && currentGroupId === context.groupId) {
                renderGroupChat();
            }
            console.error(`群聊批量生成失败：${result.error}`);
        }
        
        // 清理状态
        apiCallingState.sendGroupMessage = false;
        const fishBtn = document.querySelector('#page-group-chat button[onclick="sendGroupMessageWithAPI()"]');
        if (fishBtn) {
            fishBtn.classList.remove('breathing');
        }
        groupChatAbortControllers = [];
    }, abortController);
    
    // 异步执行批量API调用
    (async () => {
        try {
            const response = await fetch(`${settings.apiUrl}/chat/completions`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${settings.apiKey}`
                },
                body: JSON.stringify({
                    model: settings.model || "gpt-3.5-turbo",
                    messages: [
                        { role: "system", content: "你是一个群聊场景生成器，需要为多个NPC生成回复。请严格按照JSON格式返回。" },
                        { role: "user", content: batchSystemPrompt }
                    ],
                    temperature: 0.8,
                    max_tokens: Math.max(2000, npcInfos.length * 500) // 含回复+心理状态+日记，增加token以支持多句话回复
                }),
                signal: abortController.signal
            });
            
            if (!response.ok) {
                let errorMessage = `API请求失败 (${response.status})`;
                try {
                    const errorText = await response.text();
                    if (errorText) {
                        try {
                            const errorData = JSON.parse(errorText);
                            if (errorData.error && errorData.error.message) {
                                errorMessage = errorData.error.message;
                            } else if (errorData.message) {
                                errorMessage = errorData.message;
                            } else {
                                errorMessage = `${errorMessage}: ${errorText}`;
                            }
                        } catch (e) {
                            errorMessage = `${errorMessage}: ${errorText}`;
                        }
                    }
                } catch (e) {
                    errorMessage = `${errorMessage}: 无法读取错误信息`;
                }
                completeApiCall(apiCallId, { success: false, error: errorMessage });
                return;
            }
            
            const data = await response.json();
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                completeApiCall(apiCallId, { success: false, error: 'API返回数据格式错误' });
                return;
            }
            
            const reply = data.choices[0].message.content.trim();
            if (!reply) {
                completeApiCall(apiCallId, { success: false, error: 'AI返回内容为空' });
                return;
            }
            
            // 尝试解析JSON
            let jsonMatch = reply.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                completeApiCall(apiCallId, { success: false, error: 'AI返回的不是有效的JSON格式' });
                return;
            }
            
            const result = JSON.parse(jsonMatch[0]);
            if (!result.replies || !Array.isArray(result.replies)) {
                completeApiCall(apiCallId, { success: false, error: 'AI返回的数据中没有有效的replies数组' });
                return;
            }
            
            // 验证所有NPC都有回复
            const repliedNames = result.replies.map(r => r.name);
            const missingNpcs = npcInfos.filter(npc => !repliedNames.includes(npc.name));
            if (missingNpcs.length > 0) {
                // 为缺失的NPC生成默认回复
                missingNpcs.forEach(npc => {
                    result.replies.push({
                        name: npc.name,
                        content: "（沉默不语）"
                    });
                });
            }
            
            completeApiCall(apiCallId, { success: true, replies: result.replies, proactiveContact: result.proactiveContact || null });
            
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('群聊批量生成失败:', error);
                completeApiCall(apiCallId, { success: false, error: error.message || '未知错误' });
            } else {
                // 如果被取消，也要移除加载消息
                const currentGroup = gameState.groups.find(g => g.id === group.id);
                if (currentGroup) {
                    const loadingIndex = currentGroup.messages.findIndex(m => m.id === loadingMsgId);
                    if (loadingIndex !== -1) {
                        currentGroup.messages.splice(loadingIndex, 1);
                        const currentPage = document.querySelector('.page.active');
                        if (currentPage && currentPage.id === 'page-group-chat' && currentGroupId === group.id) {
                            renderGroupChat();
                        }
                    }
                }
            }
        }
    })();
    
    // 注意：状态管理现在在API调用的回调中完成
    // 当所有群聊消息API调用完成后，回调会自动清理状态
}

function addGroupMessage(content, author = "系统") {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    const timeNames = ["早", "中", "晚"];
    const msg = {
        id: Date.now(),
        author: author,
        content: content,
        time: `${gameState.world.month}月${gameState.world.day}日 ${timeNames[gameState.world.timeOfDay]}`
    };
    
    group.messages.push(msg);
    renderGroupChat();
}

// 群聊侧边栏切换
function toggleGroupChatSidebar() {
    const sidebar = document.getElementById('group-chat-sidebar');
    const overlay = document.getElementById('group-chat-sidebar-overlay');
    if (!sidebar || !overlay) {
        console.error('侧边栏元素未找到');
        return;
    }
    const isOpen = sidebar.classList.contains('show');
    if (isOpen) {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
    } else {
        sidebar.classList.add('show');
        overlay.classList.add('show');
    }
}

// 群聊+号菜单
function toggleGroupChatPlusMenu() {
    const menu = document.getElementById('group-chat-plus-menu');
    if (!menu) {
        console.error('群聊菜单元素未找到');
        return;
    }
    // 关闭所有其他菜单
    document.querySelectorAll('.plus-menu, .chat-plus-menu').forEach(m => {
        if (m.id !== menu.id) m.classList.remove('show');
    });
    // 切换当前菜单显示状态
    const isShowing = menu.classList.contains('show');
    if (isShowing) {
        menu.classList.remove('show');
    } else {
        menu.classList.add('show');
    }
}

// 群聊菜单的点击关闭逻辑（合并到上面的监听器中）

// 群聊发送表情包
function sendEmojiFromGroupChat() {
    if (apiCallingState.sendEmoji) return;
    
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    document.getElementById('group-chat-plus-menu').classList.remove('show');
    currentEmojiNpcId = null; // 群聊不需要指定NPC
    openEmojiModal();
}

// 群聊发送图片
function sendImageFromGroupChat() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    document.getElementById('group-chat-plus-menu').classList.remove('show');
    openSendImageModal();
}

let groupMemberSelectMode = null; // 'gift' 或 'money'
let selectedGroupMemberIds = [];

// 群聊发送礼物
function sendGiftFromGroupChat() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    document.getElementById('group-chat-plus-menu').classList.remove('show');
    groupMemberSelectMode = 'gift';
    showGroupMemberSelectModal('选择要赠送礼物的成员（可多选）');
}

// 群聊转账
function sendMoneyFromGroupChat() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    document.getElementById('group-chat-plus-menu').classList.remove('show');
    groupMemberSelectMode = 'money';
    showGroupMemberSelectModal('选择要转账的成员（单选）');
}

function showGroupMemberSelectModal(title) {
    const modal = document.getElementById('group-member-select-modal');
    const titleEl = document.getElementById('group-member-select-title');
    const listEl = document.getElementById('group-member-select-list');
    
    // 只修改标题文本，保留h3和span结构
    const iconSpan = titleEl.querySelector('span.material-icons');
    if (iconSpan) {
        titleEl.innerHTML = `<span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">people</span>${title}`;
    } else {
        titleEl.innerHTML = `<span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">people</span>${title}`;
    }
    listEl.innerHTML = '';
    selectedGroupMemberIds = [];
    
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    // 显示所有成员（不包括玩家）
    group.memberIds.forEach(id => {
        if (id === null) return; // 跳过玩家
        
        const npc = gameState.npcs.find(n => n.id == id);
        if (!npc) return;
        
        const memberItem = document.createElement('div');
        memberItem.style.cssText = "display:flex;align-items:center;padding:12px;margin-bottom:8px;background:rgba(225,227,237,0.3);border-radius:8px;cursor:pointer;transition:background 0.2s;";
        memberItem.onmouseover = () => memberItem.style.background = "rgba(225,227,237,0.5)";
        memberItem.onmouseout = () => memberItem.style.background = "rgba(225,227,237,0.3)";
        
        // 根据模式选择input类型：转账用radio（单选），礼物用checkbox（多选）
        const inputType = groupMemberSelectMode === 'money' ? 'radio' : 'checkbox';
        const inputName = groupMemberSelectMode === 'money' ? 'group-transfer-member' : '';
        
        const checkbox = document.createElement('input');
        checkbox.type = inputType;
        checkbox.value = npc.id;
        checkbox.id = `group-select-member-${npc.id}`;
        checkbox.style.cssText = "width:18px;height:18px;margin-right:12px;cursor:pointer;flex-shrink:0;";
        if (inputType === 'radio') {
            checkbox.name = inputName; // radio需要相同的name才能互斥
        }
        checkbox.addEventListener('change', function() {
            updateGroupMemberSelectCount();
        });
        
        // 点击整个item区域时切换状态
        memberItem.addEventListener('click', function(e) {
            if (e.target.type !== inputType) {
                if (inputType === 'radio') {
                    // radio单选：直接选中
                    checkbox.checked = true;
                    // 取消其他radio的选中
                    document.querySelectorAll(`input[name="${inputName}"]`).forEach(r => {
                        if (r !== checkbox) r.checked = false;
                    });
                } else {
                    // checkbox多选：切换状态
                    checkbox.checked = !checkbox.checked;
                }
                updateGroupMemberSelectCount();
            }
        });
        
        const avatarDiv = document.createElement('div');
        avatarDiv.style.cssText = "width:40px;height:40px;border-radius:50%;background:var(--secondary);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:bold;margin-right:12px;flex-shrink:0;";
        avatarDiv.textContent = npc.name.charAt(0);
        
        const infoDiv = document.createElement('div');
        infoDiv.style.cssText = "flex:1;";
        infoDiv.innerHTML = `
            <div style="font-weight:bold;color:var(--text);">${npc.name}</div>
            <div style="font-size:12px;color:#8E96D9;">${npc.role}</div>
        `;
        
        memberItem.appendChild(checkbox);
        memberItem.appendChild(avatarDiv);
        memberItem.appendChild(infoDiv);
        
        listEl.appendChild(memberItem);
    });
    
    updateGroupMemberSelectCount();
    modal.style.display = 'flex';
}

function updateGroupMemberSelectCount() {
    // 根据模式选择input类型
    const inputType = groupMemberSelectMode === 'money' ? 'radio' : 'checkbox';
    const checked = document.querySelectorAll(`#group-member-select-list input[type="${inputType}"]:checked`);
    selectedGroupMemberIds = Array.from(checked).map(cb => parseInt(cb.value));
    const countEl = document.getElementById('group-member-select-count');
    const labelEl = document.getElementById('group-member-select-label');
    if (countEl) {
        if (groupMemberSelectMode === 'money') {
            countEl.textContent = selectedGroupMemberIds.length > 0 ? '1' : '0';
            if (labelEl) {
                labelEl.textContent = selectedGroupMemberIds.length > 0 ? '已选择 1 位成员' : '已选择 0 位成员';
            }
        } else {
            countEl.textContent = selectedGroupMemberIds.length;
            if (labelEl) {
                labelEl.textContent = `已选择 ${selectedGroupMemberIds.length} 位成员`;
            }
        }
    }
}

function closeGroupMemberSelectModal() {
    document.getElementById('group-member-select-modal').style.display = 'none';
    groupMemberSelectMode = null;
    selectedGroupMemberIds = [];
}

function confirmGroupMemberSelect() {
    if (selectedGroupMemberIds.length === 0) {
        if (groupMemberSelectMode === 'money') {
            alert('请选择要转账的成员');
        }
        return;
    }
    
    if (groupMemberSelectMode === 'gift') {
        // 打开礼物商店，传递选中的成员ID（可多选）
        window.groupGiftTargetIds = selectedGroupMemberIds;
        closeGroupMemberSelectModal();
        openGiftShop(); // 使用模态框方式打开礼物商店
    } else if (groupMemberSelectMode === 'money') {
        // 转账只能选择一个成员
        if (selectedGroupMemberIds.length > 1) {
            alert('转账只能选择一个成员');
            return;
        }
        // 显示转账金额输入
        showGroupMoneyTransferModal();
    }
}

function showGroupMoneyTransferModal() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    const currentMoney = gameState.player.stats.money;
    const maxAmount = Math.min(currentMoney, 1000);
    
    // 创建转账金额输入模态框
    const modal = document.createElement('div');
    modal.id = 'group-money-transfer-input-modal';
    modal.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:200;display:flex;justify-content:center;align-items:center;";
    modal.onclick = function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    };
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width:400px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3><span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">account_balance_wallet</span>转账银两</h3>
                <button class="icon-btn" onclick="document.getElementById('group-money-transfer-input-modal').remove()" style="color:var(--text);">✕</button>
            </div>
            <div class="input-group">
                <label>当前银两</label>
                <div style="background:var(--secondary);padding:12px;border-radius:8px;text-align:center;font-size:24px;color:var(--accent);font-weight:bold;">
                    ${currentMoney}两
                </div>
            </div>
            <div class="input-group">
                <label>转账金额（每人）</label>
                <input type="number" id="group-money-transfer-amount" placeholder="请输入金额" min="1" max="${maxAmount}" step="1" style="font-size:18px;text-align:center;">
                <div style="display:flex;gap:5px;margin-top:8px;">
                    <button class="btn btn-outline" style="flex:1;font-size:12px;padding:6px;" onclick="setGroupTransferAmount(0.25)">25%</button>
                    <button class="btn btn-outline" style="flex:1;font-size:12px;padding:6px;" onclick="setGroupTransferAmount(0.5)">50%</button>
                    <button class="btn btn-outline" style="flex:1;font-size:12px;padding:6px;" onclick="setGroupTransferAmount(0.75)">75%</button>
                    <button class="btn btn-outline" style="flex:1;font-size:12px;padding:6px;" onclick="setGroupTransferAmount(1)">全部</button>
                </div>
            </div>
            <div class="input-group">
                <label>备注（可选）</label>
                <input type="text" id="group-money-transfer-note" placeholder="转账备注" maxlength="20" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--secondary);font-size:14px;text-align:center;">
            </div>
            <div class="input-group">
                <label>转账给 <span id="group-transfer-member-names"></span></label>
                <div style="background:var(--secondary);padding:8px;border-radius:8px;text-align:center;color:var(--text);font-size:14px;" id="group-money-transfer-total">
                    转账金额：0两
                </div>
            </div>
            <div style="display:flex;gap:10px;margin-top:15px;">
                <button class="btn btn-outline" onclick="document.getElementById('group-money-transfer-input-modal').remove()" style="flex:1;">取消</button>
                <button class="btn" onclick="confirmGroupMoneyTransfer()" style="flex:1;">确定转账</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // 显示成员名字
    const memberNames = selectedGroupMemberIds.map(id => {
        const npc = gameState.npcs.find(n => n.id == id);
        return npc ? npc.name : '';
    }).filter(Boolean).join('、');
    document.getElementById('group-transfer-member-names').textContent = memberNames;
    
    // 监听金额变化
    const amountInput = document.getElementById('group-money-transfer-amount');
    amountInput.addEventListener('input', updateGroupTransferTotal);
    updateGroupTransferTotal();
}

function setGroupTransferAmount(percent) {
    const currentMoney = gameState.player.stats.money;
    const maxAmount = Math.min(currentMoney, 1000);
    const amount = Math.floor(maxAmount * percent);
    document.getElementById('group-money-transfer-amount').value = amount;
    updateGroupTransferTotal();
}

function updateGroupTransferTotal() {
    const amountInput = document.getElementById('group-money-transfer-amount');
    const amount = parseInt(amountInput.value) || 0;
    // 转账只能选择一个成员，所以total就是amount
    const total = amount;
    const currentMoney = gameState.player.stats.money;
    
    document.getElementById('group-money-transfer-total').textContent = `转账金额：${total}两`;
    
    if (total > currentMoney) {
        document.getElementById('group-money-transfer-total').style.color = '#FF6B6B';
        document.getElementById('group-money-transfer-total').textContent += ` (余额不足)`;
    } else {
        document.getElementById('group-money-transfer-total').style.color = 'var(--text)';
    }
}

function confirmGroupMoneyTransfer() {
    const amountInput = document.getElementById('group-money-transfer-amount');
    const amount = parseInt(amountInput.value) || 0;
    
    if (amount <= 0) {
        alert('请输入有效的转账金额');
        return;
    }
    
    // 转账只能选择一个成员
    if (selectedGroupMemberIds.length !== 1) {
        alert('请选择一个成员进行转账');
        return;
    }
    
    const total = amount; // 只有一个成员，所以total就是amount
    const currentMoney = gameState.player.stats.money;
    
    if (total > currentMoney) {
        alert(`余额不足！需要${total}两，当前只有${currentMoney}两`);
        return;
    }
    
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    const note = document.getElementById('group-money-transfer-note').value.trim() || '';
    
    // 扣除玩家银两
    gameState.player.stats.money -= total;
    updateMoneyDisplay();
    
    // 发送转账消息到群聊（使用money字段标识转账消息）
    const timeNames = ["早", "中", "晚"];
    const npc = gameState.npcs.find(n => n.id == selectedGroupMemberIds[0]);
    const memberName = npc ? npc.name : '未知成员';
    
    const msg = {
        id: Date.now(),
        author: gameState.player.name,
        content: `向${memberName}转账`,
        money: {
            amount: amount,
            recipient: memberName,
            note: note
        },
        time: `${gameState.world.month}月${gameState.world.day}日 ${timeNames[gameState.world.timeOfDay]}`
    };
    
    group.messages.push(msg);
    renderGroupChat();
    
    // 关闭模态框
    const modal = document.getElementById('group-money-transfer-input-modal');
    if (modal) modal.remove();
    closeGroupMemberSelectModal();
}

// 群聊转账
// 群聊记忆历史设置
function openGroupMemorySettings() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    document.getElementById('group-chat-plus-menu').classList.remove('show');
    
    // 显示群聊记忆历史
    const modal = document.getElementById('memory-modal');
    const npcNameEl = document.getElementById('memory-npc-name');
    const memoryCountEl = document.getElementById('memory-count');
    const currentCountEl = document.getElementById('current-memory-count');
    const memoryDescEl = document.getElementById('memory-description');
    
    if (npcNameEl) {
        npcNameEl.textContent = `${group.name} (群聊)`;
    }
    if (memoryCountEl) {
        // 群聊的记忆设置（可以设置群聊消息保留数量）
        const groupMemorySetting = gameState.groupMemorySettings && gameState.groupMemorySettings[group.id];
        memoryCountEl.value = groupMemorySetting !== undefined ? groupMemorySetting : 100;
    }
    if (currentCountEl) {
        currentCountEl.textContent = group.messages ? group.messages.length : 0;
    }
    if (memoryDescEl) {
        memoryDescEl.textContent = '设置AI回复时记忆的群聊消息条数，默认100条。设置为0表示使用该群聊的所有消息记录（永久保存）';
    }
    
    // 标记这是群聊模式
    currentMemoryNpcId = 'group_' + currentGroupId;
    
    if (modal) {
        modal.style.display = 'flex';
    }
}

// 群聊自定义背景图片
var groupBackgroundImageTemp = null;
var groupBackgroundScaleTemp = 100;

function applyGroupChatBackground() {
    const container = document.getElementById('page-group-chat');
    if (!container) return;
    const group = currentGroupId != null && gameState.groups ? gameState.groups.find(g => g.id === currentGroupId) : null;
    const url = (group && group.backgroundImage) ? group.backgroundImage : '';
    const scale = (group && group.backgroundScale != null) ? Math.max(50, Math.min(200, group.backgroundScale)) : 100;
    if (url) {
        container.style.backgroundImage = 'url(' + url + ')';
        container.style.backgroundSize = scale + '% ' + scale + '%';
        container.style.backgroundPosition = 'center';
    } else {
        container.style.backgroundImage = '';
        container.style.backgroundSize = '';
        container.style.backgroundPosition = '';
    }
}

function openGroupChatBackgroundModal() {
    const group = gameState.groups && gameState.groups.find(g => g.id === currentGroupId);
    if (!group) {
        showErrorModal('请先进入一个群聊。');
        return;
    }
    groupBackgroundImageTemp = null;
    groupBackgroundScaleTemp = (group.backgroundScale != null) ? Math.max(50, Math.min(200, group.backgroundScale)) : 100;
    document.getElementById('group-chat-background-url').value = (group.backgroundImage && group.backgroundImage.indexOf('http') === 0) ? group.backgroundImage : '';
    document.getElementById('group-chat-background-file').value = '';
    document.getElementById('group-chat-background-scale-text').textContent = groupBackgroundScaleTemp + '%';
    var previewWrap = document.getElementById('group-chat-background-preview-wrap');
    var preview = document.getElementById('group-chat-background-preview');
    if (group.backgroundImage) {
        preview.style.backgroundImage = 'url(' + group.backgroundImage + ')';
        preview.style.backgroundSize = groupBackgroundScaleTemp + '% ' + groupBackgroundScaleTemp + '%';
        previewWrap.style.display = 'block';
    } else {
        preview.style.backgroundImage = '';
        preview.style.backgroundSize = '';
        previewWrap.style.display = 'none';
    }
    document.getElementById('group-chat-background-file').onchange = function() {
        var f = this.files[0];
        if (!f) return;
        var r = new FileReader();
        r.onload = function() {
            groupBackgroundImageTemp = r.result;
            preview.style.backgroundImage = 'url(' + r.result + ')';
            preview.style.backgroundSize = groupBackgroundScaleTemp + '% ' + groupBackgroundScaleTemp + '%';
            previewWrap.style.display = 'block';
        };
        r.readAsDataURL(f);
    };
    document.getElementById('group-chat-background-modal').style.display = 'flex';
    document.getElementById('group-chat-background-modal').style.alignItems = 'center';
    document.getElementById('group-chat-background-modal').style.justifyContent = 'center';
    document.getElementById('group-chat-plus-menu').classList.remove('show');
}

function closeGroupChatBackgroundModal() {
    document.getElementById('group-chat-background-modal').style.display = 'none';
    groupBackgroundImageTemp = null;
}

function groupChatBackgroundScaleChange(delta) {
    groupBackgroundScaleTemp = Math.max(50, Math.min(200, groupBackgroundScaleTemp + delta * 10));
    document.getElementById('group-chat-background-scale-text').textContent = groupBackgroundScaleTemp + '%';
    var preview = document.getElementById('group-chat-background-preview');
    if (preview && preview.style.backgroundImage) {
        preview.style.backgroundSize = groupBackgroundScaleTemp + '% ' + groupBackgroundScaleTemp + '%';
    }
}

function clearGroupChatBackgroundImage() {
    document.getElementById('group-chat-background-url').value = '';
    document.getElementById('group-chat-background-file').value = '';
    groupBackgroundImageTemp = null;
    groupBackgroundScaleTemp = 100;
    document.getElementById('group-chat-background-scale-text').textContent = '100%';
    var p = document.getElementById('group-chat-background-preview');
    p.style.backgroundImage = '';
    p.style.backgroundSize = '';
    document.getElementById('group-chat-background-preview-wrap').style.display = 'none';
}

function saveGroupChatBackground() {
    const group = gameState.groups && gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    var urlVal = document.getElementById('group-chat-background-url').value.trim();
    if (groupBackgroundImageTemp) {
        group.backgroundImage = groupBackgroundImageTemp;
    } else if (urlVal) {
        group.backgroundImage = urlVal;
    }
    // 未提供新图时保留原有背景
    group.backgroundScale = groupBackgroundScaleTemp;
    applyGroupChatBackground();
    closeGroupChatBackgroundModal();
    showTipModal('群聊背景图片已保存。', '保存成功');
}

// 打开上帝视角设置
function openGodViewSettings() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    const modal = document.getElementById('god-view-settings-modal');
    const toggle = document.getElementById('god-view-enable-toggle');
    const toggleSpan = document.getElementById('god-view-toggle-span');
    const wordCountInput = document.getElementById('god-view-word-count');
    
    if (toggle) {
        toggle.checked = group.enableGodView || false;
        updateGodViewToggleDisplay();
    }
    
    if (wordCountInput) {
        wordCountInput.value = group.godViewWordCount || 1000;
    }
    
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function updateGodViewEnable() {
    updateGodViewToggleDisplay();
}

function updateGodViewToggleDisplay() {
    const toggle = document.getElementById('god-view-enable-toggle');
    const toggleSpan = document.getElementById('god-view-toggle-span');
    if (toggle && toggleSpan) {
        const isEnabled = toggle.checked;
        toggleSpan.style.backgroundColor = isEnabled ? 'var(--accent)' : '#ccc';
        const toggleCircle = toggleSpan.querySelector('span');
        if (toggleCircle) {
            toggleCircle.style.transform = `translateX(${isEnabled ? '24px' : '0'})`;
        }
    }
}

function saveGodViewSettings() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    const toggle = document.getElementById('god-view-enable-toggle');
    const wordCountInput = document.getElementById('god-view-word-count');
    
    if (toggle) {
        group.enableGodView = toggle.checked;
    }
    
    if (wordCountInput) {
        const wordCount = parseInt(wordCountInput.value) || 1000;
        group.godViewWordCount = Math.max(500, Math.min(5000, wordCount));
    }
    
    closeGodViewSettingsModal();
}

function closeGodViewSettingsModal() {
    const modal = document.getElementById('god-view-settings-modal');
    modal.style.display = 'none';
}

// 保存群成员表情包设置
function saveGroupMemberEmojiSetting(npcId, canSend) {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    if (!group.memberEmojiSettings) {
        group.memberEmojiSettings = {};
    }
    group.memberEmojiSettings[npcId] = canSend;
}

function showGroupMembers() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    const modal = document.getElementById('group-members-modal');
    const membersList = document.getElementById('group-members-list');
    membersList.innerHTML = '';
    
    group.memberIds.forEach((id, idx) => {
        const memberItem = document.createElement('div');
        memberItem.style.cssText = "display:flex;align-items:center;padding:12px;margin-bottom:8px;background:rgba(225,227,237,0.5);border-radius:8px;";
        
        if (id === null) {
            // 玩家
            memberItem.innerHTML = `
                <div style="width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;margin-right:12px;">${gameState.player.name.charAt(0)}</div>
                <div style="flex:1;">
                    <div style="font-weight:bold;color:var(--text);">${group.members[0] || gameState.player.name}</div>
                    <div style="font-size:12px;color:#8E96D9;">你</div>
                </div>
                <span style="color:var(--accent);font-size:12px;">群主</span>
            `;
        } else {
            // 使用 == 允许类型转换，因为ID可能是字符串或数字
            const npc = gameState.npcs.find(n => n.id == id);
            if (npc) {
                const isAdmin = group.admins && group.admins.some(adminId => adminId == npc.id);
                memberItem.innerHTML = `
                    <div style="width:40px;height:40px;border-radius:50%;background:var(--secondary);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:bold;margin-right:12px;">${npc.name.charAt(0)}</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold;color:var(--text);">${npc.name}</div>
                        <div style="font-size:12px;color:#8E96D9;">${npc.role}</div>
                    </div>
                    ${isAdmin ? '<span style="color:var(--accent);font-size:12px;">⭐ 管理员</span>' : ''}
                `;
            } else {
                // 如果找不到NPC，显示ID（调试用）
                memberItem.innerHTML = `
                    <div style="width:40px;height:40px;border-radius:50%;background:var(--secondary);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:bold;margin-right:12px;">?</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold;color:var(--text);">未知成员</div>
                        <div style="font-size:12px;color:#8E96D9;">ID: ${id}</div>
                    </div>
                `;
            }
        }
        
        membersList.appendChild(memberItem);
    });
    
    modal.style.display = 'flex';
}

function closeGroupMembersModal() {
    document.getElementById('group-members-modal').style.display = 'none';
}

let groupSettingsMode = null; // 'add', 'remove', 'admin'

function showGroupSettings() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    if (group.owner !== gameState.player.name) {
        alert("只有群主可以设置群信息");
        return;
    }
    
    const modal = document.getElementById('group-settings-modal');
    const content = document.getElementById('group-settings-content');
    const confirmBtn = document.getElementById('confirm-group-settings-btn');
    
    content.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px;">
            <button class="btn btn-outline" onclick="setGroupSettingsMode('add')" style="width:100%;text-align:left;padding:12px;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:8px;">person_add</span>添加成员
            </button>
            <button class="btn btn-outline" onclick="setGroupSettingsMode('remove')" style="width:100%;text-align:left;padding:12px;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:8px;">person_remove</span>移除成员
            </button>
            <button class="btn btn-outline" onclick="setGroupSettingsMode('admin')" style="width:100%;text-align:left;padding:12px;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:8px;">admin_panel_settings</span>设置管理员
            </button>
            <button class="btn btn-outline" onclick="setGroupSettingsMode('emoji')" style="width:100%;text-align:left;padding:12px;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:8px;">mood</span>成员表情包设置
            </button>
            <button class="btn btn-outline" onclick="setGroupSettingsMode('emoji-manage')" style="width:100%;text-align:left;padding:12px;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:8px;">photo_library</span>管理成员表情包
            </button>
            <button class="btn btn-outline" onclick="openGodViewSettings()" style="width:100%;text-align:left;padding:12px;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:8px;">visibility</span>上帝视角设置
            </button>
        </div>
    `;
    
    confirmBtn.style.display = 'none';
    groupSettingsMode = null;
    modal.style.display = 'flex';
}

function setGroupSettingsMode(mode) {
    groupSettingsMode = mode;
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group) return;
    
    const content = document.getElementById('group-settings-content');
    const confirmBtn = document.getElementById('confirm-group-settings-btn');
    
    let title = '';
    let availableMembers = [];
    
    if (mode === 'add') {
        title = '添加成员';
        // 找出不在群里的NPC（使用宽松比较）
        availableMembers = gameState.npcs.filter(npc => !group.memberIds.some(id => id == npc.id));
    } else if (mode === 'remove') {
        title = '移除成员';
        // 找出群里的NPC（不包括玩家和群主，使用宽松比较）
        availableMembers = group.memberIds
            .map(id => id === null ? null : gameState.npcs.find(n => n.id == id))
            .filter(npc => npc !== null && npc !== undefined);
    } else if (mode === 'admin') {
        title = '设置管理员';
        // 找出群里的NPC（不包括玩家，使用宽松比较）
        availableMembers = group.memberIds
            .map(id => id === null ? null : gameState.npcs.find(n => n.id == id))
            .filter(npc => npc !== null && npc !== undefined);
    } else if (mode === 'emoji') {
        title = '成员表情包设置';
        // 找出群里的所有NPC（不包括玩家）
        availableMembers = group.memberIds
            .map(id => id === null ? null : gameState.npcs.find(n => n.id == id))
            .filter(npc => npc !== null && npc !== undefined);
    } else if (mode === 'emoji-manage') {
        title = '管理成员表情包';
        // 找出群里的所有NPC（不包括玩家）
        availableMembers = group.memberIds
            .map(id => id === null ? null : gameState.npcs.find(n => n.id == id))
            .filter(npc => npc !== null && npc !== undefined);
    }
    
    const titleEl = document.createElement('h4');
    titleEl.style.cssText = "margin-bottom:15px;";
    titleEl.textContent = title;
    
    const container = document.createElement('div');
    container.style.cssText = "max-height:300px;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;";
    
    if (availableMembers.length === 0) {
        const emptyMsg = document.createElement('p');
        emptyMsg.style.cssText = "text-align:center;color:#8E96D9;padding:20px;";
        emptyMsg.textContent = '暂无可用成员';
        container.appendChild(emptyMsg);
    } else {
        availableMembers.forEach(npc => {
            const isAdmin = group.admins && group.admins.some(adminId => adminId == npc.id);
            
            if (mode === 'emoji') {
                // 表情包设置模式：显示开关
                const canSendEmoji = group.memberEmojiSettings && group.memberEmojiSettings[npc.id] !== undefined 
                    ? group.memberEmojiSettings[npc.id] 
                    : true; // 默认允许
                
                const memberItem = document.createElement('div');
                memberItem.style.cssText = "display:flex;align-items:center;justify-content:space-between;padding:10px;margin-bottom:8px;background:rgba(225,227,237,0.3);border-radius:5px;cursor:pointer;";
                
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = "flex:1;";
                infoDiv.innerHTML = `
                    <div style="font-weight:bold;color:var(--text);">${npc.name}</div>
                    <div style="font-size:12px;color:#8E96D9;">${npc.role}</div>
                `;
                
                const toggleLabel = document.createElement('label');
                toggleLabel.style.cssText = "position:relative;display:inline-block;width:50px;height:26px;";
                
                const toggleInput = document.createElement('input');
                toggleInput.type = 'checkbox';
                toggleInput.id = `emoji-setting-${npc.id}`;
                toggleInput.checked = canSendEmoji;
                toggleInput.style.cssText = "opacity:0;width:0;height:0;";
                toggleInput.addEventListener('change', function() {
                    saveGroupMemberEmojiSetting(npc.id, this.checked);
                });
                
                const toggleSpan = document.createElement('span');
                toggleSpan.style.cssText = `position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:${canSendEmoji ? 'var(--accent)' : '#ccc'};border-radius:26px;transition:0.3s;`;
                
                const toggleSlider = document.createElement('span');
                toggleSlider.style.cssText = `position:absolute;content:'';height:20px;width:20px;left:3px;bottom:3px;background-color:white;border-radius:50%;transition:0.3s;transform:translateX(${canSendEmoji ? '24px' : '0'});`;
                
                toggleSpan.appendChild(toggleSlider);
                toggleLabel.appendChild(toggleInput);
                toggleLabel.appendChild(toggleSpan);
                
                // 点击整个item区域时切换开关状态
                memberItem.addEventListener('click', function(e) {
                    if (e.target !== toggleInput && e.target !== toggleLabel && !toggleLabel.contains(e.target)) {
                        toggleInput.checked = !toggleInput.checked;
                        toggleInput.dispatchEvent(new Event('change'));
                    }
                });
                
                memberItem.appendChild(infoDiv);
                memberItem.appendChild(toggleLabel);
                container.appendChild(memberItem);
            } else if (mode === 'emoji-manage') {
                // 表情包管理模式：显示美观的卡片式布局
                const memberItem = document.createElement('div');
                memberItem.style.cssText = "display:flex;align-items:center;padding:15px;margin-bottom:12px;background:linear-gradient(135deg, rgba(117,126,211,0.1) 0%, rgba(142,150,217,0.1) 100%);border:2px solid rgba(117,126,211,0.2);border-radius:12px;cursor:pointer;transition:all 0.3s;box-shadow: 0 2px 8px rgba(0,0,0,0.05);";
                memberItem.onmouseover = function() {
                    this.style.background = "linear-gradient(135deg, rgba(117,126,211,0.15) 0%, rgba(142,150,217,0.15) 100%)";
                    this.style.borderColor = "rgba(117,126,211,0.4)";
                    this.style.transform = "translateY(-2px)";
                    this.style.boxShadow = "0 4px 12px rgba(0,0,0,0.1)";
                };
                memberItem.onmouseout = function() {
                    this.style.background = "linear-gradient(135deg, rgba(117,126,211,0.1) 0%, rgba(142,150,217,0.1) 100%)";
                    this.style.borderColor = "rgba(117,126,211,0.2)";
                    this.style.transform = "translateY(0)";
                    this.style.boxShadow = "0 2px 8px rgba(0,0,0,0.05)";
                };
                memberItem.onclick = function() {
                    openNpcEmojiManager(npc.id);
                };
                
                // 头像
                const avatarDiv = document.createElement('div');
                avatarDiv.style.cssText = "width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:20px;margin-right:15px;flex-shrink:0;box-shadow: 0 2px 6px rgba(117,126,211,0.3);";
                avatarDiv.textContent = npc.name.charAt(0);
                
                // 信息区域
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = "flex:1;min-width:0;";
                const emojiCount = npc.emojis ? npc.emojis.length : 0;
                infoDiv.innerHTML = `
                    <div style="font-weight:bold;color:var(--text);font-size:16px;margin-bottom:4px;display:flex;align-items:center;gap:8px;">
                        ${npc.name}
                        ${isAdmin ? '<span style="color:var(--accent);font-size:14px;">⭐</span>' : ''}
                    </div>
                    <div style="font-size:13px;color:#8E96D9;margin-bottom:6px;">${npc.role}</div>
                    <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--accent);">
                        <span class="material-icons" style="font-size:16px;">mood</span>
                        <span>${emojiCount}个表情包</span>
                    </div>
                `;
                
                // 管理按钮图标
                const manageIcon = document.createElement('div');
                manageIcon.style.cssText = "width:36px;height:36px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:white;flex-shrink:0;transition:all 0.3s;";
                manageIcon.innerHTML = '<span class="material-icons" style="font-size:20px;">edit</span>';
                
                memberItem.appendChild(avatarDiv);
                memberItem.appendChild(infoDiv);
                memberItem.appendChild(manageIcon);
                container.appendChild(memberItem);
            } else {
                // 其他模式：显示复选框
                const memberItem = document.createElement('div');
                memberItem.style.cssText = "display:flex;align-items:center;padding:10px;margin-bottom:8px;background:rgba(225,227,237,0.3);border-radius:5px;cursor:pointer;";
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `settings-member-${npc.id}`;
                checkbox.value = npc.id;
                checkbox.style.cssText = "width:18px;height:18px;margin-right:12px;cursor:pointer;flex-shrink:0;";
                
                // 如果是设置管理员模式，已管理员默认选中（可以取消）
                if (mode === 'admin' && isAdmin) {
                    checkbox.checked = true;
                }
                
                const label = document.createElement('label');
                label.htmlFor = `settings-member-${npc.id}`;
                label.style.cssText = "flex:1;cursor:pointer;margin:0;display:flex;align-items:center;white-space:nowrap;";
                label.innerHTML = `
                    <span style="font-weight:bold;color:var(--text);margin-right:8px;">${npc.name}</span>
                    <span style="color:#8E96D9;font-size:12px;">${npc.role}</span>
                    ${isAdmin ? '<span style="color:var(--accent);font-size:12px;margin-left:8px;">⭐ 管理员</span>' : ''}
                `;
                
                // 点击整个item区域时切换checkbox状态
                memberItem.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox' && e.target.tagName !== 'LABEL') {
                        checkbox.checked = !checkbox.checked;
                    }
                });
                
                memberItem.appendChild(checkbox);
                memberItem.appendChild(label);
                container.appendChild(memberItem);
            }
        });
    }
    
    // 清空并重新填充内容
    content.innerHTML = '';
    content.appendChild(titleEl);
    content.appendChild(container);
    if (mode === 'emoji' || mode === 'emoji-manage') {
        // 表情包设置模式和管理模式不需要确认按钮
        confirmBtn.style.display = 'none';
    } else {
        confirmBtn.style.display = availableMembers.length > 0 ? 'block' : 'none';
    }
}

// 打开NPC表情包管理界面
function openNpcEmojiManager(npcId) {
    const npc = gameState.npcs.find(n => n.id === npcId);
    if (!npc) {
        alert('找不到该成员');
        return;
    }
    
    // 关闭群设置模态框
    const groupSettingsModal = document.getElementById('group-settings-modal');
    if (groupSettingsModal) {
        groupSettingsModal.style.display = 'none';
    }
    
    // 设置当前编辑的NPC（重要：先设置这个）
    currentEditingNpcId = npcId;
    // 临时设置chatTargetId，用于表情包界面识别
    const originalChatTargetId = gameState.chatTargetId;
    const originalGroupId = currentGroupId;
    gameState.chatTargetId = npcId;
    // 临时清除currentGroupId，确保不会进入群聊模式
    currentGroupId = null;
    
    // 打开表情包模态框，只显示该NPC的表情包（不显示标签页）
    const modal = document.getElementById('emoji-modal');
    const tabsDiv = document.getElementById('emoji-tabs');
    const titleEl = document.getElementById('emoji-modal-title');
    
    if (!modal || !tabsDiv || !titleEl) {
        alert('表情包界面初始化失败');
        gameState.chatTargetId = originalChatTargetId;
        currentGroupId = originalGroupId;
        currentEditingNpcId = null;
        return;
    }
    
    // 隐藏标签页，只显示该NPC的表情包
    tabsDiv.style.display = 'none';
    titleEl.innerHTML = `<span class="material-icons" style="font-size:20px;vertical-align:middle;margin-right:4px;">mood</span>${npc.name}的表情包`;
    currentEmojiTab = 'other';
    
    modal.style.display = 'flex';
    
    // 确保表情包列表正确渲染
    setTimeout(() => {
        renderEmojiGrid();
    }, 50);
}

function closeGroupSettingsModal() {
    document.getElementById('group-settings-modal').style.display = 'none';
    groupSettingsMode = null;
}

function confirmGroupSettings() {
    const group = gameState.groups.find(g => g.id === currentGroupId);
    if (!group || !groupSettingsMode) return;
    
    // 如果是表情包设置模式，单独处理
    if (groupSettingsMode === 'emoji') {
        if (!group.memberEmojiSettings) group.memberEmojiSettings = {};
        const emojiCheckboxes = document.querySelectorAll('#group-settings-content input[type="checkbox"]');
        emojiCheckboxes.forEach(cb => {
            const npcId = cb.id.replace('emoji-setting-', '');
            group.memberEmojiSettings[npcId] = cb.checked;
        });
        closeGroupSettingsModal();
        return;
    }
    
    const checked = document.querySelectorAll('#group-settings-content input[type="checkbox"]:checked');
    const selectedIds = Array.from(checked).map(cb => cb.value);
    
    // 设置管理员模式允许不选择任何成员（取消所有管理员）
    if (selectedIds.length === 0 && groupSettingsMode !== 'admin') {
        return; // 不显示弹窗，直接返回
    }
    
    if (groupSettingsMode === 'add') {
        let addedCount = 0;
        selectedIds.forEach(id => {
            // 使用宽松比较检查是否已存在
            if (!group.memberIds.some(mid => mid == id)) {
                group.memberIds.push(id);
                // 同步更新members数组
                const npc = gameState.npcs.find(n => n.id == id);
                if (npc && !group.members.includes(npc.name)) {
                    group.members.push(npc.name);
                }
                // 初始化表情包设置（默认允许）
                if (!group.memberEmojiSettings) group.memberEmojiSettings = {};
                group.memberEmojiSettings[id] = true;
                addedCount++;
            }
        });
        // 已添加成员，不显示弹窗
    } else if (groupSettingsMode === 'remove') {
        selectedIds.forEach(id => {
            // 使用宽松比较查找并移除
            const index = group.memberIds.findIndex(mid => mid == id);
            if (index > -1) {
                group.memberIds.splice(index, 1);
                // 同步更新members数组
                const npc = gameState.npcs.find(n => n.id == id);
                if (npc) {
                    const memberIndex = group.members.indexOf(npc.name);
                    if (memberIndex > -1) {
                        group.members.splice(memberIndex, 1);
                    }
                }
            }
            // 同时移除管理员身份
            if (group.admins) {
                const adminIndex = group.admins.findIndex(adminId => adminId == id);
                if (adminIndex > -1) {
                    group.admins.splice(adminIndex, 1);
                }
            }
        });
        // 已移除成员，不显示弹窗
    } else if (groupSettingsMode === 'admin') {
        if (!group.admins) group.admins = [];
        
        // 获取所有成员ID（包括当前管理员）
        const allMemberIds = group.memberIds.filter(id => id !== null);
        
        // 遍历所有成员，根据checkbox状态设置或取消管理员
        allMemberIds.forEach(id => {
            const checkbox = document.getElementById(`settings-member-${id}`);
            if (checkbox) {
                const isChecked = checkbox.checked;
                const isCurrentlyAdmin = group.admins.some(adminId => adminId == id);
                
                if (isChecked && !isCurrentlyAdmin) {
                    // 设置为管理员
                    group.admins.push(id);
                } else if (!isChecked && isCurrentlyAdmin) {
                    // 取消管理员
                    const adminIndex = group.admins.findIndex(adminId => adminId == id);
                    if (adminIndex > -1) {
                        group.admins.splice(adminIndex, 1);
                    }
                }
            }
        });
        // 已设置/取消管理员，不显示弹窗
    }
    
    renderGroupChat();
    closeGroupSettingsModal();
}

let currentPostId = null;

function renderPosts() {
    applyPostsPageBackground();
    const container = document.getElementById('posts-container');
    container.innerHTML = "";
    
    // 更新当前动态圈名称显示
    const circleNameEl = document.getElementById('current-circle-name');
    if (circleNameEl) {
        if (gameState.currentSocialCircleId === null) {
            circleNameEl.textContent = '默认动态圈';
        } else {
            const circle = gameState.socialCircles.find(c => c.id === gameState.currentSocialCircleId);
            circleNameEl.textContent = circle ? circle.name : '默认动态圈';
        }
    }
    
    // 根据当前动态圈获取动态
    let allPosts = [];
    if (gameState.currentSocialCircleId === null) {
        // 默认动态圈：显示所有动态
        allPosts = [...gameState.socialPosts];
        // 添加NPC发布的动态
        gameState.npcs.forEach(npc => {
            if (npc.socialPosts) {
                allPosts.push(...npc.socialPosts);
            }
        });
    } else {
        // 特定动态圈：只显示该动态圈的动态
        const circle = gameState.socialCircles.find(c => c.id === gameState.currentSocialCircleId);
        if (circle) {
            allPosts = [...(circle.posts || [])];
            // 添加该动态圈成员（NPC）发布的动态
            circle.members.forEach(memberId => {
                const npc = gameState.npcs.find(n => n.id == memberId);
                if (npc && npc.socialPosts) {
                    // 只添加属于当前动态圈的动态
                    npc.socialPosts.forEach(post => {
                        if (post.circleId === circle.id) {
                            allPosts.push(post);
                        }
                    });
                }
            });
        }
    }
    
    allPosts.sort((a, b) => {
        const dateA = a.date.split('-').map(Number);
        const dateB = b.date.split('-').map(Number);
        return dateB[0] - dateA[0] || dateB[1] - dateA[1] || dateB[2] - dateA[2];
    });
    
    if (allPosts.length === 0) {
        container.innerHTML = "<p style='text-align:center;color:#8E96D9;padding:20px;'>暂无动态</p>";
        return;
    }
    
    allPosts.forEach(post => {
        const card = document.createElement('div');
        card.style.cssText = `
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        `;
        card.onmouseenter = function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
        };
        card.onmouseleave = function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
        };
        
        const liked = post.likedBy && post.likedBy.includes(gameState.player.name);
        const commentsList = post.commentsList || [];
        
        card.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div style="width:40px;height:40px;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;flex-shrink:0;">
                    ${post.author.charAt(0)}
                </div>
                <div style="flex:1;">
                    <div style="font-weight:600;font-size:15px;color:var(--text);margin-bottom:2px;">${post.author}</div>
                    <div style="font-size:12px;color:var(--text);opacity:0.6;">${post.date}</div>
                </div>
            </div>
            ${post.content ? `<div style="color:var(--text);font-size:14px;line-height:1.6;margin-bottom:${post.image ? '12px' : '0'};white-space:pre-wrap;word-wrap:break-word;">${post.content}</div>` : ''}
            ${post.image ? `
                <div style="margin:${post.content ? '12px' : '0'} 0;border-radius:8px;overflow:hidden;">
                    <img src="${post.image.replace(/'/g, "\\'")}" style="width:100%;max-height:400px;object-fit:cover;display:block;cursor:pointer;" onclick="showPostImageModal(${JSON.stringify(post.image)})" />
                </div>
            ` : ''}
            <div style="display:flex;gap:20px;margin-top:16px;padding-top:12px;border-top:1px solid rgba(0,0,0,0.08);">
                <button class="btn" style="flex:1;padding:8px;font-size:13px;background:${liked ? 'var(--accent)' : 'transparent'};color:${liked ? 'white' : 'var(--text)'};border:1px solid ${liked ? 'var(--accent)' : 'var(--secondary)'};border-radius:6px;" onclick="likePost(${post.id})">
                    <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">thumb_up</span>${post.likes || 0}
                </button>
                <button class="btn" style="flex:1;padding:8px;font-size:13px;background:transparent;color:var(--text);border:1px solid var(--secondary);border-radius:6px;" onclick="showPostComments(${post.id})">
                    <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">comment</span>${commentsList.length}
                </button>
                <button class="btn" style="flex:1;padding:8px;font-size:13px;background:transparent;color:var(--text);border:1px solid var(--secondary);border-radius:6px;" onclick="sharePost(${post.id})">
                    <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:4px;">share</span>分享
                </button>
            </div>
            ${commentsList.length > 0 ? `
                <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,0.08);background:rgba(0,0,0,0.02);border-radius:6px;padding:10px;">
                    ${commentsList.slice(0, 3).map((c, idx) => `
                        <div style="font-size:13px;margin:6px 0;line-height:1.5;padding:8px;border-radius:6px;background:white;transition:background 0.2s;" onmouseenter="this.style.background='rgba(117,126,211,0.1)'" onmouseleave="this.style.background='white'">
                            <div style="display:flex;align-items:flex-start;gap:8px;">
                                <div style="flex:1;">
                                    <span style="font-weight:600;color:var(--primary);cursor:pointer;" onclick="showPostReplyModal(${post.id}, ${idx}, '${c.author.replace(/'/g, "\\'")}', null)">${c.author}</span>
                                    ${c.replyTo ? `<span style="color:var(--text);opacity:0.6;">回复</span> <span style="font-weight:600;color:var(--primary);cursor:pointer;" onclick="showPostReplyModal(${post.id}, ${idx}, '${c.replyTo.replace(/'/g, "\\'")}', '${c.author.replace(/'/g, "\\'")}')">${c.replyTo}</span>` : ''}
                                    <span style="color:var(--text);opacity:0.8;">: ${c.content}</span>
                                </div>
                                <button class="icon-btn" onclick="showPostReplyModal(${post.id}, ${idx}, '${c.author.replace(/'/g, "\\'")}', null)" style="font-size:12px;padding:4px 8px;color:var(--text);opacity:0.6;border:1px solid var(--secondary);border-radius:4px;">回复</button>
                            </div>
                            ${c.replies && c.replies.length > 0 ? `
                                <div style="margin-top:8px;padding-left:12px;border-left:2px solid var(--secondary);">
                                    ${c.replies.map(r => `
                                        <div style="font-size:12px;margin:4px 0;padding:6px;background:rgba(0,0,0,0.03);border-radius:4px;">
                                            <span style="font-weight:600;color:var(--primary);cursor:pointer;" onclick="showPostReplyModal(${post.id}, ${idx}, '${r.author.replace(/'/g, "\\'")}', null)">${r.author}</span>
                                            ${r.replyTo ? `<span style="color:var(--text);opacity:0.6;">回复</span> <span style="font-weight:600;color:var(--primary);cursor:pointer;" onclick="showPostReplyModal(${post.id}, ${idx}, '${r.replyTo.replace(/'/g, "\\'")}', '${r.author.replace(/'/g, "\\'")}')">${r.replyTo}</span>` : ''}
                                            <span style="color:var(--text);opacity:0.8;">: ${r.content}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                    ${commentsList.length > 3 ? `<div style="font-size:12px;color:var(--text);opacity:0.6;margin-top:6px;cursor:pointer;" onclick="showPostComments(${post.id})">查看全部 ${commentsList.length} 条评论</div>` : ''}
                </div>
            ` : ''}
        `;
        container.appendChild(card);
    });
}

let pendingPostImage = null;

function showCreatePostModal() {
    document.getElementById('create-post-modal').style.display = 'flex';
    document.getElementById('post-content-input').value = '';
    document.getElementById('post-char-count').textContent = '0';
    document.getElementById('post-image-preview').style.display = 'none';
    document.getElementById('post-image-input').value = '';
    pendingPostImage = null;
    
    // 监听字符数变化
    document.getElementById('post-content-input').addEventListener('input', function() {
        document.getElementById('post-char-count').textContent = this.value.length;
    });
}

function closeCreatePostModal() {
    document.getElementById('create-post-modal').style.display = 'none';
    document.getElementById('post-content-input').value = '';
    document.getElementById('post-image-preview').style.display = 'none';
    document.getElementById('post-image-input').value = '';
    pendingPostImage = null;
}

function handlePostImageSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        alert('请选择图片文件');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = e.target.result;
        document.getElementById('post-image-preview-img').src = imageData;
        document.getElementById('post-image-preview').style.display = 'block';
        pendingPostImage = imageData;
    };
    reader.readAsDataURL(file);
}

function removePostImage() {
    document.getElementById('post-image-preview').style.display = 'none';
    document.getElementById('post-image-input').value = '';
    pendingPostImage = null;
}

function confirmCreatePost() {
    const content = document.getElementById('post-content-input').value.trim();
    if (!content && !pendingPostImage) {
        alert('请输入内容或添加图片');
        return;
    }
    
    const post = {
        id: Date.now(),
        author: gameState.player.name,
        content: content || '',
        image: pendingPostImage || null,
        date: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`,
        likes: 0,
        likedBy: [],
        comments: 0,
        commentsList: [],
        shares: 0,
        circleId: gameState.currentSocialCircleId // 记录所属动态圈
    };
    
    // 朋友圈禁止重复：同一内容最多出现1次
    const targetPosts = gameState.currentSocialCircleId === null ? gameState.socialPosts : (gameState.socialCircles.find(c => c.id === gameState.currentSocialCircleId)?.posts || []);
    const sameContentCount = targetPosts.filter(p => (p.content || '').trim() === (content || '').trim()).length;
    if (sameContentCount >= 1) return; // 已有相同内容，不添加
    
    // 根据当前动态圈保存动态
    if (gameState.currentSocialCircleId === null) {
        // 默认动态圈
        gameState.socialPosts.push(post);
    } else {
        // 特定动态圈
        const circle = gameState.socialCircles.find(c => c.id === gameState.currentSocialCircleId);
        if (circle) {
            if (!circle.posts) {
                circle.posts = [];
            }
            circle.posts.push(post);
        } else {
            // 如果动态圈不存在，保存到默认动态圈
            gameState.socialPosts.push(post);
        }
    }
    
    gameState.player.socialInfluence = (gameState.player.socialInfluence || 0) + 5;
    updateSocialLevelFromInfluence();
    renderPosts();
    closeCreatePostModal();
    
    // 不再自动点赞和评论，需要用户点击刷新按钮
}

// 获取所有动态（包括动态圈中的）
function getAllPosts() {
    let allPosts = [];
    
    // 默认动态圈的动态
    allPosts = [...gameState.socialPosts];
    
    // 动态圈中的动态
    if (gameState.socialCircles) {
        gameState.socialCircles.forEach(circle => {
            if (circle.posts) {
                allPosts.push(...circle.posts);
            }
        });
    }
    
    // NPC发布的动态
    gameState.npcs.forEach(npc => {
        if (npc.socialPosts) {
            allPosts.push(...npc.socialPosts);
        }
    });
    
    return allPosts;
}

function likePost(postId, liker = null) {
    const allPosts = getAllPosts();
    const post = allPosts.find(p => p.id === postId);
    if (!post) return;
    
    const likerName = liker || gameState.player.name;
    if (!post.likedBy) post.likedBy = [];
    
    if (post.likedBy.includes(likerName)) {
        post.likedBy = post.likedBy.filter(n => n !== likerName);
        post.likes = Math.max(0, (post.likes || 0) - 1);
    } else {
        post.likedBy.push(likerName);
        post.likes = (post.likes || 0) + 1;
    }
    
    renderPosts();
}

let currentReplyCommentIndex = null;
let currentReplyTarget = null;

function showPostComments(postId) {
    const allPosts = getAllPosts();
    const post = allPosts.find(p => p.id === postId);
    if (!post) return;
    
    currentPostId = postId;
    currentReplyCommentIndex = null;
    currentReplyTarget = null;
    
    const commentsList = document.getElementById('post-comments-list');
    const comments = post.commentsList || [];
    
    if (comments.length === 0) {
        commentsList.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text);opacity:0.5;">暂无评论，快来抢沙发吧~</div>';
    } else {
        commentsList.innerHTML = comments.map((c, idx) => `
            <div style="padding:12px;margin-bottom:12px;background:white;border-radius:8px;border:1px solid rgba(0,0,0,0.08);">
                <div style="display:flex;align-items:flex-start;gap:10px;">
                    <div style="width:32px;height:32px;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px;flex-shrink:0;">
                        ${c.author.charAt(0)}
                    </div>
                    <div style="flex:1;">
                        <div style="margin-bottom:6px;">
                            <span style="font-weight:600;color:var(--primary);font-size:14px;">${c.author}</span>
                            ${c.replyTo ? `<span style="color:var(--text);opacity:0.6;font-size:13px;">回复</span> <span style="font-weight:600;color:var(--primary);font-size:13px;">${c.replyTo}</span>` : ''}
                            <span style="color:var(--text);opacity:0.6;font-size:12px;margin-left:8px;">${c.date || ''}</span>
                        </div>
                        <div style="color:var(--text);font-size:14px;line-height:1.6;margin-bottom:8px;">${c.content}</div>
                        <button class="btn" onclick="showPostReplyModal(${postId}, ${idx}, '${c.author.replace(/'/g, "\\'")}', null)" style="padding:4px 12px;font-size:12px;background:transparent;color:var(--text);opacity:0.7;border:1px solid var(--secondary);border-radius:4px;">回复</button>
                        ${c.replies && c.replies.length > 0 ? `
                            <div style="margin-top:10px;padding-left:12px;border-left:2px solid var(--secondary);">
                                ${c.replies.map((r, ridx) => `
                                    <div style="padding:8px;margin-bottom:6px;background:rgba(0,0,0,0.03);border-radius:6px;">
                                        <div style="margin-bottom:4px;">
                                            <span style="font-weight:600;color:var(--primary);font-size:13px;">${r.author}</span>
                                            ${r.replyTo ? `<span style="color:var(--text);opacity:0.6;font-size:12px;">回复</span> <span style="font-weight:600;color:var(--primary);font-size:12px;">${r.replyTo}</span>` : ''}
                                        </div>
                                        <div style="color:var(--text);font-size:13px;line-height:1.5;">${r.content}</div>
                                        <button class="btn" onclick="showPostReplyModal(${postId}, ${idx}, '${r.author.replace(/'/g, "\\'")}', null)" style="padding:2px 8px;font-size:11px;background:transparent;color:var(--text);opacity:0.6;border:none;margin-top:4px;">回复</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    document.getElementById('post-comment-input').value = '';
    document.getElementById('post-comments-modal').style.display = 'flex';
    document.getElementById('post-comment-input').focus();
}

function closePostCommentsModal() {
    document.getElementById('post-comments-modal').style.display = 'none';
    currentPostId = null;
    currentReplyCommentIndex = null;
    currentReplyTarget = null;
}

function addPostComment() {
    const input = document.getElementById('post-comment-input');
    const content = input.value.trim();
    if (!content) return;
    
    commentPost(currentPostId, gameState.player.name, content);
    input.value = '';
    showPostComments(currentPostId);
}

function commentPost(postId, author, content = null, replyTo = null, commentIndex = null) {
    const allPosts = getAllPosts();
    const post = allPosts.find(p => p.id === postId);
    if (!post) return;
    
    if (!post.commentsList) post.commentsList = [];
    
    if (!content) {
        const comments = ["不错", "有意思", "我也这么想", "有道理"];
        content = comments[Math.floor(Math.random() * comments.length)];
    }
    
    const commentData = {
        author: author,
        content: content,
        date: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`,
        replyTo: replyTo || null,
        replies: []
    };
    
    // 如果是回复，添加到对应评论的replies中
    if (commentIndex !== null && commentIndex >= 0 && commentIndex < post.commentsList.length) {
        if (!post.commentsList[commentIndex].replies) {
            post.commentsList[commentIndex].replies = [];
        }
        post.commentsList[commentIndex].replies.push(commentData);
    } else {
        // 否则添加为新评论
        post.commentsList.push(commentData);
        post.comments = (post.comments || 0) + 1;
    }
    
    renderPosts();
}

function showPostReplyModal(postId, commentIndex, targetAuthor, currentAuthor) {
    currentPostId = postId;
    currentReplyCommentIndex = commentIndex;
    currentReplyTarget = targetAuthor;
    
    const targetEl = document.getElementById('post-reply-target');
    if (currentAuthor) {
        targetEl.innerHTML = `回复 <span style="font-weight:600;color:var(--primary);">${targetAuthor}</span> 的评论（由 <span style="font-weight:600;color:var(--primary);">${currentAuthor}</span> 发起）`;
    } else {
        targetEl.innerHTML = `回复 <span style="font-weight:600;color:var(--primary);">${targetAuthor}</span>`;
    }
    
    document.getElementById('post-reply-input').value = '';
    document.getElementById('post-reply-char-count').textContent = '0';
    document.getElementById('post-reply-modal').style.display = 'flex';
    
    // 监听字符数变化
    document.getElementById('post-reply-input').addEventListener('input', function() {
        document.getElementById('post-reply-char-count').textContent = this.value.length;
    });
    
    document.getElementById('post-reply-input').focus();
}

function closePostReplyModal() {
    document.getElementById('post-reply-modal').style.display = 'none';
    currentReplyCommentIndex = null;
    currentReplyTarget = null;
}

function confirmPostReply() {
    const input = document.getElementById('post-reply-input');
    const content = input.value.trim();
    if (!content) {
        alert('请输入回复内容');
        return;
    }
    
    commentPost(currentPostId, gameState.player.name, content, currentReplyTarget, currentReplyCommentIndex);
    closePostReplyModal();
    if (document.getElementById('post-comments-modal').style.display === 'flex') {
        showPostComments(currentPostId);
    }
}

let shareSelectedContacts = [];
let shareSelectedGroups = [];
let currentSharePostId = null;

function sharePost(postId) {
    const allPosts = getAllPosts();
    currentSharePostId = postId;
    shareSelectedContacts = [];
    shareSelectedGroups = [];
    
    // 渲染好友列表
    const contactsList = document.getElementById('share-contacts-list');
    contactsList.innerHTML = '';
    gameState.npcs.forEach(npc => {
        const item = document.createElement('div');
        item.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px;background:white;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all 0.2s;';
        item.onmouseenter = function() {
            this.style.background = 'rgba(117,126,211,0.1)';
        };
        item.onmouseleave = function() {
            if (!shareSelectedContacts.includes(npc.id)) {
                this.style.background = 'white';
                this.style.borderColor = 'transparent';
            }
        };
        item.onclick = function() {
            const index = shareSelectedContacts.indexOf(npc.id);
            if (index > -1) {
                shareSelectedContacts.splice(index, 1);
                this.style.background = 'white';
                this.style.borderColor = 'transparent';
            } else {
                shareSelectedContacts.push(npc.id);
                this.style.background = 'rgba(117,126,211,0.2)';
                this.style.borderColor = 'var(--primary)';
            }
            updateShareSelectedCount();
        };
        
        item.innerHTML = `
            <div style="width:36px;height:36px;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px;flex-shrink:0;">
                ${npc.name.charAt(0)}
            </div>
            <div style="flex:1;">
                <div style="font-weight:500;font-size:14px;color:var(--text);">${npc.name}</div>
                <div style="font-size:12px;color:var(--text);opacity:0.6;">${npc.role}</div>
            </div>
            <span class="material-icons" style="font-size:20px;color:var(--primary);display:none;" id="share-contact-check-${npc.id}">check_circle</span>
        `;
        contactsList.appendChild(item);
    });
    
    // 渲染群聊列表
    const groupsList = document.getElementById('share-groups-list');
    groupsList.innerHTML = '';
    if (gameState.groups && gameState.groups.length > 0) {
        gameState.groups.forEach(group => {
            const item = document.createElement('div');
            item.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px;background:white;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all 0.2s;';
            item.onmouseenter = function() {
                this.style.background = 'rgba(117,126,211,0.1)';
            };
            item.onmouseleave = function() {
                if (!shareSelectedGroups.includes(group.id)) {
                    this.style.background = 'white';
                    this.style.borderColor = 'transparent';
                }
            };
            item.onclick = function() {
                const index = shareSelectedGroups.indexOf(group.id);
                if (index > -1) {
                    shareSelectedGroups.splice(index, 1);
                    this.style.background = 'white';
                    this.style.borderColor = 'transparent';
                    document.getElementById(`share-group-check-${group.id}`).style.display = 'none';
                } else {
                    shareSelectedGroups.push(group.id);
                    this.style.background = 'rgba(117,126,211,0.2)';
                    this.style.borderColor = 'var(--primary)';
                    document.getElementById(`share-group-check-${group.id}`).style.display = 'inline';
                }
                updateShareSelectedCount();
            };
            
            item.innerHTML = `
                <div style="width:36px;height:36px;background:linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px;flex-shrink:0;">
                    <span class="material-icons" style="font-size:20px;">group</span>
                </div>
                <div style="flex:1;">
                    <div style="font-weight:500;font-size:14px;color:var(--text);">${group.name}</div>
                    <div style="font-size:12px;color:var(--text);opacity:0.6;">${group.memberIds ? group.memberIds.length : 0} 位成员</div>
                </div>
                <span class="material-icons" style="font-size:20px;color:var(--primary);display:none;" id="share-group-check-${group.id}">check_circle</span>
            `;
            groupsList.appendChild(item);
        });
    } else {
        groupsList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text);opacity:0.5;font-size:13px;">暂无群聊</div>';
    }
    
    updateShareSelectedCount();
    document.getElementById('share-select-modal').style.display = 'flex';
}

function updateShareSelectedCount() {
    const total = shareSelectedContacts.length + shareSelectedGroups.length;
    document.getElementById('share-selected-count').textContent = total;
    
    // 更新选中标记
    shareSelectedContacts.forEach(id => {
        const check = document.getElementById(`share-contact-check-${id}`);
        if (check) check.style.display = 'inline';
    });
    shareSelectedGroups.forEach(id => {
        const check = document.getElementById(`share-group-check-${id}`);
        if (check) check.style.display = 'inline';
    });
}

function closeShareSelectModal() {
    document.getElementById('share-select-modal').style.display = 'none';
    shareSelectedContacts = [];
    shareSelectedGroups = [];
    currentSharePostId = null;
}

/**
 * 显示地图事件弹窗
 */
function showLocationEventModal(data) {
    const modal = document.getElementById('location-event-modal');
    const titleEl = document.getElementById('location-event-modal-title');
    const storyEl = document.getElementById('location-event-modal-story');
    const eventTypeEl = document.getElementById('location-event-modal-event-type');
    const personEl = document.getElementById('location-event-modal-person');
    const rewardsEl = document.getElementById('location-event-modal-rewards');
    
    // 设置标题
    titleEl.textContent = data.locationName || '地图事件';
    
    // 设置剧情描述
    storyEl.textContent = data.story || '';
    
    // 设置事件类型
    if (data.eventType) {
        eventTypeEl.innerHTML = `
            <div style="background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;padding:12px 16px;border-radius:12px;font-size:14px;font-weight:600;">
                <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:6px;">category</span>
                【事件类型】${data.eventType}
            </div>
        `;
    } else {
        eventTypeEl.innerHTML = '';
    }
    
    // 设置遇到的人
    if (data.person) {
        personEl.innerHTML = `
            <div style="background:var(--secondary);padding:16px;border-radius:12px;border-left:4px solid var(--accent);">
                <div style="color:var(--accent);font-size:14px;font-weight:600;margin-bottom:12px;">
                    <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:6px;">person</span>
                    【遇到的人】${data.person.name}（${data.person.role}）
                </div>
                <div style="color:var(--text);font-size:13px;line-height:1.6;margin-bottom:8px;">
                    <strong style="color:var(--primary);">性格：</strong>${data.person.personality}
                </div>
                <div style="color:var(--text);font-size:13px;line-height:1.6;margin-bottom:8px;">
                    <strong style="color:var(--primary);">外貌：</strong>${data.person.appearance}
                </div>
                <div style="color:var(--text);font-size:13px;line-height:1.6;">
                    <strong style="color:var(--primary);">背景：</strong>${data.person.background}
                </div>
            </div>
        `;
    } else {
        personEl.innerHTML = '';
    }
    
    // 设置奖励
    const hasAttrRewards = data.rewards && Object.entries(data.rewards)
        .filter(([k]) => !['items','clothes'].includes(k))
        .some(([k, v]) => v !== 0 && v !== null && !Array.isArray(v));
    const hasItems = data.rewards && data.rewards.items && Array.isArray(data.rewards.items) && data.rewards.items.length > 0;
    const hasClothes = data.rewards && data.rewards.clothes && typeof data.rewards.clothes === 'number';
    if (hasAttrRewards || hasItems || hasClothes) {
        const rewardParts = [];
        if (hasAttrRewards) {
            const attrItems = Object.entries(data.rewards)
                .filter(([k, v]) => !['items','clothes'].includes(k) && v !== 0 && v !== null && !Array.isArray(v))
                .map(([k, v]) => {
                    const names = { money: "银两", fame: "声望", charm: "容貌", elegance: "气质", attraction: "魅力", wisdom: "才学", martial: "武艺", energy: "体力", affection: "皇帝好感", pregnancy: "喜得龙嗣" };
                    const icons = { money: "💰", fame: "⭐", charm: "💄", elegance: "✨", attraction: "🎭", wisdom: "📚", martial: "⚔️", energy: "⚡", affection: "💕", pregnancy: "🎉" };
                    return `<span style="display:inline-block;background:rgba(117,126,211,0.1);color:var(--primary);padding:6px 12px;border-radius:8px;margin-right:8px;margin-bottom:8px;font-size:13px;font-weight:600;">${icons[k] || ''} ${names[k] || k}+${v}</span>`;
                })
                .join('');
            if (attrItems) rewardParts.push(attrItems);
        }
        if (hasItems) {
            rewardParts.push(`<span style="display:inline-block;background:rgba(117,126,211,0.1);color:var(--primary);padding:6px 12px;border-radius:8px;margin-right:8px;margin-bottom:8px;font-size:13px;font-weight:600;">🎁 ${data.rewards.items.join('、')}</span>`);
        }
        if (hasClothes) {
            const cloth = gameState.clothes && gameState.clothes.find(function(c) { return c.id === data.rewards.clothes; });
            const clothName = cloth ? cloth.name : '服装';
            rewardParts.push(`<span style="display:inline-block;background:rgba(117,126,211,0.1);color:var(--primary);padding:6px 12px;border-radius:8px;margin-right:8px;margin-bottom:8px;font-size:13px;font-weight:600;">👗 ${clothName}</span>`);
        }
        
        rewardsEl.innerHTML = `
            <div style="background:linear-gradient(135deg, rgba(117,126,211,0.1) 0%, rgba(142,150,217,0.1) 100%);padding:16px;border-radius:12px;border:1px solid var(--accent);">
                <div style="color:var(--accent);font-size:14px;font-weight:600;margin-bottom:12px;">
                    <span class="material-icons" style="font-size:18px;vertical-align:middle;margin-right:6px;">stars</span>
                    【获得奖励】
                </div>
                <div style="display:flex;flex-wrap:wrap;">
                    ${rewardParts.join('')}
                </div>
            </div>
        `;
    } else {
        rewardsEl.innerHTML = '';
    }
    
    // 显示技能经验增加提示
    if (data.skillExpGain && data.skillExpGain.skillName && data.skillExpGain.exp) {
        const tipEl = document.createElement('div');
        tipEl.style.cssText = 'color:var(--accent);font-size:13px;font-weight:600;margin-top:12px;padding:10px 14px;background:rgba(117,126,211,0.15);border-radius:8px;border-left:4px solid var(--primary);';
        tipEl.innerHTML = '📈 ' + data.skillExpGain.skillName + ' 经验 +' + data.skillExpGain.exp;
        rewardsEl.parentElement.appendChild(tipEl);
    }
    
    // 移除旧的提示信息（人脉、技能经验等）
    let oldTip = rewardsEl.nextElementSibling;
    while (oldTip && (oldTip.textContent.includes('人脉') || oldTip.textContent.includes('经验 +'))) {
        oldTip.remove();
        oldTip = rewardsEl.nextElementSibling;
    }
    
    // 显示提示信息
    if (data.person) {
        const tipEl = document.createElement('div');
        tipEl.style.cssText = 'color:var(--accent);font-size:12px;margin-top:16px;text-align:center;padding:8px;background:rgba(117,126,211,0.1);border-radius:8px;';
        tipEl.innerHTML = '<span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:4px;">info</span>可以到"人脉"页面查看并对话';
        rewardsEl.parentElement.appendChild(tipEl);
    }
    
    modal.style.display = 'flex';
}

/** 对食选择：暂存 branches + baseData，选择后展示对应剧情 */
var pendingDuishiData = null;

function showDuishiChoiceModal(branches, baseData) {
    pendingDuishiData = { branches: branches, baseData: baseData };
    var titleEl = document.getElementById('duishi-choice-modal-title');
    if (titleEl) titleEl.textContent = (baseData && baseData.eventType && baseData.eventType.indexOf('磨豆腐') >= 0) ? '你发现了磨豆腐场景' : '你发现了对食场景';
    var modal = document.getElementById('duishi-choice-modal');
    if (modal) modal.style.display = 'flex';
}

function closeDuishiChoiceModal() {
    pendingDuishiData = null;
    var modal = document.getElementById('duishi-choice-modal');
    if (modal) modal.style.display = 'none';
}

function onDuishiChoice(key) {
    if (!pendingDuishiData || !pendingDuishiData.branches || !pendingDuishiData.branches[key]) {
        closeDuishiChoiceModal();
        return;
    }
    var base = pendingDuishiData.baseData || {};
    var story = pendingDuishiData.branches[key];
    closeDuishiChoiceModal();
    // 磨豆腐或对食点击「加入」时增加侍寝技巧经验
    var skillExpGain = null;
    if (key === 'join') {
        var skillId = '侍寝技巧';
        var skill = gameState.player.skills && gameState.player.skills[skillId] ? gameState.player.skills[skillId] : { level: 0, exp: 0, mastery: 0 };
        var expAdd = 5;
        skill.exp = (skill.exp || 0) + expAdd;
        skill.mastery = (skill.mastery || 0) + 2;
        if (!gameState.player.skills) gameState.player.skills = {};
        gameState.player.skills[skillId] = skill;
        skillExpGain = { skillName: '侍寝技巧', exp: expAdd };
    }
    // 写入重要选择（剧情页显示，可点击查看完整剧情）
    if (!gameState.player.choices) gameState.player.choices = [];
    gameState.player.choices.push({
        id: Date.now() + Math.random(),
        title: (base.locationName || '下人房') + ' - ' + (base.eventType || '对食'),
        choice: story,
        date: new Date().toISOString(),
        locationName: base.locationName || '下人房'
    });
    var modalData = {
        locationName: base.locationName || '下人房',
        story: story,
        eventType: base.eventType || '对食',
        person: base.person != null ? base.person : null,
        rewards: base.rewards || {}
    };
    if (skillExpGain) modalData.skillExpGain = skillExpGain;
    showLocationEventModal(modalData);
}

/** 皇帝生成弹窗相关 */
var pendingEmperorData = null;

function showEmperorGenerateModal(emperor, locationName, loc, cost, isApiMode) {
    pendingEmperorData = { emperor: emperor, locationName: locationName, loc: loc, cost: cost, isApiMode: isApiMode };
    var infoEl = document.getElementById('emperor-generate-info');
    if (infoEl) {
        var ageText = emperor.age ? '，' + emperor.age + '岁' : '';
        infoEl.innerHTML = '<div style="margin-bottom:12px;"><strong>姓名：</strong>' + (emperor.name || '皇帝') + '</div>' +
            '<div style="margin-bottom:12px;"><strong>性格：</strong>' + (emperor.personality || '未知') + '</div>' +
            '<div style="margin-bottom:12px;"><strong>外貌：</strong>' + (emperor.appearance || '容貌威严') + ageText + '</div>' +
            (isApiMode ? '<div style="font-size:12px;color:#8E96D9;margin-top:12px;">⚠️ 重新roll将再次消耗API</div>' : '');
    }
    var modal = document.getElementById('emperor-generate-modal');
    if (modal) modal.style.display = 'flex';
}

function closeEmperorGenerateModal() {
    pendingEmperorData = null;
    var modal = document.getElementById('emperor-generate-modal');
    if (modal) modal.style.display = 'none';
}

function confirmEmperorGenerate() {
    if (!pendingEmperorData) {
        closeEmperorGenerateModal();
        return;
    }
    var data = pendingEmperorData;
    // 确保皇帝已加入（可能已经加入，也可能没有）
    var existingIndex = gameState.npcs.findIndex(function(n) { return n.role === '皇帝' && n.id === data.emperor.id; });
    if (existingIndex < 0) {
        gameState.npcs.push(data.emperor);
    }
    if (document.getElementById('page-contacts')) renderContacts();
    closeEmperorGenerateModal();
    doLocationClickRest(data.locationName, data.loc, data.cost);
}

function rerollEmperor() {
    if (!pendingEmperorData) {
        closeEmperorGenerateModal();
        return;
    }
    var data = pendingEmperorData;
    // 移除当前生成的皇帝（如果已加入）
    var oldIndex = gameState.npcs.findIndex(function(n) { return n.role === '皇帝' && n.id === data.emperor.id; });
    if (oldIndex >= 0) {
        gameState.npcs.splice(oldIndex, 1);
    }
    if (data.isApiMode) {
        // API模式：提醒会再次消耗API
        if (!confirm('重新roll将再次消耗一次API，确定要继续吗？')) {
            return;
        }
        showTipModal("正在重新生成皇帝...", "提示");
        ensureEmperorInContactsWithAPI(data.locationName).then(function(emperor) {
            showEmperorGenerateModal(emperor, data.locationName, data.loc, data.cost, true);
        }).catch(function(e) {
            showErrorModal("重新生成皇帝失败：" + e.message);
            closeEmperorGenerateModal();
            gameState.player.stats.energy = Math.min(gameState.player.stats.maxEnergy || 100, gameState.player.stats.energy + data.cost);
            updateDashboard();
        });
    } else {
        // 模板模式：直接重新生成
        var newEmperor = ensureEmperorInContactsRandom(data.locationName);
        showEmperorGenerateModal(newEmperor, data.locationName, data.loc, data.cost, false);
    }
}

/**
 * 关闭地图事件弹窗
 */
function closeLocationEventModal() {
    document.getElementById('location-event-modal').style.display = 'none';
    // 清理提示信息
    const tipEl = document.querySelector('#location-event-modal-rewards').nextElementSibling;
    if (tipEl && tipEl.textContent.includes('人脉')) {
        tipEl.remove();
    }
}

function confirmSharePost() {
    if (shareSelectedContacts.length === 0 && shareSelectedGroups.length === 0) {
        alert('请至少选择一个好友或群聊');
        return;
    }
    
    const allPosts = getAllPosts();
    const post = allPosts.find(p => p.id === currentSharePostId);
    if (!post) return;
    
    post.shares = (post.shares || 0) + shareSelectedContacts.length + shareSelectedGroups.length;
    gameState.player.socialInfluence = (gameState.player.socialInfluence || 0) + 2 * (shareSelectedContacts.length + shareSelectedGroups.length);
    updateSocialLevelFromInfluence();
    
    // 分享到选中的好友（私聊）
    shareSelectedContacts.forEach(contactId => {
        const npc = gameState.npcs.find(n => n.id === contactId);
        if (npc) {
            // 切换到聊天界面
            startChat(npc);
            // 延迟一下确保界面已切换
            setTimeout(() => {
                sendPostCard(post);
            }, 100);
        }
    });
    
    // 分享到选中的群聊
    shareSelectedGroups.forEach(groupId => {
        const group = gameState.groups.find(g => g.id === groupId);
        if (group) {
            const timeNames = ["早", "中", "晚"];
            const msg = {
                id: Date.now(),
                author: gameState.player.name,
                content: '',
                post: {
                    id: post.id,
                    author: post.author,
                    content: post.content,
                    image: post.image,
                    date: post.date
                },
                time: `${gameState.world.month}月${gameState.world.day}日 ${timeNames[gameState.world.timeOfDay]}`
            };
            group.messages.push(msg);
            
            // 如果当前在群聊界面，刷新显示
            if (currentGroupId === groupId) {
                renderGroupChat();
            }
        }
    });
    
    let shareMsg = `已分享到：`;
    if (shareSelectedContacts.length > 0) {
        const contactNames = shareSelectedContacts.map(id => {
            const npc = gameState.npcs.find(n => n.id === id);
            return npc ? npc.name : '';
        }).filter(n => n);
        shareMsg += `${contactNames.join('、')}`;
    }
    if (shareSelectedGroups.length > 0) {
        const groupNames = shareSelectedGroups.map(id => {
            const group = gameState.groups.find(g => g.id === id);
            return group ? group.name : '';
        }).filter(n => n);
        if (shareSelectedContacts.length > 0) shareMsg += '、';
        shareMsg += `群聊：${groupNames.join('、')}`;
    }
    
    alert(shareMsg);
    renderPosts();
    closeShareSelectModal();
}

// 发送动态卡片到私聊
function sendPostCard(post) {
    const box = document.getElementById('chat-box');
    const div = document.createElement('div');
    div.className = 'message msg-user post-card';
    div.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 16px;
        max-width: 85%;
        margin-left: auto;
        margin-bottom: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid rgba(0,0,0,0.08);
    `;
    
    div.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(0,0,0,0.08);">
            <div style="width:32px;height:32px;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px;">
                ${post.author.charAt(0)}
            </div>
            <div style="flex:1;">
                <div style="font-weight:600;font-size:14px;color:var(--text);">${post.author}</div>
                <div style="font-size:11px;color:var(--text);opacity:0.6;">${post.date}</div>
            </div>
            <span class="material-icons" style="font-size:18px;color:var(--accent);">share</span>
        </div>
        ${post.content ? `<div style="color:var(--text);font-size:14px;line-height:1.6;margin-bottom:${post.image ? '12px' : '0'};white-space:pre-wrap;word-wrap:break-word;">${post.content}</div>` : ''}
        ${post.image ? `
            <div style="border-radius:8px;overflow:hidden;margin-top:${post.content ? '12px' : '0'};">
                <img src="${post.image}" style="width:100%;max-height:300px;object-fit:cover;display:block;" />
            </div>
        ` : ''}
    `;
    
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    
    // 保存到历史记录
    const npc = gameState.npcs.find(n => n.id === gameState.chatTargetId);
    if (npc) {
        const currentDate = new Date().toISOString();
        npc.history.push(`[${currentDate}] ${gameState.player.name}: [分享动态: ${post.content || '图片动态'}]`);
    }
}


// ========== 经济系统 ==========
function renderEconomy() {
    const el = document.getElementById('economy-money');
    if (el) el.innerText = (gameState.player.stats.money != null ? gameState.player.stats.money : 0);
}

function renderInvest() {
    const container = document.getElementById('invest-container');
    container.innerHTML = "";
    
    // 投资类型：风险等级、收益率、周期
    const investmentTypes = [
        { 
            name: "低风险投资", 
            desc: "稳定收益，风险低", 
            risk: "低",
            options: [
                { name: "钱庄存款", cost: 500, returnRate: 1.1, days: 15, minAmount: 500 },
                { name: "商铺租赁", cost: 2000, returnRate: 1.2, days: 30, minAmount: 2000 },
                { name: "农田出租", cost: 5000, returnRate: 1.15, days: 60, minAmount: 5000 }
            ]
        },
        { 
            name: "中风险投资", 
            desc: "中等收益，有一定风险", 
            risk: "中",
            options: [
                { name: "商队投资", cost: 3000, returnRate: 1.5, days: 20, minAmount: 3000, riskChance: 0.2 },
                { name: "手工作坊", cost: 8000, returnRate: 1.4, days: 45, minAmount: 8000, riskChance: 0.15 }
            ]
        },
        { 
            name: "高风险投资", 
            desc: "高收益，高风险", 
            risk: "高",
            options: [
                { name: "海外贸易", cost: 10000, returnRate: 2.0, days: 30, minAmount: 10000, riskChance: 0.4 },
                { name: "矿山投资", cost: 20000, returnRate: 2.5, days: 60, minAmount: 20000, riskChance: 0.35 }
            ]
        }
    ];
    
    investmentTypes.forEach(type => {
        const typeCard = document.createElement('div');
        typeCard.className = "task-card";
        typeCard.style.marginBottom = "20px";
        typeCard.innerHTML = `<h4>${type.name}（${type.risk}风险）</h4><p>${type.desc}</p>`;
        
        type.options.forEach(opt => {
            const optDiv = document.createElement('div');
            optDiv.style.cssText = "background:var(--secondary);padding:10px;margin:5px 0;border-radius:5px;";
            const returnAmount = Math.floor(opt.cost * opt.returnRate);
            const profit = returnAmount - opt.cost;
            optDiv.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <strong>${opt.name}</strong><br>
                        <span style="font-size:11px;color:#757ED3;">投资: ${opt.cost}两 | 周期: ${opt.days}天 | 收益: ${returnAmount}两（+${profit}两）</span>
                        ${opt.riskChance ? `<br><span style="font-size:10px;color:var(--danger);">风险: ${Math.floor(opt.riskChance * 100)}%可能亏损</span>` : ''}
                    </div>
                    <button class="btn" style="width:auto;padding:5px 10px;font-size:12px;" onclick="showInvestModal('${opt.name}', ${opt.cost}, ${opt.returnRate}, ${opt.days}, ${opt.riskChance || 0})">投资</button>
                </div>
            `;
            typeCard.appendChild(optDiv);
        });
        
        container.appendChild(typeCard);
    });
    
    // 显示当前投资
    if (gameState.investments.length > 0) {
        container.innerHTML += "<h4 style='margin-top:20px;'>当前投资</h4>";
        gameState.investments.forEach(inv => {
            const card = document.createElement('div');
            card.className = "task-card";
            const progress = Math.floor((1 - inv.daysLeft / inv.days) * 100);
            const canClaim = inv.daysLeft <= 0;
            card.innerHTML = `
                <h4>${inv.name}</h4>
                <p>投资金额: ${inv.cost}两</p>
                <p>预计收益: ${inv.return}两（+${inv.return - inv.cost}两）</p>
                <p>剩余天数: ${inv.daysLeft}天 / ${inv.days}天</p>
                <div style="background:#D1D4E8;height:10px;border-radius:5px;margin:5px 0;">
                    <div style="background:var(--accent);height:100%;width:${Math.min(100, progress)}%;border-radius:5px;"></div>
                </div>
                ${inv.riskChance && inv.failed ? '<p style="color:var(--danger);">⚠️ 投资失败</p>' : ''}
                ${canClaim ? `<button class="btn" style="width:auto;padding:8px 16px;font-size:14px;margin-top:8px;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);color:white;" onclick="claimInvestment(${inv.id})">领取收益</button>` : `<button class="btn" style="width:auto;padding:5px 10px;font-size:12px;margin-top:5px;" onclick="cancelInvestment(${inv.id})">取消投资（损失20%）</button>`}
            `;
            container.appendChild(card);
        });
    }
}

function showInvestClaimModal(name, amount) {
    document.getElementById('invest-claim-name').textContent = name || '投资';
    document.getElementById('invest-claim-amount').textContent = amount || 0;
    const modal = document.getElementById('invest-claim-modal');
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function closeInvestClaimModal() {
    document.getElementById('invest-claim-modal').style.display = 'none';
    renderInvest();
    updateDashboard();
}

function claimInvestment(invId) {
    const inv = gameState.investments.find(i => i.id === invId);
    if (!inv) return;
    if (inv.daysLeft > 0) {
        showErrorModal('该投资尚未到期，剩余 ' + inv.daysLeft + ' 天。');
        return;
    }
    gameState.player.stats.money += inv.return;
    const index = gameState.investments.findIndex(i => i.id === invId);
    gameState.investments.splice(index, 1);
    showInvestClaimModal(inv.name, inv.return);
}

var investApplyState = { name: '', cost: 0, returnRate: 1, days: 0, riskChance: 0 };

function showInvestModal(name, cost, returnRate, days, riskChance) {
    investApplyState = { name: name, cost: cost, returnRate: returnRate, days: days, riskChance: riskChance || 0 };
    const returnAmount = Math.floor(cost * returnRate);
    const profit = returnAmount - cost;
    document.getElementById('invest-apply-info').innerHTML = `<strong>${name}</strong><br>最小投资 ${cost} 两 · 周期 ${days} 天 · 预计收益 ${returnAmount} 两（+${profit} 两）${riskChance ? '<br><span style="color:var(--danger);">风险: ' + Math.floor(riskChance * 100) + '%可能亏损</span>' : ''}`;
    document.getElementById('invest-apply-amount').value = cost;
    document.getElementById('invest-apply-amount').min = cost;
    document.getElementById('invest-apply-modal').style.display = 'flex';
    document.getElementById('invest-apply-modal').style.alignItems = 'center';
    document.getElementById('invest-apply-modal').style.justifyContent = 'center';
    document.getElementById('invest-apply-confirm').onclick = function() { confirmInvestApply(); };
}

function closeInvestApplyModal() {
    document.getElementById('invest-apply-modal').style.display = 'none';
}

function confirmInvestApply() {
    const amountStr = document.getElementById('invest-apply-amount').value;
    if (!amountStr || isNaN(amountStr)) {
        showErrorModal('请输入有效的投资金额。');
        return;
    }
    const investAmount = parseInt(amountStr, 10);
    if (investAmount < investApplyState.cost) {
        showErrorModal('投资金额不能少于 ' + investApplyState.cost + ' 两！');
        return;
    }
    closeInvestApplyModal();
    makeInvestment(investApplyState.name, investAmount, investApplyState.returnRate, investApplyState.days, investApplyState.riskChance);
}

function makeInvestment(name, cost, returnRate, days, riskChance) {
    if (gameState.player.stats.money < cost) {
        alert(`投资需要${cost}银两！`);
        return;
    }
    
    gameState.player.stats.money -= cost;
    const returnAmount = Math.floor(cost * returnRate);
    
    gameState.investments.push({
        id: Date.now(),
        name: name,
        cost: cost,
        return: returnAmount,
        returnRate: returnRate,
        days: days,
        daysLeft: days,
        riskChance: riskChance || 0,
        failed: false,
        startDate: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`
    });
    
    showTipModal(`投资成功！${days} 天后可领取 ${returnAmount} 两（收益 +${returnAmount - cost} 两）。\n到期后请到「投资」页点击「领取」。`, '投资成功');
    renderInvest();
    updateDashboard();
}

function cancelInvestment(invId) {
    const inv = gameState.investments.find(i => i.id === invId);
    if (!inv) return;
    
    if (!confirm(`确定取消投资"${inv.name}"？将损失20%本金（${Math.floor(inv.cost * 0.2)}两）`)) return;
    
    const refund = Math.floor(inv.cost * 0.8);
    gameState.player.stats.money += refund;
    
    const index = gameState.investments.findIndex(i => i.id === invId);
    gameState.investments.splice(index, 1);
    
    showTipModal('已取消投资，退还 ' + refund + ' 两。', '取消成功');
    renderInvest();
    updateDashboard();
}

function renderLoan() {
    const container = document.getElementById('loan-container');
    container.innerHTML = "";
    
    // 可借贷的NPC列表
    const lenders = gameState.npcs.filter(npc => npc.affection >= 30 || npc.role === "富商" || npc.role === "王爷");
    
    if (lenders.length === 0) {
        container.innerHTML = "<p style='text-align:center;color:#8E96D9'>暂无可借贷对象（需要好感度≥30或特殊身份）</p>";
    } else {
        container.innerHTML += "<h4>可借贷对象</h4>";
        lenders.forEach(npc => {
            const maxAmount = Math.floor(npc.affection * 100 + (npc.role === "富商" || npc.role === "王爷" ? 5000 : 0));
            const interestRate = npc.affection >= 80 ? 5 : npc.affection >= 50 ? 8 : 12;
            const card = document.createElement('div');
            card.className = "task-card";
            card.innerHTML = `
                <h4>${npc.name}（${npc.role}）</h4>
                <p>好感度: ${npc.affection}</p>
                <p>最大借贷: ${maxAmount}两</p>
                <p>利息: ${interestRate}%/30天</p>
                <button class="btn" style="width:auto;padding:5px 10px;font-size:12px;margin-top:5px;" onclick="showLoanModal(${npc.id}, ${maxAmount}, ${interestRate})">申请借贷</button>
            `;
            container.appendChild(card);
        });
    }
    
    // 显示当前借贷
    if (gameState.loans.length > 0) {
        container.innerHTML += "<h4 style='margin-top:20px;'>当前借贷</h4>";
        gameState.loans.forEach(loan => {
            const card = document.createElement('div');
            card.className = "task-card";
            const total = Math.floor(loan.amount * (1 + loan.interest / 100));
            const progress = Math.floor((1 - loan.daysLeft / loan.days) * 100);
            card.innerHTML = `
                <h4>向${loan.lender}借贷</h4>
                <p>借款金额: ${loan.amount}两</p>
                <p>利息: ${loan.interest}%/30天</p>
                <p>需还款: ${total}两（+${total - loan.amount}两利息）</p>
                <p>剩余天数: ${loan.daysLeft}天 / ${loan.days}天</p>
                <div style="background:#D1D4E8;height:10px;border-radius:5px;margin:5px 0;">
                    <div style="background:var(--danger);height:100%;width:${progress}%;border-radius:5px;"></div>
                </div>
                ${loan.daysLeft <= 3 ? '<p style="color:var(--danger);">⚠️ 即将到期！</p>' : ''}
                <button class="btn" style="width:auto;padding:5px 10px;font-size:12px;margin-top:5px;" onclick="repayLoan(${loan.id})">提前还款</button>
            `;
            container.appendChild(card);
        });
    }
}

var loanApplyState = { npcId: null, maxAmount: 0, interestRate: 0 };

function showLoanModal(npcId, maxAmount, interestRate) {
    const npc = gameState.npcs.find(n => n.id === npcId);
    if (!npc) return;
    loanApplyState = { npcId: npcId, maxAmount: maxAmount, interestRate: Math.max(1, interestRate) };
    document.getElementById('loan-apply-npc-info').innerHTML = `向 <strong>${npc.name}</strong>（${npc.role}）借贷 · 最大 <strong>${maxAmount}</strong> 两 · 好感度 ${npc.affection}`;
    document.getElementById('loan-apply-amount').value = Math.floor(maxAmount / 2);
    document.getElementById('loan-apply-rate').textContent = loanApplyState.interestRate + '%/30天';
    document.getElementById('loan-bargain-tip').style.display = 'block';
    document.getElementById('loan-apply-modal').style.display = 'flex';
    document.getElementById('loan-apply-modal').style.alignItems = 'center';
    document.getElementById('loan-apply-modal').style.justifyContent = 'center';
    document.getElementById('loan-apply-confirm').onclick = function() { confirmLoanApply(); };
    document.getElementById('loan-bargain-btn').onclick = function() { loanBargain(); };
}

function closeLoanApplyModal() {
    document.getElementById('loan-apply-modal').style.display = 'none';
    loanApplyState = { npcId: null, maxAmount: 0, interestRate: 0 };
}

function loanBargain() {
    if (!loanApplyState.npcId) return;
    const npc = gameState.npcs.find(n => n.id === loanApplyState.npcId);
    const energy = gameState.player.stats.energy || 0;
    const maxEnergy = gameState.player.stats.maxEnergy || 100;
    if (energy < 20) {
        showErrorModal('体力不足！讨价还价需要消耗 20 体力，当前体力 ' + energy + '/' + maxEnergy + '。');
        return;
    }
    gameState.player.stats.energy -= 20;
    updateDashboard();
    var refuseChance = 0.5;
    if (npc.affection >= 80) refuseChance = 0.05;
    else if (npc.affection >= 50) refuseChance = 0.2;
    else if (npc.affection >= 40) refuseChance = 0.35;
    if (Math.random() < refuseChance) {
        showTipModal('对方觉得利息已经够低了，拒绝了你的讨价还价。\n（好感度越高越容易成功）', '讨价还价被拒');
        return;
    }
    loanApplyState.interestRate = Math.max(1, loanApplyState.interestRate - 1);
    document.getElementById('loan-apply-rate').textContent = loanApplyState.interestRate + '%/30天';
    showTipModal('对方同意了！利息降至 ' + loanApplyState.interestRate + '%/30天。', '讨价还价成功');
}

function confirmLoanApply() {
    const amountStr = document.getElementById('loan-apply-amount').value;
    if (!amountStr || isNaN(amountStr)) {
        showErrorModal('请输入有效的借贷金额。');
        return;
    }
    const loanAmount = parseInt(amountStr, 10);
    if (loanAmount > loanApplyState.maxAmount) {
        showErrorModal('借贷金额不能超过 ' + loanApplyState.maxAmount + ' 两！');
        return;
    }
    if (loanAmount <= 0) {
        showErrorModal('借贷金额必须大于 0。');
        return;
    }
    closeLoanApplyModal();
    requestLoan(loanApplyState.npcId, loanAmount, loanApplyState.interestRate);
}

function requestLoan(npcId, amount, interestRate) {
    const npc = gameState.npcs.find(n => n.id === npcId);
    if (!npc) return;
    
    const days = 30;
    const total = Math.floor(amount * (1 + interestRate / 100));
    
    gameState.loans.push({
        id: Date.now(),
        lender: npc.name,
        lenderId: npcId,
        amount: amount,
        interest: interestRate,
        days: days,
        daysLeft: days,
        startDate: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`
    });
    
    gameState.player.stats.money += amount;
    
    // 好感度影响
    if (npc.affection < 50) {
        npc.affection -= 5; // 低好感度借贷会降低好感
    }
    
    showTipModal(`借贷成功！获得 ${amount} 两。\n${days} 天后需还款 ${total} 两（含利息 ${total - amount} 两）`, '借贷成功');
    renderLoan();
    updateDashboard();
}

function repayLoan(loanId) {
    const loan = gameState.loans.find(l => l.id === loanId);
    if (!loan) return;
    
    const total = Math.floor(loan.amount * (1 + loan.interest / 100));
    if (gameState.player.stats.money < total) {
        showErrorModal('还款需要 ' + total + ' 银两！当前只有 ' + gameState.player.stats.money + ' 两。');
        return;
    }
    
    gameState.player.stats.money -= total;
    
    // 提前还款可能有优惠
    const discount = loan.daysLeft > 15 ? Math.floor((total - loan.amount) * 0.1) : 0;
    if (discount > 0) {
        gameState.player.stats.money += discount;
        showTipModal('提前还款成功！获得 ' + discount + ' 两优惠，实际还款 ' + (total - discount) + ' 两。', '还款成功');
    } else {
        showTipModal('还款成功！已还 ' + total + ' 两。', '还款成功');
    }
    
    // 提升好感度
    const npc = gameState.npcs.find(n => n.id === loan.lenderId);
    if (npc) npc.affection += 5;
    
    const index = gameState.loans.findIndex(l => l.id === loanId);
    gameState.loans.splice(index, 1);
    
    renderLoan();
    updateDashboard();
}

// 物价与内务府统一：仅在休息时变动
var PRICE_ITEM_KEYS = ["人参", "胭脂", "玉佩", "素色宫装", "银簪", "避孕汤", "擦手霜"];

function initPricesIfNeeded() {
    if (!gameState.prices || Object.keys(gameState.prices).length === 0) {
        gameState.prices = {
            "人参": 30,
            "胭脂": 20,
            "玉佩": 50,
            "素色宫装": 50,
            "银簪": 30,
            "避孕汤": 60,
            "擦手霜": 15
        };
        return;
    }
    PRICE_ITEM_KEYS.forEach(name => {
        if (gameState.prices[name] == null) {
            if (name === "素色宫装") gameState.prices[name] = 50;
            else if (name === "银簪") gameState.prices[name] = 30;
            else if (name === "避孕汤") gameState.prices[name] = 60;
            else if (name === "擦手霜") gameState.prices[name] = 15;
            else gameState.prices[name] = gameState.prices["人参"] || 30;
        }
    });
}

/** 休息时更新物价：未开剧情则小幅度波动；开剧情则由 generateDailyStory 内根据【物价】解析或小幅度波动 */
function updatePricesOnRest(fromStoryMode, storyContent) {
    initPricesIfNeeded();
    if (fromStoryMode && storyContent && typeof storyContent === 'string') {
        const match = storyContent.match(/【物价】\s*([^\n]+)/);
        if (match) {
            const line = match[1].trim();
            const parts = line.split(/\s+/);
            parts.forEach(part => {
                const m = part.match(/^(.+?)([+-]?\d+)$/);
                if (m) {
                    const itemName = m[1].replace(/\s/g, '');
                    const delta = parseInt(m[2], 10);
                    if (gameState.prices[itemName] != null) {
                        gameState.prices[itemName] = Math.max(10, gameState.prices[itemName] + delta);
                    }
                }
            });
            return;
        }
    }
    // 小幅度波动 ±5%，避免上下浮动很大
    Object.keys(gameState.prices).forEach(itemName => {
        const change = (Math.random() - 0.5) * 0.1; // ±5%
        gameState.prices[itemName] = Math.max(10, Math.floor(gameState.prices[itemName] * (1 + change)));
    });
}

function renderPrices() {
    const container = document.getElementById('prices-container');
    initPricesIfNeeded();
    // 仅展示当前物价，不在此处波动（波动仅在休息时进行）
    container.innerHTML = "<h4>当前物价</h4>";
    Object.keys(gameState.prices).forEach(itemName => {
        const card = document.createElement('div');
        card.className = "task-card";
        card.innerHTML = `
            <h4>${itemName}</h4>
            <p>价格: ${gameState.prices[itemName]}银两</p>
        `;
        container.appendChild(card);
    });
}

// ========== 剧情系统 ==========
function renderStory() {
    const container = document.getElementById('story-container');
    container.innerHTML = "";
    
    // 显示每日剧情
    if (!gameState.player.dailyStories || gameState.player.dailyStories.length === 0) {
        container.innerHTML += "<p style='text-align:center;color:#8E96D9'>暂无剧情记录</p>";
    } else {
        // 按日期倒序排列
        const sortedStories = [...gameState.player.dailyStories].sort((a, b) => {
            return new Date(b.date) - new Date(a.date);
        });
        
        sortedStories.forEach(story => {
            const card = document.createElement('div');
            card.className = "task-card";
            card.innerHTML = `
                <h4>${story.title}</h4>
                <p style="white-space: pre-wrap; line-height: 1.6;">${story.content}</p>
                <p style="font-size:10px;color:#AFB4E1;margin-top:10px;">${new Date(story.date).toLocaleString()}</p>
            `;
            container.appendChild(card);
        });
    }
    
    container.innerHTML += "<h4 style='margin-top:15px;'>重要选择</h4>";
    if (gameState.player.choices.length === 0) {
        container.innerHTML += "<p style='text-align:center;color:#8E96D9'>暂无选择记录</p>";
    } else {
        // 按地图（locationName）分组，地图踩点API生成的剧情单独成组
        const byLocation = {};
        const noLocation = [];
        gameState.player.choices.forEach(choice => {
            const loc = choice.locationName;
            if (loc) {
                if (!byLocation[loc]) byLocation[loc] = [];
                byLocation[loc].push(choice);
            } else {
                noLocation.push(choice);
            }
        });
        const locationNames = Object.keys(byLocation).sort();
        locationNames.forEach(locName => {
            const sectionTitle = document.createElement('h4');
            sectionTitle.style.cssText = "margin-top:15px;margin-bottom:8px;color:var(--accent);font-size:14px;";
            sectionTitle.textContent = "【" + locName + "】";
            container.appendChild(sectionTitle);
            byLocation[locName].forEach(choice => {
                const card = document.createElement('div');
                card.className = "task-card";
                const choiceText = (choice.choice && choice.choice.length > 200) ? choice.choice.substring(0, 200) + '…' : (choice.choice || '');
                const fullContent = choice.choice || '';
                const clickHint = fullContent.length > 200 ? '<p style="font-size:11px;color:var(--accent);margin-top:8px;">点击查看完整剧情</p>' : '';
                card.style.cursor = 'pointer';
                card.onclick = () => showStoryModal(choice.title || '剧情', fullContent, choice.date || new Date().toISOString(), choice);
                card.innerHTML = `
                    <h4>${choice.title || '剧情'}</h4>
                    <p style="white-space:pre-wrap;line-height:1.5;">${choiceText}</p>
                    <p style="font-size:10px;color:#AFB4E1;">${choice.date || ''}</p>
                    ${clickHint}
                `;
                container.appendChild(card);
            });
        });
        if (noLocation.length > 0) {
            const otherTitle = document.createElement('h4');
            otherTitle.style.cssText = "margin-top:15px;margin-bottom:8px;color:var(--accent);font-size:14px;";
            otherTitle.textContent = "【其他】";
            container.appendChild(otherTitle);
            noLocation.forEach(choice => {
                const card = document.createElement('div');
                card.className = "task-card";
                const fullContent = choice.choice || '';
                const displayText = (fullContent && fullContent.length > 200) ? fullContent.substring(0, 200) + '…' : fullContent;
                const clickHint = fullContent.length > 200 ? '<p style="font-size:11px;color:var(--accent);margin-top:8px;">点击查看完整剧情</p>' : '';
                card.style.cursor = 'pointer';
                card.onclick = () => showStoryModal(choice.title || '选择', fullContent, choice.date || new Date().toISOString(), choice);
                card.innerHTML = `
                    <h4>${choice.title || '选择'}</h4>
                    <p style="white-space:pre-wrap;line-height:1.5;">选择: ${displayText}</p>
                    <p style="font-size:10px;color:#AFB4E1;">${choice.date || ''}</p>
                    ${clickHint}
                `;
                container.appendChild(card);
            });
        }
    }
}

// 更新NPC关系
function updateNPCRelationship(npcId, change) {
    if (!gameState.player.relationships[npcId]) {
        gameState.player.relationships[npcId] = { type: "neutral", level: 0 };
    }
    
    const rel = gameState.player.relationships[npcId];
    rel.level = Math.max(0, Math.min(100, rel.level + change));
    
    // 根据等级自动调整关系类型
    if (rel.level >= 80 && rel.type !== "lover") {
        rel.type = "lover";
    } else if (rel.level >= 50 && rel.type === "neutral") {
        rel.type = "friend";
    } else if (rel.level <= 20 && rel.type === "neutral") {
        rel.type = "enemy";
    }
}

// 检查NPC特殊事件
function checkNPCSpecialEvents(npc) {
    if (npc.affection >= 80 && !npc.specialEvents.includes("confession")) {
        npc.specialEvents.push("confession");
    }
}

// 初始化时调用
function initGameSystems() {
    updateSeason();
    checkItemSets();
}

// 动态圈相关函数
function showSocialCircleSettings() {
    const modal = document.getElementById('social-circle-settings-modal');
    const memoryInput = document.getElementById('social-circle-memory-post-count');
    if (memoryInput) memoryInput.value = (gameState.socialCircleMemoryPostCount != null ? gameState.socialCircleMemoryPostCount : 10);
    renderSocialCirclesList();
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function closeSocialCircleSettingsModal() {
    const memoryInput = document.getElementById('social-circle-memory-post-count');
    if (memoryInput) {
        const v = parseInt(memoryInput.value, 10);
        if (!isNaN(v) && v >= 5 && v <= 50) gameState.socialCircleMemoryPostCount = v;
    }
    document.getElementById('social-circle-settings-modal').style.display = 'none';
}

function renderSocialCirclesList() {
    const container = document.getElementById('social-circles-list');
    container.innerHTML = '';
    
    // 默认动态圈
    const defaultItem = document.createElement('div');
    defaultItem.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(225,227,237,0.5);border-radius:8px;margin-bottom:8px;cursor:pointer;';
    defaultItem.onclick = () => switchSocialCircle(null);
    defaultItem.innerHTML = `
        <div>
            <div style="font-weight:bold;color:var(--text);">默认动态圈</div>
            <div style="font-size:12px;color:#8E96D9;margin-top:4px;">所有动态</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
            <button type="button" class="btn btn-outline" onclick="event.stopPropagation(); openCircleBackgroundModal(null);" style="padding:4px 10px;font-size:12px;">背景图</button>
            <span style="color:var(--accent);font-size:20px;">${gameState.currentSocialCircleId === null ? '✓' : ''}</span>
        </div>
    `;
    container.appendChild(defaultItem);
    
    // 其他动态圈
    if (gameState.socialCircles && gameState.socialCircles.length > 0) {
        gameState.socialCircles.forEach(circle => {
            const item = document.createElement('div');
            item.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(225,227,237,0.5);border-radius:8px;margin-bottom:8px;cursor:pointer;';
            item.onclick = () => switchSocialCircle(circle.id);
            item.innerHTML = `
                <div>
                    <div style="font-weight:bold;color:var(--text);">${circle.name}</div>
                    <div style="font-size:12px;color:#8E96D9;margin-top:4px;">${circle.members.length}位成员</div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <button type="button" class="btn btn-outline" onclick="event.stopPropagation(); openCircleBackgroundModal(${circle.id});" style="padding:4px 10px;font-size:12px;">背景图</button>
                    <span style="color:var(--accent);font-size:20px;">${gameState.currentSocialCircleId === circle.id ? '✓' : ''}</span>
                </div>
            `;
            container.appendChild(item);
        });
    }
}

function switchSocialCircle(circleId) {
    gameState.currentSocialCircleId = circleId;
    renderPosts();
    closeSocialCircleSettingsModal();
}

function showCreateSocialCircleModal() {
    const modal = document.getElementById('create-social-circle-modal');
    const membersList = document.getElementById('social-circle-members-list');
    const nameInput = document.getElementById('social-circle-name-input');
    
    nameInput.value = '';
    membersList.innerHTML = '';
    
    // 生成成员列表（人脉中的NPC）
    gameState.npcs.forEach(npc => {
        const memberItem = document.createElement('div');
        memberItem.style.cssText = 'display:flex;align-items:center;padding:10px;margin-bottom:8px;background:rgba(255,255,255,0.5);border-radius:8px;cursor:pointer;transition:all 0.2s;';
        memberItem.onmouseover = () => memberItem.style.background = 'rgba(255,255,255,0.8)';
        memberItem.onmouseout = () => memberItem.style.background = 'rgba(255,255,255,0.5)';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = npc.id;
        checkbox.id = `circle-member-${npc.id}`;
        checkbox.style.marginRight = '10px';
        
        const label = document.createElement('label');
        label.htmlFor = `circle-member-${npc.id}`;
        label.style.cssText = 'flex:1;cursor:pointer;display:flex;align-items:center;';
        label.innerHTML = `
            <div style="width:32px;height:32px;background:linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px;margin-right:10px;">
                ${npc.name.charAt(0)}
            </div>
            <div>
                <div style="font-weight:bold;color:var(--text);">${npc.name}</div>
                <div style="font-size:12px;color:#8E96D9;">${npc.role}</div>
            </div>
        `;
        
        memberItem.appendChild(checkbox);
        memberItem.appendChild(label);
        membersList.appendChild(memberItem);
    });
    
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

function closeCreateSocialCircleModal() {
    document.getElementById('create-social-circle-modal').style.display = 'none';
}

function confirmCreateSocialCircle() {
    const nameInput = document.getElementById('social-circle-name-input');
    const name = nameInput.value.trim();
    
    if (!name) {
        alert('请输入动态圈名称');
        return;
    }
    
    // 获取选中的成员
    const checkboxes = document.querySelectorAll('#social-circle-members-list input[type="checkbox"]:checked');
    const memberIds = Array.from(checkboxes).map(cb => {
        const id = cb.value;
        const numId = parseInt(id);
        return isNaN(numId) ? id : numId;
    });
    
    if (memberIds.length === 0) {
        alert('请至少选择一位成员');
        return;
    }
    
    // 创建动态圈
    const circle = {
        id: Date.now(),
        name: name,
        members: memberIds,
        posts: [],
        createdAt: `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`
    };
    
    if (!gameState.socialCircles) {
        gameState.socialCircles = [];
    }
    gameState.socialCircles.push(circle);
    
    // 切换到新创建的动态圈
    gameState.currentSocialCircleId = circle.id;
    
    closeCreateSocialCircleModal();
    showSocialCircleSettings();
    renderPosts();
}

// 动态圈背景图（单个动态圈单个背景图）
var currentCircleBackgroundEditingId = null; // null = 默认动态圈，否则为 circle.id
var circleBackgroundImageTemp = null;
var circleBackgroundScaleTemp = 100;

function applyPostsPageBackground() {
    const container = document.getElementById('page-posts');
    if (!container) return;
    let url = '';
    let scale = 100;
    if (gameState.currentSocialCircleId === null) {
        url = gameState.defaultSocialCircleBackgroundImage || '';
        scale = (gameState.defaultSocialCircleBackgroundScale != null) ? Math.max(50, Math.min(200, gameState.defaultSocialCircleBackgroundScale)) : 100;
    } else {
        const circle = gameState.socialCircles && gameState.socialCircles.find(c => c.id === gameState.currentSocialCircleId);
        if (circle) {
            url = circle.backgroundImage || '';
            scale = (circle.backgroundScale != null) ? Math.max(50, Math.min(200, circle.backgroundScale)) : 100;
        }
    }
    if (url) {
        container.style.backgroundImage = 'url(' + url + ')';
        container.style.backgroundSize = scale + '% ' + scale + '%';
        container.style.backgroundPosition = 'center';
    } else {
        container.style.backgroundImage = '';
        container.style.backgroundSize = '';
        container.style.backgroundPosition = '';
    }
}

function openCircleBackgroundModal(circleIdOrNull) {
    currentCircleBackgroundEditingId = circleIdOrNull;
    var title = document.getElementById('circle-background-title');
    title.textContent = circleIdOrNull === null ? '默认动态圈 · 背景图' : '动态圈背景图';
    circleBackgroundImageTemp = null;
    var url = '';
    var scale = 100;
    if (circleIdOrNull === null) {
        url = gameState.defaultSocialCircleBackgroundImage || '';
        scale = (gameState.defaultSocialCircleBackgroundScale != null) ? Math.max(50, Math.min(200, gameState.defaultSocialCircleBackgroundScale)) : 100;
    } else {
        var circle = gameState.socialCircles && gameState.socialCircles.find(c => c.id === circleIdOrNull);
        if (circle) {
            url = circle.backgroundImage || '';
            scale = (circle.backgroundScale != null) ? Math.max(50, Math.min(200, circle.backgroundScale)) : 100;
        }
    }
    circleBackgroundScaleTemp = scale;
    document.getElementById('circle-background-url').value = (url && url.indexOf('http') === 0) ? url : '';
    document.getElementById('circle-background-file').value = '';
    document.getElementById('circle-background-scale-text').textContent = circleBackgroundScaleTemp + '%';
    var previewWrap = document.getElementById('circle-background-preview-wrap');
    var preview = document.getElementById('circle-background-preview');
    if (url) {
        preview.style.backgroundImage = 'url(' + url + ')';
        preview.style.backgroundSize = circleBackgroundScaleTemp + '% ' + circleBackgroundScaleTemp + '%';
        previewWrap.style.display = 'block';
    } else {
        preview.style.backgroundImage = '';
        preview.style.backgroundSize = '';
        previewWrap.style.display = 'none';
    }
    document.getElementById('circle-background-file').onchange = function() {
        var f = this.files[0];
        if (!f) return;
        var r = new FileReader();
        r.onload = function() {
            circleBackgroundImageTemp = r.result;
            preview.style.backgroundImage = 'url(' + r.result + ')';
            preview.style.backgroundSize = circleBackgroundScaleTemp + '% ' + circleBackgroundScaleTemp + '%';
            previewWrap.style.display = 'block';
        };
        r.readAsDataURL(f);
    };
    document.getElementById('circle-background-modal').style.display = 'flex';
    document.getElementById('circle-background-modal').style.alignItems = 'center';
    document.getElementById('circle-background-modal').style.justifyContent = 'center';
}

function closeCircleBackgroundModal() {
    document.getElementById('circle-background-modal').style.display = 'none';
    currentCircleBackgroundEditingId = null;
    circleBackgroundImageTemp = null;
}

function circleBackgroundScaleChange(delta) {
    circleBackgroundScaleTemp = Math.max(50, Math.min(200, circleBackgroundScaleTemp + delta * 10));
    document.getElementById('circle-background-scale-text').textContent = circleBackgroundScaleTemp + '%';
    var preview = document.getElementById('circle-background-preview');
    if (preview && preview.style.backgroundImage) {
        preview.style.backgroundSize = circleBackgroundScaleTemp + '% ' + circleBackgroundScaleTemp + '%';
    }
}

function clearCircleBackgroundImage() {
    document.getElementById('circle-background-url').value = '';
    document.getElementById('circle-background-file').value = '';
    circleBackgroundImageTemp = null;
    circleBackgroundScaleTemp = 100;
    document.getElementById('circle-background-scale-text').textContent = '100%';
    var p = document.getElementById('circle-background-preview');
    p.style.backgroundImage = '';
    p.style.backgroundSize = '';
    document.getElementById('circle-background-preview-wrap').style.display = 'none';
}

function saveCircleBackground() {
    var urlVal = document.getElementById('circle-background-url').value.trim();
    if (currentCircleBackgroundEditingId === null) {
        if (circleBackgroundImageTemp) gameState.defaultSocialCircleBackgroundImage = circleBackgroundImageTemp;
        else if (urlVal) gameState.defaultSocialCircleBackgroundImage = urlVal;
        gameState.defaultSocialCircleBackgroundScale = circleBackgroundScaleTemp;
    } else {
        var circle = gameState.socialCircles && gameState.socialCircles.find(c => c.id === currentCircleBackgroundEditingId);
        if (circle) {
            if (circleBackgroundImageTemp) circle.backgroundImage = circleBackgroundImageTemp;
            else if (urlVal) circle.backgroundImage = urlVal;
            circle.backgroundScale = circleBackgroundScaleTemp;
        }
    }
    applyPostsPageBackground();
    closeCircleBackgroundModal();
    showTipModal('背景图已保存，已应用到当前动态圈。', '保存成功');
}

// 刷新动态圈 - 一次API调用完成所有成员的发动态、点赞、评论
async function refreshSocialCircle() {
    const savedSettings = localStorage.getItem('palace_settings');
    if (!savedSettings) {
        showErrorModal('请先在设置中配置API Key才能刷新动态圈。');
        return;
    }
    const settings = JSON.parse(savedSettings);
    if (!settings.apiKey || !settings.apiUrl) {
        showErrorModal('请先在设置中配置API Key才能刷新动态圈。');
        return;
    }
    let circleMembers = [];
    if (gameState.currentSocialCircleId === null) {
        circleMembers = gameState.npcs.map(npc => npc.id);
    } else {
        const circle = gameState.socialCircles.find(c => c.id === gameState.currentSocialCircleId);
        if (!circle) {
            showErrorModal('动态圈不存在');
            return;
        }
        circleMembers = circle.members || [];
    }
    if (circleMembers.length === 0) {
        showErrorModal('当前动态圈没有成员');
        return;
    }
    const memoryCount = Math.max(5, Math.min(50, (gameState.socialCircleMemoryPostCount != null ? gameState.socialCircleMemoryPostCount : 10)));
    let allPosts = [];
    if (gameState.currentSocialCircleId === null) {
        allPosts = [...gameState.socialPosts];
    } else {
        const circle = gameState.socialCircles.find(c => c.id === gameState.currentSocialCircleId);
        if (circle && circle.posts) allPosts = [...circle.posts];
    }
    const postsForPrompt = allPosts.slice(-memoryCount);
    const refreshBtn = event.target.closest('button');
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<span class="material-icons" style="font-size:18px;animation:spin 1s linear infinite;">refresh</span><span>刷新中...</span>';
    }
    try {
        const npcInfos = [];
        for (const memberId of circleMembers) {
            const npc = gameState.npcs.find(n => n.id == memberId);
            if (!npc) continue;
            let npcPrivateMemory = '';
            if (npc.history && npc.history.length > 0) {
                const memCount = gameState.memorySettings[npc.id] !== undefined ? gameState.memorySettings[npc.id] : 100;
                if (memCount === 0) npcPrivateMemory = npc.history.join('\n');
                else npcPrivateMemory = npc.history.filter(msg => msg.includes(`${npc.name}:`)).slice(-memCount).join('\n');
            }
            let groupChatMemory = '';
            gameState.groups.forEach(group => {
                if (!group.memberIds.includes(memberId) || !group.messages || group.messages.length === 0) return;
                const gMem = gameState.groupMemorySettings && gameState.groupMemorySettings[group.id] !== undefined ? gameState.groupMemorySettings[group.id] : 100;
                const msgs = gMem === 0 ? group.messages : group.messages.slice(-gMem);
                const text = msgs.map(m => `${m.author}: ${m.content || ''}`).join('\n');
                if (text) groupChatMemory += `群聊"${group.name}"：\n${text}\n\n`;
            });
            npcInfos.push({
                id: npc.id,
                name: npc.name,
                role: npc.role,
                personality: npc.personality,
                privateMemory: npcPrivateMemory,
                groupMemory: groupChatMemory
            });
        }
        const postsText = postsForPrompt.map((p, i) => {
            let commentsStr = '';
            if (p.commentsList && p.commentsList.length > 0) {
                commentsStr = p.commentsList.map(c => {
                    let s = c.author + ': ' + (c.content || '');
                    if (c.replies && c.replies.length > 0) s += ' 回复：' + c.replies.map(r => (r.replyTo ? r.author + '回复' + r.replyTo + ': ' + r.content : r.author + ': ' + r.content)).join(' ');
                    return s;
                }).join(' | ');
            }
            return '动态' + (i + 1) + ' 作者:' + p.author + ' 内容:' + (p.content || '[图片]').substring(0, 100) + ' 点赞:' + (p.likes || 0) + ' 评论数:' + (p.comments || 0) + (commentsStr ? ' 评论: ' + commentsStr : '');
        }).join('\n');
        const membersText = npcInfos.map(n => `姓名:${n.name} 身份:${gameState.world.dynasty}朝${n.role} 性格:${n.personality}${n.privateMemory ? ' 私聊记忆:' + n.privateMemory.substring(0, 200) : ''}${n.groupMemory ? ' 群聊:' + n.groupMemory.substring(0, 150) : ''}`).join('\n');
        const systemPrompt = `你是中国古代宫廷背景朋友圈的批量决策器。动态圈中的玩家（主角）自身设定：${getPlayerContextForAPI()}。${getStylePresetPrompt()}${getAntiBaguguPrompt()}
当前动态圈成员：\n${membersText}

当前动态（共${postsForPrompt.length}条，序号1到${postsForPrompt.length}）：\n${postsText}

请为每个成员生成：1) 是否发一条新动态（发则写内容不超过100字，不发则null）；2) 对每条动态（按序号postIndex 1~${postsForPrompt.length}）若作者不是自己则：是否点赞(like)、是否评论(comment内容或null)、是否回复某条评论(replyLine格式"回复 对方名: 内容"或null)。已点赞/已评论过的不要重复。
重要：成员可以对其他成员的动态点赞、评论；若某条评论下有人回复了你（你的评论被他人回复了），你也可以用 replyLine 对该回复者进行再回复，填"回复 对方名: 内容"。点赞同样可以给其他成员的动态点。
只输出一个JSON，不要markdown或其它文字。格式：
{"npcActions":[{"name":"成员名","post":"动态内容或null","interactions":[{"postIndex":1,"like":true,"comment":"评论或null","replyLine":"回复 对方名: 内容或null"},...]},...]}
注意：interactions里只包含该成员会互动的动态（跳过自己发的），postIndex对应上面动态序号。同一动态若该成员既想评论又想回复某条评论，comment与replyLine可同时填。`;
        const response = await fetch(settings.apiUrl + '/chat/completions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + settings.apiKey },
            body: JSON.stringify({
                model: settings.model || 'gpt-3.5-turbo',
                messages: [
                    { role: 'system', content: '你只输出一个合法JSON，包含npcActions数组。' },
                    { role: 'user', content: systemPrompt }
                ],
                temperature: 0.8,
                max_tokens: 4000
            })
        });
        if (!response.ok) {
            let errMsg = 'HTTP ' + response.status;
            try { const b = await response.json(); errMsg = b.error?.message || b.message || errMsg; } catch (_) {}
            throw new Error(errMsg);
        }
        const data = await response.json();
        const raw = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? data.choices[0].message.content.trim() : '';
        const jsonMatch = raw.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('API未返回有效JSON');
        const result = JSON.parse(jsonMatch[0]);
        if (!result.npcActions || !Array.isArray(result.npcActions)) throw new Error('JSON中缺少npcActions数组');
        const dateStr = `${gameState.world.year}-${gameState.world.month}-${gameState.world.day}`;
        for (const action of result.npcActions) {
            const npc = gameState.npcs.find(n => n.name === action.name);
            if (!npc) continue;
            if (action.post && typeof action.post === 'string' && action.post.trim() && action.post.toLowerCase() !== 'null') {
                const newContent = action.post.trim().substring(0, 200);
                const targetPosts = gameState.currentSocialCircleId === null ? gameState.socialPosts : (gameState.socialCircles.find(c => c.id === gameState.currentSocialCircleId)?.posts || []);
                const sameCount = targetPosts.filter(p => (p.content || '').trim() === newContent.trim()).length;
                if (sameCount >= 1) continue; // 朋友圈禁止重复：已有相同内容则跳过
                var postImage = null;
                if (npc.emojis && npc.emojis.length > 0 && Math.random() < 0.35) {
                    var emojiData = npc.emojis[Math.floor(Math.random() * npc.emojis.length)];
                    postImage = typeof emojiData === 'string' ? emojiData : (emojiData.image || null);
                }
                const newPost = {
                    id: Date.now() + Math.random(),
                    author: npc.name,
                    content: newContent,
                    image: postImage,
                    date: dateStr,
                    likes: 0,
                    likedBy: [],
                    comments: 0,
                    commentsList: [],
                    shares: 0,
                    circleId: gameState.currentSocialCircleId
                };
                if (gameState.currentSocialCircleId === null) {
                    gameState.socialPosts.push(newPost);
                } else {
                    const circle = gameState.socialCircles.find(c => c.id === gameState.currentSocialCircleId);
                    if (circle) {
                        if (!circle.posts) circle.posts = [];
                        circle.posts.push(newPost);
                    }
                }
                if (!npc.socialPosts) npc.socialPosts = [];
                newPost.circleId = gameState.currentSocialCircleId;
                npc.socialPosts.push(newPost);
            }
            if (!action.interactions || !Array.isArray(action.interactions)) continue;
            for (const it of action.interactions) {
                const idx = (it.postIndex != null ? parseInt(it.postIndex, 10) : 0) - 1;
                if (idx < 0 || idx >= postsForPrompt.length) continue;
                const post = postsForPrompt[idx];
                if (post.author === npc.name) continue;
                if (it.like === true && (!post.likedBy || !post.likedBy.includes(npc.name))) {
                    if (!post.likedBy) post.likedBy = [];
                    post.likedBy.push(npc.name);
                    post.likes = (post.likes || 0) + 1;
                }
                if (it.comment && typeof it.comment === 'string' && it.comment.trim() && it.comment.toLowerCase() !== 'null') {
                    const commentStr = it.comment.trim().substring(0, 80);
                    if (!post.commentsList) post.commentsList = [];
                    if (!post.commentsList.some(c => c.author === npc.name)) {
                        post.commentsList.push({
                            author: npc.name,
                            content: commentStr,
                            date: dateStr,
                            replyTo: null,
                            replies: []
                        });
                        post.comments = (post.comments || 0) + 1;
                    }
                }
                if (it.replyLine && typeof it.replyLine === 'string' && it.replyLine.includes('回复') && !it.replyLine.includes('不回复')) {
                    const replyMatch = it.replyLine.match(/回复\s*([^:：]+)[:：]\s*(.+)/);
                    if (replyMatch) {
                        const replyToName = replyMatch[1].trim();
                        const replyContent = (replyMatch[2].trim()).substring(0, 80);
                        if (!replyContent) continue;
                        if (!post.commentsList) continue;
                        for (let i = 0; i < post.commentsList.length; i++) {
                            const comment = post.commentsList[i];
                            if (comment.author === replyToName) {
                                if (!comment.replies) comment.replies = [];
                                if (!comment.replies.some(r => r.author === npc.name && r.replyTo === replyToName)) {
                                    comment.replies.push({ author: npc.name, content: replyContent, date: dateStr, replyTo: replyToName });
                                }
                                break;
                            }
                            if (comment.replies && comment.replies.some(r => r.author === replyToName)) {
                                if (!comment.replies.some(r => r.author === npc.name && r.replyTo === replyToName)) {
                                    comment.replies.push({ author: npc.name, content: replyContent, date: dateStr, replyTo: replyToName });
                                }
                                break;
                            }
                        }
                    }
                }
            }
        }
        renderPosts();
    } catch (error) {
        console.error('刷新动态圈失败:', error);
        showErrorModal('刷新动态圈失败：' + (error.message || '未知错误'));
    } finally {
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<span class="material-icons" style="font-size:18px;">refresh</span><span>刷新</span>';
        }
    }
}

// 教程（右上角问号）——最小侵入式 L2 浮层，打开时默认全部收起
function openTutorialModal() {
    const modal = document.getElementById('tutorial-modal');
    if (!modal) return;
    modal.style.display = 'flex';
    var bodies = modal.querySelectorAll('.tut-category-body');
    var headers = modal.querySelectorAll('.tut-category-header');
    bodies.forEach(function(b) { b.classList.remove('open'); });
    headers.forEach(function(h) {
        var arr = h.querySelector('.tut-category-arrow');
        if (arr) arr.textContent = '\u25B6';
    });
}
function toggleTutorialCategory(headerEl) {
    if (!headerEl || !headerEl.classList.contains('tut-category-header')) return;
    var body = headerEl.nextElementSibling;
    var arrow = headerEl.querySelector('.tut-category-arrow');
    if (body && body.classList.contains('tut-category-body')) {
        body.classList.toggle('open');
        if (arrow) arrow.textContent = body.classList.contains('open') ? '\u25BC' : '\u25B6';
    }
}
function closeTutorialModal() {
    const modal = document.getElementById('tutorial-modal');
    if (!modal) return;
    modal.style.display = 'none';
}
function handleTutorialBackdropClick(e) {
    // 仅当点击遮罩（而不是卡片内容）时关闭
    if (e && e.target && e.target.id === 'tutorial-modal') closeTutorialModal();
}
document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') closeTutorialModal();
});

</script>
</body>
</html>